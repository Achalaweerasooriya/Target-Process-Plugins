define(["tau/components/extensions/component.extension.base","tau/services/service.actions","tau/core/templates-factory","tau/ui/templates/actions/ui.template.convert"],function(a,b,c){var d=46,e=0;return a.extend({"bus convertEntity":function(a){var b=a.data.projectID,c=a.data.generalID;this.convert(c,b)},convert:function(a,f){var g=this.config.context.applicationContext.id,h=this.bus.getGlobalBus(),i=new b;Ext.WindowMgr.zseed=99999;var j=this,k=[],l=function(b){function n(){var a=g.find("#entityType").val();g.find("textarea").unbind("keypress"),g.find("textarea").unbind("keyup"),g.find("#pnlLookupUserStory").css("display",a==d?"block":"none"),a==0?g.find(".convert-btn").attr("disabled","disabled"):a==d?(g.find("textarea").bind("keypress ",function(a){a.keyCode==13&&(a.stopPropagation(),a.preventDefault())}),g.find("textarea").bind("keyup",m),g.find("textarea").bind("change",m),m()):g.find(".convert-btn").removeAttr("disabled")}e++;var g=c.get("convert").bind(j.config,{types:b.d}).appendTo("body"),l="convertEntityPanel"+e;g=g.find("#convertEntityPanel").prop("id",l);var m=function(){g.find("textarea").val().length==0?g.find(".convert-btn").attr("disabled","disabled"):g.find(".convert-btn").removeAttr("disabled")};$create(Tp.Atlas.Extenders.Lookup.GeneralLookupBehavior,{TargetControl:g.find("#txtGeneralsLookup")[0],clearLink:g.find("#lnkClear")[0],entityTypeIDs:[4],excludeEntityID:a,findLink:g.find("#lnkFind")[0],generalElement:g.find("#hdnGeneralID")[0],id:"lkpUserStories",projectID:f,projectIDs:k,showEntityTypeFilter:!1,showProjectFilter:!0,showReleaseIterationFilter:!0,onFindDelegate:function(){g.find(".convert-btn").removeAttr("disabled")},showStateFilter:!1},null,null),g.find(".convert-btn").click(function(){var b=g.find("#entityType").val();o.hide(),j.fire("showProgress",{text:"Converting..."});var c={generalId:a},e=function(b){o.close(),j.fire("hideProgress");var c=b.d,d=c.EntityTypeName.split("."),e=d[d.length-1],f={entity:{id:c.GeneralID},entityType:{name:e}};j.fire("generalWasConverted",f),h.fire("history.exclude",{id:a}),h.fire("routing.redirect",{url:"#"+e.toLowerCase()+"/"+c.GeneralID}),window._criticalTauChanges=!0},f=function(a){o.close(),j.fire("hideProgress");var b=jQuery.parseJSON(a.responseText)||{Message:"Server is not available"},c=b.Message;j.fire("error",{message:c})};if(b==d){var k=g.find("#hdnGeneralID").val();if(!k){j.fire("error",{message:"Parent user story is not specified"});return}i.convertGeneralToTask(a,k,e,f)}else c.entityTypeId=b,i.convertGeneralToType(a,b,e,f)}),g.find("#entityType").change(function(){n()}),n();var o=showModalPopup(l,{title:"Convert",width:600,height:220})};i.getProjectIds(function(b){k=b.d,i.generalCanConvertTo(a,l)})}})})