define(["tau/core/model-base","Underscore"],function(a,b){var c=function(a){this.model=a};c.prototype={done:function(a){var b=a[0].data.entityState;this.model.fire("dataBind",b)}};var d=a.extend({onInit:function(){var a=this,d=new c(this),e=this.config.context,f=e.entity.entityType.name,g=e.entity.id,h=[{entityState:["id","name","isFinal","isCommentRequired",{nextStates:["id"]}]}],i=function(c){var d=c.data.changes,e=c.data.cmd.config.fields;d.entityState&&(c.data.cmd.config.fields=b.union(e,h),a.fire("beforeChanges",c.data.changes))},j=function(b){b.data.changes.entityState&&a.fire("applyChanges",b.data.changes)};a.store.on({eventName:"beforeSave",type:f,listener:this},i),a.store.on({eventName:"afterSave",type:f,listener:this},j),this.store.get(f,{id:g,fields:h},{success:d.setEntity,scope:d}).done({success:d.done,scope:d})}});return d})