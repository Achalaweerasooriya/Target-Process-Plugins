define(["Underscore","tau/core/model-base","tau/models/dataprocessor/model.processor.assignments","tau/extensions/extension.underscore"],function(a,b,c){var d=function(a){this.model=a};d.prototype={groupByState:function(b){var c=a.groupBy(b,function(a){var b=2;a.entityState.isinitial?b=1:a.entityState.isfinal&&(b=3);return b});return a(c).sortBy(function(a){return a.key})},completeLoadEntities:function(b,c){c=c||["tasks"];var d=a(b).pluck("data"),e=d[0].tasks,f=d.length>1?d[1].bugs:[],g=[];a.indexOf(c,"tasks")!==-1&&(g=g.concat(e)),a.indexOf(c,"bugs")!==-1&&(g=g.concat(f));var h=this.groupByState(g),i=[];for(var j=0;j<h.length;j++){var k=h[j]?h[j].items:[];i=i.concat(a(k).sortBy(function(a){var b={task:-1,bug:1},c=a.__type;return b[c]||0}))}this.done(this.convertData(i))},convertData:function(a){var b=[];for(var d=0;d<a.length;d++){var e=a[d],f={id:e.id,name:e.name,__type:e.__type,entityState:{id:e.entityState.id,name:e.entityState.name},effort:e.effort,assignments:c.getAssignments(e)};b.push(f)}return b},done:function(a){var b={items:a};this.model.bus.fire("dataBind",b)}};var e=b.extend({_createDetailCommand:function(a){var b={};b[a]=["id","name","effort",{entityState:["id","name","isinitial","isfinal"]},{roleEfforts:["id",{role:["id","name"]}]},{assignments:["id",{role:["id"]},{generalUser:["id","firstName","lastName"]}]}];return b},_retrieveEntity:function(b){var c=this.config.context,d=c.entity.entityType.name,e=c.entity.id,f=c.applicationContext.processes[0].practices,g=a.pluck(f,"name"),h=["tasks"];a.indexOf(g,"Bug Tracking")!==-1&&h.push("bugs");var i=this.store;for(var j=0;j<h.length;j++){var k=this._createDetailCommand(h[j]),l={id:e,nested:!0,fields:[k]};i=i.get(d,l)}i.done({success:function(a){return function(c){return b.completeLoadEntities(c,a)}}(h),scope:b})},onInit:function(){var a=new d(this);this._retrieveEntity(a)}});return e})