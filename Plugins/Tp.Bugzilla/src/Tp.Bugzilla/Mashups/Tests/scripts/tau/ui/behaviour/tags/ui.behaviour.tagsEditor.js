define(["Underscore","jQuery","tau/core/tau"],function(a,b,c){b.widget("ui.tagsEditor",{options:{selector:".ui-tags__tag",onSave:function(){}},_create:function(){this.init()},init:function(){this.$list=b(this.element);var c=this.options.selector,d=this.$list.find(c);d.append('<a href="#" class="ui-tags__control-delete" title="Delete tag">Delete tag</a>');var e=this;this.$list.delegate(".ui-tags__control-delete","click",function(a){a.preventDefault(),b(this).parents(c).eq(0).remove(),e.options.onSave(e.getTags())}),this.$widget=b('<li class="ui-tags__editor"><a href="#" title="Add tag" class="ui-tags__editor__control-show"><i>Add tag</i></a></li>'),this.$widget.find("a:first").click(a.bind(this.showEditor,this)),this.$list.append(this.$widget)},showEditor:function(d){d.preventDefault();if(!this._editorIsVisible){if(!this.$editor){var e=b(c.concat('<span class="ui-tags__editor__inner">','    <input type="text" maxlength="50" class="ui-tags__editor__input" />','    <div class="button-group" style="position: relative; top: 5px; left: 3px;"><a title="Add" class="button small ui-tags__editor__button-submit" >Add&nbsp;</a>','    <a title="Cancel" class="button small ui-tags__editor__button-cancel"  >x</a></div>',"</span>")),f=this;e.find(".ui-tags__editor__button-submit").click(function(){var a=f.parseTags(e.find(":text").val());f.addTags(a),f.hideEditor(),f.options.onSave(f.getTags())}),e.find(".ui-tags__editor__button-cancel").click(function(){f.hideEditor()}),e.find(":text").keydown(a.bind(this.mapKeys,this)),e.appendTo(this.$widget),this.$editor=e}this.resetEditor(),this.$widget.toggleClass("ui-tags__editor-active",!0),this._editorIsVisible=!0,this.$editor.find(":text").focus()}},hideEditor:function(){this.$editor&&this._editorIsVisible&&(this.$editor.find(":text").blur(),this.$widget.toggleClass("ui-tags__editor-active",!1),this._editorIsVisible=!1,this.resetEditor())},resetEditor:function(){this.$editor&&this.$editor.find(":text").val("")},mapKeys:function(a){switch(a.which){case 13:a.preventDefault();var b=this,c=b.parseTags(this.$editor.find(":text").val());b.addTags(c),b.hideEditor(),b.options.onSave(b.getTags());break;case 27:a.preventDefault(),this.hideEditor(a)}},getTagsElements:function(){var a=[];return this.$list.find(this.options.selector).each(function(c,d){var e=b(d);a.push({value:b.trim(e.find("span:first").text()),$el:e})}),a},getTags:function(){var a=[];return this.$list.find(this.options.selector).each(function(c,d){var e=b(d);a.push(b.trim(e.find("span:first").text()))}),a},addTags:function(c){var d=this.getTagsElements(),e=a.pluck(d,"value"),f=[],g=[];a.each(c,function(b,c){var h=a.indexOf(e,b);h==-1?f.push(b):g.push(d[h].$el)});var h=b();this.$list.find(this.options.selector).removeClass("ui-tags__tag-new"),a.each(f,function(a){var c=b('<li class="ui-tags__tag ui-tags__tag-new"><a href="#" class="ui-tags__control-delete" title="Delete tag">Delete tag</a></li>');c.prepend("<span></span>").children().text(a),h=h.add(c)});var i=this.$list.find(this.options.selector);i.length?i.last().after(h):this.$list.prepend(h),this.$list.find(this.options.selector).removeClass("ui-tags__tag-updated"),a.each(g,function(a){a.addClass("ui-tags__tag-updated")}),this.$list.find(".ui-tags__tag-new, .ui-tags__tag-updated").css("backgroundColor","#FFFFE1").animate({backgroundColor:"#d3e6fc"},{queue:!1,duration:3e3})},parseTags:function(b){b=b||"";var c=b.split(",");return c=a(c).map(function(a){return a.trim()}),c=a.uniq(c),c=a.compact(c),c}})})