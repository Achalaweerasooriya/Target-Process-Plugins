define(["Underscore","tau/core/model-base","tau/core/termProcessor","tau/configurator"],function(a,b,c,d){var e=function(a){this.model=a};e.prototype={getFields:function(){var b=a.map(this.model.config.entities,function(a,b){return{type:a.type,isReference:a.isReference}});return b},getCommands:function(){var b=a.map(this.model.config.entities,function(a){var b={};return a.type=="owner"?b[a.type]=["id","firstName","lastName"]:b[a.type]=["id","name"],b});return b},setEntityType:function(a){this.entityType=a},initializeTerms:function(a){this.termProcessor=new c(a)},done:function(a){var b=a[0].data,c={entities:[]},e=this.getFields();for(var f=0,g=e.length;f<g;f++){var h=e[f].type,i=b[h]||{},j={type:h,value:{id:null,name:""}};if(i.id)if(h=="owner"){var k=i;j.value={id:k.id,name:[k.firstName,k.lastName].join(" "),role:k.role,avatar:[d.getApplicationPath(),"/Avatar.ashx?UserId=",k.id,"&size=32"].join("")}}else j.value={id:i.id,name:i.name},e[f].isReference&&(j.externalUrl=[d.getApplicationPath(),"/View.aspx?noRedirect=1&id=",i.id].join(""),j.applicationUrl="#"+j.type+"/"+j.value.id);c.entities.push(j)}this.model.bus.fire("dataBind",c)}};var f=b.extend({onInit:function(){var a=this,b=new e(this),c=this.config.context,d=c.entity.entityType.name,f=c.entity.id;b.setEntityType(d),b.initializeTerms(c.applicationContext.processes[0].terms);var g={id:f,fields:["id"]},h=b.getCommands();g.fields=g.fields.concat(h);var i=function(b){var c=b.data.changes,e=b.data.cmd.config.fields,f=["id","name"];c.release&&d!=="iteration"&&a.addRequiredFields("iteration",e,f),c.iteration&&a.addRequiredFields("release",e,f),a.fire("prepareChanges",c)},j=function(b){a.fire("applyChanges",b.data.changes)};a.store.on({eventName:"beforeSave",type:d,listener:this},i).on({eventName:"afterSave",type:d,listener:this},j),this.store.get(d,g).done({success:b.done,scope:b})},addRequiredFields:function(b,c,d){var e=a.detect(c,function(a){return a.hasOwnProperty(b)});e?a.each(d,function(c){a.any(e[b],function(a){return c==a})||e[b].push(c)}):(e={},e[b]=d,c.push(e))}});return f})