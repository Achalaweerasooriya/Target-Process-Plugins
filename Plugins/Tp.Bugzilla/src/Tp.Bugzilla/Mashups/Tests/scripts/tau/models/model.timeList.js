define(["Underscore","tau/core/model-base","tau/core/dates","tau/converters/converter.date"],function(a,b,c,d){function g(a){this.model=a,this.times=[]}function f(a){var b={id:a,fields:["id",{tasks:["id","name",{times:["id","date","spent","remain","description",{user:["id","firstName","lastName"]}]}]}],list:!0,nested:!0};return b}function e(a){return{id:a,fields:["id","name",{times:["id","date","spent","remain","description",{user:["id","firstName","lastName"]}]}]}}g.prototype={getAssignableRetrievedCallback:function(){return{scope:this,success:this.onAssignableRetrieved}},getTaskRetrievedCallbackInfo:function(){return{scope:this,success:this.onTasksRetrieved}},getAllTasksRetrievedCallbackInfo:function(){return{scope:this,success:this.onAllTasksRetrieved}},onAssignableRetrieved:function(a){this.assignable=this.model.assignable=a.data;var b=this.model.assignable,c=b.times;this._addTimesToTimeArray(c,this.assignable)},onTasksRetrieved:function(b){a(b.data.tasks).each(function(a){a.__type="task"});var c=b.data.tasks;for(var d=0;d<c.length;d++)this._addTimesToTimeArray(c[d].times,c[d])},onAllTasksRetrieved:function(){var a={items:this.getTimes()};this.model.bus.fire("dataBind",a)},getTimesSortedByDate:function(){var b=[],d=this.times.length;for(var e=0;e<d;e++){var f=a(this.times[e]).clone();f.date=c.fromStringToDate(f.date),b.push(f)}b.sort(function(a,b){return b.date-a.date});return b},getTimes:function(){var a=[],b=this.getTimesSortedByDate(),c=b.length;for(var d=0;d<c;d++)a.push(this.convertServerDataModelData(b[d]));return a},convertServerDataModelData:function(a){var b=a.user;return{date:d.convertDateToMothDayYearString(a.date),spent:a.spent,remain:a.remain,description:a.description,person:[b.firstName,b.lastName].join(" "),workOn:{__type:a.workOn.__type,name:a.workOn.name}}},_addTimesToTimeArray:function(b,c){var d=[];for(var e=0;e<b.length;e++){var f=a(b[e]).clone();f.workOn=c,d.push(f)}this.times=this.times.concat(d)}};var h=b.extend({isUserStory:function(a){return a.toLowerCase()=="userstory"},onInit:function(){var a=new g(this),b=this.config.context.entity,c=b.id,d=b.entityType.name,h=e(c),i=this.isUserStory(d),j=this.store;j=j.get(d,h,a.getAssignableRetrievedCallback());if(i){var k=f(c);j=j.get(d,k,a.getTaskRetrievedCallbackInfo())}j.done(a.getAllTasksRetrievedCallbackInfo())}});return h})