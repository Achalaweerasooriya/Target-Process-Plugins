define(["Underscore","tau/models/dataProviders/model.provider.groups.base","tau/core/dates","libs/date.js/build/date"],function(a,b,c){return b.extend({fetch:function(b,c,d){var e=["userstory"],f=a.pluck(this.config.context.applicationContext.processes[0].practices,"name");a.indexOf(f,"Bug Tracking")!==-1&&e.push("bug");return b=="entityState.name"?this._fetchState(b,e,d):this._fetchIterations(b,e,d)},_fetchIterations:function(b,d,e){var f=this.config.context,g=f.entity.entityType.name,h=f.entity.id,i=this.config.store,j={id:h,nested:!0,fields:[{iterations:["id","name","startDate","endDate"]}]},k=f.applicationContext.culture.shortDateFormat;k="d MMM",i=i.get("release",j),i.done({success:function(b){var d=a(b).pluck("data")[0].iterations,f=[];d=a.sortBy(d,function(a){return c.fromStringToDate(a.startDate)}),a.forEach(d,function(a){var b=c.fromStringToDate(a.startDate).clearTime(),d=c.fromStringToDate(a.endDate).clearTime(),e=!0,g=!1;Date.today().between(b,d)&&(e=!1,g=!0);var h=b.format(k)+" / "+d.format(k);h=h+" ("+Math.floor((d.getTime()-b.getTime())/1e3/60/60/24+1)+" days)",g&&(h=h+" (current)"),f.push({key:a.id,title:a.name,subtitle:h,collapsed:e})}),f.push({key:null,title:"Backlog",collapsed:!0}),a.forEach(f,function(a){a.items=[]}),e(f)},scope:this})}})})