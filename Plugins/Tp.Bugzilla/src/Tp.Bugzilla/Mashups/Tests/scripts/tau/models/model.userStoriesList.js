define(["Underscore","tau/core/model-base","tau/models/dataprocessor/model.processor.assignments","tau/extensions/extension.underscore"],function(a,b,c){var d=function(a){this.model=a};d.prototype={sortByState:function(b){var c=a(b).sortBy(function(a){var b=0;return a.entityState.isinitial?b=-1:a.entityState.isfinal&&(b=1),b});return c},completeLoadEntities:function(b){var c=b[0].data.userStories;a(c).each(function(a){a.__type="userStory"});var d=this.sortByState(c);this.done(this.convertData(d))},convertData:function(a){var b=[];for(var d=0;d<a.length;d++){var e=a[d];e.priority=e.priority||{id:null,name:null},e.entityState=e.entityState||{id:null,name:null},e.release=e.release||{id:null,name:null},e.iteration=e.iteration||{id:null,name:null};var f={__type:e.__type,id:e.id,name:e.name,effort:e.effort,project:{id:e.project?e.project.id:null,name:e.project?e.project.name:null},priority:{id:e.priority.id,name:e.priority.name},entityState:{id:e.entityState.id,name:e.entityState.name},release:{id:e.release.id,name:e.release.name},iteration:{id:e.iteration.id,name:e.iteration.name},assignments:c.getAssignments(e)};b.push(f)}return b},done:function(a){var b={items:a};this.model.bus.fire("dataBind",b)}};var e=b.extend({_createDetailCommand:function(a){var b={};return b[a]=["id","name","effort",{project:["id","name"]},{priority:["id","name"]},{entityState:["id","name","isinitial","isfinal"]},{release:["id","name"]},{iteration:["id","name"]},{roleEfforts:["id",{role:["id","name"]}]},{assignments:["id",{role:["id"]},{generalUser:["id","firstName","lastName"]}]}],b},_retrieveEntity:function(a){var b=this.config.context,c=b.entity.entityType.name,d=b.entity.id,e=this._createDetailCommand("userStories"),f={id:d,nested:!0,fields:[e]};this.store.get(c,f).done({success:a.completeLoadEntities,scope:a})},onInit:function(){var a=new d(this);this._retrieveEntity(a)}});return e})