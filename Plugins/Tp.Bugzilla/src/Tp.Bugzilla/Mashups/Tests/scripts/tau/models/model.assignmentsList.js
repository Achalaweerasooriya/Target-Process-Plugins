define(["Underscore","tau/core/model-base","tau/configurator"],function(a,b,c){var d=function(a){this.model=a};d.prototype={assignableRetrieved:function(a){var b=a.data;this.model.assignable=this.assignable=b},done:function(){var a=this.assignable.owner;this.model.assignable=this.assignable;var b={effortPoints:this._getEffortPoints(),owner:this._convertUserDataToViewData(a),assignments:{groups:this.getGroups()},totalEffort:this._getTotalEffort()};this.assignable["tasks-count"]>0&&(b.tasksEffort={effort:this.floatToString(this.assignable["tasks-effort-sum"]),remain:this.floatToString(this.assignable["tasks-effortToDo-sum"])}),this.model.bus.fire("dataBind",b)},_getEffortPoints:function(){return this.model.config.context.getEffortPoint().shortName},_getTotalEffort:function(){var a=this.assignable,b={effort:this.floatToString(a.effort),remain:this.floatToString(a.effortToDo)};return b},_convertUserDataToViewData:function(a){var b=[c.getApplicationPath(),"/Avatar.ashx?UserId=",a.id,"&size=32"].join("");return{id:a.id,name:a.firstName+" "+a.lastName,avatar:b}},getRoles:function(){var a=this.assignable.roleEfforts,b=[],c=a.length;for(var d=0;d<c;d++)b.push(a[d].role);return b},getGroups:function(){var a=this.getRoles(),b=[];for(var c=0;c<a.length;c++){var d=a[c],e={roleEffort:this._getRoleEffort(d)};e.role=d,e.users=this.getUsersInRole(d),e.allowAdd=(d.isPair?2:1)>e.users.length,b.push(e)}return b},getUsersInRole:function(b){var c=[],d=a.sortBy(this.assignable.assignments,function(a){return a.id}),e=d.length;for(var f=0;f<e;f++){var g=d[f];if(g.role.id==b.id){var h=this._convertUserDataToViewData(g.generalUser);h.assignmentId=g.id,h.roleId=b.id,c.push(h)}}return c},_getRoleEffort:function(a){var b=this.assignable.roleEfforts,c=b.length;if(!a.hasEffort)return null;for(var d=0;d<c;d++){var e=b[d];if(e.role.id==a.id)return{effort:this.floatToString(e.effort),remain:this.floatToString(e.effortToDo),id:e.id}}},floatToString:function(a){return a.toFixed(2).replace(".00","")}};var e=b.extend({_getFieldsConfig:function(){var a={role:["id","name","isPair","hasEffort"]},b={generalUser:["id","firstName","lastName"]},c=["id","effort","effortToDo"];this.config.context.entity.entityType.name.toLowerCase()==="userstory"&&(c=c.concat(["tasks-count","tasks-effort-sum","tasks-effortToDo-sum"]));var d=[{project:["id"]},{owner:["id","firstName","lastName"]},{roleEfforts:["id","effort","effortToDo",a],list:!0},{assignments:["id",{role:["id","name"]},b],list:!0}];c=c.concat(d);return c},"bus evictTotalEfforts":function(){delete this.assignable.effort,delete this.assignable.effortToDo,this.store.evictProperties(this.assignable.id,this.assignable.__type,["effort","effortToDo"])},onInit:function(){var a=new d(this),b=this._getFieldsConfig(),c=this.config.context.entity;this.store.get(c.entityType.name,{id:c.id,fields:b},{success:a.assignableRetrieved,scope:a}).done({success:a.done,scope:a})},_onOwnerChanged:function(a){this.fire("ownerChanged",d.prototype._convertUserDataToViewData(a[0].owner))}});return e})