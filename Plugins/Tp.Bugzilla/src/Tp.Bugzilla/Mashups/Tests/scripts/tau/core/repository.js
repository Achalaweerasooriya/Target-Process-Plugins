define(["Underscore","tau/core/class","tau/core/event","tau/core/tau","tau/core/header","tau/core/comparer","tau/core/types","tau/store/db"],function(a,b,c,d,e,f,g,h){var i=b.extend({init:function(a){if(!a.service)throw"rest service should be defined";this.__allTypeLoadMarkers={},this.__listenerObjects={objects:[],holders:[]},this.__subscriptions={},this.types=a.types||g.getDictionary(),this.db=new h({types:this.types}),this.service=a.service},mergeCommands:function(b){var c={},e=this;return a.each(b,function(b){b=a.defaults(b,{name:"get",config:{},callbacks:{}}),b.callbacks=d.getCallbacks(b.callbacks),e._processFieldsConfig(b,b.name==="get"?null:"_getEmptyArray");var f=[b.type,b.config.id||"_",b.name,b.config.nested===!0?a.uniqueId():""].join("_");if(!c.hasOwnProperty(f))c[f]=b,b.commands=[];else{var g=c[f];e.db.mergeFields(g.config.fields,b.config.fields),g.commands.push(b)}}),c},execute:function(b){var c=this;a.isArray(b)||(b=[b]);var d=c.mergeCommands(b);a.each(a.values(d),function(a){if(a.executed===!0)throw"command is already executed. the same command can not be used twice";c["api "+a.name](a)})},_registerListener:function(b,c,e){var f=b||{},g=c.eventName;f.hasOwnProperty(g)||(f[g]={});var h=a.uniqueId(g),i={id:h,config:c,callback:d.createScopedCallbackIfRequired(e)},j=f[g];if(c.listener){var k=a.indexOf(this.__listenerObjects.objects,c.listener),l={id:h,holder:j};k<0?(this.__listenerObjects.objects.push(c.listener),this.__listenerObjects.holders.push([l])):this.__listenerObjects.holders[k].push(l)}return j[h]=i,i},_getListeners:function(b){var c=this,d=c._getSubscriptions(b.type);if(!d)return[];var e=d[b.eventName];if(!e)return[];var g=[];return a.each(a(e).values(),function(d){var e=d.config.filter,h=d.config.hasChanges||[];if(e){var i=c.db.getPersistedNode(b.obj.id,b.obj.type),j=b.obj;i&&i.data?j=i.data:b.nodeEvent.changes&&!a.isEmpty(b.nodeEvent.changes)&&(j=b.nodeEvent.changes);var k=f.compare(j,e);if(a(k.changes).keys().length>0)return}if(b.nodeEvent&&h.length>0){var l=b.nodeEvent.changes||{},m=a.select(h,function(a){return l.hasOwnProperty(a)}).length;if(m!==h.length)return}g.push(d)}),g},on:function(a,b){var c=this,d=a.type?c.types[a.type].name:"_all_",e=c._getSubscriptions(d);return c._registerListener(e,a,b)},_getSubscriptions:function(a){return this.__subscriptions.hasOwnProperty(a)||(this.__subscriptions[a]={}),this.__subscriptions[a]},unbind:function(b){var c=a.indexOf(this.__listenerObjects.objects,b);if(c<0)return;var d=this.__listenerObjects.holders[c];this.__listenerObjects.holders.splice(c,1),this.__listenerObjects.objects.splice(c,1),a(d).each(function(a){var b=a.holder[a.id];b.callback=function(){},delete a.holder[a.id]})},_autoAppend:function(b,c,d){a.each(c,function(c){a.any(b,function(a){return e.header.getFieldName(a)===e.header.getFieldName(c)})||b[d?d:"unshift"](c)})},registerData:function(a){this.db.register(a)},_getEmptyArray:function(){return[]},_getDefaultFields:function(b){var c=this.types[b.type];return a.clone(c?c.fields||[]:[])},_processFieldsConfig:function(b,c){var d=this;c=c||"_getDefaultFields";if(!b.config.fields||b.config.fields.length===0)b.config.fields=d[c](b);var e=b.config.fields;d._autoAppend(e,["id"]);for(var f=e.length;f>0;f--){var g=e[f-1];if(a.isSimple(g))continue;var h=a.getFieldName(g),i=b.type?d.types[b.type]:null,j=null,k=[];if(i&&i.refs&&i.refs[h]){var l=i.refs[h];l.list===!0&&(g.list=!0),k=l.fields,j=l.name}var m={type:j,config:{fields:g[h]||k}};g[h]=d._processFieldsConfig(m,c)}var n=e.length;for(f=0;f<n;f++){var o=a.getFieldName(e[f]);for(var p=f+1;p<n;p++)a.getFieldName(e[p])===o&&(a.isSimple(e[f])||a.mergeFields(e[f][o],e[p][o]),e.splice(p,1),n--,p--)}return e},_invokeCommandCallback:function(b,c,d,e){var f=this;f._invokeCommandCallbackR(b,c,d,e);if(d.config.silent===!0)return;if(!f.__subscriptions._all_||a.isEmpty(f.__subscriptions._all_))return;var g=a.values(f.__subscriptions._all_[b]||[]),h={name:b,data:{cmd:d,data:e}};a(g).each(function(a){a.callback(h)})},_invokeCommandCallbackR:function(b,c,d,e){var f=this;d.executed=!0,c[b]({command:d,data:e}),d.hasOwnProperty("commands")&&a.each(d.commands,function(a){a.executed=!0,a.failed=d.failed,f._invokeCommandCallbackR(b,a.callbacks,a,e)})},"api remove":function(a){var b=this,c=a.callbacks;a.callbacks={success:function(d){var e=b.evictPersistedObject(a.config.id,a.type);b._invokeCommandCallback("success",c,a,a.callbacks),b._populateAfterRemoveEvent(a,e)},failure:function(d){a.failed=!0,b._invokeCommandCallback("failure",c,a,d)}},b._populateBeforeRemoveEvent(a),b.service.remove(a)},evictPersistedObject:function(a,b){return this.db.remove(a,this.types[b].name)},evictProperties:function(a,b,c){this.db.removeProperties(a,this.types[b].name,c)},isPropertyInitialized:function(a,b,c){return this.db.isPropertyInitialized(a,b,c)},"api save":function(b){var c=this,d=b.callbacks;b.config.$set=b.config.$set||{},b.callbacks={success:function(e){a.extend(e,{__type:b.type});var f=a.extend(a.extend({},b.config.$set),e),g=c.db.register(f);c._invokeCommandCallback("success",d,b),c._notifyAboutNewsAndChanges(g,b)},failure:function(a){b.failed=!0,c._invokeCommandCallback("failure",d,b,a)}},c._populateBeforeSaveEvent(b),c._processFieldsConfig(b,"_getEmptyArray"),c.service.save(b)},_notifyAboutNewsAndChanges:function(b,c){var d=this;a.each(a.keys(b.tree),function(e){a.each(a(b.tree[e]).values(),function(a){d._populateEvent(c,"afterSave",a,{id:a.id,type:e})})})},_populateEvent:function(b,c,d,e){var f=a.uniqueId("repositoryEvent"),g=this._getListeners({type:e.type,eventName:c,nodeEvent:d,obj:e});if(g.length!==0){var h={id:f,name:c,data:{id:e.id,type:e.type,cmd:b,obj:e,changes:d.changes}};a(g).each(function(a){a.callback(h)})}},_populateBeforeRemoveEvent:function(a){this._populateEvent(a,"beforeRemove",{},{id:a.config.id,type:a.type})},_populateAfterRemoveEvent:function(b,c){var d=this;a.each(c.deletedData,function(a){d._populateEvent(b,"afterRemove",{},a)})},_populateBeforeSaveEvent:function(a){this._populateEvent(a,"beforeSave",{changes:a.config.$set||{}},{id:a.config.id,type:a.type})},markRecordSetAsCompleteLoaded:function(a){this.__allTypeLoadMarkers[a]=!0},isTypeMarkedAsCompleteLoaded:function(a){return this.__allTypeLoadMarkers[a]===!0},_appendDiscriminator:function(b,c){var d=this;b.isParentType&&a.indexOf(c,"id")>=0&&d._autoAppend(c,[b.discriminator],"push"),a.each(c,function(a){if(e.header.isSimple(a))return;var c=e.header.getFieldName(a),f=b.refs[c];f&&d._appendDiscriminator(d.types[f.name],a[c])})},_processCommandForGet:function(b){var c=this,d=c.db.get(b.config.id,b.type,b.config),e=b.config.fields;if(d.notInitializedFields.length===0)if(!d.all||!!c.isTypeMarkedAsCompleteLoaded(b.type))return b.config.fields=e,c._invokeCommandCallback("success",b.callbacks,b,d.data),{isInvoked:!0};var f=d.notInitializedFields;return d.all&&!c.isTypeMarkedAsCompleteLoaded(b.type)&&(f=a.clone(e)),{isInvoked:!1,fields:f}},_runReadCommand:function(b,c,d,e){var f=this;f._appendDiscriminator(f.types[b.type],d),a.extend(b.config,{fields:d}),f._processFieldsConfig(b);var g=b.callbacks;b.callbacks={success:function(d){b.config.fields=c,a.defaults(d,{__type:b.type}),f.db.register(d);var h=e(d);f._invokeCommandCallback("success",g,b,h),b.callbacks=g},failure:function(a){b.config.fields=c,b.failed=!0,f._invokeCommandCallback("failure",g,b,a),b.callbacks=g}},this.service[b.name](b)},"api find":function(b){var c=this,d=b.config.fields,e=function(e){var f=[];a.each(e,function(a){f.push(c.db.get(a.id,b.type,{fields:d}).data)});if(e.hasOwnProperty("getNextUrl")){f.isNextPageAvailable=function(){return!0};var g=a.clone(b);g.config=a.clone(g.config),g.config.$skip=g.config.$skip+g.config.$limit,f.getNextPageCommand=function(){return g}}else f.isNextPageAvailable=function(){return!1};return f};this._runReadCommand(b,d,a.clone(d),e)},"api get":function(a){var b=this,c=a.config.fields,d=b._processCommandForGet(a);if(d.isInvoked)return;var e=function(d){return a.config.id||b.markRecordSetAsCompleteLoaded(a.type),b.db.get(a.config.id,a.type,{fields:c}).data};this._runReadCommand(a,c,d.fields,e)}});return i})