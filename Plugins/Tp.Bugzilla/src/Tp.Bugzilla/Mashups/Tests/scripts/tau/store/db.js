define(["Underscore","tau/core/class","tau/core/header","tau/core/comparer"],function(a,b,c,d){return b.extend({init:function(a){this.__data={},this.__types=a.types||{}},_getTypeHolder:function(a,b){var c=a[b]||{};a.hasOwnProperty(b)||(a[b]=c);return c},_getTypeDictionary:function(a){return this._getTypeHolder(this.__data,a)},getPersistedNode:function(a,b){var c=this,d=c.__data[b];if(!d)return null;if(!a)return d;var e=d[a];return e?e:null},isDataRegistered:function(a,b){return(this.__data[b]||{}).hasOwnProperty(a)},_registerReferenceInNode:function(a,b,c,d,e){var f={isReference:!0,id:a,type:b.name};f.property=e,f.list=d.list,c.refs[f.type+"_"+f.id+"_"+f.property]=f},_registerReferences:function(b,c,d){var e=this,f=e._getRegisterTemplate(),g=function(a){return a.id===c.id};a.each(a(b.refs||{}).keys(),function(h){if(!!c.hasOwnProperty(h)){var i=c[h],j=b.refs[h];if(d.data.hasOwnProperty(h)){var k=d.data[h]||[];a.isArray(k)||(k=[k]),a.each(k,function(a){var d=e.getPersistedNode(a.id,a.type);e._cleanUpRefsInNode(c.id,b.name,d,h)})}if(i===null||i.id===null){c[h]=null,j.list&&(c[h]=[]);return}a.extend(i,{__type:j.name});var l=e._register(i);a.mergeArrayObjects(f,l,["diffs"]),c[h]=j.list?a.extend(l.refs,{isReference:!0,type:j.name,list:!0}):l.refs[0],a.each(l.nodes,function(a){e._registerReferenceInNode(c.id,b,a,j,h)});if(j.list!==!0){var m=e.__types[j.name];m&&a.each(a(m.refs||{}).keys(),function(i){var j=m.refs[i];if(j.name==b.name&&j.list===!0){var k=e.getPersistedNode(c[h].id,m.name)||{},l=k.data||{},n=l[i];if(a.isArray(n)&&!a.any(n,g)){var o={};e._attachReference(n,c.id,b.name),o[i]=n,e._registerReferenceInNode(k.id,k.origin?e.__types[k.origin.type]:m,d,j,i),f.diffs.push({id:k.id,type:m.name,changes:o})}}})}}});return f},_removeCascadeObjects:function(b,c){var d=this,e=d._getRegisterTemplate();a.each(a(b.refs||{}).keys(),function(f){var g=b.refs[f];g.cascade&&(g.list?a.each(c[f],function(a){d._extendRegister(e,d.remove(a.id,a.type))}):d._extendRegister(e,d.remove(c[f].id,c[f].type)))});return e},_cleanUpRefsInNode:function(b,c,d,e){a(a(d.refs).keys()).each(function(a){var f=new RegExp(c+"_"+(b||"\\d*")+("_"+e||""));a.search(f)!==-1&&delete d.refs[a]})},_removeObjectFromRefs:function(b,c,d){var e=this,f=e._getRegisterTemplate();a(d).each(function(d){var g=e.getPersistedNode(d.id,d.type);if(!!g){f.nodes.push(g);var h={};h[d.property]=null,d.list?(g.data[d.property]=a(g.data[d.property]).select(function(a){return a.id!=b}),h[d.property]=g.data[d.property]):g.data[d.property]=null,e._cleanUpRefsInNode(b,c,g),f.diffs.push({id:d.id,type:d.type,changes:h})}});return f},removeProperties:function(b,c,d){var e=this,f=e.getPersistedNode(b,c);if(!!f){var g=e.__types[c],h=f.data;a(d).each(function(c){var d=h[c];d&&d.isReference&&(d.list||(d=[d]),a(d).each(function(a){var d=e.getPersistedNode(a.id,a.type);e._cleanUpRefsInNode(b,g.name,d,c)})),delete h[c]})}},remove:function(b,c){var d=this,e=d._getRegisterTemplate(),f=d.getPersistedNode(b,c);if(!f)return e;var g=d.__types[c],h=f.refs,i=f.data;e.deletedData.push(a(i).defaults({id:b,type:c})),delete d.__data[c][b],d._extendRegister(e,d._removeCascadeObjects(g,i)),d._extendRegister(e,d._removeObjectFromRefs(b,c,h));return e},isPropertyInitialized:function(a,b,c){var d=this.getPersistedNode(a,b);return d?d.data.hasOwnProperty(c):!1},_attachReference:function(a,b,c){var d={isReference:!0,id:b,type:c};a.push(d);return d},_registerParentNodes:function(b,c,d,e){var f=this,g=f.__types[b];if(g){var h=g.parent;while(h){var i=f.__types[h];e=f._getTypeDictionary(h);if(!i)break;e[c]=e[c]||{},a.extend(e[c],{data:d.data,refs:d.refs,id:c,origin:{id:c,type:b}}),h=i.parent}}},_getRegisterTemplate:function(){return{refs:[],nodes:[],diffs:[],tree:{},deletedData:[]}},_registerObjectInTree:function(b,c){var d=this,e=d._getTypeHolder(b,c.type);if(!e.hasOwnProperty(c.id)){var f={},g=d.__types[c.type],h={id:c.id,changes:f};if(g.isParentType||g.parent){var i=d.getPersistedNode(c.id,c.type);i.origin&&(g=d.__types[i.origin.type],i=d.getPersistedNode(i.origin.id,i.origin.type));var j=g.parent;while(j){var k=d.__types[j],l=d._getTypeHolder(b,k.name);l[c.id]=h,j=k.parent}}e[c.id]=h}a.extend(e[c.id].changes,c.changes)},_extendTree:function(b,c){var d=this;a.each(c,function(a){d._registerObjectInTree(b,a)})},_extendRegister:function(b,c){this._extendTree(b.tree,c.diffs),a.mergeArrayObjects(b,c,["diffs","deleteData"])},register:function(a){return this._register(a)},isTypeDetectionRequired:function(a){var b=this.__types[a];return b.isParentType},getTypeDetectionForNode:function(a,b){if(!this.isTypeDetectionRequired(b))return{required:!1};var c=this.getPersistedNode(a,b),d={required:!0};return c?c.origin?!c.origin.id||!c.origin.type?d:{required:!1,type:c.origin.type}:d:d},_register:function(b){var c=this,e=c._getRegisterTemplate();if(a.isEmpty(b))return e;var f=b.__type;a.isArray(b)||(b=[b]),a.each(b,function(b){var g=b.__type||f,h=b.id;if(!g||!h)throw"properties __type and id are required for data registration";var i=c.__types[g];if(i.isParentType){var j=c.getTypeDetectionForNode(h,f);g=j.required?i.detectType(b):j.type,i=c.__types[g]}var k={id:h,type:g,changes:{}},l=c._getTypeDictionary(g),m=l[h];m||(l[h]=m={data:{},id:h,refs:{}}),c._registerParentNodes(g,h,m,l);var n=a.clone(m.data),o=a.clone(b),p=c._registerReferences(i,o,m);c._extendRegister(e,p),a.extend(m.data,o),m.data.hasOwnProperty("__type")&&delete m.data.__type,c._attachReference(e.refs,h,g),e.nodes.push(m),a.each(a(b).keys(),function(a){if(a!=="__type"&&a!=="id"){var b=n[a],c=m.data[a];d.isEqualIncluded(c,b)||(k.changes[a]=c)}}),c._extendTree(e.tree,[k]),e.diffs.push(k)});return e},get:function(b,c,d){var e=this;if(!b){var f={data:[],notInitializedFields:[],all:!0};a.each(a(this._getTypeDictionary(c)).keys(),function(a){var b=e._get(a,c,d);f.data.push(b.data),e.mergeFields(f.notInitializedFields,b.notInitializedFields)});return f}return this._get(b,c,d)},_get:function(b,d,e){var f=this;e=e||{};var g=f.getPersistedNode(b,d),h=f.__types[d]||{},i=h.refs||{},j=e.$fields||e.fields||[],k={data:null,type:h,notInitializedFields:j};if(!g)return k;var l={},m=[],n=function(a,b,c){var d=f._get(a.id,a.type,{fields:b||[]});d.notInitializedFields.length&&c.push(d.notInitializedFields);return d.data},o=g.data;a.each(j,function(b){var d=c.header.getFieldName(b),e=o[d];if(a.isUndefined(e))m.push(b);else{l[d]=e;if(i.hasOwnProperty(d)&&e){var g=[];if(a.isArray(e)){var h=e;e=[],a.each(h,function(a){e.push(n(a,b[d],g))})}else e=n(e,b[d],g);if(g.length>0){var j={};j[d]=[],a(g).each(function(a){f.mergeFields(j[d],a)}),j[d].length>0&&m.push(j)}}l[d]=e}}),g.origin&&(d=g.origin.type);return{type:h,data:a(l).defaults({id:b,__type:d}),notInitializedFields:m}},mergeFields:function(b,c,d){return a.mergeFields(b,c,d)},destroy:function(){delete this.__data,delete this.__types}})})