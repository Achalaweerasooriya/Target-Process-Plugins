define(["Underscore","tau/core/model-base","tau/models/dataprocessor/model.processor.comment","tau/core/dates","tau/core/types.targetprocess"],function(a,b,c,d){function e(a,b){this.model=a,this.converter=b}e.prototype={getAssignableRetrievedCallback:function(){return{scope:this,success:this.onAssignableRetrieved}},onAssignableRetrieved:function(b){this.assignable=this.model.assignable=b.data;var c=b.data.comments,e=a(c).sortBy(function(a){return+d.parse(a.createDate)}),f=this.convertDTO(e).convertToTree(null);this.model.bus.fire("dataBind",{items:f})},convertDTO:function(b){var c=this;this.convertedComments=a(b).map(function(a){return c.converter.convertDTO(a)});return this},convertToTree:function(a){var b=[],c=this.convertedComments;for(var d=0,e=c.length;d<e;d++){var f=c[d];f.parentId==a&&(b.push(f),f.comments=this.convertToTree(f.id))}return b}};var f=b.extend({name:"Comments",onInit:function(){var a=this.config.context.entity;this.converter=new c(this.config.context);var b=new e(this,this.converter);this.store.get(a.entityType.name,{id:a.id,fields:["id",{comments:["id","description","createDate","parentId",{owner:["id","firstName","lastName","kind"]}],list:!0}]},b.getAssignableRetrievedCallback()).done()},"bus createDTO":function(a){var b=a.data,c=this.converter.convertDTO(b);c.comments=[],this.fire("DTOCreated",c)},destroy:function(){this.converter.destroy(),this.converter=null,this._super()}});return f})