define(["Underscore","jQuery","tau/core/Class","tau/core/types","tau/services/service.arrayToJsonConverter","tau/core/header","libs/json2"],function(a,b,c,d,e,f){var g=c.extend({init:function(c){c=c||{},a.defaults(c,{api:b,types:d.getDictionary()}),this.config=c},remove:function(a){var b=this,c={Id:a.config.id},d={url:b.getUrl(a),contentType:"application/json; charset=utf-8",type:"DELETE",processData:!1,data:JSON.stringify(c),dataType:"json"},e=this.getErrorCallback(a);b.config.api.ajax(d).success(function(){a.callbacks.success({id:a.config.id})}).error(e)},save:function(b){var c={$set:b.config.$set||{}};if(b.type==="prioritizer"){a.extend(c,{$include:this._formIncludes(b.config.fields)}),this.executeCrudCommandViaPageService(b,c,"save");return}this.executeCrudCommand(b,c,"save")},getErrorCallback:function(a){var c=this.config.appPath,d=function(d){if(d.status===401){document.location.href=c+"/login.aspx?ReturnUrl="+document.location.href;return}try{d.response=b.parseJSON(d.responseText)}catch(e){}finally{a.callbacks.failure(d)}};return d},executeCrudCommandViaPageService:function(c,d,e){var g=this,h={id:c.config.id,type:c.type};a.extend(h,d);var i=JSON.stringify({json:JSON.stringify(h)}),j={url:[g.config.appPath,"PageServices/RESTCrud.asmx",e].join("/"),contentType:"application/json; charset=utf-8",type:"POST",data:i,dataType:"json"},k=this.getErrorCallback(c);g.config.api.ajax(j).success(function(d){var e={id:d.d.id};if(d.d.isError===!0){c.callbacks.failure({Message:d.d.errorMessage,CRUD:!0});return}if(d.d.jsonToReturn&&d.d.jsonToReturn.length>0){var g=b.parseJSON(d.d.jsonToReturn);g=f.formatObject(g),a.extend(e,g)}c.callbacks.success(e)}).error(k)},executeCrudCommand:function(b,c){var d=this,e={Id:b.config.id};a.extend(e,f.formatObject(c.$set,"Upper"));var g={url:d.getUrl(b,"resultInclude"),contentType:"application/json; charset=utf-8",type:"POST",processData:!1,data:JSON.stringify(e),dataType:"json"},h=this.getErrorCallback(b);d.config.api.ajax(g).success(function(a){b.callbacks.success(f.formatObject(a))}).error(h)},find:function(a){this.get(a)},get:function(b){var c=this;a.defaults(b.config,{format:"array"});var d=b.config.nested===!0||!b.config.id?"convertArray":"convert",g=function(a){b.arrStr=a;var f=c.config.api.parseJSON(a);return e[d]({header:c._getFields(b)},f)},h=function(a){var b=c.config.api.parseJSON(a),d=b;return b&&b.hasOwnProperty("Items")&&(d=b.Items,b.hasOwnProperty("Next")&&(d.getNextUrl=function(){return b.Next})),d},i=c.getUrl(b),j={url:i,accepts:{array:"application/x-array"},dataType:b.config.format,converters:{"text array":g,"text json":h}},k=function(a){b.config.format!=="array"&&(a=f.formatObject(a));if(b.type==="context"||b.type==="implementationHistory")a.id=b.config.id;if(b.config.nested===!0){var d=c._getNestedObject(b),e=f.header.getFieldName(d),g={id:b.config.id};g[e]=a,a=g}b.callbacks.success(a)},l=c.getErrorCallback(b),m=[],n=function(d){if(!a.isArray(d)||b.name!=="get"){k(d);return}m=m.concat(d);if(d.getNextUrl){var e=a.clone(j);e.url=d.getNextUrl(),c.config.api.ajax(e).success(n).error(l)}else k(m)};c.config.api.ajax(j).success(n).error(l)},_formIncludes:function(b){var c=[],d=this;return a.each(b,function(a){if(f.header.isSimple(a)){var b=a;a.indexOf("$ref")===0&&(b=a.replace("$ref:","")),c.push(b);return}var e=f.header.getFieldName(a);c.push(e+d._formIncludes(a[e]))}),["[",c.join(","),"]"].join("")},_getQueryOperators:function(){var b=function(b,c){var d=this,e=[];return a.isArray(c)||(c=[c]),a.each(c,function(a){e.push("("+b+" "+d.name+" "+JSON.stringify(a)+")")}),e},c=function(a){return["("+a+" "+this.name+")"]},d=function(b,c){var d=this,e=[];a.isArray(c)||(c=[c]);var f=[];return a(c).each(function(a){f.push(JSON.stringify(a))}),e.push("("+b+" "+d.name+" ("+f.join(",")+"))"),e};return{$in:{name:"in",render:d},$ne:{name:"ne",render:b},$gt:{name:"gt",render:b},$gte:{name:"gte",render:b},$lt:{name:"lt",render:b},$lte:{name:"lte",render:b},$contains:{name:"contains",render:b},$eq:{name:"eq",render:b},$isNull:{name:"is null",render:c},$isNotNull:{name:"is not null",render:c}}},_isQueryValueWithOperator:function(b,c){var d=a(b).keys();if(d.length===0)return!1;var e=c||this._getQueryOperators();return e.hasOwnProperty(d[0])},_formWhere:function(b,c){var d=[],e=this;c=c||"";var f=e._getQueryOperators();return a.each(a(b).keys(),function(g){var h=b[g],i=c+g;if(a.isString(h)||a.isNumber(h)||a.isDate(h)||a.isArray(h)||a.isBoolean(h)||a.isNull(h)){var j=h===null?"$isNull":"$eq";d=d.concat(f[j].render(i,h));return}if(e._isQueryValueWithOperator(h,f)){a.each(a(h).keys(),function(a){d=d.concat(f[a].render(i,h[a]))});return}d.push(e._formWhere(h,g+"."))}),d},_getWhere:function(a){var b=this._formWhere(a);return b.length===0?"":"&where="+encodeURIComponent(b.join(" and "))},_getNestedObject:function(b){var c=null;return a.each(b.config.fields,function(a){f.header.isSimple(a)||(c=a)}),c},_getFields:function(a){if(a.config.nested!==!0)return a.config.fields;var b=this._getNestedObject(a),c=f.header.getFieldName(b);return b[c]},_getOrderBy:function(a){return!a.config.$orderBy||a.config.$orderBy===""?"":"&orderBy="+a.config.$orderBy},_getOrderByDesc:function(a){return!a.config.$orderByDesc||a.config.$orderByDesc===""?"":"&orderByDesc="+a.config.$orderByDesc},getUrl:function(b,c){var d=this;a.defaults(b.config,{$skip:0,$limit:999,$query:{}});if(b.type==="context")return b.config.format="json",[d.config.path,"context.asmx","?ids="+b.config.id].join("/");if(b.type==="implementationHistory")return b.config.format="json",[d.config.appPath,"Reports/ImplementationHistory.ashx?id="+b.config.id+"&"+(new Date).valueOf()].join("/");var e=d.config.types[b.type]||{resource:b.type},g=b.config.fields,h=[d.config.path,e.resource+".asmx",b.config.id].join("/");if(b.config.nested===!0){var i=d._getNestedObject(b),j=f.header.getFieldName(i);g=i[j],h=[h,j].join("/")}return h=[h,"?skip=",b.config.$skip,"&take=",b.config.$limit,"&",c?c:"include","=",d._formIncludes(g),b.name==="find"?d._getWhere(b.config.$query):"",d._getOrderBy(b),d._getOrderByDesc(b)].join(""),h}});return g})