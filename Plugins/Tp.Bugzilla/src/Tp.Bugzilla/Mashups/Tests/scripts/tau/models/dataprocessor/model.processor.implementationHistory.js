define(["Underscore","tau/core/termProcessor"],function(a,b){var c=function(b,c,d){return a.each(d,function(a){a in c&&(b[a]=c[a])}),b},d=function(a){this._historyItems=a};d.enhance=function(a){return(new this(a)).enhance()},d.prototype={constructor:d,enhance:function(){var a=this._historyItems;return a=this._addDateSpan(a),a},_addDateSpan:function(b){var c=this._createItemStateGroups(b);return a.each(c,function(b){var c=a.first(b).state;c.dateSpan=b.length}),b},_createItemStateGroups:function(b){var c=[],d=null,e=null;return a.each(b,function(a){d!=a.state.name&&(d=a.state.name,e&&c.push(e),e=[]),e.push(a)}),c.push(e),c}};var e=function(a){this._historyItems=a};e.compress=function(a){return(new this(a)).compress()},e.prototype={constructor:e,compress:function(){var a=this._historyItems;return a=this._compressAssignments(a),a=this._compressStates(a),a},_compressStates:function(b){var c=a.select(b,function(a,c){var d=!0;return this._isItemStateNeedsCompression(a.state)&&this._isItemNeedsCompression(a,c,b)&&(d=!1),d},this);return c},_isItemStateNeedsCompression:function(a){return a.isInitial||a.isFinal},_isItemNeedsCompression:function(a,b,c){var d=!1,e=c[b-1],f=!e;if(!f){var g=e.state.name!=a.state.name,h=a.transitions>1,i=a.assignments,j=a.relatedEntities,k=a.spentTime>0;g||!h&&!i&&!j&&!k&&(d=!0)}return d},_compressAssignments:function(a){return this._clearDublicatedAssignmentsForState(a),this._mergeIdenticalAssignmentsForItem(a),a},_clearDublicatedAssignmentsForState:function(b){var c=a.select(b,function(a,c){var d=!1;if(a.assignments){var e=b[c-1];e&&e.state.name==a.state.name&&this._areAssignmentsTheSame(e.assignments,a.assignments)&&(d=!0)}return d},this);a.each(c,function(a){delete a.assignments})},_mergeIdenticalAssignmentsForItem:function(b){a.each(b,function(b){if(b.assignments){var c=[],d={};a.each(b.assignments,function(a){a.id in d?d[a.id].roles.push(a.role):(d[a.id]=a,a.roles=[a.role],delete a.role,c.push(a))}),b.assignments=c}})},_areAssignmentsTheSame:function(b,c){var d=a.pluck(b,"id").join(""),e=a.pluck(c,"id").join("");return d==e}};var f=function(a){this._inputData=a,this._termProcessor=new b(a.terms)};return f.transform=function(a){return(new this(a)).transform()},f.prototype={constructor:f,transform:function(){var a={entityStates:this._getEntityStateNames(),historyItems:this._getHistoryItems()};return a},_getHistoryEntries:function(){return this._inputData.response[0].data.statistics.entries},_getAllEntityStatesForProcess:function(){return this._inputData.response[1].data.entityStates},_getAllUsers:function(){return this._inputData.response[2].data},_getAllRoles:function(){return this._inputData.response[3].data},_getEntityStateNames:function(){var b=this._getEntityStates(),c=this._sortEntityStates(b),d=a.map(c,function(a){return a.name});return d},_getEntityStates:function(){var b=this._inputData.entityTypeName,c=a.select(this._getAllEntityStatesForProcess(),function(a){return b.toLowerCase()==a.entityType.name.toLowerCase()});return c},_sortEntityStates:function(b){var c=a.sortBy(b,function(a){var b=a.numericPriority;return a.isInitial?b=Number.NEGATIVE_INFINITY:a.isFinal&&(b=Number.POSITIVE_INFINITY),b}).reverse();return c},_getHistoryItems:function(){var b=[];return a.each(this._getHistoryEntries(),function(a){b.push(this._createHistoryItem(a))},this),b=this._sortHistoryItems(b),b=this._enhanceHistoryItems(b),b=this._compressHistoryItems(b),b},_createHistoryItem:function(b){var c={date:new Date(Date.parse(b.date)),spentTime:parseFloat(b.time),transitions:parseFloat(b.transitions),state:this._getHistoryEntryState(b)},d=this._getHistoryEntryRelatedEntities(b);return a.isEmpty(d)||(c.relatedEntities=d),b.assignments&&(c.assignments=this._getHistoryEntryAssignments(b)),c},_getHistoryEntryState:function(a){var b=this._getEntityStateInfo(a.stateId),d=c({},b,["name","isInitial","isFinal"]);return b.role&&(d.roleId=b.role.id),d},_getEntityStateInfo:function(b){var c=a.detect(this._getAllEntityStatesForProcess(),function(a){return b==a.id});return c},_getHistoryEntryRelatedEntities:function(a){var b=c({},a,["opened","closed"]);return this._setEntityAlias(b.opened),this._setEntityAlias(b.closed),b},_setEntityAlias:function(b){a.each(b,function(a){var b=this._getEntityAlias(a.type);b&&(a.alias=b)},this)},_getEntityAlias:function(a){var b=this._termProcessor.getTerms(a);return b?b.name:null},_getHistoryEntryAssignments:function(b){var c=[];return a.each(b.assignments,function(a){var b=this._getUserInfo(a.userId);b&&c.push({id:a.userId,firstName:b.firstName,lastName:b.lastName,role:{id:parseInt(a.roleId),name:this._roleIdToName(a.roleId)}})},this),c},_getUserInfo:function(b){var d=null,e=a.detect(this._getAllUsers(),function(a){return b==a.id});return e&&(d=c({},e,["firstName","lastName"])),d},_roleIdToName:function(b){var c=a.detect(this._getAllRoles(),function(a){return b==a.id});return c.name},_sortHistoryItems:function(b){return a.sortBy(b,function(a){return new Date(Date.parse(a.date))})},_enhanceHistoryItems:function(a){return d.enhance(a)},_compressHistoryItems:function(a){return e.compress(a)}},f})