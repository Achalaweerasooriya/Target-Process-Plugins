define(["Underscore","tau/core/types","tau/core/model-base","tau/configurator","tau/utils/utils.textsearch"],function(a,b,c,d,e){return c.extend({init:function(){this._super.apply(this,arguments),this.textSearch=new e},"bus setFilter":function(a){this.config.data.filter=a.data.filter,this.fire("refresh",{refreshSelector:".user-list,.footer-box"})},setShowMore:function(a){this.config.data.showMore=a},"bus showMore":function(){this.setShowMore(!0),this.fire("refresh",{refreshSelector:".user-list,.footer-box"})},onInit:function(){this.fire("registerStoreRequest"),this.fire("commitTransaction",{})},"bus projectMembersReady+excludedUserReady+projectRolesReady":function(a){var b=a.projectMembersReady.data,c=a.excludedUserReady.data,d=a.projectRolesReady.data,e=[],f=[];!this.excludedUsersContainsLoggedUser(c)&&this.loggedUserInProjectTeam(b)&&(f=[{id:"assign-to-me",title:"Assign To Me"}]),this.filterIsNotEmpty()?e=this.getFilteredGroups(d,b,c):(e=this.getGroups(b,c,d),e.length==0&&(this.setShowMore(!0),e=this.getGroups(b,c,d)));var g={headerActions:f,moreAvailable:!1,groups:e};this.fire("extendDataToBind",g),this.fire("dataBind",g)},getGroups:function(a,b,c){var d=[];for(var e=0;e<c.length;e++){var f=c[e];if(this.usersForRoleIsVisible(f)){var g=this.getUsersForRole(f,a,b);g.length>0&&d.push({role:f,users:g})}}return d},isStringValidForFilter:function(a){return this.textSearch.match(a,this.config.data.filter)!==null},getFilteredGroups:function(a,b,c){var d=[];for(var e=0;e<a.length;e++){var f=a[e],g=[];if(this.isStringValidForFilter(f.name))g=this.getUsersForRole(f,b,c);else{g=this.getUsersForRole(f,b,c);var h=[];for(var i=0;i<g.length;i++)this.isStringValidForFilter(g[i].name)&&h.push(g[i]);g=h}g.length>0&&d.push({role:f,users:g})}return d},usersForRoleIsVisible:function(a){var b=this.config.data||{};if(this.isMoreAvailable()){if(b.hasOwnProperty("roleId"))return b.roleId===a.id;if(b.role)return a.id==b.role.id}return!0},userIsNotExcluded:function(a,b){if(!a.user.isActive)return!1;var c=a.user.id;if(b.constructor!=Array)return c!=b.id;for(var d=0;d<b.length;d++)if(c==b[d].id)return!1;return!0},getUsersForRole:function(a,b,c){var d=[];for(var e=0;e<b.length;e++){var f=b[e];f.role.id==a.id&&this.userIsNotExcluded(f,c)&&d.push(this.convertUser(f.user))}return d.sort(function(a,b){var c=a.name.toLowerCase(),d=b.name.toLowerCase();return c<d?-1:c>d?1:0}),d},convertUser:function(a){return{id:a.id,name:[a.firstName,a.lastName].join(" "),role:a.role,avatar:[d.getApplicationPath(),"/Avatar.ashx?UserId=",a.id,"&size=32"].join("")}},getLoggedUser:function(){return this.config.context.applicationContext.loggedUser},loggedUserInProjectTeam:function(b){var c=this.getLoggedUser();return a.any(b,function(a){return a.user.id===c.id})},excludedUsersContainsLoggedUser:function(a){var b=this.getLoggedUser();for(var c=0;c<a.length;c++)if(a[c].id===b.id)return!0;return!1},filterIsNotEmpty:function(){return this.config.data.filter&&this.config.data.filter.length},filterIsEmpty:function(){return!this.filterIsNotEmpty()},isMoreAvailable:function(){var a=this.config.data;return this.filterIsEmpty()&&a.showMore!==!0&&(a.hasOwnProperty("roleId")||a.hasOwnProperty("role"))},destroy:function(){this.project=null,this.entity=null,this._super()}})})