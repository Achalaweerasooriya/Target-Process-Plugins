define(["Underscore","tau/core/model.editable.base","tau/configurator","tau/utils/utils.textsearch"],function(a,b,c,d){return b.extend({"bus setFilter":function(a){this.config.data.filter=a.data.filter,this.fire("refresh",{refreshSelector:".user-list,.footer-box"})},setShowMore:function(a){this.config.data.showMore=a},"bus showMore":function(){this.setShowMore(!0),this.fire("refresh",{refreshSelector:".user-list,.footer-box"})},"bus removeAssignment":function(){var a={id:this.config.data.assignmentId,typeName:"assignment"};this.fire("remove",a)},assignTo:function(b){var c={typeName:"assignment",$include:[{generalUser:["id","firstName","lastName"]},{role:["id","name"]},{assignable:["id"]}]};this.config.data.hasOwnProperty("assignmentId")?a.extend(c,{id:this.config.data.assignmentId,$set:{generalUser:{id:b}}}):this.config.data.role?a.extend(c,{id:null,$set:{generalUser:{id:b},assignable:{id:parseInt(this.config.context.entity.id)},role:{id:this.config.data.role.id}}}):c={type:this.config.context.entity.entityType.name,$set:{owner:{id:b}},$include:[{owner:["id","firstName","lastName"]}]},this.fire("save",c)},"bus assignToLoggedUser":function(){this.assignTo(this.getLoggedUser().id)},"bus changeAssignment":function(a){var b=a.data.user.id;this.assignTo(b)},onInit:function(){var a={model:this,success:function(a){this.model.processEntity(a.data)}};a.scope=a;var b=this.config.context.entity,c={role:["id","name"]},e={generalUser:["id","firstName","lastName"]},f={id:b.id,fields:["id",{project:["id"]},{owner:["id"]},{assignments:["id",c,e],list:!0}]};this.store.get(b.entityType.name,f,a).done(),this.textSearch=new d},processEntity:function(a){var b={model:this,success:function(a){var b=this.model.processProject(a.data);this.model.fire("dataBind",b)}};b.scope=b;var c={user:["id","firstName","lastName","isActive"]},d={role:["id","name"]},e={projectMembers:[c,d]},f={id:a.project.id,fields:["id",e]};this.entity=a,this.store.get("project",f,b).done()},getGroups:function(){var a=this.getRoles(),b=[];for(var c=0;c<a.length;c++){var d=a[c];if(this.usersForRoleIsVisible(d)){var e=this.getUsersForRole(d);e.length>0&&b.push({role:d,users:e})}}return b},isStringValidForFilter:function(a){return this.textSearch.match(a,this.config.data.filter)!==null},getFilteredGroups:function(){var a=this.getRoles(),b=[];for(var c=0;c<a.length;c++){var d=a[c],e=[];if(this.isStringValidForFilter(d.name))e=this.getUsersForRole(d);else{e=this.getUsersForRole(d);var f=[];for(var g=0;g<e.length;g++)this.isStringValidForFilter(e[g].name)&&f.push(e[g]);e=f}e.length>0&&b.push({role:d,users:e})}return b},usersForRoleIsVisible:function(a){var b=this.config.data||{};if(this.isMoreAvailable()){if(b.hasOwnProperty("roleId"))return b.roleId===a.id;if(b.role)return a.id==b.role.id}return!0},getExcludedUser:function(){var a=this.config.data||{},b=[],c=a.roleId||(a.role||{}).id;if(c){var d=this.entity.assignments;for(var e=0;e<d.length;e++)d[e].role.id==c&&b.push(d[e].generalUser)}else b.push(this.entity.owner);return b},userIsNotExcluded:function(a){if(!a.user.isActive)return!1;var b=this.getExcludedUser(),c=a.user.id;if(b.constructor!=Array)return c!=b.id;for(var d=0;d<b.length;d++)if(c==b[d].id)return!1;return!0},getUsersForRole:function(a){var b=this.project,c=[],d=b.projectMembers;for(var e=0;e<d.length;e++){var f=d[e];f.role.id==a.id&&this.userIsNotExcluded(f)&&c.push(this.convertUser(f.user))}c.sort(function(a,b){var c=a.name.toLowerCase(),d=b.name.toLowerCase();return c<d?-1:c>d?1:0});return c},convertUser:function(a){return{id:a.id,name:[a.firstName,a.lastName].join(" "),role:a.role,avatar:[c.getApplicationPath(),"/Avatar.ashx?UserId=",a.id,"&size=32"].join("")}},getRoles:function(){var a=this.project,b=[],c={},d=a.projectMembers,e=d.length;for(var f=0;f<e;f++){var g=d[f].role;if(c.hasOwnProperty(g.id))continue;c[g.id]=!0,b.push(g)}return b},getLoggedUser:function(){return this.config.context.applicationContext.loggedUser},getHeaderActions:function(){var a=[];this.config.data.assignmentId&&a.push({id:"unassign",title:"Unassign"}),!this.excludedUsersContainsLoggedUser()&&this.loggedUserInProjectTeam()&&a.push({id:"assign-to-me",title:"Assign To Me"});return a},loggedUserInProjectTeam:function(){var b=this.config.context.applicationContext.loggedUser;return a.any(this.project.projectMembers,function(a){return a.user.id===b.id})},excludedUsersContainsLoggedUser:function(){var a=this.getLoggedUser(),b=this.getExcludedUser();for(var c=0;c<b.length;c++)if(b[c].id===a.id)return!0;return!1},filterIsNotEmpty:function(){return this.config.data.filter&&this.config.data.filter.length},filterIsEmpty:function(){return!this.filterIsNotEmpty()},processProject:function(a){var b=this;b.project=a;var c=[];this.filterIsNotEmpty()?c=this.getFilteredGroups():(c=this.getGroups(),c.length==0&&(this.setShowMore(!0),c=this.getGroups()));var d={headerActions:this.getHeaderActions(),moreAvailable:this.isMoreAvailable(),groups:c};b.data=d;return d},isMoreAvailable:function(){var a=this.config.data;return this.filterIsEmpty()&&a.showMore!==!0&&(a.hasOwnProperty("roleId")||a.hasOwnProperty("role"))},destroy:function(){this.project=null,this.entity=null,this._super()}})})