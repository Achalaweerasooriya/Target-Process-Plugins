define(["Underscore","jQuery","tau/components/extensions/component.extension.base"],function(a,b,c){return c.extend({"bus afterRender":function(a){this._$element=a.data.element,this._data=a.data.data,this._render()},_render:function(){this._createFlowIndicators(),this._connectMarkers(),this.fire("stateProgressRendered")},_createFlowIndicators:function(){var b=this._$element.find(".tau-historyGrid .tau-historyItem");a.each(this._data.historyItems,function(a,c){this._markProgressStep(b.eq(c),a)},this)},_getHistoryItemStateIndex:function(b){return a.indexOf(this._data.entityStates,b)},_getFlowType:function(a){var b="NORMAL";return a.state.isFinal?b="DONE":this._isUnderImpediment(a)?b="IMPEDIMENT":a.transitions>1&&(b="MULTITRANS"),b},_isUnderImpediment:function(b){var c=a.any(this._getImpedimentRangeList(),function(a){return this._isInImpedimentRange(b,a)},this);return c},_getImpedimentRangeList:function(){if(!this._impedimentRangeList){this._impedimentRangeList=[];var b=this._getAllImpediments();a.each(b.opened,function(a,c){this._impedimentRangeList.push({start:a,end:b.closed[c]||Number.POSITIVE_INFINITY})},this),this._impedimentRangeList.sort(function(a,b){return b.end-b.start-(a.end-a.start)})}return this._impedimentRangeList},_getAllImpediments:function(){var b={opened:{},closed:{}};return a.each(this._data.historyItems,function(c){c.relatedEntities&&(a.each(c.relatedEntities.opened,function(a){this._isImpediment(a)&&(b.opened[a.id]=c.date)},this),a.each(c.relatedEntities.closed,function(a){this._isImpediment(a)&&(b.closed[a.id]=c.date)},this))},this),b},_isImpediment:function(a){return a.type.toLowerCase()=="impediment"},_isInImpedimentRange:function(a,b){return a.date>=b.start&&a.date<=b.end},_markProgressStep:function(a,c){var d=this._getHistoryItemStateIndex(c.state.name),e=this._getFlowType(c),f=this._createFlowIndicator(e),g=c.state.dateSpan;g&&!c.state.isFinal&&b("<span/>").addClass("datespan").text(g).attr("title",g+" consecutive days in this state").appendTo(f),a.find(".tau-progressSteps .tau-step:nth-child("+(d+1)+") .tau-marker").append(f)},_createFlowIndicator:function(a){var c=b("<div/>").addClass("tau-flow");switch(a){case"NORMAL":c.addClass("tau-normal");break;case"MULTITRANS":c.addClass("tau-transitions");break;case"IMPEDIMENT":c.addClass("tau-impediment");break;case"DONE":c.addClass("tau-done")}return c},_connectMarkers:function(){a.each(this._data.historyItems,function(a,b){var c=this._getHistoryItemStateIndex(a.state.name);this._connect(b,c,b-1,"in"),this._connect(b,c,b+1,"out")},this)},_connect:function(a,b,c,d){var e=this._data.historyItems[c];if(e){var f=this._getHistoryItemStateIndex(e.state.name),g=b-f;g>0&&this._$element.find(".tau-historyGrid .tau-historyItem").eq(a).find(".tau-progressSteps .tau-step").filter(function(a){return a>=f+1&&a<=b}).find(".tau-marker").addClass("tau-"+d)}}})})