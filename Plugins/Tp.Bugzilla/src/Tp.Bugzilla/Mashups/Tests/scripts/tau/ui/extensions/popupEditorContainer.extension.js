define(["Underscore","jQuery","tau/ui/extensions/editable-base","tau/ui/behaviour/common/ui.behaviour.tauBubble"],function(a,b,c,d){return c.extend({category:"edit",init:function(a){this._super(a),this.containers=[]},destroy:function(){this.destroyContainers(),this._super()},onEditActivated:function(c){this.destroyContainers();var e=this,f=this.element=c.element;for(var g=0;g<e.config.popupEditorContainer.length;g++){var h=e.config.popupEditorContainer[g],i=f.find(h.targetSelector);i.find(".external-view,.ui-type-icon").click(function(a){a.stopPropagation()}),i.each(function(){var c=b(this);h.component.data=c.tmplItem().data;var g={components:a.clone(h.component),context:e.config.context};c.addClass("tau-bubble-target"),h.targetCssClass&&c.addClass(h.targetCssClass);var i=!1;h.alignmentSelector&&(h.alignmentSelectorFrom=="target"?i=c.find(h.alignmentSelector):i=f.find(h.alignmentSelector));if(!i||!i.length)i=c;i.addClass("ui-link");var j=function(a){return function(){e.initializeContainer(this.$target,this.$popup,a)}}(g);d.call(c,{alignTo:i,onShow:j})})}},initializeContainer:function(a,b,c){var d=this,e=b.find(".tau-bubble__inner");d.$popupInner=e,d.$target=a;if(a.data("bubbleLoaded")===!0)return;e.find("div.ui-loading-message").remove(),e.append("<div class='ui-loading-message'>Loading...</div>"),d.createComponents(c,function(b){var c=b[0].component;c.on("afterRender",function(b){e.find(".ui-loading-message").remove();var d=b.data.element;d.appendTo(e),a.data("bubbleLoaded",!0),b.removeListener(),a.tauBubble("adjustPosition"),a.tauBubble("adjustPositionStart"),a.tauBubble("adjustPosition"),a.bind("close",function(){c.fire("blur",{})}),a.bind("show",function(){c.fire("focus",{}),c.fire("popupResize",a.tauBubble("getMaxSize")),a.tauBubble("adjustPosition")}),c.fire("popupResize",a.tauBubble("getMaxSize")),a.tauBubble("adjustPosition"),a.tauBubble("adjustPosition"),setTimeout(function(){c.fire("focus",{})},500)}),d.addContainer(c),c.initialize();var f=function(){a.data("bubbleLoaded",!1),a.tauBubble("empty")},g=function(){a.tauBubble("hide")},h=function(){a.tauBubble("destroy"),c.destroy()};c.on("beforeSave",f),c.on("beforeRemove",f),c.on("reset",g),c.on("afterSave",h),c.on("afterRemove",h)})},addContainer:function(a){this.containers.push(a)},destroyContainers:function(){var b=this.containers;a.each(b,function(a){a.destroy()}),this.containers=[]}})})