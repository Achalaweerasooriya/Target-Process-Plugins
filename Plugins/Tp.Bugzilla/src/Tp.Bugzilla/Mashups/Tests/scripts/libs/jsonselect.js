/*! Copyright (c) 2011, Lloyd Hilaiel, ISC License */
(function(exports){function b(a){try{return JSON&&JSON.parse?JSON.parse(a):(new Function("return "+a))()}catch(b){d("ijs",b.message)}}function d(a,b){throw new Error(c[a]+(b&&" in '"+b+"'"))}function h(a,c){c||(c=0);var g=f.exec(a.substr(c));if(!g)return undefined;c+=g[0].length;var h;return g[1]?h=[c," "]:g[2]?h=[c,g[0]]:g[3]?h=[c,e.typ,g[0]]:g[4]?h=[c,e.psc,g[0]]:g[5]?h=[c,e.psf,g[0]]:g[6]?d("upc",a):g[8]?h=[c,g[7]?e.ide:e.str,b(g[8])]:g[9]?d("ujs",a):g[10]&&(h=[c,e.ide,g[10].replace(/\\([^\r\n\f0-9a-fA-F])/g,"$1")]),h}function j(a,b){return typeof a===b}function l(a,c){var d,e=i.exec(a.substr(c));if(e)return c+=e[0].length,d=e[1]||e[2]||e[3]||e[5]||e[6],e[1]||e[2]||e[3]?[c,0,b(d)]:e[4]?[c,0,undefined]:[c,d]}function m(a,b){b||(b=0);var c=l(a,b),e;if(c&&c[1]==="("){e=m(a,c[0]);var f=l(a,e[0]);(!f||f[1]!==")")&&d("epex",a),b=f[0],e=["(",e[1]]}else!c||c[1]&&c[1]!="x"?d("ee",a+" - "+(c[1]&&c[1])):(e=c[1]==="x"?undefined:c[2],b=c[0]);var g=l(a,b);if(!g||g[1]==")")return[b,e];(g[1]=="x"||!g[1])&&d("bop",a+" - "+(g[1]&&g[1]));var h=m(a,g[0]);b=h[0],h=h[1];var i;if(typeof h!="object"||h[0]==="("||k[g[1]][0]<k[h[1]][0])i=[e,g[1],h];else{i=h;while(typeof h[0]=="object"&&h[0][0]!="("&&k[g[1]][0]>=k[h[0][1]][0])h=h[0];h[0]=[e,g[1],h[0]]}return[b,i]}function n(a,b){function c(a){return typeof a!="object"||a===null?a:a[0]==="("?c(a[1]):[c(a[0]),a[1],c(a[2])]}var d=m(a,b?b:0);return[d[0],c(d[1])]}function o(a,b){if(a===undefined)return b;if(a===null||typeof a!="object")return a;var c=o(a[0],b),d=o(a[2],b);return k[a[1]][1](c,d)}function p(a,b,c,e){c||(e={});var f=[],g,i;b||(b=0);for(;;){var j=s(a,b,e);f.push(j[1]),j=h(a,b=j[0]),j&&j[1]===" "&&(j=h(a,b=j[0]));if(!j)break;if(j[1]===">"||j[1]==="~")j[1]==="~"&&(e.usesSiblingOp=!0),f.push(j[1]),b=j[0];else if(j[1]===",")g===undefined?g=[",",f]:g.push(f),f=[],b=j[0];else if(j[1]===")"){c||d("ucp",j[1]),i=1,b=j[0];break}}c&&!i&&d("mcp",a),g&&g.push(f);var k;return!c&&e.usesSiblingOp?k=r(g?g:f):k=g?g:f,[b,k]}function q(a){var b=[],c;for(var d=0;d<a.length;d++)if(a[d]==="~"){if(d<2||a[d-2]!=">")c=a.slice(0,d-1),c=c.concat([{has:[[{pc:":root"},">",a[d-1]]]},">"]),c=c.concat(a.slice(d+1)),b.push(c);if(d>1){var e=a[d-2]===">"?d-3:d-2;c=a.slice(0,e);var f={};for(var g in a[e])a[e].hasOwnProperty(g)&&(f[g]=a[e][g]);f.has||(f.has=[]),f.has.push([{pc:":root"},">",a[d-1]]),c=c.concat(f,">",a.slice(d+1)),b.push(c)}break}return d==a.length?a:b.length>1?[","].concat(b):b[0]}function r(a){if(a[0]===","){var b=[","];for(var c=c;c<a.length;c++){var d=q(d[c]);b=b.concat(d[0]===","?d.slice(1):d)}return b}return q(a)}function s(a,b,c){var f=b,i={},j=h(a,b);j&&j[1]===" "&&(f=b=j[0],j=h(a,b)),j&&j[1]===e.typ?(i.type=j[2],j=h(a,b=j[0])):j&&j[1]==="*"&&(j=h(a,b=j[0]));for(;;){if(j===undefined)break;if(j[1]===e.ide)i.id&&d("nmi",j[1]),i.id=j[2];else if(j[1]===e.psc)(i.pc||i.pf)&&d("mpc",j[1]),j[2]===":first-child"?(i.pf=":nth-child",i.a=0,i.b=1):j[2]===":last-child"?(i.pf=":nth-last-child",i.a=0,i.b=1):i.pc=j[2];else{if(j[1]!==e.psf)break;if(j[2]===":val"||j[2]===":contains")i.expr=[undefined,j[2]===":val"?"=":"*=",undefined],j=h(a,b=j[0]),j&&j[1]===" "&&(j=h(a,b=j[0])),(!j||j[1]!=="(")&&d("pex",a),j=h(a,b=j[0]),j&&j[1]===" "&&(j=h(a,b=j[0])),(!j||j[1]!==e.str)&&d("sex",a),i.expr[2]=j[2],j=h(a,b=j[0]),j&&j[1]===" "&&(j=h(a,b=j[0])),(!j||j[1]!==")")&&d("epex",a);else if(j[2]===":has"){j=h(a,b=j[0]),j&&j[1]===" "&&(j=h(a,b=j[0])),(!j||j[1]!=="(")&&d("pex",a);var k=p(a,j[0],!0);j[0]=k[0],i.has||(i.has=[]),i.has.push(k[1])}else if(j[2]===":expr"){i.expr&&d("mexp",a);var l=n(a,j[0]);j[0]=l[0],i.expr=l[1]}else{(i.pc||i.pf)&&d("mpc",a),i.pf=j[2];var m=g.exec(a.substr(j[0]));m||d("mepf",a),m[5]?(i.a=2,i.b=m[5]==="odd"?1:0):m[6]?(i.a=0,i.b=parseInt(m[6],10)):(i.a=parseInt((m[1]?m[1]:"+")+(m[2]?m[2]:"1"),10),i.b=m[3]?parseInt(m[3]+m[4],10):0),j[0]+=m[0].length}}j=h(a,b=j[0])}return f===b&&d("se",a),[b,i]}function t(b){return Array.isArray?Array.isArray(b):a.call(b)==="[object Array]"}function u(a){if(a===null)return"null";var b=typeof a;return b==="object"&&t(a)&&(b="array"),b}function v(a,b,c,d,e){var f=[],g=b[0]===">"?b[1]:b[0],h=!0,i;g.type&&(h=h&&g.type===u(a)),g.id&&(h=h&&g.id===c),h&&g.pf&&(g.pf===":nth-last-child"?d=e-d:d++,g.a===0?h=g.b===d:(i=(d-g.b)%g.a,h=!i&&d*g.a+g.b>=0));if(h&&g.has){var j=function(){throw 42};for(var k=0;k<g.has.length;k++){try{w(g.has[k],a,j)}catch(l){if(l===42)continue}h=!1;break}}return h&&g.expr&&(h=o(g.expr,a)),b[0]!==">"&&b[0].pc!==":root"&&f.push(b),h&&(b[0]===">"?b.length>2&&(h=!1,f.push(b.slice(2))):b.length>1&&(h=!1,f.push(b.slice(1)))),[h,f]}function w(a,b,c,d,e,f){var g=a[0]===","?a.slice(1):[a],h=[],i=!1,j=0,k=0,l,m;for(j=0;j<g.length;j++){m=v(b,g[j],d,e,f),m[0]&&(i=!0);for(k=0;k<m[1].length;k++)h.push(m[1][k])}if(h.length&&typeof b=="object"){h.length>=1&&h.unshift(",");if(t(b))for(j=0;j<b.length;j++)w(h,b[j],c,undefined,j,b.length);else for(l in b)b.hasOwnProperty(l)&&w(h,b[l],c,l)}i&&c&&c(b)}function x(a,b){var c=[];return w(a,b,function(a){c.push(a)}),c}function y(a){return{sel:p(a)[1],match:function(a){return x(this.sel,a)},forEach:function(a,b){return w(this.sel,a,b)}}}var a=Object.prototype.toString,c={bop:"binary operator expected",ee:"expression expected",epex:"closing paren expected ')'",ijs:"invalid json string",mcp:"missing closing paren",mepf:"malformed expression in pseudo-function",mexp:"multiple expressions not allowed",mpc:"multiple pseudo classes (:xxx) not allowed",nmi:"multiple ids not allowed",pex:"opening paren expected '('",se:"selector expected",sex:"string expected",sra:"string required after '.'",uc:"unrecognized char",ucp:"unexpected closing paren",ujs:"unclosed json string",upc:"unrecognized pseudo class"},e={psc:1,psf:2,typ:3,str:4,ide:5},f=new RegExp('^(?:([\\r\\n\\t\\ ]+)|([~*,>\\)\\(])|(string|boolean|null|array|object|number)|(:(?:root|first-child|last-child|only-child))|(:(?:nth-child|nth-last-child|has|expr|val|contains))|(:\\w+)|(?:(\\.)?(\\"(?:[^\\\\\\"]|\\\\[^\\"])*\\"))|(\\")|\\.((?:[_a-zA-Z]|[^\\0-\\0177]|\\\\[^\\r\\n\\f0-9a-fA-F])(?:[_a-zA-Z0-9\\-]|[^\\u0000-\\u0177]|(?:\\\\[^\\r\\n\\f0-9a-fA-F]))*))'),g=/^\s*\(\s*(?:([+\-]?)([0-9]*)n\s*(?:([+\-])\s*([0-9]))?|(odd|even)|([+\-]?[0-9]+))\s*\)/,i=new RegExp('^\\s*(?:(true|false|null)|(-?\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d+)?)|("(?:[^\\]|\\[^"])*")|(x)|(&&|\\|\\||[\\$\\^<>!\\*]=|[=+\\-*/%<>])|([\\(\\)]))'),k={"*":[9,function(a,b){return a*b}],"/":[9,function(a,b){return a/b}],"%":[9,function(a,b){return a%b}],"+":[7,function(a,b){return a+b}],"-":[7,function(a,b){return a-b}],"<=":[5,function(a,b){return j(a,"number")&&j(b,"number")&&a<=b}],">=":[5,function(a,b){return j(a,"number")&&j(b,"number")&&a>=b}],"$=":[5,function(a,b){return j(a,"string")&&j(b,"string")&&a.lastIndexOf(b)===a.length-b.length}],"^=":[5,function(a,b){return j(a,"string")&&j(b,"string")&&a.indexOf(b)===0}],"*=":[5,function(a,b){return j(a,"string")&&j(b,"string")&&a.indexOf(b)!==-1}],">":[5,function(a,b){return j(a,"number")&&j(b,"number")&&a>b}],"<":[5,function(a,b){return j(a,"number")&&j(b,"number")&&a<b}],"=":[3,function(a,b){return a===b}],"!=":[3,function(a,b){return a!==b}],"&&":[2,function(a,b){return a&&b}],"||":[1,function(a,b){return a||b}]};exports._lex=h,exports._parse=p,exports.match=function(a,b){return y(a).match(b)},exports.forEach=function(a,b,c){return y(a).forEach(b,c)},exports.compile=y})(typeof exports=="undefined"?window.JSONSelect={}:exports)