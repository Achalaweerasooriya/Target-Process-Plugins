/*!!
 * Crossroads - JavaScript Routes
 * Released under the MIT license <http://www.opensource.org/licenses/mit-license.php>
 * @author Miller Medeiros
 * @version 0.4
 * @build 31 (06/07/2011 12:15 AM)
 */
function arrayIndexOf(a,b){var c=a.length;while(c--)if(a[c]===b)return c;return-1}function isType(a,b){return"[object "+a+"]"===_toString.call(b)}function isRegExp(a){return isType("RegExp",a)}function isArray(a){return isType("Array",a)}function isFunction(a){return isType("Function",a)}function typecastValue(a){return a===null?a:BOOL_REGEXP.test(a)?a.toLowerCase()==="true":a===""||isNaN(a)?a:parseFloat(a)}var signals=require("signals"),crossroads,Route,patternLexer,_toString=Object.prototype.toString,BOOL_REGEXP=/^(true|false)$/i;crossroads=function(){function d(a,b,c){var d=new Route(a,b,c);return e(d),d}function e(b){var c=f();do--c;while(a[c]&&b._priority<=a[c]._priority);a.splice(c+1,0,b)}function f(){return a.length}function g(b){var c=h(b);c>=0&&a.splice(c,1),b._destroy()}function h(b){return arrayIndexOf(a,b)}function i(){var b=f();while(b--)a[b]._destroy();a.length=0}function j(a){a=a||"";var d=k(a),e=d?l(a,d):null;d?(e?d.matched.dispatch.apply(d.matched,e):d.matched.dispatch(),c.dispatch(a,d,e)):b.dispatch(a)}function k(b){var c=f(),d;while(d=a[--c])if(d.match(b))return d;return null}function l(a,b){return patternLexer.getParamValues(a,b._matchRegexp)}var a=[],b=new signals.Signal,c=new signals.Signal;return{_routes:a,addRoute:d,removeRoute:g,removeAllRoutes:i,parse:j,bypassed:b,routed:c,getNumRoutes:f,toString:function(){return"[crossroads numRoutes:"+f()+"]"}}}(),Route=function(a,b,c){var d=isRegExp(a);this._pattern=a,this._paramsIds=d?null:patternLexer.getParamIds(this._pattern),this._matchRegexp=d?a:patternLexer.compilePattern(a),this.matched=new signals.Signal,b&&this.matched.add(b),this._priority=c||0},Route.prototype={rules:void 0,match:function(a){return this._matchRegexp.test(a)&&this._validateParams(a)},_validateParams:function(a){var b=this.rules,c;for(c in b)if(b.hasOwnProperty(c)&&!this._isValidParam(a,c))return!1;return!0},_isValidParam:function(a,b){var c=this.rules[b],d=this._getParamValuesObject(a),e=d[b],f;return isRegExp(c)?f=c.test(e):isArray(c)?f=arrayIndexOf(c,e)!==-1:isFunction(c)&&(f=c(e,a,d)),f||!1},_getParamValuesObject:function(a){var b=this._paramsIds,c=patternLexer.getParamValues(a,this._matchRegexp),d={},e=b?b.length:0;while(e--)d[b[e]]=c[e];return d.request_=typecastValue(a),d},dispose:function(){crossroads.removeRoute(this)},_destroy:function(){this.matched.dispose(),this.matched=this._pattern=this._matchRegexp=null},toString:function(){return'[Route pattern:"'+this._pattern+'", numListeners:'+this.matched.getNumListeners()+"]"}},patternLexer=crossroads.patternLexer=function(){function f(a){var b=[],d;while(d=c.exec(a))b.push(d[1]);return b}function g(a){return a=a?h(a):"",a=a.replace(/\/$/,""),a=j(a),a=i(a),new RegExp("^"+a+"/?$")}function h(a){return a.replace(c,d)}function i(a){return a.replace(e,b.source)}function j(b){return b.replace(a,"\\$&")}function k(a,b){var c=b.exec(a);return c&&(c.shift(),c=l(c)),c}function l(a){var b=a.length,c=[];while(b--)c[b]=typecastValue(a[b]);return c}var a=/[\\\.\+\*\?\^\$\[\]\(\)\{\}\/\'\#]/g,b=/([^\/]+)/,c=/\{([^\}]+)\}/g,d="___CR_PARAM___",e=new RegExp(d,"g");return{getParamIds:f,getParamValues:k,compilePattern:g}}(),exports=crossroads