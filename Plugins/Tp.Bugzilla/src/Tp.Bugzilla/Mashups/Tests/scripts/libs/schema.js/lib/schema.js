define(function(require,exports,module){var a=require("./utils"),b=require("./objecttools");module.exports=function(){var c=this,d=this.Schema=function(b){typeof b=="string"&&(b=JSON.parse(b));if(b instanceof d)return b;a.extend(this,b),this.id===undefined&&(this.id=""+d._id++),d.instances[this.id]=this};a.extend(d.prototype,{validate:function(a,b){var d=new c.Validation(this,a,b);return delete d.instance.__id,d},setFallbacks:function(b){return typeof b=="string"?this.fallbacks=c.Validation[b]:b===undefined?this.fallbacks=c.fallbacks:this.fallbacks=a.extend({},c.fallbacks,b),this}}),a.extend(d,{_id:1,create:function(a){if(typeof a=="string")var a=JSON.parse(a);var b=c.schemaSchema.validate(a);if(b.isError())throw console.log(b.getError()),b.getError();return b.instance},createSeveral:function(a){for(var b in a)a[b].id===undefined&&(a[b].id=b),a[b]=this.create(a[b]);return a},instances:{},resolveRefs:function(){for(var a in this.instances)b.resolveRefs(this.instances[a],!0)}})}})