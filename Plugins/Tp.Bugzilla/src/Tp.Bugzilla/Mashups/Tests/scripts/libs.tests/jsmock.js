function Discrepancy(a,b){if(b.constructor!=InvocationBehavior)throw new Error("The behavior can only be an InvocationBehavior object");this.message=a,this.behavior=b}function Similar(a){this.expected=a}function Like(a){this.expected=a}function TypeOf(a){if(typeof a!="function")throw new Error("Can only take constructors");this.type=a}function InvocationBehavior(a,b,c){this.caller=a,this.method=b,this.methodArguments=c}function ExpectationMatcher(){this.__expectationBehaviorList=[],this.__actualBehaviorList=[],this.__discrepancy=null}function MockControl(){this.__expectationMatcher=new ExpectationMatcher,this.__lastMock=null,this.__lastCallName=null}JSMock={extend:function(a){var b=new MockControl;a.createMock=function(a){return b.createMock(a)},a.resetMocks=function(){b.reset()},a.verifyMocks=function(){b.verify()},a.tearDown?a.tearDown.constructor==Function&&(a.__oldTearDown__=a.tearDown,a.tearDown=function(){a.__oldTearDown__(),a.verifyMocks()}):a.tearDown=function(){a.verifyMocks()}}},MockControl.prototype={createMock:function(a){var b={calls:[],expects:function(){this.__recording=!0;return this},__recording:!1};b.expect=b.expects;if(a!=null)if(typeof a=="function")this.__createMethods(a,b),this.__createMethods(new a,b);else if(typeof a=="object")this.__createMethods(a,b);else throw new Error("Cannot mock out a "+typeof a);var c=this;b.addMockMethod=function(a){c.__createMethod(c,b,a)};return b},andReturn:function(a){this.__verifyLastMockNotNull("Cannot set return value without an expectation"),this.__initializeReturnExpectationForMock(),this.__lastMock.calls[this.__lastCallName].push(function(){return a})},andThrow:function(a){this.__verifyLastMockNotNull("Cannot throw error without an expectation"),this.__initializeReturnExpectationForMock(),this.__lastMock.calls[this.__lastCallName].push(function(){throw new Error(a)})},andStub:function(a){this.__verifyLastMockNotNull("Cannot stub without an expectation");if(typeof a!="function")throw new Error("Stub must be a function");this.__initializeReturnExpectationForMock(),this.__lastMock.calls[this.__lastCallName].push(function(){return a.apply(this,arguments)})},reset:function(){this.__expectationMatcher.reset()},verify:function(){if(!this.__expectationMatcher.matches()){discrepancy=this.__expectationMatcher.discrepancy(),message=discrepancy.message,method=discrepancy.behavior.method,formattedArgs=ArgumentFormatter.format(discrepancy.behavior.methodArguments),this.__expectationMatcher.reset();throw new Error(message+": "+method+"("+formattedArgs+")")}this.__expectationMatcher.reset()},__createMethods:function(a,b){for(var c in a)this.__isPublicMethod(a,c)&&this.__createMethod(this,b,c)},__createMethod:function(a,b,c){b[c]=function(){if(b.__recording){a.__lastMock=b,a.__lastCallName=c,a.__expectationMatcher.addExpectedMethodCall(b,c,arguments),b.__recording=!1;return a}a.__expectationMatcher.addActualMethodCall(b,c,arguments);if(b.calls[c]!=null){var d=b.calls[c].shift();if(typeof d=="function")return d.apply(this,arguments)}}},__isPublicMethod:function(a,b){try{return typeof a[b]=="function"&&b.charAt(0)!="_"}catch(c){return!1}},__verifyLastMockNotNull:function(a){if(this.__lastMock==null)throw new Error(a)},__initializeReturnExpectationForMock:function(){typeof this.__lastMock.calls[this.__lastCallName]=="undefined"&&(this.__lastMock.calls[this.__lastCallName]=[])}},ExpectationMatcher.prototype={addExpectedMethodCall:function(a,b,c){this.__expectationBehaviorList.push(new InvocationBehavior(a,b,c))},addActualMethodCall:function(a,b,c){this.__actualBehaviorList.push(new InvocationBehavior(a,b,c))},matches:function(){var a=this,b=!0;this.__expectationBehaviorList.eachIndexForJsMock(function(c,d){var e=a.__actualBehaviorList.length>c?a.__actualBehaviorList[c]:null;b&&(e===null?(a.__discrepancy=new Discrepancy("Expected function not called",d),b=!1):d.method!=e.method?(a.__discrepancy=new Discrepancy("Surprise call. Expected: ["+d.method+"] , but was ["+e.method+"]",e),b=!1):d.caller!=e.caller?(a.__discrepancy=new Discrepancy("Surprise call from unexpected caller",e),b=!1):a.__matchArguments(d.methodArguments,e.methodArguments)||(a.__discrepancy=new Discrepancy("Unexpected Arguments. Expected: ["+JSON.stringify(d.methodArguments)+", but was:"+JSON.stringify(e.methodArguments)+" for method ",e),b=!1))}),this.__actualBehaviorList.length>this.__expectationBehaviorList.length&&b&&(this.__discrepancy=new Discrepancy("Surprise call",this.__actualBehaviorList[this.__expectationBehaviorList.length]),b=!1);return b},reset:function(){this.__expectationBehaviorList=[],this.__actualBehaviorList=[],this.__discrepancy=null},discrepancy:function(){return this.__discrepancy},__matchArguments:function(a,b){var c=this.__convertArgumentsToArray(a),d=this.__convertArgumentsToArray(b);return ArgumentMatcher.matches(c,d)},__convertArgumentsToArray:function(a){var b=[];for(var c=0;c<a.length;c++)b[c]=a[c];return b}},TypeOf.isA=function(a){return new TypeOf(a)},Like.is=function(a){return new Like(a)},Similar.to=function(a){return new Similar(a)},ArgumentMatcher={matches:function(a,b){return this.__delegateMatching(a,b)},__delegateMatching:function(a,b){return a==null?this.__match(a,b):a.constructor==TypeOf?this.__match(a.type,b.constructor):a.constructor==Like?this.__matchLike(a.expected,b):a.constructor==Similar?this.__matchSimilar(a.expected,b):a.constructor==Array?this.__matchArrays(a,b):this.__match(a,b)},__getProperties:function(a){var b=[];for(var c in a)b.push(c);b.sort();return b},__matchLike:function(a,b){var c=this.__getProperties(a),d=this.__getProperties(b),e=this.__matchArrays(c,d);if(e){var f=[],g=[];for(var h in a){if(h==undefined||h==null)continue;var i=a[h],j=b[h];i&&j&&i instanceof Object&&j instanceof Object?(f.push(!0),g.push(this.__delegateMatching(i,j))):(f.push(i),g.push(j))}e=this.__matchArrays(f,g)}return e},__matchSimilar:function(a,b){var c=!0,d=[],e=[];for(var f in a){if(f==undefined||f==null)continue;var g=a[f],h=b[f];g&&h&&g instanceof Object&&h instanceof Object?(d.push(!0),e.push(this.__delegateMatching(g,h))):(d.push(g),e.push(h))}c=this.__matchArrays(d,e);return c},__match:function(a,b){return a==b},__matchArrays:function(a,b){if(b==null)return!1;if(b.constructor!=Array)return!1;if(a.length!=b.length)return!1;for(var c=0;c<a.length;c++)if(!this.__delegateMatching(a[c],b[c]))return!1;return!0}},ArgumentFormatter={format:function(a){var b="";for(var c=0;c<a.length;c++)if(a[c]==null)b+=b==""?"null":", null";else if(a[c].constructor==TypeOf||a[c].constructor==Function){var d=a[c].constructor==TypeOf?a[c].type:a[c];b+=b==""?this.__formatFunction(d):", "+this.__formatFunction(d)}else typeof a[c]=="string"?b+=b==""?'"'+a[c].toString()+'"':', "'+a[c].toString()+'"':a[c].constructor==Array?b+=b==""?"["+this.format(a[c])+"]":", ["+this.format(a[c])+"]":b+=b==""?a[c].toString():", "+a[c].toString();return b},__formatFunction:function(a){if(a==Array)return"Array";if(a==Date)return"Date";if(a==Object)return"Object";if(a==String)return"String";if(a==Function)return"Function";if(a==RegExp)return"RegExp";if(a==Error)return"Error";if(a==Number)return"Number";if(a==Boolean)return"Boolean";var b=a.toString().match(/function (\w+)/);return b==null?"{{Closure}}":b[1]}},Array.prototype.eachIndexForJsMock=function(a){for(var b=0;b<this.length;b++)a(b,this[b])}