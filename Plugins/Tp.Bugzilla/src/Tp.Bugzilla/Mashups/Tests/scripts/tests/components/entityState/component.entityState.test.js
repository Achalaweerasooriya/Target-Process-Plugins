define(["jQuery","tau/components/component.property.entityState","tests/components/component.specs","tests/common/testData.Generator","tests/common/service.mock","tau/configurator","tests/components/common/common.setup"],function(a,b,c,d,e,f,g){var h=function(){var h=new d;h.initDefaultData();var i=h.getData(),j=h.getProjects(),k=h.getBugs()[0],l=h.getEntityStates(),m={manualContext:!0,context:{entity:{entityType:{name:k.__type},id:k.id},applicationContext:{selectedProjects:[j[0]],culture:{name:"en-US",timePattern:"g:i A",shortDateFormat:"M/d/yyyy",longDateFormat:"dddd, MMMM dd, yyyy",decimalSeparator:".",__type:"culture"},processes:h.getProcesses()}}},n=k.entityState,o=l[1],p=l[3],q=g.create("[component.property.entityState]",i,b,m),r=[{name:"should render valid markup",test:function(){var a=this.$el,b=a.find(".attr-name");ok(b.hasClass("ui-link"),"Marked as link"),equals(b.text(),n.name,"Entity state name")}},{name:"should allow to change state",preSetup:function(){var a=this.service=new e;f.setService(a)},test:function(){var b=this.$el;b.click();var c=a(".tau-bubble");equals(c.size(),1,"Count of bubbles"),equals(c.find(".drop-down-option").size(),n.nextStates.length,"Count of next states");var d=c.eq(0).find('.drop-down-option:contains("'+o.name+'")');this.service.registerSaveCommand({config:{$set:{entityState:{id:o.id}},fields:["id",{entityState:["id","name","isFinal","isCommentRequired",{nextStates:["id"],list:!0}]}],id:k.id},returnedData:{id:k.id,entityState:o}}),d.click(),equals(this.$el.find(".attr-name").text(),o.name,"Entity state is changed")}},{name:"should save state with comment",preSetup:function(){var a=this.service=new e;f.setService(a)},test:function(){var b=this.$el;b.click();var c=a(".tau-bubble");equals(c.size(),1,"Bubble appears"),equals(c.find(".ui-entity-state-comment").size(),0,"No comments");var d=c.eq(0).find('.drop-down-option:contains("'+p.name+'")');equals(d.size(),1,"Done option available"),d.click(),equals(c.find(".ui-entity-state-comment").size(),1,"Comment input is open");var e=c.find(".ui-entity-state-comment .ui-state-comment-field");equals(e.size(),1,"Comment field is presented"),e.val("Test comment");var f=c.find(".ui-entity-state-comment .button-group .save");equals(f.size(),1,"Save button is presented"),this.service.registerSaveCommand({config:{$set:{description:"Test comment",general:{id:k.id}},fields:["id","description","createDate","parentId",{owner:["id","firstName","lastName"]}]},returnedData:{id:k.id,entityState:o}}),this.service.registerSaveCommand({config:{id:k.id,$set:{entityState:{id:p.id}},fields:["id",{entityState:["id","name","isFinal","isCommentRequired",{nextStates:["id"],list:!0}]}]},returnedData:{id:k.id,entityState:p}}),f.click()}}];c.create(q,m).viewShouldFollowBasicComponentLifeCycle().viewShouldPassTests(r).done();var s=h.getBugs()[2],t={manualContext:!0,context:{entity:{entityType:{name:s.__type},id:s.id},applicationContext:{selectedProjects:[j[0]],culture:{name:"en-US",timePattern:"g:i A",shortDateFormat:"M/d/yyyy",longDateFormat:"dddd, MMMM dd, yyyy",decimalSeparator:".",__type:"culture"},processes:h.getProcesses()}}},u=g.create("[component.property.entityState][final state]",i,b,t);c.create(u,t).viewShouldFollowBasicComponentLifeCycle().viewShouldPassTests([{name:"should disable state pull down if there are no next states",test:function(){var b=this.$el,c=b.find(".attr-name");ok(!c.hasClass("ui-link"),"Marked as link"),equals(c.text(),p.name,"Entity state name"),b.click();var d=a(".tau-bubble");equals(d.size(),0,"Bubble editor is disabled")}}]).done()};return{run:h}})