define(["Underscore","tests/common/service.mock","tau/components/component.list","tests/common/datapoint/test.common.datapoint","tests/common/applicationContext","tests/components/common/common.setup","tests/components/component.specs","tests/common/checker","tau/models/dataProviders/model.provider.items.tasks_bugs","tau/models/dataProviders/model.provider.groups.tasks_bugs","tau/configurator","tau/models/dataprocessor/model.processor.context","tau/ui/templates/list_/grid.entity/ui.template.list.grid.entity"],function(a,b,c,d,e,f,g,h,i,j,k,l){var m=function(){var h=new e,m=d.projects(),n=d.entityStates(),o=d.bugs(),p=d.tasks(),q={id:15,__type:"userStory",tasks:a(p).filter(function(a){return a.id==31||a.id==33}),bugs:a(o).filter(function(a){return a.id==41||a.id==665})},r=[q].concat(n).concat(m),s={context:{type:"story",id:15}},t=function(){var a=this.service=new b;k.setService(a),k.getProxy().markRecordSetAsCompleteLoaded("project"),k.getProxy().markRecordSetAsCompleteLoaded("entityState"),k.getProxy().markRecordSetAsCompleteLoaded("priority"),k.getProxy().markRecordSetAsCompleteLoaded("severity")},u=[{preSetup:t,name:"should render valid markup view",test:function(){var b=this.data,c=this.$el,d=c.find("[role=group]");equals(d.length,5,"Groups amount");for(var e=0;e<d.length;e++){var f=d.eq(e);equals(f.find("[role=title]").text(),b.groups[e].title,"Group title"),equals(f.find("[role=counter]").text(),b.groups[e].items.length,"Group counter")}var g=c.find("[role=list-inner]");for(var h=0;h<g.length;h++){var i=g.eq(h),j=i.find("> tr");for(var k=0;k<j.length;k++){var l=j.eq(k).find("td"),m=b.groups[h].items[k];equals(l.length,7,"Amount of row cells"),equals(l.eq(1).text(),m.id,"ID Data column");var n=l.eq(2).find("span").eq(0);equals(n.text(),m.name,"Name Data column");if(m.tags.length){var o=l.eq(2).find("span").eq(1);equals(o.text(),m.tags[0],"Tag Data column")}m.__type==="bug"?equals(l.eq(3).text(),m.severity.name.toString(),"Severity Data column"):m.__type==="task"&&equals(l.eq(3).text(),"","Priority Data column");var p=m.effort.estimated+"&nbsp;"+m.effort.unit.shortName,q=l.eq(4).find("span:first").html();equals(q,p,"Estimated effort"),m.effort.percentFromMaximum>0?(ok(l.eq(5).find(".ui-progressbar__progress").attr("style").match(new RegExp("width:\\s*"+m.effort.percentFromMaximum+"%")),"Column progress width"),ok(l.eq(5).find(".ui-progressbar__progress__indicator").attr("style").match(new RegExp("width:\\s*"+m.effort.percentComplete+"%")),"Column progress width")):equals(l.eq(5).find(".ui-progressbar__progress").size(),0,"Progress bar should not be shown"),equals(l.eq(6).find(".ui-assignment__group").length,m.assignments.groups.length,"Assignments items");var r=l.eq(6).find(".ui-assignment__group");a.forEach(m.assignments.groups,function(b,c){var d=r.eq(c);equals(d.find(".ui-assignment__group__title").text(),b.role.name,"Group title");var e=d.find(".ui-assignment__user");equals(e.length,b.users.length,"Group users length"),a.forEach(b.users,function(a,c){var d=e.eq(c),a=b.users[c];equals(d.find("img").attr("src"),"/TP/Avatar.ashx?UserId="+a.id+"&size=24","User avatar"),equals(d.find("img").prop("title"),a.name,"User name")})})}}}},{name:"should save state",preSetup:t,test:function(){var a=this.data,b=this.$el,c=null,d=k.getRouting();this.component.getGlobalBus().on("routing.setState",function(a){c=a.data}),b.find(".tau-list__group__collapse:first").click(),same(c,{list:{"Open,Backlog":!0}}),ok(b.find(".tau-list__group__collapse:first").eq(1).hasClass("tau-list__group__collapse_collapsed_true")===!1,"state is initial")}},{name:"should allow to prioritize",preSetup:t,test:function(){var a=this.$el,b=a.find("[role=group]:first"),c=b.find("[role=item]:first"),d=c.next();this.service.registerSaveCommand({config:{id:31,$set:{beforeId:undefined,afterId:undefined},fields:["id"]},returnedData:{id:31}}),this.service.registerGetCommand({config:{id:31,fields:["id","numericPriority"]},returnedData:{id:31,numericPriority:34}}),b.triggerHandler("sortstart",{item:c});var e=a.find(".tau-list__group_available_true[role=group]");equals(e.length,2,"Available groups");var f=a.find(".tau-list__group_available_false[role=group]");equals(f.length,3,"Unvailable groups"),c.insertAfter(d),b.triggerHandler("sortupdate",{item:c}),b.triggerHandler("sortstop"),a=this.$el,e=a.find(".tau-list__group_available_true[role=group]"),equals(e.length,5,"Available groups are default"),f=a.find(".tau-list__group_available_false[role=group]"),equals(f.length,0,"Unavailable groups are switched off")}},{name:"should use available next states for groups",preSetup:t,test:function(){var a=this.$el,b=a.find("[role=group]:eq(1)"),c=b.find("[role=item]:first");b.triggerHandler("sortstart",{item:c});var d=a.find(".tau-list__group_available_true[role=group]");equals(d.length,3,"Available groups use next states")}},{name:"should allow to change group",preSetup:t,test:function(){var a=this.$el,b=a.find("[role=group]:first"),c=a.find("[role=group]").eq(4);c.find(".tau-list__group__collapse").click(),equals(b.find("[role=counter]").text(),1,"Count started"),equals(c.find("[role=counter]").text(),1,"Count started");var d=b.find("[role=item]:first"),e=c.find("[role=item]:first");this.service.registerSaveCommand({config:{id:31,$set:{beforeId:undefined,afterId:33},fields:["id"]},returnedData:{id:31}}),this.service.registerGetCommand({config:{id:31,fields:["id","numericPriority"]},returnedData:{id:31,numericPriority:34}}),this.service.registerSaveCommand({config:{id:31,$set:{entityState:{id:4}},fields:["id",{entityState:["id","name","isFinal"]}]},returnedData:{id:31,entityState:{id:4,name:"Done",isFinal:!0}}}),this.service.registerGetCommand({config:{id:31,fields:["id",{entityState:["id","name","isFinal"]}]},returnedData:{id:31,entityState:{id:4,name:"Done",isFinal:!0}}}),equals(d.hasClass("tau-list__table__row_isfinalstate_true"),!1,"Highlight not changed"),b.triggerHandler("sortstart",{item:d}),d.insertAfter(e),b.triggerHandler("sortupdate",{item:d}),b.triggerHandler("sortstop"),a=this.$el,b=a.find("[role=group]:first"),c=a.find("[role=group]").eq(4);var d=b.find("[role=item]:first"),e=c.find("[role=item]:first");equals(b.find("[role=counter]").text(),0,"Count changed"),equals(c.find("[role=counter]").text(),2,"Count changed"),equals(c.find(".tau-list__table__row_isfinalstate_true").length,2,"Highlight changed"),equals(c.find("[role=item]").eq(0).find("td").eq(1).text(),33,"Order correct"),equals(c.find("[role=item]").eq(1).find("td").eq(1).text(),31,"Order correct")}},{name:"should allow to change group but no priority in closed group",preSetup:t,test:function(){var a=this.$el,b=a.find("[role=group]:first"),c=a.find("[role=group]").eq(4);equals(b.find("[role=counter]").text(),1,"Count started"),equals(c.find("[role=counter]").text(),1,"Count started");var d=b.find("[role=item]:first"),e=c.find("[role=item]:first");this.service.registerSaveCommand({config:{id:31,$set:{entityState:{id:4}},fields:["id",{entityState:["id","name","isFinal"]}]},returnedData:{id:31,entityState:{id:4,name:"Done",isFinal:!0}}}),equals(d.hasClass("tau-list__table__row_isfinalstate_true"),!1,"Highlight not changed"),b.triggerHandler("sortstart",{item:d}),d.insertAfter(e),b.triggerHandler("sortupdate",{item:d}),b.triggerHandler("sortstop"),a=this.$el,b=a.find("[role=group]:first"),c=a.find("[role=group]").eq(4),equals(b.find("[role=counter]").text(),0,"Count changed"),equals(c.find("[role=counter]").text(),2,"Count changed"),equals(c.find("[role=item]").eq(0).find("td").eq(1).text(),31,"Order correct depends on non-changed priority"),equals(c.find("[role=item]").eq(1).find("td").eq(1).text(),33,"Order correct depends on non-changed priority"),equals(a.find(".i-target").length,0,"No highlight")}},{name:"should allow to change group and ask to add comment",preSetup:t,test:function(){var a=this.$el,b=a.find("[role=group]").eq(1),c=a.find("[role=group]").eq(3),d=b.find("[role=item]:first"),e=c.find("[role=item]:first");b.triggerHandler("sortstart",{item:d}),d.insertAfter(e),b.triggerHandler("sortupdate",{item:d});var f=d.tauBubble("widget");equals(f.length,1,"Show popup"),ok(this.$el===a,"don refresh"),f.find(":button:eq(1)").click(),ok(this.$el!==a,"refresh"),a=this.$el,b=a.find("[role=group]").eq(1),c=a.find("[role=group]").eq(3),d=b.find("[role=item]:first"),e=c.find("[role=item]:first"),this.service.registerSaveCommand({config:{$set:{description:"fuck you",general:{id:41}},$include:["id","description","createDate","parentId",{owner:["id","firstName","lastName"]}],fields:["id"]},returnedData:{id:1}}),this.service.registerSaveCommand({config:{id:41,$set:{beforeId:undefined,afterId:665},fields:["id"]},returnedData:{id:41}}),this.service.registerGetCommand({config:{id:41,fields:["id","numericPriority"]},returnedData:{id:41,numericPriority:667}}),this.service.registerSaveCommand({config:{id:41,$set:{entityState:{id:44}},fields:["id",{entityState:["id","name","isFinal"]}]},returnedData:{id:41,entityState:{id:44,name:"In Testing",isFinal:!1}}}),b.triggerHandler("sortstart",{item:d}),d.insertAfter(e),b.triggerHandler("sortupdate",{item:d}),f=d.tauBubble("widget"),equals(f.length,1,"Show popup"),equals(f.find("textarea").length,1,"Popup correct"),f.find("textarea").val("fuck you"),f.find("button:eq(0)").click(),ok(d.parents("[role=group]:first")[0]===c[0],"Regroup"),this.service.verify()}}],v={context:{applicationContext:h},itemsDataProvider:i,groupsDataProvider:j,groupBy:"entityState.name",orderBy:["entityState.id"],views:[{type:"grid.entity",group:{dataIndex:"name"}}]};l(v.context);var w=f.create("[component.list][tasks_bugs]",r,c,v);g.create(w,s).viewShouldFollowDataComponentLifeCycle(t).viewShouldPassTests(u).done()};return{run:m}})