define(["tau/slice/api","Underscore","jQuery","tests.async/testkit/testkit.store","tests.async/slice/data","tau/core/tau","./client.slice"],function(a,_,$,b,c,d,e){var f=new b,g=new e({x:"release",y:"feature",cells:"userStory"}),h=function(b){var c=$.Deferred(),d=b.get("data"),e=d.project.p_scrum.id,f=b.get("configurator").getStore(),h={x:{types:["Release"]},y:{types:["Feature"]},cells:{types:["UserStory"]}},i=null;return b.get("real")===!1&&(i=function(a){var b=$.Deferred(),c=decodeURI(a.url);if(c.indexOf("/cells")>0)return b.resolve(g.getCells(d,a)),b;if(c.indexOf("/list")>0)return b.resolve(g.getList(d,a)),b;if(c.indexOf("/xaxis")>0)return b.resolve(g.getXResponse(d,a)),b;if(c.indexOf("/yaxis")>0)return b.resolve(g.getYResponse(d,a)),b;if(c.indexOf("/move")>0)return b.resolve(g.move(d,a)),b;throw"not defined call for "+JSON.stringify(c)},sinon.stub(f.config.proxy.service,"get",function(a){a.callbacks.success({id:a.config.id,acid:"345"})})),f.get("context",{id:e,fields:["acid"]},{success:function(b){_.extend(h,{global:{acid:b.data.acid}});var d=new a({definition:h,service:i,store:f});c.resolve(d)}}).done(),c};f.registerSetup("fixtures",function(a,b){a.set("fixtures",c()),b()});var i={name:"[slice] api"},j=[],k=[],l=function(a,b){a.desc=function(a){return"["+this.name+"] "+a},a.deferred=$.Deferred(),b.push(a)},m=function(a){l(a,k)},n=function(a){l(a,j)};n({name:"x values",method:"x",asserts:function(a,b){a.equals(3,b.data.items.length,this.desc("3 releases for x axis"))}}),n({name:"y values",method:"y",asserts:function(a,b){a.equals(2,b.data.items.length,this.desc("2 features for y axis"))}}),n({name:"x values range 1",method:"x",params:{$take:1,$skip:0},asserts:function(a,b){a.equals(1,b.data.items.length,this.desc("takes required data"))}}),n({name:"x values range 2",method:"x",params:{$take:1,$skip:1},asserts:function(a,b){a.equals(1,b.data.items.length,this.desc("takes required data"))}}),n({name:"cell count and format",method:"cell",asserts:function(a,b){a.equals(6,b.data.items.length,this.desc("cells count is correct")),a.ok(b.data.items[0].dynamic,this.desc("dynamic node")),a.ok(b.data.items[0].fixed,this.desc("fixed node")),a.ok(b.data.items[0].x,this.desc("x node")),a.ok(b.data.items[0].y,this.desc("y node"))}}),n({name:"cells content",method:"cell",getParams:function(a){var b=a.get("data");return{x:_.values(b.release)[0].id.toString(),y:_.values(b.feature)[0].id.toString()}},asserts:function(a,b,c){var d=b.data.items[0].dynamic.items;a.equals(d.length,3,this.desc("have stories"))}}),n({name:"cells filtering by x and y",method:"cell",getParams:function(a){var b=a.get("data");return{x:_.values(b.release)[0].id.toString(),y:_.values(b.feature)[0].id.toString()}},asserts:function(a,b){a.ok(b.ajaxConfig,this.desc("ajax config comes")),a.ok(b.ajaxConfig.url.indexOf("where"),this.desc("where attached")),a.equals(b.data.items.length,1,this.desc("cells count is correct"))}}),n({name:"cells filtering only x",method:"cell",getParams:function(a){var b=a.get("data");return{x:_.values(b.release)[0].id.toString()}},asserts:function(a,b){a.equals(b.data.items.length,2,this.desc("cells count is correct"))}}),n({name:"cells filtering $in only x",method:"cell",getParams:function(a){var b=a.get("data");return{x:{$in:[_.values(b.release)[0].id.toString(),_.values(b.release)[1].id.toString()]}}},asserts:function(a,b){a.equals(b.data.items.length,4,this.desc("cells count is correct"))}}),n({name:"cells filtering only y",method:"cell",getParams:function(a){var b=a.get("data");return{y:_.values(b.feature)[0].id.toString()}},asserts:function(a,b){a.equals(b.data.items.length,3,this.desc("cells count is correct"))}}),n({name:"size",method:"size",asserts:function(a,b){a.equals(3,b.data.x,this.desc("x count is correct")),a.equals(2,b.data.y,this.desc("y count is correct"))}}),n({name:"axes",method:"axes",asserts:function(a,b){var c=a.get("data"),d=function(a,b){return _(b).map(function(b){return g.generateItem(a,b)})},e={x:d("x",c.release),y:d("y",c.feature)},f=b.data,h=function(a,b){var c=function(b){return 1*b[a]};return _(b).sortBy(c)};a.same(h("x",f.x),h("x",e.x),this.desc("x axes info is correct")),a.same(h("y",f.y),h("y",e.y),this.desc("y axes info is correct"))}}),m({name:"move item from x1 to x2",method:"move",getParams:function(a){var b=a.get("data"),c=_.values(b.release),d=_.values(b.feature),e=_.values(b.userStory);return{$set:{x:c[c.length-1].id.toString(),y:d[d.length-1].id.toString(),itemId:e[e.length-1].id.toString()}}},asserts:function(a,b){a.ok(b.data,this.desc("move successed")),a.ok(b.data.x,this.desc("x provided")),a.ok(b.data.y,this.desc("y provided")),a.ok(b.data.id,this.desc("id of item provided"))}});var o=function(a,b,c){var d=c.params;!d&&c.getParams&&(d=c.getParams(a)),a.get("configurator").clearSingles(),b[c.method](d).done(function(d){try{c.asserts(a,d,b)}catch(e){a.fail("["+c.name+"] "+e)}c.deferred.resolve()}).fail(function(b){a.fail(b.data.status+": "+b.data.statusText),c.deferred.resolve()})};return i["read slice operations"]=f.test(function(a){var b=_.select(j,function(a){if(a.name[0]==="!")return!0});b.length>0&&(j=b),$.when.apply(null,_.pluck(j,"deferred")).done(function(){a.done()}),h(a).done(function(b){while(j.length>0){var c=j.pop();o(a,b,c)}})}),i["write slice operations"]=f.test(function(a){var b=_.select(k,function(a){if(a.name[0]==="!")return!0});b.length>0&&(k=b),$.when.apply(null,_.pluck(k,"deferred")).done(function(){a.done()}),h(a).done(function(b){while(k.length>0){var c=k.pop();o(a,b,c)}})}),i})