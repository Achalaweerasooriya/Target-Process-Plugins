define(["tau/storage/api","Underscore","jQuery","tests.async/testkit/testkit.store","tau/core/class"],function(a,_,$,b,c){var d=new b;d.registerSetup("storage",function(b,c){var d={};b.get("real")===!1&&(d.service=function(a){var b=$.Deferred();return b.resolve(null),b});var e=a.extend({signUpOnFail:function(a){return a.fail(function(a){b.fail("storage error:"+a.data.responseText),b.done()}),a},select:function(){var a=this._super.apply(this,arguments);return this.signUpOnFail(a)},_deferredResolved:function(){try{this._super.apply(this,arguments)}catch(a){b.fail("failure:"+a.message),b.done()}},data:function(){var a=this._super.apply(this,arguments);return this.signUpOnFail(a)}}),f=new e(d);b.set("storage",f),c()});var e={name:"[storage] api"};return e["returns null for non-exisiting settings"]=d.test(function(a){a.get("storage").data(d.unique("ui"),"useAwseomeViews").done(function(b){a.ok(b.data===null,"null by default"),a.done()})}),e["posting data"]=d.test(function(a){var b=a.get("storage"),c=d.unique("ui"),e="    me, I love it";b.data(c,e,{publicData:{color:"red"},userData:{love:"forever"}}).done(function(d){b.data(c,e).done(function(b){a.ok(b.data),a.equals(b.data.publicData.color,"red"),a.equals(b.data.userData.love,"forever"),a.same(b.value,{color:"red",love:"forever"},"data merged"),a.done()})})}),e["select only one field"]=d.test(function(a){var b=a.get("storage"),c=d.unique("ui");b.data(c,{name:"super",f:"1",a:"black"}).done(function(){b.data(c,{scope:"public",publicData:{name:"puper",f:"2"},userData:{a:"white"}}).done(function(){b.select(c,{$where:{scope:"private"},$fields:["userData.name","userData.a as color"]}).done(function(b){a.equals(b.data.length,1);var c=b.data[0]||{};a.equals(c.name,"super"),a.equals(c.color,"black"),a.done()})})})}),e["find some"]=d.test(function(a){var b=a.get("storage"),c=d.unique("ui");b.data(c,{name:"super",f:"1",a:"black"}).done(function(){b.data(c,{scope:"public",publicData:{name:"puper",f:"2"},userData:{a:"white"}}).done(function(){b.select(c,{$where:{"userData.a":'"black"'},$fields:["userData.name","userData.a as color"]}).done(function(b){a.equals(b.data.length,1);var c=b.data[0]||{};a.equals(c.name,"super"),a.equals(c.color,"black"),a.done()})})})}),e["auto convert data values in data"]=d.test(function(a){var b=a.get("storage"),c=d.unique("ui");b.data(c,{name:"super",f:{a:{b:1}}}).done(function(b){a.equals(b.value.f.a.b,1,"deserizied in good way"),a.done()})}),e["get all data for group"]=d.test(function(a){var b=a.get("storage"),c=d.unique("ui"),e="first",f="second";b.data(c,{name:"super",f:1}).done(function(){b.data(c,{name:"puper",f:2}).done(function(){b.data(c).done(function(b){a.equals(b.data.length,2),a.done()})})})}),e["recurrent access"]=d.test(function(a){var b=a.get("storage"),c=d.unique("ui");$.when(b.data(c,{name:"super 1"}),b.data(c,{name:"super 2"})).done(function(b){a.done()})}),e})