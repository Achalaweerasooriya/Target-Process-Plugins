define(["Underscore","jQuery","tests.async/testkit/testkit.component","tests/common/remoteConstants","tests.async/slice/client.slice","tau/models/boardSettings/factory.board.settings","tau/storage/api"],function(_,$,a,b,c,d,e){var f=a.extend({init:function(a){this._super(a);var f=new c({x:"release",y:"feature",cells:"userStory"}),g={name:"preved",x:{types:["Release"]},y:{types:["Feature"]},cells:{types:["UserStory"]}};this.registerSetup("fixtures",function(a,c){var d={us:b.EntityTypes.USERSTORY,release:b.EntityTypes.RELEASE,feature:b.EntityTypes.FEATURE},e={planning:{id:b.Practices.PLANNING.id},requirements:{id:b.Practices.REQUIREMENTS.id}},f={scrum:{name:"scrum"+ +(new Date),practices:["planning","requirements"]}},g={p_scrum:{name:"Project Scrum"+ +(new Date),process:"scrum"}},h={},i={};for(var j=0;j<4;j++){var k="release"+j;h[k]={name:"Release_"+j+"_"+ +(new Date),entityType:"release",project:"p_scrum"};var l="feature"+j;i[l]={name:"Feature_"+j+"_"+ +(new Date),entityType:"feature",project:"p_scrum",release:k}}var m={};_(h).chain().keys().each(function(a){_(i).chain().keys().each(function(b){for(var c=0;c<4;c++){var d=["us",a,b,c].join("_");m[d]={name:d,entityType:"us",project:"p_scrum",release:a,feature:b}}})});var n={entityTypes:d,practices:e,processes:f,projects:g,releases:h,features:i,userStories:m};a.set("fixtures",n),c()}),this.registerSetup("board.settings",function(a,b){a.set("boardKey",_.uniqueId());if(a.get("real")===!1){b();return}var c=new e;c.data("boards",{userData:{name:"storage preved"}}).done(function(c){var d=c.data;a.set("boardKey",d.key),b()})}),this.registerSetup("component.initialize",function(a,b){var c=a.get("configurator"),e=c.getStore(),h=a.get("data"),i=h.project.p_scrum.id,j=null;a.get("real")===!1&&(j=function(a){var b=$.Deferred(),c=decodeURI(a.url);if(c.indexOf("/cells")>0)return b.resolve(f.getCells(h,a)),b;if(c.indexOf("/xaxis")>0)return b.resolve(f.getXResponse(h,a)),b;if(c.indexOf("/yaxis")>0)return b.resolve(f.getYResponse(h,a)),b;throw"not defined call for "+JSON.stringify(c)},sinon.stub(e.config.proxy.service,"get",function(a){a.callbacks.success({id:a.config.id,acid:"345"})}),c.setRestStorageService(function(b){var c=b.$scope;if(c.$group==="boards"){var d={group:{name:"boards",id:2},key:c.$key,ownerId:1,scope:"Public",publicData:{},userData:{zoomLevel:"2",name:"storage preved"},id:a.get("boardId")},e=$.Deferred();return e.resolve(d),e}})),e.get("context",{id:i,fields:["acid"]},{success:function(e){var f=a.get("componentBus"),i={context:{configurator:{storeFactory:c},acid:e.data.acid},testData:h};j!==null&&(i.sliceService=j),f.initialize(i),c.setExternal({});var k=c.getExternal(),l=k.setHash;k.setHash=function(){l.apply(k,arguments),k.triggerHashChange()};var m=_.extend({id:a.get("boardKey")},g),n=d.createInstance(c,m);f.fire("boardSettings.ready",{boardSettings:n}),b()}}).done()})}});return f})