define(["tau/core/class","Underscore"],function(Class,_){var TestKit=Class.extend({init:function(){this.setups={},this.teardowns={},this.setupsOrder=[]},registerSetup:function(name,fn){this.setups[name]=fn},registerTeardown:function(name,fn){this.teardowns[name]=fn},setSetupsOrder:function(setupNames){this.setupsOrder=setupNames},unique:function(name){return _.uniqueId(name+" ")+" "+ +(new Date)},test:function(testFunction){var setupsOrder=this.setupsOrder,self=this,orderedSetups=[];setupsOrder.length?_.forEach(setupsOrder,function(v){if(self.setups.hasOwnProperty(v)==0)throw new Error('No setup name "'+v+'"');orderedSetups.push(self.setups[v])}):orderedSetups=self.setups;var setups=_.compact(_.values(orderedSetups)),teardowns=_.values(this.teardowns);return function(){return function(test){var setupsSeries=[];_.forEach(setups,function(fn){setupsSeries.push(function(next){fn.call(null,test,next)})});var teardownsSeries=[];_.forEach(teardowns,function(fn){teardownsSeries.push(function(next){fn.call(null,test,next)})}),_.series(setupsSeries,function(err,result){if(err)test.done(err);else{if(teardowns.length){var done=test.done;test.done=function(err){_.series(teardownsSeries,function(err2){if(err||err2)return done(err||err2);done()})}}try{testFunction(test)}catch(e){test.fail("failure:"+e.message),test.done()}}})}}()}});return TestKit})