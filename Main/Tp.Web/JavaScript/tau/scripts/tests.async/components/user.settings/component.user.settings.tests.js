define(["jQuery","tests.async/testkit/testkit.component","tau/components/component.user.settings","tau/ui/extensions/container/ui.extension.container.childrenEvents","tau/extensions/extension.underscore"],function($,TestKit,Component,ExtensionChildrenEvents){var testKit=new TestKit(Component);testKit.registerSetup("componentBus",function(test,next){var componentConfig={context:{configurator:test.get("configurator")},extensions:[ExtensionChildrenEvents]};test.set("componentBus",test.get("componentClass").create(componentConfig)),next()}),testKit.registerSetup("fixtures",function(test,next){var users={vasya:{login:"vasya"+ +(new Date),firstName:"Vasya",lastName:"Pupkin",email:"vasya"+_.UUID()+"@example.com",password:123123,isAdministrator:!0,avatarUri:"http://localhost/targetprocess/avatar.ashx?UserId=120&modified=2132&size="}},fixtures={users:users};test.set("fixtures",fixtures),next()}),testKit.registerSetup("component.initialize",function(test,next){var spy=null,configurator=test.get("configurator");test.get("real")==0?(spy=sinon.stub(configurator.getAvatarService(),"getCropRect",function(userId){var rectCrop=$.Deferred();return rectCrop.resolve({height:767,width:767,x:10,y:23})}),spy=sinon.stub(configurator.getAvatarService(),"crop",function(url){return $.Deferred().resolve({Id:test.get("data").user.vasya.id,FirstName:"Vasya",LastName:"Pupkin",AvatarUri:"http://localhost/targetprocess/avatar.ashx?UserId=120&modified="+(new Date).getTime()+"&size=",ModifyDate:"/Date(1346330577084+0300)/"})}),spy=sinon.stub(configurator.getAvatarService(),"remove",function(url){return $.Deferred().resolve({Id:userId,FirstName:"Vasya",LastName:"Pupkin",AvatarUri:"http://localhost/targetprocess/avatar.ashx?UserId=120&modified="+(new Date).getTime()+"&size=",ModifyDate:"/Date(1346330577084+0300)/"})})):(spy=sinon.spy(configurator.getAvatarService(),"getCropRect"),spy=sinon.spy(configurator.getAvatarService(),"crop"),spy=sinon.spy(configurator.getAvatarService(),"remove")),test.set("avatarService.spy",spy);var testData=test.get("data"),componentBus=test.get("componentBus"),appContextService=configurator.getApplicationContextService();configurator.setLoggedUser(testData.user.vasya),componentBus.initialize({context:{entity:testData.user.vasya,applicationContext:{culture:{decimalSeparator:"."},loggedUser:testData.user.vasya}}}),next()});var testcase={name:"component.user.settings"};return testcase["should render valid markup and should allow to edit"]=testKit.test(function(test){var user=test.get("data").user.vasya,oldSrc,login="vasya"+(new Date).getTime(),email="example"+_.UUID()+"@mailer.ru",hours=10,password=1,activeDirectory="";testKit.flow(test,{"bus afterRender[0]":function(evt,renderData){var $el=renderData.element,$emailField=$el.find(".tau-email"),$login=$el.find(".tau-login"),$hours=$el.find(".tau-weekly-hours"),$activeDirectory=$el.find(".tau-active-directory-name"),$password=$el.find(".tau-password"),$passwordConfirmation=$el.find(".tau-password-confirmation"),$isActive=$el.find(".tau-is-active"),saveButton=$el.find(".tau-update");$("body").append($el),$el.wrap('<div style="display: none;" />'),test.equals($el.length,1,"el rendered"),$emailField.val("dfasasdf"),$login.val(""),$hours.val(""),$activeDirectory.val("fdsa"),$passwordConfirmation.val(1),$password.val(3),$el.submit(),test.ok($emailField.hasClass("tau-error")&&$emailField.attr("title"),"validate email"),test.ok($login.hasClass("tau-error")&&$login.attr("title"),"validate login"),test.ok($hours.hasClass("tau-error")&&$hours.attr("title"),"validate weekly hours"),test.ok($activeDirectory.hasClass("tau-error")&&$activeDirectory.attr("title"),"validate active directory name"),test.ok($password.hasClass("tau-error")&&$password.attr("title")&&$passwordConfirmation.hasClass("tau-error")&&$passwordConfirmation.attr("title"),"validate password"),$emailField.val(email),$login.val(login),$hours.val(hours),$activeDirectory.val(activeDirectory),$passwordConfirmation.val(password),$password.val(password),$isActive.prop("checked",!0),$el.submit()},"bus afterRender[1]":function(evt,renderData){var isSave=!0,$el=renderData.element,$emailField=$el.find(".tau-email"),$login=$el.find(".tau-login"),$hours=$el.find(".tau-weekly-hours"),$activeDirectory=$el.find(".tau-active-directory-name"),$isActive=$el.find(".tau-is-active");isSave=$emailField.val()==email&&$login.val()==login&&$hours.val()==hours&&$activeDirectory.val()==activeDirectory&&$isActive.prop("checked"),test.ok(isSave,"user settings save"),test.done()}})}),testcase})