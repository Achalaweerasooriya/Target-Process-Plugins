define(["jQuery","tests.async/testkit/testkit.component","tp/reports/cycleTimeDistribution/component.report","tests/common/remoteConstants","tp.tests.async/components/reports/chart.helper","tp/date.utils","libs/d3/d3","tp/reports/service.chart.size"],function($,TestKit,Component,Constants,helper,du,d3,ServiceChartSize){function TimeDistributionChart($element){function $emptySpace(day){return day?$element.find("rect.transparent:nth("+day+")"):$element.find("rect.transparent")}function $bar(day){return $element.find("g.day:nth("+day+")")}function trigger($trigger){function _getEventArgs(data){return data.length?[[data]]:data}return function(event){d3.event={pageX:0,pageY:0};var d3trigger=d3.select($trigger[0]),args=_getEventArgs(d3trigger.datum());d3trigger.on(event).call($trigger[0],args)}}return{emptyBars:function(day){return $.extend($emptySpace(day),{trigger:trigger($emptySpace(day))})},emptySpace:function(day){return $.extend($emptySpace(day),{trigger:trigger($emptySpace(day))})},bar:function(day){return $.extend($bar(day),{trigger:trigger($bar(day))})},popup:function(){var bubble=$element.find(".tau-chart-tooltip").data("tauBubble");return bubble.$popup},tooltip:function(){return $element.find("div.hover.tau-chart-tooltip")}}}function Report($element){return{settings:helper.Settings($element)}}var testKit=new TestKit(Component);testKit.registerSetup("fixtures",function(test,next){var entityStates={us_done:{name:"done"+ +(new Date),entityType:"us",process:"scrum",isFinal:!0},bug_done:{name:"done"+ +(new Date),entityType:"bug",process:"scrum",isFinal:!0},task_done:{name:"done"+ +(new Date),entityType:"task",process:"scrum",isFinal:!0},feature_done:{name:"done"+ +(new Date),entityType:"feature",process:"scrum",isFinal:!0},request_done:{name:"done"+ +(new Date),entityType:"request",process:"scrum",isFinal:!0}},entityTypes={us:Constants.EntityTypes.USERSTORY,bug:Constants.EntityTypes.BUG,task:Constants.EntityTypes.TASK,feature:Constants.EntityTypes.FEATURE,request:Constants.EntityTypes.REQUEST},practices={planning:{id:Constants.Practices.PLANNING.id},bugTracking:{id:Constants.Practices["BUG TRACKING"].id}},processes={scrum:{name:"scream"+parseInt(Math.random()*1e11),practices:["planning","bugTracking"]}},projects={project1:{name:"Project #1"+parseInt(Math.random()*1e11),process:"scrum"}},userStories={us1:{name:"US1",entityType:"us",project:"project1",entityState:"us_done",createDate:du.toTimestamp(du.addDays(new Date,-10)),startDate:du.toTimestamp(du.addDays(new Date,-7))}},bugs={bug1:{name:"B1",entityType:"bug",project:"project1",entityState:"bug_done",createDate:du.toTimestamp(du.addDays(new Date,-10)),startDate:du.toTimestamp(du.addDays(new Date,-3))},bug2:{name:"B2",entityType:"bug",project:"project1",entityState:"bug_done",createDate:du.toTimestamp(du.addDays(new Date,-10)),startDate:du.toTimestamp(du.addDays(new Date,-5))},bug3:{name:"B3",entityType:"bug",project:"project1",entityState:"bug_done",createDate:du.toTimestamp(du.addDays(new Date,-10)),startDate:du.toTimestamp(du.addDays(new Date,-7))}},tasks={task1:{name:"T1",entityType:"task",project:"project1",userStory:"us1",entityState:"task_done",createDate:du.toTimestamp(du.addDays(new Date,-10)),startDate:du.toTimestamp(du.addDays(new Date,-1))}},fixtures={practices:practices,entityTypes:entityTypes,processes:processes,entityStates:entityStates,projects:projects,userStories:userStories,bugs:bugs,tasks:tasks};test.set("fixtures",fixtures),next()}),testKit.registerSetup("component.initialize",function(test,next){var testData=test.get("data"),componentBus=test.get("componentBus"),configurator=test.get("configuratorInstance");configurator.registerService("chart.size",new ServiceChartSize),configurator.getApplicationContextService().getApplicationContext({projectIds:[testData.project.project1.id]},{success:function(context){var acid=context.acid;sinon.stub(configurator.getAppStateStore(),"get",function(command){command.callback({acid:acid})}),ajaxSpied||(ajaxSpied=sinon.spy($,"ajax")),configurator.getRestStorage().data("settings","timeDistributionChart",{userData:{scale:"cycleTime",entities:JSON.stringify(["userstory","bug"]),filter:"?EndDate > Today - 180(days)"},scope:"Public"}).done(function(data){ajaxSpied.reset(),test.set("ajaxSpy",ajaxSpied),componentBus.initialize({context:{configurator:configurator}}),next()})}})});var testcase={name:"cycle time distribution"};return testcase["should render cycle time distribution chart component"]=testKit.test(function(test){testKit.flow(test,{"bus afterRender[0]":function(evt,renderData){test.ok(renderData.element.is(".tau-cycle-time-distribution"),"Cycle Time Distribution chart container component rendered."),test.ok(renderData.element.find(".tau-chart-settings").length,"Settings rendered."),test.ok(renderData.element.find(".tau-chart-plot").length,"Plot rendered."),test.done()}})}),testcase["should initialize plot"]=testKit.test(function(test){testKit.flow(test,{"bus plot.ready":function(evt,plot){test.ok(plot,"Plot is initialized"),test.done()}})}),testcase["should render user story and bug bars"]=testKit.test(function(test){testKit.flow(test,{"bus afterRender + plot.afterRender[0]":function(evt,data,plot){test.ok(data.element.find("rect.userstory").length,"User story bars were rendered."),test.ok(data.element.find("rect.bug").length,"Bug bars were rendered."),test.done()}})}),testcase["should render probability line"]=testKit.test(function(test){testKit.flow(test,{"bus afterRender + plot.afterRender[0]":function(evt,data,plot){test.ok(data.element.find("path.userstory").length,"User story completeness probability was rendered."),test.ok(data.element.find("path.bug").length,"Bug completeness probability was rendered."),test.done()}})}),testcase["should open details on mouse move over bars"]=testKit.test(function(test){testKit.flow(test,{"bus afterRender + plot.afterRender[0]":function(evt,data,plot){function hover(day){return chart.bar(day).trigger("mouseover"),chart.popup()}var chart=TimeDistributionChart(data.element);test.ok(hover(3),"tooltip is shown"),test.equals(hover(3).text(),"3 days33.3% of all bugs (1 of 3)","text is correct"),test.equals(hover(5).text(),"5 days33.3% of all bugs (1 of 3)","text is correct"),test.equals(hover(7).text(),"7 days100% of all user stories (1 of 1)33.3% of all bugs (1 of 3)","text is correct"),test.done()}})}),testcase["should show probability details on mouse move over empty space"]=testKit.test(function(test){testKit.flow(test,{"bus afterRender + plot.afterRender[0]":function(evt,data,plot){function triggerOn(day){return chart.emptySpace(day).trigger("mousemove"),chart.tooltip()}var chart=TimeDistributionChart(data.element);test.ok(triggerOn(3).length,"tooltip is shown"),test.equals(triggerOn(3).text(),"probability to complete entities in 3 days: 0% 33.3% ","text is correct"),test.equals(triggerOn(5).text(),"probability to complete entities in 5 days: 0% 66.7% ","text is correct"),test.equals(triggerOn(7).text(),"probability to complete entities in 7 days: 100% 100% ","text is correct"),test.done()}})}),testcase["should show probability details on mouse move over bars"]=testKit.test(function(test){testKit.flow(test,{"bus afterRender + plot.afterRender[0]":function(evt,data,plot){function triggerOn(day){return chart.bar(day).trigger("mousemove"),chart.tooltip()}var chart=TimeDistributionChart(data.element);test.ok(triggerOn(7).length,"tooltip is shown"),test.equals(triggerOn(7).text(),"probability to complete entities in 7 days: 100% 100% ","text is correct"),test.done()}})}),testcase["should render settings"]=testKit.test(function(test){testKit.flow(test,{"bus afterRender[0]":function(evt,renderData){var settings=Report(renderData.element).settings;test.ok(settings.isrendered(),"Render settings"),test.same(settings.yAxisButtonNames(),["Lead Time","Cycle Time"],"Lead Time, Cycle Time buttons rendered."),test.equals(settings.yAxisButton(),"Cycle Time","Cycle Time selected by default."),test.same(settings.entityButtonNames(),["Feature","User Story","Task","Bug","Request"],"Entity selector buttons rendered."),test.ok(settings.filterRendered(),"Filter input is rendered"),test.ok(settings.filterHelpRendered(),"Filter help button is rendered"),test.done()}})}),testcase["should respond to settings change"]=testKit.test(function(test){testKit.flow(test,{"bus afterRender[0] + settings.changed[0]":function(evt,renderData){var settings=Report(renderData.element).settings,featureBtn=settings.entityButtons().get("feature");featureBtn.check(),featureBtn.change()},"bus settings.changed[1]":function(evt,data){test.same(["feature","userstory","bug"],helper.select("id").from(data.parameters.definition.cells.items),"User story, Bug and Feature are in definition"),test.done()}})}),testcase["should map data according to settings"]=testKit.test(function(test){testKit.flow(test,{"bus data.ready[0]":function(evt,loadedData){test.same(helper.roundAll(helper.select("y").from(loadedData.data)),[7,3,5,7],"Cycle time mapped to y property"),test.same(helper.select("fill").from(loadedData.data),["UserStory","Bug","Bug","Bug"],"Type mapped to fill property"),test.done()}})}),testcase["should store settings"]=testKit.test(function(test){testKit.flow(test,{"bus afterRender[0] + settings.changed[0]":function(evt,renderData){test.get("ajaxSpy").reset();var settings=Report(renderData.element).settings,featureBtn=settings.entityButtons().get("feature");featureBtn.check(),featureBtn.change()},"bus settings.changed[1]":function(evt,data){var postedSettings=JSON.parse(test.get("ajaxSpy").args[1][0].data),postedEntities=JSON.parse(JSON.parse(postedSettings.userData.entities));test.same(postedEntities,["feature","userstory","bug"],"Feature is enabled for display"),test.done()}})}),testcase["should choose between lead time/cycle time via settings"]=testKit.test(function(test){testKit.flow(test,{"bus afterRender[0] +  settings.changed[0] + data.ready[0]":function(evt,renderData,$1,loadedData){var settings=Report(renderData.element).settings;$(settings.yAxisButtons()[0]).click()},"bus settings.changed[0] + data.ready[0]":function(evt,$1,loadedData){test.same(helper.roundAll(helper.select("y").from(loadedData.data)),[7,3,5,7],"Cycle time mapped to y property by default")},"bus settings.changed[1] + data.ready[1]":function(evt,$1,loadedData){test.same(helper.roundAll(helper.select("y").from(loadedData.data)),[10,10,10,10],"Lead time mapped to y property"),test.done()}})}),testcase["should filter entities"]=testKit.test(function(test){testKit.flow(test,{"bus afterRender[0]":function(evt,renderData){var settings=Report(renderData.element).settings;settings.enterFilter("?Name == 'US1'"),settings.applyFilter()},"bus settings.changed[1]":function(evt,data){test.equals(data.parameters.definition.cells.filter,"?Name == 'US1'","Filter applied"),test.done()}})}),testcase["should display axes labels"]=testKit.test(function(test){testKit.flow(test,{"bus afterRender + plot.afterRender[0]":function(evt,data,plot){test.ok(data.element.find("._x .axisLabel .tick").length,"x axis ticks were rendered."),test.equal(data.element.find("._x text.axisLabel.axisTitle").text(),"Cycle Time, days","x axis label were rendered."),test.ok(data.element.find("._x .axisLabel text").length,"x axis labelswere rendered."),test.ok(data.element.find("._y .axisLabel .tick").length,"y axis ticks were rendered."),test.equal(data.element.find("._y text.axisLabel.axisTitle").text(),"% of all entities","y axis label were rendered."),test.ok(data.element.find("._y .axisLabel text").length,"y axis labelswere rendered."),test.done()}})}),testcase["should aggregate data over all pages"]=testKit.test(function(test){testKit.flow(test,{"bus settings.changed[0] + data.ready[0]":function(evt,settings,data){var bus=test.get("componentBus");settings.parameters.take=1,bus.fire("settings.changed",settings)},"bus data.ready[1]":function(evt,loadedData){test.same(helper.select("fill").from(loadedData.data),["UserStory","Bug","Bug","Bug"],"All entities are loaded"),test.done()}})}),testcase["should render max values"]=testKit.test(function(test){testKit.flow(test,{"bus afterRender + plot.afterRender[0]":function(evt,data,plot){test.ok(data.element.find("text.max-val .userstory").length,"User story max value rendered."),test.ok(data.element.find("text.max-val .bug").length,"Bug max value rendered."),test.done()}})}),testcase["should re-render transparent bars after settings changed"]=testKit.test(function(test){testKit.flow(test,{"bus formData.changed[0]":function(evt,formData){test.set("lastFormData",formData)},"bus afterRender + plot.afterRender[0]":function(evt,data,plot){var bus=test.get("componentBus"),formData=test.get("lastFormData");formData.time.key="leadTime",bus.fire("formData.changed",formData)},"bus afterRender + plot.afterRender[1]":function(evt,data,plot){var widths=TimeDistributionChart(data.element).emptyBars().map(function(){return $(this).attr("width")}),normalizedWidths=widths.map(function(){return this/widths[0]});test.same(normalizedWidths.toArray(),[1,1,1,1,1,1,1,1,1,1,1],"widths should be the same"),test.done()}})}),testcase})