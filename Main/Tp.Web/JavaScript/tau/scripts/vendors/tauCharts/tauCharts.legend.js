!function(e){if("function"==typeof define&&define.amd)define(["tauCharts"],function(t){return e(t)});else if("object"==typeof module&&module.exports){var t=require("tauCharts");module.exports=e(t)}else e(this.tauCharts)}(function(e){function t(e){return Math.log(e)/Math.LN10}var i=function(e,t){if(t(e))return e;var r,n,a,l=e.unit||[];for(r=0;r<l.length;r+=1)if(n=l[r],a=i(n,t))return a},r=function(e){return e=Math.round(e),e%2?e+1:e},n=e.api._,a=e.api.d3,l=function(e){return null===e||""===e||"undefined"==typeof e},s=function(){return{_delegateEvent:function(e,t,i,r){e.addEventListener(t,function(e){for(var t=e.target;t!==e.currentTarget&&null!==t;)t.classList.contains(i)&&r(e,t),t=t.parentNode})},_findUnit:function(e){var t=e.getConfig();return i(t.spec.unit,function(e){return e.color||e.size&&"measure"===t.dimensions[e.size].type})},init:function(e){this._isNeedLegend(e)&&(this._currentFilters={},this._storageValues={},this._container=e.insertToRightSidebar(this._containerTemplate),this._delegateEvent(this._container,"click","graphical-report__legend__item-color",function(t,i){this._toggleLegendItem(i,e)}.bind(this)),this._delegateEvent(this._container,"mouseover","graphical-report__legend__item-color",function(t,i){this._highlightToggle(i,e,!0)}.bind(this)),this._delegateEvent(this._container,"mouseout","graphical-report__legend__item-color",function(t,i){this._highlightToggle(i,e,!1)}.bind(this)))},_highlightToggle:function(e,t,i){var r=this._unit.options.color,l=t.getSVG(),s=a.select(l);if(e.classList.contains("disabled")&&(i=!1),i){var o=e.getAttribute("data-value"),c=this._storageValues[o],u=c.color;s.selectAll(".i-role-element").classed({"graphical-report__highlighted":!1}),s.selectAll(".i-role-element."+u).filter(function(e){var t=e.hasOwnProperty(c.dimension)?e[c.dimension]:n.chain(e.values).pluck(c.dimension).unique().first().value();return r.legend(t).value===c.value}).classed({"graphical-report__highlighted":!0}),s.classed({"graphical-report__highlighted_chart":!0})
}else s.selectAll(".i-role-element").classed({"graphical-report__highlighted":!1}),s.classed({"graphical-report__highlighted_chart":!1})},_toggleLegendItem:function(e,t){var i=this._unit.options.color,r=e.getAttribute("data-value"),a=n.keys(this._currentFilters);if(a.length!==this._colorScaleSize-1||this._currentFilters.hasOwnProperty(r))if(this._currentFilters.hasOwnProperty(r)){var l=this._currentFilters[r];delete this._currentFilters[r],e.classList.remove("disabled"),t.removeFilter(l)}else{this._currentFilters[r]=1;var s=this._storageValues[r],o={tag:"legend",predicate:function(e){var t=e[s.dimension];return i.legend(t).value!==s.value}};e.classList.add("disabled"),this._currentFilters[r]=t.addFilter(o)}},_isNeedLegend:function(e){return Boolean(this._findUnit(e))},onUnitReady:function(e,t){-1!==t.type.indexOf("ELEMENT")&&(this._unit=t)},_getColorMap:function(e,t,i){return n(e).chain().map(function(e){return t.legend(e[i])}).uniq(function(e){return e.value}).value().reduce(function(e,t){return e.brewer[t.value]=t.color,e.values.push(t),e},{brewer:{},values:[]})},_containerTemplate:'<div class="graphical-report__legend"></div>',_template:n.template('<div class="graphical-report__legend"><div class="graphical-report__legend__title"><%=name%></div><%=items%></div>'),_itemTemplate:n.template(["<div data-value='<%=value%>' class=\"graphical-report__legend__item graphical-report__legend__item-color <%=classDisabled%>\">",'<div class="graphical-report__legend__guide__wrap"><div class="graphical-report__legend__guide <%=color%>" ></div></div><%=label%>',"</div>"].join("")),_itemSizeTemplate:n.template(['<div class="graphical-report__legend__item graphical-report__legend__item--size">','<div class="graphical-report__legend__guide__wrap">','<svg class="graphical-report__legend__guide graphical-report__legend__guide--size  <%=className%>" style="width: <%=diameter%>px;height: <%=diameter%>px;"><circle cx="<%=radius%>" cy="<%=radius%>" class="graphical-report__dot" r="<%=radius%>"></circle></svg>',"</div><%=value%>","</div>"].join("")),_renderColorLegend:function(e,t){if(e.color){var i=this._unit.options.color,r=this._unit.color.scaleDim;
e.guide=e.guide||{},e.guide.color=this._unit.guide.color;var a=e.guide.color.label.text||i.dimension,s=this._getColorMap(t.getData({excludeFilter:["legend"]}),i,r);e.guide.color.brewer=s.brewer;var o=n.reduce(s.values,function(e,t){var i={dimension:r,value:t.value,color:t.color},s=JSON.stringify(i),o=n.escape(l(t.label)?"No "+a:t.label);return e.items.push(this._itemTemplate({color:t.color,classDisabled:this._currentFilters[s]?"disabled":"",label:o,value:n.escape(s)})),e.storageValues[s]=i,e},{items:[],storageValues:{}},this);this._storageValues=o.storageValues,this._container.insertAdjacentHTML("beforeend",this._template({items:o.items.join(""),name:a})),this._colorScaleSize=o.items.length}},_renderSizeLegend:function(e,i){if(e.size&&"measure"===i.getConfig().spec.dimensions[e.size].type){var a=this._unit.options.sizeScale,l=this._unit.size.scaleDim;e.guide=e.guide||{},e.guide.size=this._unit.guide.size;var s,o=e.guide.size.label.text||l,c=n.sortBy(i.getData(),function(e){return a(e[l])}),u=c.length,d=c[0][l],_=c[u-1][l];if(_-d){var g=t(_-d),h=Math.round(4-g),p=Math.pow(10,h),v=(_-d)/5,f=[d,d+v,d+2*v,d+3*v,_];s=n(f).chain().map(function(e){return e===_||e===d?e:Math.round(e*p)/p}).unique().value()}else s=[d];var m=n.map(s,function(t){var i=a(t);return this._itemSizeTemplate({diameter:r(2*i+2),radius:i,value:t,className:e.color?"color-definite":"color-default-size"})},this).reverse();this._container.insertAdjacentHTML("beforeend",this._template({items:m.join(""),name:o}))}},onRender:function(e){if(this._container){this._container.innerHTML="";var t=this._findUnit(e);this._renderColorLegend(t,e),this._renderSizeLegend(t,e)}}}};return e.api.plugins.add("legend",s),s});