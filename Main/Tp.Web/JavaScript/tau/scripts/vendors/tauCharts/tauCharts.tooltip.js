!function(t){if("function"==typeof define&&define.amd)define(["tauCharts"],function(e){return t(e)});else if("object"==typeof module&&module.exports){var e=require("tauCharts");module.exports=t(e)}else t(this.tauCharts)}(function(t){function e(e){return e=e||{},{template:['<div class="i-role-content graphical-report__tooltip__content"></div>','<div class="i-role-exclude graphical-report__tooltip__exclude">','<div class="graphical-report__tooltip__exclude__wrap">','<span class="tau-icon-close-gray"></span>Exclude',"</div>","</div>"].join(""),itemTemplate:['<div class="graphical-report__tooltip__list__item">','<div class="graphical-report__tooltip__list__elem"><%=label%></div>','<div class="graphical-report__tooltip__list__elem"><%=value%></div>',"</div>"].join(""),onExcludeData:function(){},_drawPoint:function(t,e,i,n){this.circle&&this.circle.remove(),this.circle=t.append("circle").attr("cx",e).attr("cy",i).attr("class",n).attr("r",4),this.circle.node().addEventListener("mouseover",function(){clearTimeout(this._timeoutHideId)}.bind(this),!1),this.circle.node().addEventListener("mouseleave",function(){this._hide()}.bind(this),!1)},formatters:{},labels:{},init:function(t){this._chart=t,this._dataFields=e.fields,this._getDataFields=e.getFields,i.extend(this,i.omit(e,"fields","getFields")),this._timeoutHideId=null,this._dataWithCoords={},this._unitMeta={},this._templateItem=i.template(this.itemTemplate),this._tooltip=t.addBalloon({spacing:3,auto:!0,effectClass:"fade"}),this._elementTooltip=this._tooltip.getElement();var n=t.getConfig().spec,r=this._findDimensionGuides(n),o=i.reduce(r,function(t,e,n){return t[n]=i.last(e),t},{}),a=this._generateDefaultFormatters(o,n.dimensions);i.extend(this.formatters,a);var s=this._generateDefaultLabels(o);i.extend(this.labels,s);var l=this._elementTooltip;l.addEventListener("mouseover",function(){clearTimeout(this._timeoutHideId)}.bind(this),!1),l.addEventListener("mouseleave",function(){this._hide()}.bind(this),!1),l.addEventListener("click",function(t){for(var e=t.target;e!==t.currentTarget&&null!==e;)e.classList.contains("i-role-exclude")&&(this._exclude(),this._hide()),e=e.parentNode
}.bind(this),!1),l.insertAdjacentHTML("afterbegin",this.template),this.afterInit(this._elementTooltip)},afterInit:function(){},onUnitReady:function(t,e){if(e.type&&0===e.type.indexOf("ELEMENT")){var i=this._generateKey(e.$where);this._unitMeta[i]=e;var n=e.partition();this._dataWithCoords[i]=n.map(function(t){return{x:e.options.xScale(t[e.x.scaleDim]),y:e.options.yScale(t[e.y.scaleDim]),item:t}},this)}},renderItem:function(t,e){return this._templateItem({label:t,value:e})},render:function(t,e){return e=i.unique(e),e.map(function(e){var i=t[e],n=this._getFormatter(e)(i),r=this._getLabel(e);return this.renderItem(r,n,e,i)},this).join("")},afterRender:function(){},onRender:function(t){i.isFunction(this._getDataFields)&&(this._dataFields=this._getDataFields(t)),this._hide()},_getFormatter:function(t){return this.formatters[t]||i.identity},_getLabel:function(t){return this.labels[t]||t},_generateDefaultLabels:function(t){return i.reduce(t,function(t,e,i){return t[i]=e.label||i,t},{})},_generateDefaultFormatters:function(e,n){return i.reduce(e,function(e,i,r){var o=function(e){if(null==e)return null;var o=i.tickPeriod||i.tickFormat;if(o){var a="x-time-auto"===o?"day":o;return t.api.tickFormat.get(a)(e)}return i.tickLabel?e[i.tickLabel]:n[r].value?e[n[r].value]:e};return e[r]=function(t){var e=o(t);return null==e?"No "+i.label:e},e},{})},_findDimensionGuides:function(t){var e={},i=function(t,i){var n=i[t];if(n){var r=(i.guide||{})[t];r&&(e[n]||(e[n]=[]),e[n].push(r))}};return o(t.unit,function(t){return i("x",t),i("y",t),i("color",t),i("size",t),!1}),e},_exclude:function(){this._chart.addFilter({tag:"exclude",predicate:function(t){return function(e){return JSON.stringify(e)!==JSON.stringify(t)}}(this._currentElement)}),this.onExcludeData(this._currentElement)},_calculateLength:function(t,e,i,n){return(i-t)*(i-t)+(n-e)*(n-e)},_calculateLengthToLine:function(t,e,i,n,o,a){var s={x:i-t,y:n-e},l={x:o-t,y:a-e},u=s.x*l.x+s.y*l.y;if(0>u)return r(t,o,e,a);var c={x:t-i,y:e-n},d={x:o-i,y:a-n},h=c.x*d.x+c.y*d.y;
return 0>h?r(i,o,n,a):Math.abs(((i-t)*(a-e)-(n-e)*(o-t))/r(t,i,e,n))},_generateKey:function(t){return JSON.stringify(t)},_getFields:function(t){if(this._dataFields)return this._dataFields;for(var e=[t.size&&t.size.scaleDim,t.color&&t.color.scaleDim],n=[],r=[];t=t.parentUnit;)n.push(t.x.scaleDim),r.push(t.y.scaleDim);return i.compact(e.concat(r,n).reverse())},isLine:function(t){return t.elementData.hasOwnProperty("key")&&Array.isArray(t.elementData.values)},_onElementMouseOver:function(t,e,r,o){clearTimeout(this._timeoutHideId);var a=this._generateKey(e.cellData.$where),s=e.elementData,l=this.isLine(e);if(l){var u=this._dataWithCoords[a],c=u.filter(function(t){return i.contains(s.values,t.item)}),d=i.reduce(c,function(t,e,i,n){var o;if(i+1===n.length){var a=e;e=n[i-1],o=a}else o=n[i+1];var s=this._calculateLengthToLine(e.x,e.y,o.x,o.y,r[0],r[1]);return s<t.h&&(t.h=s,t.points={point1:e,point2:o}),t}.bind(this),{h:1/0,points:{}}),h=i.min(d.points,function(t){return this._calculateLength(t.x,t.y,r[0],r[1])},this);s=h.item,this._drawPoint(n.select(e.element.parentNode),h.x,h.y,this._unitMeta[a].options.color.get(e.elementData.key))}if(this._currentElement!==s){var _=this._elementTooltip.querySelectorAll(".i-role-content");if(_[0]){var f=this._getFields(this._unitMeta[a]);_[0].innerHTML=this.render(s,f)}else console.log("template should contain i-role-content class");this._show(o),this._currentElement=s}},onElementMouseOver:function(t,e){var r=n.mouse(document.body),o=n.mouse(e.element);clearTimeout(this._timeoutShowId),this._timeoutShowId=i.delay(this._onElementMouseOver.bind(this),200,t,e,o,r)},onElementMouseOut:function(){this._hide()},_show:function(t){this._tooltip.show(t[0],t[1]).updateSize()},_hide:function(){clearTimeout(this._timeoutShowId),this._timeoutHideId=setTimeout(function(){this._currentElement=null,this._tooltip.hide(),this.circle&&this.circle.remove()}.bind(this),300)},_destroyTooltip:function(){this.circle&&this.circle.remove(),this._tooltip.destroy()},destroy:function(){this._destroyTooltip()
}}}var i=t.api._,n=t.api.d3,r=function(t,e,i,n){return Math.sqrt((e-t)*(e-t)+(n-i)*(n-i))},o=function(t,e){if(e(t))return t;var i,n,r,a=t.unit||[];for(i=0;i<a.length;i+=1)if(n=a[i],r=o(n,e))return r};return t.api.plugins.add("tooltip",e),e});