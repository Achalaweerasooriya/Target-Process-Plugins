/*!
 * Nodeunit
 * Copyright (c) 2010 Caolan McMahon
 * MIT Licensed
 *
 * THIS FILE SHOULD BE BROWSER-COMPATIBLE JS!
 * You can use @REMOVE_LINE_FOR_BROWSER to remove code from the browser build.
 * Only code on that line will be removed, it's mostly to avoid requiring code
 * that is node specific
 */

define(["libs/async/async","./types","./nodeunit"],function(async,types,nodeunit){var exports={},_keys=function(obj){if(_.isObject(obj)==0)return[];if(Object.keys)return Object.keys(obj);var keys=[];for(var k in obj)obj.hasOwnProperty(k)&&keys.push(k);return keys},_copy=function(obj){var nobj={},keys=_keys(obj);for(var i=0;i<keys.length;i+=1)nobj[keys[i]]=obj[keys[i]];return nobj};exports.runTest=function(name,fn,opt,callback){var options=types.options(opt);options.testStart(name,opt.moduleId);var start=(new Date).getTime(),test=types.test(name,start,options,callback);try{fn(test)}catch(e){test.done(e)}},exports.runSuite=function(name,suite,options,callback){suite=wrapGroup(suite);var keys=_keys(suite),sname=name,funcName="concatSeries";options.execution=="parallel"&&(funcName="concat"),options.shuffle&&(keys=_.shuffle(keys)),async[funcName](keys,function(k,cb){var prop=suite[k],_name;_name=sname?[].concat(sname,k):[k],_name.toString=function(){return this.join(" ")};if(typeof prop=="function"){var filterPassed=!0,filter=options.filter,name=_name.toString();filter&&(filterPassed=name.search(filter)==0);if(!filterPassed)return cb();options.moduleStart&&options.moduleStart(),exports.runTest(_name,suite[k],options,cb)}else exports.runSuite(_name,suite[k],options,cb)},callback)},exports.runModule=function(name,module,opt,callback){function run_once(){_run||(_run=!0,_moduleStart(module))}var options=_copy(types.options(opt)),_run=!1,_moduleStart=options.moduleStart;module=wrapGroup(module),options.moduleStart=run_once,options.moduleId=module.id;var start=(new Date).getTime();exports.runSuite(name,module,options,function(err,a_list){var end=(new Date).getTime(),assertion_list=types.assertionList(a_list,end-start);options.moduleDone(module,assertion_list),callback(null,a_list)})},exports.runModules=function(modules,opt){var all_assertions=[],options=types.options(opt),start=(new Date).getTime(),funcName="concatSeries";opt.execution=="parallel"&&(funcName="concat"),options.shuffle&&(modules=_.shuffle(modules)),async[funcName](_keys(modules),function(k,cb){exports.runModule(modules[k].name||k,modules[k],options,cb)},function(err,all_assertions){var end=(new Date).getTime();options.done(types.assertionList(all_assertions,end-start))})};var wrapTest=function(setUp,tearDown,fn){return function(test){var context={};if(tearDown){var done=test.done;test.done=function(err){try{tearDown.call(context,function(err2){if(err&&err2)return test._assertion_list.push(types.assertion({error:err})),done(err2);done(err||err2)})}catch(e){done(e)}}}setUp?setUp.call(context,function(err){if(err)return test.done(err);fn.call(context,test)}):fn.call(context,test)}},getSerialCallback=function(fns){return fns.length?function(callback){var that=this,bound_fns=[];for(var i=0,len=fns.length;i<len;i++)(function(j){bound_fns.push(function(){return fns[j].apply(that,arguments)})})(i);return async.series(bound_fns,callback)}:null},wrapGroup=function(group,setUps,tearDowns){var tests={},setUps=setUps?setUps.slice():[],tearDowns=tearDowns?tearDowns.slice():[];group.setUp&&(setUps.push(group.setUp),delete group.setUp),group.tearDown&&(tearDowns.unshift(group.tearDown),delete group.tearDown);var keys=_keys(group);for(var i=0;i<keys.length;i+=1){var k=keys[i];typeof group[k]=="function"?tests[k]=wrapTest(getSerialCallback(setUps),getSerialCallback(tearDowns),group[k]):typeof group[k]=="object"&&k.substr(0,1)!="_"?tests[k]=wrapGroup(group[k],setUps,tearDowns):tests[k]=group[k]}return tests};return exports.testCase=function(suite){return suite},exports})