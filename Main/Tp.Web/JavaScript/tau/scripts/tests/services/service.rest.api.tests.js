define(["tau/store/services/service.rest","tau/store/header","jQuery"],function(serviceRest,tauHeader,$){var noPagingRun=function(format,input){var assert=function(result){ok(_.isArray(result),"it is array"),ok(result[0].name,"simple value"),equal(result[0].contacts.length,0,"array value")},result=null,c={};this.api.mockAjaxCall(c);var successFn=function(r){result=r};this.rest.get({type:"person",name:"get",config:{format:format,fields:["name",{contacts:["email"],list:!0}]},callbacks:{success:successFn}}),c.success({items:[input]}),equal(format,c.config.dataType,"used format applied"),assert(result),this.mockControl.verify()},papaPagesRun=function(format,firstPageData,secondPageData){var result=null,firstPage={},secondPage={};this.api.mockAjaxCall(firstPage),this.api.mockAjaxCall(secondPage);var countOfSuccess=0,successFn=function(r){result=r,countOfSuccess++};return this.rest.get({type:"person",name:"get",config:{format:format,fields:["name",{contacts:["email"],list:!0}]},callbacks:{success:successFn}}),firstPage.success(firstPageData),secondPage.success(secondPageData),this.mockControl.verify(),equal(countOfSuccess,1),equal(result.length,2,"two pages merged"),result},childrenPagesRun=function(format,s1,s2,s3,commandName){var result=null;commandName=commandName||"get";var firstPage={},secondPage={},thirdPage={};this.api.mockAjaxCall(firstPage),this.api.mockAjaxCall(secondPage),this.api.mockAjaxCall(thirdPage);var countOfSuccess=0,successFn=function(r){result=r,countOfSuccess++};return commandName!="save"?this.rest.get({type:"person",name:commandName,config:{format:format,fields:["name",{contacts:["email"],list:!0}]},callbacks:{success:successFn}}):this.rest.save({type:"person",name:commandName,config:{$set:{},format:format,fields:["name",{contacts:["email"],list:!0}]},callbacks:{success:successFn}}),firstPage.success(s1),secondPage.success(s2),thirdPage.success(s3),this.mockControl.verify(),equal(result[0].contacts.length,3,"three pages merged"),equal(countOfSuccess,1),result},innerRun=function(){module("[api rest service]",{setup:function(){this.mockControl=new MockControl;var empty=function(config){},jqApiInterface={ajax:empty,error:empty,success:empty};this.api=this.mockControl.createMock(jqApiInterface),this.api.parseJSON=$.parseJSON,this.api.mockAjaxCall=function(config){var x=config||{},self=this;self.expects().ajax(TypeOf.isA(Object)).andStub(function(args){return x.config=args,self}),self.expects().success(TypeOf.isA(Function)).andStub(function(f){return x.success=function(r){x.config.dataType=="array"?r=x.config.converters["text array"](JSON.stringify(r)):r=x.config.converters["text json"](JSON.stringify(r)),f(r)},self}),self.expects().error(TypeOf.isA(Function)).andStub(function(f){return x.failure=f,self})};var config={api:this.api,types:{person:{name:"person",fields:["name"],resource:"persons",refs:{contacts:{list:!0,name:"contact",fields:["email"]}}},contact:{name:"contact",fields:["email",tauHeader.ref("owner")],resource:"contacts",refs:{owner:{name:"person"}}}}};this.rest=new serviceRest(config)},teardown:function(){delete this.rest}}),test("array: no paging",function(){noPagingRun.call(this,"array",["Vasya Pupkin",{items:[]}])}),test("array: no paging with null",function(){noPagingRun.call(this,"array",["Vasya Pupkin",null])}),test("array: no paging with empty array",function(){noPagingRun.call(this,"array",["Vasya Pupkin",[]])}),test("json: no paging",function(){noPagingRun.call(this,"json",{name:"Vasya Pupkin",contacts:{items:[]}})}),test("json: no paging with empty array",function(){noPagingRun.call(this,"json",{name:"Vasya Pupkin",contacts:[]})}),test("array: paging papa",function(){var firstPageData={items:[["Vasya",null]],next:"nextPage"},secondPageData={items:[["Tolya",null]]};papaPagesRun.call(this,"array",firstPageData,secondPageData)}),test("json: paging papa",function(){var firstPageData={items:[{name:"Vasya",contacts:[]}],next:"nextPage"},secondPageData={items:[{name:"Tolya",contacts:[]}]};papaPagesRun.call(this,"array",firstPageData,secondPageData)}),test("array: paging children",function(){var firstPageData={items:[["Vasya",{items:[["s@s.com"]],next:"super url"}]]},secondPageData={items:[["n@n.com"]],next:"super url"},thirdPageData={items:[["f@f.com"]]};childrenPagesRun.call(this,"array",firstPageData,secondPageData,thirdPageData)}),test("array: paging children when include is defined in url",function(){var firstPageData={items:[["Vasya",{items:[["s@s.com"]],next:"super url?Include=[Owner[Id],Email]"}]]},secondPageData={items:[[[1],"n@n.com"]],next:"super url?include=[Email,notes[id, description]]"},thirdPageData={items:[["f@f.com",{items:[[1,"super 1"],[3,"super 2"]]}]]},result=childrenPagesRun.call(this,"array",firstPageData,secondPageData,thirdPageData);equals(result[0].contacts[0].email,"s@s.com"),equals(result[0].contacts[1].email,"n@n.com"),equals(result[0].contacts[1].owner.id,1),equals(result[0].contacts[2].email,"f@f.com"),equals(result[0].contacts[2].notes.length,2),equals(result[0].contacts[2].notes[0].id,1),equals(result[0].contacts[2].notes[1].id,3),equals(result[0].contacts[2].notes[0].description,"super 1"),equals(result[0].contacts[2].notes[1].description,"super 2")}),test("array: paging children refresh command",function(){var firstPageData={items:[["Vasya",{items:[["s@s.com"]],next:"super url"}]]},secondPageData={items:[["n@n.com"]],next:"super url"},thirdPageData={items:[["f@f.com"]]};childrenPagesRun.call(this,"array",firstPageData,secondPageData,thirdPageData,"refresh")}),test("json: paging children",function(){var firstPageData={items:[{name:"Vasya",contacts:{items:[{email:"s@s.com"}],next:"super url"}}]},secondPageData={items:[{email:"n@n.com"}],next:"super url"},thirdPageData={items:[{email:"f@f.com"}]};childrenPagesRun.call(this,"json",firstPageData,secondPageData,thirdPageData)}),test("json: paging children on save",function(){var firstPageData={items:[{name:"Vasya",contacts:{items:[{email:"s@s.com"}],next:"super url"}}]},secondPageData={items:[{email:"n@n.com"}],next:"super url"},thirdPageData={items:[{email:"f@f.com"}]};childrenPagesRun.call(this,"json",firstPageData,secondPageData,thirdPageData,"save")}),test("parse fields from include",function(){deepEqual(tauHeader.parseFieldsFromString("[A-Count,b,C]"),["a-count","b","c"]),deepEqual(tauHeader.parseFieldsFromString("[A[V-Count],b,C]"),[{a:["v-count"]},"b","c"]),deepEqual(tauHeader.parseFieldsFromString("[a,b,C]"),["a","b","c"]),deepEqual(tauHeader.parseFieldsFromString("[a[x],b[c]]"),[{a:["x"]},{b:["c"]}]),deepEqual(tauHeader.parseFieldsFromString("[a[x],b[c],a[z]]"),[{a:["x"]},{b:["c"]},{a:["z"]}]),deepEqual(tauHeader.parseFieldsFromString("[a,b,C[E],v]"),["a","b",{c:["e"]},"v"]),deepEqual(tauHeader.parseFieldsFromString("[c[e,f[m]]]"),[{c:["e",{f:["m"]}]}]),deepEqual(tauHeader.parseFieldsFromString("[a,b,C[E,f[m]],v[x]]"),["a","b",{c:["e",{f:["m"]}]},{v:["x"]}]),deepEqual(tauHeader.parseFieldsFromString("[C[E],C[B]]"),[{c:["e"]},{c:["b"]}])})};return{run:innerRun}})