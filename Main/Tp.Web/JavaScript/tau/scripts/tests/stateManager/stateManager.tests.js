define(["Underscore","tau/core/state.manager","tau/services/service.routing","tau/core/external"],function(_,a,b,c){var d=function(){module("[stateManager]",{setup:function(){var d=this;d.originalHash='board/5&component1={"collapsed":true}&component2={"a":1}&component3={"b":1}',d.external=new c({location:{hash:"#"+d.originalHash}}),d.service=new b({external:d.external}),d.stateManager=new a({service:d.service,state:d.external.hashParams()})},teardown:function(){delete this.originalHash,delete this.external,delete this.service,delete this.stateManager}}),test("should allow to get state of existing parameter",function(){var a=null;this.stateManager.get({id:"component1",fields:["collapsed"],callback:function(b){a=b}}),same(a,{collapsed:!0},"parameter value")}),test("should allow to get state of non-existing parameter",function(){var a=null;this.stateManager.get({id:"component77",fields:["x"],callback:function(b){a=b}}),same(a,{x:null},"parameter value")}),test("should allow to set state of existing parameter",function(){var a=null;this.stateManager.set({id:"component1",set:{collapsed:!1},callback:function(b){a=b}}),same(a,{collapsed:!1},"parameter value")}),test("should allow to set state of non-existing parameter",function(){var a=null;this.stateManager.set({id:"component77",set:{x:22},callback:function(b){a=b}}),same(a,{x:22},"parameter value")}),test("should propagate state changes",function(){var a=this;this.external.onHashChange(function(b){var c=b.hashParams();a.stateManager.update(c)});var b={},c={},d=function(a){b[a.paramId+"_"+a.fieldName]=a};a.stateManager.bind({paramId:"component1",fieldName:"collapsed",callback:d,listener:c}),a.stateManager.bind({paramId:"component2",fieldName:"a",callback:d,listener:c}),a.stateManager.bind({paramId:"component3",fieldName:"a",callback:d,listener:c}),a.stateManager.bind({paramId:"component3",fieldName:"b",callback:d,listener:c}),a.stateManager.bind({paramId:"component4",fieldName:"x",callback:d,listener:c}),this.external.setHash('board/5&component1={"collapsed":false}&component3={"a": 7}&component4={"x":5}'),this.external.triggerHashChange(),same(b.component1_collapsed,{paramId:"component1",fieldName:"collapsed",value:!1,delta:{curr:!1,prev:!0}},"should react on field value change"),same(b.component2_a,{paramId:"component2",fieldName:"a",value:null,delta:{curr:null,prev:1}},"should react on removing the whole parameter"),same(b.component3_a,{paramId:"component3",fieldName:"a",value:7,delta:{curr:7,prev:null}},"should react on adding new field"),same(b.component3_b,{paramId:"component3",fieldName:"b",value:null,delta:{curr:null,prev:1}},"should react on removing existing field"),same(b.component4_x,{paramId:"component4",fieldName:"x",value:5,delta:{curr:5,prev:null}},"should react on adding new parameter"),a.stateManager.unbind(c)})};return{run:d}})