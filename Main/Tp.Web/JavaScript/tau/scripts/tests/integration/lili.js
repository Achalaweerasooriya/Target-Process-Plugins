define(["jQuery","Underscore","tau/core/event","tau/core/repository","tau/services/service.rest","tau/store/store","tau/core/types.targetprocess","tau/configurator","tau/models/dataprocessor/model.processor.context"],function(a,b,c,d,e,f,g,h,i){function j(){var a=window.location.href.toLowerCase(),b=a.substr(0,a.indexOf("javascript")-1);h.setApplicationPath(b);var c=new e({appPath:b,path:b+"/api/v1"}),g=new d({service:c});return new f({proxy:g})}var k=j(),l={_currentScenario:null,scenarios:{},unique:function(a){return a+ +(new Date)+b.uniqueId(" lili ")},complete:function(){return this._currentScenario=null,this},createContext:function(){var a=l.getCurrentScenario();return a.commands.unshift({name:"createContextUsingPreviousCommand",config:{scenario:a}}),this},createContextUsingPreviousCommand:function(a,c,d,e){var f=d.result.data;b.extend(e,{context:{entity:{entityType:{name:f.__type},type:f.__type,id:f.id}}});var g=["id","acid","culture",{loggedUser:["id","email","isAdministrator"]},{processes:["id","name","terms","practices","customFields"]},{selectedProjects:["id","name",{process:["id","name"]}]}];k.get("context",{id:f.id,fields:g},{success:function(a){b.extend(e.context,{applicationContext:a.data}),e.context=i(e.context),c.success(a)},failure:function(a){c.failure(a)}}).done()},useComponent:function(a){var b=l.getCurrentScenario();return b.commands.unshift({name:"createComponent",config:{name:a}}),this},bringToLiveComponent:function(a){var b=l.getCurrentScenario();return b.commands.unshift({name:"initComponent",config:a}),this},sendMessage:function(a){var b=l.getCurrentScenario();return b.commands.unshift({name:"populateEventToComponent",config:a}),this},_listenBus:function(a,b,d){var e={bus:a.component},f=function(a){e.bus.removeAllListeners(e),b.success(a)},g=function(a){e.bus.removeAllListeners(e),b.failure(a)};e["bus "+d.success]=f,e["bus "+d.failure]=g,c.subscribeOn(e)},populateEventToComponent:function(a,c,d,e){this._listenBus(e,c,a),b.isObject(a.data)&&this._processConfig(a.data,e),e.component.fire(a.name,a.data)},initComponent:function(a,b,d,e){a=a||{};var f={bus:e.component,"bus beforeInit":function(a){e.componentConfig=a.data.config}},g=function(a){f.bus.removeAllListeners(f),e.$element=a.data.element,b.success({})};this.attachToStoreEvent("failure",b);var h=a.successEvent||"afterRender";f["bus "+h]=g,c.subscribeOn(f);try{f.bus.initialize(a)}catch(i){f.bus.removeAllListeners(f),b.failure(i)}},click:function(a){var b=l.getCurrentScenario();return b.commands.unshift({name:"clickOnElement",config:a}),this},attachToStoreEvent:function(a,b){var c={},d=h.getStore(),e=function(){d.unbind(c)},f=function(c){e(),b[a](c)};d.on({eventName:a,listener:c},f),d.on({eventName:"success",listener:c},e),d.on({eventName:"failure",listener:c},e)},clickOnElement:function(c,d,e,f){b.defaults(c,{success:"afterSave",failure:"saveFailed"}),this._listenBus(f,d,c),a(".drop-down-option:first",f.$element).click()},createComponent:function(a,c,d,e){var f={},g=this,h=function(a){g.removeAllListeners(f),c.failure(a.data)};g.on("requireFailure",h,f),g.attachToStoreEvent("failure",c);var i=a.name,j={};if(i.indexOf("$lili/")>=0){var k=i.replace("$lili/","");a=e.componentConfig;var l=b.jsonSelect(a,k);l.length>0&&(j=l[0],i=j.type)}require(["tau/components/component."+i],function(a){g.removeAllListeners(f);try{b.extend(j,{context:e.context}),e.component=a.create(j),c.success(a)}catch(d){c.failure(d)}})},getCurrentScenario:function(){return this._currentScenario===null?this.scenario(b.uniqueId("Scenario")):this._currentScenario},scenario:function(a){return this.scenarios.hasOwnProperty(a)&&(a=b.uniqueId(a+" ")),this._currentScenario={name:a,executed:!1,failed:!1,commands:[],failure:""},this.scenarios[a]=this._currentScenario,this},_pokeProgress:function(){var a=this,c=b(this.scenarios).values(),d=b.select(c,function(a){return a.executed}),e=b.select(c,function(a){return a.executed&&!a.failed}),f=b.select(c,function(a){return a.executed&&a.failed}),g={total:c.length,executed:d.length,success:e.length,failed:f.length,percent:0};g.total>0&&(g.percent=g.executed/g.total*100),a.fire("progress",g),d.length===c.length&&a.fire("completed",g)},markAsExecuted:function(a){var b=this;a.executed=!0,this._pokeProgress()},_processConfig:function(a,c){var d=this;b(b(a).keys()).each(function(e){var f=a[e];if(b.isString(f)&&f.indexOf("$lili/")==0){f=f.replace("$lili/","");var g=f.split("/"),h=g.shift(),i=g.join("/");b.each(c.commands,function(c){if(c.id===h){var d=c.result.data,f=b.jsonSelect(d,i);f.length>0&&(a[e]=f[0])}});return}b.isObject(f)&&d._processConfig(f,c)})},runCommand:function(a,c,d){var e=this,f=a.pop();if(!f){e.fire("success",c),e.markAsExecuted(c);return}var g={success:function(b){f.result=b[0],e.runCommand(a,c,f)},failure:function(a){f.result=b.isArray(a)?a[0]:a,c.failed=!0,e.fire("failure",c),e.markAsExecuted(c)}};try{if(e.hasOwnProperty(f.name)){e[f.name](f.config,g,d,c);return}e._processConfig(f.config||{},c),k[f.name](f.type,f.config).done(g)}catch(h){g.failure(h)}},_processLiliConfig:function(a){a=a||{};var c=this;b.defaults(a,{filter:""}),a.filter&&b.each(b(c.scenarios).keys(),function(b){b.toLowerCase().indexOf(a.filter.toLowerCase())<0&&delete c.scenarios[b]})},_executeScenario:function(a){var b=this;b.fire("executing",a),b.runCommand([].concat(a.commands),a)},execute:function(a){var c=this;c._processLiliConfig(a),c._pokeProgress(),b.each(b(c.scenarios).values(),function(a){c._executeScenario(a)})},executeStepByStep:function(a){var c=this;c._processLiliConfig(a);var d=b(c.scenarios).keys(),e=function(){var a=d.pop();a&&c._executeScenario(c.scenarios[a])};c.on("progress",e),c._pokeProgress()}};return b(b(g.getDictionary()).keys()).each(function(a){l[a]=function(){return{_pushCommand:function(c,d,e){e||(e=b.uniqueId("lili_command_")),l.getCurrentScenario().commands.unshift({id:e,name:c,type:a,config:d})},save:function(a,b){return this._pushCommand("save",a,b),l},remove:function(a){return this._pushCommand("remove",a),l},refresh:function(a){return this._pushCommand("refresh",a),l},get:function(a){return this._pushCommand("get",a),l}}}}),c.implementOn(l),require.onError=function(a){throw l.fire("requireFailure",a),"File failed to be loaded:"+a.message},l})