define(["jQuery","Underscore","tau/core/event","tau/store/repository","tau/store/services/service.rest","tau/store/store","tau/store/types.targetprocess","tau/configurator","tau/models/dataprocessor/model.processor.context"],function($,_,a,b,c,d,e,f,g){function h(){var a=window.location.href.toLowerCase(),e=a.substr(0,a.indexOf("javascript")-1);f.setApplicationPath(e);var g=new c({appPath:e,path:e+"/api/v1"}),h=new b({service:g});return new d({proxy:h})}var i=h(),j={_currentScenario:null,scenarios:{},unique:function(a){return a+ +(new Date)+_.uniqueId(" lili ")},complete:function(){return this._currentScenario=null,this},createContext:function(){var a=j.getCurrentScenario();return a.commands.unshift({name:"createContextUsingPreviousCommand",config:{scenario:a}}),this},createContextUsingPreviousCommand:function(a,b,c,d){var e=c.result.data;_.extend(d,{context:{entity:{entityType:{name:e.__type},type:e.__type,id:e.id}}});var f=["id","acid","culture",{loggedUser:["id","email","isAdministrator"]},{processes:["id","name","terms","practices","customFields"]},{selectedProjects:["id","name",{process:["id","name"]}]}];i.get("context",{id:e.id,fields:f},{success:function(a){_.extend(d.context,{applicationContext:a.data}),d.context=g(d.context),b.success(a)},failure:function(a){b.failure(a)}}).done()},useComponent:function(a){var b=j.getCurrentScenario();return b.commands.unshift({name:"createComponent",config:{name:a}}),this},bringToLiveComponent:function(a){var b=j.getCurrentScenario();return b.commands.unshift({name:"initComponent",config:a}),this},sendMessage:function(a){var b=j.getCurrentScenario();return b.commands.unshift({name:"populateEventToComponent",config:a}),this},_listenBus:function(b,c,d){var e={bus:b.component},f=function(a){e.bus.removeAllListeners(e),c.success(a)},g=function(a){e.bus.removeAllListeners(e),c.failure(a)};e["bus "+d.success]=f,e["bus "+d.failure]=g,a.subscribeOn(e)},populateEventToComponent:function(a,b,c,d){this._listenBus(d,b,a),_.isObject(a.data)&&this._processConfig(a.data,d),d.component.fire(a.name,a.data)},initComponent:function(b,c,d,e){b=b||{};var f={bus:e.component,"bus beforeInit":function(a){e.componentConfig=a.data.config}},g=function(a){f.bus.removeAllListeners(f),e.$element=a.data.element,c.success({})};this.attachToStoreEvent("failure",c);var h=b.successEvent||"afterRender";f["bus "+h]=g,a.subscribeOn(f);try{f.bus.initialize(b)}catch(i){f.bus.removeAllListeners(f),c.failure(i)}},click:function(a){var b=j.getCurrentScenario();return b.commands.unshift({name:"clickOnElement",config:a}),this},attachToStoreEvent:function(a,b){var c={},d=f.getStore(),e=function(){d.unbind(c)},g=function(c){e(),b[a](c)};d.on({eventName:a,listener:c},g),d.on({eventName:"success",listener:c},e),d.on({eventName:"failure",listener:c},e)},clickOnElement:function(a,b,c,d){_.defaults(a,{success:"afterSave",failure:"saveFailed"}),this._listenBus(d,b,a),$(".drop-down-option:first",d.$element).click()},createComponent:function(a,b,c,d){var e={},f=this,g=function(a){f.removeAllListeners(e),b.failure(a.data)};f.on("requireFailure",g,e),f.attachToStoreEvent("failure",b);var h=a.name,i={};if(h.indexOf("$lili/")>=0){var j=h.replace("$lili/","");a=d.componentConfig;var k=_.jsonSelect(a,j);k.length>0&&(i=k[0],h=i.type)}require(["tau/components/component."+h],function(a){f.removeAllListeners(e);try{_.extend(i,{context:d.context}),d.component=a.create(i),b.success(a)}catch(c){b.failure(c)}})},getCurrentScenario:function(){return this._currentScenario===null?this.scenario(_.uniqueId("Scenario")):this._currentScenario},scenario:function(a){return this.scenarios.hasOwnProperty(a)&&(a=_.uniqueId(a+" ")),this._currentScenario={name:a,executed:!1,failed:!1,commands:[],failure:""},this.scenarios[a]=this._currentScenario,this},_pokeProgress:function(){var a=this,b=_(this.scenarios).values(),c=_.select(b,function(a){return a.executed}),d=_.select(b,function(a){return a.executed&&!a.failed}),e=_.select(b,function(a){return a.executed&&a.failed}),f={total:b.length,executed:c.length,success:d.length,failed:e.length,percent:0};f.total>0&&(f.percent=f.executed/f.total*100),a.fire("progress",f),c.length===b.length&&a.fire("completed",f)},markAsExecuted:function(a){var b=this;a.executed=!0,this._pokeProgress()},_processConfig:function(a,b){var c=this;_(_(a).keys()).each(function(d){var e=a[d];if(_.isString(e)&&e.indexOf("$lili/")==0){e=e.replace("$lili/","");var f=e.split("/"),g=f.shift(),h=f.join("/");_.each(b.commands,function(b){if(b.id===g){var c=b.result.data,e=_.jsonSelect(c,h);e.length>0&&(a[d]=e[0])}});return}_.isObject(e)&&c._processConfig(e,b)})},runCommand:function(a,b,c){var d=this,e=a.pop();if(!e){d.fire("success",b),d.markAsExecuted(b);return}var f={success:function(c){e.result=c[0],d.runCommand(a,b,e)},failure:function(a){e.result=_.isArray(a)?a[0]:a,b.failed=!0,d.fire("failure",b),d.markAsExecuted(b)}};try{if(d.hasOwnProperty(e.name)){d[e.name](e.config,f,c,b);return}d._processConfig(e.config||{},b),i[e.name](e.type,e.config).done(f)}catch(g){f.failure(g)}},_processLiliConfig:function(a){a=a||{};var b=this;_.defaults(a,{filter:""}),a.filter&&_.each(_(b.scenarios).keys(),function(c){c.toLowerCase().indexOf(a.filter.toLowerCase())<0&&delete b.scenarios[c]})},_executeScenario:function(a){var b=this;b.fire("executing",a),b.runCommand([].concat(a.commands),a)},execute:function(a){var b=this;b._processLiliConfig(a),b._pokeProgress(),_.each(_(b.scenarios).values(),function(a){b._executeScenario(a)})},executeStepByStep:function(a){var b=this;b._processLiliConfig(a);var c=_(b.scenarios).keys(),d=function(){var a=c.pop();a&&b._executeScenario(b.scenarios[a])};b.on("progress",d),b._pokeProgress()}};return _(_(e.getDictionary()).keys()).each(function(a){j[a]=function(){return{_pushCommand:function(b,c,d){d||(d=_.uniqueId("lili_command_")),j.getCurrentScenario().commands.unshift({id:d,name:b,type:a,config:c})},save:function(a,b){return this._pushCommand("save",a,b),j},remove:function(a){return this._pushCommand("remove",a),j},refresh:function(a){return this._pushCommand("refresh",a),j},get:function(a){return this._pushCommand("get",a),j}}}}),a.implementOn(j),require.onError=function(a){throw j.fire("requireFailure",a),"File failed to be loaded:"+a.message},j})