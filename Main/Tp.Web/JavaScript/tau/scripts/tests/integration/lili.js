define(["jQuery","Underscore","app.path","tau/core/event","tau/store/repository","tau/store/services/service.rest","tau/store/store","tau/store/types.targetprocess","tau/configurator","tau/models/dataprocessor/model.processor.context"],function($,_,AppPath,event,repository,serviceRest,Store,types,conf,fnCtx){function getStore(){var path=AppPath.get(),restApi=new serviceRest({appPath:path,path:path+"/api/v1"}),repInstance=new repository({service:restApi});return new Store({proxy:repInstance})}var store=getStore(),lili={_currentScenario:null,scenarios:{},unique:function(prefix){return prefix+ +(new Date)+_.uniqueId(" lili ")},complete:function(){return this._currentScenario=null,this},createContext:function(){var currentScenario=lili.getCurrentScenario();return currentScenario.commands.unshift({name:"createContextUsingPreviousCommand",config:{scenario:currentScenario}}),this},createContextUsingPreviousCommand:function(config,callbacks,cmd,scenario){var entity=cmd.result.data;_.extend(scenario,{context:{entity:{entityType:{name:entity.__type},type:entity.__type,id:entity.id}}});var fields=["id","acid","culture",{loggedUser:["id","email","isAdministrator"]},{processes:["id","name","terms","practices","customFields"]},{selectedProjects:["id","name",{process:["id","name"]}]}];store.get("context",{id:entity.id,fields:fields},{success:function(r){_.extend(scenario.context,{applicationContext:r.data}),scenario.context=fnCtx(scenario.context),callbacks.success(r)},failure:function(r){callbacks.failure(r)}}).done()},useComponent:function(componentName){var currentScenario=lili.getCurrentScenario();return currentScenario.commands.unshift({name:"createComponent",config:{name:componentName}}),this},bringToLiveComponent:function(config){var currentScenario=lili.getCurrentScenario();return currentScenario.commands.unshift({name:"initComponent",config:config}),this},sendMessage:function(config){var currentScenario=lili.getCurrentScenario();return currentScenario.commands.unshift({name:"populateEventToComponent",config:config}),this},_listenBus:function(scenario,callbacks,config){var listener={bus:scenario.component},successFn=function(r){listener.bus.removeAllListeners(listener),callbacks.success(r)},failureFn=function(r){listener.bus.removeAllListeners(listener),callbacks.failure(r)};listener["bus "+config.success]=successFn,listener["bus "+config.failure]=failureFn,event.subscribeOn(listener)},populateEventToComponent:function(config,callbacks,cmd,scenario){this._listenBus(scenario,callbacks,config),_.isObject(config.data)&&this._processConfig(config.data,scenario),scenario.component.fire(config.name,config.data)},initComponent:function(config,callbacks,cmd,scenario){config=config||{};var listener={bus:scenario.component,"bus beforeInit":function(evt){scenario.componentConfig=evt.data.config}},successFn=function(evt){listener.bus.removeAllListeners(listener),scenario.$element=evt.data.element,callbacks.success({})};this.attachToStoreEvent("failure",callbacks);var success=config.successEvent||"afterRender";listener["bus "+success]=successFn,event.subscribeOn(listener);try{listener.bus.initialize(config)}catch(ex){listener.bus.removeAllListeners(listener),callbacks.failure(ex)}},click:function(config){var currentScenario=lili.getCurrentScenario();return currentScenario.commands.unshift({name:"clickOnElement",config:config}),this},attachToStoreEvent:function(eventName,callbacks){var listener={},storeInst=conf.getStore(),unbind=function(){storeInst.unbind(listener)},fnCallback=function(r){unbind(),callbacks[eventName](r)};storeInst.on({eventName:eventName,listener:listener},fnCallback),storeInst.on({eventName:"success",listener:listener},unbind),storeInst.on({eventName:"failure",listener:listener},unbind)},clickOnElement:function(config,callbacks,cmd,scenario){_.defaults(config,{success:"afterSave",failure:"saveFailed"}),this._listenBus(scenario,callbacks,config),$(".drop-down-option:first",scenario.$element).click()},createComponent:function(config,callbacks,cmd,scenario){var listener={},self=this,failure=function(evt){self.removeAllListeners(listener),callbacks.failure(evt.data)};self.on("requireFailure",failure,listener),self.attachToStoreEvent("failure",callbacks);var name=config.name,componentConfig={};if(name.indexOf("$lili/")>=0){var path=name.replace("$lili/","");config=scenario.componentConfig;var arr=_.jsonSelect(config,path);arr.length>0&&(componentConfig=arr[0],name=componentConfig.type)}require(["tau/components/component."+name],function(c){self.removeAllListeners(listener);try{_.extend(componentConfig,{context:scenario.context}),scenario.component=c.create(componentConfig),callbacks.success(c)}catch(ex){callbacks.failure(ex)}})},getCurrentScenario:function(){return this._currentScenario===null?this.scenario(_.uniqueId("Scenario")):this._currentScenario},scenario:function(name){return this.scenarios.hasOwnProperty(name)&&(name=_.uniqueId(name+" ")),this._currentScenario={name:name,executed:!1,failed:!1,commands:[],failure:""},this.scenarios[name]=this._currentScenario,this},_pokeProgress:function(){var self=this,values=_(this.scenarios).values(),executed=_.select(values,function(v){return v.executed}),success=_.select(values,function(v){return v.executed&&!v.failed}),failed=_.select(values,function(v){return v.executed&&v.failed}),data={total:values.length,executed:executed.length,success:success.length,failed:failed.length,percent:0};data.total>0&&(data.percent=data.executed/data.total*100),self.fire("progress",data),executed.length===values.length&&self.fire("completed",data)},markAsExecuted:function(scenario){var self=this;scenario.executed=!0,this._pokeProgress()},_processConfig:function(obj,scenario){var self=this;_(_(obj).keys()).each(function(key){var value=obj[key];if(_.isString(value)&&value.indexOf("$lili/")==0){value=value.replace("$lili/","");var parts=value.split("/"),commandId=parts.shift(),jsonPath=parts.join("/");_.each(scenario.commands,function(command){if(command.id===commandId){var jsonObject=command.result.data,arr=_.jsonSelect(jsonObject,jsonPath);arr.length>0&&(obj[key]=arr[0])}});return}_.isObject(value)&&self._processConfig(value,scenario)})},runCommand:function(commands,scenario,previousCommand){var self=this,command=commands.pop();if(!command){self.fire("success",scenario),self.markAsExecuted(scenario);return}var callbacks={success:function(r){command.result=r[0],self.runCommand(commands,scenario,command)},failure:function(r){command.result=_.isArray(r)?r[0]:r,scenario.failed=!0,self.fire("failure",scenario),self.markAsExecuted(scenario)}};try{if(self.hasOwnProperty(command.name)){self[command.name](command.config,callbacks,previousCommand,scenario);return}self._processConfig(command.config||{},scenario),store[command.name](command.type,command.config).done(callbacks)}catch(ex){callbacks.failure(ex)}},_processLiliConfig:function(config){config=config||{};var self=this;_.defaults(config,{filter:""}),config.filter&&_.each(_(self.scenarios).keys(),function(name){name.toLowerCase().indexOf(config.filter.toLowerCase())<0&&delete self.scenarios[name]})},_executeScenario:function(scenario){var self=this;self.fire("executing",scenario),self.runCommand([].concat(scenario.commands),scenario)},execute:function(config){var self=this;self._processLiliConfig(config),self._pokeProgress(),_.each(_(self.scenarios).values(),function(s){self._executeScenario(s)})},executeStepByStep:function(config){var self=this;self._processLiliConfig(config);var queue=_(self.scenarios).keys(),processNext=function(){var name=queue.pop();name&&self._executeScenario(self.scenarios[name])};self.on("progress",processNext),self._pokeProgress()}};return _(_(types.getDictionary()).keys()).each(function(t){lili[t]=function(){return{_pushCommand:function(name,config,id){id||(id=_.uniqueId("lili_command_")),lili.getCurrentScenario().commands.unshift({id:id,name:name,type:t,config:config})},save:function(config,id){return this._pushCommand("save",config,id),lili},remove:function(config){return this._pushCommand("remove",config),lili},refresh:function(config){return this._pushCommand("refresh",config),lili},get:function(config){return this._pushCommand("get",config),lili}}}}),event.implementOn(lili),require.onError=function(ex){throw lili.fire("requireFailure",ex),"File failed to be loaded:"+ex.message},lili})