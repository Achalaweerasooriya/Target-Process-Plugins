define(["Underscore","tests/common/service.mock","tau/components/component.list","tests/common/datapoint/test.common.datapoint","tests/common/applicationContext","tests/components/common/common.setup","tests/components/component.specs","tests/common/checker","tau/models/dataProviders/model.provider.items.tasks_bugs","tau/models/dataProviders/model.provider.groups.tasks_bugs","tau/configurator","tau/models/dataprocessor/model.processor.context","tau/ui/templates/list_/grid.entity/ui.template.list.grid.entity"],function(_,a,b,c,d,e,f,g,h,i,j,k){var l=function(){var g=new d,l=c.projects(),m=c.entityStates(),n=c.bugs(),o=c.tasks(),p={id:15,__type:"userStory",tasks:_(o).filter(function(a){return a.id==31||a.id==33}),bugs:_(n).filter(function(a){return a.id==41||a.id==665})},q=[p].concat(m).concat(l),r={context:{type:"story",id:15}},s=function(){var b=this.service=new a;j.setService(b),j.getProxy().markRecordSetAsCompleteLoaded("project"),j.getProxy().markRecordSetAsCompleteLoaded("entityState"),j.getProxy().markRecordSetAsCompleteLoaded("priority"),j.getProxy().markRecordSetAsCompleteLoaded("severity"),j.getRouting().setStateParameter("list",null)},t=[{preSetup:s,name:"should render valid markup view",test:function(){var a=this.data,b=this.$el,c=b.find("[role=group]");equals(c.length,5,"Groups amount");for(var d=0;d<c.length;d++){var e=c.eq(d);equals(e.find("[role=title]").text(),a.groups[d].title,"Group title"),equals(e.find("[role=counter]").text(),a.groups[d].items.length,"Group counter")}var f=b.find("[role=list-inner]");for(var g=0;g<f.length;g++){var h=f.eq(g),i=h.find("> tr");for(var j=0;j<i.length;j++){var k=i.eq(j).find("td"),l=a.groups[g].items[j];equals(k.length,7,"Amount of row cells"),equals(k.eq(1).text(),l.id,"ID Data column");var m=k.eq(2).find("span").eq(0);equals(m.text(),l.name,"Name Data column");if(l.tags.length){var n=k.eq(2).find("span").eq(1);equals(n.text(),l.tags[0],"Tag Data column")}l.__type==="bug"?equals(k.eq(3).text(),l.severity.name.toString(),"Severity Data column"):l.__type==="task"&&equals(k.eq(3).text(),"","Priority Data column");var o=l.effort.estimated+"&nbsp;"+l.effort.unit.shortName,p=k.eq(4).find("span:first").html();equals(p,o,"Estimated effort"),l.effort.percentFromMaximum>0?(ok(k.eq(5).find(".ui-progressbar__progress").attr("style").match(new RegExp("width:\\s*"+l.effort.percentFromMaximum+"%")),"Column progress width"),ok(k.eq(5).find(".ui-progressbar__progress__indicator").attr("style").match(new RegExp("width:\\s*"+l.effort.percentComplete+"%")),"Column progress width")):equals(k.eq(5).find(".ui-progressbar__progress").size(),0,"Progress bar should not be shown"),equals(k.eq(6).find(".ui-assignment__group").length,l.assignments.groups.length,"Assignments items");var q=k.eq(6).find(".ui-assignment__group");_.forEach(l.assignments.groups,function(a,b){var c=q.eq(b);equals(c.find(".ui-assignment__group__title").text(),a.role.name,"Group title");var d=c.find(".ui-assignment__user");equals(d.length,a.users.length,"Group users length"),_.forEach(a.users,function(b,c){var e=d.eq(c),b=a.users[c];equals(e.find("img").attr("src"),"/TP/Avatar.ashx?UserId="+b.id+"&size=24","User avatar"),equals(e.find("img").prop("title"),b.name,"User name")})})}}}},{name:"should save state",preSetup:s,test:function(){var a=this.data,b=this.$el,c={},d=j.getRouting();d.on("stateChanged",function(a){c[a.data.name]=a.data.value}),b.find(".tau-list__group__collapse:first").click(),same(c,{list:{"Open,Backlog":!0}}),ok(b.find(".tau-list__group__collapse:first").eq(1).hasClass("tau-list__group__collapse_collapsed_true")===!1,"state is initial")}},{name:"should allow to prioritize",preSetup:s,test:function(){var a=this.$el,b=a.find("[role=group]:first"),c=b.find("[role=item]:first"),d=c.next();this.service.registerSaveCommand({config:{id:31,$set:{beforeId:undefined,afterId:undefined},fields:["id"]},returnedData:{id:31}}),this.service.registerGetCommand({config:{id:31,fields:["id","numericPriority"]},returnedData:{id:31,numericPriority:34}}),b.triggerHandler("sortstart",{item:c});var e=a.find(".tau-list__group_available_true[role=group]");equals(e.length,2,"Available groups");var f=a.find(".tau-list__group_available_false[role=group]");equals(f.length,3,"Unvailable groups"),c.insertAfter(d),b.triggerHandler("sortupdate",{item:c}),b.triggerHandler("sortstop"),a=this.$el,e=a.find(".tau-list__group_available_true[role=group]"),equals(e.length,5,"Available groups are default"),f=a.find(".tau-list__group_available_false[role=group]"),equals(f.length,0,"Unavailable groups are switched off")}},{name:"should use available next states for groups",preSetup:s,test:function(){var a=this.$el,b=a.find("[role=group]:eq(1)"),c=b.find("[role=item]:first");b.triggerHandler("sortstart",{item:c});var d=a.find(".tau-list__group_available_true[role=group]");equals(d.length,3,"Available groups use next states")}},{name:"should allow to change group",preSetup:s,test:function(){var a=this.$el,b=a.find("[role=group]:first"),c=a.find("[role=group]").eq(4);c.find(".tau-list__group__collapse").click(),equals(b.find("[role=counter]").text(),1,"Count started"),equals(c.find("[role=counter]").text(),1,"Count started");var d=b.find("[role=item]:first"),e=c.find("[role=item]:first");this.service.registerSaveCommand({config:{id:31,$set:{beforeId:undefined,afterId:33},fields:["id"]},returnedData:{id:31}}),this.service.registerGetCommand({config:{id:31,fields:["id","numericPriority"]},returnedData:{id:31,numericPriority:34}}),this.service.registerSaveCommand({config:{id:31,$set:{entityState:{id:4}},fields:["id",{entityState:["id","name","isFinal"]}]},returnedData:{id:31,entityState:{id:4,name:"Done",isFinal:!0}}}),this.service.registerGetCommand({config:{id:31,fields:["id",{entityState:["id","name","isFinal"]}]},returnedData:{id:31,entityState:{id:4,name:"Done",isFinal:!0}}}),equals(d.hasClass("tau-list__table__row_isfinalstate_true"),!1,"Highlight not changed"),b.triggerHandler("sortstart",{item:d}),d.insertAfter(e),b.triggerHandler("sortupdate",{item:d}),b.triggerHandler("sortstop"),a=this.$el,b=a.find("[role=group]:first"),c=a.find("[role=group]").eq(4);var d=b.find("[role=item]:first"),e=c.find("[role=item]:first");equals(b.find("[role=counter]").text(),0,"Count changed"),equals(c.find("[role=counter]").text(),2,"Count changed"),equals(c.find(".tau-list__table__row_isfinalstate_true").length,2,"Highlight changed"),equals(c.find("[role=item]").eq(0).find("td").eq(1).text(),33,"Order correct"),equals(c.find("[role=item]").eq(1).find("td").eq(1).text(),31,"Order correct")}},{name:"should allow to change group but no priority in closed group",preSetup:s,test:function(){var a=this.$el,b=a.find("[role=group]:first"),c=a.find("[role=group]").eq(4);equals(b.find("[role=counter]").text(),1,"Count started"),equals(c.find("[role=counter]").text(),1,"Count started");var d=b.find("[role=item]:first"),e=c.find("[role=item]:first");this.service.registerSaveCommand({config:{id:31,$set:{entityState:{id:4}},fields:["id",{entityState:["id","name","isFinal"]}]},returnedData:{id:31,entityState:{id:4,name:"Done",isFinal:!0}}}),equals(d.hasClass("tau-list__table__row_isfinalstate_true"),!1,"Highlight not changed"),b.triggerHandler("sortstart",{item:d}),d.insertAfter(e),b.triggerHandler("sortupdate",{item:d}),b.triggerHandler("sortstop"),a=this.$el,b=a.find("[role=group]:first"),c=a.find("[role=group]").eq(4),equals(b.find("[role=counter]").text(),0,"Count changed"),equals(c.find("[role=counter]").text(),2,"Count changed"),equals(c.find("[role=item]").eq(0).find("td").eq(1).text(),31,"Order correct depends on non-changed priority"),equals(c.find("[role=item]").eq(1).find("td").eq(1).text(),33,"Order correct depends on non-changed priority"),equals(a.find(".i-target").length,0,"No highlight")}},{name:"should allow to change group and ask to add comment",preSetup:s,test:function(){var a=this.$el,b=a.find("[role=group]").eq(1),c=a.find("[role=group]").eq(3),d=b.find("[role=item]:first"),e=c.find("[role=item]:first");b.triggerHandler("sortstart",{item:d}),d.insertAfter(e),b.triggerHandler("sortupdate",{item:d});var f=d.tauBubble("widget");equals(f.length,1,"Show popup"),ok(this.$el===a,"don refresh"),f.find(":button:eq(1)").click(),ok(this.$el!==a,"refresh"),a=this.$el,b=a.find("[role=group]").eq(1),c=a.find("[role=group]").eq(3),d=b.find("[role=item]:first"),e=c.find("[role=item]:first"),this.service.registerSaveCommand({config:{$set:{description:"fuck you",general:{id:41}},$include:["id","description","createDate","parentId",{owner:["id","firstName","lastName"]}],fields:["id"]},returnedData:{id:1}}),this.service.registerSaveCommand({config:{id:41,$set:{beforeId:undefined,afterId:665},fields:["id"]},returnedData:{id:41}}),this.service.registerGetCommand({config:{id:41,fields:["id","numericPriority"]},returnedData:{id:41,numericPriority:667}}),this.service.registerSaveCommand({config:{id:41,$set:{entityState:{id:44}},fields:["id",{entityState:["id","name","isFinal"]}]},returnedData:{id:41,entityState:{id:44,name:"In Testing",isFinal:!1}}}),b.triggerHandler("sortstart",{item:d}),d.insertAfter(e),b.triggerHandler("sortupdate",{item:d}),f=d.tauBubble("widget"),equals(f.length,1,"Show popup"),equals(f.find("textarea").length,1,"Popup correct"),f.find("textarea").val("fuck you"),f.find("button:eq(0)").click(),ok(d.parents("[role=group]:first")[0]===c[0],"Regroup"),this.service.verify()}}],u={context:{applicationContext:g},itemsDataProvider:h,groupsDataProvider:i,groupBy:"entityState.name",orderBy:["entityState.id"],views:[{type:"grid.entity",group:{dataIndex:"name"}}]};k(u.context);var v=e.create("[component.list][tasks_bugs]",q,b,u);f.create(v,r).viewShouldFollowDataComponentLifeCycle(s).viewShouldPassTests(t).done()};return{run:l}})