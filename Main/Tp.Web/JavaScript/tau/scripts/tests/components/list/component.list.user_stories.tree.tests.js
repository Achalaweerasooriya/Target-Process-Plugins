define(["Underscore","tau/components/component.list","tests/common/testData","tests/common/applicationContext","tests/components/common/common.setup","tests/components/component.specs","tests/common/checker","tau/models/dataProviders/model.provider.items.user_stories","tau/models/dataProviders/model.provider.groups.user_stories","tau/ui/templates/list_/grid.entity/ui.template.list.grid.entity"],function(_,listComponent,testData,AppCtx,commonSetup,componentSpecs,checker,ItemsDataProvider,GroupsDataProvider){var innerRun=function(){function createExpectedItemsCommand(entityType,entityId,collectionName){var config={id:entityId,nested:!0,fields:["id"]},coll={};coll[collectionName]=["id","name","tags",Similar.to({priority:["id","name"]}),"effort","effortCompleted","effortToDo","timeSpent","timeRemain",Similar.to({entityState:["id","name","isinitial","isfinal"]}),Similar.to({roleEfforts:["id",Like.is({role:["id","name"]})]}),Similar.to({assignments:["id",Like.is({role:["id"]}),Similar.to({generalUser:["id","firstName","lastName"]})]})],config.fields.push(Similar.to(coll));var command=Similar.to({name:"get",type:entityType,config:Similar.to(config)});return command}function createExpectedStatesCommand(){var process=appContext.processes[0],config={id:process.id,fields:["id",Similar.to({entityStates:["id","name","isinitial","isfinal","isplanned",Similar.to({entityType:["id","name"]})]})]},command=Similar.to({name:"get",type:"process",config:Similar.to(config)});return command}var appContext=new AppCtx,data=testData.registerTestDataForUserStoriesListModel(),testProcess=testData.getStatesForProcess(),items=data.userStories,entity=data.data,context={context:{type:"feature",id:15}},expectedData={items:[],groups:[{key:"Open",items:[{id:1,name:"US1",__type:"userStory",entityState:{id:1,name:"Open",isInitial:!0,isFinal:!1},tags:["us1","epic"],priority:{id:1,name:"Low"},effort:{estimated:56,spent:8,remain:48,total:56,percentComplete:14,percentFromMaximum:100,timeSpent:9,timeRemain:41,unit:{name:"Hour",shortName:"h"}},assignments:{groups:[{role:{id:1,name:"Dev."},users:[{id:1,name:"Vasili I.",assignmentId:309,avatarUrl:"/TP/Avatar.ashx?UserId=1&size=24"},{id:2,name:"Ivan V.",assignmentId:310,avatarUrl:"/TP/Avatar.ashx?UserId=2&size=24"}]}]}}],collapsed:!1,title:"Open"},{key:"Done",items:[],collapsed:!1,title:"Done"},{key:"In Progress",items:[{id:3,name:"US3",__type:"userStory",entityState:{id:23,name:"In Progress",isInitial:!1,isFinal:!1},tags:["us3","wow"],priority:{id:1,name:"Low"},effort:{estimated:16,spent:8,remain:8,total:16,percentComplete:50,percentFromMaximum:29,timeSpent:5,timeRemain:7,unit:{name:"Hour",shortName:"h"}},assignments:{groups:[{role:{id:1,name:"Dev."},users:[]}]}}],collapsed:!1,title:"In Progress"},{key:"Closed",items:[{id:2,name:"US2",__type:"userStory",entityState:{id:24,name:"Closed",isInitial:!1,isFinal:!0},tags:[],priority:{id:1,name:"Low"},effort:{estimated:12,spent:6,remain:6,total:12,percentComplete:50,percentFromMaximum:21,timeSpent:3,timeRemain:18,unit:{name:"Hour",shortName:"h"}},assignments:{groups:[{role:{id:1,name:"Dev."},users:[{id:1,name:"Vasili I.",assignmentId:309,avatarUrl:"/TP/Avatar.ashx?UserId=1&size=24"},{id:2,name:"Ivan V.",assignmentId:310,avatarUrl:"/TP/Avatar.ashx?UserId=2&size=24"}]}]}}],collapsed:!0,title:"Closed"}],config:{views:[{type:"grid.entity",group:{dataIndex:"name"}}],currentView:{type:"grid.entity",group:{dataIndex:"name"}}}},expectedItemsCommand=createExpectedItemsCommand("feature",15,"userStories"),expectedStatesCommand=createExpectedStatesCommand(),viewTests=[{name:"should render valid markup view",test:function(){var data=this.data,$el=this.$el,$groups=$el.find("[role=group]");equals($groups.length,4,"Groups amount");for(var g=0;g<$groups.length;g++){var $groupTitle=$groups.eq(g);equals($groupTitle.find("[role=title]").text(),data.groups[g].title,"Group title"),equals($groupTitle.find("[role=counter]").text(),data.groups[g].items.length,"Group counter")}var $itemsGroups=$el.find("[role=list-inner]");for(var i=0;i<$itemsGroups.length;i++){var $group=$itemsGroups.eq(i),$trs=$group.find("> tr");for(var j=0;j<$trs.length;j++){var $tds=$trs.eq(j).find("td"),item=data.groups[i].items[j];equals($tds.length,7,"Amount of row cells"),equals($tds.eq(1).text(),item.id,"ID Data column");var $nameTd=$tds.eq(2).find("span").eq(0);equals($nameTd.text(),item.name,"Name Data column");if(item.tags.length){var $tagsTd=$tds.eq(2).find("span").eq(1);equals($tagsTd.text(),item.tags[0],"Tag Data column")}equals($tds.eq(3).text(),item.priority.name.toString(),"Priority Data column"),equals($tds.eq(4).find("span:first").html(),item.effort.estimated+"&nbsp;"+item.effort.unit.shortName,"Estimated Effort Data column"),ok($tds.eq(5).find(".ui-progressbar__progress").attr("style").match(new RegExp("width:\\s*"+item.effort.percentFromMaximum+"%")),"Column progress width"),ok($tds.eq(5).find(".ui-progressbar__progress__indicator").attr("style").match(new RegExp("width:\\s*"+item.effort.percentComplete+"%")),"Column progress width"),equals($tds.eq(6).find(".ui-assignment__group").length,item.assignments.groups.length,"Assignments items");var $assignmentGroups=$tds.eq(6).find(".ui-assignment__group");_.forEach(item.assignments.groups,function(group,k){var $group=$assignmentGroups.eq(k);equals($group.find(".ui-assignment__group__title").text(),group.role.name,"Group title");var $assignmentUsers=$group.find(".ui-assignment__user");equals($assignmentUsers.length,group.users.length,"Group users length"),_.forEach(group.users,function(user,m){var $user=$assignmentUsers.eq(m),user=group.users[m];equals($user.find("img").attr("src"),"/TP/Avatar.ashx?UserId="+user.id+"&size=24","User avatar"),equals($user.find("img").prop("title"),user.name,"User name")})})}}}}],componentConfig={context:{applicationContext:appContext},itemsDataProvider:ItemsDataProvider,groupsDataProvider:GroupsDataProvider,groupBy:"entityState.name",views:[{type:"grid.entity",group:{dataIndex:"name"}}]},setup=commonSetup.create("[component.list][user_stories_tree]",[entity,testProcess],listComponent,componentConfig);componentSpecs.create(setup,context).viewShouldFollowDataComponentLifeCycle().modelShouldReturnData(expectedData,[[expectedStatesCommand],[expectedItemsCommand],[expectedItemsCommand],[expectedItemsCommand],[expectedItemsCommand]]).viewShouldPassTests(viewTests).done()};return{run:innerRun}})