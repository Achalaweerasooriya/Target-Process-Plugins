define(["tau/components/component.list","tests/common/testData","tests/components/common/common.setup","tests/components/component.specs","tests/common/checker","tau/models/dataProviders/model.provider.items.bugs_tasks","tau/models/dataProviders/model.provider.groups.bugs_tasks","tau/ui/templates/list_/grid/ui.template.list.grid"],function(listComponent,testData,commonSetup,componentSpecs,checker,BugsTasksDataProvider){var innerRun=function(){function createExpectedTaskBugDetailCommand(entityType,entityId,collectionName){var config={id:entityId,nested:!0,fields:["id"]},coll={};coll[collectionName]=["id","name","effort",Similar.to({entityState:["id","name","isinitial","isfinal"]}),Similar.to({roleEfforts:["id",Like.is({role:["id","name"]})]}),Similar.to({assignments:["id",Like.is({role:["id"]}),Similar.to({generalUser:["id","firstName","lastName"]})]})],config.fields.push(Similar.to(coll));var command=Similar.to({name:"get",type:entityType,config:Similar.to(config)});return command}var data=testData.registerTestDataForEntityListModel().userStory,entity=data[0],entityId=data.id,expectedCmdArray=[Similar.to({name:"get",type:data.__type,config:Like.is({id:entityId,fields:["id","effort","effortToDo","tasks-count","tasks-effort-sum","tasks-effortToDo-sum",Like.is({owner:["id","firstName","lastName"]}),Like.is({roleEfforts:["id","effort","effortToDo",Like.is({role:["id","name"]})],list:!0}),Like.is({assignments:["id",Like.is({role:["id","name"]}),Like.is({generalUser:["id","firstName","lastName"]})],list:!0})]})})],developerRole={id:1,name:"Dev."},context={context:{type:"story",id:15}},entities=[{id:31,name:"Task Name1",__type:"task",entityState:{id:1,name:"Open"},effort:1,assignments:{groups:[{role:developerRole,users:[{id:1,name:"Vasili I.",assignmentId:309},{id:2,name:"Ivan V.",assignmentId:310}]}]}},{id:41,name:"Bug Name1",__type:"bug",entityState:{id:1,name:"Open"},effort:5,assignments:{groups:[{role:{id:1,name:"Dev."},users:[{id:3,name:"Alex P.",assignmentId:311},{id:4,name:"Petr I.",assignmentId:312}]}]}},{id:32,name:"Task Name2",__type:"task",entityState:{id:2,name:"In Progress"},effort:22,assignments:{groups:[{role:{id:1,name:"Dev."},users:[{id:1,name:"Vasili I.",assignmentId:309},{id:2,name:"Ivan V.",assignmentId:310}]}]}},{id:43,name:"Bug Name3",__type:"bug",entityState:{id:2,name:"In Progress"},effort:5,assignments:{groups:[{role:{id:1,name:"Dev."},users:[{id:3,name:"Alex P.",assignmentId:311},{id:4,name:"Petr I.",assignmentId:312}]}]}},{id:33,name:"Task Name3",__type:"task",entityState:{id:3,name:"Done"},effort:8,assignments:{groups:[{role:{id:1,name:"Dev."},users:[{id:1,name:"Vasili I.",assignmentId:309},{id:2,name:"Ivan V.",assignmentId:310}]}]}},{id:42,name:"Bug Name2",__type:"bug",entityState:{id:3,name:"Done"},effort:5,assignments:{groups:[{role:{id:1,name:"Dev."},users:[{id:3,name:"Alex P.",assignmentId:311},{id:4,name:"Petr I.",assignmentId:312}]}]}}],expectedDataGrouped={items:[],groups:[{key:{id:1,name:"Open"},items:[{id:31,name:"Task Name1",__type:"task",entityState:{id:1,name:"Open"},effort:1,assignments:{groups:[{role:developerRole,users:[{id:1,name:"Vasili I.",assignmentId:309},{id:2,name:"Ivan V.",assignmentId:310}]}]}},{id:41,name:"Bug Name1",__type:"bug",entityState:{id:1,name:"Open"},effort:5,assignments:{groups:[{role:{id:1,name:"Dev."},users:[{id:3,name:"Alex P.",assignmentId:311},{id:4,name:"Petr I.",assignmentId:312}]}]}}]},{key:{id:2,name:"In Progress"},items:[{id:32,name:"Task Name2",__type:"task",entityState:{id:2,name:"In Progress"},effort:22,assignments:{groups:[{role:{id:1,name:"Dev."},users:[{id:1,name:"Vasili I.",assignmentId:309},{id:2,name:"Ivan V.",assignmentId:310}]}]}},{id:43,name:"Bug Name3",__type:"bug",entityState:{id:2,name:"In Progress"},effort:5,assignments:{groups:[{role:{id:1,name:"Dev."},users:[{id:3,name:"Alex P.",assignmentId:311},{id:4,name:"Petr I.",assignmentId:312}]}]}}]},{key:{id:3,name:"Done"},items:[{id:33,name:"Task Name3",__type:"task",entityState:{id:3,name:"Done"},effort:8,assignments:{groups:[{role:{id:1,name:"Dev."},users:[{id:1,name:"Vasili I.",assignmentId:309},{id:2,name:"Ivan V.",assignmentId:310}]}]}},{id:42,name:"Bug Name2",__type:"bug",entityState:{id:3,name:"Done"},effort:5,assignments:{groups:[{role:{id:1,name:"Dev."},users:[{id:3,name:"Alex P.",assignmentId:311},{id:4,name:"Petr I.",assignmentId:312}]}]}}]}],config:{views:[{type:"grid",group:{dataIndex:"name"},fields:[{dataIndex:"id",cssClass:"tau-list__cell-id"},{dataIndex:"name",cssClass:"tau-list__cell-name"},{dataIndex:"entityState.name",cssClass:"tau-list__cell-stateName"}]}]}},expectedTasksBugsDetailsCommand=[],item=createExpectedTaskBugDetailCommand("userStory",15,"tasks");expectedTasksBugsDetailsCommand.push(item),item=createExpectedTaskBugDetailCommand("userStory",15,"bugs"),expectedTasksBugsDetailsCommand.push(item);var viewTests=[{name:"should render valid markup view",test:function(){var data=this.data,$el=this.$el,$groups=$el.find(".tau-list__group");equals($groups.length,3,"Groups amount");for(var i=0;i<$groups.length;i++){var $group=$groups.eq(i);equals($group.find("h2").text(),data.groups[i].key.name,"Group title"),equals($group.find("table").length,1,"Inner table"),equals($group.find("table tr").length,2,"Inner table rows");var $trs=$group.find("table tr");for(var j=0;j<$trs.length;j++){var $tds=$trs.eq(j).find("td");equals($tds.length,3,"Inner table td");for(var k=0;k<$tds.length;k++){var fieldIndex=componentConfig.views[0].fields[k].dataIndex,val=_.complexKey(data.groups[i].items[j],fieldIndex);val=(new String(val||"")).toString(),equals($tds.eq(k).text(),val,"Cell content");var fieldClass=componentConfig.views[0].fields[k].cssClass;equals($tds.hasClass(fieldClass),!0,"Cell CSS class")}}}}}],componentConfig={dataProvider:BugsTasksDataProvider,groupBy:"entityState",orderBy:["entityState.id"],views:[{type:"grid",group:{dataIndex:"name"},fields:[{dataIndex:"id",cssClass:"tau-list__cell-id"},{dataIndex:"name",cssClass:"tau-list__cell-name"},{dataIndex:"entityState.name",cssClass:"tau-list__cell-stateName"}]}]},setup=commonSetup.create("[component.list][with.grouping]",data,listComponent,componentConfig);componentSpecs.create(setup,context).viewShouldFollowDataComponentLifeCycle().modelShouldReturnData(expectedDataGrouped,[expectedTasksBugsDetailsCommand]).viewShouldPassTests(viewTests).done();var expectedDataWithoutGrouping={items:entities,groups:[],config:{views:[{type:"grid",fields:[{dataIndex:"id",cssClass:"tau-list__cell-id"},{dataIndex:"name"},{dataIndex:"entityState.name"}]}]}},componentConfigWithoutGroups={dataProvider:BugsTasksDataProvider,orderBy:["entityState.id"],views:[{type:"grid",fields:[{dataIndex:"id",cssClass:"tau-list__cell-id"},{dataIndex:"name"},{dataIndex:"entityState.name"}]}]},viewTestsWithoutGroups=[{name:"should render valid markup view",test:function(){var data=this.data,$el=this.$el,$groups=$el.find(".tau-list__group");equals($groups.length,0,"Groups amount"),equals($el.find("table").length,1,"Inner table");var $table=$el.find("table");equals($table.find("tr").length,6,"Inner table rows");var $trs=$table.find("tr");for(var j=0;j<$trs.length;j++){var $tds=$trs.eq(j).find("td");equals($tds.length,3,"Inner table td");for(var k=0;k<$tds.length;k++){var fieldIndex=componentConfig.views[0].fields[k].dataIndex,val=_.complexKey(data.items[j],fieldIndex);equals($tds.eq(k).text(),(new String(data.items[j][fieldIndex]?data.items[j][fieldIndex]:"")).toString(),"Cell content")}}}}],setupWithoutGrouping=commonSetup.create("[component.list][without.grouping]",data,listComponent,componentConfigWithoutGroups);componentSpecs.create(setupWithoutGrouping,context).viewShouldFollowDataComponentLifeCycle().modelShouldReturnData(expectedDataWithoutGrouping,[expectedTasksBugsDetailsCommand]).viewShouldPassTests(viewTestsWithoutGroups).done()};return{run:innerRun}})