define(["Underscore","jQuery","tests/common/testData","tests/common/model.chainfixture","tests/common/modelConfig","tau/core/termProcessor","tau/models/dataprocessor/model.processor.context"],function(_,$,a,b,c,d,e){return{create:function(a,f,g,h,i){return{setup:function(j){function k(a){this.config=a,this.termProcessor=new d(a.context.getTerms()),this.component.fire("initialize",a)}$.fx.off=!0,module(a,{setup:function(){this.___testStartBusesCount=tau.buses.count(!0);var a=typeof f=="function"?f():f,c={testData:a};b.setup(this).setInitialData(c),j.preSetup&&j.preSetup.call(this,b);var d=_.clone(h||{});d.context&&(d.context=e(d.context)),this.component=g.create(d),j.setup&&j.setup.call(this,b)},teardown:function(){this.component.fire("destroy");var c=tau.buses.count(!0),d=c-this.___testStartBusesCount;if(d>0){var e="Dirty destroy. "+d+" bus(es) remained alive";throw console.log("["+a+"]:"+e),{message:e}}b.tearDown(this)}});var l={setupFunctions:[],initialize:function(a){var b=a.manualContext!==!0?c[a.context.type](a.context.id,i):_(a.context).clone(),d=_(a.settings||{}).clone();b=_.extend(b,a.context.data),d.context=e(b);var f=k;return arguments.length>1&&(f=arguments[1]||f),this.setupFunctions.push(function(){f.call(this,d)}),l},test:function(a,b){var c=this.setupFunctions;return test(a,function(){for(var a=0,d=c.length;a<d;a++)c[a].call(this);b.call(this),this.mockControl.verify()}),l}};return l}}}}})