define(["Underscore","jQuery","tests/common/testData","tests/common/model.chainfixture","tests/common/modelConfig","tau/core/termProcessor","tau/models/dataprocessor/model.processor.context"],function(_,$,testData,fixture,modelConfig,TermProcessor,fnCtx){return{create:function(name,data,component,componentConfig,customContextConfig){return{setup:function(config){function init(config){this.config=config,this.termProcessor=new TermProcessor(config.context.getTerms()),this.component.fire("initialize",config)}$.fx.off=!0,module(name,{setup:function(){this.___testStartBusesCount=tau.buses.count(!0);var initialData=typeof data=="function"?data():data,dataConfig={testData:initialData};fixture.setup(this).setInitialData(dataConfig),config.preSetup&&config.preSetup.call(this,fixture);var clone=_.clone(componentConfig||{});clone.context&&(clone.context=fnCtx(clone.context)),this.component=component.create(clone),config.setup&&config.setup.call(this,fixture)},teardown:function(){this.component.fire("destroy");var countAfterDestroy=tau.buses.count(!0),delta=countAfterDestroy-this.___testStartBusesCount;if(delta>0){var message="Dirty destroy. "+delta+" bus(es) remained alive";throw console.log("["+name+"]:"+message),{message:message}}fixture.tearDown(this)}});var testModule={setupFunctions:[],initialize:function(config){var context=config.manualContext!==!0?modelConfig[config.context.type](config.context.id,customContextConfig):_(config.context).clone(),settings=_(config.settings||{}).clone();context=_.extend(context,config.context.data),settings.context=fnCtx(context);var initFunc=init;return arguments.length>1&&(initFunc=arguments[1]||initFunc),this.setupFunctions.push(function(){initFunc.call(this,settings)}),testModule},test:function(testName,testFunc){var setupFunctions=this.setupFunctions;return test(testName,function(){for(var i=0,setupFunctionCount=setupFunctions.length;i<setupFunctionCount;i++)setupFunctions[i].call(this);testFunc.call(this),this.mockControl.verify()}),testModule}};return testModule}}}}})