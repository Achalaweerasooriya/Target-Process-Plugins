define(["Underscore","jQuery","tests/common/testData","tests/common/model.chainfixture","tests/common/modelConfig","tau/core/termProcessor","tau/models/dataprocessor/model.processor.context"],function(a,b,c,d,e,f,g){return{create:function(c,h,i,j,k){return{setup:function(l){function m(a){this.config=a,this.termProcessor=new f(a.context.getTerms()),this.component.fire("initialize",a)}b.fx.off=!0,module(c,{setup:function(){this.___testStartBusesCount=tau.buses.count(!0);var b=typeof h=="function"?h():h,c={testData:b};d.setup(this).setInitialData(c),l.preSetup&&l.preSetup.call(this,d);var e=a.clone(j||{});e.context=g(e.context),this.component=i.create(e),l.setup&&l.setup.call(this,d)},teardown:function(){this.component.fire("destroy");var a=tau.buses.count(!0),b=a-this.___testStartBusesCount;if(b>0){var e="Dirty destroy. "+b+" bus(es) remained alive";throw console.log("["+c+"]:"+e),{message:e}}d.tearDown(this)}});var n={setupFunctions:[],initialize:function(b){var c=b.manualContext!==!0?e[b.context.type](b.context.id,k):a(b.context).clone(),d=a(b.settings||{}).clone();c=a.extend(c,b.context.data),d.context=g(c);var f=m;return arguments.length>1&&(f=arguments[1]||f),this.setupFunctions.push(function(){f.call(this,d)}),n},test:function(a,b){var c=this.setupFunctions;return test(a,function(){for(var a=0,d=c.length;a<d;a++)c[a].call(this);b.call(this),this.mockControl.verify()}),n}};return n}}}}})