define(["Underscore","jQuery","tau/utils/utils.routing"],function(_,$,a){var b=function(){module("[utils.routing] tests",{setup:function(){}}),test("should register routes",function(){var b=!1,c="preved",d=new a({window:window});d.reset().register({pattern:"task/{id}",callback:function(a){b=a.id}}).register({pattern:"bug/{id}",callback:function(a){b=a.id+1}}).register("project/{id}",function(a){b=a.id+2}).start(),d.execute("#task/126"),equals(b,126,"Routing is executed and processed"),$(window).triggerHandler($.Event("hashchange",{hash:"task/123"})),equals(b,123,"Routing is executed and processed"),$(window).triggerHandler($.Event("hashchange",{hash:"bug/555"})),equals(b,556,"Routing is executed and processed"),$(window).triggerHandler($.Event("hashchange",{hash:"project/555"})),equals(b,557,"Routing is executed and processed"),d.stop(),$(window).triggerHandler($.Event("hashchange",{hash:"project/556"})),equals(b,557,"Routing is executed and processed")}),test("should handle routes with state data",function(){var b=!1,c="preved",d={},e=new a({window:window});e.reset().register({pattern:"task/{id}",callback:function(a,c){b=a.id,d=c}}),e.start(),$(window).triggerHandler($.Event("hashchange",{hash:'task/555||{"tab":3}'})),equals(b,555,"Extract request parameters"),same(d,{tab:3},"Extract state parameters"),$(window).triggerHandler($.Event("hashchange",{hash:"task/5556||"+JSON.stringify({tab:'Ё!"#$%^&*()_+=-09}{[]|":?><Q~"fff"<fff>'})})),equals(b,5556,"Extract request parameters"),same(d,{tab:'Ё!"#$%^&*()_+=-09}{[]|":?><Q~"fff"<fff>'},"Extract special state parameters"),e.stop()}),test("should produce routes with state data",function(){var b=!1,c="preved",d={},e=new a({window:window});e.reset().register({pattern:"task/{id}",callback:function(a,b){}}),e.start(),$(window).triggerHandler($.Event("hashchange",{hash:"task/555"}));var f=e.generateUrl();equals(f,"task/555","Generate correct url"),$(window).triggerHandler($.Event("hashchange",{hash:'task/555||{"tab":3}'})),f=e.generateUrl(),equals(f,'task/555||{"tab":3}',"Generate correct url"),e.stop()}),test("should save referer",function(){var b=!1,c="preved",d={},e=new a({window:window});e.reset().register({pattern:"task/{id}",callback:function(a,b){}}),e.start(),$(window).triggerHandler($.Event("hashchange",{hash:"task/555"})),equals(e.getReferer().url,"","Init referer is null"),$(window).triggerHandler($.Event("hashchange",{hash:"task/666"})),equals(e.getReferer().url,"task/555","Have referer"),$(window).triggerHandler($.Event("hashchange",{hash:'task/666||{"tab":3}'})),equals(e.getReferer().url,"task/555","Have referer"),e.stop(),e=null,e=new a({window:window}),e.reset().register({pattern:"task/{id}",callback:function(a,b){}}),e.start(),equals(e.getReferer().url,"task/555","Have referer"),$(window).triggerHandler($.Event("hashchange",{hash:"task/888"})),$(window).triggerHandler($.Event("unload",{})),equals(e.getReferer().url,"task/888","Handle window unload")})};return{run:b}})