define(["Underscore","jQuery","tau/core/tau","tau/components/component.testCaseList","tests/components/component.specs","tests/common/testData","tests/components/common/common.setup","tau/configurator"],function(_,$,tau,testCaseListComponent,componentSpecs,testData,commonSetup,configurator){var innerRun=function(){function getClass(a){return a.map(function(){return $(this).attr("class")||""}).get()}function getText(a){return a.map(function(){return $(this).text()||""}).get()}function validateTestCaseElement(a,b){ok(a.is("tbody.collapsed"),"TBody is valid");var c=a.children("tr");equal(c.length,2,"Count of rows is valid");var d=c.eq(0).children("td"),e=d.eq(0).children().eq(0);ok(e.is("button.extra-info.expand"),"Expand button is valid"),equal(e.text(),"+","Expand text button is valid");var f=d.eq(1).children();ok(f.eq(0).find("em").is(".ui-type-icon.ui-type-icon-testcase"),"Bundle of test case is valid"),equal(d.eq(1).children("a").attr("href"),"#testcase/"+b.id,"Url is valid"),equal(d.eq(2).text(),b.name,"Name is valid"),equal(d.eq(3).text(),b.lastRunDate||"","Name is valid");if(b.lastRunStatus){var g=d.eq(4).children("span"),h=null;b.lastRunStatus.isPassed===!0?h="span.passed:contains(Passed)":b.lastRunStatus.isPassed===!1&&(h="span.failed:contains(Failed)"),h?ok(g.is(h),"Last run status is valid"):ok(!g.length,"Last run status is valid")}var i=c.eq(1),j=i.children("td");equal(j.length,2,"Count of cells in second row is valid"),equal(j.eq(1).attr("colspan"),"5","Colspan of steps/succes is valid");var k=j.eq(1).children(),l=k.eq(0);ok(l.is("div.steps")&&l.children().eq(0).is("h4:contains('Steps')"),"Steps header is valid "),ok(l.children().eq(1).is("span")&&l.children().eq(1).html().replace("<IMG","<img")==b.steps,"Steps is valid ");var m=k.eq(1);ok(m.is("div.success")&&m.children().eq(0).is("h4:contains('Success')"),"Success header is valid "),ok(m.children().eq(1).is("span")&&m.children().eq(1).html()==b.success,"Success is valid ")}function parse(dateString){return eval(["new ",dateString.replace(/\//gi,"")].join(""))}function getEntityFieldsArray(){return Like.is({testCases:["id","name","lastRunDate","lastStatus","steps","success","numericPriority"],list:!0})}var data=testData.getTestDataForTestCaseList(),classNames={CONTAINER:"ui-testCaseList"},lastRun1=parse(data[0].testCases[0].lastRunDate),lastRun2=parse(data[0].testCases[1].lastRunDate),expectedTestCases={items:[{__type:"testCase",id:4,name:"4345345",lastRunDate:"6-Jun-2011 "+[lastRun1.getHours(),lastRun1.getMinutes()].join(":"),applicationUrl:"#testcase/4",externalUrl:"/TP/View.aspx?noRedirect=1&id=4",steps:'45345 <img src="/TP/uploads/porn.jpg">',success:"3453453425345",lastRunStatus:{isPassed:!0}},{__type:"testCase",id:5,name:"34534",lastRunDate:"6-Jun-2011 "+[lastRun2.getHours(),lastRun2.getMinutes()].join(":"),steps:"3455",success:"3453453454",applicationUrl:"#testcase/5",externalUrl:"/TP/View.aspx?noRedirect=1&id=5",lastRunStatus:{isPassed:!1}},{__type:"testCase",id:6,name:"4534",lastRunDate:null,applicationUrl:"#testcase/6",externalUrl:"/TP/View.aspx?noRedirect=1&id=6",steps:"455",success:"34534534534"},{__type:"testCase",id:7,name:"345",lastRunDate:null,applicationUrl:"#testcase/7",externalUrl:"/TP/View.aspx?noRedirect=1&id=7",steps:"first second",success:"succes1 succes2"}]},expectedCmdArray=[Similar.to({name:"get",type:"userStory",config:Like.is({id:2,fields:["id",getEntityFieldsArray()]})})],viewTests=[{name:"should render valid colgroup",test:function(){var a=tau.concat(".",classNames.CONTAINER," colgroup col"),b=getClass(this.$el.find(a));same(b,["toggler","id","name","last-run-date","last-status","last-run"],"Column classes is valid")}},{name:"should render valid head",test:function(){var a=tau.concat(".",classNames.CONTAINER," thead th"),b=this.$el.find(a),c=getText(b);c[0]=c[0].replace(/\s*/gi,""),same(c,["+-","ID","Name","Last Run Date","Last Status","Run"],"Texts of header items is valid");var d=b.eq(0).children();equal(d.length,2,"Count of buttons is valid"),ok(d.eq(0).is(".extra-info.expand"),"Expand all button is valid"),ok(d.eq(1).is(".extra-info.collapse"),"Collapse all button is valid")}},{name:"should create valid content",test:function(){var a=this.$el.find(tau.concat(".",classNames.CONTAINER," tbody")),b=this.data.items;for(var c=0,d=b.length;c<d;c++)validateTestCaseElement(a.eq(c),b[c])}},{name:"should collapse on tbody click",test:function(){var a=this.$el.find("tbody .extra-info"),b=this.$el.find("tbody");same(getClass(b),["collapsed","collapsed","collapsed","collapsed"],"Initial classes of bodies is valid"),same(getClass(a),["extra-info expand","extra-info expand","extra-info expand","extra-info expand"],"Initial classes of buttons is valid"),a.eq(0).simulate("click"),same(getClass(b),["","collapsed","collapsed","collapsed"],"Classes of bodies after click is valid"),same(getClass(a),["extra-info collapse","extra-info expand","extra-info expand","extra-info expand"],"Classes of buttons after click  is valid"),same(getText(a),["-","+","+","+"],"Text of buttons after click  is valid"),a.eq(0).simulate("click"),same(getClass(b),["collapsed","collapsed","collapsed","collapsed"],"Classes of bodies after click is valid"),same(getClass(a),["extra-info expand","extra-info expand","extra-info expand","extra-info expand"],"Classes of buttons after click  is valid"),same(getText(a),["+","+","+","+"],"Text of buttons after click  is valid"),a.eq(1).simulate("click"),same(getClass(b),["collapsed","","collapsed","collapsed"],"Classes of bodies after click is valid"),same(getClass(a),["extra-info expand","extra-info collapse","extra-info expand","extra-info expand"],"Classes of buttons after click  is valid"),same(getText(a),["+","-","+","+"],"Text of buttons after click  is valid"),a.eq(1).simulate("click"),same(getClass(b),["collapsed","collapsed","collapsed","collapsed"],"Classes of bodies after click is valid"),same(getClass(a),["extra-info expand","extra-info expand","extra-info expand","extra-info expand"],"Classes of buttons after click  is valid"),same(getText(a),["+","+","+","+"],"Text of buttons after click  is valid")}},{name:"should expand all",test:function(){var a=this.$el.find("tbody .extra-info"),b=this.$el.find("thead .extra-info.expand"),c=this.$el.find("thead .extra-info.collapse"),d=this.$el.find("tbody");b.simulate("click"),same(getClass(d),["","","",""],"Classes of bodies after click is valid"),same(getClass(a),["extra-info collapse","extra-info collapse","extra-info collapse","extra-info collapse"],"Classes of buttons after expand all button click  is valid"),same(getText(a),["-","-","-","-"],"Text of buttons after click  is valid"),c.simulate("click"),same(getClass(d),["collapsed","collapsed","collapsed","collapsed"],"Classes of bodies after click is valid"),same(getClass(a),["extra-info expand","extra-info expand","extra-info expand","extra-info expand"],"Classes of buttons after expand all button click  is valid"),same(getText(a),["+","+","+","+"],"Text of buttons after click  is valid")}},{name:"should evict test cases on add testcase",test:function(){this.component.fire("testCaseWasAdded");var a=configurator.getProxy(),b=a.db.getPersistedNode(2,"userStory");ok(b.data.hasOwnProperty("testCases")===!1,"Test case collection is evicted")}}],context={context:{type:"story",id:2}},setup=commonSetup.create("[component.testCaseList]",testData.getTestDataForTestCaseList(),testCaseListComponent);componentSpecs.create(setup,context).viewShouldFollowDataComponentLifeCycle().modelShouldReturnData(expectedTestCases,[expectedCmdArray]).viewShouldPassTests(viewTests).viewShouldContainEmptyMessage(null,function(){equal(this.$el.find(".ui-testCaseList-content").css("display"),"none"),equal(this.$el.find(".ui-empty-data-msg").text(),"No test cases found"),equal(this.$el.find(".tau-add-testCase").text(),"Add Test Case")}).done()};return{run:innerRun}})