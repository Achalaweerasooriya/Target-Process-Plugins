define(["Underscore","jQuery","tau/configurator","tau/components/component.assignmentsList","tau/components/component.userList","tests/common/testData.Generator","tests/components/common/common.setup","tests/components/component.specs","tests/components/assignmentsList/component.assignmentsList.tests"],function(a,b,c,d,e,f,g,h,i){var j=function(){var e=new f;e.clear(),e.initDefaultData();var j=e.getData(),k=function(){var b=a.select(j,function(a){return a.__type==="userStory"});return b[3]},l=k(),m=l.id,n={context:{type:"story",id:m}},o=[i.generateBaseViewTest("should change assignment").addTest(function(){var a=this.$el,b=a.find(".user-name:eq(0)");b.click();var c=a.find(".user").eq(0).tauBubble("widget").find(".filtered-user-list");equal(c.size(),1,"Count of popup"),equal(c.find(".role-title").size(),1,"Count of visible roles"),equal(c.find(".role-title").text(),"Developer","Only developer is visible");var d=c.find(".user");equal(d.size(),2,"Count of user"),equal(d.eq(0).find(".user-name").text(),"Administrator Administrator","First Developer"),equal(d.eq(1).find(".user-name").text(),"Sam Yellow","First Developer");var f=e.getUsers()[6];this.service.registerSaveCommand({config:{$set:{generalUser:{id:f.id}},fields:["id",{generalUser:["id","firstName","lastName"]},{role:["id","name"]},{assignable:["id"]}],id:l.assignments[0].id},returnedData:{id:l.assignments[0].id,generalUser:f}}),d.eq(1).click(),equal(this.$el.find(".filtered-user-list").size(),0,"Popup was removed"),equal(this.$el.find(".user-name").eq(0).text(),"Sam Yellow","User was updated")}),i.generateBaseViewTest("should unassign user").addTest(function(){var a=this.$el;this.service.registerRemoveCommand({config:{id:l.assignments[0].id,fields:["id"]},returnedData:{id:l.assignments[0].id,isError:!1}}),a.find(".user-name").eq(0).click(),a.find(".header-box .unassign-button").click();var b=a.find(".user").eq(0).tauBubble("widget");b.find(".unassign-button").click(),equal(this.$el.find(".filtered-user-list").size(),0,"Popup is removed"),equal(this.$el.find(".user-name").eq(0).text(),"Sandra Red","User is removed"),equal(this.$el.find(".user-name").size(),3,"Count of user"),ok(this.$el.find(".group[roleid=1] .role-header .role-title .add-btn").size()==1,"Add assign button is shown")}),i.generateBaseViewTest("should change assign to logged user").addTest(function(){var a=this.$el,b=this.config.context.applicationContext.loggedUser;this.service.registerSaveCommand({config:{$set:{generalUser:{id:b.id}},fields:["id",{generalUser:["id","firstName","lastName"]},{role:["id","name"]},{assignable:["id"]}],id:l.assignments[0].id},returnedData:{id:l.assignments[0].id,generalUser:b}}),a.find(".user-name").eq(0).click();var c=a.find(".user").eq(0).tauBubble("widget");c.find(".assign-to-me-button").click(),equal(this.$el.find(".filtered-user-list").size(),0,"Popup was removed"),equal(this.$el.find(".user-name").eq(0).text(),b.firstName+" "+b.lastName,"User name is valid")}),i.generateBaseViewTest("should change developer role effort").addTest(function(){var b=this.testData,d=a.find(b,function(a){return a.id===m});this.component.on("evictTotalEfforts",function(){var b=[a.clone(d.roleEfforts[0]),a.clone(d.roleEfforts[1])];d={id:d.id,__type:d.__type,roleEfforts:b,effort:99,effortToDo:55},a.extend(d.roleEfforts[0],{effort:99,effortToDo:55}),c.getProxy().registerData(d)}),this.service.registerSaveCommand({config:{$set:{effort:99},fields:["id","effortToDo"],id:d.roleEfforts[0].id},returnedData:{id:d.roleEfforts[0].id,effortToDo:99}});var e=this.$el,f=e.find(".role-effort .effort").eq(0);f.click(),f.text(99),f.blur(),equal(this.$el.find(".role-effort .effort").eq(0).text(),"99h"),equal(this.$el.find(".role-effort .remain").eq(0).text(),"55h")}),i.generateBaseViewTest("should filter by user name and role name").addTest(function(){var a=this.$el;a.find(".user-name").eq(0).click();var b=a.find(".user").eq(0).tauBubble("widget"),c=b.find(".user-search-box");c.val("and"),c.simulate("keyup",{charCode:97});var d=b.find(".filtered-user-list .role-title");equal(d.size(),1,"Count of roles"),equal(d.eq(0).text().trim(),"Top Manager","Top Manager");var e=b.find(".filtered-user-list .user-name");equal(e.size(),1,"Count of users"),equal(e.eq(0).text().trim(),"Andrew Gray","Andrew Gray"),c.val("Devel"),c.simulate("keyup",{charCode:97});var d=b.find(".filtered-user-list .role-title");equal(d.size(),1,"Count of roles"),equal(d.eq(0).text().trim(),"Developer","Developer");var e=b.find(".filtered-user-list .user-name");equal(e.size(),2,"Count of users"),equal(e.eq(0).text().trim(),"Administrator Administrator","Administrator Administrator"),equal(e.eq(1).text().trim(),"Sam Yellow","Sam Yellow")}),i.generateBaseViewTest("should all on show more click").addTest(function(){var a=this.$el;a.find(".user-name").eq(0).click();var b=a.find(".user").eq(0).tauBubble("widget"),c=b.find(".filtered-user-list .more-link");equal(c.size(),1,"More button count"),c.click();var d=b.find(".filtered-user-list .role-title");equal(d.size(),4,"Roles count")})],p=g.create("[component.assignmentsList editable]",j,d);h.create(p,n).viewShouldPassTests(o).done();var q={effortPoints:"h",owner:{id:255,name:"Tod Black",avatar:"/TP/Avatar.ashx?UserId=255&size=32"},assignments:{groups:[{roleEffort:{effort:"20",remain:b.browser.msie?"15.56":"15.55"},role:{id:1,name:"Developer",isPair:!0,__type:"role"},users:[{id:254,name:"John Brown",avatar:"/TP/Avatar.ashx?UserId=254&size=32",assignmentId:250,roleId:1}],allowAdd:!0},{roleEffort:{effort:"15",remain:"8"},role:{id:4,name:"QA Engineer",isPair:!1,__type:"role"},users:[{id:256,name:"Andrew Gray",avatar:"/TP/Avatar.ashx?UserId=256&size=32",assignmentId:251,roleId:4}],allowAdd:!1}]},totalEffort:{effort:"25.11",remain:"98.51"},tasksEffort:{effort:"18.21",remain:"12.21"}};e.clear(),e.initDefaultData();var j=e.getData(),r={};a.each(j,function(a){a.id===m&&(a.assignments.splice(2,1),r=a)});var p=g.create("[component.assignmentsList editable]",j,d);h.create(p,n).viewShouldPassTests([i.generateBaseViewTest("should assign to me",q).addTest(function(){var a=this.$el,b=this.config.context.applicationContext.loggedUser,c=e.getRoles()[0];this.service.registerSaveCommand({config:{$set:{generalUser:{id:b.id},assignable:{id:r.id},role:{id:c.id}},fields:["id",{generalUser:["id","firstName","lastName"]},{role:["id","name"]},{assignable:["id"]}]},returnedData:{id:256,generalUser:b,role:c,assignable:{id:m}}});var d=a.find(".add-btn:eq(0)");d.click();var f=d.tauBubble("widget"),g=f.find(".filtered-user-list .assign-to-me-button");equal(f.size(),1,"Count of popup"),equal(f.find(".role-title").size(),1,"Count of visible roles"),equal(f.find(".role-title").text(),"Developer","Only developer is visible"),g.simulate("click"),ok(this.$el.find(".add-btn").eq(0).hasClass("disabled"),"Add button is disabled"),equal(this.$el.find(".user").eq(1).text().trim(),b.firstName+" "+b.lastName,"User is shown")})]).done(),e.clear(),e.initDefaultData();var j=e.getData(),s={manualContext:!0,a:"a"},t={loggedUser:{id:985,firstName:"User",lastName:"not in team"}},p=g.create("[component.assignmentsList editable]",j,d,s,t);h.create(p,n).viewShouldPassTests([i.generateBaseViewTest("should not show assign to me button if user is not in team").addTest(function(){var a=this.$el,b=a.find(".user").eq(0);b.click();var c=b.tauBubble("widget").find(".filtered-user-list"),d=c.find(".assign-to-me-button");ok(c.size()==1,"User list is shown"),ok(d.size()==0,"Assign to is hidden")})]).done()};return{run:j}})