define(["Underscore","jQuery","tau/core/class","tau/configurator","tau/components/component.implementationHistory","tests/common/testData","tests/components/common/common.setup","tests/components/component.specs","tests/common/applicationContext"],function(_,$,a,b,c,d,e,f,g){var h=function(){var a=d.getImplementationHistoryData(),b={context:{id:15,type:"story",applicationContext:new g}},h={entityStates:["Five","Four","Three","Two","One"],historyItems:[{date:"2011-08-26T09:00:00",spentTime:0,transitions:0,state:{name:"One",dateSpan:6,isInitial:!0,isFinal:!1}},{date:"2011-08-29T09:00:00",spentTime:0,transitions:2,state:{name:"One",isInitial:!0,isFinal:!1}},{date:"2011-08-30T09:00:00",spentTime:0,transitions:1,state:{name:"One",isInitial:!0,isFinal:!1}},{date:"2011-09-01T09:00:00",spentTime:0,transitions:1,state:{name:"Three",dateSpan:3,isInitial:!1,isFinal:!1},assignments:[{id:1,firstName:"John",lastName:"Connor",role:"Leader"}]},{date:"2011-09-02T09:00:00",spentTime:0,transitions:0,state:{name:"Three",isInitial:!1,isFinal:!1}},{date:"2011-09-03T09:00:00",spentTime:0,transitions:0,state:{name:"Three",isInitial:!1,isFinal:!1},assignments:[{id:2,firstName:"Frodo",lastName:"Baggins",role:"Hobbit"}]},{date:"2011-09-04T09:00:00",spentTime:0,transitions:1,state:{name:"Two",dateSpan:2,isInitial:!1,isFinal:!1}},{date:"2011-09-05T09:00:00",spentTime:0,transitions:0,state:{name:"Two",isInitial:!1,isFinal:!1}},{date:"2011-09-06T09:00:00",spentTime:3,transitions:3,state:{name:"Three",dateSpan:1,isInitial:!1,isFinal:!1},relatedEntities:{opened:[{id:1,type:"x-entity",name:"Foo"}]}},{date:"2011-09-07T09:00:00",spentTime:0,transitions:1,state:{name:"Two",dateSpan:1,isInitial:!1,isFinal:!1}},{date:"2011-09-08T09:00:00",spentTime:8,transitions:1,state:{name:"Three",dateSpan:1,isInitial:!1,isFinal:!1},relatedEntities:{closed:[{id:1,type:"x-entity",name:"Foo"}]},assignments:[{id:1,firstName:"John",lastName:"Connor",role:"Leader"}]},{date:"2011-09-09T09:00:00",spentTime:0,transitions:1,state:{name:"One",dateSpan:2,isInitial:!0,isFinal:!1}},{date:"2011-09-11T09:00:00",spentTime:0,transitions:1,state:{name:"Three",dateSpan:1,isInitial:!1,isFinal:!1}},{date:"2011-09-12T09:00:00",spentTime:0,transitions:1,state:{name:"One",dateSpan:1,isInitial:!0,isFinal:!1}},{date:"2011-09-13T09:00:00",spentTime:0,transitions:1,state:{name:"Five",isInitial:!1,isFinal:!0}}]},i=[Similar.to({name:"get",type:"implementationHistory",config:Like.is({id:b.context.id,fields:["id","statistics"]})}),Similar.to({name:"get",type:"process",config:Like.is({id:b.context.applicationContext.processes[0].id,fields:["id",Similar.to({entityStates:["id","name","isInitial","isFinal",Similar.to({entityType:["id","name"]})]})]})}),Similar.to({name:"get",type:"project",config:Like.is({id:b.context.applicationContext.selectedProjects[0].id,fields:["id",Similar.to({projectMembers:["id",Similar.to({user:["id","firstName","lastName"]}),Similar.to({role:["id","name"]})]})]})})],j=[{name:"Template frame markup",test:function(){ok(this.$el.hasClass("tau-implementationHistory"),"Frame has valid root class");var a=this.$el.find("> .tau-historyGridInterpretation");ok(a.size()==1,"Frame has container for the history grid interpretation");var b=this.$el.find("> .tau-historyGrid");ok(b.size()==1,"Frame has container for the history grid"),ok(b.find("> table > tbody > tr").size()==1,"History grid container has valid structure")}},{name:"History grid interpretation elements",test:function(){var a=this.$el.find("> .tau-historyGridInterpretation");ok(_.all(h.entityStates,function(b,c){return a.find("> div:nth-child("+(c+1)+")").text()==b}),"A set of step-related labels is found"),ok(a.find("> div:nth-child("+(h.entityStates.length+1)+")").text()=="Date","Label for date is found"),ok(a.find("> div:nth-child("+(h.entityStates.length+2)+")").text()=="Related Entities","Label for related entities is found")}},{name:"History items count",test:function(){ok(this.$el.find(".tau-historyGrid td.tau-historyItem").size()==h.historyItems.length,"History items count is valid")}},{name:"History item state progress steps",test:function(){var a=h.entityStates.length;ok(_.all(this.$el.find(".tau-historyGrid td.tau-historyItem"),function(b){var c=$(b).find("> .tau-progressSteps > .tau-step > .tau-marker");return a==c.size()}),"Progress steps count is valid")}},{name:"History item date",test:function(){ok(_.all(this.$el.find(".tau-historyGrid td.tau-historyItem"),function(a,b){var c=$(a).find("> .tau-date"),d=c.size()==1,e=c.find("> .tau-day").text()==dateFormat(h.historyItems[b].date,"dd"),f=c.find("> .tau-month").text()==dateFormat(h.historyItems[b].date,"MMM");return d&&e&&f}),"Date is valid")}},{name:"Related entities container",test:function(){ok(_.all(this.$el.find(".tau-historyGrid td.tau-historyItem"),function(a){return $(a).find("> .tau-relatedEntities").size()==1}),"Container is found")}},{name:"History item state markers",test:function(){ok(_.all(this.$el.find(".tau-historyGrid td.tau-historyItem"),function(a,b){var c=h.historyItems[b],d=_.indexOf(h.entityStates,c.state.name),e=$(a).find(".tau-progressSteps .tau-step").eq(d),f="tau-normal";c.transitions>1&&(f="tau-transitions"),c.state.isFinal&&(f="tau-done");var g=e.find(".tau-marker").size()==1,i=e.find(".tau-marker .tau-flow").hasClass(f);return g&&i}),"State markers are valid")}},{name:"History item state markers date span",test:function(){ok(_.all(h.historyItems,function(a,b){var c=!0;if(a.state.dateSpan){var d=this.$el.find(".tau-historyGrid td.tau-historyItem").eq(b).find(".tau-progressSteps .tau-flow"),e=d.text()==a.state.dateSpan,f=d.attr("title")==a.state.dateSpan;c=e&&f}return c},this),"Date span labels are valid")}},{name:"History item state marker connections",test:function(){var a=["tau-marker","tau-marker","tau-marker tau-out","tau-marker","tau-marker","tau-marker","tau-marker tau-in","tau-marker tau-out","tau-marker","tau-marker tau-in tau-out","tau-marker","tau-marker tau-in tau-out","tau-marker","tau-marker tau-in tau-out","tau-marker"];ok(_.all(this.$el.find(".tau-historyGrid td.tau-historyItem"),function(b,c){var d=$(b).find(".tau-progressSteps .tau-step .tau-marker .tau-flow").parent();return d.attr("class")==a[c]}),"Marker connections are valid")}},{name:"Time load",test:function(){var a=_.max(h.historyItems,function(a){return a.spentTime}).spentTime;ok(_.all(h.historyItems,function(b,c){var d=b.spentTime,e=d*100/a,f=Math.round(e/10)*10,g=this.$el.find(".tau-historyGrid td.tau-historyItem .tau-date").eq(c),h=g.hasClass("tau-timeLoad-"+f),i=g.attr("title")==d+" hours";return h&&i},this),"Time load indicators are valid")}},{name:"Related Entities",test:function(){var a=this.$el.find(".tau-historyGrid td.tau-historyItem");ok(a.eq(8).find(".tau-relatedEntities .tau-entity.tau-x-entity").size()==1&&a.eq(10).find(".tau-relatedEntities .tau-entity.tau-x-entity.tau-closed").size()==1,"Related entities are valid")}},{name:"Assignments",test:function(){ok(_.all(h.historyItems,function(a,b){var c=!0;return a.assignments&&(c=_.all(a.assignments,function(a,c){var d=this.$el.find(".tau-historyGrid td.tau-historyItem").eq(b).find(".tau-assignments img").eq(c),e=[a.firstName,a.lastName,"("+a.role+")"].join(" "),f=d.size()==1,g=d.attr("title")==e;return f&&g},this)),c},this),"Assignments are valid")}}],k=e.create("[component.implementationHistory]",a,c,b);f.create(k,b).done()};return{run:h}})