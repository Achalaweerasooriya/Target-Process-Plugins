define(["Underscore","jQuery","tau/core/class","tau/configurator","tau/components/component.implementationHistory","tests/common/testData","tests/components/common/common.setup","tests/components/component.specs","tests/common/applicationContext"],function(a,b,c,d,e,f,g,h,i){var j=function(){var c=f.getImplementationHistoryData(),d={context:{id:15,type:"story",applicationContext:new i}},j={entityStates:["Five","Four","Three","Two","One"],historyItems:[{date:"2011-08-26T09:00:00",spentTime:0,transitions:0,state:{name:"One",dateSpan:6,isInitial:!0,isFinal:!1}},{date:"2011-08-29T09:00:00",spentTime:0,transitions:2,state:{name:"One",isInitial:!0,isFinal:!1}},{date:"2011-08-30T09:00:00",spentTime:0,transitions:1,state:{name:"One",isInitial:!0,isFinal:!1}},{date:"2011-09-01T09:00:00",spentTime:0,transitions:1,state:{name:"Three",dateSpan:3,isInitial:!1,isFinal:!1},assignments:[{id:1,firstName:"John",lastName:"Connor",role:"Leader"}]},{date:"2011-09-02T09:00:00",spentTime:0,transitions:0,state:{name:"Three",isInitial:!1,isFinal:!1}},{date:"2011-09-03T09:00:00",spentTime:0,transitions:0,state:{name:"Three",isInitial:!1,isFinal:!1},assignments:[{id:2,firstName:"Frodo",lastName:"Baggins",role:"Hobbit"}]},{date:"2011-09-04T09:00:00",spentTime:0,transitions:1,state:{name:"Two",dateSpan:2,isInitial:!1,isFinal:!1}},{date:"2011-09-05T09:00:00",spentTime:0,transitions:0,state:{name:"Two",isInitial:!1,isFinal:!1}},{date:"2011-09-06T09:00:00",spentTime:3,transitions:3,state:{name:"Three",dateSpan:1,isInitial:!1,isFinal:!1},relatedEntities:{opened:[{id:1,type:"x-entity",name:"Foo"}]}},{date:"2011-09-07T09:00:00",spentTime:0,transitions:1,state:{name:"Two",dateSpan:1,isInitial:!1,isFinal:!1}},{date:"2011-09-08T09:00:00",spentTime:8,transitions:1,state:{name:"Three",dateSpan:1,isInitial:!1,isFinal:!1},relatedEntities:{closed:[{id:1,type:"x-entity",name:"Foo"}]},assignments:[{id:1,firstName:"John",lastName:"Connor",role:"Leader"}]},{date:"2011-09-09T09:00:00",spentTime:0,transitions:1,state:{name:"One",dateSpan:2,isInitial:!0,isFinal:!1}},{date:"2011-09-11T09:00:00",spentTime:0,transitions:1,state:{name:"Three",dateSpan:1,isInitial:!1,isFinal:!1}},{date:"2011-09-12T09:00:00",spentTime:0,transitions:1,state:{name:"One",dateSpan:1,isInitial:!0,isFinal:!1}},{date:"2011-09-13T09:00:00",spentTime:0,transitions:1,state:{name:"Five",isInitial:!1,isFinal:!0}}]},k=[Similar.to({name:"get",type:"implementationHistory",config:Like.is({id:d.context.id,fields:["id","statistics"]})}),Similar.to({name:"get",type:"process",config:Like.is({id:d.context.applicationContext.processes[0].id,fields:["id",Similar.to({entityStates:["id","name","isInitial","isFinal",Similar.to({entityType:["id","name"]})]})]})}),Similar.to({name:"get",type:"project",config:Like.is({id:d.context.applicationContext.selectedProjects[0].id,fields:["id",Similar.to({projectMembers:["id",Similar.to({user:["id","firstName","lastName"]}),Similar.to({role:["id","name"]})]})]})})],l=[{name:"Template frame markup",test:function(){ok(this.$el.hasClass("tau-implementationHistory"),"Frame has valid root class");var a=this.$el.find("> .tau-historyGridInterpretation");ok(a.size()==1,"Frame has container for the history grid interpretation");var b=this.$el.find("> .tau-historyGrid");ok(b.size()==1,"Frame has container for the history grid"),ok(b.find("> table > tbody > tr").size()==1,"History grid container has valid structure")}},{name:"History grid interpretation elements",test:function(){var b=this.$el.find("> .tau-historyGridInterpretation");ok(a.all(j.entityStates,function(a,c){return b.find("> div:nth-child("+(c+1)+")").text()==a}),"A set of step-related labels is found"),ok(b.find("> div:nth-child("+(j.entityStates.length+1)+")").text()=="Date","Label for date is found"),ok(b.find("> div:nth-child("+(j.entityStates.length+2)+")").text()=="Related Entities","Label for related entities is found")}},{name:"History items count",test:function(){ok(this.$el.find(".tau-historyGrid td.tau-historyItem").size()==j.historyItems.length,"History items count is valid")}},{name:"History item state progress steps",test:function(){var c=j.entityStates.length;ok(a.all(this.$el.find(".tau-historyGrid td.tau-historyItem"),function(a){var d=b(a).find("> .tau-progressSteps > .tau-step > .tau-marker");return c==d.size()}),"Progress steps count is valid")}},{name:"History item date",test:function(){ok(a.all(this.$el.find(".tau-historyGrid td.tau-historyItem"),function(a,c){var d=b(a).find("> .tau-date"),e=d.size()==1,f=d.find("> .tau-day").text()==dateFormat(j.historyItems[c].date,"dd"),g=d.find("> .tau-month").text()==dateFormat(j.historyItems[c].date,"MMM");return e&&f&&g}),"Date is valid")}},{name:"Related entities container",test:function(){ok(a.all(this.$el.find(".tau-historyGrid td.tau-historyItem"),function(a){return b(a).find("> .tau-relatedEntities").size()==1}),"Container is found")}},{name:"History item state markers",test:function(){ok(a.all(this.$el.find(".tau-historyGrid td.tau-historyItem"),function(c,d){var e=j.historyItems[d],f=a.indexOf(j.entityStates,e.state.name),g=b(c).find(".tau-progressSteps .tau-step").eq(f),h="tau-normal";e.transitions>1&&(h="tau-transitions"),e.state.isFinal&&(h="tau-done");var i=g.find(".tau-marker").size()==1,k=g.find(".tau-marker .tau-flow").hasClass(h);return i&&k}),"State markers are valid")}},{name:"History item state markers date span",test:function(){ok(a.all(j.historyItems,function(a,b){var c=!0;if(a.state.dateSpan){var d=this.$el.find(".tau-historyGrid td.tau-historyItem").eq(b).find(".tau-progressSteps .tau-flow"),e=d.text()==a.state.dateSpan,f=d.attr("title")==a.state.dateSpan;c=e&&f}return c},this),"Date span labels are valid")}},{name:"History item state marker connections",test:function(){var c=["tau-marker","tau-marker","tau-marker tau-out","tau-marker","tau-marker","tau-marker","tau-marker tau-in","tau-marker tau-out","tau-marker","tau-marker tau-in tau-out","tau-marker","tau-marker tau-in tau-out","tau-marker","tau-marker tau-in tau-out","tau-marker"];ok(a.all(this.$el.find(".tau-historyGrid td.tau-historyItem"),function(a,d){var e=b(a).find(".tau-progressSteps .tau-step .tau-marker .tau-flow").parent();return e.attr("class")==c[d]}),"Marker connections are valid")}},{name:"Time load",test:function(){var b=a.max(j.historyItems,function(a){return a.spentTime}).spentTime;ok(a.all(j.historyItems,function(a,c){var d=a.spentTime,e=d*100/b,f=Math.round(e/10)*10,g=this.$el.find(".tau-historyGrid td.tau-historyItem .tau-date").eq(c),h=g.hasClass("tau-timeLoad-"+f),i=g.attr("title")==d+" hours";return h&&i},this),"Time load indicators are valid")}},{name:"Related Entities",test:function(){var a=this.$el.find(".tau-historyGrid td.tau-historyItem");ok(a.eq(8).find(".tau-relatedEntities .tau-entity.tau-x-entity").size()==1&&a.eq(10).find(".tau-relatedEntities .tau-entity.tau-x-entity.tau-closed").size()==1,"Related entities are valid")}},{name:"Assignments",test:function(){ok(a.all(j.historyItems,function(b,c){var d=!0;return b.assignments&&(d=a.all(b.assignments,function(a,b){var d=this.$el.find(".tau-historyGrid td.tau-historyItem").eq(c).find(".tau-assignments img").eq(b),e=[a.firstName,a.lastName,"("+a.role+")"].join(" "),f=d.size()==1,g=d.attr("title")==e;return f&&g},this)),d},this),"Assignments are valid")}}],m=g.create("[component.implementationHistory]",c,e,d);h.create(m,d).done()};return{run:j}})