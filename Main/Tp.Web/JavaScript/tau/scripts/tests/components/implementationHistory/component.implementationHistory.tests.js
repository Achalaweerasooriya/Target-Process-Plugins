define(["Underscore","jQuery","tau/core/class","tau/configurator","tau/components/component.implementationHistory","tests/common/testData","tests/components/common/common.setup","tests/components/component.specs","tests/common/applicationContext"],function(_,$,Class,configurator,implementationHistoryComponent,testData,commonSetup,componentSpecs,AppCtx){var innerRun=function(){var data=testData.getImplementationHistoryData(),context={context:{id:15,type:"story",applicationContext:new AppCtx}},expectedData={entityStates:["Five","Four","Three","Two","One"],historyItems:[{date:"2011-08-26T09:00:00",spentTime:0,transitions:0,state:{name:"One",dateSpan:6,isInitial:!0,isFinal:!1}},{date:"2011-08-29T09:00:00",spentTime:0,transitions:2,state:{name:"One",isInitial:!0,isFinal:!1}},{date:"2011-08-30T09:00:00",spentTime:0,transitions:1,state:{name:"One",isInitial:!0,isFinal:!1}},{date:"2011-09-01T09:00:00",spentTime:0,transitions:1,state:{name:"Three",dateSpan:3,isInitial:!1,isFinal:!1},assignments:[{id:1,firstName:"John",lastName:"Connor",role:"Leader"}]},{date:"2011-09-02T09:00:00",spentTime:0,transitions:0,state:{name:"Three",isInitial:!1,isFinal:!1}},{date:"2011-09-03T09:00:00",spentTime:0,transitions:0,state:{name:"Three",isInitial:!1,isFinal:!1},assignments:[{id:2,firstName:"Frodo",lastName:"Baggins",role:"Hobbit"}]},{date:"2011-09-04T09:00:00",spentTime:0,transitions:1,state:{name:"Two",dateSpan:2,isInitial:!1,isFinal:!1}},{date:"2011-09-05T09:00:00",spentTime:0,transitions:0,state:{name:"Two",isInitial:!1,isFinal:!1}},{date:"2011-09-06T09:00:00",spentTime:3,transitions:3,state:{name:"Three",dateSpan:1,isInitial:!1,isFinal:!1},relatedEntities:{opened:[{id:1,type:"x-entity",name:"Foo"}]}},{date:"2011-09-07T09:00:00",spentTime:0,transitions:1,state:{name:"Two",dateSpan:1,isInitial:!1,isFinal:!1}},{date:"2011-09-08T09:00:00",spentTime:8,transitions:1,state:{name:"Three",dateSpan:1,isInitial:!1,isFinal:!1},relatedEntities:{closed:[{id:1,type:"x-entity",name:"Foo"}]},assignments:[{id:1,firstName:"John",lastName:"Connor",role:"Leader"}]},{date:"2011-09-09T09:00:00",spentTime:0,transitions:1,state:{name:"One",dateSpan:2,isInitial:!0,isFinal:!1}},{date:"2011-09-11T09:00:00",spentTime:0,transitions:1,state:{name:"Three",dateSpan:1,isInitial:!1,isFinal:!1}},{date:"2011-09-12T09:00:00",spentTime:0,transitions:1,state:{name:"One",dateSpan:1,isInitial:!0,isFinal:!1}},{date:"2011-09-13T09:00:00",spentTime:0,transitions:1,state:{name:"Five",isInitial:!1,isFinal:!0}}]},expectedCmdArray=[Similar.to({name:"get",type:"implementationHistory",config:Like.is({id:context.context.id,fields:["id","statistics"]})}),Similar.to({name:"get",type:"process",config:Like.is({id:context.context.applicationContext.processes[0].id,fields:["id",Similar.to({entityStates:["id","name","isInitial","isFinal",Similar.to({entityType:["id","name"]})]})]})}),Similar.to({name:"get",type:"project",config:Like.is({id:context.context.applicationContext.selectedProjects[0].id,fields:["id",Similar.to({projectMembers:["id",Similar.to({user:["id","firstName","lastName"]}),Similar.to({role:["id","name"]})]})]})})],viewTests=[{name:"Template frame markup",test:function(){ok(this.$el.hasClass("tau-implementationHistory"),"Frame has valid root class");var $historyGridInterpretation=this.$el.find("> .tau-historyGridInterpretation");ok($historyGridInterpretation.size()==1,"Frame has container for the history grid interpretation");var $historyGrid=this.$el.find("> .tau-historyGrid");ok($historyGrid.size()==1,"Frame has container for the history grid"),ok($historyGrid.find("> table > tbody > tr").size()==1,"History grid container has valid structure")}},{name:"History grid interpretation elements",test:function(){var $historyGridInterpretation=this.$el.find("> .tau-historyGridInterpretation");ok(_.all(expectedData.entityStates,function(state,index){return $historyGridInterpretation.find("> div:nth-child("+(index+1)+")").text()==state}),"A set of step-related labels is found"),ok($historyGridInterpretation.find("> div:nth-child("+(expectedData.entityStates.length+1)+")").text()=="Date","Label for date is found"),ok($historyGridInterpretation.find("> div:nth-child("+(expectedData.entityStates.length+2)+")").text()=="Related Entities","Label for related entities is found")}},{name:"History items count",test:function(){ok(this.$el.find(".tau-historyGrid td.tau-historyItem").size()==expectedData.historyItems.length,"History items count is valid")}},{name:"History item state progress steps",test:function(){var entityStatesCount=expectedData.entityStates.length;ok(_.all(this.$el.find(".tau-historyGrid td.tau-historyItem"),function(historyItemElement){var $historyItemSteps=$(historyItemElement).find("> .tau-progressSteps > .tau-step > .tau-marker");return entityStatesCount==$historyItemSteps.size()}),"Progress steps count is valid")}},{name:"History item date",test:function(){ok(_.all(this.$el.find(".tau-historyGrid td.tau-historyItem"),function(historyItemElement,index){var $date=$(historyItemElement).find("> .tau-date"),dateElementIsFound=$date.size()==1,dayIsValid=$date.find("> .tau-day").text()==dateFormat(expectedData.historyItems[index].date,"dd"),monthIsValid=$date.find("> .tau-month").text()==dateFormat(expectedData.historyItems[index].date,"MMM");return dateElementIsFound&&dayIsValid&&monthIsValid}),"Date is valid")}},{name:"Related entities container",test:function(){ok(_.all(this.$el.find(".tau-historyGrid td.tau-historyItem"),function(historyItem){return $(historyItem).find("> .tau-relatedEntities").size()==1}),"Container is found")}},{name:"History item state markers",test:function(){ok(_.all(this.$el.find(".tau-historyGrid td.tau-historyItem"),function(historyItemElement,index){var historyItemData=expectedData.historyItems[index],historyItemStateIndex=_.indexOf(expectedData.entityStates,historyItemData.state.name),$historyItemActiveStep=$(historyItemElement).find(".tau-progressSteps .tau-step").eq(historyItemStateIndex),expectedFlowClass="tau-normal";historyItemData.transitions>1&&(expectedFlowClass="tau-transitions"),historyItemData.state.isFinal&&(expectedFlowClass="tau-done");var markerIsFound=$historyItemActiveStep.find(".tau-marker").size()==1,flowIsValid=$historyItemActiveStep.find(".tau-marker .tau-flow").hasClass(expectedFlowClass);return markerIsFound&&flowIsValid}),"State markers are valid")}},{name:"History item state markers date span",test:function(){ok(_.all(expectedData.historyItems,function(historyItem,index){var truthTest=!0;if(historyItem.state.dateSpan){var $flow=this.$el.find(".tau-historyGrid td.tau-historyItem").eq(index).find(".tau-progressSteps .tau-flow"),flowHasValidLabel=$flow.text()==historyItem.state.dateSpan,flowHasValidTitle=$flow.attr("title")==historyItem.state.dateSpan;truthTest=flowHasValidLabel&&flowHasValidTitle}return truthTest},this),"Date span labels are valid")}},{name:"History item state marker connections",test:function(){var expectedClassAttrs=["tau-marker","tau-marker","tau-marker tau-out","tau-marker","tau-marker","tau-marker","tau-marker tau-in","tau-marker tau-out","tau-marker","tau-marker tau-in tau-out","tau-marker","tau-marker tau-in tau-out","tau-marker","tau-marker tau-in tau-out","tau-marker"];ok(_.all(this.$el.find(".tau-historyGrid td.tau-historyItem"),function(historyItemElement,index){var $marker=$(historyItemElement).find(".tau-progressSteps .tau-step .tau-marker .tau-flow").parent();return $marker.attr("class")==expectedClassAttrs[index]}),"Marker connections are valid")}},{name:"Time load",test:function(){var maxTimeLoad=_.max(expectedData.historyItems,function(historyItem){return historyItem.spentTime}).spentTime;ok(_.all(expectedData.historyItems,function(historyItem,index){var actualTimeload=historyItem.spentTime,relatedTimeLoad=actualTimeload*100/maxTimeLoad,roundedTimeLoad=Math.round(relatedTimeLoad/10)*10,$timeLoadIndicator=this.$el.find(".tau-historyGrid td.tau-historyItem .tau-date").eq(index),timeIndicatorHasValidClass=$timeLoadIndicator.hasClass("tau-timeLoad-"+roundedTimeLoad),timeIndicatorHasValidTitle=$timeLoadIndicator.attr("title")==actualTimeload+" hours";return timeIndicatorHasValidClass&&timeIndicatorHasValidTitle},this),"Time load indicators are valid")}},{name:"Related Entities",test:function(){var $historyItems=this.$el.find(".tau-historyGrid td.tau-historyItem");ok($historyItems.eq(8).find(".tau-relatedEntities .tau-entity.tau-x-entity").size()==1&&$historyItems.eq(10).find(".tau-relatedEntities .tau-entity.tau-x-entity.tau-closed").size()==1,"Related entities are valid")}},{name:"Assignments",test:function(){ok(_.all(expectedData.historyItems,function(historyItem,historyItemIndex){var truthTest=!0;return historyItem.assignments&&(truthTest=_.all(historyItem.assignments,function(assignment,assignmentIndex){var $assignment=this.$el.find(".tau-historyGrid td.tau-historyItem").eq(historyItemIndex).find(".tau-assignments img").eq(assignmentIndex),expectedTitle=[assignment.firstName,assignment.lastName,"("+assignment.role+")"].join(" "),assignmentElementIsFound=$assignment.size()==1,assignmentElementHasValidTitle=$assignment.attr("title")==expectedTitle;return assignmentElementIsFound&&assignmentElementHasValidTitle},this)),truthTest},this),"Assignments are valid")}}],setup=commonSetup.create("[component.implementationHistory]",data,implementationHistoryComponent,context);componentSpecs.create(setup,context).done()};return{run:innerRun}})