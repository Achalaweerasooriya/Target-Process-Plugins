define(["Underscore","jQuery","tests/common/service.mock","tau/core/class","tau/configurator","tau/components/component.comments","tests/common/testData","tests/components/common/common.setup","tests/components/component.specs","tau/components/component.commentList","tau/components/component.comment","tau/components/component.comment.new.editor"],function(a,b,c,d,e,f,g,h,i){var j=function(){function d(){var a=g.getDataForComments(),c=[];for(var d=0;d<a.length;d++)c.push(b.extend(!0,{},a[d]));return c}function n(a){var b=a.find("> .ui-comment-body > .ui-comment-heading > .ui-comment-menu > .delete");return b}function o(a){var b=a.find("> .ui-comment-body > .ui-comment-heading > .ui-comment-menu > .edit");return b}function p(a){var b=a.find("> .ui-comment-body > .ui-comment-heading > .ui-comment-menu > .reply");return b}function q(a){p(a).click();var b=a.find("> .ui-comment-body > .ui-comment-reply > .ui-richeditor");return equals(b.size(),1,"Editor for reply is presented"),b}function r(a,c){c.isRequester?ok(a.find(">.ui-comment-body").hasClass("tau-comments-requester"),"Marked as comment from requestor"):ok(!a.find(">.ui-comment-body").hasClass("tau-comments-requester"),"Not marked as comment from requestor"),equals(a.find(">.ui-comment-body >.ui-comment-heading > .ui-comment-name").text(),c.name,"Name is valid"),equals(a.find(">.ui-comment-body >.ui-comment-heading > .ui-comment-ago").text(),"("+c.age+")","Age is valid");var d=a.find(">.ui-comment-body >.ui-comment-text").html().toLowerCase(),e=b("<p>"+c.description+"</p>").html().toLowerCase();equals(d,e,"Description is valid"),c.isOwnerComment&&ok(a.find(">.ui-comment-body").is(".ui-commets-comment-owner"),"Owner comment is valid")}function s(a){var b=a.find(".ui-comments-add-link");equals(b.size(),1,"Add comment link is added"),ok(b.css("display")!=="none","Link is visible"),b.click(),ok(b.css("display")==="none","Link is hidden");var c=b.next().find(".ui-richeditor");return c}function t(a){var b=a.find(".ui-comments-add-link");equals(b.size(),1,"Add comment link is added"),ok(b.css("display")!=="none","Link is visible"),b.click(),ok(b.css("display")==="none","Link is hidden");var c=b.next().find(".ui-richeditor");equals(c.size(),1,"Rich editor is introduced"),c.find(".ui-richeditor__controls__cancel").click(),ok(b.css("display")!=="none","Link is visible again"),c=b.next().find(".ui-richeditor"),equals(c.size(),0,"Rich editor is removed")}function u(a){return a.find(">.ui-comment-body >.ui-richeditor")}function v(a){return a.find(".ui-richeditor__controls__save")}function w(a){return a.find(".ui-richeditor__controls__cancel")}function x(a){var b=a.find("> .ui-comment-body > .ui-comment-heading > .ui-comment-menu > .delete");b.click();var c=a.find(".ui-comment-body .confirmation");equals(c.size(),1,"Confirmation is displayed"),c.find(".cancel").click(),c=a.find(".ui-comment-body .confirmation"),equals(c.size(),0,"Confirmation is removed"),b.click(),c=a.find(".ui-comment-body .confirmation"),equals(c.size(),1,"Confirmation is displayed"),c.find(".ok").click()}function y(a){return function(b){var d=this.service=new c;e.setService(d);var f=a.length;for(var g=0;g<f;g++){var h=a[g],i=h.command,j=h.setup||function(){},k=h.stub||function(){};k._test=this,j.call(this,i,h)}}}function z(a){return{command:a,setup:function(a){a._test=this,this.service.registerGetCommand(a)}}}function A(a){return{command:a,setup:function(a){a._test=this,this.service.registerSaveCommand(a)}}}function B(a){return{command:a,setup:function(a){a._test=this,this.service.registerRemoveCommand(a)}}}function C(b,c){c=c||"<p>Updated text</p>",b=b||a.clone(k[0].comments[3]);var d=b.id;return y([A({config:{id:d,$set:{description:c,general:{id:152}},fields:D},returnedData:a.extend(b,{description:c}),preCheck:"isMarkedAsUpdating"})])}var j=d(),k=d(),l=e.getCurrentDate(),m={items:[{id:450,parentId:null,avatar:"/TP/Avatar.ashx?UserId=13&size=32",name:"",description:"First Comment",age:"1 month ago",comments:[{id:451,parentId:450,avatar:"/TP/Avatar.ashx?UserId=256&size=32",name:"Andrew G.",description:"First reply to First Comment <img src='/TP/#Attachment.aspx?AttachmentID=12'/>",age:"2 hours ago",comments:[],deleted:!1,isRequester:!1},{id:452,parentId:450,avatar:"/TP/Avatar.ashx?UserId=254&size=32",name:"John B.",description:"Second reply to First Comment",age:"25 min ago",comments:[],deleted:!1,isRequester:!1}],deleted:!1,isRequester:!0},{id:453,parentId:null,avatar:"/TP/Avatar.ashx?UserId=255&size=32",name:"Tod B.",description:"Second comment",age:"23 days ago",comments:[{id:454,parentId:453,avatar:"/TP/Avatar.ashx?UserId=257&size=32",name:"Sandra R.",description:"Reply to second comment",age:"25 sec ago",comments:[],deleted:!1,isRequester:!1}],deleted:!1,isRequester:!1}]},D=["id","description","createDate","parentId",{owner:["id","firstName","lastName","kind"]}],E=[{name:"should render valid markup",test:function(){var a=this.$el,b=a.find(".ui-all-comments > .ui-comment");equals(b.length,2,"Count of root comments is valid");var c=this.data.items;r(b.eq(0),c[0]);var d=b.eq(0).find(".ui-comments > .ui-comment");equals(d.length,2,"Count of replay on first comment is valid"),r(d.eq(0),c[0].comments[0]),r(d.eq(1),c[0].comments[1]);var e=b.eq(1).find(".ui-comments > .ui-comment");equals(e.length,1,"Count of replay on second comment is valid"),r(e.eq(0),c[1].comments[0]),t(a)}},{name:"should apply editable and deletable permissions",test:function(){var a=this.$el,b=a.find(".ui-all-comments .ui-comment");equals(b.length,5,"Count of comments");for(var c=0,d=b.length-1;c<d;c++){var e=b.eq(c).find("> .ui-comment-body"),f=e.find(".ui-comment-heading > .ui-comment-menu ");ok(e.hasClass("editable"),"Marked as editable"),ok(e.hasClass("deletable"),"Marked as deletable"),equals(f.find(".reply").length,1,"Reply button is added"),equals(f.find(".edit").length,1,"Edit button is added"),equals(f.find(".delete").length,1,"Delete button is added");var g=e.find(".ui-comment-reply > .ui-editor-placeholder");equals(g.size(),1,"Place holder for reply is presented"),equals(g.css("display"),"none","Reply placeholder display")}t(a)}},{name:"should save comment (success)",preSetup:C(),test:function(){var a=this.$el,c=a.find(".ui-comment").eq(4),d=c.find(".ui-comment-menu .edit");this.isMarkedAsUpdating=function(a){ok(c.hasClass("updating"),"Marked as updating")},d.click();var e=u(c);equals(e.size(),1,"Editor is presented");var f="<p>Updated text</p>";e.find("textarea").val(f),v(e).click(),c=this.$el.find(".ui-comment").eq(4);var g=c.find("> .ui-comment-body > .ui-comment-text");equals(g.html().toLowerCase(),f.toLowerCase(),"Comment text is updated"),ok(!c.children(".ui-comment-body").hasClass("updating"),"Not marked as updating"),equals(u(c).length,0,"Count of editors"),ok(!b.contains(g[0],e[0]),"Editor is removed"),d=c.find(".ui-comment-menu .edit"),d.click(),e=u(c),equals(e.find("textarea").val().toLowerCase(),f.toLowerCase(),"Template data is up to date")}},{name:"should reply to comment",preSetup:y([A({config:{$set:{description:"<p>Updated text</p>",parentId:454,general:{id:152}},fields:D},returnedData:{id:64,description:"<p>Updated text</p>",createDate:l,parentId:454,owner:{id:23,firstName:"Administrator",lastName:"Administrator",kind:"user"}},preCheck:"isMarkedAsUpdating"})]),test:function(){var a=this.$el;e.setCurrentDate(l);var c=a.find(".ui-comment").eq(4),d=q(c);this.isMarkedAsUpdating=function(a){var b=c.find("> .ui-comments").children().last();ok(b.hasClass("updating"),"Marked as updating");var d=b.find("> .ui-comment-heading");equals(d.find("> .ui-comment-menu > .edit").size(),0,"Edit button"),equals(d.find("> .ui-comment-menu > .delete").size(),0,"Delete button")};var f="<p>Updated text</p>";d.find("textarea").val(f);var g=v(d);equals(g.text(),"Add Reply","Text of reply button"),g.click();var h=this.$el.find(".ui-comment").eq(5),i=h.find("> .ui-comment-body"),j=i.find("> .ui-comment-heading"),k=j.find("> .ui-comment-ago");equals(k.text(),"(Just added)","Creation date label"),equals(j.find("> .ui-comment-menu > .edit").size(),1,"Edit button"),equals(j.find("> .ui-comment-menu > .delete").size(),1,"Delete button");var m=i.find("> .ui-comment-text");equals(m.html().toLowerCase(),f.toLowerCase(),"Comment text is updated"),equals(u(h).size(),0,"Count of editors"),ok(!b.contains(h[0],d[0]),"Editor is removed")}},{name:"should cancel draft reply to comment",test:function(){var a=this.$el,b=a.find(".ui-comment").eq(4),c=q(b),d=w(c);d.click(),ok(c.css("display")==="none","Editor is hidden")}},{name:"should has one editor instance opened for edit/reply/add comments",test:function(){var a=this.$el,b=a.find(".ui-comment").eq(4);ok(!0,"--------- Click reply ---------"),p(b).click();var c=b.find("> .ui-comment-body > .ui-comment-reply > .ui-richeditor");equals(c.size(),1,"Editor for reply is presented"),ok(c.css("display")!=="none","Reply Editor is visible"),ok(!0,"--------- Click edit ---------"),o(b).click(),ok(c.css("display")==="none","Reply Editor is hidden");var d=b.find("> .ui-comment-body > .ui-richeditor");equals(d.size(),1,"Edit Editor is presented"),ok(d.css("display")!=="none","Edit Editor is visible"),ok(!0,"--------- Click add comment link ---------"),t(a),ok(d.css("display")==="none","Edit Editor is hidden")}},{name:"should support delete operation (comments tree leaf)",preSetup:y([B({config:{id:454,fields:["id"]},preCheck:"isMarkedAsDeleting"})]),test:function(){var a=this.$el,b=a.find(".ui-comment").eq(4);this.isMarkedAsDeleting=function(a){ok(b.hasClass("deleting"),"Marked as deleting")},equals(a.find(".ui-comment").size(),5,"Amount of comments before delete"),x(b),equals(this.$el.find(".ui-comment").size(),4,"Amount of comments after delete")}},{name:"should support delete operation (parent comment)",preSetup:C(k[0].comments[0],"DELETED"),test:function(){var a=this.$el,b=a.find(".ui-comment").eq(0);this.isMarkedAsUpdating=function(a){ok(b.hasClass("updating"),"Marked as updating")},x(b),b=this.$el.find(".ui-comment").eq(0),equals(b.find(".ui-comment-body").html().trim(),"DELETED","Text is changed")}},{name:"should add new comment",preSetup:y([A({config:{$set:{description:"Just added comment",general:{id:j[0].id}},fields:D},returnedData:a(a.clone(k[0].comments[1])).extend({id:10,description:"Just added comment",createDate:l}),preCheck:"isMarkedAsUpdating"})]),test:function(){var b=this.$el;e.setCurrentDate(l);var c=a.clone(k[0].comments[1]);a(c).extend({id:10,description:"Just added comment",createDate:e.getCurrentDate()}),this.isMarkedAsUpdating=function(a){ok(b.find(".ui-all-comments").children().last().hasClass("updating"),"Marked as updating")};var d=s(b),f=b.find(".ui-comment").size();equals(f,5,"Original amount of comments");var g=d.find("textarea");g.val("Just added comment");var h=v(d);h.click();var i=this.$el.find(".ui-comment").size();equals(i,6,"New amount of comments");var j=this.$el.find(".ui-comment").last();r(j,{name:"Tod B.",description:c.description,age:"Just added"}),t(this.$el)}},{name:"should mark comment as DELETED after new child comment adding",preSetup:y([A({config:{$set:{description:"Just added comment",parentId:454,general:{id:j[0].id}},fields:D},returnedData:a(a.clone(k[0].comments[3])).extend({id:100,description:"Just added comment",createDate:e.getCurrentDate(),parentId:454})}),A({config:{$set:{description:"DELETED",general:{id:152}},fields:D,id:454},returnedData:a(a.clone(k[0].comments[3])).extend({description:"DELETED"})})]),test:function(){var a=this.$el,b=a.find(".ui-comment").size();equals(b,5,"Amount before");var c=a.find(".comment-id-454");equals(c.find(".ui-comment-text").eq(0).text().trim(),"Reply to second comment","Original comment text");var d=q(c);d.find("textarea").val("Just added comment"),v(d).click(),equals(this.$el.find(".ui-comment").size(),6,"Amount after reply"),c=this.$el.find(".comment-id-454"),equals(c.find(".ui-comment-text").eq(0).text().trim(),"Reply to second comment","Original comment text"),x(c);var e=this.$el.find(".ui-comment").size();equals(e,6,"Amount after delete"),c=this.$el.find(".comment-id-454"),equals(c.find(".ui-comment-body").html().trim(),"DELETED","Text is changed")}},{name:"should delete empty comments branch when the last comment is being deleted",preSetup:y([A({config:{$set:{parentId:454,description:"Just added comment",general:{id:j[0].id}},fields:D},returnedData:a(a.clone(k[0].comments[3])).extend({id:100,description:"Just added comment",createDate:e.getCurrentDate(),parentId:454})}),A({config:{$set:{description:"DELETED",general:{id:152}},fields:D,id:454},returnedData:a(a.clone(k[0].comments[3])).extend({description:"DELETED"})}),B({config:{id:100,fields:["id"]}}),B({config:{id:454,fields:["id"]}})]),test:function(){var a=this.$el.find(".ui-comment").size();equals(a,5,"Amount before");var b=this.$el.find(".comment-id-454");equals(b.find(".ui-comment-text").eq(0).text().trim(),"Reply to second comment","Original comment text");var c=q(b);c.find("textarea").val("Just added comment"),v(c).click(),equals(this.$el.find(".ui-comment").size(),6,"Amount after reply"),b=this.$el.find(".comment-id-454"),equals(b.find(".ui-comment-text").eq(0).text().trim(),"Reply to second comment","Original comment text"),x(b);var d=this.$el.find(".ui-comment").size();equals(d,6,"Amount after delete"),b=this.$el.find(".comment-id-454"),equals(b.find(".ui-comment-body").html().trim(),"DELETED","Text is changed");var e=this.$el.find(".comment-id-100");x(e),a=this.$el.find(".ui-comment").size(),equals(a,4,"Amount after removing comments branch")}},{name:"should apply ID:XXX replacement rule",preSetup:y([A({config:{$set:{description:"ID:111 as well as the text id:123 should be replaced with link. And also <b>this</b>Id:777 and this Id:    777 and id:&nbsp; 111",general:{id:j[0].id}},fields:D},returnedData:a(a.clone(k[0].comments[1])).extend({id:10,description:"ID:111 as well as the text id:123 should be replaced with link. And also <b>this</b>Id:777 and this Id:    777 and id:&nbsp; 111",createDate:e.getCurrentDate()}),preCheck:"isMarkedAsUpdating"}),z({config:{id:"111",fields:["id","name",{entityType:["id","name"]}],silent:!0},returnedData:{id:111,name:"Entity 111",entityType:{id:1,name:"task"}}}),z({config:{id:"123",fields:["id","name",{entityType:["id","name"]}],silent:!0},returnedData:{id:123,name:"Entity 123",entityType:{id:1,name:"task"}}}),z({config:{id:"777",fields:["id","name",{entityType:["id","name"]}],silent:!0},returnedData:{id:777,name:"Entity 777",entityType:{id:1,name:"task"}}})]),test:function(){var a=this,b=this.$el;this.isMarkedAsUpdating=function(a){ok(b.find(".ui-all-comments").children().last().hasClass("updating"),"Marked as updating")};var c=s(b),d=b.find(".ui-comment").size();equals(d,5,"Original amount of comments");var e=c.find("textarea");e.val("ID:111 as well as the text id:123 should be replaced with link. And also <b>this</b>Id:777 and this Id:    777 and id:&nbsp; 111");var f=v(c);f.click();var g=this.$el.find(".comment-id-10"),h=g.find(".ui-comment-text a");equals(h.eq(0).html(),"#111&nbsp;Entity 111","Entity 111"),equals(h.eq(1).html(),"#123&nbsp;Entity 123","Entity 123"),equals(h.eq(2).html(),"#777&nbsp;Entity 777","Entity 777"),equals(h.eq(3).html(),"#777&nbsp;Entity 777","Entity 777"),equals(h.eq(4).html(),"#111&nbsp;Entity 111","Entity 111"),o(g).click();var i=g.find("textarea").val();equals(i,"ID:111 as well as the text id:123 should be replaced with link. And also <b>this</b>Id:777 and this Id:    777 and id:&nbsp; 111","Original text (without links) is restored for edit"),g.find(".ui-richeditor__controls__cancel").click(),h=g.find(".ui-comment-text a"),equals(h.length,5,"Entity links as are")}}],F=h.create("[component.comments]",d,f);i.create(F,{context:{type:"bug",id:j[0].id}}).viewShouldFollowDataComponentLifeCycle().viewShouldPassTests(E).done()};return{run:j}})