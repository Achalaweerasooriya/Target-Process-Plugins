define(["tp/mashups","user/mashups","tau/core/global.bus","Underscore","tau/core/bus.reg","tau/core/event"],function(Mashups,um,gb,_,busRegistry,EventClass){var mashups=new Mashups,isSignedUp=!1,fnCriterionForViewMashups=function(mashup){for(var i=0;i<mashup.libs.length;i++){var lib=mashup.libs[i],libPath=lib.toLowerCase();if(libPath.indexOf("/view")>0||libPath.indexOf("iew")>0)return!0}return!1},api={init:function(){startViewIntegration()},onInit:function(callback){mashups.onMashupsLoaded(fnCriterionForViewMashups).done(callback)}},getMarkup=function(controlToAdd){return{header:[{name:controlToAdd.id,type:"label",text:controlToAdd.name}],items:[{name:controlToAdd.id,type:"container"}]}},appendTab=function(controlToAdd,tabsConfig){var tabItem={label:controlToAdd.name,name:"parent:"+controlToAdd.id};tabsConfig.tabs.push(_.extend(tabItem,getMarkup(controlToAdd)))},appendBlock=function(controlToAdd,config){var item={type:"collapsible",name:"parent:"+controlToAdd.id,collapsed:!0,stateName:controlToAdd.name.toLowerCase().replace(" ","")};config.children.push(_.extend(item,getMarkup(controlToAdd)))},getTabsConfig=function(evt){var tabsConfig=_.jsonSelect(evt.data.children,':has(:root>.type:val("tabs"))');return tabsConfig.length===0&&(tabsConfig={tabs:[]}),tabsConfig=tabsConfig[0],tabsConfig},getInfoColumnConfig=function(evt){var config=_.jsonSelect(evt.data.children,':has(:root>.name:val("additional info column container"))');return config.length===0&&(config={children:[]}),config=config[0],config},startViewIntegration=function(){if(isSignedUp)return;isSignedUp=!0,busRegistry.getByName("entity component",function(bus){var listener={bus:bus,"bus before_contextRetrieved":function(evt){evt.suspendMain(),api.onInit(function(){evt.resumeMain()})}};EventClass.subscribeOn(listener)});var bus=gb.get();bus.on("afterRender",function(evt){var controlsToAdd=mashups.controls.view,name=evt.caller.name,data=evt.data||{element:{addClass:function(){}},data:{view:{config:{context:{entity:{}}}}}};if(controlsToAdd.hasOwnProperty(name)){var contextEntity=data.view.config.context,entityId=contextEntity.entity.id,ctrl=controlsToAdd[name],context={entity:{id:entityId,type:ctrl.type}},isHeader=data.view.config.type==="label",fnCreate=isHeader?"onCreateHeader":"onCreateContent";isHeader||data.element.addClass("ui-custom-control-content"),ctrl[fnCreate](data.element,context)}if(name==="entity component"){var entity=data.view.config.entity,element=data.element,subscriptions=mashups.subscriptions.view,type=entity.type.toLowerCase();if(subscriptions.hasOwnProperty(type))for(var i=0;i<subscriptions[type].length;i++)subscriptions[type][i](element,{context:entity})}}),bus.on("onConfigContainerCreated",function(evt){var controlsToAdd=mashups.controls.view,values=_.values(controlsToAdd),tabsConfig=null,blocksConfig=null;for(var i=0;i<values.length;i++){var controlToAdd=values[i],entity=evt.data.context.entity;if(controlToAdd.type.toLowerCase()!==entity.entityType.name.toLowerCase())continue;if(controlToAdd.control==="tab"){tabsConfig||(tabsConfig=getTabsConfig(evt)),appendTab(controlToAdd,tabsConfig);continue}controlToAdd.control==="block"&&(blocksConfig||(blocksConfig=getInfoColumnConfig(evt)),appendBlock(controlToAdd,blocksConfig))}})};return api})