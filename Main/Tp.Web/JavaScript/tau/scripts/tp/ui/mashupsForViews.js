define(["tp/mashups","user/mashups","tau/core/global.bus","Underscore","tau/core/bus.reg","tau/core/event"],function(n,e,t,o,i,a){var r=new n,c=!1,s={element:{addClass:function(){}},view:{config:{context:{entity:{id:null,entityType:{name:null}}}}}},l=function(n){for(var e=0,t=n.libs.length;t>e;e++){var o=n.libs[e],i=o.toLowerCase();if(i.indexOf("/view")>0||i.indexOf("iew")>0)return!0}return!1},u={init:function(){L()},onInit:function(n){r.onMashupsLoaded(l).done(n)}},d=function(n){return{header:[{name:n.id,type:"label",text:n.name}],items:[{name:n.id,type:"container"}]}},f=function(n,e){var t={label:n.name,name:"parent:"+n.id};e.tabs.push(o.extend(t,d(n)))},p=function(n,e){var t={type:"collapsible",name:"parent:"+n.id,collapsed:!0,stateName:n.name.toLowerCase().replace(" ","")},i=o.extend(t,d(n));n.options&&n.options.positionToInsert&&e.children.length&&e.children[0].children&&e.children[0].children.length>=n.options.positionToInsert?e.children[0].children.splice(n.options.positionToInsert,0,i):e.children.push(i)},h=function(n){var e=o.jsonSelect(n.children,':has(:root>.type:val("tabs"))');return 0===e.length&&(e=[{tabs:[]}]),e=e[0]},v=function(n){var e=o.jsonSelect(n.children,':has(:root>.name:val("additional info column container"))');return 0===e.length&&(e=[{children:[]}]),e=e[0]},y=function(n,e){var t=e&&e.getViewIsSuitablePromiseCallback;return t?t({entity:n}):null},m=function(e,t){var i=r.subscriptions.view,a=t.type.toLowerCase(),c=(i[a]||[]).concat(i[n.GENERAL_TYPE]||[]),s=[],l=[];o.forEach(c,function(n){var e=y(t,n.options);e?(l.push(e),e.done(o.bind(function(n,e){e&&s.push(n)},this,n))):s.push(n)});var u=o.bind(function(n,e){o.forEach(s,function(t){t.callback(n,{entity:e})})},this,e,t);l.length>0?$.when.apply(this,l).then(function(){u()}):u()},b=function(n,e,t){var i=w(n,e),a=o.bind(t,this,n);i.length>0?$.whenList(i).done(a):a()},w=function(e,t){for(var i=o.values(t),a=[],r=i.length,c=new Array(r),s=0;r>s;s++){var l=i[s],u=e.context.entity;if(l.type.toLowerCase()===u.entityType.name.toLowerCase()||l.type.toLowerCase()===n.GENERAL_TYPE.toLowerCase()){var d=y(u,l.options);if(d){var f=$.Deferred();a.push(f.promise()),d.done(o.bind(function(n,e,t){t&&(c[n]=e)},this,s,l)).always(f.resolve)}else c[s]=l}}return $.whenList(a).done(o.bind(function(){g(e,o.compact(c))},this)),a},g=function(n,e){var t=null,i=null;o.forEach(e,function(e){"tab"===e.control&&(t||(t=h(n)),f(e,t)),"block"===e.control&&(i||(i=v(n)),p(e,i))})},C=function(n,e){var t=e.view.config.context.entity,i={entity:o.extend(t,{type:t.entityType.name})},a="label"===e.view.config.type,r=a?"onCreateHeader":"onCreateContent";a||e.element.addClass("ui-custom-control-content"),n[r](e.element,i)},L=function(){if(!c){c=!0,i.getByName("entity component",function(n){var e={bus:n,"bus before_contextRetrieved":function(n){n.suspendMain(),u.onInit(function(){n.resumeMain()})}};a.subscribeOn(e)});var n=t.get();n.on("afterRenderAll",function(n){var e=n.caller.name,t=n.data||s;if("entity component"===e){var i=t.element,a=t.view.config.entity,r=o.extend(a,{entityType:{name:a.type}});m(i,r)}}),n.on("afterRender",function(n){var e=r.controls.view,t=n.caller.name,o=n.data||s;e.hasOwnProperty(t)&&C(e[t],o)}),n.on("configReadyForIntegration",function(n){var e=r.controls.view,t=$.Deferred();n.data.integrationReadyPromise=t.promise(),b(n.data,e,function(n){t.resolve(n)})})}};return u});