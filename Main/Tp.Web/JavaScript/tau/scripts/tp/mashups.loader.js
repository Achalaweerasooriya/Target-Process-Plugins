define(["jQuery","Underscore","tp/mashups","libs/parseUri"],function(t,i,e,s){var a=["beforeAppInit"],n={initDeferred:t.Deferred(),loadState:{},initPointsData:{},init:function(){this._setLoadStates(),this._overrideMashupsFunctions();var t=s(location.href).hasQueryKey("nomashups");return t||require(["user/mashups"],function(){this._processRegisteredMashups(),this.initDeferred.resolve()}.bind(this)),this},_setLoadStates:function(){i.each(a,function(i){this.loadState[i]={status:t.Deferred()}},this)},_overrideMashupsFunctions:function(){this.originalFunctions={initializeMashupFolder:e.prototype.initializeMashupFolder},e.prototype.initializeMashupFolder=t.noop},_processRegisteredMashups:function(){var t=e.prototype.getRegisteredMashups();i.each(t,function(t){var i=t.options.initPoint;this.initPointsData[i]||(this.initPointsData[i]={initPoint:i,mashups:[]}),t.mashups.length&&this.initPointsData[i].mashups.push(t)},this)},loadMashups:function(t){this.initDeferred.done(this._loadMashups.bind(this,t))},_loadMashups:function(t){var i=this.initPointsData[t]||{},e=i.mashups||[];i.startTime=Date.now();var s=this._initializeMashups(e);s.done(this._toggleState.bind(this,t))},_initializeMashups:function(e){var s=t.Deferred(),a=e.length,n=[],o=function(){0===a&&s.resolve(n)};return o(),i.each(e,function(t){var i=Date.now();this.originalFunctions.initializeMashupFolder.call(t.ctx),t.initDeferred.done(function(){n.push(t)}),t.initDeferred.always(function(){a--,t.totalTime=Date.now()-i,o()})},this),s},_toggleState:function(t){var i=this.initPointsData[t]||{};this._updateTimingData(i),this._trackMashupsLoad(i),this.loadState[t].status.resolve()},_trackMashupsLoad:function(t){var e={"@":["--exclude-board-context"]},s=i.extend({},e,t);taus.track("mashups.load",s)},_updateTimingData:function(t){t.totalTime=Date.now()-t.startTime,delete t.startTime}};return n});