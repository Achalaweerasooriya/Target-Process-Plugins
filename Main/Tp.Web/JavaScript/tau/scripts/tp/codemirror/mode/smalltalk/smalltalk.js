define(["tp/codemirror/lib/codemirror"],function(CodeMirror){CodeMirror.defineMode("smalltalk",function(config,parserConfig){function chain(stream,state,f){return state.tokenize=f,f(stream,state)}function ret(tp,style){return type=tp,style}function tokenBase(stream,state){var ch=stream.next();return ch=='"'?chain(stream,state,tokenComment(ch)):ch=="'"?chain(stream,state,tokenString(ch)):ch=="#"?(stream.eatWhile(/[\w\$_]/),ret("string","string")):ch=="$"?(stream.next()=="<"&&(stream.eatWhile(/\d/),stream.eat(/\>/)),ret("string","string")):ch=="^"||ch==":"&&stream.eat("=")?ret("operator","operator"):/\d/.test(ch)?(stream.eatWhile(/[\w\.]/),ret("number","number")):/[\[\]()]/.test(ch)?ret(ch,null):(stream.eatWhile(/[\w\$_]/),keywords&&keywords.propertyIsEnumerable(stream.current())?ret("keyword","keyword"):ret("word","variable"))}function tokenString(quote){return function(stream,state){var escaped=!1,next,end=!1;while((next=stream.next())!=null){if(next==quote&&!escaped){end=!0;break}escaped=!escaped&&next=="\\"}if(end||!escaped)state.tokenize=tokenBase;return ret("string","string")}}function tokenComment(quote){return function(stream,state){var next,end=!1;while((next=stream.next())!=null)if(next==quote){end=!0;break}return end&&(state.tokenize=tokenBase),ret("comment","comment")}}function Context(indented,column,type,align,prev){this.indented=indented,this.column=column,this.type=type,this.align=align,this.prev=prev}function pushContext(state,col,type){return state.context=new Context(state.indented,col,type,null,state.context)}function popContext(state){return state.context=state.context.prev}var keywords={"true":1,"false":1,nil:1,self:1,"super":1,thisContext:1},indentUnit=config.indentUnit,type;return{startState:function(basecolumn){return{tokenize:tokenBase,context:new Context((basecolumn||0)-indentUnit,0,"top",!1),indented:0,startOfLine:!0}},token:function(stream,state){var ctx=state.context;stream.sol()&&(ctx.align==null&&(ctx.align=!1),state.indented=stream.indentation(),state.startOfLine=!0);if(stream.eatSpace())return null;var style=state.tokenize(stream,state);return type=="comment"?style:(ctx.align==null&&(ctx.align=!0),type=="["?pushContext(state,stream.column(),"]"):type=="("?pushContext(state,stream.column(),")"):type==ctx.type&&popContext(state),state.startOfLine=!1,style)},indent:function(state,textAfter){if(state.tokenize!=tokenBase)return 0;var firstChar=textAfter&&textAfter.charAt(0),ctx=state.context,closing=firstChar==ctx.type;return ctx.align?ctx.column+(closing?0:1):ctx.indented+(closing?0:indentUnit)},electricChars:"]"}}),CodeMirror.defineMIME("text/x-stsrc",{name:"smalltalk"})})