define(["tp/codemirror/lib/codemirror"],function(CodeMirror){CodeMirror.defineMode("ruby",function(config,parserConfig){function wordObj(words){var o={};for(var i=0,e=words.length;i<e;++i)o[words[i]]=!0;return o}function chain(newtok,stream,state){return state.tokenize.push(newtok),newtok(stream,state)}function tokenBase(stream,state){curPunc=null;if(stream.sol()&&stream.match("=begin")&&stream.eol())return state.tokenize.push(readBlockComment),"comment";if(stream.eatSpace())return null;var ch=stream.next();if(ch=="`"||ch=="'"||ch=='"'||ch=="/")return chain(readQuoted(ch,"string",ch=='"'),stream,state);if(ch=="%"){var style,embed=!1;stream.eat("s")?style="atom":stream.eat(/[WQ]/)?(style="string",embed=!0):stream.eat(/[wxqr]/)&&(style="string");var delim=stream.eat(/[^\w\s]/);return delim?(matching.propertyIsEnumerable(delim)&&(delim=matching[delim]),chain(readQuoted(delim,style,embed,!0),stream,state)):"operator"}if(ch=="#")return stream.skipToEnd(),"comment";if(ch=="<"&&stream.eat("<")){stream.eat("-"),stream.eat(/[\'\"\`]/);var match=stream.match(/^\w+/);return stream.eat(/[\'\"\`]/),match?chain(readHereDoc(match[0]),stream,state):null}if(ch=="0")return stream.eat("x")?stream.eatWhile(/[\da-fA-F]/):stream.eat("b")?stream.eatWhile(/[01]/):stream.eatWhile(/[0-7]/),"number";if(/\d/.test(ch))return stream.match(/^[\d_]*(?:\.[\d_]+)?(?:[eE][+\-]?[\d_]+)?/),"number";if(ch=="?"){while(stream.match(/^\\[CM]-/));return stream.eat("\\")?stream.eatWhile(/\w/):stream.next(),"string"}return ch==":"?stream.eat("'")?chain(readQuoted("'","atom",!1),stream,state):stream.eat('"')?chain(readQuoted('"',"atom",!0),stream,state):(stream.eatWhile(/[\w\?]/),"atom"):ch=="@"?(stream.eat("@"),stream.eatWhile(/[\w\?]/),"variable-2"):ch=="$"?(stream.next(),stream.eatWhile(/[\w\?]/),"variable-3"):/\w/.test(ch)?(stream.eatWhile(/[\w\?]/),stream.eat(":")?"atom":"ident"):ch!="|"||!state.varList&&state.lastTok!="{"&&state.lastTok!="do"?/[\(\)\[\]{}\\;]/.test(ch)?(curPunc=ch,null):ch=="-"&&stream.eat(">")?"arrow":/[=+\-\/*:\.^%<>~|]/.test(ch)?(stream.eatWhile(/[=+\-\/*:\.^%<>~|]/),"operator"):null:(curPunc="|",null)}function tokenBaseUntilBrace(){var depth=1;return function(stream,state){if(stream.peek()=="}"){depth--;if(depth==0)return state.tokenize.pop(),state.tokenize[state.tokenize.length-1](stream,state)}else stream.peek()=="{"&&depth++;return tokenBase(stream,state)}}function readQuoted(quote,style,embed,unescaped){return function(stream,state){var escaped=!1,ch;while((ch=stream.next())!=null){if(ch==quote&&(unescaped||!escaped)){state.tokenize.pop();break}if(embed&&ch=="#"&&!escaped&&stream.eat("{")){state.tokenize.push(tokenBaseUntilBrace(arguments.callee));break}escaped=!escaped&&ch=="\\"}return style}}function readHereDoc(phrase){return function(stream,state){return stream.match(phrase)?state.tokenize.pop():stream.skipToEnd(),"string"}}function readBlockComment(stream,state){return stream.sol()&&stream.match("=end")&&stream.eol()&&state.tokenize.pop(),stream.skipToEnd(),"comment"}var keywords=wordObj(["alias","and","BEGIN","begin","break","case","class","def","defined?","do","else","elsif","END","end","ensure","false","for","if","in","module","next","not","or","redo","rescue","retry","return","self","super","then","true","undef","unless","until","when","while","yield","nil","raise","throw","catch","fail","loop","callcc","caller","lambda","proc","public","protected","private","require","load","require_relative","extend","autoload"]),indentWords=wordObj(["def","class","case","for","while","do","module","then","unless","catch","loop","proc"]),dedentWords=wordObj(["end","until"]),matching={"[":"]","{":"}","(":")"},curPunc;return{startState:function(){return{tokenize:[tokenBase],indented:0,context:{type:"top",indented:-config.indentUnit},continuedLine:!1,lastTok:null,varList:!1}},token:function(stream,state){stream.sol()&&(state.indented=stream.indentation());var style=state.tokenize[state.tokenize.length-1](stream,state),kwtype;if(style=="ident"){var word=stream.current();style=keywords.propertyIsEnumerable(stream.current())?"keyword":/^[A-Z]/.test(word)?"tag":state.lastTok=="def"||state.lastTok=="class"||state.varList?"def":"variable",indentWords.propertyIsEnumerable(word)?kwtype="indent":dedentWords.propertyIsEnumerable(word)?kwtype="dedent":word=="if"&&stream.column()==stream.indentation()&&(kwtype="indent")}if(curPunc||style&&style!="comment")state.lastTok=word||curPunc||style;return curPunc=="|"&&(state.varList=!state.varList),kwtype=="indent"||/[\(\[\{]/.test(curPunc)?state.context={prev:state.context,type:curPunc||style,indented:state.indented}:(kwtype=="dedent"||/[\)\]\}]/.test(curPunc))&&state.context.prev&&(state.context=state.context.prev),stream.eol()&&(state.continuedLine=curPunc=="\\"||style=="operator"),style},indent:function(state,textAfter){if(state.tokenize[state.tokenize.length-1]!=tokenBase)return 0;var firstChar=textAfter&&textAfter.charAt(0),ct=state.context,closing=ct.type==matching[firstChar]||ct.type=="keyword"&&/^(?:end|until|else|elsif|when)\b/.test(textAfter);return ct.indented+(closing?0:config.indentUnit)+(state.continuedLine?config.indentUnit:0)}}}),CodeMirror.defineMIME("text/x-ruby","ruby")})