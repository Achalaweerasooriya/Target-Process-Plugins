define(["tp/codemirror/lib/codemirror"],function(CodeMirror){CodeMirror.defineMode("stex",function(cmCfg,modeCfg){function pushCommand(state,command){state.cmdState.push(command)}function peekCommand(state){return state.cmdState.length>0?state.cmdState[state.cmdState.length-1]:null}function popCommand(state){if(state.cmdState.length>0){var plug=state.cmdState.pop();plug.closeBracket()}}function applyMostPowerful(state){var context=state.cmdState;for(var i=context.length-1;i>=0;i--){var plug=context[i];if(plug.name=="DEFAULT")continue;return plug.styleIdentifier()}return null}function addPluginPattern(pluginName,cmdStyle,brackets,styles){return function(){this.name=pluginName,this.bracketNo=0,this.style=cmdStyle,this.styles=styles,this.brackets=brackets,this.styleIdentifier=function(content){return this.bracketNo<=this.styles.length?this.styles[this.bracketNo-1]:null},this.openBracket=function(content){return this.bracketNo++,"bracket"},this.closeBracket=function(content){}}}function setState(state,f){state.f=f}function normal(source,state){if(source.match(/^\\[a-z]+/)){var cmdName=source.current();cmdName=cmdName.substr(1,cmdName.length-1);var plug=plugins[cmdName];return typeof plug=="undefined"&&(plug=plugins.DEFAULT),plug=new plug,pushCommand(state,plug),setState(state,beginParams),plug.style}var ch=source.next();if(ch=="%")return setState(state,inCComment),"comment";if(ch=="}"||ch=="]")return plug=peekCommand(state),plug?(plug.closeBracket(ch),setState(state,beginParams),"bracket"):"error";return ch=="{"||ch=="["?(plug=plugins.DEFAULT,plug=new plug,pushCommand(state,plug),"bracket"):/\d/.test(ch)?(source.eatWhile(/[\w.%]/),"atom"):(source.eatWhile(/[\w-_]/),applyMostPowerful(state))}function inCComment(source,state){return source.skipToEnd(),setState(state,normal),"comment"}function beginParams(source,state){var ch=source.peek();if(ch=="{"||ch=="["){var lastPlug=peekCommand(state),style=lastPlug.openBracket(ch);return source.eat(ch),setState(state,normal),"bracket"}return/[ \t\r]/.test(ch)?(source.eat(ch),null):(setState(state,normal),lastPlug=peekCommand(state),lastPlug&&popCommand(state),normal(source,state))}var plugins=new Array;return plugins.importmodule=addPluginPattern("importmodule","tag","{[",["string","builtin"]),plugins.documentclass=addPluginPattern("documentclass","tag","{[",["","atom"]),plugins.usepackage=addPluginPattern("documentclass","tag","[",["atom"]),plugins.begin=addPluginPattern("documentclass","tag","[",["atom"]),plugins.end=addPluginPattern("documentclass","tag","[",["atom"]),plugins.DEFAULT=function(){this.name="DEFAULT",this.style="tag",this.styleIdentifier=function(content){},this.openBracket=function(content){},this.closeBracket=function(content){}},{startState:function(){return{f:normal,cmdState:[]}},copyState:function(s){return{f:s.f,cmdState:s.cmdState.slice(0,s.cmdState.length)}},token:function(stream,state){var t=state.f(stream,state),w=stream.current();return t}}}),CodeMirror.defineMIME("text/x-stex","stex")})