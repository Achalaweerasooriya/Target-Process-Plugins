define(["tp/codemirror/lib/codemirror"],function(CodeMirror){CodeMirror.defineMode("xmlpure",function(config,parserConfig){function chain(stream,state,parser){return state.tokenize=parser,parser(stream,state)}function inBlock(style,terminator,nextTokenize){return function(stream,state){while(!stream.eol()){if(stream.match(terminator)){popContext(state),state.tokenize=nextTokenize;break}stream.next()}return style}}function pushContext(state,tagName){var noIndent=doNotIndent.hasOwnProperty(tagName)||state.context&&state.context.doIndent,newContext={tagName:tagName,prev:state.context,indent:state.context?state.context.indent+indentUnit:0,lineNumber:state.lineNumber,indented:state.indented,noIndent:noIndent};state.context=newContext}function popContext(state){if(state.context){var oldContext=state.context;return state.context=oldContext.prev,oldContext}return null}function isTokenSeparated(stream){return stream.sol()||stream.string.charAt(stream.start-1)==" "||stream.string.charAt(stream.start-1)=="	"}function parseDocument(stream,state){return stream.eat("<")?stream.eat("?")?(pushContext(state,TAG_INSTRUCTION),state.tokenize=parseProcessingInstructionStartTag,STYLE_INSTRUCTION):stream.match("!--")?(pushContext(state,TAG_COMMENT),chain(stream,state,inBlock(STYLE_COMMENT,"-->",parseDocument))):stream.eatSpace()||stream.eol()?(stream.skipToEnd(),STYLE_ERROR):(state.tokenize=parseElementTagName,STYLE_ELEMENT_NAME):(stream.skipToEnd(),STYLE_ERROR)}function parseElementTagName(stream,state){var startPos=stream.pos;if(stream.match(/^[a-zA-Z_:][-a-zA-Z0-9_:.]*/)){var tagName=stream.string.substring(startPos,stream.pos);return pushContext(state,tagName),state.tokenize=parseElement,STYLE_ELEMENT_NAME}if(stream.match(/^\/[a-zA-Z_:][-a-zA-Z0-9_:.]*( )*>/)){var endTagName=stream.string.substring(startPos+1,stream.pos-1).trim(),oldContext=popContext(state);return state.tokenize=state.context==null?parseDocument:parseElementBlock,oldContext==null||endTagName!=oldContext.tagName?STYLE_ERROR:STYLE_ELEMENT_NAME}return state.tokenize=state.context==null?parseDocument:parseElementBlock,stream.eatWhile(/[^>]/),stream.eat(">"),STYLE_ERROR}function parseElement(stream,state){return stream.match(/^\/>/)?(popContext(state),state.tokenize=state.context==null?parseDocument:parseElementBlock,STYLE_ELEMENT_NAME):stream.eat(/^>/)?(state.tokenize=parseElementBlock,STYLE_ELEMENT_NAME):isTokenSeparated(stream)&&stream.match(/^[a-zA-Z_:][-a-zA-Z0-9_:.]*( )*=/)?(state.tokenize=parseAttribute,STYLE_ATTRIBUTE):(state.tokenize=state.context==null?parseDocument:parseDocument,stream.eatWhile(/[^>]/),stream.eat(">"),STYLE_ERROR)}function parseAttribute(stream,state){var quote=stream.next();return quote!='"'&&quote!="'"?(stream.skipToEnd(),state.tokenize=parseElement,STYLE_ERROR):(state.tokParams.quote=quote,state.tokenize=parseAttributeValue,STYLE_WORD)}function parseAttributeValue(stream,state){var ch="";while(!stream.eol()){ch=stream.next();if(ch==state.tokParams.quote)return state.tokenize=parseElement,STYLE_WORD;if(ch=="<")return stream.skipToEnd(),state.tokenize=parseElement,STYLE_ERROR;if(ch=="&"){ch=stream.next();if(ch==";")return stream.skipToEnd(),state.tokenize=parseElement,STYLE_ERROR;while(!stream.eol()&&ch!=";"){if(ch=="<")return stream.skipToEnd(),state.tokenize=parseElement,STYLE_ERROR;ch=stream.next()}if(stream.eol()&&ch!=";")return stream.skipToEnd(),state.tokenize=parseElement,STYLE_ERROR}}return STYLE_WORD}function parseElementBlock(stream,state){return stream.eat("<")?stream.match("?")?(pushContext(state,TAG_INSTRUCTION),state.tokenize=parseProcessingInstructionStartTag,STYLE_INSTRUCTION):stream.match("!--")?(pushContext(state,TAG_COMMENT),chain(stream,state,inBlock(STYLE_COMMENT,"-->",state.context==null?parseDocument:parseElementBlock))):stream.match("![CDATA[")?(pushContext(state,TAG_CDATA),chain(stream,state,inBlock(STYLE_TEXT,"]]>",state.context==null?parseDocument:parseElementBlock))):stream.eatSpace()||stream.eol()?(stream.skipToEnd(),STYLE_ERROR):(state.tokenize=parseElementTagName,STYLE_ELEMENT_NAME):(pushContext(state,TAG_TEXT),state.tokenize=parseText,null)}function parseText(stream,state){return stream.eatWhile(/[^<]/),stream.eol()||(popContext(state),state.tokenize=parseElementBlock),STYLE_TEXT}function parseProcessingInstructionStartTag(stream,state){return stream.match("xml",!0,!0)?state.lineNumber>1||stream.pos>5?(state.tokenize=parseDocument,stream.skipToEnd(),STYLE_ERROR):(state.tokenize=parseDeclarationVersion,STYLE_INSTRUCTION):isTokenSeparated(stream)||stream.match("?>")?(state.tokenize=parseDocument,stream.skipToEnd(),STYLE_ERROR):(state.tokenize=parseProcessingInstructionBody,STYLE_INSTRUCTION)}function parseProcessingInstructionBody(stream,state){return stream.eatWhile(/[^?]/),stream.eat("?")&&stream.eat(">")&&(popContext(state),state.tokenize=state.context==null?parseDocument:parseElementBlock),STYLE_INSTRUCTION}function parseDeclarationVersion(stream,state){return state.tokenize=parseDeclarationEncoding,isTokenSeparated(stream)&&stream.match(/^version( )*=( )*"([a-zA-Z0-9_.:]|\-)+"/)?STYLE_INSTRUCTION:(stream.skipToEnd(),STYLE_ERROR)}function parseDeclarationEncoding(stream,state){return state.tokenize=parseDeclarationStandalone,isTokenSeparated(stream)&&stream.match(/^encoding( )*=( )*"[A-Za-z]([A-Za-z0-9._]|\-)*"/)?STYLE_INSTRUCTION:null}function parseDeclarationStandalone(stream,state){return state.tokenize=parseDeclarationEndTag,isTokenSeparated(stream)&&stream.match(/^standalone( )*=( )*"(yes|no)"/)?STYLE_INSTRUCTION:null}function parseDeclarationEndTag(stream,state){return state.tokenize=parseDocument,stream.match("?>")&&stream.eol()?(popContext(state),STYLE_INSTRUCTION):(stream.skipToEnd(),STYLE_ERROR)}var STYLE_ERROR="error",STYLE_INSTRUCTION="comment",STYLE_COMMENT="comment",STYLE_ELEMENT_NAME="tag",STYLE_ATTRIBUTE="attribute",STYLE_WORD="string",STYLE_TEXT="atom",TAG_INSTRUCTION="!instruction",TAG_CDATA="!cdata",TAG_COMMENT="!comment",TAG_TEXT="!text",doNotIndent={"!cdata":!0,"!comment":!0,"!text":!0,"!instruction":!0},indentUnit=config.indentUnit;return{electricChars:"/",startState:function(){return{tokenize:parseDocument,tokParams:{},lineNumber:0,lineError:!1,context:null,indented:0}},token:function(stream,state){stream.sol()&&(state.lineNumber++,state.lineError=!1,state.indented=stream.indentation());if(stream.eatSpace())return null;var style=state.tokenize(stream,state);return state.lineError=state.lineError||style=="error",style},blankLine:function(state){state.lineNumber++,state.lineError=!1},indent:function(state,textAfter){if(state.context){if(state.context.noIndent==1)return;return textAfter.match(/^<\/.*/)?state.context.indent:state.context.indent+indentUnit}return 0},compareStates:function(a,b){if(a.indented!=b.indented)return!1;for(var ca=a.context,cb=b.context;;ca=ca.prev,cb=cb.prev){if(!ca||!cb)return ca==cb;if(ca.tagName!=cb.tagName)return!1}}}}),CodeMirror.defineMIME("application/xml","purexml"),CodeMirror.defineMIME("text/xml","purexml")})