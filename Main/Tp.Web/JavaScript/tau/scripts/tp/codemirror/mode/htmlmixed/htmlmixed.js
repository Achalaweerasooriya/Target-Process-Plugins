define(["tp/codemirror/lib/codemirror"],function(CodeMirror){CodeMirror.defineMode("htmlmixed",function(config,parserConfig){function html(stream,state){var style=htmlMode.token(stream,state.htmlState);return style=="tag"&&stream.current()==">"&&state.htmlState.context&&(/^script$/i.test(state.htmlState.context.tagName)?(state.token=javascript,state.localState=jsMode.startState(htmlMode.indent(state.htmlState,"")),state.mode="javascript"):/^style$/i.test(state.htmlState.context.tagName)&&(state.token=css,state.localState=cssMode.startState(htmlMode.indent(state.htmlState,"")),state.mode="css")),style}function maybeBackup(stream,pat,style){var cur=stream.current(),close=cur.search(pat);return close>-1&&stream.backUp(cur.length-close),style}function javascript(stream,state){return stream.match(/^<\/\s*script\s*>/i,!1)?(state.token=html,state.curState=null,state.mode="html",html(stream,state)):maybeBackup(stream,/<\/\s*script\s*>/,jsMode.token(stream,state.localState))}function css(stream,state){return stream.match(/^<\/\s*style\s*>/i,!1)?(state.token=html,state.localState=null,state.mode="html",html(stream,state)):maybeBackup(stream,/<\/\s*style\s*>/,cssMode.token(stream,state.localState))}var htmlMode=CodeMirror.getMode(config,{name:"xml",htmlMode:!0}),jsMode=CodeMirror.getMode(config,"javascript"),cssMode=CodeMirror.getMode(config,"css");return{startState:function(){var state=htmlMode.startState();return{token:html,localState:null,mode:"html",htmlState:state}},copyState:function(state){if(state.localState)var local=CodeMirror.copyState(state.token==css?cssMode:jsMode,state.localState);return{token:state.token,localState:local,mode:state.mode,htmlState:CodeMirror.copyState(htmlMode,state.htmlState)}},token:function(stream,state){return state.token(stream,state)},indent:function(state,textAfter){return state.token==html||/^\s*<\//.test(textAfter)?htmlMode.indent(state.htmlState,textAfter):state.token==javascript?jsMode.indent(state.localState,textAfter):cssMode.indent(state.localState,textAfter)},compareStates:function(a,b){return htmlMode.compareStates(a.htmlState,b.htmlState)},electricChars:"/{}:"}}),CodeMirror.defineMIME("text/html","htmlmixed")})