define(["tp/codemirror/lib/codemirror"],function(CodeMirror){CodeMirror.defineMode("rst",function(config,options){function setState(state,fn,ctx){state.fn=fn,setCtx(state,ctx)}function setCtx(state,ctx){state.ctx=ctx||{}}function setNormal(state,ch){if(ch&&typeof ch!="string"){var str=ch.current();ch=str[str.length-1]}setState(state,normal,{back:ch})}function hasMode(mode){if(mode){var modes=CodeMirror.listModes();for(var i in modes)if(modes[i]==mode)return!0}return!1}function getMode(mode){return hasMode(mode)?CodeMirror.getMode(config,mode):null}function normal(stream,state){function testBackward(re){return sol||!state.ctx.back||re.test(state.ctx.back)}function testForward(re){return stream.eol()||stream.match(re,!1)}function testInline(re){return stream.match(re)&&testBackward(/\W/)&&testForward(/\W/)}var ch,sol,i;if(stream.eat(/\\/))return ch=stream.next(),setNormal(state,ch),null;sol=stream.sol();if(sol&&(ch=stream.eat(reSection))){for(i=0;stream.eat(ch);i++);if(i>=3&&stream.match(/^\s*$/))return setNormal(state,null),"section";stream.backUp(i+1)}if(sol&&stream.match(reDirectiveMarker))return stream.eol()||setState(state,directive),"directive-marker";if(stream.match(reVerbatimMarker)){if(!verbatimMode)setState(state,verbatim);else{var mode=verbatimMode;setState(state,verbatim,{mode:mode,local:mode.startState()})}return"verbatim-marker"}if(sol&&stream.match(reExamples,!1)){if(!pythonMode)return setState(state,verbatim),"verbatim-marker";var mode=pythonMode;return setState(state,verbatim,{mode:mode,local:mode.startState()}),null}if(sol&&(stream.match(reEnumeratedList)||stream.match(reBulletedList)))return setNormal(state,stream),"list";if(testInline(reFootnoteRef))return setNormal(state,stream),"footnote";if(testInline(reCitationRef))return setNormal(state,stream),"citation";ch=stream.next();if(testBackward(rePreInline)){if(!(ch!==":"&&ch!=="|"||!stream.eat(/\S/))){var token;return ch===":"?token="role":token="replacement",setState(state,inline,{ch:ch,wide:!1,prev:null,token:token}),token}if(ch==="*"||ch==="`"){var orig=ch,wide=!1;ch=stream.next(),ch==orig&&(wide=!0,ch=stream.next());if(ch&&!/\s/.test(ch)){var token;return orig==="*"?token=wide?"strong":"emphasis":token=wide?"inline":"interpreted",setState(state,inline,{ch:orig,wide:wide,prev:null,token:token}),token}}}return setNormal(state,ch),null}function inline(stream,state){function finish(ch){return state.ctx.prev=ch,token}var ch=stream.next(),token=state.ctx.token;if(ch!=state.ctx.ch)return finish(ch);if(/\s/.test(state.ctx.prev))return finish(ch);if(state.ctx.wide){ch=stream.next();if(ch!=state.ctx.ch)return finish(ch)}return!stream.eol()&&!rePostInline.test(stream.peek())?(state.ctx.wide&&stream.backUp(1),finish(ch)):(setState(state,normal),setNormal(state,ch),token)}function directive(stream,state){var token=null;if(stream.match(reDirective))token="directive";else if(stream.match(reHyperlink))token="hyperlink";else if(stream.match(reFootnote))token="footnote";else{if(!stream.match(reCitation))return stream.eatSpace(),stream.eol()?(setNormal(state,stream),null):(stream.skipToEnd(),setState(state,comment),"comment");token="citation"}return setState(state,body,{start:!0}),token}function body(stream,state){var token="body";return!state.ctx.start||stream.sol()?block(stream,state,token):(stream.skipToEnd(),setCtx(state),token)}function comment(stream,state){return block(stream,state,"comment")}function verbatim(stream,state){return verbatimMode?stream.sol()?(stream.eatSpace()||setNormal(state,stream),null):verbatimMode.token(stream,state.ctx.local):block(stream,state,"verbatim")}function block(stream,state,token){return stream.eol()||stream.eatSpace()?(stream.skipToEnd(),token):(setNormal(state,stream),null)}var verbatimMode=getMode(options.verbatim),pythonMode=getMode("python"),reSection=/^[!"#$%&'()*+,-./:;<=>?@[\\\]^_`{|}~]/,reDirective=/^\s*\w([-:.\w]*\w)?::(\s|$)/,reHyperlink=/^\s*_[\w-]+:(\s|$)/,reFootnote=/^\s*\[(\d+|#)\](\s|$)/,reCitation=/^\s*\[[A-Za-z][\w-]*\](\s|$)/,reFootnoteRef=/^\[(\d+|#)\]_/,reCitationRef=/^\[[A-Za-z][\w-]*\]_/,reDirectiveMarker=/^\.\.(\s|$)/,reVerbatimMarker=/^::\s*$/,rePreInline=/^[-\s"([{</:]/,rePostInline=/^[-\s`'")\]}>/:.,;!?\\_]/,reEnumeratedList=/^\s*((\d+|[A-Za-z#])[.)]|\((\d+|[A-Z-a-z#])\))\s/,reBulletedList=/^\s*[-\+\*]\s/,reExamples=/^\s+(>>>|In \[\d+\]:)\s/;return{startState:function(){return{fn:normal,ctx:{}}},copyState:function(state){return{fn:state.fn,ctx:state.ctx}},token:function(stream,state){var token=state.fn(stream,state);return token}}}),CodeMirror.defineMIME("text/x-rst","rst")})