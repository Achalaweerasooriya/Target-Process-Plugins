define(["tp/codemirror/lib/codemirror"],function(t){t.defineMode("rst",function(e,n){function r(t,e,n){t.fn=e,i(t,n)}function i(t,e){t.ctx=e||{}}function c(t,e){if(e&&"string"!=typeof e){var n=e.current();e=n[n.length-1]}r(t,u,{back:e})}function a(e){if(e){var n=t.listModes();for(var r in n)if(n[r]==e)return!0}return!1}function o(n){return a(n)?t.getMode(e,n):null}function u(t,e){function n(t){return u||!e.ctx.back||t.test(e.ctx.back)}function i(e){return t.eol()||t.match(e,!1)}function a(e){return t.match(e)&&n(/\W/)&&i(/\W/)}var o,u,l;if(t.eat(/\\/))return o=t.next(),c(e,o),null;if(u=t.sol(),u&&(o=t.eat(h))){for(l=0;t.eat(o);l++);if(l>=3&&t.match(/^\s*$/))return c(e,null),"section";t.backUp(l+1)}if(u&&t.match(M))return t.eol()||r(e,s),"directive-marker";if(t.match(_)){if(x){var m=x;r(e,d,{mode:m,local:m.startState()})}else r(e,d);return"verbatim-marker"}if(u&&t.match(Z,!1)){if(p){var m=p;return r(e,d,{mode:m,local:m.startState()}),null}return r(e,d),"verbatim-marker"}if(u&&(t.match(A)||t.match(E)))return c(e,t),"list";if(a($))return c(e,t),"footnote";if(a(y))return c(e,t),"citation";if(o=t.next(),n(g)){if((":"===o||"|"===o)&&t.eat(/\S/)){var v;return v=":"===o?"role":"replacement",r(e,f,{ch:o,wide:!1,prev:null,token:v}),v}if("*"===o||"`"===o){var k=o,b=!1;if(o=t.next(),o==k&&(b=!0,o=t.next()),o&&!/\s/.test(o)){var v;return v="*"===k?b?"strong":"emphasis":b?"inline":"interpreted",r(e,f,{ch:k,wide:b,prev:null,token:v}),v}}}return c(e,o),null}function f(t,e){function n(t){return e.ctx.prev=t,a}var i=t.next(),a=e.ctx.token;return i!=e.ctx.ch?n(i):/\s/.test(e.ctx.prev)?n(i):e.ctx.wide&&(i=t.next(),i!=e.ctx.ch)?n(i):t.eol()||z.test(t.peek())?(r(e,u),c(e,i),a):(e.ctx.wide&&t.backUp(1),n(i))}function s(t,e){var n=null;if(t.match(k))n="directive";else if(t.match(b))n="hyperlink";else if(t.match(w))n="footnote";else{if(!t.match(S))return t.eatSpace(),t.eol()?(c(e,t),null):(t.skipToEnd(),r(e,m),"comment");n="citation"}return r(e,l,{start:!0}),n}function l(t,e){var n="body";return!e.ctx.start||t.sol()?v(t,e,n):(t.skipToEnd(),i(e),n)}function m(t,e){return v(t,e,"comment")}function d(t,e){return x?t.sol()?(t.eatSpace()||c(e,t),null):x.token(t,e.ctx.local):v(t,e,"verbatim")}function v(t,e,n){return t.eol()||t.eatSpace()?(t.skipToEnd(),n):(c(e,t),null)}var x=o(n.verbatim),p=o("python"),h=/^[!"#$%&'()*+,-./:;<=>?@[\\\]^_`{|}~]/,k=/^\s*\w([-:.\w]*\w)?::(\s|$)/,b=/^\s*_[\w-]+:(\s|$)/,w=/^\s*\[(\d+|#)\](\s|$)/,S=/^\s*\[[A-Za-z][\w-]*\](\s|$)/,$=/^\[(\d+|#)\]_/,y=/^\[[A-Za-z][\w-]*\]_/,M=/^\.\.(\s|$)/,_=/^::\s*$/,g=/^[-\s"([{</:]/,z=/^[-\s`'")\]}>\/:.,;!?\\_]/,A=/^\s*((\d+|[A-Za-z#])[.)]|\((\d+|[A-Z-a-z#])\))\s/,E=/^\s*[-\+\*]\s/,Z=/^\s+(>>>|In \[\d+\]:)\s/;return{startState:function(){return{fn:u,ctx:{}}},copyState:function(t){return{fn:t.fn,ctx:t.ctx}},token:function(t,e){var n=e.fn(t,e);return n}}}),t.defineMIME("text/x-rst","rst")});