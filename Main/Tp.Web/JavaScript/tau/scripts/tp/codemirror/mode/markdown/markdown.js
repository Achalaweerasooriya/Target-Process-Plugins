define(["tp/codemirror/lib/codemirror"],function(CodeMirror){CodeMirror.defineMode("markdown",function(cmCfg,modeCfg){function switchInline(stream,state,f){return state.f=state.inline=f,f(stream,state)}function switchBlock(stream,state,f){return state.f=state.block=f,f(stream,state)}function blockNormal(stream,state){if(stream.match(codeRE))return stream.skipToEnd(),code;if(stream.eatSpace())return null;if(stream.peek()==="#"||stream.match(headerRE))return stream.skipToEnd(),header;if(stream.eat(">"))return state.indentation++,quote;if(stream.peek()==="[")return switchInline(stream,state,footnoteLink);if(hrRE.test(stream.peek())){var re=new RegExp("(?:s*["+stream.peek()+"]){3,}$");if(stream.match(re,!0))return hr}var match;return(match=stream.match(ulRE,!0)||stream.match(olRE,!0))?(state.indentation+=match[0].length,list):switchInline(stream,state,state.inline)}function htmlBlock(stream,state){var style=htmlMode.token(stream,state.htmlState);return style==="tag"&&state.htmlState.type!=="openTag"&&!state.htmlState.context&&(state.f=inlineNormal,state.block=blockNormal),style}function getType(state){return state.strong?state.em?emstrong:strong:state.em?em:null}function handleText(stream,state){return stream.match(textRE,!0)?getType(state):undefined}function inlineNormal(stream,state){var style=state.text(stream,state);if(typeof style!="undefined")return style;var ch=stream.next();if(ch==="\\")return stream.next(),getType(state);if(ch==="`")return switchInline(stream,state,inlineElement(code,"`"));if(ch==="[")return switchInline(stream,state,linkText);if(ch==="<"&&stream.match(/^\w/,!1))return stream.backUp(1),switchBlock(stream,state,htmlBlock);var t=getType(state);return ch==="*"||ch==="_"?stream.eat(ch)?(state.strong=!state.strong)?getType(state):t:(state.em=!state.em)?getType(state):t:getType(state)}function linkText(stream,state){while(!stream.eol()){var ch=stream.next();ch==="\\"&&stream.next();if(ch==="]")return state.inline=state.f=linkHref,linktext}return linktext}function linkHref(stream,state){stream.eatSpace();var ch=stream.next();return ch==="("||ch==="["?switchInline(stream,state,inlineElement(linkhref,ch==="("?")":"]")):"error"}function footnoteLink(stream,state){return stream.match(/^[^\]]*\]:/,!0)?(state.f=footnoteUrl,linktext):switchInline(stream,state,inlineNormal)}function footnoteUrl(stream,state){return stream.eatSpace(),stream.match(/^[^\s]+/,!0),state.f=state.inline=inlineNormal,linkhref}function inlineRE(endChar){return inlineRE[endChar]||(inlineRE[endChar]=new RegExp("^(?:[^\\\\\\"+endChar+"]|\\\\.)*(?:\\"+endChar+"|$)")),inlineRE[endChar]}function inlineElement(type,endChar,next){return next=next||inlineNormal,function(stream,state){return stream.match(inlineRE(endChar)),state.inline=state.f=next,type}}var htmlMode=CodeMirror.getMode(cmCfg,{name:"xml",htmlMode:!0}),header="header",code="code",quote="quote",list="list",hr="hr",linktext="linktext",linkhref="linkhref",em="em",strong="strong",emstrong="emstrong",hrRE=/^[*-=_]/,ulRE=/^[*-+]\s+/,olRE=/^[0-9]\.\s+/,headerRE=/^(?:\={3,}|-{3,})$/,codeRE=/^(k:\t|\s{4,})/,textRE=/^[^\[*_\\<>`]+/;return{startState:function(){return{f:blockNormal,block:blockNormal,htmlState:htmlMode.startState(),indentation:0,inline:inlineNormal,text:handleText,em:!1,strong:!1}},copyState:function(s){return{f:s.f,block:s.block,htmlState:CodeMirror.copyState(htmlMode,s.htmlState),indentation:s.indentation,inline:s.inline,text:s.text,em:s.em,strong:s.strong}},token:function(stream,state){if(stream.sol()){state.f=state.block;var previousIndentation=state.indentation,currentIndentation=0;while(previousIndentation>0)if(stream.eat(" "))previousIndentation--,currentIndentation++;else{if(!(previousIndentation>=4&&stream.eat("	")))break;previousIndentation-=4,currentIndentation+=4}state.indentation=currentIndentation;if(currentIndentation>0)return null}return state.f(stream,state)},getType:getType}}),CodeMirror.defineMIME("text/x-markdown","markdown")})