define(["tp/codemirror/lib/codemirror"],function(e){e.defineMode("tiddlywiki",function(e){function t(e,t,r){return t.tokenize=r,r(e,t)}function r(e,t,r){return d=e,s=r,t}function n(e,n){var d,s=e.sol();if(n.block=!1,d=e.peek(),s&&/[<\/\*{}\-]/.test(d)){if(e.match(z))return n.block=!0,t(e,n,o);if(e.match(v))return r("quote","quote");if(e.match(x)||e.match(p))return r("code","code");if(e.match(g)||e.match(w)||e.match($)||e.match(y))return r("code","code");if(e.match(b))return r("hr","hr")}var d=e.next();if(s&&/[\/\*!#;:>|]/.test(d)){if("!"==d)return e.skipToEnd(),r("header","header");if("*"==d)return e.eatWhile("*"),r("list","list");if("#"==d)return e.eatWhile("#"),r("list","list");if(";"==d)return e.eatWhile(";"),r("list","list");if(":"==d)return e.eatWhile(":"),r("list","list");if(">"==d)return e.eatWhile(">"),r("quote","quote");if("|"==d)return r("table","table")}if("{"==d&&e.match(/\{\{/))return t(e,n,o);if(/[hf]/i.test(d)&&/[ti]/i.test(e.peek())&&e.match(/\b(ttps?|tp|ile):\/\/[\-A-Z0-9+&@#\/%?=~_|$!:,.;]*[A-Z0-9+&@#\/%=~_|$]/i))return r("link-external","link-external");if('"'==d)return r("string","string");if(/[\[\]]/.test(d)&&e.peek()==d)return e.next(),r("brace","brace");if("@"==d)return e.eatWhile(m),r("link-external","link-external");if(/\d/.test(d))return e.eatWhile(/\d/),r("number","number");if("/"==d){if(e.eat("%"))return t(e,n,i);if(e.eat("/"))return t(e,n,l)}if("_"==d&&e.eat("_"))return t(e,n,u);if("-"==d&&e.eat("-"))return t(e,n,c);if("'"==d&&e.eat("'"))return t(e,n,a);if("<"!=d)return r(d);if(e.eat("<"))return t(e,n,f);e.eatWhile(/[\w\$_]/);var k=e.current(),W=h.propertyIsEnumerable(k)&&h[k];return W?r(W.type,W.style,k):r("text",null,k)}function i(e,t){for(var i,a=!1;i=e.next();){if("/"==i&&a){t.tokenize=n;break}a="%"==i}return r("comment","comment")}function a(e,t){for(var i,a=!1;i=e.next();){if("'"==i&&a){t.tokenize=n;break}a="'"==i}return r("text","strong")}function o(e,t){var i,a=t.block;return a&&e.current()?r("code","code"):!a&&e.match(_)?(t.tokenize=n,r("code","code-inline")):a&&e.sol()&&e.match(W)?(t.tokenize=n,r("code","code")):(i=e.next(),a?r("code","code"):r("code","code-inline"))}function l(e,t){for(var i,a=!1;i=e.next();){if("/"==i&&a){t.tokenize=n;break}a="/"==i}return r("text","em")}function u(e,t){for(var i,a=!1;i=e.next();){if("_"==i&&a){t.tokenize=n;break}a="_"==i}return r("text","underlined")}function c(e,t){for(var i,a=!1;i=e.next();){if("-"==i&&a){t.tokenize=n;break}a="-"==i}return r("text","line-through")}function f(e,t){var i,a,o;return"<<"==e.current()?r("brace","macro"):(i=e.next())?">"==i&&">"==e.peek()?(e.next(),t.tokenize=n,r("brace","macro")):(e.eatWhile(/[\w\$_]/),a=e.current(),o=k.propertyIsEnumerable(a)&&k[a],o?r(o.type,o.style,a):r("macro",null,a)):(t.tokenize=n,r(i))}var d,s,h=(e.indentUnit,function(){return{}}()),k=function(){function e(e){return{type:e,style:"macro"}}return{allTags:e("allTags"),closeAll:e("closeAll"),list:e("list"),newJournal:e("newJournal"),newTiddler:e("newTiddler"),permaview:e("permaview"),saveChanges:e("saveChanges"),search:e("search"),slider:e("slider"),tabs:e("tabs"),tag:e("tag"),tagging:e("tagging"),tags:e("tags"),tiddler:e("tiddler"),timeline:e("timeline"),today:e("today"),version:e("version"),option:e("option"),"with":e("with"),filter:e("filter")}}(),m=/[\w_\-]/i,b=/^\-\-\-\-+$/,x=/^\/\*\*\*$/,p=/^\*\*\*\/$/,v=/^<<<$/,g=/^\/\/\{\{\{$/,w=/^\/\/\}\}\}$/,$=/^<!--\{\{\{-->$/,y=/^<!--\}\}\}-->$/,z=/^\{\{\{$/,W=/^\}\}\}$/,_=/.*?\}\}\}/;return{startState:function(){return{tokenize:n,indented:0,level:0}},token:function(e,t){if(e.eatSpace())return null;var r=t.tokenize(e,t);return r},electricChars:""}}),e.defineMIME("text/x-tiddlywiki","tiddlywiki")});