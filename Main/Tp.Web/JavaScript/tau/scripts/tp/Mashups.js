define("tp/mashups",["jQuery","Underscore"],function($,_){function Mashups(){this.basePath=null,this.mashupPath=null,this.currentPlaceholder=null,this.libs=[]}return Mashups.prototype={controls:{view:{}},subscriptions:{view:{}},mashupDeferreds:[],setPlaceholder:function(placeholder,basePath,mashupPath){this.currentPlaceholder=placeholder,this.basePath=basePath,this.mashupPath=mashupPath},addMashup:function(func){var basePath=this.basePath,mashupPath=this.mashupPath,id=this.currentPlaceholder,libs=this.libs;this.libs=[];var $deferred=$.Deferred();$deferred.mashup={path:mashupPath,libs:libs.concat([])},this.mashupDeferreds.push($deferred),$(function(){require(libs,function(){var args=Array.prototype.slice.call(arguments);args.push({placeholderId:id,basePath:basePath,mashupPath:mashupPath});try{var r=func.apply(null,args);return $deferred.resolve(),r}catch(e){$deferred.resolve(),console.log(e)}return{message:"mashup contains js errors"}},function(){$deferred.resolve()})})},findMashupDeferreds:function(fnCriterion){var finds=[];return _.each(this.mashupDeferreds,function($deffered){fnCriterion($deffered.mashup)&&finds.push($deffered)}),finds},onMashupsLoaded:function(fnCriterion){return $.when.apply(null,this.findMashupDeferreds(fnCriterion))},addDependency:function(moduleName){return this.libs.push(moduleName),this},addText:function(path){return this.libs.push("text!"+this.mashupPath+path),this},addHtml:function(path){return this.addText(path+"!strip")},addModule:function(name,module){var libs=this.libs;this.libs=[];if(!name)throw"tau.mashups.addModule: name should be specified";define(name,libs,function(){if(typeof module!="function")return module;var args=Array.prototype.slice.call(arguments);return module.apply(null,args)})},addCSS:function(cssRelativePath){var cssPath=this.mashupPath+cssRelativePath,cssLink=document.createElement("link");cssLink.setAttribute("rel","stylesheet"),cssLink.setAttribute("type","text/css"),cssLink.setAttribute("href",cssPath);var newCssHref=(cssLink.href||"").toLowerCase(),styleSheetList=document.styleSheets,hasStyleSheet=_.any(styleSheetList,function(ss){var iCssHref=(ss.href||"").toLowerCase();return iCssHref===newCssHref});return hasStyleSheet||document.getElementsByTagName("head")[0].appendChild(cssLink),this}},Mashups}),require(["tp/mashups"],function(Mashups){var viewTypes=["project","bug","userStory","testPlan","release","iteration","build","testCase","request","testPlanRun","task","feature","testPlan","impediment"],controlsToAdd=Mashups.prototype.controls.view,subscriptions=Mashups.prototype.subscriptions.view,configureControl=function(config){var id=_.uniqueId("custom control:"+config.control+":"+config.name+":"+config.type);controlsToAdd[id]=_.extend(config,{id:id})},View=function(config){this.config=config||{type:""}};View.prototype={addControl:function(name,ctrlType,fnRenderContentCallback,fnRenderHeaderCallback){var self=this,emptyFn=function(){},config={type:self.config.type||"notype",control:ctrlType,name:name||"Noname",onCreateContent:fnRenderContentCallback||emptyFn,onCreateHeader:fnRenderHeaderCallback||emptyFn};configureControl(config)},onRender:function(callback){var type=this.config.type.toLowerCase();return subscriptions.hasOwnProperty(type)||(subscriptions[type]=[]),subscriptions[type].push(callback),this},addTab:function(name,fnRenderContentCallback,fnRenderHeaderCallback){return this.addControl(name,"tab",fnRenderContentCallback,fnRenderHeaderCallback),this},addBlock:function(name,fnRenderContentCallback,fnRenderHeaderCallback){return this.addControl(name,"block",fnRenderContentCallback,fnRenderHeaderCallback),this}};var createDefine=function(viewType){var moduleName="tp/"+viewType+"/view";define(moduleName,[],function(){return new View({type:viewType})})};for(var i=0;i<viewTypes.length;i++)createDefine(viewTypes[i])})