define(["jQuery","tp/jquery.utils","tp/animatedPopup"],function(){(function($){function fwdNavigationButtonController(iterator){this._create(iterator)}function bwdNavigationButtonController(iterator){this._create(iterator)}changeLogIterator=function(source){this._create(source)},changeLogIterator.prototype={index:null,source:null,_create:function(source){this.source=source,this.index=0},retrievePrevious:function(){return this.canMoveBackward()?this.source[this.index-1]:this.current()},retrieveNext:function(){return this.canMoveForward()?this.source[this.index+1]:this.current()},previous:function(){this.canMoveBackward()&&this.index--},next:function(){this.canMoveForward()&&this.index++},_find:function(value){var equal=this.source;for(var index in value)equal=$.grep(equal,function(x){return x[index]==value[index]});return equal[0]},current:function(value){if(!value)return this.source[this.index];this.index=jQuery.inArray(this._find(value),this.source)},canMoveBackward:function(){return this.index>0},canMoveForward:function(){return this.index<this.source.length-1}},$.widget("ui.changeLogLink",{options:null,popup:null,_create:function(){var iterator=new changeLogIterator(this.options.source);iterator.current({Url:this._getUrl()});var popupConfig={iterator:iterator,form:this.options.popup.form,header:this.options.popup.header,iframe:this.options.popup.iframe,sourceElement:this.element};this.popup=this.options.popup.container.changeLogPopup(popupConfig),this.element.click($.proxy(this._showPopup,this)),this.options.opened&&this._showPopup(null)},_getUrl:function(){return this.element.attr("href")},_showPopup:function(e){e&&e.preventDefault();if(this.popup.changeLogPopup("isVisible"))return;this.options.deactivate(),this.popup.changeLogPopup("show")}}),$.widget("ui.changeLogPopup",{disabledClass:"disable",fixedWidth:760,fixedHeight:540,options:null,closeLink:null,prevLink:null,nextLink:null,headerTemplate:null,_create:function(){this.element.animatedPopup({sourceElement:this.options.sourceElement,fixedWidth:this.fixedWidth,fixedHeight:this.fixedHeight,content:this.options.form,resize:$.proxy(this._resize,this)}),$(document).keydown($.proxy(this.keydown,this)),this.prevLink=this.element.find(".prev"),this.prevLink.navigationButton({controller:new bwdNavigationButtonController(this.options.iterator)}),this.prevLink.navigationButton("click",$.proxy(this.loadContent,this)),this.nextLink=this.element.find(".next"),this.nextLink.navigationButton({controller:new fwdNavigationButtonController(this.options.iterator)}),this.nextLink.navigationButton("click",$.proxy(this.loadContent,this)),!this.options.iterator.canMoveForward()&&!this.options.iterator.canMoveBackward()&&(this.nextLink.hide(),this.prevLink.hide()),this.headerTemplate=this.options.header.html()},isVisible:function(){return this.element.is(":visible")},show:function(){this.loadContent($.proxy(this._contentLoaded,this))},hide:function(){this.element.animatedPopup("hide")},keydown:function(e){switch(e.which){case 27:this.hide()}},_contentLoaded:function(){this.element.animatedPopup("show")},loadContent:function(callback){var iframe=this.options.iframe,iterator=this.options.iterator;callback&&iframe.one("load",callback),iframe.one("load",$.proxy(this._bindKeyDown,this)),iframe.attr("src",iterator.current().Url),this.prevLink.navigationButton("render"),this.nextLink.navigationButton("render"),$.tmpl(this.headerTemplate,iterator.current()).appendTo(this.options.header.empty())},_bindKeyDown:function(){this.options.iframe.contents().keydown($.proxy(this.keydown,this))},_resize:function(){var iframe=this.options.iframe;iframe.height(this.fixedHeight),iframe.width(this.fixedWidth)}}),fwdNavigationButtonController.prototype={iterator:null,_create:function(iterator){this.iterator=iterator},onNavigate:function(){this.iterator.next()},isEnabled:function(){return this.iterator.canMoveForward()},getData:function(){return this.iterator.retrieveNext()}},bwdNavigationButtonController.prototype={iterator:null,_create:function(iterator){this.iterator=iterator},onNavigate:function(){this.iterator.previous()},isEnabled:function(){return this.iterator.canMoveBackward()},getData:function(){return this.iterator.retrievePrevious()}},$.widget("ui.navigationButton",{disabledClass:"disable",onClick:null,controller:null,template:null,isEnabled:!0,_create:function(){this.controller=this.options.controller,this.template=this.element.html(),this.element.click($.proxy(this._onClick,this))},_onClick:function(){if(!this.isEnabled)return;this.controller.onNavigate(),this.onClick&&this.onClick()},render:function(){$.tmpl(this.template,this.controller.getData()).appendTo(this.element.empty()),this.isEnabled=this.controller.isEnabled(),this.element.selectClass(this.isEnabled,"",this.disabledClass)},click:function(handler){this.onClick=handler}})})(jQuery)})