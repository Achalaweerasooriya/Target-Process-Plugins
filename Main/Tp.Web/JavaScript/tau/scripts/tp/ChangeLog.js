define(["libs/jquery/jquery.ui","libs/jquery/jquery.tmpl","tp/jquery.utils"],function(){(function(a){function c(a){this._create(a)}function b(a){this._create(a)}changeLogIterator=function(a){this._create(a)},changeLogIterator.prototype={index:null,source:null,_create:function(a){this.source=a,this.index=0},retrievePrevious:function(){return this.canMoveBackward()?this.source[this.index-1]:this.current()},retrieveNext:function(){return this.canMoveForward()?this.source[this.index+1]:this.current()},previous:function(){this.canMoveBackward()&&this.index--},next:function(){this.canMoveForward()&&this.index++},_find:function(b){var c=this.source;for(var d in b)c=a.grep(c,function(a){return a[d]==b[d]});return c[0]},current:function(a){if(a)this.index=jQuery.inArray(this._find(a),this.source);else return this.source[this.index]},canMoveBackward:function(){return this.index>0},canMoveForward:function(){return this.index<this.source.length-1}},a.widget("ui.changeLogLink",{options:null,popup:null,_create:function(){var b=new changeLogIterator(this.options.source);b.current({Url:this._getUrl()});var c={iterator:b,form:this.options.popup.form,header:this.options.popup.header,iframe:this.options.popup.iframe,sourceElement:this.element};this.popup=this.options.popup.container.changeLogPopup(c),this.element.click(a.proxy(this._showPopup,this)),this.options.opened&&this._showPopup(null)},_getUrl:function(){return this.element.attr("href")},_showPopup:function(a){a&&a.preventDefault();this.popup.changeLogPopup("isVisible")||(this.options.deactivate(),this.popup.changeLogPopup("show"))}}),a.widget("ui.changeLogPopup",{disabledClass:"disable",fixedWidth:760,fixedHeight:540,options:null,closeLink:null,prevLink:null,nextLink:null,resizeHandler:null,headerTemplate:null,_create:function(){this.element.modal(),this.resizeHandler=a.proxy(this._onResize,this),this.closeLink=this.element.find(".close"),this.closeLink.click(a.proxy(this.hide,this)),a(document).keydown(a.proxy(this.keydown,this)),this.prevLink=this.element.find(".prev"),this.prevLink.navigationButton({controller:new c(this.options.iterator)}),this.prevLink.navigationButton("click",a.proxy(this.loadContent,this)),this.nextLink=this.element.find(".next"),this.nextLink.navigationButton({controller:new b(this.options.iterator)}),this.nextLink.navigationButton("click",a.proxy(this.loadContent,this)),!this.options.iterator.canMoveForward()&&!this.options.iterator.canMoveBackward()&&(this.nextLink.hide(),this.prevLink.hide()),this.headerTemplate=this.options.header.html()},isVisible:function(){return this.element.is(":visible")},show:function(){a(window).bind("resize",this.resizeHandler),this.loadContent(a.proxy(this._contentLoaded,this))},hide:function(){var b=this;a(window).unbind("resize",this.resizeHandler);var c={target:this.options.sourceElement,callback:function(){b.element.modal("hide")}};b.options.form.hide(),this.element.minimizeTo(c)},keydown:function(a){switch(a.which){case 27:this.hide()}},_contentLoaded:function(){var a=this;a.element.modal("show"),a.options.form.hide();var b=a._getOffset(),c={target:a.options.sourceElement,callback:function(){a.options.form.show(),a._onResize()},settings:{left:b.left,top:b.top,width:a.fixedWidth,height:a.fixedHeight}};a.element.maximizeFrom(c)},loadContent:function(b){var c=this.options.iframe,d=this.options.iterator;b&&c.one("load",b),c.one("load",a.proxy(this._bindKeyDown,this)),c.attr("src",d.current().Url),this.prevLink.navigationButton("render"),this.nextLink.navigationButton("render"),a.tmpl(this.headerTemplate,d.current()).appendTo(this.options.header.empty())},_bindKeyDown:function(){this.options.iframe.contents().keydown(a.proxy(this.keydown,this))},_onResize:function(){this._resize(),this._center()},_getPopupWidth:function(){return 200+this.fixedHeight},_getOffset:function(){var b=a("body"),c=b.width(),d=b.height(),e=(c-this.fixedWidth)/2,f=Math.max((d-this._getPopupWidth())/2,50);return{top:f,left:e}},_center:function(){var a=this._getOffset();this.element.offset(a)},_resize:function(){var a=this.options.iframe;a.height(this.fixedHeight),a.width(this.fixedWidth)}}),b.prototype={iterator:null,_create:function(a){this.iterator=a},onNavigate:function(){this.iterator.next()},isEnabled:function(){return this.iterator.canMoveForward()},getData:function(){return this.iterator.retrieveNext()}},c.prototype={iterator:null,_create:function(a){this.iterator=a},onNavigate:function(){this.iterator.previous()},isEnabled:function(){return this.iterator.canMoveBackward()},getData:function(){return this.iterator.retrievePrevious()}},a.widget("ui.navigationButton",{disabledClass:"disable",onClick:null,controller:null,template:null,isEnabled:!0,_create:function(){this.controller=this.options.controller,this.template=this.element.html(),this.element.click(a.proxy(this._onClick,this))},_onClick:function(){!this.isEnabled||(this.controller.onNavigate(),this.onClick&&this.onClick())},render:function(){a.tmpl(this.template,this.controller.getData()).appendTo(this.element.empty()),this.isEnabled=this.controller.isEnabled(),this.element.selectClass(this.isEnabled,"",this.disabledClass)},click:function(a){this.onClick=a}})})(jQuery)})