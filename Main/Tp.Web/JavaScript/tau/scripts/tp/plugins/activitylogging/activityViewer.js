define(["app.path","tp/plugins/activityLogging/activityTemplate","tp/plugins/activityLogging/activityRepository","tp/plugins/profileNameSource","jQuery"],function(appPath,activityTemplate,activityRepository,profileNameSource,$){function activityViewer(config){this._create(config)}return activityViewer.prototype={activityTemplate:null,recordTemplate:null,placeHolder:null,errorMessageContainer:null,interval:1e4,requestInProgress:!1,capacity:5e3,intervalId:null,activityType:{All:0,Errors:10},filter:{DateRange:{StartDate:null,EndDate:null},Type:0},rendered:!1,_create:function(config){this.placeHolder=config.placeHolder,this.repository=new activityRepository,this.activityTemplate=activityTemplate.activityTemplate,this.recordTemplate=activityTemplate.recordTemplate,this.controlTemplate=activityTemplate.controlTemplate,this.profileNameSource=profileNameSource},render:function(){if(!this._isEditMode())return;this.rendered||(this.renderLogContainer(),this._initializeFilter()),this.renderActivityLog()},renderLogContainer:function(){var rendered=$.tmpl(this.activityTemplate,{});rendered.find("#linkMoreActivity").click($.proxy(this._showMore,this)),rendered.find("#linkShowErrors").click($.proxy(this._showErrors,this)),rendered.find("#linkShowAll").click($.proxy(this._showAll,this)),rendered.find("#linkClear").click($.proxy(this._clearActivityLog,this)),rendered.appendTo(this.placeHolder.find(".controls-widgets"));var controlTemplate=$(this.controlTemplate);controlTemplate.find(".hideLog, .showLog").click(function(event){event.preventDefault(),controlTemplate.find(".hideLog").toggle(),controlTemplate.find(".showLog").toggle(),rendered.slideToggle("fast")}),controlTemplate.appendTo(this.placeHolder.find(".additional-controls")),this.intervalId||(this.intervalId=window.setInterval($.proxy(this._getLatestActivityLog,this),this.interval)),$(".collapsable-activity").live("click",this._toggle),this.rendered=!0},renderActivityLog:function(){this.filter.Type===this.activityType.Errors?this._showErrors():this._showAll()},_initializeFilter:function(){var activityType=(new appPath.tp.URL(location.href)).getArgumentValue("Type"),explicitActivityType=this._getActivityType(activityType);typeof explicitActivityType!="undefined"&&explicitActivityType!==null&&(this.filter.Type=explicitActivityType)},_getLatestActivityLog:function(){if(!this.requestInProgress){var filter={DateRange:{StartDate:this.filter.DateRange.StartDate},Type:this.filter.Type};this._getActivityLog(filter,this._onGetLatestActivityLogSuccess)}},_getActivityLog:function(filter,success){this.requestInProgress=!0,this.repository.getActivityLog(this.profileNameSource.getProfileName(),filter,$.proxy(function(data){this.requestInProgress=!1,this.placeHolder.find(".lastSyncDate").text((new Date).toString("HH:mm:ss")).parent().show(),$.proxy(success,this)(data)},this),$.proxy(function(request){this.requestInProgress=!1,$.proxy(this._processError,this)(request)},this))},_showMore:function(){this._getPreloader().show();var filter={DateRange:{EndDate:this.filter.DateRange.EndDate},Type:this.filter.Type};this._getActivityLog(filter,this._onGetActivityLogSuccess())},_showErrors:function(){var filter={DateRange:{EndDate:null},Type:this.activityType.Errors};this._changeActivityType(filter,$.proxy(function(){this.placeHolder.find("#linkShowAll").show(),this.placeHolder.find("#linkShowErrors").hide(),this.placeHolder.find("div.log").html(""),this.filter.DateRange.StartDate=null,this.filter.DateRange.EndDate=null,this.filter.Type=this.activityType.Errors},this))},_showAll:function(){var filter={DateRange:{EndDate:null},Type:this.activityType.All};this._changeActivityType(filter,$.proxy(function(){this.placeHolder.find("#linkShowAll").hide(),this.placeHolder.find("#linkShowErrors").show(),this.placeHolder.find("div.log").html(""),this.filter.DateRange.StartDate=null,this.filter.DateRange.EndDate=null,this.filter.Type=this.activityType.All},this))},_changeActivityType:function(filter,onSuccess){this._getPreloader().show(),this._getActivityLog(filter,this._onGetActivityLogSuccess(onSuccess))},_clearActivityLog:function(){this._getPreloader().show();var filter={Type:this.filter.Type};this.repository.clearActivityLog(this.profileNameSource.getProfileName(),filter,$.proxy(this._onClearActivityLogSuccess,this),$.proxy(this._processError,this))},_onGetActivityLogSuccess:function(onSuccess){return function(data){this._getPreloader().hide(),onSuccess&&onSuccess();if(!data.Records||!data.Records.length||data.Type!==this.filter.Type){this.placeHolder.find("#linkMoreActivity").hide();return}this.placeHolder.find("#linkMoreActivity").show(),data.Records&&data.Records.length?(this.filter.DateRange.EndDate=data.Records[data.Records.length-1].DateTime,this.filter.DateRange.StartDate===null&&(this.filter.DateRange.StartDate=data.Records[0].DateTime)):this.placeHolder.find("#linkMoreActivity").hide();var rendered=$.tmpl(this.recordTemplate,data);this.placeHolder.find("div.log").append(rendered)}},_onGetLatestActivityLogSuccess:function(data){this._getPreloader().hide();if(!data.Records||!data.Records.length||data.Type!==this.filter.Type)return;data.Records&&data.Records.length&&(this.filter.DateRange.StartDate=data.Records[0].DateTime);var rendered=$.tmpl(this.recordTemplate,data);this.placeHolder.find("div.log").prepend(rendered),this._rollOverSize()},_rollOverSize:function(){var logEntries=this.placeHolder.find("div.log>div");for(var i=this.capacity;i<logEntries.length;i++)$(logEntries[i]).remove()},_onClearActivityLogSuccess:function(data){this._getPreloader().hide(),this.filter.DateRange.StartDate=null,this.filter.DateRange.EndDate=null,this.placeHolder.find("div.log").html(""),this.placeHolder.find("#linkMoreActivity").hide()},_processError:function(response){this._getPreloader().hide()},_isEditMode:function(){return this.profileNameSource.getProfileName()!=null},_getActivityType:function(type){var filterType=this.activityType[type];return filterType!==null?filterType:this.activityType.All},_getPreloader:function(){return this.placeHolder.find("span.preloader")},_toggle:function(){$(this).toggleClass("collapsed").toggleClass("expanded"),$(this).next().slideToggle("fast")}},activityViewer})