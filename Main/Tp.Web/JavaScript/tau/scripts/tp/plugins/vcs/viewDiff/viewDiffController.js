define(["tp/plugins/pluginsRepository","tp/plugins/commandGateway","tp/plugins/vcs/viewDiff/sourcePopup","tp/plugins/vcs/viewDiff/diffPopup","jQuery"],function(i,t,e,n,s){var r=function(i){this._ctor(i)};return r.prototype={_ctor:function(r){this.pluginsRepository=i,this.commandGateway=new t(r),this.pluginName=r.pluginName,this.firstInitialization=!0,this.drawingInProgress=!1,this.viewSourcePopup=e,this.viewDiffPopup=n,this.initialize();var o=Sys.WebForms.PageRequestManager.getInstance();o.add_pageLoaded(s.proxy(this.initialize,this))},initialize:function(i,t){var e=this,n=function(){e.drawingInProgress=!0,e.firstInitialization=!1,e.pluginsRepository.pluginStartedAndHasAtLeastOneProfile(e.pluginName,s.proxy(e._getImportedRevisionsSuccess,e))},r=!t&&this.firstInitialization&&!this.drawingInProgress;if(r)n();else{var o=s.grep(t.get_panelsUpdated(),function(i){return i.id.contains("revisionsGrid")}),a=!this.drawingInProgress&&(this.firstInitialization||o.length>0&&0==s(o).find("._diff").length);a&&n()}},_getImportedRevisionsSuccess:function(){var i=s.makeArray(s('table[id$="revisionsGrid"] tr .expandedList ._revisionID').map(function(i,t){return s(t).val()}));this.commandGateway.execute("GetImportedRevisions",i,s.proxy(this._render,this))},_render:function(i){var t=this;s('table[id$="revisionsGrid"] tr .expandedList').each(function(){if(!(s(this).find(".vcsView, .vcsViewDisabled").length>0)){var e=s(this).find("._revisionID").val(),n=s.grep(i,function(i){return i==e}).length>0;if(n){var r=s(this).parentsUntil("tr","td:first").parent().prev(),o=r.find("td:nth-child(2)").text().replace(/\W+/g,"");s(this).find("table.generalTable tr+tr").each(function(){var i=s(this).find("td"),n=s.trim(s(i[1]).text()),r=s(i[0]).find("a"),a=r.text();"Delete"==n?r.addClass("vcsViewDisabled"):(r.attr("href","#").removeAttr("disabled").addClass("vcsView"),r.click(function(i){i.preventDefault(),t.showView(e,o,a)})),"Modify"==n&&s('<a href="#" class="_diff">Diff</a>').click(function(i){i.preventDefault(),t.showDiff(e,o,a)
}).appendTo(s(i[2]))})}}}),this.drawingInProgress=!1},showView:function(i,t,e){this.viewSourcePopup.loading();var n=this;this.commandGateway.execute("ViewSource",{TpRevisionId:i,Path:e},function(i){var s=i.Content||"File is empty";n.viewSourcePopup.view(t,s,e)},null,this.showError)},showDiff:function(i,t,e){this.viewDiffPopup.loading();var n=this;this.commandGateway.execute("ViewDiff",{TpRevisionId:i,Path:e},function(i){n.viewDiffPopup.view(t,i,e)},null,this.showError)},showError:function(i){s("<div />").html('<p class="p-15">'+i+"</p>").popup({title:"Error occurred",fitToWindow:!1})}},r});