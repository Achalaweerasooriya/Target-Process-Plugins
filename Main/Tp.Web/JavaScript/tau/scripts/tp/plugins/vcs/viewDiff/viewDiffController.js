define(["tp/plugins/pluginsRepository","tp/plugins/commandGateway","tp/plugins/vcs/viewDiff/sourcePopup","tp/plugins/vcs/viewDiff/diffPopup","jQuery"],function(pluginsRepository,CommandGateway,viewSourcePopup,viewDiffPopup,$){function ViewDiffController(config){this._ctor(config)}return ViewDiffController.prototype={_ctor:function(config){this.pluginsRepository=pluginsRepository,this.commandGateway=new CommandGateway(config),this.pluginName=config.pluginName,this.firstInitialization=!0,this.drawingInProgress=!1,this.viewSourcePopup=viewSourcePopup,this.viewDiffPopup=viewDiffPopup,this.initialize();var prm=Sys.WebForms.PageRequestManager.getInstance();prm.add_pageLoaded($.proxy(this.initialize,this))},initialize:function(sender,args){var that=this,init=function(){that.drawingInProgress=!0,that.firstInitialization=!1,that.pluginsRepository.pluginStartedAndHasAtLeastOneProfile(that.pluginName,$.proxy(that._getImportedRevisionsSuccess,that))},firstInit=!args&&this.firstInitialization&&!this.drawingInProgress;if(firstInit)init();else{var updatePanels=$.grep(args.get_panelsUpdated(),function(element){return element.id.contains("revisionsGrid")}),update=!this.drawingInProgress&&(this.firstInitialization||updatePanels.length>0&&$(updatePanels).find("._diff").length==0);update&&init()}},_getImportedRevisionsSuccess:function(){var revisions=$.makeArray($('table[id$="revisionsGrid"] tr .expandedList ._revisionID').map(function(index,item){return $(item).val()}));this.commandGateway.execute("GetImportedRevisions",revisions,$.proxy(this._render,this))},_render:function(revisions){var that=this;$('table[id$="revisionsGrid"] tr .expandedList').each(function(){if($(this).find(".vcsView, .vcsViewDisabled").length>0)return;var tpRevisionId=$(this).find("._revisionID").val(),importedRevision=$.grep(revisions,function(revision){return revision==tpRevisionId}).length>0;if(importedRevision){var revisionRow=$(this).parentsUntil("tr","td:first").parent().prev(),thirdPartyRevisionId=revisionRow.find("td:nth-child(2)").text().replace(/\W+/g,"");$(this).find("table.generalTable tr+tr").each(function(){var cells=$(this).find("td"),action=$.trim($(cells[1]).text()),pathLink=$(cells[0]).find("a"),path=pathLink.text();action!="Delete"?(pathLink.attr("href","#").removeAttr("disabled").addClass("vcsView"),pathLink.click(function(e){e.preventDefault(),that.showView(tpRevisionId,thirdPartyRevisionId,path)})):pathLink.addClass("vcsViewDisabled"),action=="Modify"&&$('<a href="#" class="_diff">Diff</a>').click(function(e){e.preventDefault(),that.showDiff(tpRevisionId,thirdPartyRevisionId,path)}).appendTo($(cells[2]))})}}),this.drawingInProgress=!1},showView:function(revisionId,thirdPartyRevisionId,path){this.viewSourcePopup.loading();var that=this;this.commandGateway.execute("ViewSource",{TpRevisionId:revisionId,Path:path},function(data){var content=data.Content||"File is empty";that.viewSourcePopup.view(thirdPartyRevisionId,content,path)},null,this.showError)},showDiff:function(revisionId,thirdPartyRevisionId,path){this.viewDiffPopup.loading();var that=this;this.commandGateway.execute("ViewDiff",{TpRevisionId:revisionId,Path:path},function(data){that.viewDiffPopup.view(thirdPartyRevisionId,data,path)},null,this.showError)},showError:function(responseText){$("<div />").html('<p class="p-15">'+responseText+"</p>").popup({title:"Error occured",fitToWindow:!1})}},ViewDiffController})