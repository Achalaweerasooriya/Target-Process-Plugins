define(["tp/codemirror/lib/codemirror","jQuery","tau/ui/behaviour/common/ui.behaviour.progressIndicator","tp/popup","tp/codemirror/mode/diff/diff","tp/codemirror/mode/clike/clike","tp/codemirror/mode/css/css","tp/codemirror/mode/htmlmixed/htmlmixed","tp/codemirror/mode/javascript/javascript","tp/codemirror/mode/perl/perl","tp/codemirror/mode/php/php","tp/codemirror/mode/python/python","tp/codemirror/mode/ruby/ruby","tp/codemirror/mode/xml/xml"],function(codeMirror,$,ProgressIndicator){function SourcePopup(){this._ctor()}return SourcePopup.prototype={_ctor:function(){this.placeholder=$('<div class="_viewSourcePopup viewSourcePopup" />'),this.emptyText="No data to display",this.codeViewer=codeMirror(this.placeholder[0],{readOnly:!0,lineNumbers:!0});var that=this;this.popup=this.placeholder.popup({zIndex:2e4,autoOpen:!1,minWidth:300,open:function(){that.resizeCodeViewer()},resize:function(){that.resizeCodeViewer()}}),this.placeholder.parent().addClass("vcsSource")},resizeCodeViewer:function(){var height=$("._viewSourcePopup").height(),width=$("._viewSourcePopup").width();$(".CodeMirror-scroll").css("height",height),$(".CodeMirror-scroll").css("width",width)},view:function(thirdPartyRevisionId,content,path){var text=content||this.emptyText,title="File: "+path+'<br /><span class="subTitle">Revision: '+thirdPartyRevisionId+"</span>";this.placeholder.removeClass("_refreshing"),ProgressIndicator.get(this.placeholder).hide(),this._setModeByFileExtension(path),this.codeViewer.setValue(text),this.popup.popup("option","title",title),this.popup.popup("open"),this.codeViewer.refresh()},loading:function(){var ph=this.placeholder;ph.addClass("_refreshing"),ProgressIndicator.get(ph).show(),this.popup.popup("option","title",""),this.popup.popup("open")},_getExtension:function(fileName){return fileName.substr(fileName.lastIndexOf(".")+1)},_setModeByFileExtension:function(path){var extension=this._getExtension(path),mode="clike";switch(extension){case"css":mode="text/css";break;case"cs":mode="text/x-csharp";break;case"c":case"h":mode="text/x-csrc";break;case"cpp":mode="text/x-c++src";break;case"html":case"htm":case"shtml":mode="text/html";break;case"js":mode="text/javascript";break;case"java":mode="text/x-java";break;case"perl":mode="text/x-perl";break;case"php":case"phtml":case"phl":mode="application/x-httpd-php";break;case"py":mode="text/x-python";break;case"rb":mode="text/x-ruby";break;case"xml":case"config":mode="application/xml";break;default:mode="null"}this.codeViewer.setOption("mode",mode)}},new SourcePopup})