define(["libs/jquery/jquery","libs/jquery/jquery.ui","tp/popup"],function(a){function b(a){this._ctor(a)}return b.prototype={placeholder:a('<div class="_viewDiffPopup viewDiffPopup">\n    <div class="diffHeader">\n        <div class="_legend legend">\n            <span class="lineAdded">line added</span>&nbsp;&nbsp;\n            <span class="lineUpdated">line changed</span>&nbsp;&nbsp;\n            <span class="lineDeleted">line deleted</span>\n        </div>\n        <div class="revisionsContainer">\n            <div class="revisionContainer right">\n                <div class="_rightRevision revision"></div>\n            </div>\n            <div class="revisionContainer left">\n                <div class="_leftRevision revision"></div>\n            </div>\n        </div>\n    </div>\n    <div class="diffContainer _diffContainer">\n        <div class="_rightContainer sourceContainer right">\n            <pre>\n                <div class="_rightPan"></div>\n            </pre>\n        </div>\n        <div class="_leftContainer sourceContainer left">\n            <pre>\n                <div class="_leftPan"></div>\n            </pre>\n        </div>\n        <div style="clear:both;"></div>\n    </div>\n    <div class="scrollers">\n        <div class="_rightScroller rightScroller right">\n            <div class="_scrollerInternals scrollerInternals"></div>\n        </div>\n        <div class="_leftScroller leftScroller left">\n            <div class="_scrollerInternals scrollerInternals"></div>\n        </div>\n    </div>\n</div>'),lineTemplate:'<div {{if line.Action}}class="line${actions[line.Action]}"{{/if}}>${line.LineNumber}  ${line.Line}</div>',actions:{0:"None",10:"Added",20:"Updated",30:"Deleted"},_ctor:function(b){this.placeholder.appendTo(b.placeholder),this.emptyText=b.emptyText||"No data to display";var c=a.proxy(this._getSyncFunction("left","right"),this),d=a.proxy(this._getSyncFunction("right","left"),this),e=this,f=a.proxy(function(){e._processScroller("right"),e._processScroller("left")},this);this.popup=this.placeholder.popup({autoOpen:!1,minWidth:300,open:function(){e._processScroller("right").bind("scroll",d),e._processScroller("left").bind("scroll",c),a(window).bind("resize",f)},close:function(){e.placeholder.find("._rightScroller").unbind("scroll",d),e.placeholder.find("._leftScroller").unbind("scroll",c),a(window).unbind("resize",f)},resize:function(){f()}}),this.placeholder.parent().addClass("vcsDiff")},_getSyncFunction:function(a,b){var c=this;return function(){var d=c.placeholder.find("._"+a+"Scroller");c.placeholder.find("._"+b+"Scroller").scrollLeft(d.scrollLeft()),c.placeholder.find("._"+b+"Container").scrollLeft(d.scrollLeft()),c.placeholder.find("._"+a+"Container").scrollLeft(d.scrollLeft())}},_processScroller:function(b){var c=a("._"+b+"Pan").width(),d=this.placeholder.find("._"+b+"Container"),e=d.width(),f=this.placeholder.find("._"+b+"Scroller"),g=this.placeholder.find("._diffContainer");return d.height()<g.height()?(d.height(g.height()),f.css("right",0)):(d.css("height","auto"),f.css("right","17px")),f.find("._scrollerInternals").width(c),f.width(e),e<c?f.show():f.hide(),f},view:function(a,b,c){var d="Changed file: "+c;this.placeholder.find("._leftRevision").text("Revision "+(a-1)),this.placeholder.find("._rightRevision").text("Revision "+a),this._processPan(this.placeholder.find("._leftPan").html(""),b.LeftPan),this._processPan(this.placeholder.find("._rightPan").html(""),b.RightPan),this.popup.popup("option","title",d),this.popup.popup("open"),this.placeholder.removeClass("_refreshing")},loading:function(){this.placeholder.addClass("_refreshing")},_processPan:function(b,c){for(var d=0;d<c.length;d++){var e=c[d];e.LineNumber=this._normalizeLineNumber(e.LineNumber),e.Line=e.Line.replace(/\t/g,"&#9;")||"&nbsp;",b.append(a.tmpl(this.lineTemplate,{line:e,actions:this.actions}))}},_normalizeLineNumber:function(a){var b=a;if(b<0)return"     ";var c=new String(b+1);while(c.length<5)c=" "+c;return c}},b})