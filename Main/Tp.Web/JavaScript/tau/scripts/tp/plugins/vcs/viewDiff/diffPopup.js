define(["jQuery","tau/ui/behaviour/common/ui.behaviour.progressIndicator","tp/popup"],function(i,e){var n=function(){this._ctor()};return n.prototype={placeholder:i(['<div class="_viewDiffPopup viewDiffPopup">','<div class="diffHeader">','<div class="_legend legend">','<span class="lineAdded">line added</span>&nbsp;&nbsp;','<span class="lineUpdated">line changed</span>&nbsp;&nbsp;','<span class="lineDeleted">line deleted</span>',"</div>",'<div class="revisionsContainer">','<div class="revisionContainer right">','<div class="_rightRevision revision"></div>',"</div>",'<div class="revisionContainer left">','<div class="_leftRevision revision"></div>',"</div>","</div>","</div>",'<div class="diffContainer _diffContainer">','<div class="_rightContainer sourceContainer right">',"<pre>",'<div class="_rightPan"></div>',"</pre>","</div>",'<div class="_leftContainer sourceContainer left">',"<pre>",'<div class="_leftPan"></div>',"</pre>","</div>",'<div style="clear:both;"></div>',"</div>",'<div class="scrollers">','<div class="_rightScroller rightScroller right">','<div class="_scrollerInternals scrollerInternals"></div>',"</div>",'<div class="_leftScroller leftScroller left">','<div class="_scrollerInternals scrollerInternals"></div>',"</div>","</div>","</div>"].join("")),lineTemplate:'<div {{if line.Action}}class="line${actions[line.Action]}"{{/if}}>${line.LineNumber}  ${line.Line}</div>',actions:{0:"None",10:"Added",20:"Updated",30:"Deleted"},emptyText:"No data to display",_ctor:function(){},_createPopup:function(){if(!this.popup){var e=i.proxy(this._getSyncFunction("left","right"),this),n=i.proxy(this._getSyncFunction("right","left"),this),t=i.proxy(function(){this._processScroller("right"),this._processScroller("left")},this),s=this;this.popup=this.placeholder.popup({autoOpen:!1,minWidth:300,parentClassName:"vcsDiff",open:function(){s._processScroller("right").bind("scroll",n),s._processScroller("left").bind("scroll",e),i(window).bind("resize",t)},close:function(){s.placeholder.find("._rightScroller").unbind("scroll",n),s.placeholder.find("._leftScroller").unbind("scroll",e),i(window).unbind("resize",t)},resize:function(){t()}})}},_getSyncFunction:function(i,e){var n=this;return function(){var t=n.placeholder.find("._"+i+"Scroller");n.placeholder.find("._"+e+"Scroller").scrollLeft(t.scrollLeft()),n.placeholder.find("._"+e+"Container").scrollLeft(t.scrollLeft()),n.placeholder.find("._"+i+"Container").scrollLeft(t.scrollLeft())}},_processScroller:function(e){var n=i("._"+e+"Pan").width(),t=this.placeholder.find("._"+e+"Container"),s=t.width(),l=this.placeholder.find("._"+e+"Scroller"),r=this.placeholder.find("._diffContainer");return t.height()<r.height()?(t.height(r.height()),l.css("right",0)):(t.css("height","auto"),l.css("right","17px")),l.find("._scrollerInternals").width(n),l.width(s),n>s?l.show():l.hide(),l},openPopup:function(i,e){var n=this.placeholder;this._showRevision(n.find("._leftRevision"),e.LeftPanRevisionId),this._showRevision(n.find("._rightRevision"),e.RightPanRevisionId),this._showContent(n.find("._leftPan"),e.LeftPan),this._showContent(n.find("._rightPan"),e.RightPan),this._createPopup(),this.popup.popup("option","title",i),this.popup.popup("open")},view:function(i,n,t){this.placeholder.removeClass("_refreshing"),e.get(this.placeholder).hide(),this.openPopup("Changed file: "+t,n)},loading:function(){this.placeholder.addClass("_refreshing"),e.get(this.placeholder).show();var i={LeftPanRevisionId:"",RightPanRevisionId:"",LeftPan:[],RightPan:[]};this.openPopup("",i)},_showRevision:function(i,e){i.text("Revision "+e)},_showContent:function(e,n){e.html("");for(var t=0;t<n.length;t++){var s=n[t];s.LineNumber=this._normalizeLineNumber(s.LineNumber),s.Line=s.Line.replace(/\t/g,"&#9;")||"&nbsp;",e.append(i.tmpl(this.lineTemplate,{line:s,actions:this.actions}))}},_normalizeLineNumber:function(i){if(0>i)return"     ";var e="     "+(i+1);return e.slice(-5)}},new n});