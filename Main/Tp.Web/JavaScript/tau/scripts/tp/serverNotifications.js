define(["tp/utils","tau/utils/utils.date","Underscore","jQuery","notifications/hubs"],function(t,n,e,i){var s="is-connecting",o="has-general-subscriptions",c="is-stop-inprogress",d="unloading",h=function(){this.$dfConnected=null,this.disconnected=e.Callbacks(),this.disconnectedSubscription=!1,this.connection=i.connection,this.proxies={resource:new r(this,"Resource"),slice:new r(this,"Slice"),"slice-timeline":new r(this,"TimelineSlice"),"slice-newlist":new r(this,"TreeViewSlice"),"slice-entitynewlist":new r(this,"EntityTreeViewSlice"),"view-menu":new r(this,"ViewMenu")},i(window).on("beforeunload",this.stop.bind(this,!0))};h.prototype={transportType:i.ui.ie?"longPolling":"auto",get$dfConnected:function(){return this.$dfConnected=this.$dfConnected||i.Deferred(),this.$dfConnected},start:function(t){this.$dfConnected=this.get$dfConnected(),this.$dfConnected.done(t),this.$dfConnected[s]=!0;var n=this.connection.hub;n[o]||this.disconnectedSubscription||(this.disconnectedSubscription=!0,n.disconnected(e.bind(function(){n[o]=!1,this.$dfConnected&&(this.$dfConnected[s]=!1,this.$dfConnected.reject(),this.$dfConnected=null),this.disconnected[d]||this.disconnected.fire()},this))),n.start({transport:this.transportType}).done(e.bind(function(){n[o]=!0,this.$dfConnected||(this.$dfConnected=this.get$dfConnected(),this.$dfConnected.done(t),this.$dfConnected[s]=!0),this.$dfConnected.resolve()},this)).fail(e.bind(function(){n[o]=!1,this.$dfConnected&&this.$dfConnected.reject()},this)).always(e.bind(function(){this.$dfConnected&&(this.$dfConnected[s]=!1)},this))},stop:function(t){if(!this.disconnected[c]){this.disconnected[c]=!0,this.disconnected[d]=t;var n=e.map(this.proxies,function(t){var n=e.pluck(t.subscriptions,"id"),s=i.Deferred();return t.unsubscribe(n,s.resolve),s});i.when.apply(i,n).then(e.bind(function(){var t=this.connection.hub;t.stop(),t[o]=!1,this.$dfConnected&&(this.$dfConnected[s]=!1)},this))}},get:function(t){return this.proxies[t]}};var r=function(t,n){this.hubName=n,this.subscriptions={},this.connection=t,this.hub=t.connection[this.hubName],this.hub.client.notifyChanged=e.bind(this.handleData,this),this.hub.client.status=this.onStatus.notify,window["verbose.mode"]&&(this.hub.connection.logging=!0)
};return r.prototype={onStatus:i.Deferred(),subscribe:function(n,s){this.connection.start(e.bind(function(n,s){var o=[],c=e.map(n,e.bind(function(n){var s=e.defaults(e.extend(n,{id:t.guid()}),{clientId:null,parameters:{},callback:i.noop(),logNotifications:null});return this.subscriptions[s.id]=s,o.push(s.id),this.hub.server.subscribe(s)},this));i.when.apply(i,c).then(e.bind(s,null,o))},this,n,s))},unsubscribe:function(t,n){var s=e.map(t,function(t){delete this.subscriptions[t];try{return this.hub.server.unsubscribe(t)}catch(n){}},this);i.when.apply(i,s).then(n)},logReject:function(t){window.appIsInDebugMode&&window.console&&console.log("comet batch data by hub %s rejected",this.hubName,t)},logData:function(t){window["verbose.mode"]&&window.console&&(console.group&&console.groupEnd?(console.group("comet batch data by hub %s",this.hubName),console.log("Raw: %o",t),console.log("Subscription ID: %o",t.SubscriptionId),console.log("Client ID: %o",t.ClientId),console.log("Time: %o",t.Timestamp),console.groupEnd()):console.log("comet batch data by hub %s",this.hubName))},handleData:function(t){var i=this.subscriptions[t.SubscriptionId];if(!i||t.ClientId&&t.ClientId===i.clientId)return void this.logReject(t);t.items=JSON.parse(t.Data),this.logData(t);var s=n.parseTimestamp(t.Timestamp);i.batchCallback(t),e.forEach(t.items,function(o){var c={sid:t.SubscriptionId,timestamp:s,data:o,trace:e.map(t.Trace,function(t){return{name:t.Name,timestamp:n.parseTimestamp(t.Timestamp)}})};i.callback(c)})}},new h});