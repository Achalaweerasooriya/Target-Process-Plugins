define(["jQuery","app.path","tp/reports/burndown/dataProvider","tau/core/tau","tp/dropdown"],function(e,t,r,n){function i(){this.dataProvider=new r,this.typeDictionary={iteration:"iteration",release:"release",teamiteration:"teamiteration"}}return i.prototype={initialize:function(e){this.queryStringPlannableId=parseInt(n.getQueryValueFromUrl(location.href.toLowerCase(),"entityid")),this.queryStringBurnDownType=n.getQueryValueFromUrl(location.href.toLowerCase(),"burndowntype"),this.placeholder=e.placeholder,this.contextProvider=e.contextProvider,this.filterProvider=e.filterProvider,this.updatePlannable=e.updatePlannable,this.savedFilter=e.savedFilter?e.savedFilter:{plannableId:-1,burnDownType:this._getDefaultType()},isNaN(this.queryStringPlannableId)||"teamiteration"!=this.queryStringBurnDownType&&"release"!=this.queryStringBurnDownType&&"iteration"!=this.queryStringBurnDownType||(this.savedFilter.plannableId=this.queryStringPlannableId,this.savedFilter.burnDownType=this.typeDictionary[this.queryStringBurnDownType])},_getPlannableFromQueryString:function(){var e=null;if(!isNaN(this.queryStringPlannableId)){var t=this;e=this.filterProvider.allIterations.filter(function(e){return e.id==t.queryStringPlannableId})[0]}return e},_getSavedPlannable:function(){var t=this._getPlannables(),r=this,n=e.grep(t,function(e){return e.id==r.savedFilter.plannableId});return n.length?n[0]:null},_getDefaultPlannable:function(){var t=this._getPlannables(),r=this.filterProvider._getDefaultIteration();if(!r){var n=e.grep(t,function(e){return e.current});n.length&&(r=n[0])}return r},render:function(){function t(){return n.savedFilter.burnDownType.toLowerCase()==this.toLowerCase()}var r=[{id:"",name:"",items:[]}];(this._isIterationsAvailable()||"iteration"==this.queryStringBurnDownType)&&r[0].items.push({id:"iteration",name:this.contextProvider.getIterationTerm()}),r[0].items.push({id:"release",name:this.contextProvider.getReleaseTerm()}),this._areTeamIterationsAvailable()&&r[0].items.push({id:"teamiteration",name:"Team Iteration"});var n=this,i=e.proxy(function(){var e=this._getSavedPlannable()||this._getDefaultPlannable();return e?e.id:0},n),a=e.proxy(function(){return this.filterProvider.getIterationsDropDownDataSource(this._getPlannables())},n),o=e.proxy(function(){return this.filterProvider.getIterationsDropDownDataSource(this._getCurrentPlannables())},n),l=e.proxy(function(){var e=n.filterProvider._getSelectedPlannable()||n._getPlannableFromQueryString()||this._getSavedPlannable()||this._getDefaultPlannable();e&&e.entityType.toLowerCase()==n.getType().toLowerCase()&&(n.contextProvider.setCurrentProject(e.parent.id),n.filterProvider.setStartDate(e.startDate),n.filterProvider.processFilterOptionsVisibility(e)),n.filterProvider.update()},n),s=e.proxy(function(){n.iterationsDropDown||(n.iterationsDropDown=n.placeholder.find("._selectedIteration").dropDown({value:i(),quickData:o(),data:a(),select:l})),l()},n),u=e.proxy(function(){n.iterationsDropDown.dropDown("option","data",a()),n.iterationsDropDown.dropDown("option","quickData",o()),n.iterationsDropDown.dropDown("option","value",i()),l()},n),p=n._getDefaultType();n.savedFilter&&n.savedFilter.burnDownType&&e(n._getPossibleTypes()).filter(t).length>0&&(p=n.savedFilter.burnDownType),this.burnDownTypeDropDown=this.placeholder.find("._burnDownType").dropDown({value:p,quickData:r,data:[],select:function(){var e=n.burnDownTypeDropDown.dropDown("value");n.updatePlannable(e,u)}}),s()},getPlannableId:function(){return this.iterationsDropDown.dropDown("value")},getType:function(){return this.burnDownTypeDropDown?this.burnDownTypeDropDown.dropDown("value"):this.savedFilter&&this.savedFilter.burnDownType?this.savedFilter.burnDownType:this._getDefaultType()},_getPlannables:function(){return this._filterPlannables(this.filterProvider.allIterations)},_getCurrentPlannables:function(){return this._filterPlannables(this.filterProvider.allCurrentIterations)},_filterPlannables:function(e){var t=this.getType();return e.filter(function(e){return e.entityType.toLowerCase()==t.toLowerCase()})},_getDefaultType:function(){return this._getPossibleTypes()[0]},_getPossibleTypes:function(){function t(e){return function(t,r){return r.entityType.toLowerCase()==e.toLowerCase()}}var r=this,n=[];return this._isIterationsAvailable()&&n.push("iteration"),n.push("release"),this._areTeamIterationsAvailable()&&n.push("teamiteration"),e(n).filter(function(n,i){return e(r.filterProvider.allIterations).filter(t(i)).length>0})},_isIterationsAvailable:function(){return this.contextProvider.isPracticeAvailable("Iterations")},_areTeamIterationsAvailable:function(){return this.contextProvider.getTeamIds().length>0}},i});