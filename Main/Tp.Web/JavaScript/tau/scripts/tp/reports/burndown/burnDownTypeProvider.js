define(["jQuery","app.path","tp/reports/burndown/dataProvider","tau/core/tau","tp/dropdown"],function($,appPath,dataProvider,tau){function BurnDownType(config){this.dataProvider=new dataProvider,this.typeDictionary={iteration:"iteration",release:"release",teamiteration:"teamiteration"}}return BurnDownType.prototype={initialize:function(config){this.queryStringPlannableId=parseInt(tau.getQueryValueFromUrl(location.href.toLowerCase(),"entityid")),this.queryStringBurnDownType=tau.getQueryValueFromUrl(location.href.toLowerCase(),"burndowntype"),this.placeholder=config.placeholder,this.contextProvider=config.contextProvider,this.filterProvider=config.filterProvider,this.updatePlannable=config.updatePlannable,this.savedFilter=config.savedFilter?config.savedFilter:{plannableId:-1,burnDownType:this._getDefaultType()},!isNaN(this.queryStringPlannableId)&&(this.queryStringBurnDownType=="teamiteration"||this.queryStringBurnDownType=="release"||this.queryStringBurnDownType=="iteration")&&(this.savedFilter.plannableId=this.queryStringPlannableId,this.savedFilter.burnDownType=this.typeDictionary[this.queryStringBurnDownType])},_getPlannableFromQueryString:function(){var plannable=null;if(!isNaN(this.queryStringPlannableId)){var that=this;plannable=this.filterProvider.allIterations.filter(function(item){return item.id==that.queryStringPlannableId})[0]}return plannable},_getSavedPlannable:function(){var plannables=this._getPlannables(),that=this,savedPlannable=$.grep(plannables,function(item){return item.id==that.savedFilter.plannableId});return savedPlannable.length?savedPlannable[0]:null},_getDefaultPlannable:function(){var plannables=this._getPlannables(),defaultIteration=this.filterProvider._getDefaultIteration();if(!defaultIteration){var curIterations=$.grep(plannables,function(item){return item.current});curIterations.length&&(defaultIteration=curIterations[0])}return defaultIteration},render:function(){function isSavedFilter(){return that.savedFilter.burnDownType.toLowerCase()==this.toLowerCase()}var burnDownTypeData=[{id:"",name:"",items:[]}];(this._isIterationsAvailable()||this.queryStringBurnDownType=="iteration")&&burnDownTypeData[0].items.push({id:"iteration",name:this.contextProvider.getIterationTerm()}),burnDownTypeData[0].items.push({id:"release",name:this.contextProvider.getReleaseTerm()}),this._areTeamIterationsAvailable()&&burnDownTypeData[0].items.push({id:"teamiteration",name:"Team Iteration"});var that=this,iterationValueGetter=$.proxy(function(){var savedPlannable=this._getSavedPlannable()||this._getDefaultPlannable();return savedPlannable?savedPlannable.id:0},that),iterationDataGetter=$.proxy(function(){return this.filterProvider.getIterationsDropDownDataSource(this._getPlannables())},that),iterationQuickDataGetter=$.proxy(function(){return this.filterProvider.getIterationsDropDownDataSource(this._getCurrentPlannables())},that),updateContext=$.proxy(function(){var iteration=that.filterProvider._getSelectedPlannable()||that._getPlannableFromQueryString()||this._getSavedPlannable()||this._getDefaultPlannable();iteration&&iteration.entityType.toLowerCase()==that.getType().toLowerCase()&&(that.contextProvider.setCurrentProject(iteration.parent.id),that.filterProvider.setStartDate(iteration.startDate),that.filterProvider.processFilterOptionsVisibility(iteration)),that.filterProvider.update()},that),updateIterations=$.proxy(function(){that.iterationsDropDown||(that.iterationsDropDown=that.placeholder.find("._selectedIteration").dropDown({value:iterationValueGetter(),quickData:iterationQuickDataGetter(),data:iterationDataGetter(),select:updateContext})),updateContext()},that),updateTypes=$.proxy(function(){that.iterationsDropDown.dropDown("option","data",iterationDataGetter()),that.iterationsDropDown.dropDown("option","quickData",iterationQuickDataGetter()),that.iterationsDropDown.dropDown("option","value",iterationValueGetter()),updateContext()},that),burnDownType=that._getDefaultType();that.savedFilter&&that.savedFilter.burnDownType&&$(that._getPossibleTypes()).filter(isSavedFilter).length>0&&(burnDownType=that.savedFilter.burnDownType),this.burnDownTypeDropDown=this.placeholder.find("._burnDownType").dropDown({value:burnDownType,quickData:burnDownTypeData,data:[],select:function(){var type=that.burnDownTypeDropDown.dropDown("value");that.updatePlannable(type,updateTypes)}}),updateIterations()},getPlannableId:function(){return this.iterationsDropDown.dropDown("value")},getType:function(){return this.burnDownTypeDropDown?this.burnDownTypeDropDown.dropDown("value"):this.savedFilter&&this.savedFilter.burnDownType?this.savedFilter.burnDownType:this._getDefaultType()},_getPlannables:function(){return this._filterPlannables(this.filterProvider.allIterations)},_getCurrentPlannables:function(){return this._filterPlannables(this.filterProvider.allCurrentIterations)},_filterPlannables:function(items){var type=this.getType();return items.filter(function(item){return item.entityType.toLowerCase()==type.toLowerCase()})},_getDefaultType:function(){return this._getPossibleTypes()[0]},_getPossibleTypes:function(){function isOfType(type){return function(_,plannable){return plannable.entityType.toLowerCase()==type.toLowerCase()}}var self=this,types=[];return this._isIterationsAvailable()&&types.push("iteration"),types.push("release"),this._areTeamIterationsAvailable()&&types.push("teamiteration"),$(types).filter(function(_,type){return $(self.filterProvider.allIterations).filter(isOfType(type)).length>0})},_isIterationsAvailable:function(){return this.contextProvider.isPracticeAvailable("Iterations")},_areTeamIterationsAvailable:function(){return this.contextProvider.getTeamIds().length>0}},BurnDownType})