define(["jQuery","app.path","tp/date.utils","libs/jquery/jquery.tmpl"],function($,appPath,du){function setAlign(val){return function(config){return config.my=val,config}}return $.widget("ui.summaryPopup",{options:{index:0,data:[],show:$.noop,hide:$.noop,navigate:$.noop},_template:'<div class="chart-bubble">\n    <div class="date">${title}</div>\n    <div class="_details">\n        <table>\n            <tr class="{{if yesterday}}_collapsible collapse-block{{else}}noncollapse-block{{/if}}">\n                <td>\n                    <div class="indicator-small yesterday">${yesterday.toFixed(2).replace(".00", "")}${units}</div>\n                </td>\n                <td style="width: 100%;">\n                    <div class="_remained yesterday-text">{{if initial}}Initial&nbsp;Effort{{else}}Start-of-Day&nbsp;Time&nbsp;Remaining{{/if}}\n                    </div>\n                </td>\n            </tr>\n\n            <tr style="display: none;">\n                <td colspan="2" class="nopadding">\n                    <div class="inner-top-shadow"></div>\n                        <div class="inner">\n                            <table>\n                                {{each effort.remained}}\n                                <tr>\n                                    <td><span class="entity-indicator">${total}${units}</span></td>\n                                    <td><i class="tau-entity-icon tau-${entityType}">${term}</i></td>\n                                    <td class="name"><div class="name-overflow">\n                                    {{if isDeleted === true}}\n                                        <span data-type="${entityType}">${name}</span>\n                                    {{else}}\n                                        <a href="${url}" title="${name}" data-id="${id}" data-type="${entityType}" class="_entity-ref">${name}</a>\n                                    {{/if}}\n                                    \n                                    </div></td>\n                                </tr>\n                                {{/each}}\n                            </table>\n                        </div>\n                    <div class="inner-bottom-shadow"></div>\n                </td>\n            </tr>\n\n            {{if added}}\n            <tr  class="_collapsible collapse-block">\n                <td>\n                    <div class="indicator-small add">+&nbsp;${added.toFixed(2).replace(".00", "")}${units}</div>\n                </td>\n                <td style="width: 100%;">\n                    <div class="_added complete-text">Added</div>\n                </td>\n            </tr>\n            <tr style="display: none;">\n                <td colspan="2" class="nopadding">\n                    <div class="inner-top-shadow"></div>\n                        <div class="inner">\n                            <table>\n                                {{each effort.added}}\n                                <tr>\n                                    <td><span class="entity-indicator">${total}${units}</span></td>\n                                    <td><i class="tau-entity-icon tau-${entityType}">${term}</i></td>\n                                    <td class="name _parent"><div class="name-overflow">\n                                    {{if isDeleted === true}}\n                                        <span data-type="${entityType}">${name}</span>\n                                    {{else}}\n                                        <a href="${url}" title="${name}" data-id="${id}" data-type="${entityType}" class="_entity-ref">${name}</a>\n                                    {{/if}}\n                                    </div></td>\n                                </tr>\n\n                                {{if showChildren}}\n                                <tr><td colspan="3"><table>\n                                    {{each children}}\n                                    <tr class="inner-task">\n                                        <td class="task-time"><span class="entity-indicator">${effort}{{if entityType == \'Task\'}}h{{else}}${units}{{/if}}</span></td>\n                                        <td><i class="tau-entity-icon tau-${entityType}">${term}</i></td>\n                                        <td class="name font-11"><div class="name-overflow">\n                                        {{if isDeleted === true}}\n                                            <span data-type="${entityType}">${name}</span>\n                                        {{else}}\n                                            <a href="${url}" title="${name}" data-id="${id}" data-type="${entityType}" class="_entity-ref">${name}</a>\n                                        {{/if}}\n                                        </div></td>\n                                    </tr>\n                                    {{/each}}\n                                </table></td></tr>\n                                {{/if}}\n                                {{/each}}\n                            </table>\n                        </div>\n                    <div class="inner-bottom-shadow"></div>\n                </td>\n            </tr>\n            {{/if}}\n\n            {{if removed}}\n\n            <tr class="_collapsible collapse-block">\n                <td>\n                    <div class="indicator-small remove" style="white-space:nowrap;">-&nbsp;${removed.toFixed(2).replace(".00", "")}${units}</div>\n                </td>\n                <td style="width: 100%;">\n                    <div class="_removed complete-text">Removed</div>\n                </td>\n            </tr>\n            <tr style="display: none;">\n                <td colspan="2" class="nopadding">\n                    <div class="inner-top-shadow"></div>\n                        <div class="inner">\n                            <table>\n                                {{each effort.removed}}\n                                <tr>\n                                    <td><span class="entity-indicator">${total}${units}</span></td>\n                                    <td><i class="tau-entity-icon tau-${entityType}">${term}</i></td>\n                                    <td class="name _parent"><div class="name-overflow">\n                                    {{if isDeleted === true}}\n                                        <span data-type="${entityType}">${name}</span>\n                                    {{else}}    \n                                        <a href="${url}" title="${name}" data-id="${id}" data-type="${entityType}" class="_entity-ref">${name}</a>\n                                    {{/if}}\n                                    </div></td>\n                                </tr>\n                                {{if showChildren}}\n                                <tr><td colspan="3"><table>\n                                    {{each children}}\n                                    <tr class="inner-task">\n                                        <td class="task-time"><span class="entity-indicator">${effort}{{if entityType == \'Task\'}}h{{else}}${units}{{/if}}</span></td>\n                                        <td><i class="tau-entity-icon tau-${entityType}">${term}</i></td>\n                                        <td class="name font-11"><div class="name-overflow">\n                                        {{if isDeleted === true}}\n                                            <span data-type="${entityType}">${name}</span>\n                                        {{else}}    \n                                            <a href="${url}" title="${name}" data-id="${id}" data-type="${entityType}" class="_entity-ref">${name}</a>\n                                        {{/if}}\n                                        </div></td>\n                                    </tr>\n                                    {{/each}}\n                                </table></td></tr>\n                                {{/if}}\n                                {{/each}}\n                            </table>\n                        </div>\n                    <div class="inner-bottom-shadow"></div>\n                </td>\n            </tr>\n            {{/if}}\n\n            {{if spent}}\n            <tr class="_collapsible collapse-block">\n                <td>\n                    <div class="indicator-small complete" style="white-space: nowrap;">-&nbsp;${spent.toFixed(2).replace(".00", "")}${units}</div>\n                </td>\n                <td style="width: 100%;">\n                    <div class="_spent complete-text">Completed</div>\n                </td>\n            </tr>\n            <tr style="display: none;">\n                <td colspan="2" class="nopadding">\n                    <div class="inner-top-shadow"></div>\n                        <div class="inner">\n                            <table>\n                                {{each effort.spent}}\n                                <tr>\n                                    <td><span class="entity-indicator">${total}${units}</span></td>\n                                    <td><i class="tau-entity-icon tau-${entityType}">${term}</i></td>\n                                    <td class="name _parent"><div class="name-overflow">\n                                    {{if isDeleted === true}}\n                                        <span data-type="${entityType}">${name}</span>\n                                    {{else}}    \n                                        <a href="${url}" title="${name}" data-id="${id}" data-type="${entityType}" class="_entity-ref">${name}</a>\n                                    {{/if}}\n                                    </div></td>\n                                </tr>\n                                {{if showChildren}}\n                                <tr><td colspan="3"><table>\n                                    {{each children}}\n                                    <tr class="inner-task">\n                                        <td class="task-time"><span class="entity-indicator">${effort}{{if entityType == \'Task\'}}h{{else}}${units}{{/if}}</span></td>\n                                        <td><i class="tau-entity-icon tau-${entityType}">${term}</i></td>\n                                        <td class="name font-11"><div class="name-overflow">\n                                        {{if isDeleted === true}}\n                                            <span data-type="${entityType}">${name}</span>\n                                        {{else}}    \n                                            <a href="${url}" title="${name}" data-id="${id}" data-type="${entityType}" class="_entity-ref">${name}</a>\n                                        {{/if}}\n                                        </div></td>\n                                    </tr>\n                                    {{/each}}\n                                </table></td></tr>\n                                {{/if}}\n                                {{/each}}\n                            </table>\n                        </div>\n                    <div class="inner-bottom-shadow"></div>\n                </td>\n            </tr>\n            {{/if}}\n    </div>\n    {{if remained}}\n\n    <tr>\n        <td>\n            <div class="remain{{if today}} today{{/if}}">${remained.toFixed(2).replace(".00", "")}${units}</div>\n        </td>\n        <td>\n            <div class="_remained remain-text{{if today}} today{{/if}}">End-of-Day Time Remaining</div>\n        </td>\n    </tr>\n    {{/if}}\n    \n    {{if forecast != null && today}}\n\n    <tr>\n         <td>\n            <div class="remain today">${forecast}</div>\n        </td>\n        <td>\n            <div class="_forecast remain-text today">Forecast End Date</div>\n        </td>\n    </tr>\n    {{/if}}\n    \n    </table>\n</div>\n',_create:function(){this.element.tauBubble({className:"tau-summaryPopup",alignTo:this.options.alignTo,onPositionConfig:setAlign("left top"),onBeforeShow:$.proxy(this._onBeforeShow,this),onHide:$.proxy(this._onHide,this),dontCloseSelectors:["div.close"]})},show:function(){this.element.tauBubble("show"),this.options.show()},popup:function(){return this.element.data("tauBubble").$popup},_onHide:function(){this.options.hide()},_onBeforeShow:function(){var data=this._getTemplateData(this.options.data,this.options.index),content=$.tmpl(this._template,data);content.find("._details").accordion({header:"tr._collapsible",collapsible:!0,active:!1,icons:!1,autoHeight:!1,animated:!1});var self=this;content.on("click","._entity-ref",function(event){var $this=$(this),d=$this.data();event.preventDefault(),self.options.navigate({id:d.id,type:d.type})}),this.element.tauBubble("option","content",content).on("close",function(){content.find("._details").accordion("destroy"),content.off("click","._entity-ref")})},_getTemplateData:function(d,i){var termProcessor=this.options.termProcessor,that=this,getEffort=function(efft){return efft.map(function(ef){var children=ef.children.filter(function(child){return child.effort}).map(function(child){return{id:child.id,name:child.name,effort:child.effort,url:that._getUrl(child.id,child.entityType),term:termProcessor.getTerms(child.entityType).iconSmall,isDeleted:child.isDeleted,entityType:child.entityType}}),bugsChilds=$.grep(children,function(el,i){return el.entityType=="Bug"}),showChildren=!1;return ef.action!="None"?bugsChilds.length>0&&(showChildren=!0,children=bugsChilds):showChildren=!0,{id:ef.id,name:ef.name,total:ef.total,action:ef.action,url:that._getUrl(ef.id,ef.entityType),term:termProcessor.getTerms(ef.entityType).iconSmall,isDeleted:ef.isDeleted,entityType:ef.entityType,showChildren:showChildren,children:children}})};return{initial:i==0,yesterday:d.total.remained,title:d.title?d.title:d.date.endDate.toString("d MMMM, dddd"),date:d.date,remained:d.total.remainedForNextDay,spent:d.total.spent,added:d.total.added,removed:d.total.removed,today:d.today,units:d.units,forecast:d.forecast!=null?d.forecast.toString("d MMM").replace(" ","&nbsp;"):null,effort:{remained:getEffort(d.effort.remained),spent:getEffort(d.effort.spent),added:getEffort(d.effort.added),removed:getEffort(d.effort.removed)}}},_getUrl:function(id,entityType){var term=entityType=="Bug"?"QA":"Planning";return(new appPath.tp.WebServiceURL((new appPath.tp.AcidURL("/Project/"+term+"/"+entityType+"/View.aspx?"+entityType+"ID="+id)).toString())).toString()},destroy:function(){this.element.tauBubble("destroy")}}),$})