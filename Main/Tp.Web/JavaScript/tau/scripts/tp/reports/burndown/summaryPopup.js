define(["jQuery","app.path","tau/utils/utils.date","libs/jquery/jquery.tmpl"],function(t,n){return t.widget("ui.summaryPopup",{options:{index:0,data:[],show:t.noop,hide:t.noop,navigate:t.noop},_template:'<div class="chart-bubble">\n    <div class="date">${title}</div>\n    <div class="_details">\n        <table>\n            <tr class="{{if yesterday}}_collapsible collapse-block{{else}}noncollapse-block{{/if}}">\n                <td>\n                    <div class="indicator-small yesterday">${yesterday.toFixed(2).replace(".00", "")}${units}</div>\n                </td>\n                <td style="width: 100%;">\n                    <div class="_remained yesterday-text">{{if initial}}Initial&nbsp;Effort{{else}}Start-of-Day&nbsp;Time&nbsp;Remaining{{/if}}\n                    </div>\n                </td>\n            </tr>\n\n            <tr style="display: none;">\n                <td colspan="2" class="nopadding">\n                    <div class="inner-top-shadow"></div>\n                        <div class="inner">\n                            <table>\n                                {{each effort.remained}}\n                                <tr>\n                                    <td><span class="entity-indicator">${total}${units}</span></td>\n                                    <td><i class="tau-entity-icon tau-entity-icon--${entityType.toLowerCase()}">${term}</i></td>\n                                    <td class="name"><div class="name-overflow">\n                                    {{if isDeleted === true}}\n                                        <span data-type="${entityType}">${name}</span>\n                                    {{else}}\n                                        <a href="${url}" title="${name}" data-id="${id}" data-type="${entityType}" class="_entity-ref">${name}</a>\n                                    {{/if}}\n                                    \n                                    </div></td>\n                                </tr>\n                                {{/each}}\n                            </table>\n                        </div>\n                    <div class="inner-bottom-shadow"></div>\n                </td>\n            </tr>\n\n            {{if added}}\n            <tr  class="_collapsible collapse-block">\n                <td>\n                    <div class="indicator-small add">+&nbsp;${added.toFixed(2).replace(".00", "")}${units}</div>\n                </td>\n                <td style="width: 100%;">\n                    <div class="_added complete-text">Added</div>\n                </td>\n            </tr>\n            <tr style="display: none;">\n                <td colspan="2" class="nopadding">\n                    <div class="inner-top-shadow"></div>\n                        <div class="inner">\n                            <table>\n                                {{each effort.added}}\n                                <tr>\n                                    <td><span class="entity-indicator">${total}${units}</span></td>\n                                    <td><i class="tau-entity-icon tau-entity-icon--${entityType.toLowerCase()}">${term}</i></td>\n                                    <td class="name _parent"><div class="name-overflow">\n                                    {{if isDeleted === true}}\n                                        <span data-type="${entityType}">${name}</span>\n                                    {{else}}\n                                        <a href="${url}" title="${name}" data-id="${id}" data-type="${entityType}" class="_entity-ref">${name}</a>\n                                    {{/if}}\n                                    </div></td>\n                                </tr>\n\n                                {{if showChildren}}\n                                <tr><td colspan="3"><table>\n                                    {{each children}}\n                                    <tr class="inner-task">\n                                        <td class="task-time"><span class="entity-indicator">${effort}{{if entityType == \'Task\'}}h{{else}}${units}{{/if}}</span></td>\n                                        <td><i class="tau-entity-icon tau-entity-icon--${entityType.toLowerCase()}">${term}</i></td>\n                                        <td class="name font-11"><div class="name-overflow">\n                                        {{if isDeleted === true}}\n                                            <span data-type="${entityType}">${name}</span>\n                                        {{else}}\n                                            <a href="${url}" title="${name}" data-id="${id}" data-type="${entityType}" class="_entity-ref">${name}</a>\n                                        {{/if}}\n                                        </div></td>\n                                    </tr>\n                                    {{/each}}\n                                </table></td></tr>\n                                {{/if}}\n                                {{/each}}\n                            </table>\n                        </div>\n                    <div class="inner-bottom-shadow"></div>\n                </td>\n            </tr>\n            {{/if}}\n\n            {{if removed}}\n\n            <tr class="_collapsible collapse-block">\n                <td>\n                    <div class="indicator-small remove" style="white-space:nowrap;">-&nbsp;${removed.toFixed(2).replace(".00", "")}${units}</div>\n                </td>\n                <td style="width: 100%;">\n                    <div class="_removed complete-text">Removed</div>\n                </td>\n            </tr>\n            <tr style="display: none;">\n                <td colspan="2" class="nopadding">\n                    <div class="inner-top-shadow"></div>\n                        <div class="inner">\n                            <table>\n                                {{each effort.removed}}\n                                <tr>\n                                    <td><span class="entity-indicator">${total}${units}</span></td>\n                                    <td><i class="tau-entity-icon tau-entity-icon--${entityType.toLowerCase()}">${term}</i></td>\n                                    <td class="name _parent"><div class="name-overflow">\n                                    {{if isDeleted === true}}\n                                        <span data-type="${entityType}">${name}</span>\n                                    {{else}}    \n                                        <a href="${url}" title="${name}" data-id="${id}" data-type="${entityType}" class="_entity-ref">${name}</a>\n                                    {{/if}}\n                                    </div></td>\n                                </tr>\n                                {{if showChildren}}\n                                <tr><td colspan="3"><table>\n                                    {{each children}}\n                                    <tr class="inner-task">\n                                        <td class="task-time"><span class="entity-indicator">${effort}{{if entityType == \'Task\'}}h{{else}}${units}{{/if}}</span></td>\n                                        <td><i class="tau-entity-icon tau-entity-icon--${entityType.toLowerCase()}">${term}</i></td>\n                                        <td class="name font-11"><div class="name-overflow">\n                                        {{if isDeleted === true}}\n                                            <span data-type="${entityType}">${name}</span>\n                                        {{else}}    \n                                            <a href="${url}" title="${name}" data-id="${id}" data-type="${entityType}" class="_entity-ref">${name}</a>\n                                        {{/if}}\n                                        </div></td>\n                                    </tr>\n                                    {{/each}}\n                                </table></td></tr>\n                                {{/if}}\n                                {{/each}}\n                            </table>\n                        </div>\n                    <div class="inner-bottom-shadow"></div>\n                </td>\n            </tr>\n            {{/if}}\n\n            {{if spent}}\n            <tr class="_collapsible collapse-block">\n                <td>\n                    <div class="indicator-small complete" style="white-space: nowrap;">-&nbsp;${spent.toFixed(2).replace(".00", "")}${units}</div>\n                </td>\n                <td style="width: 100%;">\n                    <div class="_spent complete-text">Completed</div>\n                </td>\n            </tr>\n            <tr style="display: none;">\n                <td colspan="2" class="nopadding">\n                    <div class="inner-top-shadow"></div>\n                        <div class="inner">\n                            <table>\n                                {{each effort.spent}}\n                                <tr>\n                                    <td><span class="entity-indicator">${total}${units}</span></td>\n                                    <td><i class="tau-entity-icon tau-entity-icon--${entityType.toLowerCase()}">${term}</i></td>\n                                    <td class="name _parent"><div class="name-overflow">\n                                    {{if isDeleted === true}}\n                                        <span data-type="${entityType}">${name}</span>\n                                    {{else}}    \n                                        <a href="${url}" title="${name}" data-id="${id}" data-type="${entityType}" class="_entity-ref">${name}</a>\n                                    {{/if}}\n                                    </div></td>\n                                </tr>\n                                {{if showChildren}}\n                                <tr><td colspan="3"><table>\n                                    {{each children}}\n                                    <tr class="inner-task">\n                                        <td class="task-time"><span class="entity-indicator">${effort}{{if entityType == \'Task\'}}h{{else}}${units}{{/if}}</span></td>\n                                        <td><i class="tau-entity-icon tau-entity-icon--${entityType.toLowerCase()}">${term}</i></td>\n                                        <td class="name font-11"><div class="name-overflow">\n                                        {{if isDeleted === true}}\n                                            <span data-type="${entityType}">${name}</span>\n                                        {{else}}    \n                                            <a href="${url}" title="${name}" data-id="${id}" data-type="${entityType}" class="_entity-ref">${name}</a>\n                                        {{/if}}\n                                        </div></td>\n                                    </tr>\n                                    {{/each}}\n                                </table></td></tr>\n                                {{/if}}\n                                {{/each}}\n                            </table>\n                        </div>\n                    <div class="inner-bottom-shadow"></div>\n                </td>\n            </tr>\n            {{/if}}\n    </div>\n    {{if remained}}\n\n    <tr>\n        <td>\n            <div class="remain{{if today}} today{{/if}}">${remained.toFixed(2).replace(".00", "")}${units}</div>\n        </td>\n        <td>\n            <div class="_remained remain-text{{if today}} today{{/if}}">End-of-Day Time Remaining</div>\n        </td>\n    </tr>\n    {{/if}}\n    \n    {{if forecast != null && today}}\n\n    <tr>\n         <td>\n            <div class="remain today">${forecast}</div>\n        </td>\n        <td>\n            <div class="_forecast remain-text today">Forecast End Date</div>\n        </td>\n    </tr>\n    {{/if}}\n    \n    </table>\n</div>\n',_create:function(){this.element.tauBubble({className:"tau-summaryPopup",alignTo:this.options.alignTo,onPositionConfig:function(t){t.my="left top"
},onArrowPositionConfig:function(t,n){"top"===n?t.my+="+1":"bottom"===n&&(t.my+="-1")},onBeforeShow:t.proxy(this._onBeforeShow,this),onHide:t.proxy(this._onHide,this),dontCloseSelectors:["div.close"]})},show:function(){this.element.tauBubble("show"),this.options.show()},popup:function(){return this.element.data("ui-tauBubble").$popup},_onHide:function(){this.options.hide()},_onBeforeShow:function(){var n=this._getTemplateData(this.options.data,this.options.index),e=t.tmpl(this._template,n),i=this;e.find("._details").accordion({header:"tr._collapsible",collapsible:!0,active:!1,icons:!1,autoHeight:!1,animated:!1,change:function(){i.element.tauBubble("adjustPosition")}});var a=this;e.on("click","._entity-ref",function(n){var e=t(this),i=e.data();n.preventDefault(),a.options.navigate({id:i.id,type:i.type})}),this.element.tauBubble("option","content",e).on("close",function(){var t=e.find("._details");t.data("ui-accordion")&&t.accordion("destroy"),e.off("click","._entity-ref")})},_getTemplateData:function(n,e){var i=this.options.termProcessor,a=this,s=function(n){return n.map(function(n){var e=n.children.filter(function(t){return t.effort}).map(function(t){return{id:t.id,name:t.name,effort:t.effort,url:a._getUrl(t.id,t.entityType),term:i.getTerms(t.entityType).iconSmall,isDeleted:t.isDeleted,entityType:t.entityType}}),s=t.grep(e,function(t){return"Bug"==t.entityType}),d=!1;return"None"==n.action?d=!0:s.length>0&&(d=!0,e=s),{id:n.id,name:n.name,total:n.total,action:n.action,url:a._getUrl(n.id,n.entityType),term:i.getTerms(n.entityType).iconSmall,isDeleted:n.isDeleted,entityType:n.entityType,showChildren:d,children:e}})};return{initial:0==e,yesterday:n.total.remained,title:n.title?n.title:n.date.startDate.toString("d MMMM, dddd"),date:n.date,remained:n.total.remained+n.total.added-n.total.spent-n.total.removed,spent:n.total.spent,added:n.total.added,removed:n.total.removed,today:n.today,units:n.units,forecast:null==n.forecast?null:n.forecast.toString("d MMM").replace(" ","&nbsp;"),effort:{remained:s(n.effort.remained),spent:s(n.effort.spent),added:s(n.effort.added),removed:s(n.effort.removed)}}
},_getUrl:function(t,e){var i="/View.aspx?ID="+t+"&Entity="+e;return new n.tp.WebServiceURL(new n.tp.AcidURL(i).toString()).toString()},destroy:function(){this.element.tauBubble("destroy")}}),t});