define(["jQuery","Underscore","tp/reports/burndown/dataProvider","template!tau/components/burn.down.filter/templates/burn.down.filter.template","tp/reports/burndown/filterStorage","tp/reports/burndown/filterDataProvider","tau/utils/utils.date","app.path","tau/core/tau","tp/dropdown"],function(t,e,i,n,r,s,a,o,l){function u(t){this.featureService=t.featureService,this.template=t.template||n,this.placeholder=t.placeholder,this.contextProvider=t.contextProvider,this.dataProvider=t.dataProvider,this.storage=t.storage||new r({groupName:"burnDownVer2Filter"}),this.onUpdate=t.onUpdate||function(){},this.typeDictionary={iteration:"iteration",release:"release",teamiteration:"teamiteration"}}var h=-1;return u.prototype={initialize:function(){this.queryStringPlannableId=parseInt(l.getQueryValueFromUrl(location.href.toLowerCase(),"entityid")),this.queryStringBurnDownType=l.getQueryValueFromUrl(location.href.toLowerCase(),"burndowntype"),this.contextProvider.onReady().then(function(){return this.dataProvider.getPlannable({projectIds:this.contextProvider.getProjectIds(),teamIds:this.contextProvider.getTeamIds()})}.bind(this)).then(function(t){this.provider=new s({plannables:t,contextProvider:this.contextProvider})}.bind(this)).then(this._getFilter.bind(this)).then(this._render.bind(this))},update:function(t){t=t||{};var e=this._getFilterData();this._saveFilter(e),t.skipProjectDropdownUpdate||this._updateProjectDropDown(e),this.onUpdate(this.getData())},_saveFilter:function(t){this.storage.savePlannableFilter(t)},_getFilter:function(){var i=t.Deferred();return this.storage.findPlannableFilter(function(t){var n=t&&e.keys(t).length?t:this.provider.getDefaultFilterData();isNaN(this.queryStringPlannableId)||"teamiteration"!=this.queryStringBurnDownType&&"release"!=this.queryStringBurnDownType&&"iteration"!=this.queryStringBurnDownType||(n={plannableId:this.queryStringPlannableId,burnDownType:this.typeDictionary[this.queryStringBurnDownType]}),i.resolve(n)}.bind(this)),i.promise()},getType:function(t){return this.burnDownTypeDropDown?this.burnDownTypeDropDown.dropDown("value"):t&&t.burnDownType?t.burnDownType:this.provider.getDefaultType()
},getPlannableId:function(){return this.iterationsDropDown.dropDown("value")},_getPlannableFromQueryString:function(){var t=null;return isNaN(this.queryStringPlannableId)||(t=e.find(this.provider.allIterations,function(t){return t.id==this.queryStringPlannableId},this)),t},_getPlannableFrom:function(t){var i=this.getType(t);return e.find(this.provider.getPlannables(i),function(e){return e.id==t.plannableId},this)},_initializeProjectDropDown:function(t){var i=this._getPlannableFrom(t)||this.getDefaultIteration(),n=t&&t.projectIds?t.projectIds:[],r=n[0]||h,s=i?i.parents:[],a=this.provider.getProjectsList(s),o=e.pluck(a[0].items,"id");e.contains(o,r)||(r=h),this.projectDropDown=this.placeholder.find("._selectedProject").dropDown({value:r,quickData:a,data:[],select:this.update.bind(this,{skipProjectDropdownUpdate:!0})})},_getSelectedProject:function(t,i){i=i||{};var n=i.initial,r=i.availableProjects?i.availableProjects:[];r=e.pluck(r,"parentId");var s=n?t:this._getFilterData(),a=s&&s.projectIds?s.projectIds[0]:h,o=r.indexOf(a)>=0;return a=o?a:h},_updateProjectDropDown:function(t){if(this.projectDropDown){var e=this._getSelectedPlannable(),i=this._getSelectedProject(t,{availableProjects:e?e.parents:[]}),n=e?e.parents:[];this.projectDropDown.dropDown("option","quickData",this.provider.getProjectsList(n)),this.projectDropDown.dropDown("option","value",i)}},_getSelectedProjects:function(){var t=this.projectDropDown?this.projectDropDown.dropDown("value"):null;return t=t==h?null:t,t?[t]:t},getData:function(){var t=this._getSelectedPlannable(),e=this._getStartDate();if(t&&e){var i=this._getFilterBaseData(e,t.typeName,t);i.manuallySetVelocity=this.getManuallySetVelocity();var n=this._getSelectedProjects();return n&&(i.projectIds=n),i}return null},_render:function(i){this.placeholder.html(this.template.render());var n=this.placeholder.find(".tau-chart-filter-list__item");n.filter(":not(._empty)").toggle(!!this.provider.allIterations.length),n.filter("._empty").toggle(!this.provider.allIterations.length),t.datepicker.parseDate=function(t,e){return a.parse(e)
},t.datepicker.formatDate=function(t,e){return a.formatAs(e,t)},this.placeholder.find("._startDate").datepicker({buttonImageOnly:!1,showOn:"both",buttonText:"Choose",onSelect:this.update.bind(this),dateFormat:"MM/dd/yyyy"}),this._pointsButton().on("click keypress",this._onUnitsClick.bind(this)),this._hoursButton().on("click keypress",this._onUnitsClick.bind(this)),this.placeholder.on("click keypress","._weekends, ._include-bugs",this.update.bind(this));var r=function(){var t=this.getType(i),e=this._getPlannableFrom(i)||this.provider.getDefaultPlannable(t);return e?e.id:0}.bind(this),s=function(){var t=this.getType(i);return this.getIterationsDropDownDataSource(this.provider.getPlannables(t))}.bind(this),o=function(){var t=this.getType(i);return this.getIterationsDropDownDataSource(this.provider.getCurrentPlannables(t))}.bind(this),l=function(t){var e=this.getType(i),n=this._getSelectedPlannable()||this._getPlannableFromQueryString()||this._getPlannableFrom(i)||this.provider.getDefaultPlannable(e);if(n&&n.entityType.toLowerCase()==e.toLowerCase()){this.contextProvider.setCurrentProject(n.parents[0].parentId);var r=n.startDate;t&&i.startDate&&i.plannableId===n.id&&(r=i.startDate),this.setStartDate(r),this.processFilterOptionsVisibility(n)}this.update()}.bind(this),u=function(){this.iterationsDropDown||(this.iterationsDropDown=this.placeholder.find("._selectedIteration").dropDown({value:r(),quickData:o(),data:s(),select:l})),this.featureService&&this._initializeProjectDropDown(i),l(!0)}.bind(this),h=function(){this.iterationsDropDown.dropDown("option","data",s()),this.iterationsDropDown.dropDown("option","quickData",o()),this.iterationsDropDown.dropDown("option","value",r()),l()}.bind(this),d=this._getPlannableFrom(i);d||(i=this.provider.getDefaultFilterData(i),d=this._getPlannableFrom(i)),this.processFilterOptionsVisibility(d),this._bugsSection().hasClass("invisible")||this._setShowBugs(i.showBugs),this._unitsSection().hasClass("invisible")||this._selectUnit(i.isInPoints),this._setIncludeWeekends(i.includeWeekends);
var c=this.provider.getDefaultType();i&&i.burnDownType&&e.any(this.provider.getPossibleTypes(),function(t){return i.burnDownType.toLowerCase()==t.toLowerCase()},this)&&(c=i.burnDownType);var p=[{id:"",name:"",items:[]}];(this.provider.isIterationsAvailable()||"iteration"==this.queryStringBurnDownType)&&p[0].items.push({id:"iteration",name:this.contextProvider.getIterationTerm()}),p[0].items.push({id:"release",name:this.contextProvider.getReleaseTerm()}),this.provider.areTeamIterationsAvailable()&&p[0].items.push({id:"teamiteration",name:"Team Iteration"}),this.burnDownTypeDropDown=this.placeholder.find("._burnDownType").dropDown({value:c,quickData:p,data:[],select:h.bind(this)}),u(),t(this).trigger("afterRender")},_onUnitsClick:function(e){var i=t(e.currentTarget).text()==this._pointsButton().text();this._selectUnit(i);var n=this._getSelectedPlannable();this._bugsSection().toggleClass("invisible",!n||!this._showBugs(n)),this.update()},_selectUnit:function(t){this._pointsButton().toggleClass("selected",t),this._hoursButton().toggleClass("selected",!t)},_showBugs:function(t){return t.isBugsAvailable&&!(t.isPointsAvailable&&!t.isTimeTrackingAvailable&&this._hoursButton().hasClass("selected")&&!this._unitsSection().hasClass("invisible"))},processFilterOptionsVisibility:function(t){t=t||{};var e=t.typeName||t.entityType||"",i=e.toLowerCase()==this.typeDictionary.release,n=this._unitsSection(),r=this._bugsSection(),s=this._projectsSection();t.isPointsAvailable?n.show():n.hide(),this._showBugs(t)?r.removeClass("invisible"):r.addClass("invisible"),this.featureService&&i?s.show():s.hide()},getDefaultIteration:function(){return this.provider.getDefaultIteration(this.getType())},getIterationsDropDownDataSource:function(t){return e.chain(t).pluck("parent").uniq(e.property("id")).map(function(i){return{id:i.id,name:i.name,items:e.chain(t).filter(function(t){return e.findWhere(t.parents,{parentId:i.id})}).map(function(t){return{id:t.id,name:t.current?t.name+" (current)":t.name}}).value()}
}).sort(function(t,e){return t.name==e.name?0:t.name.toLowerCase()<e.name.toLowerCase()?-1:1}).value()},getManuallySetVelocity:function(){var t=this.placeholder.closest("._burnDownReport").find(".velocity-input");return t.length>0&&""!==t.val()?parseFloat(t.val()):0},_getUrl:function(t){return new o.tp.WebServiceURL(t).url},_getFilterData:function(){var t=this._getSelectedPlannable(),e=this._getStartDate();if(t){var i=this._getFilterBaseData(e,this.getType(),t);return i.projectIds=this._getSelectedProjects(),i}return null},_getFilterBaseData:function(t,e,i){var n=i.isPointsAvailable&&this.isInPoints();return{burnDownType:e,plannableId:i.id,startDate:t?t:null,includeWeekends:this._getIncludeWeekends(),isInPoints:n,showBugs:this.isShowBugs(),units:n?"p":"h"}},_getStartDate:function(){var t=this._getRawStartDate();return a.format.date.short(t)},_getRawStartDate:function(){return this.placeholder.find("._startDate").datepicker().datepicker("getDate")},setStartDate:function(t){this.placeholder.find("._startDate").datepicker("setDate",t)},_getIncludeWeekends:function(){return this._isChecked("_weekends")},_setIncludeWeekends:function(t){return this.placeholder.find("._weekends").attr("checked",t)},isInPoints:function(){return this._unitsSection().hasClass("invisible")?this._getSelectedPlannable().isPointsAvailable:this._pointsButton().hasClass("selected")},isShowBugs:function(){return this._bugsSection().hasClass("invisible")?!1:this._isChecked("_include-bugs")},_isChecked:function(t){return this.placeholder.find("."+t+":not(.invisible)")&&"on"==this.placeholder.find("."+t+":checked").val()},_unitsSection:function(){return this.placeholder.find("._unitsOption")},_pointsButton:function(){return this.placeholder.find("._inPoints")},_hoursButton:function(){return this.placeholder.find("._inHours")},_bugsSection:function(){return this.placeholder.find("._bugsOption")},_projectsSection:function(){return this.placeholder.find(".i-selectedProject-wrap")},_setShowBugs:function(t){this.placeholder.find("._include-bugs").attr("checked",t)
},_getSelectedPlannable:function(){var e=this.getPlannableId(),i=t.grep(this.provider.allIterations,function(t){return t.id==e});if(i.length>0){var n=i[0];return n.typeName=this.getType(),n}return null}},u});