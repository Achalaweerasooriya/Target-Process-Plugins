define(["libs/d3/d3","tau/utils/utils.date","tp/reports/dataRepository","jQuery"],function(t,e,n,r){function a(){this.dataRepository=new n({url:"/reports/v1/burnDown"})}return a.prototype={yAxisPointsCount:10,yRoundTo:10,data:[],initialize:function(n,r){var a=this;a.filter=n,n?this.dataRepository.get(n,function(i){a.forecast=i.forecastFinishDate,a.forecastDay=i.forecastDay,a.iterationEndDay=i.iterationEndDay,a.isTitlesProvided=i.isTitlesProvided,a.velocity=i.velocity,a.manuallySetVelocity=i.manuallySetVelocity,a.decimalSeparator=i.decimalSeparator,a.isPlannableFinished=i.isPlannableFinished,a.d3=t,a.data=[];for(var o=i.effort,u=0;u<o.length;u++){var d=o[u],s=o[u+1],f={date:{startDate:e.convertToTimezone(d.date.startDate),endDate:e.convertToTimezone(d.date.endDate)},total:a._getTotal(d,s),effort:d.effort,units:n.units,forecast:null!=a.forecast?e.convertToTimezone(a.forecast):null};a.data.push(f)}a.data.length&&a._adjustLastDay(),r()}):r()},_getTotal:function(e,n){var r=null;return e.effort&&(r={remained:t.sum(e.effort,function(t){return t.remained}),spent:t.sum(e.effort,function(t){return t.spent}),added:t.sum(e.effort,function(t){return t.added}),removed:t.sum(e.effort,function(t){return Math.abs(t.removed)})},r.remainedForNextDay=n&&n.effort?t.sum(n.effort,function(t){return t.remained}):r.remained+r.added-r.spent-r.removed),r},_adjustLastDay:function(){for(var t=this.data.length-2;t>0;t--){var n=this.data[t],r=this.data[t-1];if(null==n.total&&null!=r.total&&!e.between(e.getNow(),r.date.startDate,r.date.endDate))return void(r.last=!0)}},getPlannable:function(t,e){this.dataRepository.getPlannable(t,e,r.proxy(function(t){r(this).trigger("data-error",JSON.parse(t.responseText))},this))},getDetails:function(e,n){var a=function(e,n,r){var a=e.filter(function(t){return t.item.parentId==n.id});n.children=a.map(function(t){var e=t.item;return{id:e.id,name:e.name,effort:r(t),isDeleted:e.isDeleted,entityType:e.entityType}});var i=e.filter(function(t){return t.item.id==n.id})[0];
return n.total=t.sum(n.children.map(function(t){return t.effort}))+(i?r(i):0),n},i={date:e.date,remained:this._getParentIds(e,function(t){return t.remained}),added:this._getParentIds(e,function(t){return t.added}),removed:this._getParentIds(e,function(t){return t.removed}),spent:this._getParentIds(e,function(t){return t.spent})};this.dataRepository.getDetails(i,r.proxy(function(t){var r={date:e.date,effort:{remained:t.remained.map(function(t){return a(e.effort,t,function(t){return t.remained})}),added:t.added.map(function(t){return a(e.effort,t,function(t){return t.added})}),removed:t.removed.map(function(t){return a(e.effort,t,function(t){return t.removed})}),spent:t.spent.map(function(t){return a(e.effort,t,function(t){return t.spent})})},total:e.total,units:e.units,forecast:e.forecast,today:t.today};n(r)},this))},_getParentIds:function(t,e){for(var n=t.effort.filter(function(t){return e(t)}).map(function(t){var e=t.item.parentId;return null!=e&&e>0?e:t.item.id}),a=[],i=0;i<n.length;i++){var o=n[i];0==r.grep(a,function(t){return t==o}).length&&a.push(o)}return a},getIdealLineStartValue:function(){var t=this.data[0],e=0;return this.data.length?(t&&t.total&&(e=t.total.remained),this.data.filter(function(t){return"undefined"!=typeof t.total&&null!=t.total}).reduce(function(t,e){return t+e.total.added-e.total.removed},e)):e},_getYUpperBound:function(){var e=this.data.filter(function(t){return t.total});if(0==e.length)return 10;var n=Math.max(t.max(e,function(t){return t.total.remained+t.total.added-t.total.removed-t.total.spent}),this.getIdealLineStartValue())||10,r=Math.floor(Math.log(n)/Math.log(this.yRoundTo));r>1&&r--;var r=Math.pow(this.yRoundTo,r),a=Math.ceil(n/r)*r;return a},_getYAxisValues:function(){var e=this._getYUpperBound(),n=this;return t.range(this.yAxisPointsCount+1).map(function(t){return e/n.yAxisPointsCount*t})},getYAxis:function(){return{label:function(t){return t},values:this._getYAxisValues(),count:this.yAxisPointsCount,max:this._getYUpperBound()}
},_getXAxisValuesCount:function(){return this.data.length},getXAxis:function(){function e(t){return t.toString("d MMM")}function n(n){switch(n){case"release":return{xLabel:function(t,n){return a.data[n]?"[Week "+(n+1)+"] "+e(a.data[n].date.startDate)+" - "+e(a.data[n].date.endDate):void 0},transform:function(){return function(){this.attr("transform",function(){var e=t.select(this).attr("x"),n=t.select(this).attr("y");return"rotate(325 "+e+","+n+")"})}}};default:return{xLabel:function(t,n){return a.data[n]?e(a.data[n].date.startDate):void 0},transform:function(t){return function(){this.attr("dx",(t.x(1)-t.x(0))/2)}}}}}var a=this,i=Math.max(0,this._getXAxisValuesCount());return r.extend(a.filter?n(a.filter.burnDownType):{},{count:i,max:i,values:t.range(i)})},getXValue:function(t){return this.data.indexOf(t)},getYValue:function(t){return t.total?t.total.remained:null}},a});