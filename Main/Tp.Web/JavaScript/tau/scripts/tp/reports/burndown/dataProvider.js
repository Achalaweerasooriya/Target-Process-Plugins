define(["libs/d3/d3","tau/utils/utils.date","tp/reports/dataRepository","jQuery","Underscore"],function(t,e,n,r,i){function a(n,r){this.yAxisPointsCount=10,this.yRoundTo=10,this.data=[],this.forecast=n.forecastFinishDate,this.forecastDay=n.forecastDay,this.iterationEndDay=n.iterationEndDay,this.isTitlesProvided=n.isTitlesProvided,this.velocity=n.velocity,this.manuallySetVelocity=n.manuallySetVelocity,this.decimalSeparator=n.decimalSeparator,this.isPlannableFinished=n.isPlannableFinished,this.d3=t,this.filter=r;var a=n.effort;a&&(this.data=i.chain(a).zip(i.rest(a)).map(function(t){var e=t[0],n=t[1];return{element:e,total:this._getTotal(e,n)}},this).map(function(t,n,r){var i=t.element,a=n==r.length-1,o=e.convertToTimezone(i.date.startDate),u=e.convertToTimezone(i.date.endDate),s=a||null!=t.total&&null==r[n+1].total&&!e.between(e.getNow(),o,u);return{date:{startDate:o,endDate:u},total:t.total,effort:i.effort,units:this.filter.units,forecast:this.forecast||e.convertToTimezone(this.forecast),last:s}},this).value())}function o(){this.dataRepository=new n({url:"/reports/v1/burnDown"})}return a.prototype={isEmpty:function(){return!this.filter||!this.filter.burnDownType||0===this.getXAxisValuesCount()},getIdealLineStartValue:function(){var t=this.data[0],e=0;return this.data.length?(t&&t.total&&(e=t.total.remained),this.data.filter(function(t){return"undefined"!=typeof t.total&&null!=t.total}).reduce(function(t,e){return t+e.total.added-e.total.removed},e)):e},getYUpperBound:function(){var e=this.data.filter(function(t){return t.total}),n=10;if(0===e.length)return n;var r=t.max(e,function(t){return t.total.remained}),i=t.max(e,function(t){return t.total.remained+t.total.added-t.total.removed-t.total.spent}),a=Math.max(i,r,this.getIdealLineStartValue())||n,o=Math.floor(Math.log(a)/Math.log(this.yRoundTo));return o>1&&o--,o=Math.pow(this.yRoundTo,o),Math.ceil(a/o)*o},getYAxisValues:function(){var e=this.getYUpperBound(),n=this;return t.range(this.yAxisPointsCount+1).map(function(t){return e/n.yAxisPointsCount*t
})},getXAxisValuesCount:function(){return this.data.length},getXValue:function(t){return this.data.indexOf(t)},getYValue:function(t){return t.total?t.total.remained:null},_getTotal:function(e,n){var r=null;return e.effort&&(r={remained:t.sum(e.effort,function(t){return t.remained}),spent:t.sum(e.effort,function(t){return t.spent}),added:t.sum(e.effort,function(t){return t.added}),removed:t.sum(e.effort,function(t){return Math.abs(t.removed)})},r.remainedForNextDay=n&&n.effort?t.sum(n.effort,function(t){return t.remained}):r.remained+r.added-r.spent-r.removed),r}},o.prototype={initialize:function(t,e){t&&t.burnDownType?this.dataRepository.get(t,function(n){e(new a(n,t))},function(t){var e=JSON.parse(t.responseText);r(this).trigger("data-error",e)}.bind(this)):e(new a({},t))},getPlannable:function(t){var e=r.Deferred();return this.dataRepository.getPlannable(t,function(t){e.resolve(t)},function(t){r(this).trigger("data-error",JSON.parse(t.responseText)),e.fail()}.bind(this)),e},getDetails:function(n,r){var i=function(e,n,r){var i=e.filter(function(t){return t.item.parentId==n.id});n.children=i.map(function(t){var e=t.item;return{id:e.id,name:e.name,effort:r(t),isDeleted:e.isDeleted,entityType:e.entityType}});var a=e.filter(function(t){return t.item.id==n.id})[0];return n.total=t.sum(n.children.map(function(t){return t.effort}))+(a?r(a):0),n},a={date:n.date,remained:this._getParentIds(n,function(t){return t.remained}),added:this._getParentIds(n,function(t){return t.added}),removed:this._getParentIds(n,function(t){return t.removed}),spent:this._getParentIds(n,function(t){return t.spent})};this.dataRepository.getDetails(a,function(t){var a={date:n.date,effort:{remained:t.remained.map(function(t){return i(n.effort,t,function(t){return t.remained})}),added:t.added.map(function(t){return i(n.effort,t,function(t){return t.added})}),removed:t.removed.map(function(t){return i(n.effort,t,function(t){return t.removed})}),spent:t.spent.map(function(t){return i(n.effort,t,function(t){return t.spent
})})},total:n.total,units:n.units,forecast:e.convertToTimezone(n.forecast),today:t.today};r(a)}.bind(this))},_getParentIds:function(t,e){for(var n=t.effort.filter(function(t){return e(t)}).map(function(t){var e=t.item.parentId;return null!=e&&e>0?e:t.item.id}),i=[],a=0;a<n.length;a++){var o=n[a];0===r.grep(i,function(t){return t==o}).length&&i.push(o)}return i}},o});