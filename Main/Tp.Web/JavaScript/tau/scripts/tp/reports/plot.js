define(["jQuery","libs/d3/d3","template!tp/reports/burndown/template.legend"],function(t,i,e){function s(t){this.margin=t.margin||30,this.height=t.height,this.initialWidth=t.width,this.aspectRatio=t.aspectRatio,this.mode=t.mode||"simple",this.detalization=t.detalization||"full",this.charts=t.charts||[],this.captions=t.captions||[],this.showLegend="undefined"==typeof t.showLegend?!0:t.showLegend,this.showLabels="undefined"==typeof t.showLabels?!0:t.showLabels,this.legend=e.render(),this.axesSettings=t.axes||{}}return s.prototype={_initialize:function(t){this._dataProvider=t;var e=this.axesSettings.x||{};this.xAxis=this.getXAxis(e);var s=this.axesSettings.y||{};this.yAxis=this.getYAxis(s),this.yCellSize=this._getYCellSize(this.yAxis.count),this.initialWidth?(this.xCellSize=this._getXCellSize(this.xAxis.count),this.width=this.initialWidth):(this.xCellSize=this._getXCellSizeAdaptive(this.placeholder.width(),this.xAxis.count,this.yCellSize),this.width=this.xAxis.count*this.xCellSize+this.margin),this.x=i.scale.linear().domain([0,this.xAxis.max]).range([0+this.margin,this.width-this.margin/2]),this.y=i.scale.linear().domain([0,this.yAxis.max]).range([this.height-this.margin-35,10])},getXAxis:function(e){function s(t){return t.toString("d MMM")}function a(t){switch(t){case"release":return{xLabel:function(t,i){return r._dataProvider.data[i]?"[Week "+(i+1)+"] "+s(r._dataProvider.data[i].date.startDate)+" - "+s(r._dataProvider.data[i].date.endDate):void 0},transform:function(){return function(){this.attr("transform",function(){var t=i.select(this).attr("x"),e=i.select(this).attr("y");return"rotate(325 "+t+" "+e+")"})}}};default:return{xLabel:function(t,i){return r._dataProvider.data[i]?s(r._dataProvider.data[i].date.startDate):void 0},transform:function(t){var s=(t.x(1)-t.x(0))/2;return function(){"slope"===e.labelSlope?(this.attr("transform",function(){var t=i.select(this).attr("x"),e=parseFloat(t)+s,a=i.select(this).attr("y");return"rotate(325 "+e+" "+a+")"}),this.attr("x",function(){var t=i.select(this).attr("x");
return parseFloat(t)+s})):this.attr("dx",(t.x(1)-t.x(0))/2)}}}}}var r=this,h=Math.max(0,this._dataProvider.getXAxisValuesCount());return t.extend(r._dataProvider.filter?a(r._dataProvider.filter.burnDownType):{},{count:h,max:h,values:i.range(h)})},getYAxis:function(){return{label:function(t){return t},values:this._dataProvider.getYAxisValues(),count:this._dataProvider.yAxisPointsCount,max:this._dataProvider.getYUpperBound()}},_getYCellSize:function(t){return(this.height-this.margin)/t},_getXCellSize:function(t){return(this.initialWidth-this.margin)/t},_getXCellSizeAdaptive:function(t,i,e){var s=e,a=i*s+this.margin;return a>t&&(s=t>.75*a?(t-this.margin)/i:.75*e),s},render:function(t){this._initialize(t),this.placeholder.html("").height("auto"),this._renderPlot(),this._renderCaptions(),this._renderCharts(),this.showLegend&&this.placeholder.append(this.legend)},resize:function(t){this.initialWidth=t.width,this.height=t.height,this.hasData()&&this.render(this._dataProvider)},hasData:function(){return this._dataProvider},_renderPlot:function(){this._createPlot(),this._renderAxes(),this._renderGrid(),this._renderLabels()},_renderAxes:function(){var t=this.createGroup("axes");t.append("line").attr("class","yAxis").attr("y1",this.y(this.yAxis.values[0])).attr("x1",this.x(this.xAxis.values[0])).attr("y2",this.y(this.yAxis.max)).attr("x2",this.x(this.xAxis.values[0])),t.append("line").attr("class","xAxis").attr("x1",this.x(this.xAxis.values[0])).attr("y1",this.y(this.yAxis.values[0])).attr("x2",this.x(this.xAxis.max)).attr("y2",this.y(this.yAxis.values[0]))},_renderGrid:function(){var t=this.createGroup("grid");t.selectAll(".yLine").data(this.y.ticks(this.yAxis.count+1)).enter().append("line").attr("class","yLine").attr("y1",this.y).attr("x1",this.x(this.xAxis.values[0])).attr("y2",this.y).attr("x2",this.x(this.xAxis.max)),t.selectAll(".xLine").data(this.x.ticks(this.xAxis.count)).enter().append("line").attr("class","xLine").attr("x1",this.x).attr("y1",this.y(this.yAxis.values[0])).attr("x2",this.x).attr("y2",this.y(this.yAxis.max))
},_renderLabels:function(){if(this.showLabels){var t=this.createGroup("labels"),i=this;t.selectAll(".xLabel").data(this.x.ticks(this.xAxis.count)).enter().append("text").attr("class","xLabel").attr("x",i.x).attr("y",this.y(0)+.9*this.margin).text(this.xAxis.xLabel).call(this.xAxis.transform({x:i.x,y:i.y})),t.selectAll(".yLabel").data(this.y.ticks(this.yAxis.count+1)).enter().append("text").attr("class","yLabel").text(this.yAxis.label).attr("x",this.margin-10).attr("y",this.y).attr("dy",4)}},_createPlot:function(){this.caption=i.select(this.placeholder[0]).append("div").attr("id","report-caption").attr("class","caption").style("width",i.max([this.width,this.width/3])+"px"),this.plot=i.select(this.placeholder[0]).append("div").attr("class","report-caption__wrap").style({height:this.height+"px"}).append("svg").attr("width",this.width).attr("height",this.height)},createGroup:function(t){return this.plot.append("g").attr("class","_"+t)},getLastBurnDownPoint:function(){return t(this.plot.selectAll("line.lineChart")[0]).last()[0]},_renderCaptions:function(){for(var t=0;t<this.captions.length;t++)this.captions[t].render(this,this._dataProvider)},_renderCharts:function(){for(var t=0;t<this.charts.length;t++)this.charts[t].render(this,this._dataProvider)}},s});