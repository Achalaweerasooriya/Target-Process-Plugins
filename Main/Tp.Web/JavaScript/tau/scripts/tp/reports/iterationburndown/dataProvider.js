define(["libs/d3/d3","tp/date.utils","tp/reports/dataRepository","libs/date.js/build/date"],function(a,b,c){function d(){this.dataRepository=new c({url:"/reports/v1/burnDown"})}return d.prototype={yAxisPointsCount:10,yRoundTo:10,initialize:function(a,c){var d=this;this.dataRepository.get(a,function(a){d.data=a.map(function(a){return{date:b.parseFromJSON(a.date),total:d._getTotal(a),effort:a.effort}}),d._adjustLastDay(),d.startDate=d.data[0].date,c()})},_getTotal:function(b){var c=null;return b.effort&&(c={remained:a.sum(b.effort,function(a){return a.remained}),spent:a.sum(b.effort,function(a){return a.spent}),added:a.sum(b.effort,function(a){return a.added}),removed:a.sum(b.effort,function(a){return a.removed})},c.remainedForNextDay=c.remained+c.added-c.spent-c.removed),c},_adjustLastDay:function(){var a=this.data.map(function(a,b){return{data:a,index:b}}).filter(function(a){return!a.data.total}),c=-1;a.length&&!b.sameDay(a[0].data.date,(new Date).addDays(1))&&(c=a[0].index),c>0&&(this.data[c].total={remained:this.data[c-1].total.remainedForNextDay,added:0,removed:0,spent:0,remainedForNextDay:this.data[c-1].total.remainedForNextDay})},getDetails:function(b,c){var d=function(b,c,d){var e=b.filter(function(a){return a.item.parentId==c.id});return c.children=e.map(function(a){return{id:a.item.id,name:a.item.name,effort:d(a)}}),c.total=a.sum(c.children.map(function(a){return a.effort})),c},e={date:b.date,remained:this._getParentIds(b,function(a){return a.remained}),added:this._getParentIds(b,function(a){return a.added}),removed:this._getParentIds(b,function(a){return a.removed}),spent:this._getParentIds(b,function(a){return a.spent})};this.dataRepository.getDetails(e,$.proxy(function(a){var e={date:b.date,effort:{remained:a.remained.map(function(a){return d(b.effort,a,function(a){return a.remained})}),added:a.added.map(function(a){return d(b.effort,a,function(a){return a.added})}),removed:a.removed.map(function(a){return d(b.effort,a,function(a){return a.removed})}),spent:a.spent.map(function(a){return d(b.effort,a,function(a){return a.spent})})},total:b.total};c(e)},this))},_getParentIds:function(a,b){var c=a.effort.filter(function(a){return b(a)}).map(function(a){return a.item.parentId}),d=[];for(var e=0;e<c.length;e++){var f=c[e];$.grep(d,function(a){return a==f}).length==0&&d.push(f)}return d},_getYUpperBound:function(){var b=this.data.filter(function(a){return a.total});if(b.length==0)return 10;var c=a.max(b,function(a){return a.total.remained})||10,d=Math.floor(Math.log(c)/Math.log(this.yRoundTo));d>1&&d--;var d=Math.pow(this.yRoundTo,d),e=Math.ceil(c/d)*d;return e},_getYAxisValues:function(){var b=this._getYUpperBound(),c=this;return a.range(this.yAxisPointsCount+1).map(function(a){return b/c.yAxisPointsCount*a})},getYAxis:function(){return{label:function(a){return a},values:this._getYAxisValues(),count:this.yAxisPointsCount,max:this._getYUpperBound()}},_getXAxisValuesCount:function(){return this.data.length},getXAxis:function(){var b=this._getXAxisValuesCount()-1;b<0&&(b=0);var c=this;return{label:function(a){return c.data[a].date.toString("d MMM")},count:b,max:b,values:a.range(b)}},getXValue:function(a){return this.data.indexOf(a)},getYValue:function(a){return a.total?a.total.remained:null}},d})