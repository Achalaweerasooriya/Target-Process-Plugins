define(["jQuery","tp/date.utils","tp/reports/context","tau/integration","libs/jquery/jquery.tmpl"],function($,a,b,c){return $.widget("ui.summaryPopup",{options:{index:0,data:[]},_template:'<div class="_summaryPopup tau-bubble" style="display: block;">\n    <div class="tau-bubble__arrow-top" style="display: block; "></div>\n    <div class="tau-bubble__inner" role="content">\n\n        <div class="chart-bubble">\n            <div class="date">${date}</div>\n            <div class="_details">\n                <table>\n                    <tr class="_collapsible collapse-block">\n                        <td>\n                            <div class="indicator-small yesterday">${yesterday.toFixed(2)}h</div>\n                        </td>\n                        <td style="width: 100%;">\n                            <div class="_remained yesterday-text">{{if initial}}Initial&nbsp;Effort{{else}}Start-of-Day&nbsp;Time&nbsp;Remaining{{/if}}\n                            </div>\n                        </td>\n                    </tr>\n\n                    <tr style="display: none;">\n                        <td colspan="2" class="nopadding">\n                            <div class="inner">\n                                <table>\n                                    {{each effort.remained}}\n                                    <tr>\n                                        <td><span class="entity-indicator">${total}h</span></td>\n                                        <td><i class="tau-icon tau-story">${term}</i></td>\n                                        <td class="name"><div class="name-overflow"><a href="${url}" title="${name}" data-id="${id}" data-type="UserStory" class="_entity-ref">${name}</a></div></td>\n                                    </tr>\n                                    {{/each}}\n                                </table>\n                            </div>\n                        </td>\n                    </tr>\n\n                    {{if added}}\n                    <tr  class="_collapsible collapse-block">\n                        <td>\n                            <div class="indicator-small add">- ${added.toFixed(2)}h</div>\n                        </td>\n                        <td style="width: 100%;">\n                            <div class="_added complete-text">Added</div>\n                        </td>\n                    </tr>\n                    <tr style="display: none;">\n                        <td colspan="2" class="nopadding">\n                            <div class="inner">\n                                <table>\n                                    {{each effort.added}}\n                                    <tr>\n                                        <td><span class="entity-indicator">${total}h</span></td>\n                                        <td><i class="tau-icon tau-story">${term}</i></td>\n                                        <td class="name _parent"><div class="name-overflow"><a href="${url}" title="${name}" data-id="${id}" data-type="UserStory" class="_entity-ref">${name}</a></div></td>\n                                    </tr>\n\n                                    {{if showChildren}}\n                                    <tr><td colspan="3"><table>\n                                        {{each children}}\n                                        <tr class="inner-task">\n                                            <td class="pl-10"><span class="entity-indicator">${effort}h</span></td>\n                                            <td><i class="tau-icon tau-task">${term}</i></td>\n                                            <td class="name font-11"><div class="name-overflow"><a href="${url}" title="${name}" data-id="${id}" data-type="Task" class="_entity-ref">${name}</a></div></td>\n                                        </tr>\n                                        {{/each}}\n                                    </table></td></tr>\n                                    {{/if}}\n                                    {{/each}}\n                                </table>\n                            </div>\n                        </td>\n                    </tr>\n                    {{/if}}\n\n                    {{if removed}}\n\n                    <tr class="_collapsible collapse-block">\n                        <td>\n                            <div class="indicator-small remove">- ${removed.toFixed(2)}h</div>\n                        </td>\n                        <td style="width: 100%;">\n                            <div class="_removed complete-text">Removed</div>\n                        </td>\n                    </tr>\n                    <tr style="display: none;">\n                        <td colspan="2" class="nopadding">\n                            <div class="inner">\n                                <table>\n                                    {{each effort.removed}}\n                                    <tr>\n                                        <td><span class="entity-indicator">${total}h</span></td>\n                                        <td><i class="tau-icon tau-story">${term}</i></td>\n                                        <td class="name _parent"><div class="name-overflow"><a href="${url}" title="${name}" data-id="${id}" data-type="UserStory" class="_entity-ref">${name}</a></div></td>\n                                    </tr>\n                                    {{if showChildren}}\n                                    <tr><td colspan="3"><table>\n                                        {{each children}}\n                                        <tr class="inner-task">\n                                            <td class="pl-10"><span class="entity-indicator">${effort}h</span></td>\n                                            <td><i class="tau-icon tau-task">${term}</i></td>\n                                            <td class="name font-11"><div class="name-overflow"><a href="${url}" title="${name}" data-id="${id}" data-type="Task" class="_entity-ref">${name}</a></div></td>\n                                        </tr>\n                                        {{/each}}\n                                    </table></td></tr>\n                                    {{/if}}\n                                    {{/each}}\n                                </table>\n                            </div>\n                        </td>\n                    </tr>\n                    {{/if}}\n\n                    {{if spent}}\n                    <tr class="_collapsible collapse-block">\n                        <td>\n                            <div class="indicator-small complete" style="white-space: nowrap;">-&nbsp;${spent.toFixed(2)}h</div>\n                        </td>\n                        <td style="width: 100%;">\n                            <div class="_spent complete-text">Completed</div>\n                        </td>\n                    </tr>\n                    <tr style="display: none;">\n                        <td colspan="2" class="nopadding">\n                            <div class="inner">\n                                <table>\n                                    {{each effort.spent}}\n                                    <tr>\n                                        <td><span class="entity-indicator">${total}h</span></td>\n                                        <td><i class="tau-icon tau-story">${term}</i></td>\n                                        <td class="name _parent"><div class="name-overflow"><a href="${url}" title="${name}" data-id="${id}" data-type="UserStory" class="_entity-ref">${name}</a></div></td>\n                                    </tr>\n                                    {{if showChildren}}\n                                    <tr><td colspan="3"><table>\n                                        {{each children}}\n                                        <tr class="inner-task">\n                                            <td class="pl-10"><span class="entity-indicator">${effort}h</span></td>\n                                            <td><i class="tau-icon tau-task">${term}</i></td>\n                                            <td class="name font-11"><div class="name-overflow"><a href="${url}" title="${name}" data-id="${id}" data-type="Task" class="_entity-ref">${name}</a></div></td>\n                                        </tr>\n                                        {{/each}}\n                                    </table></td></tr>\n                                    {{/if}}\n                                    {{/each}}\n                                </table>\n                            </div>\n                        </td>\n                    </tr>\n                    {{/if}}\n            </div>\n            {{if remained}}\n\n            <tr>\n                <td>\n                    <div class="remain{{if today}} today{{/if}}">${remained.toFixed(2)}h</div>\n                </td>\n                <td>\n                    <div class="_remained remain-text{{if today}} today{{/if}}">End-of-Day Time Remaining</div>\n                </td>\n            </tr>\n            {{/if}}\n            </table>\n        </div>\n    </div>\n</div>',_context:b,open:function(){if(!this.isOpen()){var a=this._getTemplateData(this.options.data,this.options.index);this._openBubblePopup($.tmpl(this._template,a),a.date)}},_openBubblePopup:function(a,b){this._bubblePopup=this.element.bubblePopup({top:15,left:-13,content:a,key:b,open:function(){a.find("._details").accordion({header:"tr._collapsible",collapsible:!0,active:!1,icons:!1,autoHeight:!1,animated:!1}),a.find("._entity-ref").click(function(a){a.preventDefault();var b=$(this);c.show(b.data("id"),b.data("type"),$.noop)})},close:function(){a.find("._details").accordion("destroy"),a.find("._entity-ref").unbind()}}),this._bubblePopup.bubblePopup("open")},isOpen:function(){return this._bubblePopup&&this._bubblePopup.bubblePopup("isOpen")},_getTemplateData:function(c,d){var e=b.getTermProcessorForCurrentProject(),f=e.getTerms("UserStory").iconSmall,g=e.getTerms("Task").iconSmall,h=this,i=function(a){return a.map(function(a){return{id:a.id,name:a.name,total:a.total,action:a.action,url:h._getUrl(a.id,"UserStory"),term:f,showChildren:a.action=="None",children:a.children.filter(function(a){return a.effort}).map(function(a){return{id:a.id,name:a.name,effort:a.effort,url:h._getUrl(a.id,"Task"),term:g}})}})};return{initial:d==0,yesterday:c.total.remained,date:c.date.toString("d MMMM"),remained:c.total.remainedForNextDay,spent:c.total.spent,added:c.total.added,removed:c.total.removed,today:a.sameDay(c.date,new Date),effort:{remained:i(c.effort.remained),spent:i(c.effort.spent),added:i(c.effort.added),removed:i(c.effort.removed)}}},_getUrl:function(a,b){return(new Tp.WebServiceURL((new Tp.AcidURL("/Project/Planning/"+b+"/View.aspx?"+b+"ID="+a)).toString())).toString()},destroy:function(){this._bubblePopup.bubblePopup("destroy")}}),$})