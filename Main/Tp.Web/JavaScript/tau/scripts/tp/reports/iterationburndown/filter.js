define(["jQuery","tp/gateway","tp/date.utils","tp/reports/context","libs/jquery/jquery.ui","libs/jquery/jquery.tmpl","tp/bubblepopup","tp/dropdown"],function($,a,b,c){function d(){this.gateway=a,this.template='<div class="chart-filter">\n    <span class="pr-10">\n        <label><span class="divider">Iteration&nbsp;&nbsp;</span><span class="_selectedIteration iterations-caret"></span></label>\n    </span>\n    <span class="ui-dateeditor pr-10">\n        <label><span class="divider">Start Date&nbsp;&nbsp;</span><input type="text" name="StartDate" class="_startDate hasDatePicker" maxlength="20"></label>\n    </span>\n    <span class="divider">\n        <label><input type="checkbox" name="Weekends" class="_weekends" checked="checked">Weekends</label>\n    </span>\n</div>',this.currentIterations=[],this.context=c}return d.prototype={initialize:function(a){this.placeholder=a.placeholder,this.update=a.update,this._getIterations($.proxy(this._render,this))},_getIterations:function(a){var c=$.map(this.context.getSelectedProjects(),function(a){return a.Id}),d=this;this._retrieveIterations(this._getUrl("/api/v1/Iterations?where=Project.Id in ("+c.join(",")+")&include=[Name,StartDate,EndDate,Project]&orderByDesc=StartDate"),function(c){var e=b.getNow();d.iterations=$.map(c.Items,function(a){var c=b.parseFromJSON(a.StartDate),d=b.parseFromJSON(a.EndDate);return{startDate:c,endDate:d,id:a.Id,name:a.Name,current:b.between(e,c,d),project:{id:a.Project.Id,name:a.Project.Name}}}),d.currentIterations=d.iterations.filter(function(a){return a.current}),a()})},_retrieveIterations:function(a,b){this.gateway.getJSON(a,b)},_render:function(){var a=this._getDefaultIteration();this.placeholder.html(this.template),this.placeholder.find("._startDate").datepicker({buttonImageOnly:!1,showOn:"both",buttonText:"Choose",onSelect:this.update}),this.placeholder.find("._weekends").click(this.update);var b=$.proxy(function(){this.context.setCurrentProject(this._getSelectedIteration().project.id),this._setStartDate(this._getSelectedIteration().startDate),this.update()},this);this.iterationsDropDown=this.placeholder.find("._selectedIteration").dropDown({value:a,quickData:this._getIterationsDropDownDataSource(this.currentIterations),data:this._getIterationsDropDownDataSource(this.iterations),select:b}),b()},_getDefaultIteration:function(){var a=null;return this.currentIterations.length&&(a=this.currentIterations.map(function(a){return a.id})[0]),a},_getIterationsDropDownDataSource:function(a){var b=$.map(a,function(a){return a.project}),c=[];for(var d=0;d<b.length;d++){var e=b[d];$.grep(c,function(a){return a.id==a.id}).length==0&&c.push({id:e.id,name:e.name})}for(var d=0;d<c.length;d++)c[d].items=$.grep(a,function(a){return a.project.id==c[d].id}).map(function(a){return{id:a.id,name:a.current?a.name+" (current)":a.name}});return c},_getUrl:function(a){return(new Tp.WebServiceURL(a)).url},getData:function(){return{iterationId:this._getIterationId(),startDate:this._getStartDate(),includeWeekends:this.includeWeekends()}},_getIterationId:function(){return this.iterationsDropDown.dropDown("value")},_getStartDate:function(){return this.placeholder.find("._startDate").datepicker().datepicker("getDate")},_setStartDate:function(a){this.placeholder.find("._startDate").datepicker("setDate",a)},includeWeekends:function(){return this.placeholder.find("._weekends:checked").val()=="on"},_getSelectedIteration:function(){var a=this._getIterationId(),b=$.grep(this.iterations,function(b){return b.id==a});return b?b[0]:null}},d})