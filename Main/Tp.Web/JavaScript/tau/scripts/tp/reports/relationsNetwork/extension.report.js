define(["Underscore","jQuery","libs/d3/d3","tau/components/extensions/component.extension.base","tp/reports/chart.plot","tp/reports/relationsNetwork/chart.network","tp/reports/relationsNetwork/chart.scales","tau/ui/templates/board.plus/ui.template.boardplus.card.skeleton","tp/reports/relationsNetwork/chart.network.layout","tp/reports/relationsNetwork/behaviour.network.popup","tp/reports/relationsNetwork/behaviour.focus","tp/reports/relationsNetwork/chart.data"],function(_,$,d3,ExtensionBase,Plot,NetworkChart,Scales,$1,layout,NetworkPopup,focus,data){function select(property){return function(d){return d[property]}}function notEqualTo(x){return function(d){return d!=x}}return ExtensionBase.extend({"bus configurator.ready:last + afterRender":function(evt,configurator,data){var networkChart=new NetworkChart({templateFactory:configurator.getTemplateFactory(),handlers:[NetworkPopup.create({navigator:configurator.service("navigator")}),focus]}),sizeService=configurator.service("chart.size"),plot=new Plot({scales:new Scales,placeholder:data.element.find(".tau-chart-plot").get(0),axes:[],size:{size:function(data){var size=sizeService.size(data);return{width:size.width/.9,height:size.height}}},charts:[networkChart]});$(networkChart).on("afterRender",function(){plot.loading(!1)}),$(plot).on("nodata",function(){plot.loading(!1),data.element.find(".tau-chart-box").hide()}),this.fire("plot.ready",plot)},_getSecondary:function(primary){var primaryIds=_.map(primary,select("id"));return _.chain(primary).map(function(d){return[d.slaves,d.masters]}).flatten(!1).unique(!1,select("id")).filter(function(d){return primaryIds.every(notEqualTo(d.id))}).value()},_getRelations:function(data){var slaveRelation=function(master){return function(d){return{id:d.relationId,type:d.relationType,master:master.id,slave:d.id}}},masterRelation=function(slave){return function(d){return{id:d.relationId,type:d.relationType,master:d.id,slave:slave.id}}};return _.chain(data).map(function(d){return[d.data.slaves.map(slaveRelation(d.data)),d.data.masters.map(masterRelation(d.data))]}).flatten(!1).unique(!1,select("id")).value()},_getLinks:function(relations,nodes){function byId(id){return function(x){return id==x.id}}return relations.map(function(relation){return{id:relation.id,source:nodes.filter(byId(relation.master))[0],target:nodes.filter(byId(relation.slave))[0],value:1,type:relation.type}}).filter(function(link){return link.source&&link.target})},"bus data.ready":function(e,loadedData){loadedData.metaData.hasMore&&alert("There are more items to show.\n\nOne can only see up to 100 items at a time. You might want to narrow down your filter settings.")},"bus plot.ready:last + error":function(e,plot,loadedData){plot.loading(!1)},"bus plot.ready:last + beforeLoad":function(e,plot,loadedData){plot.loading(!0)},"bus plot.ready:last + data.ready":function(e,plot,loadedData){var self=this,relations=this._getRelations(loadedData.data),primary=_.map(loadedData.data,select("data")),secondary=this._getSecondary(primary),acid=loadedData.settings.parameters.definition.global.acid;data.fetch(secondary,acid,function(secondary){primary=_.map(primary,function(d){return $.extend(d,{nodeType:"primary"})}),secondary=_.map(secondary,function(d){return $.extend(d,{nodeType:"secondary"})});var nodes=_.union(primary,secondary);nodes.forEach(function(node){node.links=node.links||[]}),self._getLinks(relations,nodes).forEach(function(link){link.source.links.push(link),link.target.links.push(link)}),plot.data(nodes,loadedData.settings),self.fire("plot.afterRender",plot)})}})})