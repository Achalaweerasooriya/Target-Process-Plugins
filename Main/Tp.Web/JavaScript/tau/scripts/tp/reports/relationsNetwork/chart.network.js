define(["jQuery","Underscore","libs/d3/d3","tp/reports/chart.layout","tp/reports/relationsNetwork/chart.network.layout","tp/reports/chart.behaviour","tau/core/tau","tau/ui/extensions/board.plus/ui.board.plus.utils"],function(t,e,a,r,n,s,i,l){var c=e.contains([10,11],i.ieVersion);return s.extend({init:function(t){this.handlers=this.initHandlers(t.handlers||[]),this.cardTemplate=t.templateFactory.get("board.plus.default.card.customized")},nodes:function(r,n){var s=e.filter(r.nodes,function(t){return t.cardData}),i=this,l=t(n.placeholder).closest("div")[0];a.select(l).selectAll(".tau-chart-box").style("display","block");var c=a.select(l).selectAll(".tau-chart-box").data(s,function(t){return t.id});return c.enter().append("div"),c.attr("class",function(t){return"tau-chart-box i-trigger-set-focus tau-ui-size-"+n.scales.zoom(t.nodeType)}).html(function(e){return t("<div></div>").append(i.cardTemplate.bind({},{dataItem:{data:e,type:e.type},layout:r.settings.layouts[e.nodeType][e.type.toLowerCase()],configurator:r.settings.configurator})).html()}),c.exit().remove(),c},links:function(t,e){var r=a.select(e.placeholder);r.selectAll("line.link").remove();var n=r.selectAll(".link").data(t);return n.enter().append("line").attr("data-entity-id",function(t){return t.id}).attr("class",function(t){return"link "+e.scales.relationType(t.type)}).attr("marker-end",function(t){return"url(#"+e.scales.relationType(t.type)+")"}),n.exit().remove(),n},addTransparentClickHandler:function(t){var e=a.select(t.placeholder).append("rect").attr("width",t.plot.width-t.plot.margin).attr("class","transparent i-trigger-reset-focus");this._subscribe(e,["click"],t)},resetFocus:function(t){a.select(t.placeholder.parentNode.parentNode.parentNode).classed("tau-chart-focus",!1).selectAll(".tau-chart-focused").classed("tau-chart-focused",!1)},data:function(s,i){function o(){return t(i.placeholder).closest("div")}var d=s.nodes,u=this,h=i.plot.width,p=i.plot.height;this.addTransparentClickHandler(i),this.resetFocus(i);
var f=e.chain(d).map(function(t){return t.links}).flatten(!1).unique().value();d.forEach(function(t){var e=t.type?l.getCardSize(t.type.toLowerCase(),i.scales.zoom(t.nodeType)):{width:0,height:0};t.size=[e.width,e.height]},this);var y=this.nodes(s,i),g=this.links(f,i),v=function(t){return t&&!c?function(){y.transition().call(n.nodes(k.scales)),g.transition().call(n.links(k.scales))}:function(){y.call(n.nodes(k.scales)),g.call(n.links(k.scales))}},m=function(){p=Math.max(p,k.height()),o().height(p),a.select(i.placeholder.parentNode).style("height",p+"px"),a.select(i.placeholder).style("height",p+"px"),a.select(i.placeholder).select(".transparent").attr("height",p),d.forEach(function(t){t.fixed="primary"==t.nodeType}),v(!1)(),t(u).trigger("afterRender")},k=r.graph().width(h).links(f).nodes(d).end(function(){m(),m=v(!0)}).dragmove(function(t){function e(t,e,a){return Math.min(Math.max(t,e),a)}var a=e(k.scales.x(t.x),t.size[0]/2,h-t.size[0]/2-12),r=e(k.scales.y(t.y),t.size[1]/2,p-t.size[1]/2);t.x=k.scales.x.invert(a),t.y=k.scales.y.invert(r),v(!1)()});y.call(k.drag),a.select(i.placeholder.parentNode).select("defs").selectAll("marker").data(i.scales.relationType.range()).enter().append("marker").attr("id",String).attr("viewBox","0 -7 14 14").attr("refX",14).attr("markerUnits","userSpaceOnUse").attr("markerWidth",7).attr("markerHeight",7).attr("orient","auto").append("path").attr("class",String).attr("stroke-width","1").attr("d","M0,-7L14,0L0,7"),this._subscribe(y,["click","dblclick"],i),this._subscribe(k.drag,["dragstart.behavior"],i),k.doLayout()}})});