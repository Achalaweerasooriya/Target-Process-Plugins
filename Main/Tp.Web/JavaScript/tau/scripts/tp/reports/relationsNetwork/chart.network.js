define(["jQuery","Underscore","libs/d3/d3","tp/reports/chart.layout","tp/reports/relationsNetwork/chart.network.layout","tp/reports/chart.behaviour","tau/core/tau","tau/ui/extensions/board.plus/ui.board.plus.utils","tau/ui/templates/board.plus/customized/ui.template.boardplus.default.card.customized"],function(e,t,r,a,n,s,i,l,c){var o=t.contains([10,11],i.ieVersion);return s.extend({nodes:function(a,n){var s=t.filter(a.nodes,function(e){return e.cardData}),i=e(n.placeholder).closest("div")[0];r.select(i).selectAll(".tau-chart-box").style("display","block");var l=r.select(i).selectAll(".tau-chart-box").data(s,function(e){return e.id});return l.enter().append("div"),l.attr("class",function(e){return"tau-chart-box i-trigger-set-focus tau-ui-size-"+n.scales.zoom(e.nodeType)}).html(function(e){return c.get().bindPure({},{dataItem:{data:e,type:e.type},layout:a.settings.layouts[e.nodeType][e.type.toLowerCase()],configurator:a.settings.configurator})}),l.exit().remove(),l},links:function(e,t){var a=r.select(t.placeholder);a.selectAll("line.link").remove();var n=a.selectAll(".link").data(e);return n.enter().append("line").attr("data-entity-id",function(e){return e.id}).attr("class",function(e){return"link "+t.scales.relationType(e.type)}).attr("marker-end",function(e){return"url(#"+t.scales.relationType(e.type)+")"}),n.exit().remove(),n},addTransparentClickHandler:function(e){var t=r.select(e.placeholder).append("rect").attr("width",e.plot.width-e.plot.margin).attr("class","transparent i-trigger-reset-focus");this._subscribe(t,["click"],e)},resetFocus:function(e){r.select(e.placeholder.parentNode.parentNode.parentNode).classed("tau-chart-focus",!1).selectAll(".tau-chart-focused").classed("tau-chart-focused",!1)},data:function(s,i){function c(){return e(i.placeholder).closest("div")}var d=s.nodes,u=this,p=i.plot.width,h=i.plot.height;this.addTransparentClickHandler(i),this.resetFocus(i);var f=t.chain(d).map(function(e){return e.links}).flatten(!1).unique().value();d.forEach(function(e){var t=e.type?l.getCardSize(e.type.toLowerCase(),i.scales.zoom(e.nodeType)):{width:0,height:0};
e.size=[t.width,t.height]},this);var g,y=this.nodes(s,i),k=this.links(f,i),m=function(e){return e&&!o?function(){y.transition().call(n.nodes(g.scales)),k.transition().call(n.links(g.scales))}:function(){y.call(n.nodes(g.scales)),k.call(n.links(g.scales))}},v=function(){h=Math.max(h,g.height()),c().height(h),r.select(i.placeholder.parentNode).style("height",h+"px"),r.select(i.placeholder).style("height",h+"px"),r.select(i.placeholder).select(".transparent").attr("height",h),d.forEach(function(e){e.fixed="primary"==e.nodeType}),m(!1)(),e(u).trigger("afterRender")};g=a.graph().width(p).links(f).nodes(d).end(function(){v(),v=m(!0)}).dragmove(function(e){function t(e,t,r){return Math.min(Math.max(e,t),r)}var r=t(g.scales.x(e.x),e.size[0]/2,p-e.size[0]/2-12),a=t(g.scales.y(e.y),e.size[1]/2,h-e.size[1]/2);e.x=g.scales.x.invert(r),e.y=g.scales.y.invert(a),m(!1)()}),y.call(g.drag),r.select(i.placeholder.parentNode).select("defs").selectAll("marker").data(i.scales.relationType.range()).enter().append("marker").attr("id",String).attr("viewBox","0 -7 14 14").attr("refX",14).attr("markerUnits","userSpaceOnUse").attr("markerWidth",7).attr("markerHeight",7).attr("orient","auto").append("path").attr("class",String).attr("stroke-width","1").attr("d","M0,-7L14,0L0,7"),this._subscribe(y,["click","dblclick"],i),this._subscribe(g.drag,["dragstart.behavior"],i),g.doLayout()}})});