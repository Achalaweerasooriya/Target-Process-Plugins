define(["libs/d3/d3","Underscore","tp/reports/chart.layout"],function(d3,_,layout){var sqr=function(x){return x*x},sqrDist=function(p1,p2){return sqr(p1.x-p2.x)+sqr(p1.y-p2.y)};return{links:function(scales){var getEdges=function(d){var x=scales.x(d.x),y=scales.y(d.y);return[{x:x-d.size[0]/2,y:y},{x:x+d.size[0]/2,y:y},{x:x,y:y-d.size[1]/2},{x:x,y:y+d.size[1]/2}]},buildLine=function(source,target){var sourceEdges=getEdges(source),targetEdges=getEdges(target);return _.flatten(sourceEdges.map(function(s){return targetEdges.map(function(t){return{source:s,target:t}})})).sort(function(p1,p2){return d3.ascending(sqrDist(p1.source,p1.target),sqrDist(p2.source,p2.target))})[0]};return function(){this.each(function(d){d.line=buildLine(d.source,d.target)}).attr("x1",function(d){return d.line.source.x}).attr("y1",function(d){return d.line.source.y}).attr("x2",function(d){return d.line.target.x}).attr("y2",function(d){return d.line.target.y})}},nodes:function(scales){return function(){this.style("left",function(d){return Math.round(scales.x(d.x)-d.size[0]/2)+"px"}).style("top",function(d){return Math.round(scales.y(d.y)-d.size[1]/2)+"px"})}}}})