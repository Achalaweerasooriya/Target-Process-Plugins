define(["Underscore","jQuery","tp/reports/dataRepository","tp/reports/model.report","tp/reports/settings/definitionBuilder"],function(t,n,e,r,i){function a(t){return function(n){return t==n.id}}function u(t){return function(n){return n[t]}}function o(t){return function(n){return n!=t}}function s(t,n,e,r,a){var u=i.getSecondaryRelations(t,n,e);l.get(u.definition,r(u.layouts),a,a)}function d(n){var e=function(t){return function(n){return{id:n.relationId,type:n.relationType,master:t.id,slave:n.id}}},r=function(t){return function(n){return{id:n.relationId,type:n.relationType,master:n.id,slave:t.id}}};return t.chain(n).map(function(t){return[t.data.slaves.map(e(t.data)),t.data.masters.map(r(t.data))]}).flatten(!1).unique(!1,u("id")).value()}function f(n){var e=t.map(n,u("id"));return t.chain(n).map(function(t){return[t.slaves,t.masters]}).flatten(!1).unique(!1,u("id")).filter(function(t){return e.every(o(t.id))}).value()}function c(t,n){return t.map(function(t){return{id:t.id,source:n.filter(a(t.master))[0],target:n.filter(a(t.slave))[0],value:1,type:t.type}}).filter(function(t){return t.source&&t.target})}var l=new e({url:"/slice/v1/matrix/cardsDetails"});return r.extend({"bus data.ready":function(e,r){this._beforeLoad();var i=this,a=t.map(r.data,u("data")),o=f(a),l=r.settings.parameters.definition.global.acid;s(o,l,r.settings.configurator,function(e){return function(u){var o=t.map(a,function(t){return n.extend(t,{nodeType:"primary"})}),s=t.map(u.items,function(t){return n.extend(t.data,{nodeType:"secondary"})}),f=t.union(o,s);f.forEach(function(t){t.links=t.links||[]});var l=d(r.data);c(l,f).forEach(function(t){t.source.links.push(t),t.target.links.push(t)}),r.settings.layouts=n.extend(r.settings.layouts,e),i._afterLoad(),i.fire("nodes.ready",{nodes:f,settings:r.settings})}},t.bind(this._error,this))}})});