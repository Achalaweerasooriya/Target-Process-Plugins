define(["libs/d3/d3"],function(d3){function noop(){}function select(key){return function(d){return d[key]}}function sqr(x){return x*x}function force(){var d3_force=d3.layout.force(),force_resume=d3_force.resume,extension={resume:function(){force_resume.call(d3_force);while(!d3_force.tick.call(d3_force));return this}};return d3.rebind(d3_force,extension,"resume")}return{graph:function(){function tick(e){var kx=Math.min(1,size[1]/size[0]),ky=Math.min(1,size[0]/size[1]),k=gravity*e.alpha;k&&nodes.forEach(function(node){node.x+=(size[0]/2-node.x)*k*kx,node.y+=(size[1]/2-node.y)*k*ky}),links.forEach(function(link){var distance=(link.source.r+link.target.r)/2;if(link.source.x>link.target.x-distance){var dx=(link.source.x-link.source.x+distance)*1.5*e.alpha;link.source.x-=dx,link.target.x+=dx}link.source.y+=e.alpha*(link.target.y-link.source.y)/2,link.target.y+=e.alpha*(link.source.y-link.target.y)/2}),nodes.filter(select("fixed")).forEach(function(node){node.x=node.px,node.y=node.py})}function graph(){}function dragStart(d){d3_force.stop(),d3.select(this).style("z-index",100)}function dragEnd(d){d3.select(this).style("z-index",undefined),d.fixed=!0,d3_force.resume()}function dragMove(d){d.px=d.x,d.py=d.y,d.x=graph.scales.x.invert(d3.event.x),d.y=graph.scales.y.invert(d3.event.y),dragmove(d)}var gravity=2.5,width,size=[],links=[],nodes=[],end=noop,dragmove=noop,d3_force=force();return graph.doLayout=function(){nodes.forEach(function(node){node.r=Math.sqrt(2*sqr(node.size[0])),node.charge=-sqr(node.r*(1+Math.log(node.links.length/10+1)))});var nodeWidth=d3.max(nodes,function(node){return node.size[0]}),nodeHeight=d3.max(nodes,function(node){return node.size[1]}),nodeRatio=d3.max(nodes,function(node){return node.size[1]/node.size[0]});size[0]=Math.min(width,2*Math.sqrt(-d3.sum(nodes,select("charge")))),size[1]=-4*d3.sum(nodes,select("charge"))/size[0]/gravity;var d3_force_on_end=function(){var xRange=d3.extent(nodes,select("x")),yRange=d3.extent(nodes,select("y"));graph.height=function(){return(yRange[1]-yRange[0])*nodeRatio+2*nodeHeight},graph.scales={x:d3.scale.linear().range([nodeWidth,size[0]-nodeWidth]).domain(xRange),y:d3.scale.linear().range([nodeHeight,graph.height()-nodeHeight]).domain(yRange)},end()};return d3_force.gravity(0).charge(select("charge")).linkDistance(Math.sqrt(2*sqr(nodeWidth))).nodes(nodes).links(links).size(size).on("tick",function(e){tick(e)}).on("end",function(){d3_force_on_end(),d3_force_on_end=end}).start(),graph},graph.nodes=function(value){return value?(nodes=value,graph):nodes},graph.links=function(value){return value?(links=value,graph):links},graph.gravity=function(value){return gravity=value,graph},graph.width=function(value){return width=value,graph},graph.end=function(value){return end=value,graph},graph.dragmove=function(value){return dragmove=value,graph},graph.drag=d3.behavior.drag().on("dragstart.graph",dragStart).on("dragend.graph",dragEnd).on("drag.graph",dragMove),graph}}})