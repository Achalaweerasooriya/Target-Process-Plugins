define(["libs/d3/d3"],function(n){function r(){}function t(n){return function(r){return r[n]}}function e(n){return n*n}function a(){var r=n.layout.force(),t=r.resume,e={resume:function(){for(t.call(r);!r.tick.call(r););return this}};return n.rebind(r,e,"resume")}return{graph:function(){function i(n){var r=Math.min(1,g[1]/g[0]),e=Math.min(1,g[0]/g[1]),a=h*n.alpha;a&&x.forEach(function(n){n.x+=(g[0]/2-n.x)*a*r,n.y+=(g[1]/2-n.y)*a*e}),l.forEach(function(r){var t=(r.source.r+r.target.r)/2;if(r.source.x>r.target.x-t){var e=1.5*(r.source.x-r.source.x+t)*n.alpha;r.source.x-=e,r.target.x+=e}r.source.y+=n.alpha*(r.target.y-r.source.y)/2,r.target.y+=n.alpha*(r.source.y-r.target.y)/2}),x.filter(t("fixed")).forEach(function(n){n.x=n.px,n.y=n.py})}function u(){}function o(){v.stop(),n.select(this).style("z-index",100)}function c(r){n.select(this).style("z-index",void 0),r.fixed=!0,v.resume()}function s(r){r.px=r.x,r.py=r.y,r.x=u.scales.x.invert(n.event.x),r.y=u.scales.y.invert(n.event.y),y(r)}var f,h=2.5,g=[],l=[],x=[],d=r,y=r,v=a();return u.doLayout=function(){x.forEach(function(n){n.r=Math.sqrt(2*e(n.size[0])),n.charge=-e(n.r*(1+Math.log(n.links.length/10+1)))});var r=n.max(x,function(n){return n.size[0]}),a=n.max(x,function(n){return n.size[1]}),o=n.max(x,function(n){return n.size[1]/n.size[0]});g[0]=Math.min(f,2*Math.sqrt(-n.sum(x,t("charge")))),g[1]=-4*n.sum(x,t("charge"))/g[0]/h;var c=function(){var e=n.extent(x,t("x")),i=n.extent(x,t("y"));u.height=function(){return(i[1]-i[0])*o+2*a},u.scales={x:n.scale.linear().range([r,g[0]-r]).domain(e),y:n.scale.linear().range([a,u.height()-a]).domain(i)},d()};return v.gravity(0).charge(t("charge")).linkDistance(Math.sqrt(2*e(r))).nodes(x).links(l).size(g).on("tick",function(n){i(n)}).on("end",function(){c(),c=d}).start(),u},u.nodes=function(n){return n?(x=n,u):x},u.links=function(n){return n?(l=n,u):l},u.gravity=function(n){return h=n,u},u.width=function(n){return f=n,u},u.end=function(n){return d=n,u},u.dragmove=function(n){return y=n,u},u.drag=n.behavior.drag().on("dragstart.graph",o).on("dragend.graph",c).on("drag.graph",s),u}}});