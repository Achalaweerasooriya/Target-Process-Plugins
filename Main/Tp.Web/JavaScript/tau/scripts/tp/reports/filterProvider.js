define(["jQuery","Underscore","app.path","tau/utils/utils.date","tp/reports/burndown/filterStorage","tp/reports/burndown/burnDownTypeProvider","tp/dropdown"],function(t,e,i,n,r,s){function a(){this.currentIterations=[],this.storage=new r({groupName:"burnDownVer2Filter"}),this.burnDownTypeProvider=new s}return a.prototype={initialize:function(e){this.dataProvider=e.dataProvider,this.placeholder=e.placeholder,this.template=e.template,this.contextProvider=e.contextProvider,this.plannablesRetrieved=!1;var i=this;this.update=function(){i._saveFilter(),e.update()},this._getSavedFilter(function(n){i.savedFilter=n,i.burnDownTypeProvider.initialize({placeholder:e.placeholder,contextProvider:e.contextProvider,updatePlannable:t.proxy(this._drawChart,this),savedFilter:i.savedFilter,filterProvider:this});var r=i.burnDownTypeProvider.getType();i._drawChart(r,t.proxy(i._render,i))})},_drawChart:function(e,i){this.plannableRetrieve=t.proxy(this.dataProvider.getPlannable,this.dataProvider),this._getIterations(i)},_getIterations:function(e){if(this.plannablesRetrieved)return this.iterations=this._getForType(this.allIterations),this.currentIterations=this._getForType(this.allCurrentIterations),void e();var i=this;this._retrieveIterations(this.contextProvider.getProjectIds(),this.contextProvider.getTeamIds(),function(r){var s=n.getServerNow();i.allIterations=t.map(r,function(t){var e=n.convertToTimezone(t.startDate),i=n.convertToTimezone(t.endDate);return{startDate:e,endDate:i,id:t.id,name:t.name,entityType:t.entityType,current:n.between(s,e,i),isBugsAvailable:t.isBugsAvailable,isPointsAvailable:t.isPointsAvailable,isTimeTrackingAvailable:t.isTimeTrackingAvailable,parent:{id:t.parentId,name:t.parentName}}}),i.allCurrentIterations=i.allIterations.filter(function(t){return t.current}),i.iterations=i._getForType(i.allIterations),i.currentIterations=i._getForType(i.allCurrentIterations),i.plannablesRetrieved=!0,e()})},_getForType:function(t){var e=this.burnDownTypeProvider.getType();return t.filter(function(t){return t.entityType.toLowerCase()==e.toLowerCase()})},_retrieveIterations:function(t,e,i){this.plannableRetrieve({projectIds:t,teamIds:e},i)},_render:function(){var e=this.contextProvider.getBugsTerm();this.template=this.template.replace("{1}",e),this.placeholder.html(this.template),0==this.allIterations.length&&this.placeholder.hide(),t.datepicker.parseDate=function(t,e){return n.parse(e)},t.datepicker.formatDate=function(t,e){return n.formatAs(e,t)},this.placeholder.find("._startDate").datepicker({buttonImageOnly:!1,showOn:"both",buttonText:"Choose",onSelect:this.update,dateFormat:"MM/dd/yyyy"}),this.placeholder.find("._weekends").click(this.update),this._pointsButton().click(t.proxy(this._onUnitsClick,this)),this._hoursButton().click(t.proxy(this._onUnitsClick,this)),this.placeholder.find("._include-bugs").click(this.update);var i=this._getDefaultIteration();"undefined"!=typeof i&&this.processFilterOptionsVisibility(i);var r=this,s=function(t){r.burnDownTypeProvider.render(t)};this._applySavedFilter(s),t(this).trigger("afterRender")},_saveFilter:function(){var t=this._getFilterData();if(null!=t){if(""==t.burnDownType)return;this._bugsSection().is(":visible")||delete t.showBugs,this._unitsSection().is(":visible")||delete t.isInPoints}this.storage.savePlannableFilter(t)},_getSavedFilter:function(e){this.storage.findPlannableFilter(t.proxy(e,this))},_applySavedFilter:function(t){null!=this.savedFilter&&(this._bugsSection().is(":visible")&&this._setShowBugs(this.savedFilter.showBugs),this._unitsSection().is(":visible")&&this._selectUnit(this.savedFilter.isInPoints),this._setIncludeWeekends(this.savedFilter.includeWeekends)),t(this.savedFilter)},_onUnitsClick:function(e){var i=t(e.currentTarget).text()==this._pointsButton().text();this._selectUnit(i);var n=this._getSelectedPlannable();n&&this._showBugs(n)?this._bugsSection().removeClass("invisible"):this._bugsSection().addClass("invisible"),this.update()},_selectUnit:function(t){t?(this._pointsButton().addClass("selected"),this._hoursButton().removeClass("selected")):(this._pointsButton().removeClass("selected"),this._hoursButton().addClass("selected"))},_showBugs:function(t){return t.isBugsAvailable&&!(t.isPointsAvailable&&!t.isTimeTrackingAvailable&&this._hoursButton().hasClass("selected")&&this._unitsSection().is(":visible"))},processFilterOptionsVisibility:function(t){var e=this._unitsSection(),i=this._bugsSection();t.isPointsAvailable?e.show():e.hide(),this._showBugs(t)?i.removeClass("invisible"):i.addClass("invisible")},_getDefaultIteration:function(){var t=this.iterations[0];return this.currentIterations.length&&(t=this.currentIterations.map(function(t){return t})[0]),t},getIterationsDropDownDataSource:function(e){for(var i=t.map(e,function(t){return t.parent}),n=[],r=0;r<i.length;r++){var s=i[r];0==t.grep(n,function(t){return t.id==s.id}).length&&n.push({id:s.id,name:s.name})}for(var r=0;r<n.length;r++)n[r].items=t.grep(e,function(t){return t.parent.id==n[r].id}).map(function(t){return{id:t.id,name:t.current?t.name+" (current)":t.name}});return n.sort(function(t,e){return t.name==e.name?0:t.name.toLowerCase()<e.name.toLowerCase()?-1:1}),n},getManuallySetVelocity:function(){var t=this.placeholder.closest("._burnDownReport").find(".velocity-input");return t.length>0&&""!==t.val()?parseFloat(t.val()):0},_getUrl:function(t){return new i.tp.WebServiceURL(t).url},_getFilterData:function(){var t=this._getSelectedPlannable(),e=this._getStartDate();return t?{burnDownType:this.burnDownTypeProvider.getType(),plannableId:t.id,startDate:e?e:null,includeWeekends:this._getIncludeWeekends(),isInPoints:this.isInPoints(),showBugs:this.isShowBugs(),units:t.isPointsAvailable&&this.isInPoints()?"p":"h"}:null},_getPlannableId:function(){return this.burnDownTypeProvider.getPlannableId()},_getStartDate:function(){var t=this._getRawStartDate();return n.format.date.short(t)},_getRawStartDate:function(){var t=this.placeholder.find("._startDate").datepicker().datepicker("getDate");return t},setStartDate:function(t){this.placeholder.find("._startDate").datepicker("setDate",t)},_getIncludeWeekends:function(){return this._isChecked("_weekends")},_setIncludeWeekends:function(t){return this.placeholder.find("._weekends").attr("checked",t)},isInPoints:function(){return this._unitsSection().is(":visible")?this._pointsButton().hasClass("selected"):this._getSelectedPlannable().isPointsAvailable},isShowBugs:function(){return this._bugsSection().is(":visible")?this._isChecked("_include-bugs"):!1},_isChecked:function(t){return this.placeholder.find("."+t+":visible")&&"on"==this.placeholder.find("."+t+":checked").val()},_unitsSection:function(){return this.placeholder.find("._unitsOption")},_pointsButton:function(){return this.placeholder.find("._inPoints")},_hoursButton:function(){return this.placeholder.find("._inHours")},_bugsSection:function(){return this.placeholder.find("._bugsOption")},_setShowBugs:function(t){this.placeholder.find("._include-bugs").attr("checked",t)},_getSelectedPlannable:function(){var e=this._getPlannableId(),i=t.grep(this.allIterations,function(t){return t.id==e});if(i.length>0){var n=i[0];return n.typeName=this.burnDownTypeProvider.getType(),n}return null}},a});