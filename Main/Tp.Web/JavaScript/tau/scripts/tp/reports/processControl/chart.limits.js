define(["libs/jstat/jstat.extensions","libs/d3/d3","Underscore","tp/reports/chart.behaviour","tp/reports/processControl/chart.axes.format"],function(t,e,n,a,r){return a.extend({getData:function(t,e){for(var n=[],a=e.scales.stroke.domain(),r=e.scales.stroke.range(),i=0;i<a.length;i++){var s=this._getEntityDataForStroke(t,a[i]);if(s.length>0){var l=r[i],o=this._getLimitsData(s,l,e);n=n.concat(o)}}return this.adjustLabelsPlacement(n)},_getEntityDataForStroke:function(t,e){return t.filter(function(t){return t.stroke==e}).map(function(t){return t.y})},_getLimitsData:function(e,a,r){var i=t(e),s=i.median(),l=Math.sqrt(i.meansqerr()),o=r.scales.y.range()[1];return n.filter([this.getControlLimitData(s,l,a,r),this.getWarningLimitData(s,l,a,r),this.getMedianData(s,a,r)],function(t){return t.y>o})},getControlLimitData:function(t,e,n,a){var r=t+3*e,i=a.scales.y(r);return 0===e&&(i-=2),{id:n+"control",value:r,text:"Control limit: ","class":"control",entityType:n,description:"Indicates the threshold at which the process is statistically 'unlikely' (3 standard errors from the median).",y:i}},getWarningLimitData:function(t,e,n,a){var r=t+2*e,i=a.scales.y(r);return 0===e&&(i-=1),{id:n+"warning",value:t+2*e,text:"Warning limit: ","class":"warning",entityType:n,description:"Indicates the dangerous threshold. All the items above this line are suspicious (2 standard errors from the median).",y:i}},getMedianData:function(t,e,n){return{id:e+"median",value:t,text:"Median: ","class":"median",entityType:e,description:'Typical lead or cycle time. The "middle" value in the list of all values.',y:n.scales.y(t)}},adjustLabelsPlacement:function(e){var a=18,r=function(t,e,n){return Math.abs(t-e)<=a*n},i=n.chain(e).sortBy(function(t){return t.y}).value();return n.each(i,function(e,i,s){var l=n.filter(s,function(t,n){return r(t.y,e.y,Math.abs(i-n))}),o=l.length,c=t(l.map(function(t){return t.y})).mean();n.each(l,function(t,e){t.y=c+(e-o/2)*a+10})}),i},data:function(t,n){e.select(n.placeholder).classed("limits",!0);var a=this.getData(t.nodes,n),i=e.select(n.placeholder).selectAll("line.limit").data(a,function(t){return t.id});i.enter().append("line"),i.exit().remove(),i.attr("class",function(t){return"limit "+t["class"]+" "+t.entityType}).transition().attr("x1",n.scales.x.range()[0]-n.scales.axisMargin).attr("y1",function(t){return n.scales.y(t.value)}).attr("x2",n.scales.x.range()[1]).attr("y2",function(t){return n.scales.y(t.value)});var s=e.select(n.placeholder).selectAll("text.limit.limitLabel").data(a,function(t){return t.id});s.enter().append("text"),s.exit().remove(),s.attr("class",function(t){return"limit limitLabel "+t.entityType}).transition().text(function(t){return t.text+r.timerange("d","h","min")(t.value)}).attr("x",n.scales.x.range()[1]+n.plot.margin/4).attr("y",function(t){return t.y}).attr("dy",".35em"),this._subscribe(s,["mouseover","mouseout"],n)}})});