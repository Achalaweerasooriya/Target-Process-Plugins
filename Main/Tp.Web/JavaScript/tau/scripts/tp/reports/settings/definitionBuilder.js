define(["Underscore","tau/models/board.customize.units/board.customize.cards.builderSelector","tau/services/customize/service.customize.card.layout.factory","tau/configurations/definitions/board.definition.factory","tau/models/board.customize.units/const.card.sizes"],function(e,t,n,a,i){var s=function(e){switch(e){case"feature":case"userstory":case"task":case"bug":case"request":return"assignable";case"solution":return;default:return e}},r={relations:function(){return"masterRelations.Select({Master.id as id, Master.name as name,Master.entityType.name as type,RelationType.name as relationType,id as relationId}) as masters,slaveRelations.Select({Slave.id as id,Slave.name as name, Slave.entityType.name as type,RelationType.name as relationType,id as relationId}) as slaves"},data:function(){return"id, name, entityType.name as type"}},l=function(a,i,s,l){var o=e.filter(i,function(e){return"program"!==e.toLowerCase()}),u={get:function(){return $.Deferred().resolve({cells:o,zoomLevel:{board:3}})}},d=new n(s,u),c=new t;d.getCardLayoutsByTypesAndSize(o,l).then(function(t){return e.reduce(t,function(e,t,n){return e.types.push({type:n,data:c.build(n,t)}),e.mapLayouts[n]=t,e},{types:[],mapLayouts:{}})}).done(function(t){a.cells.types=t.types,a.layouts=t.mapLayouts,a.cells.items=e.map(t.types,function(e){return{id:e.type,data:e.data.substring(0,e.data.lastIndexOf("}"))+","+r.data()+","+r.relations()+"}",ordering:null}})}.bind(this))};return{getTypeGroup:s,cell:r,getWithRelations:function(t,n,a){var s=e.map(t.entities,function(e){return e.id}),r={base64:!0,take:100,where:null,definition:{global:{acid:n},x:null,y:null,cells:{items:{},filter:t.useFilter?t.filter:null,types:[]},user:{cardFilter:t.onlyWithRelations?"?(MasterRelations.Count > 0) or (SlaveRelations.Count > 0)":""}}};return l(r.definition,s,a,i.M),{definition:r,layouts:{primary:r.definition.layouts}}},getSecondaryRelations:function(t,n,a){var s=e.map(t,function(e){return e.type}),r={CardsIds:e.pluck(t,"id"),base64:!0,take:t.length,where:null,definition:{global:{acid:n},x:null,y:null,cells:{items:{}}}};return l(r.definition,s,a,i.XS),{definition:r,layouts:{secondary:r.definition.layouts}}},getWithLeadAndCycleTime:function(t,n){return{base64:!0,take:1e3,where:null,definition:{global:{acid:n},x:{id:"entitystate",filter:"?IsFinal is True",ordering:null},cells:{items:e.map(t.entities,function(e){return{id:e.id,data:"{id,name,entityType.name as type,endDate,leadTime,cycleTime}",filter:null,ordering:null}}),filter:t.useFilter?t.filter:null},user:{cardFilter:"?EndDate is not None and ("+t.time.filter+")"}}}}}});