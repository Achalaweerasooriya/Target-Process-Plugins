define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/ui/behaviour/overlay/ui.behaviour.overlay","libs/jquery/jquery.placeholder","libs/jquery/jquery.toggleFilter"],function(e,t,i){return i.extend({"bus $el.ready:last + error":function(e,t){t.tauOverlay("hide")},"bus $form.ready":function(e,i){var n=this,l=i.find(".i-role-filter-input");l.each(function(){t(this).data("default",t(this).val())}),i.find(".i-role-filter-control").toggleFilter({}),i.on("click",".i-role-report-entity-type",function(e){var n=t(this),l=n.prev(),a=!n.hasClass("tau-checked");n.toggleClass("tau-checked",a),l.prop("checked",a),i.trigger("_change",{$input:l,sourceEvent:e})});var a="[name=data_filter]",r=i.find(a);i.delegate(a,"keydown",function(e){if(e.which==t.ui.keyCode.ENTER){var i=t(this);i.blur()}}),i.on("_change",function(){n._enableFilter(n.unbind(i).entities.length,r),n.fire("filter.form.changed")})},_enableFilter:function(e,t){t.prop("disabled",!e);var i=t.closest(".i-role-filter-control");i.find(".i-role-help").prop("disabled",!e),i.find(".i-role-filter-toggle").prop("disabled",!e&&!i.hasClass("i-role-filter-control_on"))},"bus configurator.ready:last + $form.ready:last + filter.resolve":function(e,t,i,n){var l=this.unbind(i),a=this;t.getAppStateStore().get({fields:["acid"],callback:function(e){a.getSpaceTotal(t.getSliceFactory(),e.acid,l).done(function(e){a.updateForm(t,i,e),n.resolve(l)})}})},unbind:function(e){return{entities:e.find("[name=entities]:checked").map(function(){return{id:t(this).val()}}),filter:e.find("[name=data_filter]").val(),useFilter:!!e.find(".i-role-useFilter").prop("checked")}},updateForm:function(i,n,l){var a=n.find("[name=entities]"),r=l.cells.types;e.forEach(r,function(e){var i=a.filter(function(){return this.value==e.id||t(this).hasClass("permission-denied")}),n=i.next(),l=!e.isAvailable;i.add(n).prop("disabled",l).toggleClass("tau-disabled",l)})},getSpaceTotal:function(i,n,l){return t.when(this.spaceAvailable(i,n),this.spaceCells(i,n,l)).pipe(function(t,i){var n={spaceDefault:t.space,spaceAvailable:{cells:i.space.cells||[]},settingsCurrent:i.settings},l={cells:{name:"cells",types:[],filter:""}},a=function(e){return e.toLowerCase()
};return l.cells.types=e.map(n.spaceDefault.cells.items,function(t){var i={id:t.id,name:t.name,isAvailable:e.any(n.spaceAvailable.cells.items,function(e){return a(e.id)===a(t.id)}),isSelected:e.any(n.settingsCurrent.cells.items,function(e){return a(e.id)===a(t.id)})};return i.isAvailable=i.isSelected?!0:i.isAvailable,i}),l.cells.filter=n.settingsCurrent.cells.filter||"",l.acid=i.settings.acid||"",l})},spaceAvailable:function(e,t){var i={global:{acid:t}},n=e.create({definition:i});return n.space().pipe(function(e){return{space:e.data}})},spaceCells:function(t,i,n){var l={cells:{items:n.entities,filter:n.filter},acid:i},a={definition:{global:{acid:i},cells:{items:e.map(l.cells.items,function(e){return{id:e.id,data:null,filter:null,type:e.id}})}}},r=t.create(a);return r.space().pipe(function(e){return{space:e.data,settings:l}})}})});