define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/ui/behaviour/overlay/ui.behaviour.overlay","libs/jquery/jquery.placeholder","libs/jquery/jquery.toggleFilter"],function(e,i,t){return t.extend({"bus $el.ready:last + error":function(e,i){i.tauOverlay("hide")},"bus $form.ready":function(e,t){var n=this,l=t.find(".i-role-filter-input");l.placeholder(),l.each(function(){i(this).data("default",i(this).val())}),t.find(".i-role-filter-control").toggleFilter({}),t.on("click",".i-role-report-entity-type",function(e){var n=i(this),l=n.prev(),a=!n.hasClass("tau-checked");n.toggleClass("tau-checked",a),l.prop("checked",a),t.trigger("_change",{$input:l,sourceEvent:e})});var a="[name=data_filter]",r=t.find(a);t.delegate(a,"keydown",function(e){if(e.which==i.ui.keyCode.ENTER){var t=i(this);t.blur()}}),t.on("_change",function(){n._enableFilter(n.unbind(t).entities.length,r),n.fire("filter.form.changed")})},_enableFilter:function(e,i){i.prop("disabled",!e);var t=i.closest(".i-role-filter-control");t.find(".i-role-help").prop("disabled",!e),t.find(".i-role-filter-toggle").prop("disabled",!e&&!t.hasClass("i-role-filter-control_on"))},"bus configurator.ready:last + $form.ready:last + filter.resolve":function(e,i,t,n){var l=this.unbind(t),a=this;i.getAppStateStore().get({fields:["acid"],callback:function(e){a.getSpaceTotal(i.getSliceFactory(),e.acid,l).done(function(e){a.updateForm(i,t,e),n.resolve(l)})}})},unbind:function(e){return{entities:e.find("[name=entities]:checked").map(function(){return{id:i(this).val()}}),filter:e.find("[name=data_filter]").val(),useFilter:!!e.find(".i-role-useFilter").prop("checked")}},updateForm:function(t,n,l){var a=n.find(".i-role-filter-input");a.placeholder("refresh");var r=n.find("[name=entities]"),s=l.cells.types;e.forEach(s,function(e){var t=r.filter(function(){return this.value==e.id||i(this).hasClass("permission-denied")}),n=t.next(),l=!e.isAvailable;t.add(n).prop("disabled",l).toggleClass("tau-disabled",l)})},getSpaceTotal:function(t,n,l){return i.when(this.spaceAvailable(t,n),this.spaceCells(t,n,l)).pipe(function(i,t){var n={spaceDefault:i.space,spaceAvailable:{cells:t.space.cells||[]},settingsCurrent:t.settings},l={cells:{name:"cells",types:[],filter:""}},a=function(e){return e.toLowerCase()};return l.cells.types=e.map(n.spaceDefault.cells.items,function(i){var t={id:i.id,name:i.name,isAvailable:e.any(n.spaceAvailable.cells.items,function(e){return a(e.id)===a(i.id)}),isSelected:e.any(n.settingsCurrent.cells.items,function(e){return a(e.id)===a(i.id)})};return t.isAvailable=t.isSelected?!0:t.isAvailable,t}),l.cells.filter=n.settingsCurrent.cells.filter||"",l.acid=t.settings.acid||"",l})},spaceAvailable:function(e,i){var t={global:{acid:i}},n=e.create({definition:t});return n.space().pipe(function(e){return{space:e.data}})},spaceCells:function(i,t,n){var l={cells:{items:n.entities,filter:n.filter},acid:t},a={definition:{global:{acid:t},cells:{items:e.map(l.cells.items,function(e){return{id:e.id,data:null,filter:null,type:e.id}})}}},r=i.create(a);return r.space().pipe(function(e){return{space:e.data,settings:l}})}})});