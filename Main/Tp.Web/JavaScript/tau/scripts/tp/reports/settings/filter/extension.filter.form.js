define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/ui/behaviour/overlay/ui.behaviour.overlay","libs/jquery/jquery.placeholder","libs/jquery/jquery.toggleFilter"],function(_,$,ExtensionBase){return ExtensionBase.extend({"bus $el.ready:last + error":function(evt,$el){$el.tauOverlay("hide")},"bus $form.ready":function(evt,$form){var self=this,$filters=$form.find(".i-role-filter-input");$filters.placeholder(),$filters.each(function(){$(this).data("default",$(this).val())}),$form.find(".i-role-filter-control").find("button").addClass("tau-checked").end().toggleFilter({defaultExpand:!0}),$form.delegate("[name=entities]","change",function(e){$form.find("input:checked").next().addClass("tau-checked"),$form.find("input:not(:checked)").next().removeClass("tau-checked"),$form.trigger("_change",{$input:$(this),sourceEvent:e})});var filterSelector="[name=data_filter]",$filter=$form.find(filterSelector);$form.delegate(filterSelector,"keydown",function(e){if(e.which==$.ui.keyCode.ENTER){var $input=$(this);$input.blur()}}),$form.on("_change",function(e,source){self._enableFilter(self.unbind($form).entities.length,$filter),self.fire("filter.form.changed")})},_enableFilter:function(enabled,$filter){$filter.prop("disabled",!enabled);var $control=$filter.closest(".i-role-filter-control");$control.find(".i-role-help").prop("disabled",!enabled),$control.find(".i-role-filter-toggle").prop("disabled",!enabled&&!$control.hasClass("i-role-filter-control_on"))},"bus configurator.ready:last + $form.ready:last + filter.resolve":function(e,configurator,$form,promise){var filter=this.unbind($form),self=this;configurator.getAppStateStore().get({fields:["acid"],callback:function(r){self.getSpaceTotal(configurator.getSliceFactory(),r.acid,filter).done(function(space){self.updateForm(configurator,$form,space),promise.resolve(filter)})}})},unbind:function($form){return{entities:$form.find("[name=entities]:checked").map(function(){return{id:$(this).val()}}),filter:$form.find("[name=data_filter]").val()}},updateForm:function(configurator,$form,space){var $filter=$form.find(".i-role-filter-input");$filter.placeholder("refresh");var $cells=$form.find("[name=entities]"),items=space.cells.types;_.forEach(items,function(item){$cells.filter(function(){return this.value==item.id||$(this).hasClass("permission-denied")}).prop("disabled",!item.isAvailable).toggleClass("tau-disabled",!item.isAvailable).next().prop("disabled",!item.isAvailable).toggleClass("tau-disabled",!item.isAvailable)})},getSpaceTotal:function(sliceFactory,acid,filter){return $.when(this.spaceAvailable(sliceFactory,acid),this.spaceCells(sliceFactory,acid,filter)).pipe(function(spaceAvailable,spaceCells){var data={spaceDefault:spaceAvailable.space,spaceAvailable:{cells:spaceCells.space.cells||[]},settingsCurrent:spaceCells.settings},space={cells:{name:"cells",types:[],filter:""}},lc=function(s){return s.toLowerCase()};return space.cells.types=_.map(data.spaceDefault.cells.items,function(v){var item={id:v.id,name:v.name,isAvailable:_.any(data.spaceAvailable.cells.items,function(u){return lc(u.id)===lc(v.id)}),isSelected:_.any(data.settingsCurrent.cells.items,function(u){return lc(u.id)===lc(v.id)})};return item.isAvailable=item.isSelected?!0:item.isAvailable,item}),space.cells.filter=data.settingsCurrent.cells.filter||"",space.acid=spaceCells.settings.acid||"",space})},spaceAvailable:function(sliceFactory,acid){var definition={global:{acid:acid}},slice=sliceFactory.create({definition:definition});return slice.space().pipe(function(result){return{space:result.data}})},spaceCells:function(sliceFactory,acid,filter){var settings={cells:{items:filter.entities,filter:filter.filter},acid:acid},sliceConfig={definition:{global:{acid:acid},cells:{items:_.map(settings.cells.items,function(item){return{id:item.id,data:null,filter:null,type:item.id}})}}},slice=sliceFactory.create(sliceConfig);return slice.space().pipe(function(result){return{space:result.data,settings:settings}})}})})