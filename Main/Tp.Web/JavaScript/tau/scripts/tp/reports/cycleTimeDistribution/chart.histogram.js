define(["jQuery","Underscore","libs/d3/d3","tp/reports/chart.behaviour"],function(t,e,n,r){return r.extend({init:function(t){this.handlers=this.initHandlers(t.handlers||[])},_join:function(e){return e[0].values.map(function(r,a){return{x:r.x,values:e.map(function(e){return t.extend(e.values[a],{fill:e.key,count:e.values.count})}).filter(function(t){return t.y>0}).sort(function(t,e){return n.descending(t.y,e.y)})}})},data:function(t,e){var r=t.nodes,t=this._join(r),a=n.select(e.placeholder).selectAll("g.day").data(t,function(t){return t.x});a.enter().append("g").attr("class","day"),a.exit().remove(),a.attr("transform",function(t){return"translate("+e.scales.x(t.x)+",0)"}).each(function(){var t=n.select(this);t.select("g")[0][0]||(t.append("g").attr("class","bar"),t.append("g").attr("class","top"))});var s=a.select("g.bar").selectAll("rect").data(function(t){return t.values},function(t){return t.fill});s.enter().append("rect"),s.exit().remove(),s.attr("class",function(t){return e.scales.fill(t.fill)}).transition().attr("y",function(t){return e.scales.y(t.y)}).attr("width",function(t){return e.scales.width(t.dx)-1}).attr("height",function(t){return e.scales.height(t.y)});var i=a.select("g.top").selectAll("line").data(function(t){return t.values},function(t){return t.fill});i.enter().append("line"),i.exit().remove(),i.attr("class",function(t){return e.scales.fill(t.fill)}).transition().attr("y1",function(t){return e.scales.y(t.y)}).attr("y2",function(t){return e.scales.y(t.y)}).attr("x1",.5).attr("x2",e.scales.x(1)-e.scales.x(0)-1),this._subscribe(a,["mousemove","mouseover","mouseout"],e)}})});