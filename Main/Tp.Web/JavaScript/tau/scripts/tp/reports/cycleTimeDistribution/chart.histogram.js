define(["jQuery","Underscore","libs/d3/d3","tp/reports/chart.behaviour"],function($,_,d3,ChartBehavior){return ChartBehavior.extend({init:function(config){this.handlers=this.initHandlers(config.handlers||[])},_join:function(histograms){return histograms[0].values.map(function(_,i){return{x:_.x,values:histograms.map(function(bundle){return $.extend(bundle.values[i],{fill:bundle.key,count:bundle.values.count})}).filter(function(d){return d.y>0}).sort(function(d1,d2){return d3.descending(d1.y,d2.y)})}})},data:function(histograms,context){var data=this._join(histograms),bins=d3.select(context.placeholder).selectAll("g.day").data(data,function(d){return d.x});bins.enter().append("g").attr("class","day"),bins.exit().remove(),bins.attr("transform",function(d){return"translate("+context.scales.x(d.x)+",0)"}).each(function(){var elem=d3.select(this);elem.select("g")[0][0]||(elem.append("g").attr("class","bar"),elem.append("g").attr("class","top"))});var bars=bins.select("g.bar").selectAll("rect").data(function(d){return d.values},function(d){return d.fill});bars.enter().append("rect"),bars.exit().remove(),bars.attr("class",function(d){return context.scales.fill(d.fill)}).transition().attr("y",function(d){return context.scales.y(d.y)}).attr("width",function(d){return context.scales.width(d.dx)-1}).attr("height",function(d){return context.scales.height(d.y)});var topBars=bins.select("g.top").selectAll("line").data(function(d){return d.values},function(d){return d.fill});topBars.enter().append("line"),topBars.exit().remove(),topBars.attr("class",function(d){return context.scales.fill(d.fill)}).transition().attr("y1",function(d){return context.scales.y(d.y)}).attr("y2",function(d){return context.scales.y(d.y)}).attr("x1",.5).attr("x2",context.scales.x(1)-context.scales.x(0)-1),this._subscribe(bins,["mousemove","mouseover","mouseout"],context)}})})