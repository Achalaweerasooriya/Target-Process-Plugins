define(["jQuery","Underscore","libs/d3/d3","tp/reports/chart.behaviour"],function($,_,d3){function ProbabilityChart(){}return ProbabilityChart.prototype={init:function(config){this.handlers=this.initHandlers(config.handlers||[])},_cumulative:function(histograms){var stack=d3.layout.stack();return histograms.map(function(d){return stack(d.values.map(function(bin){return[{x:bin.x,y:bin.y,dx:bin.dx,fill:d.key}]}))})},_join:function(stacks){return stacks[0].map(function(_,i){return{x:_[0].x,values:stacks.map(function(d){return d[i][0]})}})},data:function(histograms,context){var data=this._join(this._cumulative(histograms)),bins=d3.select(context.placeholder).attr("opacity",0).selectAll("g.probability").data(data);bins.enter().append("g").attr("class",function(d){return"probability data-x-"+d.x}),bins.exit().remove();var lines=bins.selectAll("path").data(function(d){return d.values},function(d){return d.fill});lines.enter().append("path"),lines.exit().remove(),lines.attr("class",function(d){return context.scales.fill(d.fill)}).transition().attr("d",function(d){return"M"+context.scales.x(d.x)+","+context.scales.probability(d.y0)+"L"+context.scales.x(d.x)+","+context.scales.probability(d.y+d.y0)+"L"+context.scales.x(d.x+d.dx)+","+context.scales.probability(d.y+d.y0)})}},ProbabilityChart})