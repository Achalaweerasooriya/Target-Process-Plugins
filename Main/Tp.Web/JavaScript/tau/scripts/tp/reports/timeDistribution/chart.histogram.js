define(["jQuery","Underscore","libs/d3/d3","tp/reports/chart.behaviour"],function($,_,d3,ChartBehavior){return ChartBehavior.extend({init:function(config){this.contextProvider=config.contextProvider,this.handlers=this.initHandlers(config.handlers||[])},_prepare:function(histograms,context){return d3.range(1,context.scales.x.domain()[1]).map(function(x,i){return{x:x,values:histograms.map(function(bundle){return $.extend(bundle.values[i],{fill:bundle.key,count:bundle.values.count})}).filter(function(d){return d.y>0})}})},_renderHistogram:function(histograms,context){var preparedData=this._prepare(histograms,context),bins=d3.select(context.placeholder).selectAll("g.day").data(preparedData,function(d){return d.x});bins.enter().append("g").attr("class","day"),bins.exit().remove(),bins.attr("transform",function(d){return"translate("+context.scales.x(d.x-1)+",0)"}).each(function(){var elem=d3.select(this);elem.select("g")[0][0]||(elem.append("g").attr("class","bar"),elem.append("g").attr("class","top"))});var bars=bins.select("g.bar").selectAll("rect").data(function(d){return d.values.filter(function(d1){return d1.y})},function(d){return d.fill});bars.enter().append("rect"),bars.exit().remove(),bars.attr("class",function(d){return context.scales.fill(d.fill)}).transition().attr("y",function(d){return context.scales.y(d.y)}).attr("width",context.scales.x(1)-context.scales.x(0)).attr("height",function(d){return context.scales.y.range()[0]-context.scales.y(d.y)});var topBars=bins.select("g.top").selectAll("line").data(function(d){return d.values.filter(function(d1){return d1.y})},function(d){return d.fill});return topBars.enter().append("line"),topBars.exit().remove(),topBars.attr("class",function(d){return context.scales.fill(d.fill)}).transition().attr("y1",function(d){return context.scales.y(d.y)}).attr("y2",function(d){return context.scales.y(d.y)}).attr("x1",.5).attr("x2",context.scales.x(1)-context.scales.x(0)-.5),bins},_renderMaxValues:function(histograms,context){var maxValData=histograms.map(function(d){return d.values.sort(d3.descending),$.extend(d.values[0],{key:d.key,count:d.values.count})}),maxVals=d3.select(context.placeholder).selectAll("text.max-val").data(maxValData,function(d){return d.key});maxVals.enter().append("text"),maxVals.exit().remove();var that=this;maxVals.attr("class",function(d){return context.scales.fill(d.key)+" max-val"}).text(function(d){return d.length+" of "+d.count+" "+that.contextProvider.getTerm(d.key,d.all).toLowerCase()}).transition().attr("x",function(d){return context.scales.x(d.x)}).attr("y",function(d){return context.scales.y(d.y)}).attr("dy",-5).attr("dx",2)},data:function(histograms,context){var bins=this._renderHistogram(histograms,context);this._renderMaxValues(histograms,context),this._subscribe(bins,["mouseover","mouseout"],context)}})})