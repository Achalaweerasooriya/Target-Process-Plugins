define(["jQuery"],function($){function setAlign(val){return function(config){return config.my=val,config}}return $.widget("ui.dropDown",{options:{value:null,quickData:[],data:[],select:$.noopF},_template:'<div class="_dropDown">\n    <div class="_items">\n        {{each groups}}\n        <div data-id="${id}" class="parents">${name}</div>\n        <ul>\n            {{each items}}\n            <li data-id="${id}" class="_item">${name}</li>\n            {{/each}}\n        </ul>\n        {{/each}}\n    </div>\n    {{if hasMore && showMore}}\n    <div class="more">\n        <a href="#" class="_more">more...</a>\n    </div>\n    {{/if}}\n</div>',_create:function(){this.element.after('<span class="add-on _opener"></span>'),this._opener=this.element.next(),this.element.tauBubble({className:"tau-summaryPopup iteration-bubble",onPositionConfig:setAlign("left top"),onBeforeShow:$.proxy(this._onBeforeShow,this)}),this.element.next().click($.proxy(function(event){event.stopPropagation(),this.element.click()},this)),this._setValue(this._getDataItem(this.options.value)),(!this.options.data||!this.options.data.length)&&(!this.options.quickData||!this.options.quickData.length)&&(this.element.addClass("caret-disabled"),this._opener.addClass("caret-disabled")),this.key="dropDown"+(new Date).getTime()},_getData:function(data){return{groups:data,hasMore:data!=this.options.data,showMore:this.options.data&&this.options.data.length>0}},_onItemClick:function(){var that=this;return function(){that.element.data("id",$(this).data("id")),that.element.text($(this).text()),that.element.tauBubble("hide"),that._setValue(that._getSelectedItem()),that.options.select()}},_onMoreClick:function(){var that=this;return function(event){event.preventDefault(),event.stopPropagation();var $content=that.element.data("tauBubble").$popup;$content.find("._item").unbind(),$content.find("._more").unbind(),that.element.tauBubble("option","content",that._getContent(that.options.data)),$content.find("._item").click(that._onItemClick())}},_getContent:function(data){return $.tmpl(this._template,this._getData(data))},_getSelectedItem:function(){var id=this.element.data("id");return this._getItem(id)},_getQuickDataItem:function(id){return this.options.quickData.length?this._getItemFromDataSource(this.options.quickData,id):this._getItem(id)},_getDataItem:function(id){var quick=this._getQuickDataItem(id);return typeof quick!="undefined"?quick:this._getItemFromDataSource(this.options.data,id)},_getItem:function(id){return this._getItemFromDataSource(this.options.data,id)},_getItemFromDataSource:function(dataSource,id){var items=$.map(dataSource,function(group){return $.grep(group.items,function(item){return item.id==id})});return items?items[0]:null},option:function(name,value){if(typeof value=="undefined")return this.options[name];name=="data"&&this._disable(!value||!value.length),name=="value"&&this._setValue(this._getQuickDataItem(value)),this.options[name]=value},_disable:function(val){val?(this.element.addClass("caret-disabled"),this._opener.addClass("caret-disabled")):(this.element.removeClass("caret-disabled"),this._opener.removeClass("caret-disabled")),this.options.disabled=val},_onBeforeShow:function(){if(this.element.is(".caret-disabled"))return!1;var data=this.options.quickData.length?this.options.quickData:this.options.data;if(!data.length)return;var content=this._getContent(data);this.element.tauBubble("option","content",content),content.find("._item").click(this._onItemClick()),content.find("._more").click(this._onMoreClick())},value:function(id){if(typeof id!="undefined"){this._setValue(this._getItem(id)),this.options.select();return}return this.options.disabled?"":this.element.data("id")||""},values:function(){var result=[];return $.merge(result,this.options.data),$.merge(result,this.options.quickData),$.map(result,function(item){return item.id})},_setValue:function(item){if(!item)return;this.element.data("id",item.id),this.element.text(item.name)},destroy:function(){this.element.next().remove(),this.bubble&&(this.bubble.bubblePopup("content").find("._item").unbind(),this.bubble.bubblePopup("content").find("._more").unbind(),this.bubble.bubblePopup("destroy"))}}),$})