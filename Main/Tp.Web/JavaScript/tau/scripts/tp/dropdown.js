define(["jQuery","libs/jquery/jquery.tmpl","tp/bubblepopup"],function($){return $.widget("ui.dropDown",{options:{value:null,quickData:[],data:[],select:$.noop},_template:'<div class="tau-bubble" style="display: block;">\n    <div class="tau-bubble__arrow-top" style="display: block; "></div>\n    <div class="tau-bubble__inner iteration-bubble" role="content">\n\n\n<div class="_dropDown">\n    <div class="_items">\n        {{each groups}}\n        <div data-id="${id}" class="projects">${name}</div>\n        <ul>\n            {{each items}}\n            <li data-id="${id}" class="_item">${name}</li>\n            {{/each}}\n        </ul>\n        {{/each}}\n    </div>\n    {{if hasMore}}\n    <div class="more">\n        <a href="#" class="_more">more...</a>\n    </div>\n    {{/if}}\n</div>\n        \n        </div>\n    \n    \n    </div>',_create:function(){this.element.after('<span class="add-on _opener"></span>');var a=$.proxy(function(a){a.stopPropagation(),this.open()},this);this.element.next().click(a),this.element.click(a),this._setValue(this._getQuickDataItem(this.options.value))},_getData:function(a){return{groups:a,hasMore:a!=this.options.data}},_onItemClick:function(){var a=this;return function(){a.element.data("id",$(this).data("id")),a.element.text($(this).text()),a.bubble.bubblePopup("close"),a._setValue(a._getSelectedItem()),a.options.select()}},_onMoreClick:function(){var a=this;return function(b){b.preventDefault(),b.stopPropagation(),a.bubble.bubblePopup("content").find("._item").unbind(),a.bubble.bubblePopup("content").find("._more").unbind(),a.bubble.bubblePopup("content",a._getContent(a.options.data)),a.bubble.bubblePopup("content").find("._item").click(a._onItemClick())}},_getContent:function(a){return $.tmpl(this._template,this._getData(a))},_getSelectedItem:function(){var a=this.element.data("id");return this._getItem(a)},_getQuickDataItem:function(a){return this.options.quickData?this._getItemFromDataSource(this.options.quickData,a):this._getItem(a)},_getItem:function(a){return this._getItemFromDataSource(this.options.data,a)},_getItemFromDataSource:function(a,b){var c=$.map(a,function(a){return $.grep(a.items,function(a){return a.id==b})});return c?c[0]:null},open:function(){var a=this._getContent(this.options.quickData.length?this.options.quickData:this.options.data);this.bubble=this.element.bubblePopup({content:a,key:"dropDown",top:30,left:-6}),a.find("._item").click(this._onItemClick()),a.find("._more").click(this._onMoreClick()),this.bubble.bubblePopup("open")},close:function(){this.bubble.bubblePopup("close")},value:function(a){if(typeof a!="undefined"){this._setValue(this._getItem(a)),this.options.select();return}return this.element.data("id")},_setValue:function(a){if(!a){this.element.text("---Select---");return}this.element.data("id",a.id),this.element.text(a.name)},destroy:function(){this.element.next().remove(),this.bubble.bubblePopup("content").find("._item").unbind(),this.bubble.bubblePopup("content").find("._more").unbind(),this.bubble.bubblePopup("destroy")}}),$})