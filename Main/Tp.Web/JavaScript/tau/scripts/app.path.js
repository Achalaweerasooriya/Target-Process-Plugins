define(["jQuery","tau/core/class"],function($,clazz){var appRoot=null,getAppPath=function(constantRequirePath){var result=null,location=window.location,search=location.search,href=location.href,position=search?href.indexOf(search):href.length,pathToPage=href.substr(0,position),pathToPageTokens=pathToPage.split("/");pathToPageTokens.pop();var pathToRequire=$(document).find('script[src*="/require.js"]').attr("src"),pathToRequireTokens=pathToRequire.split("/");pathToRequireTokens.pop();var constantRequirePathTokens=constantRequirePath.split("/");while(".."===pathToRequireTokens[0])pathToRequireTokens.shift(),pathToPageTokens.pop();if(pathToRequireTokens.length===0)for(var i=0;i<constantRequirePathTokens.length;i++)pathToPageTokens.pop();else if(pathToRequireTokens.join("/").toLowerCase()!==constantRequirePathTokens.join("/").toLowerCase())throw"Can't determine application root";return result=pathToPageTokens.join("/"),result},api={get:function(){return appRoot||(appRoot=getAppPath("javascript/tau/scripts"))},tp:{}},tp=api.tp;return tp.UrlParameterCollection=clazz.extend({query:null,_parameters:null,init:function(query){this.query=query;var a=[],b=this.query.split("&"),c="";if(b.length<1)return a;for(i=0;i<b.length;i++)c=b[i].split("="),c[0].length>0&&(a[i]=[c[0],c.length==1?c[0]:c[1]]);this._parameters=a},get:function(key){var parameter=this._findParameter(key);if(parameter)return parameter[1]},_findParameter:function(key){for(var i=0;i<this._parameters.length;i++)if(this._parameters[i][0]==key)return this._parameters[i]},set:function(key,value){var parameter=this._findParameter(key);if(parameter){parameter[1]=value;return}this._parameters.push([key,value])},remove:function(key){for(var i=0;i<this._parameters.length;i++)this._parameters[i][0]==key&&this._parameters.splice(i,1)}}),tp.UrlParameterCollection.prototype.toString=function(){if(this._parameters.length==0)return"";var query="?";for(var i=0;i<this._parameters.length;i++)i>0&&(query+="&"),query+=this._parameters[i][0]+"="+this._parameters[i][1];return query},tp.URL=clazz.extend({init:function(url){url.length==0&&eval('throw "Invalid URL ['+url+']"'),this.url=url,this.port=-1,this.query=this.url.indexOf("?")>=0?this.url.substring(this.url.indexOf("?")+1):"",this.query.indexOf("#")>=0&&(this.query=this.query.substring(0,this.query.indexOf("#"))),this.protocol="",this.host="",this.protocolSep="",this.portSep="";var protocolSepIndex=this.url.indexOf("://");if(protocolSepIndex>=0){this.protocolSep="://",this.protocol=this.url.substring(0,protocolSepIndex).toLowerCase(),this.host=this.url.substring(protocolSepIndex+3),this.host.indexOf("/")>=0&&(this.host=this.host.substring(0,this.host.indexOf("/")));var atIndex=this.host.indexOf("@");if(atIndex>=0){var credentials=this.host.substring(0,atIndex),colonIndex=credentials.indexOf(":");colonIndex>=0?(this.username=credentials.substring(0,colonIndex),this.password=credentials.substring(colonIndex)):this.username=credentials,this.host=this.host.substring(atIndex+1)}var portColonIndex=this.host.indexOf(":");portColonIndex>=0&&(this.portSep=":",this.port=this.host.substring(portColonIndex),this.host=this.host.substring(0,portColonIndex)),this.file=this.url.substring(protocolSepIndex+3),this.file=this.file.substring(this.file.indexOf("/"))}else this.file=this.url;this.file.indexOf("?")>=0&&(this.file=this.file.substring(0,this.file.indexOf("?")));var refSepIndex=url.indexOf("#");refSepIndex>=0?(this.file=this.file.substring(0,refSepIndex),this.reference=this.url.substring(this.url.indexOf("#"))):this.reference="",this.path=this.file,this.query.length>0&&(this.file+="?"+this.query),this.reference.length>0&&(this.file+="#"+this.reference),this._parameters=new tp.UrlParameterCollection(this.query)},getPort:function(){return this.port},getQuery:function(){return this._parameters.toString()},getProtocol:function(){return this.protocol},getHost:function(){return this.host},getUserName:function(){return this.username},getPassword:function(){return this.password},getFile:function(){return this.file},getReference:function(){return this.reference},getPath:function(){return this.path},getAcid:function(){return this.getArgumentValue("acid")},setAcid:function(value){this.setArgumentValue("acid",value)},setArgumentValue:function(key,value){this._parameters.set(key,value)},removeArgument:function(key){this._parameters.remove(key)},getArgumentValue:function(key){var parameter=this._parameters.get(key);return parameter!=null?parameter.replace(/\+/g," "):null}}),tp.URL.prototype.toString=function(){var segments=[this.getProtocol(),this.protocolSep,this.getHost(),this.getPort(),this.getPath(),this.getQuery()],_url="";return $.each(segments,function(){this&&this!=-1&&(_url+=this)}),_url},tp.AcidURL=tp.URL.extend({init:function(url){this._super(url)},toString:function(){var acid=(new tp.URL(document.location.href)).getAcid();return this.setAcid(acid),this._super()}}),tp.WebServiceURL=tp.AcidURL.extend({init:function(url){this._super(api.get()+url)}}),api})