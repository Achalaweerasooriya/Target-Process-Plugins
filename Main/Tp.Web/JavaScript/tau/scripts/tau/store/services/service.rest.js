define(["Underscore","jQuery","tau/core/class","tau/store/types","tau/store/services/service.arrayToJsonConverter","tau/store/header","tau/core/tau","libs/json2"],function(e,r,t,n,i,a,o){var s=t.extend({init:function(t){t=t||{},e.defaults(t,{api:r,types:n.getDictionary()}),this.config=t},removeFromList:function(e){var r=this,t=a.header.getFieldName(e.config.$set),n={url:r.getUrl(e)+"/"+t+"/"+e.config.$set[t].id,contentType:"application/json; charset=utf-8",type:"POST",processData:!1,dataType:"json",beforeSend:function(e){e.setRequestHeader("X-HTTP-Method-Override","DELETE")}},i=this.getErrorCallback(e);r.config.api.ajax(n).success(function(){e.callbacks.success({id:e.config.id})}).error(i)},remove:function(e){var r=this,t={Id:e.config.id},n={url:r.getUrl(e),contentType:"application/json; charset=utf-8",type:"POST",processData:!1,dataType:"json",data:JSON.stringify(t),beforeSend:function(e){e.setRequestHeader("X-HTTP-Method-Override","DELETE")}},i=this.getErrorCallback(e);r.config.api.ajax(n).success(function(){e.callbacks.success({id:e.config.id})}).error(i)},save:function(r){var t={$set:r.config.$set||{}};return"prioritizer"===r.type?(e.extend(t,{$include:this._formIncludes(r.config.fields)}),void this.executeCrudCommandViaPageService(r,t,"save")):void this.executeCrudCommand(r,t,"save")},getErrorCallback:function(e){var t=this.config.appPath;return function(n){if(401===n.status)return void(document.location.href=t+"/login.aspx?ReturnUrl="+document.location.href);try{n.response=r.parseJSON(n.responseText||null)}catch(i){}finally{e.callbacks.failure(n)}}},executeCrudCommandViaPageService:function(t,n,i){var o=this,s={id:t.config.id,type:t.type};e.extend(s,n);var c=JSON.stringify({json:JSON.stringify(s)}),u={url:[o.config.appPath,"PageServices/RESTCrud.asmx",i].join("/"),contentType:"application/json; charset=utf-8",type:"POST",data:c,dataType:"json"},d=this.getErrorCallback(t);o.config.api.ajax(u).success(function(n){var i={id:n.d.id};if(n.d.isError===!0)return void t.callbacks.failure({Message:n.d.errorMessage,CRUD:!0});
if(n.d.jsonToReturn&&n.d.jsonToReturn.length>0){var o=r.parseJSON(n.d.jsonToReturn);o=a.formatObject(o),e.extend(i,o.data)}t.callbacks.success(i)}).error(d)},executeCrudCommand:function(r,t){var n=this;e.defaults(r.config,{format:"json"});var i=t.$set,a={id:r.config.id};e.isArray(i)?a=i:e.extend(a,i);var o=n.getUrl(r,"resultInclude"),s=r.config.format,c=n._getFields(r),u=n._getApiConfig(o,s,"convert",c);e.extend(u,{url:o,contentType:"application/json; charset=utf-8",type:"POST",processData:!1,data:JSON.stringify(a),dataType:"json"}),n._executeApiCall(r,"json",u)},find:function(e){this.get(e)},refresh:function(e){this.get(e)},getCompleteCallback:function(e){var r=this;return function(t){if("implementationHistory"===e.type&&(t.id=e.config.hasOwnProperty("acid")?e.config.acid:e.config.hasOwnProperty("ids")?t.acid:e.config.id),"context"===e.type&&(t.id=e.config.hasOwnProperty("id")?e.config.id:t.acid),e.config.nested===!0){var n=r._getNestedObject(e),i=a.header.getFieldName(n),o={id:e.config.id};o[i]=t,t=o}e.callbacks.success(t)}},_getArrayConverter:function(e,r){var t=this;return function(n){var a=t.config.api.parseJSON(n);return i[e]({header:r},a)}},_getJsonConverter:function(){var e=this;return function(r){var t=e.config.api.parseJSON(r);return a.formatObject(t)}},_getApiConfig:function(e,r,t,n){var i=this;return{url:e,accepts:{array:"application/x-array"},dataType:r,converters:{"text array":i._getArrayConverter(t,n),"text json":i._getJsonConverter()}}},_getNextPageFields:function(e){var r=e.fields,t=o.getQueryValueFromUrl(e.url,"include");return t&&t.length>0&&(r=a.parseFieldsFromString(t)),r},_executeApiCall:function(r,t,n){var i=this,a=i.getErrorCallback(r),o=i.getCompleteCallback(r),s=null,c=[],u=function(){var e=0===c.length;return e&&o(s),e},d=function(e){for(var r=0,t=e.nextPages.length;t>r;r++){var n=e.nextPages[r];f(n)}},f=function(r){var n=i._getNextPageFields(r),o=i._getApiConfig(r.url,t,"convertArray",n);i.config.api.ajax(o).success(function(t){c=c.concat(t.nextPages||[]);
var n=r.holder;e.each(t.data,function(e){n.push(e)}),t.data.getNextPage&&(t.data.getNextPage().holder=r.holder),d(t);var i=e.indexOf(c,r);c.splice(i,1),u()}).error(a)},l=function(e){return s=e.data,"find"===r.name?void o(s):(c=c.concat(e.nextPages||[]),u(),void d(e))};i.config.api.ajax(n).success(l).error(a)},get:function(r){var t=this;e.defaults(r.config,{format:"array"});var n=r.config.nested!==!0&&r.config.id?"convert":"convertArray",i=t.getUrl(r),a=r.config.format,o=t._getFields(r),s=t._getApiConfig(i,a,n,o);t._executeApiCall(r,a,s)},turboGet:function(e){this.get(e)},_formIncludes:function(r){var t=[],n=this;return e.each(r,function(e){if(a.header.isSimple(e)){var r=e;return 0===e.indexOf("$ref")&&(r=e.replace("$ref:","")),void t.push(r)}var i=a.header.getFieldName(e);t.push(i+n._formIncludes(e[i]))}),["[",t.join(","),"]"].join("")},_getQueryOperators:function(){var r=function(r,t){var n=this,i=[];return e.isArray(t)||(t=[t]),e.each(t,function(e){i.push("("+r+" "+n.name+" "+JSON.stringify(e)+")")}),i},t=function(e){return["("+e+" "+this.name+")"]},n=function(r,t){var n=this,i=[];e.isArray(t)||(t=[t]);var a=[];return e(t).each(function(e){a.push(JSON.stringify(e))}),i.push("("+r+" "+n.name+" ("+a.join(",")+"))"),i};return{$in:{name:"in",render:n},$ne:{name:"ne",render:r},$gt:{name:"gt",render:r},$gte:{name:"gte",render:r},$lt:{name:"lt",render:r},$lte:{name:"lte",render:r},$contains:{name:"contains",render:r},$eq:{name:"eq",render:r},$isNull:{name:"is null",render:t},$isNotNull:{name:"is not null",render:t}}},_isQueryValueWithOperator:function(r,t){var n=e(r).keys();if(0===n.length)return!1;var i=t||this._getQueryOperators();return i.hasOwnProperty(n[0])},_formWhere:function(r,t){var n=[],i=this;t=t||"";var a=i._getQueryOperators();return e.each(e(r).keys(),function(o){var s=r[o],c=t+o;if(e.isString(s)||e.isNumber(s)||e.isDate(s)||e.isArray(s)||e.isBoolean(s)||e.isNull(s)){var u=null===s?"$isNull":"$eq";return void(n=n.concat(a[u].render(c,s)))}return i._isQueryValueWithOperator(s,a)?void e.each(e(s).keys(),function(e){n=n.concat(a[e].render(c,s[e]))
}):void n.push(i._formWhere(s,c+"."))}),n},_getWhere:function(r){var t=this._formWhere(r);return 0===t.length?"":"&where="+encodeURIComponent(e.flatten(t).join(" and "))},_getNestedObject:function(r){var t=null;return e.each(r.config.fields,function(e){a.header.isSimple(e)||(t=e)}),t},_getFields:function(e){if(e.config.nested!==!0)return e.config.fields;var r=this._getNestedObject(e),t=a.header.getFieldName(r);return r[t]},_getOrderBy:function(e){return e.config.$orderBy&&""!==e.config.$orderBy?"&orderBy="+e.config.$orderBy:""},_getOrderByDesc:function(e){return e.config.$orderByDesc&&""!==e.config.$orderByDesc?"&orderByDesc="+e.config.$orderByDesc:""},_encodeRestParams:function(t){return e.isObject(t)&&(t=e.map(t,function(r,t){return{name:t,value:e.isArray(r)?r.join(","):r}})),decodeURIComponent(r.param(t))},getUrl:function(r,t){var n=this,i={$skip:0,$limit:999,$query:{}},s=r.config;if(e.defaults(s,i),"context"===r.type){if(s.format="json",s.hasOwnProperty("acid"))return[n.config.path,"context.asmx","?acid="+s.acid].join("/");var c={};return c.ids=s.id||s.ids,c.ids||(c.projectIds=s.projectIds||s.projectId||"*",c.teamIds=s.teamIds||s.teamId||"*"),e.each(c,function(e,r){e||delete c[r]}),[n.config.path,"context.asmx?"+n._encodeRestParams(c)].join("/")}if("implementationHistory"===r.type)return s.format="json",[n.config.appPath,"TpReports/ImplementationHistory.ashx?id="+s.id+"&"+(new Date).valueOf()].join("/");var u=n.config.types[r.type]||{resource:r.type},d=s.fields,f=[n.config.path,u.resource+".asmx",s.id].join("/");if(s.nested===!0){var l=n._getNestedObject(r),g=a.header.getFieldName(l);d=l[g],f=[f,g].join("/")}if(r.name&&r.name.indexOf("remove")>=0)return f;e.isArray(s.$set)&&(f+="bulk");var p="find"===r.name||"turboGet"===r.name||!e.isEmpty(s.$query);return f=[f,"?skip=",s.$skip,"&take=",s.$limit,"&",t?t:"include","=",n._formIncludes(d),p?n._getWhere(s.$query):"",n._getOrderBy(r),n._getOrderByDesc(r),o.getTokenParameterFromQueryString("&")].join("")}});return s});
