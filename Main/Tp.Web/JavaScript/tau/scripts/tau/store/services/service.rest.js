define(["Underscore","jQuery","tau/core/Class","tau/store/types","tau/store/services/service.arrayToJsonConverter","tau/store/header","tau/core/tau","libs/json2"],function(_,$,a,b,c,d,e){var f=a.extend({init:function(a){a=a||{},_.defaults(a,{api:$,types:b.getDictionary()}),this.config=a},removeFromList:function(a){var b=this,c=d.header.getFieldName(a.config.$set),e={url:b.getUrl(a)+"/"+c+"/"+a.config.$set[c].id,contentType:"application/json; charset=utf-8",type:"DELETE",processData:!1,dataType:"json"},f=this.getErrorCallback(a);b.config.api.ajax(e).success(function(){a.callbacks.success({id:a.config.id})}).error(f)},remove:function(a){var b=this,c={Id:a.config.id},d={url:b.getUrl(a),contentType:"application/json; charset=utf-8",type:"DELETE",processData:!1,data:JSON.stringify(c),dataType:"json"},e=this.getErrorCallback(a);b.config.api.ajax(d).success(function(){a.callbacks.success({id:a.config.id})}).error(e)},save:function(a){var b={$set:a.config.$set||{}};if(a.type==="prioritizer"){_.extend(b,{$include:this._formIncludes(a.config.fields)}),this.executeCrudCommandViaPageService(a,b,"save");return}this.executeCrudCommand(a,b,"save")},getErrorCallback:function(a){var b=this.config.appPath,c=function(c){if(c.status===401){document.location.href=b+"/login.aspx?ReturnUrl="+document.location.href;return}try{c.response=$.parseJSON(c.responseText)}catch(d){}finally{a.callbacks.failure(c)}};return c},executeCrudCommandViaPageService:function(a,b,c){var e=this,f={id:a.config.id,type:a.type};_.extend(f,b);var g=JSON.stringify({json:JSON.stringify(f)}),h={url:[e.config.appPath,"PageServices/RESTCrud.asmx",c].join("/"),contentType:"application/json; charset=utf-8",type:"POST",data:g,dataType:"json"},i=this.getErrorCallback(a);e.config.api.ajax(h).success(function(b){var c={id:b.d.id};if(b.d.isError===!0){a.callbacks.failure({Message:b.d.errorMessage,CRUD:!0});return}if(b.d.jsonToReturn&&b.d.jsonToReturn.length>0){var e=$.parseJSON(b.d.jsonToReturn);e=d.formatObject(e),_.extend(c,e.data)}a.callbacks.success(c)}).error(i)},executeCrudCommand:function(a,b){var c=this;_.defaults(a.config,{format:"json"});var d={id:a.config.id};_.extend(d,b.$set);var e=c.getUrl(a,"resultInclude"),f=a.config.format,g=c._getFields(a),h=c._getApiConfig(e,f,"convert",g);_.extend(h,{url:e,contentType:"application/json; charset=utf-8",type:"POST",processData:!1,data:JSON.stringify(d),dataType:"json"}),c._executeApiCall(a,"json",h)},find:function(a){this.get(a)},refresh:function(a){this.get(a)},getCompleteCallback:function(a){var b=this,c=function(c){if(a.type==="context"||a.type==="implementationHistory")c.id=a.config.id;if(a.config.nested===!0){var e=b._getNestedObject(a),f=d.header.getFieldName(e),g={id:a.config.id};g[f]=c,c=g}a.callbacks.success(c)};return c},_getArrayConverter:function(a,b){var d=this;return function(e){var f=d.config.api.parseJSON(e);return c[a]({header:b},f)}},_getJsonConverter:function(){var a=this;return function(b){var c=a.config.api.parseJSON(b);return d.formatObject(c)}},_getApiConfig:function(a,b,c,d){var e=this;return{url:a,accepts:{array:"application/x-array"},dataType:b,converters:{"text array":e._getArrayConverter(c,d),"text json":e._getJsonConverter()}}},_getNextPageFields:function(a){var b=a.fields,c=e.getQueryValueFromUrl(a.url,"include");return c&&c.length>0&&(b=d.parseFieldsFromString(c)),b},_executeApiCall:function(a,b,c){var d=this,e=d.getErrorCallback(a),f=d.getCompleteCallback(a),g=null,h=[],i=function(){var a=h.length===0;return a&&f(g),a},j=function(a){for(var b=0,c=a.nextPages.length;b<c;b++){var d=a.nextPages[b];k(d)}},k=function(a){var c=d._getNextPageFields(a),f=d._getApiConfig(a.url,b,"convertArray",c);d.config.api.ajax(f).success(function(b){h=h.concat(b.nextPages||[]);var c=a.holder;_.each(b.data,function(a){c.push(a)}),b.data.getNextPage&&(b.data.getNextPage().holder=a.holder),j(b);var d=_.indexOf(h,a);h.splice(d,1),i()}).error(e)},l=function(b){g=b.data;if(a.name==="find"){f(g);return}h=h.concat(b.nextPages||[]),i(),j(b)};d.config.api.ajax(c).success(l).error(e)},get:function(a){var b=this;_.defaults(a.config,{format:"array"});var c=a.config.nested===!0||!a.config.id?"convertArray":"convert",d=b.getUrl(a),e=a.config.format,f=b._getFields(a),g=b._getApiConfig(d,e,c,f);b._executeApiCall(a,e,g)},_formIncludes:function(a){var b=[],c=this;return _.each(a,function(a){if(d.header.isSimple(a)){var e=a;a.indexOf("$ref")===0&&(e=a.replace("$ref:","")),b.push(e);return}var f=d.header.getFieldName(a);b.push(f+c._formIncludes(a[f]))}),["[",b.join(","),"]"].join("")},_getQueryOperators:function(){var a=function(a,b){var c=this,d=[];return _.isArray(b)||(b=[b]),_.each(b,function(b){d.push("("+a+" "+c.name+" "+JSON.stringify(b)+")")}),d},b=function(a){return["("+a+" "+this.name+")"]},c=function(a,b){var c=this,d=[];_.isArray(b)||(b=[b]);var e=[];return _(b).each(function(a){e.push(JSON.stringify(a))}),d.push("("+a+" "+c.name+" ("+e.join(",")+"))"),d};return{$in:{name:"in",render:c},$ne:{name:"ne",render:a},$gt:{name:"gt",render:a},$gte:{name:"gte",render:a},$lt:{name:"lt",render:a},$lte:{name:"lte",render:a},$contains:{name:"contains",render:a},$eq:{name:"eq",render:a},$isNull:{name:"is null",render:b},$isNotNull:{name:"is not null",render:b}}},_isQueryValueWithOperator:function(a,b){var c=_(a).keys();if(c.length===0)return!1;var d=b||this._getQueryOperators();return d.hasOwnProperty(c[0])},_formWhere:function(a,b){var c=[],d=this;b=b||"";var e=d._getQueryOperators();return _.each(_(a).keys(),function(f){var g=a[f],h=b+f;if(_.isString(g)||_.isNumber(g)||_.isDate(g)||_.isArray(g)||_.isBoolean(g)||_.isNull(g)){var i=g===null?"$isNull":"$eq";c=c.concat(e[i].render(h,g));return}if(d._isQueryValueWithOperator(g,e)){_.each(_(g).keys(),function(a){c=c.concat(e[a].render(h,g[a]))});return}c.push(d._formWhere(g,f+"."))}),c},_getWhere:function(a){var b=this._formWhere(a);return b.length===0?"":"&where="+encodeURIComponent(b.join(" and "))},_getNestedObject:function(a){var b=null;return _.each(a.config.fields,function(a){d.header.isSimple(a)||(b=a)}),b},_getFields:function(a){if(a.config.nested!==!0)return a.config.fields;var b=this._getNestedObject(a),c=d.header.getFieldName(b);return b[c]},_getOrderBy:function(a){return!a.config.$orderBy||a.config.$orderBy===""?"":"&orderBy="+a.config.$orderBy},_getOrderByDesc:function(a){return!a.config.$orderByDesc||a.config.$orderByDesc===""?"":"&orderByDesc="+a.config.$orderByDesc},getUrl:function(a,b){var c=this,e={$skip:0,$limit:999,$query:{}};_.defaults(a.config,e);if(a.type==="context")return a.config.format="json",[c.config.path,"context.asmx","?ids="+a.config.id].join("/");if(a.type==="implementationHistory")return a.config.format="json",[c.config.appPath,"Reports/ImplementationHistory.ashx?id="+a.config.id+"&"+(new Date).valueOf()].join("/");var f=c.config.types[a.type]||{resource:a.type},g=a.config.fields,h=[c.config.path,f.resource+".asmx",a.config.id].join("/");if(a.config.nested===!0){var i=c._getNestedObject(a),j=d.header.getFieldName(i);g=i[j],h=[h,j].join("/")}return a.name&&a.name.indexOf("remove")>=0?h:(h=[h,"?skip=",a.config.$skip,"&take=",a.config.$limit,"&",b?b:"include","=",c._formIncludes(g),a.name==="find"?c._getWhere(a.config.$query):"",c._getOrderBy(a),c._getOrderByDesc(a)].join(""),h)}});return f})