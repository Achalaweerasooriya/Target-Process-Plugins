define(["Underscore","jQuery","tau/core/Class","tau/store/types","tau/store/services/service.arrayToJsonConverter","tau/store/header","tau/core/tau","libs/json2"],function(_,$,Class,tauTypes,arrayToJsonConverter,tauHeader,utils){var serviceRest=Class.extend({init:function(config){config=config||{},_.defaults(config,{api:$,types:tauTypes.getDictionary()}),this.config=config},removeFromList:function(command){var self=this,fieldName=tauHeader.header.getFieldName(command.config.$set),config={url:self.getUrl(command)+"/"+fieldName+"/"+command.config.$set[fieldName].id,contentType:"application/json; charset=utf-8",type:"POST",processData:!1,dataType:"json",beforeSend:function(xhr){xhr.setRequestHeader("X-HTTP-Method-Override","DELETE")}},errorCallback=this.getErrorCallback(command);self.config.api.ajax(config).success(function(){command.callbacks.success({id:command.config.id})}).error(errorCallback)},remove:function(command){var self=this,serviceCommand={Id:command.config.id},config={url:self.getUrl(command),contentType:"application/json; charset=utf-8",type:"POST",processData:!1,data:JSON.stringify(serviceCommand),dataType:"json",beforeSend:function(xhr){xhr.setRequestHeader("X-HTTP-Method-Override","DELETE")}},errorCallback=this.getErrorCallback(command);self.config.api.ajax(config).success(function(){command.callbacks.success({id:command.config.id})}).error(errorCallback)},save:function(command){var ext={$set:command.config.$set||{}};if(command.type==="prioritizer"){_.extend(ext,{$include:this._formIncludes(command.config.fields)}),this.executeCrudCommandViaPageService(command,ext,"save");return}this.executeCrudCommand(command,ext,"save")},getErrorCallback:function(command){var path=this.config.appPath;return function(err){if(err.status===401){document.location.href=path+"/login.aspx?ReturnUrl="+document.location.href;return}try{err.response=$.parseJSON(err.responseText)}catch(e){}finally{command.callbacks.failure(err)}}},executeCrudCommandViaPageService:function(command,commandExt,operation){var self=this,serviceCommand={id:command.config.id,type:command.type};_.extend(serviceCommand,commandExt);var json=JSON.stringify({json:JSON.stringify(serviceCommand)}),config={url:[self.config.appPath,"PageServices/RESTCrud.asmx",operation].join("/"),contentType:"application/json; charset=utf-8",type:"POST",data:json,dataType:"json"},errorCallback=this.getErrorCallback(command);self.config.api.ajax(config).success(function(result){var r={id:result.d.id};if(result.d.isError===!0){command.callbacks.failure({Message:result.d.errorMessage,CRUD:!0});return}if(result.d.jsonToReturn&&result.d.jsonToReturn.length>0){var obj=$.parseJSON(result.d.jsonToReturn);obj=tauHeader.formatObject(obj),_.extend(r,obj.data)}command.callbacks.success(r)}).error(errorCallback)},executeCrudCommand:function(command,commandExt){var self=this;_.defaults(command.config,{format:"json"});var $set=commandExt.$set,serviceCommand={id:command.config.id};_.isArray($set)?serviceCommand=$set:_.extend(serviceCommand,$set);var url=self.getUrl(command,"resultInclude"),format=command.config.format,fields=self._getFields(command),config=self._getApiConfig(url,format,"convert",fields);_.extend(config,{url:url,contentType:"application/json; charset=utf-8",type:"POST",processData:!1,data:JSON.stringify(serviceCommand),dataType:"json"}),self._executeApiCall(command,"json",config)},find:function(command){this.get(command)},refresh:function(command){this.get(command)},getCompleteCallback:function(command){var self=this;return function(r){command.type==="implementationHistory"&&(command.config.hasOwnProperty("acid")?r.id=command.config.acid:command.config.hasOwnProperty("ids")?r.id=r.acid:r.id=command.config.id),command.type==="context"&&(command.config.hasOwnProperty("id")?r.id=command.config.id:r.id=r.acid);if(command.config.nested===!0){var nestedObject=self._getNestedObject(command),nestedResource=tauHeader.header.getFieldName(nestedObject),temp={id:command.config.id};temp[nestedResource]=r,r=temp}command.callbacks.success(r)}},_getArrayConverter:function(fnConvertName,fields){var self=this;return function(textValue){var jsonR=self.config.api.parseJSON(textValue);return arrayToJsonConverter[fnConvertName]({header:fields},jsonR)}},_getJsonConverter:function(){var self=this;return function(textValue){var jsonR=self.config.api.parseJSON(textValue);return tauHeader.formatObject(jsonR)}},_getApiConfig:function(url,format,fnConvertName,fields){var self=this;return{url:url,accepts:{array:"application/x-array"},dataType:format,converters:{"text array":self._getArrayConverter(fnConvertName,fields),"text json":self._getJsonConverter()}}},_getNextPageFields:function(nextPage){var fields=nextPage.fields,include=utils.getQueryValueFromUrl(nextPage.url,"include");return include&&include.length>0&&(fields=tauHeader.parseFieldsFromString(include)),fields},_executeApiCall:function(command,format,config){var self=this,errorCallback=self.getErrorCallback(command),completeCallback=self.getCompleteCallback(command),result=null,nextPages=[],fireIsCompletedIfRequired=function(){var isCompletedCalls=nextPages.length===0;return isCompletedCalls&&completeCallback(result),isCompletedCalls},askNextPages=function(r){for(var j=0,l=r.nextPages.length;j<l;j++){var nextPage=r.nextPages[j];processNextPage(nextPage)}},processNextPage=function(nextPage){var fields=self._getNextPageFields(nextPage),pageConfig=self._getApiConfig(nextPage.url,format,"convertArray",fields);self.config.api.ajax(pageConfig).success(function(r){nextPages=nextPages.concat(r.nextPages||[]);var holder=nextPage.holder;_.each(r.data,function(v){holder.push(v)}),r.data.getNextPage&&(r.data.getNextPage().holder=nextPage.holder),askNextPages(r);var index=_.indexOf(nextPages,nextPage);nextPages.splice(index,1),fireIsCompletedIfRequired()}).error(errorCallback)},processResponse=function(r){result=r.data;if(command.name==="find"){completeCallback(result);return}nextPages=nextPages.concat(r.nextPages||[]),fireIsCompletedIfRequired(),askNextPages(r)};self.config.api.ajax(config).success(processResponse).error(errorCallback)},get:function(command){var self=this;_.defaults(command.config,{format:"array"});var fnConvertName=command.config.nested===!0||!command.config.id?"convertArray":"convert",url=self.getUrl(command),format=command.config.format,fields=self._getFields(command),config=self._getApiConfig(url,format,fnConvertName,fields);self._executeApiCall(command,format,config)},turboGet:function(command){this.get(command)},_formIncludes:function(fields){var includes=[],self=this;return _.each(fields,function(field){if(tauHeader.header.isSimple(field)){var f=field;field.indexOf("$ref")===0&&(f=field.replace("$ref:","")),includes.push(f);return}var fieldName=tauHeader.header.getFieldName(field);includes.push(fieldName+self._formIncludes(field[fieldName]))}),["[",includes.join(","),"]"].join("")},_getQueryOperators:function(){var defaultRenderer=function(key,value){var self=this,outR=[];return _.isArray(value)||(value=[value]),_.each(value,function(v){outR.push("("+key+" "+self.name+" "+JSON.stringify(v)+")")}),outR},nullRenderer=function(key){return["("+key+" "+this.name+")"]},inRenderer=function(key,value){var self=this,outR=[];_.isArray(value)||(value=[value]);var res=[];return _(value).each(function(vr){res.push(JSON.stringify(vr))}),outR.push("("+key+" "+self.name+" ("+res.join(",")+"))"),outR};return{$in:{name:"in",render:inRenderer},$ne:{name:"ne",render:defaultRenderer},$gt:{name:"gt",render:defaultRenderer},$gte:{name:"gte",render:defaultRenderer},$lt:{name:"lt",render:defaultRenderer},$lte:{name:"lte",render:defaultRenderer},$contains:{name:"contains",render:defaultRenderer},$eq:{name:"eq",render:defaultRenderer},$isNull:{name:"is null",render:nullRenderer},$isNotNull:{name:"is not null",render:nullRenderer}}},_isQueryValueWithOperator:function(queryValue,operators){var keys=_(queryValue).keys();if(keys.length===0)return!1;var $operators=operators||this._getQueryOperators();return $operators.hasOwnProperty(keys[0])},_formWhere:function($query,prefix){var filters=[],self=this;prefix=prefix||"";var operators=self._getQueryOperators();return _.each(_($query).keys(),function(key){var value=$query[key],queryKey=prefix+key;if(_.isString(value)||_.isNumber(value)||_.isDate(value)||_.isArray(value)||_.isBoolean(value)||_.isNull(value)){var $operator=value===null?"$isNull":"$eq";filters=filters.concat(operators[$operator].render(queryKey,value));return}if(self._isQueryValueWithOperator(value,operators)){_.each(_(value).keys(),function(op){filters=filters.concat(operators[op].render(queryKey,value[op]))});return}filters.push(self._formWhere(value,queryKey+"."))}),filters},_getWhere:function($query){var filters=this._formWhere($query);return filters.length===0?"":"&where="+encodeURIComponent(_.flatten(filters).join(" and "))},_getNestedObject:function(command){var nestedObject=null;return _.each(command.config.fields,function(field){tauHeader.header.isSimple(field)||(nestedObject=field)}),nestedObject},_getFields:function(command){if(command.config.nested!==!0)return command.config.fields;var nestedObject=this._getNestedObject(command),nestedResource=tauHeader.header.getFieldName(nestedObject);return nestedObject[nestedResource]},_getOrderBy:function(command){return!command.config.$orderBy||command.config.$orderBy===""?"":"&orderBy="+command.config.$orderBy},_getOrderByDesc:function(command){return!command.config.$orderByDesc||command.config.$orderByDesc===""?"":"&orderByDesc="+command.config.$orderByDesc},_encodeRestParams:function(params){return _.isObject(params)&&(params=_.map(params,function(v,k){return{name:k,value:_.isArray(v)?v.join(","):v}})),decodeURIComponent($.param(params))},getUrl:function(command,includeParamName){var self=this,defaults={$skip:0,$limit:999,$query:{}},config=command.config;_.defaults(config,defaults);if(command.type==="context"){config.format="json";if(config.hasOwnProperty("acid"))return[self.config.path,"context.asmx","?acid="+config.acid].join("/");var params={};return params.ids=config.id||config.ids,params.ids||(params.projectIds=config.projectIds||config.projectId||"*",params.teamIds=config.teamIds||config.teamId||"*"),_.each(params,function(v,k){v||delete params[k]}),[self.config.path,"context.asmx?"+self._encodeRestParams(params)].join("/")}if(command.type==="implementationHistory")return config.format="json",[self.config.appPath,"TpReports/ImplementationHistory.ashx?id="+config.id+"&"+(new Date).valueOf()].join("/");var type=self.config.types[command.type]||{resource:command.type},fields=config.fields,url=[self.config.path,type.resource+".asmx",config.id].join("/");if(config.nested===!0){var nestedObject=self._getNestedObject(command),nestedResource=tauHeader.header.getFieldName(nestedObject);fields=nestedObject[nestedResource],url=[url,nestedResource].join("/")}if(command.name&&command.name.indexOf("remove")>=0)return url;_.isArray(config.$set)&&(url+="bulk");var needWhere=command.name==="find"||command.name==="turboGet"||!_.isEmpty(config.$query);return url=[url,"?skip=",config.$skip,"&take=",config.$limit,"&",includeParamName?includeParamName:"include","=",self._formIncludes(fields),needWhere?self._getWhere(config.$query):"",self._getOrderBy(command),self._getOrderByDesc(command),utils.getTokenParameterFromQueryString("&")].join(""),url}});return serviceRest})