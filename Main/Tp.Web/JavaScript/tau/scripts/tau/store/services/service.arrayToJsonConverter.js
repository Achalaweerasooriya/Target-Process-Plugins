define(["Underscore","tau/store/header","tau/store/services/formatProperties"],function(_,tau,properties){return{convertArray:function(config,array){var self=this,result=[],nextPages=[];return array.next&&nextPages.push(tau.getNextPage(result,array.next,config.header)),array=array.items?array.items:array,_.each(array,function(value){var v=self.convert(config,value);result.push(v.data),nextPages=nextPages.concat(v.nextPages)}),{data:result,nextPages:nextPages}},convert:function(config,array){var obj={},self=this,nextPages=[];for(var i=0,len=config.header.length;i<len;i++){var value=array[i];_.isUndefined(value)&&(value=null);var field=config.header[i];if(tau.header.isSimple(field)){properties.hasOwnProperty(field)&&(value=tau.formatObject(value).data),obj[field]=value;continue}var key=tau.header.getFieldName(field),isList=field.list===!0;!_.isNull(value)&&(value.hasOwnProperty("items")||value.hasOwnProperty("Items"))&&(isList=!0);if(_.isEmpty(value)&&!isList){obj[key]=null;continue}if(!_.isNull(value)){var refConfig={header:field[key]},originalValue=value;if(value.hasOwnProperty("items")||value.hasOwnProperty("Items"))value=value.items||value.Items;if(isList){var arr=[];_.each(value,function(a){var converted=self.convert(refConfig,a);nextPages=nextPages.concat(converted.nextPages),arr.push(converted.data)}),value=arr,originalValue.next&&nextPages.push(tau.getNextPage(arr,originalValue.next,refConfig.header))}else{var convertedV=self.convert(refConfig,value);nextPages=nextPages.concat(convertedV.nextPages),value=convertedV.data}}_.isNull(value)&&isList&&(value=[]),obj.hasOwnProperty(key)?_.extend(obj[key],value):obj[key]=value}return{data:obj,nextPages:nextPages}}}})