define(["Underscore","tau/core/class","tau/store/header","tau/core/comparer"],function(e,t,r,i){return t.extend({init:function(e){this.__data={},this.__types=e.types||{}},_getTypeHolder:function(e,t){var r=e[t]||{};return e.hasOwnProperty(t)||(e[t]=r),r},_getTypeDictionary:function(e){return this._getTypeHolder(this.__data,e)},getPersistedNode:function(e,t){var r=this.__data[t];if(!r)return null;if(!e)return r;var i=r[e];return i?i:null},_getRefsArray:function(t){return t&&t.refs?(t.hasOwnProperty("refsArray")||(t.refsArray=e(t.refs).keys()),t.refsArray):[]},_registerReference:function(t,r,n,a,s){var o=this,d=n.refs[r];if(e.isUndefined(t)||null===t||null===t.id)return d.list?[]:null;t.__type=d.name;var f=o.__types[d.name],u=o._register(t,function(t){if(f.refs){var r=d.relationProperty;if(r){var n=f.refs[r];if(n){var u=t.data.hasOwnProperty(r),_=n.list;if(!_||u){var p=t.data[r],c=o._getReferenceObject(a.id,a.__type),y=function(e){var r={};r[d.relationProperty]=e,s.diffs.push({id:t.id,type:o._getOriginType(t),changes:r})};_?e(p).any(function(e){return e.id===a.id})?c=p:(c=p.concat([c]),y(c)):i.isEqualIncluded(c,p)||y(c),t.data[r]=c}}}}});e.mergeArrayObjects(s,u,["diffs"]);var _={isReference:!0,type:d.name,list:!0};return d.list?e.extend(u.refs,_):u.refs[0]},_removeCascadeObjects:function(t,r){var i=this,n=i._getRegisterTemplate();return e.each(i._getRefsArray(t),function(a){var s=t.refs[a];s.cascade&&(s.list?e.each(r[a],function(e){i._extendRegister(n,i.remove(e.id,e.type))}):i._extendRegister(n,i.remove(r[a].id,r[a].type)))}),n},_getOriginType:function(e){return e.origin?e.origin.type:e.__type},_removeRefFromObj:function(t,r,i,n,a){var s=this,o=t.data;if(o.hasOwnProperty(r)){var d=o[r];if(d){var f=n.refs[r];if(f.relationProperty){var u=s.__types[f.name];e.isArray(d)||(d=[d]);for(var _=0,p=d.length;p>_;_++){var c=d[_];if(!a||a===c.id){var y=s.getPersistedNode(c.id,c.type);if(!y)return;if(!y.data.hasOwnProperty(f.relationProperty))return;i.nodes.push(y);var h={};h[f.relationProperty]=null,u.refs&&u.refs[f.relationProperty]&&u.refs[f.relationProperty].list?(y.data[f.relationProperty]=e(y.data[f.relationProperty]).select(function(e){return e.id!=t.id
}),h[f.relationProperty]=y.data[f.relationProperty]):y.data[f.relationProperty]=null,i.diffs.push({id:y.id,type:s._getOriginType(y),changes:h})}}}}}},_removeObjectFromRefs:function(t,r){var i=this,n=i._getRegisterTemplate();return e(i._getRefsArray(t)).each(function(e){i._removeRefFromObj(r,e,n,t)}),n},removeProperties:function(t,r,i){var n=this.getPersistedNode(t,r);if(n){var a=n.data;e.each(i,function(e){delete a[e]})}},removeFromList:function(t,i,n){var a=this._getRegisterTemplate(),s=this.getPersistedNode(t,i);if(!s)return a;var o=this.__types[i],d=r.header.getFieldName(n),f=s.data[d]||[];if(!f)return a;var u=[],_=n[d].id;e.each(f,function(e){e.id==_?this._removeRefFromObj(s,d,a,o,_):u.push({id:e.id})},this);var p={id:t,__type:i};p[d]=u;var c=this.register(p);return this._extendRegister(c,a),c},remove:function(t,r){var i=this._getRegisterTemplate(),n=this.getPersistedNode(t,r);if(!n)return i;var a=this.__types[r],s=n.data;return i.deletedData.push(e(s).defaults({id:t,type:r})),delete this.__data[r][t],this._extendRegister(i,this._removeCascadeObjects(a,s)),this._extendRegister(i,this._removeObjectFromRefs(a,n)),i},removeCollection:function(t){var r=this,i=r.__data[t];i&&e.forEach(e.keys(i),function(e){r.remove(e,t)})},isPropertyInitialized:function(e,t,r){var i=this.getPersistedNode(e,t);return i&&i.data?i.data.hasOwnProperty(r):!1},_getReferenceObject:function(e,t){return{isReference:!0,id:e,type:t}},_attachReference:function(e,t,r){var i=this._getReferenceObject(t,r);return e.push(i),i},_getParentTypeNames:function(e){if(!e.__parents){e.__parents=[];for(var t=e.parent;t;){e.__parents.push(t);var r=this.__types[t];if(!r)break;t=r.parent}}return e.__parents},_registerParentNodes:function(t,r,i){for(var n={data:i.data,id:r,origin:{id:r,type:t}},a=this.__types[t],s=this._getParentTypeNames(a),o=0;o<s.length;o++){var d=s[o],f=this._getTypeDictionary(d);f[r]=f[r]||{},e.extend(f[r],n)}},_getRegisterTemplate:function(){return{refs:[],nodes:[],diffs:[],tree:{},deletedData:[]}
},_registerObjectInTree:function(t,r){var i=this,n=i._getTypeHolder(t,r.type);if(!n.hasOwnProperty(r.id)){for(var a={},s=i.__types[r.type],o={id:r.id,changes:a},d=i._getParentTypeNames(s),f=0;f<d.length;f++){var u=i.__types[d[f]],_=i._getTypeHolder(t,u.name);_[r.id]=o}n[r.id]=o}e.extend(n[r.id].changes,r.changes)},_extendTree:function(t,r){var i=this;e.each(r,function(e){i._registerObjectInTree(t,e)})},_extendRegister:function(t,r){this._extendTree(t.tree,r.diffs),e.mergeArrayObjects(t,r,["diffs","deleteData"])},register:function(e,t,r){return this._register(e,t,r)},isTypeDetectionRequired:function(e){var t=this.__types[e];return t.isParentType},getTypeDetectionForNode:function(e,t){if(!this.isTypeDetectionRequired(t))return{required:!1};var r=this.getPersistedNode(e,t);return r&&r.origin&&r.origin.id&&r.origin.type?{required:!1,type:r.origin.type}:{required:!0}},_getTypeDefinitionForRegistration:function(e,t,r){var i=this.__types[t]||this.__types[t.toLowerCase()];if(i.isParentType){var n=this.getTypeDetectionForNode(e,i.name);t=n.required?i.detectType(r):n.type,i=this.__types[t]}return i},_register:function(t,r,i){i=i||"__type";var n=this._getRegisterTemplate();if(e.isEmpty(t))return n;var a=t[i];e.isArray(t)||(t=e.isArray(t.items)?t.items:[t]);for(var s=0,o=t.length;o>s;s++){var d=t[s];d.hasOwnProperty(i)||(d[i]=a),this._registerObject(d,n,r,i)}return n},__findItemByName:function(t,r){return e.find(t,function(e){return e.name===r})},_registerObject:function(t,r,n,a){var s=this,o=t[a],d=t.id;if(!d)throw new Error('Property "id" is required for data registration entity "'+o+'"');if(!o)throw new Error('Property "__type" is required for data registration entity "'+d+'"');var f=s._getTypeDefinitionForRegistration(d,o,t);if(!f)return void console.warn("Missing type definition for object",t);var u={id:d,type:f.name,changes:{}},_=s._getTypeDictionary(f.name),p=_[d];p||(_[d]=p={__type:f.name,data:{id:d},id:d},s._registerParentNodes(f.name,d,p,_));var c=p.data,y=f.refs,h=s._getRegisterTemplate();
for(var g in t)if("__type"!==g&&"id"!==g){var l=t[g],v=c[g];if(y.hasOwnProperty(g)&&(l=s._registerReference(l,g,f,p,h)),"customFields"===g){l=e.map(l,function(e){if("Entity"===e.type){if(e.value&&"None"===e.value.kind&&""===e.value.name){var t=s.__findItemByName(v,e.name);if(t)return t}}else"CheckBox"===e.type&&null==e.value&&(e.value=!1);return e});var m=e.filter(l,function(e){var t=s.__findItemByName(v,e.name);return t?!i.isEqualIncluded(e,t):!0});u.changes[g]=m}p.data[g]=l,"customFields"===g||i.isEqualIncluded(v,l)||(u.changes[g]=l)}s._extendRegister(r,h),p.data.hasOwnProperty("__type")&&delete p.data.__type,r.nodes.push(p),s._extendTree(r.tree,[u]),r.diffs.push(u),s._attachReference(r.refs,d,f.name),n&&n(p)},get:function(t,r,i){if(t)return this._get(t,r,i);var n={data:[],notInitializedFields:[],all:!0};return e.each(this._getTypeDictionary(r),function(e,t){var a=this._get(t,r,i);n.data.push(a.data),this.mergeFields(n.notInitializedFields,a.notInitializedFields)},this),n},_get:function(t,i,n){var a=this;n=n||{};var s=a.getPersistedNode(t,i),o=a.__types[i]||{},d=o.refs||{},f=n.$fields||n.fields||[],u={data:null,type:o,notInitializedFields:f};if(!s)return u;var _={},p=[],c=function(e,t,r){var i=a._get(e.id,e.type,{fields:t||[]});return i.notInitializedFields.length&&r.push(i.notInitializedFields),i.data},y=s.data;return e.each(f,function(t){var i=r.header.getFieldName(t),n=y[i];if(e.isUndefined(n))return void p.push(t);if(_[i]=n,d.hasOwnProperty(i)&&n){var s=[];if(e.isArray(n)){var o=n;n=[],e.each(o,function(e){n.push(c(e,t[i],s))})}else n=c(n,t[i],s);if(s.length>0){var f={};f[i]=[],e(s).each(function(e){a.mergeFields(f[i],e)}),f[i].length>0&&p.push(f)}}_[i]=n}),s.origin&&(i=s.origin.type),{type:o,data:e(_).defaults({id:t,__type:i}),notInitializedFields:p}},mergeFields:function(t,r,i){return e.mergeFields(t,r,i)},destroy:function(){delete this.__data,delete this.__types}})});