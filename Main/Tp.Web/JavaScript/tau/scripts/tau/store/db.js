define(["Underscore","tau/core/class","tau/store/header","tau/core/comparer"],function(e,t,r,i){return t.extend({init:function(e){this.__data={},this.__types=e.types||{}},_getTypeHolder:function(e,t){var r=e[t]||{};return e.hasOwnProperty(t)||(e[t]=r),r},_getTypeDictionary:function(e){return this._getTypeHolder(this.__data,e)},getPersistedNode:function(e,t){var r=this,i=r.__data[t];if(!i)return null;if(!e)return i;var n=i[e];return n?n:null},_getRefsArray:function(t){return t&&t.refs?(t.hasOwnProperty("refsArray")||(t.refsArray=e(t.refs).keys()),t.refsArray):[]},_registerReference:function(t,r,n,a,s){var o=this,d=n.refs[r];if(e.isUndefined(t)||null===t||null===t.id)return d.list?[]:null;t.__type=d.name;var f=o.__types[d.name],u=o._register(t,function(t){if(f.refs){var r=d.relationProperty;if(r){var n=f.refs[r];if(n){var u=t.data.hasOwnProperty(r),_=t.data[r],p=n.list,c=o._getReferenceObject(a.id,a.__type),y=function(e){var r={};r[d.relationProperty]=e,s.diffs.push({id:t.id,type:o._getOriginType(t),changes:r})};(!p||u)&&(p?e(_).any(function(e){return e.id===a.id})?c=_:(c=_.concat([c]),y(c)):i.isEqualIncluded(c,_)||y(c),t.data[r]=c)}}}});e.mergeArrayObjects(s,u,["diffs"]);var _={isReference:!0,type:d.name,list:!0};return d.list?e.extend(u.refs,_):u.refs[0]},_removeCascadeObjects:function(t,r){var i=this,n=i._getRegisterTemplate();return e.each(i._getRefsArray(t),function(a){var s=t.refs[a];s.cascade&&(s.list?e.each(r[a],function(e){i._extendRegister(n,i.remove(e.id,e.type))}):i._extendRegister(n,i.remove(r[a].id,r[a].type)))}),n},_getOriginType:function(e){var t=e.__type;return e.origin&&(t=e.origin.type),t},_removeRefFromObj:function(t,r,i,n,a){var s=this,o=t.data;if(o.hasOwnProperty(r)){var d=o[r];if(d){var f=n.refs[r];if(f.relationProperty){var u=s.__types[f.name];e.isArray(d)||(d=[d]);for(var _=0,p=d.length;p>_;_++){var c=d[_];if(!a||a===c.id){var y=s.getPersistedNode(c.id,c.type);if(!y)return;if(!y.data.hasOwnProperty(f.relationProperty))return;i.nodes.push(y);var g={};g[f.relationProperty]=null,u.refs&&u.refs[f.relationProperty]&&u.refs[f.relationProperty].list?(y.data[f.relationProperty]=e(y.data[f.relationProperty]).select(function(e){return e.id!=t.id}),g[f.relationProperty]=y.data[f.relationProperty]):y.data[f.relationProperty]=null,i.diffs.push({id:y.id,type:s._getOriginType(y),changes:g})}}}}}},_removeObjectFromRefs:function(t,r){var i=this,n=i._getRegisterTemplate();return e(i._getRefsArray(t)).each(function(e){i._removeRefFromObj(r,e,n,t)}),n},removeProperties:function(t,r,i){var n=this.getPersistedNode(t,r);if(n){var a=n.data;e.each(i,function(e){delete a[e]})}},removeFromList:function(t,i,n){var a=this._getRegisterTemplate(),s=this.getPersistedNode(t,i);if(!s)return a;var o=this.__types[i],d=r.header.getFieldName(n),f=s.data[d]||[];if(!f)return a;var u=[],_=n[d].id;e.each(f,function(e){e.id==_?this._removeRefFromObj(s,d,a,o,_):u.push({id:e.id})},this);var p={id:t,__type:i};p[d]=u;var c=this.register(p);return this._extendRegister(c,a),c},remove:function(t,r){var i=this,n=i._getRegisterTemplate(),a=i.getPersistedNode(t,r);if(!a)return n;var s=i.__types[r],o=a.data;return n.deletedData.push(e(o).defaults({id:t,type:r})),delete i.__data[r][t],i._extendRegister(n,i._removeCascadeObjects(s,o)),i._extendRegister(n,i._removeObjectFromRefs(s,a)),n},removeCollection:function(t){var r=this,i=r.__data[t];i&&e.forEach(e.keys(i),function(e){r.remove(e,t)})},isPropertyInitialized:function(e,t,r){var i=this.getPersistedNode(e,t);return i?i.data?i.data.hasOwnProperty(r):!1:!1},_getReferenceObject:function(e,t){return{isReference:!0,id:e,type:t}},_attachReference:function(e,t,r){var i=this._getReferenceObject(t,r);return e.push(i),i},_getParentTypeNames:function(e){var t=this;if(!e.__parents){e.__parents=[];for(var r=e.parent;r;){e.__parents.push(r);var i=t.__types[r];if(!i)break;r=i.parent}}return e.__parents},_registerParentNodes:function(t,r,i){for(var n=this,a=n.__types[t],s={data:i.data,id:r,origin:{id:r,type:t}},o=n._getParentTypeNames(a),d=0;d<o.length;d++){var f=o[d],u=n._getTypeDictionary(f);u[r]=u[r]||{},e.extend(u[r],s)}},_getRegisterTemplate:function(){return{refs:[],nodes:[],diffs:[],tree:{},deletedData:[]}},_registerObjectInTree:function(t,r){var i=this,n=i._getTypeHolder(t,r.type);if(!n.hasOwnProperty(r.id)){for(var a={},s=i.__types[r.type],o={id:r.id,changes:a},d=i._getParentTypeNames(s),f=0;f<d.length;f++){var u=i.__types[d[f]],_=i._getTypeHolder(t,u.name);_[r.id]=o}n[r.id]=o}e.extend(n[r.id].changes,r.changes)},_extendTree:function(t,r){var i=this;e.each(r,function(e){i._registerObjectInTree(t,e)})},_extendRegister:function(t,r){this._extendTree(t.tree,r.diffs),e.mergeArrayObjects(t,r,["diffs","deleteData"])},register:function(e,t,r){return this._register(e,t,r)},isTypeDetectionRequired:function(e){var t=this.__types[e];return t.isParentType},getTypeDetectionForNode:function(e,t){if(!this.isTypeDetectionRequired(t))return{required:!1};var r=this.getPersistedNode(e,t),i={required:!0};return r?r.origin?r.origin.id&&r.origin.type?{required:!1,type:r.origin.type}:i:i:i},_getTypeDefinitionForRegistration:function(e,t,r){var i=this,n=i.__types[t];if(n||(n=i.__types[t.toLowerCase()]),n.isParentType){var a=i.getTypeDetectionForNode(e,n.name);t=a.required?n.detectType(r):a.type,n=i.__types[t]}return n},_register:function(t,r,i){i=i||"__type";var n=this._getRegisterTemplate();if(e.isEmpty(t))return n;e.isArray(t)||(t=e.isArray(t.items)?t.items:[t]);for(var a=t[i],s=0,o=t.length;o>s;s++){var d=t[s];d.hasOwnProperty(i)||(d[i]=a),this._registerObject(d,n,r,i)}return n},_registerObject:function(t,r,n,a){var s=this,o=t[a],d=t.id;if(!d)throw new Error("property 'id' is required for data registration entity '"+o+"'");if(!o)throw new Error("property '__type' is required for data registration entity '"+d+"'");var f=s._getTypeDefinitionForRegistration(d,o,t),u={id:d,type:f.name,changes:{}},_=s._getTypeDictionary(f.name),p=_[d];p||(_[d]=p={__type:f.name,data:{id:d},id:d},s._registerParentNodes(f.name,d,p,_));var c=p.data,y=f.refs,g=s._getRegisterTemplate();for(var l in t)if("__type"!==l&&"id"!==l){var h=t[l],v=c[l];if(y.hasOwnProperty(l)&&(h=s._registerReference(h,l,f,p,g)),"customFields"===l){var m=function(t,r){return e.find(t,function(e){return e.name===r})};h=e.map(h,function(e){if("Entity"===e.type&&e.value&&"None"===e.value.kind&&""===e.value.name){var t=m(v,e.name);if(t)return t}return"CheckBox"===e.type&&null==e.value&&(e.value=!1),e});var P=e.filter(h,function(e){var t=m(v,e.name);return t?!i.isEqualIncluded(e,t):!0});u.changes[l]=P}p.data[l]=h,"customFields"===l||i.isEqualIncluded(v,h)||(u.changes[l]=h)}s._extendRegister(r,g),p.data.hasOwnProperty("__type")&&delete p.data.__type,r.nodes.push(p),s._extendTree(r.tree,[u]),r.diffs.push(u),s._attachReference(r.refs,d,f.name),n&&n(p)},get:function(t,r,i){var n=this;if(!t){var a={data:[],notInitializedFields:[],all:!0};return e.each(e(this._getTypeDictionary(r)).keys(),function(e){var t=n._get(e,r,i);a.data.push(t.data),n.mergeFields(a.notInitializedFields,t.notInitializedFields)}),a}return this._get(t,r,i)},_get:function(t,i,n){var a=this;n=n||{};var s=a.getPersistedNode(t,i),o=a.__types[i]||{},d=o.refs||{},f=n.$fields||n.fields||[],u={data:null,type:o,notInitializedFields:f};if(!s)return u;var _={},p=[],c=function(e,t,r){var i=a._get(e.id,e.type,{fields:t||[]});return i.notInitializedFields.length&&r.push(i.notInitializedFields),i.data},y=s.data;return e.each(f,function(t){var i=r.header.getFieldName(t),n=y[i];if(e.isUndefined(n))return void p.push(t);if(_[i]=n,d.hasOwnProperty(i)&&n){var s=[];if(e.isArray(n)){var o=n;n=[],e.each(o,function(e){n.push(c(e,t[i],s))})}else n=c(n,t[i],s);if(s.length>0){var f={};f[i]=[],e(s).each(function(e){a.mergeFields(f[i],e)}),f[i].length>0&&p.push(f)}}_[i]=n}),s.origin&&(i=s.origin.type),{type:o,data:e(_).defaults({id:t,__type:i}),notInitializedFields:p}},mergeFields:function(t,r,i){return e.mergeFields(t,r,i)},destroy:function(){delete this.__data,delete this.__types}})});