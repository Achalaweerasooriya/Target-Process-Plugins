define(["Underscore","tau/core/class","tau/store/header","tau/core/comparer"],function(_,a,b,c){return a.extend({init:function(a){this.__data={},this.__types=a.types||{}},_getTypeHolder:function(a,b){var c=a[b]||{};return a.hasOwnProperty(b)||(a[b]=c),c},_getTypeDictionary:function(a){return this._getTypeHolder(this.__data,a)},getPersistedNode:function(a,b){var c=this,d=c.__data[b];if(!d)return null;if(!a)return d;var e=d[a];return e?e:null},_getRefsArray:function(a){return!a||!a.refs?[]:(a.hasOwnProperty("refsArray")||(a.refsArray=_(a.refs).keys()),a.refsArray)},_registerReference:function(a,b,d,e,f){var g=this,h=d.refs[b];if(_.isUndefined(a)||a===null||a.id===null)return h.list?[]:null;a.__type=h.name;var i=g.__types[h.name],j=g._register(a,function(a){if(!i.refs)return;var b=h.relationProperty;if(!b)return;var d=i.refs[b];if(!d)return;var j=a.data.hasOwnProperty(b),k=a.data[b],l=d.list,m=g._getReferenceObject(e.id,e.__type),n=function(b){var c={};c[h.relationProperty]=b,f.diffs.push({id:a.id,type:g._getOriginType(a),changes:c})};if(l&&!j)return;l?_(k).any(function(a){return a.id===e.id})?m=k:(m=k.concat([m]),n(m)):c.isEqualIncluded(m,k)||n(m),a.data[b]=m});_.mergeArrayObjects(f,j,["diffs"]);var k={isReference:!0,type:h.name,list:!0};return h.list?_.extend(j.refs,k):j.refs[0]},_removeCascadeObjects:function(a,b){var c=this,d=c._getRegisterTemplate();return _.each(c._getRefsArray(a),function(e){var f=a.refs[e];f.cascade&&(f.list?_.each(b[e],function(a){c._extendRegister(d,c.remove(a.id,a.type))}):c._extendRegister(d,c.remove(b[e].id,b[e].type)))}),d},_getOriginType:function(a){var b=a.__type;return a.origin&&(b=a.origin.type),b},_removeRefFromObj:function(a,b,c,d,e){var f=this,g=a.data;if(!g.hasOwnProperty(b))return;var h=g[b];if(!h)return;var i=d.refs[b];if(!i.relationProperty)return;var j=f.__types[i.name];_.isArray(h)||(h=[h]);for(var k=0,l=h.length;k<l;k++){var m=h[k];if(e&&e!==m.id)continue;var n=f.getPersistedNode(m.id,m.type);if(!n)return;if(!n.data.hasOwnProperty(i.relationProperty))return;c.nodes.push(n);var o={};o[i.relationProperty]=null,j.refs&&j.refs[i.relationProperty]&&j.refs[i.relationProperty].list?(n.data[i.relationProperty]=_(n.data[i.relationProperty]).select(function(b){return b.id!=a.id}),o[i.relationProperty]=n.data[i.relationProperty]):n.data[i.relationProperty]=null,c.diffs.push({id:n.id,type:f._getOriginType(n),changes:o})}},_removeObjectFromRefs:function(a,b){var c=this,d=c._getRegisterTemplate();return _(c._getRefsArray(a)).each(function(e){c._removeRefFromObj(b,e,d,a)}),d},removeProperties:function(a,b,c){var d=this,e=d.getPersistedNode(a,b);if(!e)return;var f=e.data;_(c).each(function(a){delete f[a]})},removeFromList:function(a,c,d){var e=this,f=e._getRegisterTemplate(),g=e.getPersistedNode(a,c);if(!g)return f;var h=e.__types[c],i=b.header.getFieldName(d),j=g.data[i];if(!j)return f;var k=[],l=d[i].id;_.each(j,function(a){a.id!=l?k.push({id:a.id}):e._removeRefFromObj(g,i,f,h,l)});var m={id:a,__type:c};m[i]=k;var n=e.register(m);return e._extendRegister(n,f),n},remove:function(a,b){var c=this,d=c._getRegisterTemplate(),e=c.getPersistedNode(a,b);if(!e)return d;var f=c.__types[b],g=e.data;return d.deletedData.push(_(g).defaults({id:a,type:b})),delete c.__data[b][a],c._extendRegister(d,c._removeCascadeObjects(f,g)),c._extendRegister(d,c._removeObjectFromRefs(f,e)),d},isPropertyInitialized:function(a,b,c){var d=this.getPersistedNode(a,b);return d?d.data?d.data.hasOwnProperty(c):!1:!1},_getReferenceObject:function(a,b){return{isReference:!0,id:a,type:b}},_attachReference:function(a,b,c){var d=this._getReferenceObject(b,c);return a.push(d),d},_getParentTypeNames:function(a){var b=this;if(!a.__parents){a.__parents=[];var c=a.parent;while(c){a.__parents.push(c);var d=b.__types[c];if(!d)break;c=d.parent}}return a.__parents},_registerParentNodes:function(a,b,c){var d=this,e=d.__types[a],f={data:c.data,id:b,origin:{id:b,type:a}},g=d._getParentTypeNames(e);for(var h=0;h<g.length;h++){var i=g[h],j=d._getTypeDictionary(i);j[b]=j[b]||{},_.extend(j[b],f)}},_getRegisterTemplate:function(){return{refs:[],nodes:[],diffs:[],tree:{},deletedData:[]}},_registerObjectInTree:function(a,b){var c=this,d=c._getTypeHolder(a,b.type);if(!d.hasOwnProperty(b.id)){var e={},f=c.__types[b.type],g={id:b.id,changes:e},h=c._getParentTypeNames(f);for(var i=0;i<h.length;i++){var j=c.__types[h[i]],k=c._getTypeHolder(a,j.name);k[b.id]=g}d[b.id]=g}_.extend(d[b.id].changes,b.changes)},_extendTree:function(a,b){var c=this;_.each(b,function(b){c._registerObjectInTree(a,b)})},_extendRegister:function(a,b){this._extendTree(a.tree,b.diffs),_.mergeArrayObjects(a,b,["diffs","deleteData"])},register:function(a,b){return this._register(a,b)},isTypeDetectionRequired:function(a){var b=this.__types[a];return b.isParentType},getTypeDetectionForNode:function(a,b){if(!this.isTypeDetectionRequired(b))return{required:!1};var c=this.getPersistedNode(a,b),d={required:!0};return c?c.origin?!c.origin.id||!c.origin.type?d:{required:!1,type:c.origin.type}:d:d},_getTypeDefinitionForRegistration:function(a,b,c){var d=this,e=d.__types[b];if(e.isParentType){var f=d.getTypeDetectionForNode(a,e.name);b=f.required?e.detectType(c):f.type,e=d.__types[b]}return e},_register:function(a,b){var c=this,d=c._getRegisterTemplate();if(_.isEmpty(a))return d;_.isArray(a)||(a=_.isArray(a.items)?a.items:[a]);var e=a.__type;for(var f=0,g=a.length;f<g;f++){var h=a[f];h.__type||(h.__type=e),c._registerObject(h,d,b)}return d},_registerObject:function(a,b,d){var e=this,f=a.__type,g=a.id;if(!f||!g)throw new Error("properties __type and id are required for data registration");var h=e._getTypeDefinitionForRegistration(g,f,a),i={id:g,type:h.name,changes:{}},j=e._getTypeDictionary(h.name),k=j[g];k||(j[g]=k={__type:h.name,data:{id:g},id:g},e._registerParentNodes(h.name,g,k,j));var l=k.data,m=h.refs,n=e._getRegisterTemplate();for(var o in a){if(o==="__type"||o==="id")continue;var p=a[o],q=l[o];m.hasOwnProperty(o)&&(p=e._registerReference(p,o,h,k,n)),k.data[o]=p,c.isEqualIncluded(q,p)||(i.changes[o]=p)}e._extendRegister(b,n),k.data.hasOwnProperty("__type")&&delete k.data.__type,b.nodes.push(k),e._extendTree(b.tree,[i]),b.diffs.push(i),e._attachReference(b.refs,g,h.name),d&&d(k)},get:function(a,b,c){var d=this;if(!a){var e={data:[],notInitializedFields:[],all:!0};return _.each(_(this._getTypeDictionary(b)).keys(),function(a){var f=d._get(a,b,c);e.data.push(f.data),d.mergeFields(e.notInitializedFields,f.notInitializedFields)}),e}return this._get(a,b,c)},_get:function(a,c,d){var e=this;d=d||{};var f=e.getPersistedNode(a,c),g=e.__types[c]||{},h=g.refs||{},i=d.$fields||d.fields||[],j={data:null,type:g,notInitializedFields:i};if(!f)return j;var k={},l=[],m=function(a,b,c){var d=e._get(a.id,a.type,{fields:b||[]});return d.notInitializedFields.length&&c.push(d.notInitializedFields),d.data},n=f.data;return _.each(i,function(a){var c=b.header.getFieldName(a),d=n[c];if(_.isUndefined(d)){l.push(a);return}k[c]=d;if(h.hasOwnProperty(c)&&d){var f=[];if(_.isArray(d)){var g=d;d=[],_.each(g,function(b){d.push(m(b,a[c],f))})}else d=m(d,a[c],f);if(f.length>0){var i={};i[c]=[],_(f).each(function(a){e.mergeFields(i[c],a)}),i[c].length>0&&l.push(i)}}k[c]=d}),f.origin&&(c=f.origin.type),{type:g,data:_(k).defaults({id:a,__type:c}),notInitializedFields:l}},mergeFields:function(a,b,c){return _.mergeFields(a,b,c)},destroy:function(){delete this.__data,delete this.__types}})})