define(["Underscore","tau/core/class","tau/core/header","tau/core/comparer"],function(a,b,c,d){return b.extend({init:function(a){this.__data={},this.__types=a.types||{}},_getTypeHolder:function(a,b){var c=a[b]||{};return a.hasOwnProperty(b)||(a[b]=c),c},_getTypeDictionary:function(a){return this._getTypeHolder(this.__data,a)},getPersistedNode:function(a,b){var c=this,d=c.__data[b];if(!d)return null;if(!a)return d;var e=d[a];return e?e:null},isDataRegistered:function(a,b){return(this.__data[b]||{}).hasOwnProperty(a)},_registerReferenceInNode:function(a,b,c,d,e){var f={isReference:!0,id:a,type:b.name};f.property=e,f.list=d.list,c.refs[f.type+"_"+f.id+"_"+f.property]=f},_getRefsArray:function(b){return!b||!b.refs?[]:(b.hasOwnProperty("refsArray")||(b.refsArray=a(b.refs).keys()),b.refsArray)},_registerReference:function(b,c,e,f,g){var h=this,i=e.refs[c];if(b===null||b.id===null)return i.list?[]:null;b.__type=i.name;var j=h.__types[i.name],k=h._register(b,function(b){if(!j.refs)return;var c=i.relationProperty;if(!c)return;var e=j.refs[c];if(!e)return;var k=b.data.hasOwnProperty(c),l=b.data[c],m=e.list,n=h._getReferenceObject(f.id,f.__type),o=function(a){var c={};c[i.relationProperty]=a,g.diffs.push({id:b.id,type:h._getOriginType(b),changes:c})};if(m&&!k)return;m?a(l).any(function(a){return a.id===f.id})?n=l:(n=l.concat([n]),o(n)):d.isEqualIncluded(n,l)||o(n),b.data[c]=n});a.mergeArrayObjects(g,k,["diffs"]);var l={isReference:!0,type:i.name,list:!0};return i.list?a.extend(k.refs,l):k.refs[0]},_removeCascadeObjects:function(b,c){var d=this,e=d._getRegisterTemplate();return a.each(d._getRefsArray(b),function(f){var g=b.refs[f];g.cascade&&(g.list?a.each(c[f],function(a){d._extendRegister(e,d.remove(a.id,a.type))}):d._extendRegister(e,d.remove(c[f].id,c[f].type)))}),e},_getOriginType:function(a){var b=a.__type;return a.origin&&(b=a.origin.type),b},_removeObjectFromRefs:function(b,c){var d=this,e=d._getRegisterTemplate(),f=c.data;return a(d._getRefsArray(b)).each(function(g){if(!f.hasOwnProperty(g))return;var h=f[g];if(!h)return;var i=b.refs[g];if(!i.relationProperty)return;var j=d.__types[i.name];a.isArray(h)||(h=[h]);for(var k=0,l=h.length;k<l;k++){var m=h[k],n=d.getPersistedNode(m.id,m.type);if(!n)return;if(!n.data.hasOwnProperty(i.relationProperty))return;e.nodes.push(n);var o={};o[i.relationProperty]=null,j.refs&&j.refs[i.relationProperty]&&j.refs[i.relationProperty].list?(n.data[i.relationProperty]=a(n.data[i.relationProperty]).select(function(a){return a.id!=c.id}),o[i.relationProperty]=n.data[i.relationProperty]):n.data[i.relationProperty]=null,e.diffs.push({id:n.id,type:d._getOriginType(n),changes:o})}}),e},removeProperties:function(b,c,d){var e=this,f=e.getPersistedNode(b,c);if(!f)return;var g=f.data;a(d).each(function(a){delete g[a]})},remove:function(b,c){var d=this,e=d._getRegisterTemplate(),f=d.getPersistedNode(b,c);if(!f)return e;var g=d.__types[c],h=f.data;return e.deletedData.push(a(h).defaults({id:b,type:c})),delete d.__data[c][b],d._extendRegister(e,d._removeCascadeObjects(g,h)),d._extendRegister(e,d._removeObjectFromRefs(g,f)),e},isPropertyInitialized:function(a,b,c){var d=this.getPersistedNode(a,b);return d?d.data.hasOwnProperty(c):!1},_getReferenceObject:function(a,b){var c={isReference:!0,id:a,type:b};return c},_attachReference:function(a,b,c){var d=this._getReferenceObject(b,c);return a.push(d),d},_getParentTypeNames:function(a){var b=this;if(!a.__parents){a.__parents=[];var c=a.parent;while(c){a.__parents.push(c);var d=b.__types[c];if(!d)break;c=d.parent}}return a.__parents},_registerParentNodes:function(b,c,d){var e=this,f=e.__types[b],g={data:d.data,id:c,origin:{id:c,type:b}},h=e._getParentTypeNames(f);for(var i=0;i<h.length;i++){var j=h[i],k=e._getTypeDictionary(j);k[c]=k[c]||{},a.extend(k[c],g)}},_getRegisterTemplate:function(){return{refs:[],nodes:[],diffs:[],tree:{},deletedData:[]}},_registerObjectInTree:function(b,c){var d=this,e=d._getTypeHolder(b,c.type);if(!e.hasOwnProperty(c.id)){var f={},g=d.__types[c.type],h={id:c.id,changes:f},i=d._getParentTypeNames(g);for(var j=0;j<i.length;j++){var k=d.__types[i[j]],l=d._getTypeHolder(b,k.name);l[c.id]=h}e[c.id]=h}a.extend(e[c.id].changes,c.changes)},_extendTree:function(b,c){var d=this;a.each(c,function(a){d._registerObjectInTree(b,a)})},_extendRegister:function(b,c){this._extendTree(b.tree,c.diffs),a.mergeArrayObjects(b,c,["diffs","deleteData"])},register:function(a,b){return this._register(a,b)},isTypeDetectionRequired:function(a){var b=this.__types[a];return b.isParentType},getTypeDetectionForNode:function(a,b){if(!this.isTypeDetectionRequired(b))return{required:!1};var c=this.getPersistedNode(a,b),d={required:!0};return c?c.origin?!c.origin.id||!c.origin.type?d:{required:!1,type:c.origin.type}:d:d},_getTypeDefinitionForRegistration:function(a,b,c){var d=this,e=d.__types[b];if(e.isParentType){var f=d.getTypeDetectionForNode(a,e.name);b=f.required?e.detectType(c):f.type,e=d.__types[b]}return e},_register:function(b,c){var d=this,e=d._getRegisterTemplate();if(a.isEmpty(b))return e;a.isArray(b)||(b=a.isArray(b.items)?b.items:[b]);var f=b.__type;for(var g=0,h=b.length;g<h;g++){var i=b[g];i.__type||(i.__type=f),d._registerObject(i,e,c)}return e},_registerObject:function(a,b,c){var e=this,f=a.__type,g=a.id;if(!f||!g)throw"properties __type and id are required for data registration";var h=e._getTypeDefinitionForRegistration(g,f,a),i={id:g,type:h.name,changes:{}},j=e._getTypeDictionary(h.name),k=j[g];k||(j[g]=k={__type:h.name,data:{id:g},id:g},e._registerParentNodes(h.name,g,k,j));var l=k.data,m=h.refs,n=e._getRegisterTemplate();for(var o in a){if(o==="__type"||o==="id")continue;var p=a[o],q=l[o];m.hasOwnProperty(o)&&(p=e._registerReference(p,o,h,k,n)),k.data[o]=p,d.isEqualIncluded(q,p)||(i.changes[o]=p)}e._extendRegister(b,n),k.data.hasOwnProperty("__type")&&delete k.data.__type,b.nodes.push(k),e._extendTree(b.tree,[i]),b.diffs.push(i),e._attachReference(b.refs,g,h.name),c&&c(k)},get:function(b,c,d){var e=this;if(!b){var f={data:[],notInitializedFields:[],all:!0};return a.each(a(this._getTypeDictionary(c)).keys(),function(a){var b=e._get(a,c,d);f.data.push(b.data),e.mergeFields(f.notInitializedFields,b.notInitializedFields)}),f}return this._get(b,c,d)},_get:function(b,d,e){var f=this;e=e||{};var g=f.getPersistedNode(b,d),h=f.__types[d]||{},i=h.refs||{},j=e.$fields||e.fields||[],k={data:null,type:h,notInitializedFields:j};if(!g)return k;var l={},m=[],n=function(a,b,c){var d=f._get(a.id,a.type,{fields:b||[]});return d.notInitializedFields.length&&c.push(d.notInitializedFields),d.data},o=g.data;return a.each(j,function(b){var d=c.header.getFieldName(b),e=o[d];if(a.isUndefined(e)){m.push(b);return}l[d]=e;if(i.hasOwnProperty(d)&&e){var g=[];if(a.isArray(e)){var h=e;e=[],a.each(h,function(a){e.push(n(a,b[d],g))})}else e=n(e,b[d],g);if(g.length>0){var j={};j[d]=[],a(g).each(function(a){f.mergeFields(j[d],a)}),j[d].length>0&&m.push(j)}}l[d]=e}),g.origin&&(d=g.origin.type),{type:h,data:a(l).defaults({id:b,__type:d}),notInitializedFields:m}},mergeFields:function(b,c,d){return a.mergeFields(b,c,d)},destroy:function(){delete this.__data,delete this.__types}})})