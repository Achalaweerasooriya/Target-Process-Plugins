define(["Underscore","tau/core/class","tau/core/tau","tau/store/types","tau/store/typesClass","tau/core/bus","tau/core/global.bus"],function(_,Class,tauUtils,tauTypes,TypesClass,Bus,globalBus){var storeBus=new Bus({"queue.bus":!0,name:"store",globalBus:globalBus.get()}),apiStore={_processCommand:function(commandName,type,config,callbacks){callbacks=callbacks||{};var typeEntity=this.types[type];typeEntity&&(type=typeEntity.name);var command={type:type,name:commandName,config:config,callbacks:callbacks};return this.commands.push(command),this}},unfreeze=function(){var self=this;if(_.isEmpty(self._frozenPromises)){var commands=[].concat(self._frozenCommandsQueue);self._frozenCommandsQueue=[],self.config.proxy.execute(commands)}};return Class.extend({init:function(config){var self=this;self.id=_.uniqueId("store_"),self._frozenCommandsQueue=[],self._frozenPromises={},self.config=config,self.eventEmitter=self.config.eventEmitter||{fire:function(){},on:function(){},removeAllListeners:function(){}};var storeTypes=config.types||config.proxy.types;if(storeTypes){var types=new TypesClass;_(storeTypes).each(function(type){types.register(type)}),apiStore.types=types.getDictionary()}else apiStore.types=tauTypes.getDictionary();var functions=_.functionsExt(config.proxy);_.each(functions,function(fn){var parts=fn.split("api ");if(parts.length!==2)return;var publicName=parts[1];apiStore[publicName]=function(){var args=tauUtils.extendArgs(arguments,publicName);return this._processCommand.apply(this,args)}}),self._extendWithCommonAPI(self,self)},typeMetaInfo:function(type){return apiStore.types[type]},_extendWithCommonAPI:function(obj,store){_.each(_.functionsExt(apiStore),function(fn){if(fn[0]=="_")return;obj[fn]=function(){var api=_.extend({},apiStore);return api.commands=obj.commands||[],api[fn].apply(api,arguments),api.done=function(callbacks){store._done(api.commands,callbacks)},api}})},freeze:function(){var self=this,promiseId=_.uniqueId(),promise={id:promiseId,unfreeze:function(){this.unfreeze=tauUtils.empty,delete self._frozenPromises[promiseId],unfreeze.call(self)}};return self._frozenPromises[promise.id]=promise,promise},register:function(data,typeProperty){this.config.proxy.registerData(data,typeProperty)},registerWithEvents:function(data,typeProperty){var id=data.id,type=data.__type;data.hasOwnProperty("assignable")&&this.evictProperties(id,type,["$ref:assignable[id]"]);var repository=this.config.proxy,r=repository.registerData(data,typeProperty);repository._notifyAboutNewsAndChanges(r,null)},removeWithEvents:function(data,typeProperty){data.type=_.toCamelCase(typeProperty);var repository=this.config.proxy;this.evictPersistedObject(data.id,data.type),repository._populateAfterRemoveEvent(null,{tree:[],deletedData:[data]})},on:function(config,callback){return this.config.proxy.on(config,callback),this.eventEmitter.fire("afterStoreOn",config),this},unbind:function(listener){return this.config.proxy.unbind(listener),this.eventEmitter.fire("afterStoreUnbind",listener),this},_processChain:function(commands,callbacks){callbacks=tauUtils.getCallbacks(callbacks);var commonResult=[].concat(commands);_.each(commands,function(cmd){var cmdCallbacks=tauUtils.getCallbacks(cmd.callbacks),universalCallback=function(r,name){commonResult[_.indexOf(commonResult,cmd)]=r;var notExecuted=_.select(commands,function(command){return command.executed!==!0});cmdCallbacks[name](r);if(notExecuted.length===0){var countOfFailed=_.select(commands,function(command){return command.failed===!0});callbacks[countOfFailed.length>0?"failure":"success"](commonResult)}};cmd.callbacks={success:function(r){storeBus.fire("store.command.executed",r),universalCallback(r,"success")},failure:function(r){storeBus.fire("store.command.failed",r),universalCallback(r,"failure")}}})},done:function(callbacks){tauUtils.getCallbacks(callbacks).success([])},evictProperties:function(id,type,arrayOfPropertyNames){this.config.proxy.evictProperties(id,type,arrayOfPropertyNames)},evictData:function(){this.config.proxy.evictData()},evictPersistedObject:function(id,type){this.config.proxy.evictPersistedObject(id,type)},evictCollection:function(name){this.config.proxy.evictCollection(name)},isPropertyInitialized:function(id,type,propertyName){return this.config.proxy.isPropertyInitialized(id,type,propertyName)},_done:function(commands,callbacks){var self=this;self._processChain(commands,callbacks),_.isEmpty(self._frozenPromises)?self.config.proxy.execute(commands):self._frozenCommandsQueue=[].concat(self._frozenCommandsQueue,commands)}})})