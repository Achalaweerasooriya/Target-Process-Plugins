define(["Underscore","tau/core/class","tau/core/tau","tau/core/types","tau/core/typesClass","tau/extensions/extension.underscore"],function(a,b,c,d,e){var f={_processCommand:function(a,b,c,d){d=d||{};var e=this.types[b];e&&(b=e.name);var f={type:b,name:a,config:c,callbacks:d};this.commands.push(f);return this}},g=function(){var b=this;if(a.isEmpty(b._frozenPromises)){var c=[].concat(b._frozenCommandsQueue);b._frozenCommandsQueue=[],b.config.proxy.execute(c)}};return b.extend({init:function(b){var g=this;g.id=a.uniqueId("store_"),g._frozenCommandsQueue=[],g._frozenPromises={},g.config=b;var h=b.types||b.proxy.types;if(h){var i=new e;a(h).each(function(a){i.register(a)}),f.types=i.getDictionary()}else f.types=d.getDictionary();var j=a.functionsExt(b.proxy);a.each(j,function(a){var b=a.split("api ");if(b.length===2){var d=b[1];f[d]=function(){var a=c.extendArgs(arguments,d);return this._processCommand.apply(this,a)}}}),g._extendWithCommonAPI(g,g)},_extendWithCommonAPI:function(b,c){a.each(a.functionsExt(f),function(d){d[0]!="_"&&(b[d]=function(){var e=a.extend({},f);e.commands=b.commands||[],e[d].apply(e,arguments),e.done=function(a){c._done(e.commands,a)};return e})})},freeze:function(){var b=this,d=a.uniqueId(),e={id:d,unfreeze:function(){this.unfreeze=c.empty,delete b._frozenPromises[d],g.call(b)}};b._frozenPromises[e.id]=e;return e},on:function(a,b){this.config.proxy.on(a,b);return this},unbind:function(a){this.config.proxy.unbind(a);return this},_processChain:function(b,d){d=c.getCallbacks(d);var e=[].concat(b);a.each(b,function(f){var g=c.getCallbacks(f.callbacks),h=function(c,h){e[a.indexOf(e,f)]=c;var i=a.select(b,function(a){return a.executed!==!0});g[h](c);if(i.length===0){var j=a.select(b,function(a){return a.failed===!0});d[j.length>0?"failure":"success"](e)}};f.callbacks={success:function(a){h(a,"success")},failure:function(a){h(a,"failure")}}})},done:function(a){c.getCallbacks(a).success([])},evictProperties:function(a,b,c){this.config.proxy.evictProperties(a,b,c)},isPropertyInitialized:function(a,b,c){return this.config.proxy.isPropertyInitialized(a,b,c)},_done:function(b,c){var d=this;d._processChain(b,c),a.isEmpty(d._frozenPromises)?d.config.proxy.execute(b):d._frozenCommandsQueue=[].concat(d._frozenCommandsQueue,b)}})})