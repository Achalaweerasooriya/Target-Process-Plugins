define(["Underscore","tau/core/class","tau/core/tau","tau/store/types","tau/store/typesClass"],function(_,a,b,c,d){var e={_processCommand:function(a,b,c,d){d=d||{};var e=this.types[b];e&&(b=e.name);var f={type:b,name:a,config:c,callbacks:d};return this.commands.push(f),this}},f=function(){var a=this;if(_.isEmpty(a._frozenPromises)){var b=[].concat(a._frozenCommandsQueue);a._frozenCommandsQueue=[],a.config.proxy.execute(b)}};return a.extend({init:function(a){var f=this;f.id=_.uniqueId("store_"),f._frozenCommandsQueue=[],f._frozenPromises={},f.config=a,f.eventEmitter=f.config.eventEmitter||{fire:function(){},on:function(){},removeAllListeners:function(){}};var g=a.types||a.proxy.types;if(g){var h=new d;_(g).each(function(a){h.register(a)}),e.types=h.getDictionary()}else e.types=c.getDictionary();var i=_.functionsExt(a.proxy);_.each(i,function(a){var c=a.split("api ");if(c.length!==2)return;var d=c[1];e[d]=function(){var a=b.extendArgs(arguments,d);return this._processCommand.apply(this,a)}}),f._extendWithCommonAPI(f,f)},_extendWithCommonAPI:function(a,b){_.each(_.functionsExt(e),function(c){if(c[0]=="_")return;a[c]=function(){var d=_.extend({},e);return d.commands=a.commands||[],d[c].apply(d,arguments),d.done=function(a){b._done(d.commands,a)},d}})},freeze:function(){var a=this,c=_.uniqueId(),d={id:c,unfreeze:function(){this.unfreeze=b.empty,delete a._frozenPromises[c],f.call(a)}};return a._frozenPromises[d.id]=d,d},on:function(a,b){return this.config.proxy.on(a,b),this.eventEmitter.fire("afterStoreOn",a),this},unbind:function(a){return this.config.proxy.unbind(a),this.eventEmitter.fire("afterStoreUnbind",a),this},_processChain:function(a,c){c=b.getCallbacks(c);var d=[].concat(a);_.each(a,function(e){var f=b.getCallbacks(e.callbacks),g=function(b,g){d[_.indexOf(d,e)]=b;var h=_.select(a,function(a){return a.executed!==!0});f[g](b);if(h.length===0){var i=_.select(a,function(a){return a.failed===!0});c[i.length>0?"failure":"success"](d)}};e.callbacks={success:function(a){g(a,"success")},failure:function(a){g(a,"failure")}}})},done:function(a){b.getCallbacks(a).success([])},evictProperties:function(a,b,c){this.config.proxy.evictProperties(a,b,c)},evictData:function(){this.config.proxy.evictData()},isPropertyInitialized:function(a,b,c){return this.config.proxy.isPropertyInitialized(a,b,c)},_done:function(a,b){var c=this;c._processChain(a,b),_.isEmpty(c._frozenPromises)?c.config.proxy.execute(a):c._frozenCommandsQueue=[].concat(c._frozenCommandsQueue,a)}})})