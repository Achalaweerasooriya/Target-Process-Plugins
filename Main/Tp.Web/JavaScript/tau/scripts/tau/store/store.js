define(["Underscore","tau/core/class","tau/core/tau","tau/store/types","tau/store/typesClass","tau/core/bus","tau/core/global.bus","tau/store/store.interrupter","libs/jquery/jquery"],function(e,t,n,r,i,s,o,u,c){var a=new s({"queue.bus":!0,name:"store",globalBus:o.get()}),f={_processCommand:function(e,t,n,r){r=r||{};var i=this.types[t];i&&(t=i.name);var s={type:t,name:e,config:n,callbacks:r};return this.commands.push(s),this}};return t.extend({init:function(t){this.id=e.uniqueId("store_"),this._frozenCommandsQueue=[],this._frozenPromisesQueue=[],this._frozenPromises={},this.config=t,this.eventEmitter=this.config.eventEmitter||{fire:function(){},on:function(){},removeAllListeners:function(){}};var s=t.types||t.proxy.types;if(s){var o=new i;e(s).each(function(e){o.register(e)}),f.types=o.getDictionary()}else f.types=r.getDictionary();var u=e.functionsExt(t.proxy);e.each(u,function(e){var t=e.split("api ");if(2===t.length){var r=t[1];f[r]=function(){var e=this,t=n.extendArgs(arguments,r);return e._processCommand.apply(e,t)}}}),this._extendWithCommonAPI(this,this)},typeMetaInfo:function(e){return f.types[e]},getTypes:function(){return r},_extendWithCommonAPI:function(t,n){e.each(e.functionsExt(f),function(r){"_"!=r[0]&&(t[r]=function(){var i=e.extend({},f);return i.commands=t.commands||[],i[r].apply(i,arguments),i.done=function(e){n._done(i.commands,e)},i})})},_unfreeze:function(){if(e.isEmpty(this._frozenPromises)){var t=[].concat(this._frozenCommandsQueue);this._frozenCommandsQueue=[],this.config.proxy.execute(t)}},_freeze:function(){var t=this,r=e.uniqueId(),i={id:r,unfreeze:function(){this.unfreeze=n.empty,delete t._frozenPromises[r],t._unfreeze(),t._frozenPromisesQueue.shift();var e=t._frozenPromisesQueue[0];e&&e.resolve(t._freeze())}};return t._frozenPromises[r]=i,i},freeze:function(e){var t=c.Deferred();if(this._frozenPromisesQueue.push(t),e)return 1===this._frozenPromisesQueue.length&&t.resolve(this._freeze()),t;var n=this._freeze();return t.resolve(n),n},register:function(e,t){this.config.proxy.registerData(e,t)
},registerWithEvents:function(e,t,n){var r=e.id,i=e.__type;e.hasOwnProperty("assignable")&&this.evictProperties(r,i,["$ref:assignable[id]"]);var s=this.config.proxy,o=s.registerData(e,t);s._notifyAboutNewsAndChanges(o,n||null)},removeWithEvents:function(t){t.type=e.toCamelCase(t.__type);var n=this.config.proxy;this.evictPersistedObject(t.id,t.type),n._populateAfterRemoveEvent(null,{tree:[],deletedData:[t]})},on:function(e,t){return this.config.proxy.on(e,t),this.eventEmitter.fire("afterStoreOn",e),this},unbind:function(e){return this.config.proxy.unbind(e),this.eventEmitter.fire("afterStoreUnbind",e),this},_processChain:function(t,r){r=n.getCallbacks(r);var i=[].concat(t);e.each(t,function(s){var o=n.getCallbacks(s.callbacks),u=function(n,u,c){a.fire(u,c),i[e.indexOf(i,s)]=c;var f=e.every(t,function(e){return e.executed===!0});if(o[n](c),f){var p=e.some(t,function(e){return e.failed===!0});r[p?"failure":"success"](i)}};s.callbacks={success:u.bind(this,"success","store.command.executed"),failure:u.bind(this,"failure","store.command.failed")}},this)},done:function(e){n.getCallbacks(e).success([])},getEvictedPropertiesByType:function(e){return"project"===e?["process"]:"task"===e?["project","team","userStory"]:["project","team"]},evictProperties:function(e,t,n){this.config.proxy.evictProperties(e,t,n)},evictData:function(){this.config.proxy.evictData()},evictPersistedObject:function(e,t){this.config.proxy.evictPersistedObject(e,t)},evictCollection:function(e){this.config.proxy.evictCollection(e)},isPropertyInitialized:function(e,t,n){return this.config.proxy.isPropertyInitialized(e,t,n)},_done:function(t,n){if(this._processChain(t,n),e.isEmpty(this._frozenPromises)){var r=e.reduce(t,function(e,t){var n="save"==t.name&&u.getInterruptersByType(t.type).length>0;return n?e.interrupted.push(t):e.nonInterrupted.push(t),e},{interrupted:[],nonInterrupted:[]});r.interrupted.length>0?this._callInterruptedCommands(r.interrupted,r.nonInterrupted):this._callNotInterruptedCommands(r.nonInterrupted)
}else this._frozenCommandsQueue=[].concat(this._frozenCommandsQueue,t)},_callInterruptedCommands:function(t,n){var r=this,i=t.concat(n),s=e.chain(t).map(function(t){return e.map(u.getInterruptersByType(t.type),function(e){return{callback:e,deferred:c.Deferred(),command:t}})}).flatten().value(),o=e.map(s,function(e){return e.deferred});c.whenList(o).done(function(){r.config.proxy.execute(i)}).fail(function(t){e.each(i,function(e){e.failed=!0,e.error=t,r.config.proxy.invokeFailCallback(e)})}),e.each(s,function(e){e.callback(e.deferred,r._getChanges(e.command))})},_getChanges:function(t){var n=t.type,r=c.isArray(t.config.$set)?t.config.$set:[t.config.$set],i=t.config.id;return e.map(r,function(t){return{type:n,id:i||t.id,changes:e.chain(e.keys(t)).filter(function(e){return"id"!=e}).map(function(e){return{name:e,value:t[e]}}).value()}})},_callNotInterruptedCommands:function(e){this.config.proxy.execute(e)},getDef:function(){var t=e.toArray(arguments),n=c.Deferred();return t.push({success:function(e){n.resolve(e.data)},failure:n.reject}),this.get.apply(this,t).done(),n},saveDef:function(){var t=e.toArray(arguments),n=c.Deferred();return t.push({success:function(e){n.resolve(e)},failure:n.reject}),this.save.apply(this,t).done(),n},removeDef:function(){var t=e.toArray(arguments),n=c.Deferred();return t.push({success:n.resolve,failure:n.reject}),this.remove.apply(this,t).done(),n}})});