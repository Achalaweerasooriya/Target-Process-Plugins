define(["Underscore","tau/core/class","tau/core/event","tau/core/tau","tau/store/header","tau/core/comparer","tau/store/types","tau/store/db"],function(e,t,i,n,a,s,r,o){var c=t.extend({init:function(e){if(!e.service)throw"rest service should be defined";this.__listenerObjects={objects:[],holders:[]},this.__subscriptions={},this.types=e.types||r.getDictionary(),this._initDb(e),this.service=e.service},_initDb:function(e){e=e||{},this.__allTypeLoadMarkers={},this.db=e.db||new o({types:this.types})},mergeCommands:function(t){var i={},a=this;return e.each(t,function(t){t=e.defaults(t,{name:"get",config:{},callbacks:{}}),t.callbacks=n.getCallbacks(t.callbacks),a._processFieldsConfig(t,"get"===t.name?null:"_getEmptyArray");var s=[t.type,t.config.id||"_",t.name,t.config.nested===!0?e.uniqueId():""].join("_");if(i.hasOwnProperty(s)){var r=i[s];a.db.mergeFields(r.config.fields,t.config.fields),r.commands.push(t)}else i[s]=t,t.commands=[]}),i},execute:function(t){var i=this;e.isArray(t)||(t=[t]);var n=i.mergeCommands(t);e.each(n,function(e){if(e.executed===!0)throw"command is already executed. the same command can not be used twice";e.failed===!0?i._invokeCommandCallback("failure",e.callbacks,e,e.error):i["api "+e.name](e)})},_registerListener:function(t,i,a){var s=t||{},r=i.eventName;s.hasOwnProperty(r)||(s[r]={});var o=e.uniqueId(r),c={id:o,config:i,callback:n.createScopedCallbackIfRequired(a)},l=s[r],d=i.listener;if(d){if(!d.__getRepositorySubscriberId){var f=e.uniqueId("repository_");d.__getRepositorySubscriberId=function(){return f},this.__listenerObjects[f]={listener:d,holders:[]}}var u={id:o,holder:l};this.__listenerObjects[d.__getRepositorySubscriberId()].holders.push(u)}return l[o]=c,c},unbind:function(t){if(t.__getRepositorySubscriberId){var i=this,n=t.__getRepositorySubscriberId(),a=i.__listenerObjects[n];if(a){var s=a.holders;s&&(e(s).each(function(e){var t=e.holder[e.id];t.callback=function(){},delete e.holder[e.id]}),delete t.__getRepositorySubscriberId,delete i.__listenerObjects[n])
}}},_getListeners:function(t){var i=this,n=this._getSubscriptions(t.type);if(!n)return[];var a=n[t.eventName];if(!a)return[];var r=[];return e.each(a,function(n){var a=n.config.filter;if(a){var o=i.db.getPersistedNode(t.obj.id,t.obj.type),c=t.obj;o&&o.data?c=o.data:t.nodeEvent.changes&&!e.isEmpty(t.nodeEvent.changes)&&(c=t.nodeEvent.changes);var l=s.compare(c,a);if(e.keys(l.changes).length>0)return}var d=n.config.hasChanges||[];if(t.nodeEvent&&d.length>0){var f=t.nodeEvent.changes||{},u=e.all(d,function(t){var i=t.split("|");return i.length>1?e.chain(f).keys().intersection(i).size().value()>0:f.hasOwnProperty(t)});if(!u)return}r.push(n)}),r},on:function(t,i){var n="_all_";t.type&&(n=e.has(this.types,t.type)?this.types[t.type].name:t.type);var a=this._getSubscriptions(n);return this._registerListener(a,t,i)},invokeFailCallback:function(e){this._invokeCommandCallback("failure",e.callbacks,e,e.error)},_getSubscriptions:function(e){return this.__subscriptions.hasOwnProperty(e)||(this.__subscriptions[e]={}),this.__subscriptions[e]},_autoAppend:function(t,i,n){e.each(i,function(i){e.any(t,function(e){return a.header.getFieldName(e)===a.header.getFieldName(i)})||t[n?n:"unshift"](i)})},registerData:function(e,t){return this.db.register(e,null,t)},_getEmptyArray:function(){return[]},_getDefaultFields:function(t){var i=this.types[t.type];return e.clone(i?i.fields||[]:[])},_processFieldsConfig:function(t,i){var n=this;i=i||"_getDefaultFields",t.config.fields&&0!==t.config.fields.length||(t.config.fields=n[i](t));var a=t.config.fields;n._autoAppend(a,["id"]);for(var s=a.length;s>0;s--){var r=a[s-1];if(!e.isSimple(r)){var o=e.getFieldName(r),c=t.type?n.types[t.type]:null,l=null,d=[];if(c&&c.refs&&c.refs[o]){var f=c.refs[o];f.list===!0&&(r.list=!0),d=f.fields,l=f.name}var u={type:l,config:{fields:r[o]||d}};r[o]=n._processFieldsConfig(u,i)}}var p=a.length;for(s=0;p>s;s++)for(var v=e.getFieldName(a[s]),h=s+1;p>h;h++)e.getFieldName(a[h])===v&&(e.isSimple(a[s])||e.mergeFields(a[s][v],a[h][v]),a.splice(h,1),p--,h--);
return a},_invokeCommandCallback:function(t,i,n,a){var s=this;if(s._invokeCommandCallbackR(t,i,n,a),n.config.silent!==!0&&s.__subscriptions._all_&&!e.isEmpty(s.__subscriptions._all_)){var r=e.values(s.__subscriptions._all_[t]||[]),o={name:t,data:{cmd:n,data:a}};e(r).each(function(e){e.callback(o)})}},_invokeCommandCallbackR:function(t,i,n,a){var s=this;n.executed=!0,i[t]({command:n,data:a}),n.hasOwnProperty("commands")&&e.each(n.commands,function(e){e.executed=!0,e.failed=n.failed,s._invokeCommandCallbackR(t,e.callbacks,e,a)})},"api removeFromList":function(e){var t=this,i=e.callbacks;e.config.$set=e.config.$set||{},e.callbacks={success:function(){var n=t.db.removeFromList(e.config.id,e.type,e.config.$set);t._invokeCommandCallback("success",i,e,{}),t._notifyAboutNewsAndChanges(n,e)},failure:function(n){e.failed=!0,t._invokeCommandCallback("failure",i,e,n)}},t._populateBeforeSaveEvent(e),t._processFieldsConfig(e,"_getEmptyArray"),t.service.removeFromList(e)},"api remove":function(e){var t=this,i=e.callbacks;e.callbacks={success:function(){var n=t.evictPersistedObject(e.config.id,e.type);t._populateAfterRemoveEvent(e,n),t._invokeCommandCallback("success",i,e,e.callbacks)},failure:function(n){e.failed=!0,t._invokeCommandCallback("failure",i,e,n)}},t._populateBeforeRemoveEvent(e),t.service.remove(e)},evictPersistedObject:function(e,t){return this.db.remove(e,this.types[t].name)},evictProperties:function(e,t,i){this.db.removeProperties(e,this.types[t].name,i)},evictAllPropertiesExcept:function(e,t,i){this.db.removeAllPropertiesExcept(e,this.types[t].name,i)},evictData:function(){this._initDb()},evictCollection:function(e){this.db.removeCollection(e),this.unmarkRecordSetAsCompleteLoaded(e)},isPropertyInitialized:function(e,t,i){return this.db.isPropertyInitialized(e,t,i)},getProperties:function(t){var i=this.db.__types[t];return i.simpleFields.concat(e.keys(i.refs))},"api save":function(t){var i=this,n=t.callbacks;t.config.$set=t.config.$set||{},t.callbacks={success:function(a){a.__type=t.type;
var s={};if(e.isArray(t.config.$set)){s=[];for(var r=0;r<t.config.$set.length;r++){var o=e.extend(e.extend({__type:t.type},t.config.$set[r]),a[r]);s.push(o)}}else s=e.extend(e.extend({},t.config.$set),a);var c=i.db.register(s);i._notifyAboutNewsAndChanges(c,t),i._invokeCommandCallback("success",n,t,s)},failure:function(e){t.failed=!0,i._invokeCommandCallback("failure",n,t,e)}},i._populateBeforeSaveEvent(t),i._processFieldsConfig(t,"_getEmptyArray"),i.service.save(t)},_notifyAboutNewsAndChanges:function(t,i){var n=this;e.each(t.tree,function(t,a){e.each(t,function(e){n._populateEvent(i,"afterSave",e,{id:e.id,type:a})})})},_populateEvent:function(t,i,n,a){var s=this._getListeners({type:a.type,eventName:i,nodeEvent:n,obj:a});if(0!==s.length){var r=e.uniqueId("repositoryEvent"),o={id:r,name:i,data:{id:a.id,type:a.type,cmd:t,obj:a,changes:n.changes}};e.each(s,function(e){e.callback(o)})}},_populateBeforeRemoveEvent:function(e){this._populateEvent(e,"beforeRemove",{},{id:e.config.id,type:e.type})},_populateAfterRemoveEvent:function(t,i){e.each(i.deletedData,function(e){this._populateEvent(t,"afterRemove",{},e)},this),this._notifyAboutNewsAndChanges(i,t)},_populateBeforeSaveEvent:function(e){this._populateEvent(e,"beforeSave",{changes:e.config.$set||{}},{id:e.config.id,type:e.type})},markRecordSetAsCompleteLoaded:function(e){this.__allTypeLoadMarkers[e]=!0},unmarkRecordSetAsCompleteLoaded:function(e){this.__allTypeLoadMarkers[e]=!1},isTypeMarkedAsCompleteLoaded:function(e){return this.__allTypeLoadMarkers[e]===!0},_appendDiscriminator:function(t,i){var n=this;if(!t)throw new Error("Table name is not defined");t.isParentType&&e.indexOf(i,"id")>=0&&n._autoAppend(i,[t.discriminator],"push"),e.each(i,function(e){if(!a.header.isSimple(e)){var i=a.header.getFieldName(e),s=t.refs[i];s&&n._appendDiscriminator(n.types[s.name],e[i])}})},_runReadCommand:function(t,i,n,a){var s=this;try{s._appendDiscriminator(s.types[t.type],n)}catch(r){return t.failed=!0,void t.callbacks.failure(null,r)
}t.config.fields=n,s._processFieldsConfig(t);var o=t.callbacks;t.callbacks={success:function(n){t.config.fields=i,e.defaults(n,{__type:t.type});var r=a(n,s.db.register(n));s._invokeCommandCallback("success",o,t,r),t.callbacks=o},failure:function(e){t.config.fields=i,t.failed=!0,s._invokeCommandCallback("failure",o,t,e),t.callbacks=o}},this.service[t.name](t)},"api refresh":function(t){var i=this,n=t.config.fields,a=function(e,a){return i._notifyAboutNewsAndChanges(a,t),i.db.get(t.config.id,t.type,{fields:n}).data};this._runReadCommand(t,n,e.clone(n),a)},"api turboGet":function(t){var i=this,n=t.config.fields||[];i._autoAppend(n,["id"]);var a=t.callbacks;t.callbacks={success:function(n){e.defaults(n,{__type:t.type}),i._invokeCommandCallback("success",a,t,n),t.callbacks=a},failure:function(e){t.failed=!0,i._invokeCommandCallback("failure",a,t,e),t.callbacks=a}},this.service[t.name](t)},"api find":function(t){var i=this,n=t.config.fields,a=function(a){var s=[];if(e.each(a,function(e){s.push(i.db.get(e.id,t.type,{fields:n}).data)}),a.hasOwnProperty("getNextPage")){s.isNextPageAvailable=function(){return!0};var r=e.clone(t);r.config=e.clone(r.config),r.config.$skip+=r.config.$limit,s.getNextPageCommand=function(){return r}}else s.isNextPageAvailable=function(){return!1};return s};this._runReadCommand(t,n,e.clone(n),a)},_getFromCache:function(e){var t=this.db.get(e.config.id,e.type,e.config);if(0===t.notInitializedFields.length){var i=!t.all;if(i||this.isTypeMarkedAsCompleteLoaded(e.type))return t}return null},"api get":function(t){var i=this._getFromCache(t);if(i)this._invokeCommandCallback("success",t.callbacks,t,i.data);else{var n=t.config.fields,a=function(){return t.config.id||this.markRecordSetAsCompleteLoaded(t.type),this.db.get(t.config.id,t.type,{fields:n}).data}.bind(this);this._runReadCommand(t,n,e.clone(n),a)}}});return c});