define(["Underscore","tau/core/tau"],function(_,tau){var tauExtension=_.extend(tau,{ref:function(e,t){var a={};return a[e]=t,a},list:function(e,t){var a=tau.ref(e,t);return a.list=!0,a},getNextPage:function(e,t,a){a=a||[];var r={holder:e,url:t,fields:a};return e.getNextPage=function(){return r},r},parseFieldsFromString:function(value){var self=this;value=value.replace(/([\w-]+)\[+/gi,'{"$1":['),value=value.replace(/(\])/gi,"]}"),value=value.substr(0,value.length-1),value=value.replace(/([\w-]+)(,|\])/gi,"'$1'$2");var fields=eval("(function () { return "+value+";})();"),toLowerCase=function(e){var t=e.split("-");if(t.length>1){var a=[];return _.each(t,function(e){a.push(toLowerCase(e))}),a.join("-")}return e.charAt(0).toLowerCase()+e.substr(1)},formatFields=function(e){var t=[];return _.each(e,function(e){if(self.header.isSimple(e))return void t.push(toLowerCase(e));var a={},r=self.header.getFieldName(e);a[toLowerCase(r)]=formatFields(e[r]),t.push(a)}),t};return formatFields(fields)},formatObject:function(e,t){var a=this,r={data:[],nextPages:[]};if(_.isUndefined(e)||_.isNull(e))return r.data=null,r;if("object"!=typeof e)return r.data=e,r;t=t?t:"Lower";var n=function(e){return e.charAt(0)["to"+t+"Case"]()+e.substr(1)};if(e&&(e.hasOwnProperty("Items")||e.hasOwnProperty("items"))){var u=e.next||e.Next;u&&r.nextPages.push(a.getNextPage(r.data,u,[])),e=e.Items||e.items}if(_.isArray(e))return _.each(e,function(e){var n=a.formatObject(e,t);r.nextPages=r.nextPages.concat(n.nextPages||[]),r.data.push(n.data)}),r;var i={};return _.each(_.keys(e),function(u){var s=n(u),o=s.split("-");if(o.length>1){var l=[];_.each(o,function(e){l.push(n(e))}),s=l.join("-")}var f=a.formatObject(e[u],t);r.nextPages=r.nextPages.concat(f.nextPages||[]),i[s]=f.data}),r.data=i,r},header:{getFieldName:function(e){return _.getFieldName(e)},isSimple:function(e){return _.isString(e)},isList:function(e){return e.list===!0}}});return tauExtension});