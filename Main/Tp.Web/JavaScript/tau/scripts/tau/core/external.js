define(["Underscore","jQuery","tau/core/class","libs/json2"],function(_,$,a){return a.extend({init:function(a){this.external=_.defaults(a,{location:{hash:""}})},getHash:function(){var a=this.external.location.hash;while(a.indexOf("#")===0)a=a.substr(1);return a},setHash:function(a){this.external.location.hash="#"+a},hashParams:function(){var a={},b=this.getHash(),c=b.split("&");for(var d=0,e=c.length;d<e;d++){var f=c[d],g=f.indexOf("=");if(g!==-1){var h=f.substr(0,g),i=f.substr(g+1),j=i;try{j=JSON.parse(i)}catch(k){}a[h]=j}}return a},getHashParam:function(a){var b=this.hashParams(),c=b[a]||{};return c},setHashParam:function(a,b){var c=this.getHash(),d=c.indexOf("&"+a+"="),e=d!==-1?d:c.length;d=c.indexOf("&",1+e);var f=d!==-1?d:c.length,g="";if(b!==null){var h=_.isString(b)?b:JSON.stringify(b);g="&"+a+"="+h}var i=c.substring(0,e),j=c.substring(f),k=i+g+j;this.setHash(k)},onHashChange:function(a){var b=this,c=function(c){c.stopPropagation(),c.preventDefault(),a(b)};$(this.external).bind("hashchange",c)},triggerHashChange:function(a){$(this.external).trigger("hashchange",{hash:a})}})})