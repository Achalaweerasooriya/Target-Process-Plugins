define(["Underscore","jQuery","tau/core/class","libs/json2"],function(_,$,a){var b=function(a,b,c){a=a.charAt(0)!=="&"?"&"+a:a;var d=a.indexOf("&"+b+"="),e=d!==-1?d:a.length;d=a.indexOf("&",1+e);var f=d!==-1?d:a.length,g="";if(c!==null){var h=_.isString(c)?c:JSON.stringify(c),i=a==="&"?"":"&";g=i+b+"="+h}var j=a.substring(0,e),k=a.substring(f),l=j+g+k;return l=l.charAt(0)!=="&"?l:l.substring(1),l},c=function(a){var b=a;try{b=decodeURIComponent(a)}catch(c){}return b};return a.extend({init:function(a){this.external=_.defaults(a,{location:{hash:""}})},getHash:function(){var a=this.external.location.hash;while(a.indexOf("#")===0)a=a.substr(1);return c(a)},setHash:function(a){this.external.location.hash="#"+a},hashParams:function(){var a={},b=this.getHash(),c=b.split("&");for(var d=0,e=c.length;d<e;d++){var f=c[d],g=f.indexOf("=");if(g!==-1){var h=f.substr(0,g),i=f.substr(g+1),j=i;i.charAt(0)==="{"&&i.charAt(i.length-1)==="}"&&(j=JSON.parse(i)),a[h]=j}}return a},getHashParam:function(a,b){var c=this.hashParams(),d=c[a]||(arguments.length>1?b:{});return d},setHashParam:function(a,c){var d=this.getHash(),e=b(d,a,c);this.setHash(e)},onHashChange:function(a){var b=this,c=function(c){c.stopPropagation(),c.preventDefault(),a(b)};$(this.external).bind("hashchange",c)},triggerHashChange:function(a){$(this.external).trigger("hashchange",{hash:a})}})})