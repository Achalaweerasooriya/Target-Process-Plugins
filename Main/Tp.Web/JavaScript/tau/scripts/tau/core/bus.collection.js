define(["Underscore","jQuery","tau/core/class","tau/core/event"],function(_,$,Class,Event){var Collection=Class.extend({init:function(){this.buses={}},register:function(bus){var self=this;self.buses[bus.id]=bus,self.fire("create",{bus:bus})},count:function(excludeGlobalBus){var keys=_(this.buses).keys();return excludeGlobalBus&&(keys=_(keys).without("global")),keys.length},size:function(){return this.count()},stats:function(){var counts={},self=this;_.each(_(self.buses).keys(),function(key){var bus=self.buses[key];counts.hasOwnProperty(bus.name)||(counts[bus.name]=0),counts[bus.name]++}),_.each(_(counts).keys(),function(key){console.log(key+" : "+counts[key])})},unregister:function(bus){if(bus.id==="global")return;delete this.buses[bus.id],this.fire("destroy",{bus:bus})},getByName:function(name,f){var def=$.Deferred(),cond=function(bus){return bus.name===name},bus=_.find(this.buses,cond);if(!bus){var listener=_.bind(function(def,evt){var bus=evt.data.bus;cond(bus)&&(this.removeListener("create",listener,this),def.resolve(bus))},this,def);this.on("create",listener,this)}else def.resolve(bus);return f&&def.done(f),def},onCreate:function(bus){this.register(bus)},onDestroy:function(bus){this.unregister(bus)},logCount:function(){console.log("#count: "+this.count())},clear:function(){this.buses=[]}});return Event.implementOn(Collection.prototype),Collection})