define(["Underscore"],function(e){function n(n){var t=[];for(var r in n)if(/\s/.test(r)){var i=n[r];i&&e.isFunction(i)&&t.push(r)}return t.sort(),t}var t=function(e){var n=e.split(":"),t={name:n[0],rule:null,last:!1};return n.length>1&&(t.rule=n[1],t.last="last"===t.rule),t},r=function(){};r.implementOn=function(e){var n=r.prototype;for(var t in n)void 0==e[t]&&(e[t]=n[t]);return e},r.extend=function(e){return r.implementOn(e.prototype),e},r.signUpOnEvents=function(n,r,i,s,a,o){for(var v={},u=[],l=function(t){if(o)for(var s=e.indexOf(n,t.name),a=0;s>a;a++)if(!v.hasOwnProperty(u[a].name))return;if(v[t.name]=t,e.keys(v).length===u.length){for(var l={},f=[l],c=0,h=u.length;h>c;c++){var g=u[c],p=v[g.name];l[g.name]=p,f.push(p.data),g.last||delete v[g.name]}r[i].apply(r,f)}},f=0,c=n.length;c>f;f++){var h=t(n[f]);u.push(h),s.on(h.name,l,r,null,a)}},r.subscribeOn=function(t){for(var i=n(t),s=0,a=i.length;a>s;s++){var o=i[s],v=o.replace(/\s*\+\s*/g,"+").replace(/\s*>\s*/g,">"),u=v.split(/\s+/);if(!(u.length<2)){var l=u[0];if(e.has(t,l)){var f=t[l];if(f&&e.isFunction(f.on)){var c=u[1],h=c.split("+"),g=c.split(">");if(h.length>1&&g.length>1)throw new Error('"'+o+'": + and > can not be used together');var p;u.length>2&&!isNaN(u[2])&&(p=u[2]),h.length>1?r.signUpOnEvents(h,t,o,f,p,!1):g.length>1?r.signUpOnEvents(g,t,o,f,p,!0):f.on(c,t[o],t,null,p)}}}}},r.unSubscribe=function(n){e.each(n,function(t){t&&e.isFunction(t.removeAllListeners)&&t.removeAllListeners(n)})};var i=function(e){this.name=e,this.listeners=[]};i.prototype={getListenerIndex:function(e,n){for(var t=!n,r=0,i=this.listeners;r<i.length;r++){var s=i[r];if(s.fn==e&&(s.scopeObj===n||!s.scopeObj&&t))return r}return-1}};var s={getPrivateEvents:function(){var e=this.getPrivate&&this.getPrivate()||this._||(this._={});return e.events||(e.events={})},getPrivateEvent:function(e){var n=this.getPrivate&&this.getPrivate()||this._;return n&&n.events?n.events[e]:null},once:function(n,t,r,i,s){var a=e.bind(function(e){this.removeListener(n,e,r||this)
},this),o=function(){t.apply(this,e.toArray(arguments)),a(o)};this.on(n,o,r,i,s)},on:function(n,t,s,a,o){if(e.isString(n)&&n.indexOf("+")>0){var v=n.split("+");return r.signUpOnEvents(v,this,t,this,o),this}if(e.isArray(n)){var u=this;return e.each(n,function(e){u.on(e,t,s,a,o)}),this}var l=this.getPrivateEvents(),f=l[n]||(l[n]=new i(n));if(f.getListenerIndex(t,s)>=0)return this;var c=f.listeners;s||(s=this),isNaN(o)&&(o=10);var h=this,g=function(e,r,i,o,v){var u={name:n,sender:this,date:new Date,caller:e,data:r,listenerData:a,stop:i,cancel:o,suspendMain:function(){v&&v.lock()},cancelMain:function(){v&&v.cancel()},resumeMain:function(){v&&v.unlock()},removeListener:function(){h.removeListener(n,t,s)}};return t.call(s,u,u.data),u.data};g.fn=t,g.scopeObj=s,g.priority=o;for(var p=c.length-1;p>=0;p--)if(c[p].priority<=o)return c.splice(p+1,0,g),this;return c.unshift(g),this},fire:function(){var e=!1,n=function(){e=!0},t=!1,r=function(){t=!0};return function(i,s,a,o){var v=this.getPrivateEvent(i),u=e,l=t;if(e=t=!1,v){var f=v.listeners;if(f.length){f=f.slice(0);for(var c=0;c<f.length;c++){var h=f[c].call(this,a,s,n,r,o);if("undefined"!=typeof h&&(s=h),e||t)break}}}var g=t||("undefined"==typeof s?!1:s);return e=u,t=l,g}}(),fireOnce:function(e,n,t){var r=this.fire(e,n,t);return delete this.getPrivateEvents()[e],r},removeListener:function(e,n,t){var r=this.getPrivateEvent(e);if(r){var i=r.getListenerIndex(n,t);i>=0&&r.listeners.splice(i,1)}},removeAllListeners:function(e){var n=this.getPrivateEvents();for(var t in n)if(n[t].listeners)if(e){for(var r=n[t].listeners,i=[],s=0;s<r.length;s++)r[s].scopeObj!=e&&i.push(r[s]);n[t].listeners=i}else delete n[t].listeners,delete n[t]},hasListeners:function(e){var n=this.getPrivateEvent(e);return n&&n.listeners.length>0},getListeners:function(){var e=this.getPrivateEvents(),n=[];for(var t in e){var r=e[t].listeners;if(r&&r.length>0){for(var i=[],s=0;s<r.length;s++){var a=r[s],o={name:"unknown",item:a};a.scopeObj&&a.scopeObj.bus&&a.scopeObj.bus.name?o.name=a.scopeObj.bus.name:a.scopeObj&&a.scopeObj.name&&(o.name=a.scopeObj.name),i.push(o)
}n.push({name:t,items:r,count:r.length,listeners:i})}}return n},getListenersCount:function(){var e=this.getPrivateEvents(),n=0;for(var t in e)e[t].listeners&&(n+=e[t].listeners.length);return n},createChildEventEmitter:function(n){var t=this,r=["on","removeListener","removeAllListeners","hasListeners","getListeners","getListenersCount"],i=e.inject(r,function(e,n){return e[n]={writable:!1,value:t[n].bind(t)},e},{});return Object.create(t,e.extend(i,n))}};return s.addEventListener=s.on,s.unbind=s.removeAllListeners,r.prototype=s,r});