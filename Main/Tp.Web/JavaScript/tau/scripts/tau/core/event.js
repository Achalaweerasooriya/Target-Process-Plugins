define(["Underscore"],function(_){var a=function(){};a.implementOn=function(b){var c=a.prototype;for(var d in c)b[d]==undefined&&(b[d]=c[d]);return b};var b=function(a){var b={},c=a.split(":");return b.name=c[0],c.length>1&&(b.rule=c[1]),b};return a.signUpOnEvents=function(a,c,d,e,f){var g={},h=[],i={},j=function(a){g[a.name]=a;if(_(g).keys().length===h.length){var b={};for(var e=0,f=h.length;e<f;e++){var j=i[h[e]];b[j.name]=g[j.name];if(j.rule==="last")continue;delete g[j.name]}c[d].call(c,b)}};for(var k=0,l=a.length;k<l;k++){var m=b(a[k]),n=m.name;i[n]=m,h.push(n),e.on(n,j,c,null,f)}},a.subscribeOn=function(b){var c=_(b);_.each(c.keys(),function(c){var d=b[c];if(!d)return;if(_.isFunction(d.on)){var e=_(b).functionsExt();for(var f=0,g=e.length;f<g;f++){var h=e[f],i=h.split(" "),j=i[1],k=i[0],l;if(i.length<2)continue;i.length>2&&!isNaN(i[2])&&(l=i[2]);var m=j.split("+");k==c&&(m.length>1?a.signUpOnEvents(m,b,h,d,l):d.on(j,b[h],b,null,l))}}})},a.unSubscribe=function(a){var b=_(a);_.each(b.keys(),function(b){var c=a[b];c&&_.isFunction(c.removeAllListeners)&&c.removeAllListeners(a)})},a.prototype=function(){var a=function(a){var _=a.getPrivate&&a.getPrivate()||a._||(a._={});return _.events||(_.events={})},b=function(a){this.name=a,this.listeners=[]};return b.prototype={getListenerIndex:function(a,b){for(var c=0,d=this.listeners;c<d.length;c++)if(d[c].fn==a&&(d[c].scopeObj===b||!d[c].scopeObj&&(arguments.length==1||!b)))return c;return-1}},{on:function(c,d,e,f,g){if(_.isArray(c)){var h=arguments.callee,i=this;_.each(c,function(a){h.call(i,a,d,e,f,g)});return}var j=a(this),k=j[c]||(j[c]=new b(c));if(k.getListenerIndex(d,e)<0){var l=k.listeners;e||(e=this),isNaN(g)&&(g=10);var m=this,n=function(a,b,g,h){var i={name:c,sender:this,caller:a,data:b,listenerData:f,stop:g,cancel:h,removeListener:function(){m.removeListener(c,d,e)}};return d.call(e,i),i.data};n.fn=d,n.scopeObj=e,n.priority=g;for(var o=l.length-1;o>=0;o--)if(l[o].priority<=g){l.splice(o+1,0,n);return}l.unshift(n)}return this},fire:function(){var b=!1,c=function(){b=!0},d=!1,e=function(){d=!0};return function(f,g,h){var i=a(this)[f],j=b,k=d;b=d=!1;if(i){var l=i.listeners;if(l.length){l=l.slice(0);for(var m=0;m<l.length;m++){var n=l[m].call(this,h,g,c,e);typeof n!="undefined"&&(g=n);if(b||d)break}}}var o=d||(typeof g=="undefined"?!1:g);return b=j,d=k,o}}(),fireOnce:function(b,c,d){var e=this.fire(b,c,d);return delete a(this)[b],e},removeListener:function(b,c,d){var e=a(this)[b];if(e){var f=e.getListenerIndex(c,d);f>=0&&e.listeners.splice(f,1)}},removeAllListeners:function(b){var c=a(this);for(var d in c)if(c[d].listeners)if(!b)delete c[d].listeners,delete c[d];else{var e=c[d].listeners,f=[];for(var g=0;g<e.length;g++)e[g].scopeObj!=b&&f.push(e[g]);c[d].listeners=f}},hasListeners:function(b){var c=a(this)[b];return c&&c.listeners.length>0},getListeners:function(){var b=a(this),c=[];for(var d in b){var e=b[d].listeners;if(e&&e.length>0){var f=[];for(var g=0;g<e.length;g++){var h=e[g],i={name:"unknown",item:h};h.scopeObj&&h.scopeObj.bus&&h.scopeObj.bus.name?i.name=h.scopeObj.bus.name:h.scopeObj&&h.scopeObj.name&&(i.name=h.scopeObj.name),f.push(i)}c.push({name:d,items:e,count:e.length,listeners:f})}}return c},getListenersCount:function(){var b=a(this),c=0;for(var d in b)b[d].listeners&&(c+=b[d].listeners.length);return c}}}(),a})