define(["Underscore"],function(e){var n=function(e){var n=e.split(":"),t={name:n[0]};return n.length>1&&(t.rule=n[1]),t},t=function(n){return n.name?[n.data]:e.pluck(e.values(n),"data")},r=function(){};r.implementOn=function(e){var n=r.prototype;for(var t in n)void 0==e[t]&&(e[t]=n[t]);return e},r.extend=function(e){return r.implementOn(e.prototype),e},r.signUpOnEvents=function(r,i,s,a,o,v){for(var u={},l=[],f={},c=function(n){if(v)for(var a=e.indexOf(r,n.name),o=0;a>o;o++){var c=r[o].replace(":last","");if(!u.hasOwnProperty(c))return}if(u[n.name]=n,e.keys(u).length===l.length){for(var h={},p=0,g=l.length;g>p;p++){var m=f[l[p]];h[m.name]=u[m.name],"last"!==m.rule&&delete u[m.name]}h=[h].concat(t(h)),i[s].apply(i,h)}},h=0,p=r.length;p>h;h++){var g=n(r[h]),m=g.name;f[m]=g,l.push(m),a.on(m,c,i,null,o)}},r.subscribeOn=function(n){var t=[];for(var i in n)if(/\s/.test(i)){var s=n[i];s&&e.isFunction(s)&&t.push(i)}t.sort();for(var a=0,o=t.length;o>a;a++){var v=t[a],u=v.replace(/\s*\+\s*/g,"+").replace(/\s*>\s*/g,">"),l=u.split(/\s+/);if(!(l.length<2)){var f=l[0];if(e.has(n,f)){var c=n[f];if(c&&e.isFunction(c.on)){var h=l[1],p=h.split("+"),g=h.split(">");if(p.length>1&&g.length>1)throw new Error('"'+v+'": + and > can not be used together');var m;l.length>2&&!isNaN(l[2])&&(m=l[2]),p.length>1?r.signUpOnEvents(p,n,v,c,m,!1):g.length>1?r.signUpOnEvents(g,n,v,c,m,!0):c.on(h,n[v],n,null,m)}}}}},r.unSubscribe=function(n){e.each(n,function(t){t&&e.isFunction(t.removeAllListeners)&&t.removeAllListeners(n)})};var i=function(e){this.name=e,this.listeners=[]};i.prototype={getListenerIndex:function(e,n){for(var t=0,r=this.listeners;t<r.length;t++){var i=r[t];if(i.fn==e&&(i.scopeObj===n||!i.scopeObj&&!n))return t}return-1}};var s={getPrivateEvents:function(){var e=this.getPrivate&&this.getPrivate()||this._||(this._={});return e.events||(e.events={})},getPrivateEvent:function(e){var n=this.getPrivate&&this.getPrivate()||this._;return n&&n.events?n.events[e]:null},once:function(n,t,r,i,s){var a=e.bind(function(e){this.removeListener(n,e,r||this)},this),o=function(){t.apply(this,e.toArray(arguments)),a(o)};this.on(n,o,r,i,s)},on:function(n,t,s,a,o){if(e.isString(n)&&n.indexOf("+")>0){var v=n.split("+");return r.signUpOnEvents(v,this,t,this,o),this}if(e.isArray(n)){var u=this;return e.each(n,function(e){u.on(e,t,s,a,o)}),this}var l=this.getPrivateEvents(),f=l[n]||(l[n]=new i(n));if(f.getListenerIndex(t,s)>=0)return this;var c=f.listeners;s||(s=this),isNaN(o)&&(o=10);var h=this,p=function(e,r,i,o,v){var u={name:n,sender:this,date:new Date,caller:e,data:r,listenerData:a,stop:i,cancel:o,suspendMain:function(){v&&v.lock()},cancelMain:function(){v&&v.cancel()},resumeMain:function(){v&&v.unlock()},removeListener:function(){h.removeListener(n,t,s)}};return t.call(s,u,u.data),u.data};p.fn=t,p.scopeObj=s,p.priority=o;for(var g=c.length-1;g>=0;g--)if(c[g].priority<=o)return c.splice(g+1,0,p),this;return c.unshift(p),this},fire:function(){var e=!1,n=function(){e=!0},t=!1,r=function(){t=!0};return function(i,s,a,o){var v=this.getPrivateEvent(i),u=e,l=t;if(e=t=!1,v){var f=v.listeners;if(f.length){f=f.slice(0);for(var c=0;c<f.length;c++){var h=f[c].call(this,a,s,n,r,o);if("undefined"!=typeof h&&(s=h),e||t)break}}}var p=t||("undefined"==typeof s?!1:s);return e=u,t=l,p}}(),fireOnce:function(e,n,t){var r=this.fire(e,n,t);return delete this.getPrivateEvents()[e],r},removeListener:function(e,n,t){var r=this.getPrivateEvent(e);if(r){var i=r.getListenerIndex(n,t);i>=0&&r.listeners.splice(i,1)}},removeAllListeners:function(e){var n=this.getPrivateEvents();for(var t in n)if(n[t].listeners)if(e){for(var r=n[t].listeners,i=[],s=0;s<r.length;s++)r[s].scopeObj!=e&&i.push(r[s]);n[t].listeners=i}else delete n[t].listeners,delete n[t]},hasListeners:function(e){var n=this.getPrivateEvent(e);return n&&n.listeners.length>0},getListeners:function(){var e=this.getPrivateEvents(),n=[];for(var t in e){var r=e[t].listeners;if(r&&r.length>0){for(var i=[],s=0;s<r.length;s++){var a=r[s],o={name:"unknown",item:a};a.scopeObj&&a.scopeObj.bus&&a.scopeObj.bus.name?o.name=a.scopeObj.bus.name:a.scopeObj&&a.scopeObj.name&&(o.name=a.scopeObj.name),i.push(o)}n.push({name:t,items:r,count:r.length,listeners:i})}}return n},getListenersCount:function(){var e=this.getPrivateEvents(),n=0;for(var t in e)e[t].listeners&&(n+=e[t].listeners.length);return n}};return s.addEventListener=s.on,s.unbind=s.removeAllListeners,r.prototype=s,r});