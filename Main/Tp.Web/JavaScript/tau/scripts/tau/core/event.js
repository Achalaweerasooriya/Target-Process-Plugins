define(["Underscore"],function(e){function t(t){var n=[];for(var r in t)if(/\s/.test(r)){var i=t[r];i&&e.isFunction(i)&&n.push(r)}return n.sort(),n}var n=function(e){var t=e.split(":"),n={name:t[0],rule:null,last:!1};return t.length>1&&(n.rule=t[1],n.last="last"===n.rule),n},r=function(){};r.implementOn=function(e){var t=this.prototype;for(var n in t)void 0==e[n]&&(e[n]=t[n]);return e},r.extend=function(e){return r.implementOn(e.prototype),e},r.signUpOnEvents=function(t,r,i,s,a,o){for(var l={},v=[],u=function(n){if(o)for(var s=e.indexOf(t,n.name),a=0;s>a;a++)if(!l.hasOwnProperty(v[a].name))return;if(l[n.name]=n,e.keys(l).length===v.length){for(var u={},h=[u],f=0,c=v.length;c>f;f++){var g=v[f],p=l[g.name];u[g.name]=p,h.push(p.data),g.last||delete l[g.name]}e.isFunction(i)?i.apply(r,h):r[i].apply(r,h)}},h=0,f=t.length;f>h;h++){var c=n(t[h]);v.push(c),s.on(c.name,u,r,null,a)}},r.subscribeOn=function(n){for(var i=t(n),s=0,a=i.length;a>s;s++){var o=i[s],l=o.replace(/\s*([+>])\s*/g,"$1"),v=l.split(/\s+/);if(!(v.length<2)){var u=v[0];if(e.has(n,u)){var h=n[u];if(h&&e.isFunction(h.on)){var f=v[1],c=f.split("+"),g=f.split(">");if(c.length>1&&g.length>1)throw new Error('"'+o+'": + and > can not be used together');var p;v.length>2&&!isNaN(v[2])&&(p=v[2]),c.length>1?r.signUpOnEvents(c,n,o,h,p,!1):g.length>1?r.signUpOnEvents(g,n,o,h,p,!0):h.on(f,n[o],n,null,p)}}}}},r.unSubscribe=function(t){e.each(t,function(n){n&&e.isFunction(n.removeAllListeners)&&n.removeAllListeners(t)})};var i=function(e){this.name=e,this.listeners=[]};i.prototype={getListenerIndex:function(e,t){for(var n=!t,r=0,i=this.listeners;r<i.length;r++){var s=i[r];if(s.fn==e&&(s.scopeObj===t||!s.scopeObj&&n))return r}return-1}};var s={getPrivateEvents:function(){var e=this.getPrivate&&this.getPrivate()||this._||(this._={});return e.events||(e.events={})},getPrivateEvent:function(e){var t=this.getPrivate&&this.getPrivate()||this._;return t&&t.events?t.events[e]:null},once:function(t,n,r,i,s){var a=e.bind(function(e){this.removeListener(t,e,r||this)
},this),o=function(){n.apply(this,e.toArray(arguments)),a(o)};this.on(t,o,r,i,s)},on:function(t,n,s,a,o){if(e.isString(t)&&(t.indexOf("+")>0||t.indexOf(">")>0)){var l=t.replace(/\s*([+>])\s*/g,"$1"),v=l.split("+"),u=l.split(">");if(v.length>1&&u.length>1)throw new Error('"'+t+'": + and > can not be used together');if(v.length>1)return r.signUpOnEvents(v,this,n,this,o),this;if(u.length>1)return r.signUpOnEvents(u,this,n,this,o,!0),this}if(e.isArray(t))return e.each(t,function(e){this.on(e,n,s,a,o)},this),this;var h=this.getPrivateEvents(),f=h[t]||(h[t]=new i(t));if(f.getListenerIndex(n,s)>=0)return this;var c=f.listeners;s||(s=this),isNaN(o)&&(o=10);var g=this,p=function(e,r,i,o,l){var v={name:t,sender:this,date:new Date,caller:e,data:r,listenerData:a,stop:i,cancel:o,suspendMain:function(){l&&l.lock()},cancelMain:function(){l&&l.cancel()},resumeMain:function(){l&&l.unlock()},removeListener:function(){g.removeListener(t,n,s)}};return n.call(s,v,v.data),v.data};p.fn=n,p.scopeObj=s,p.priority=o;for(var m=c.length-1;m>=0;m--)if(c[m].priority<=o)return c.splice(m+1,0,p),this;return c.unshift(p),this},fire:function(){var e=!1,t=function(){e=!0},n=!1,r=function(){n=!0};return function(i,s,a,o){var l=this.getPrivateEvent(i),v=e,u=n;if(e=n=!1,l&&l.listeners.length)for(var h=l.listeners.slice(0),f=0;f<h.length;f++){var c=h[f].call(this,a,s,t,r,o);if("undefined"!=typeof c&&(s=c),e||n)break}var g=n||("undefined"==typeof s?!1:s);return e=v,n=u,g}}(),fireOnce:function(e,t,n){var r=this.fire(e,t,n);return delete this.getPrivateEvents()[e],r},removeListener:function(e,t,n){var r=this.getPrivateEvent(e);if(r){var i=r.getListenerIndex(t,n);i>=0&&r.listeners.splice(i,1)}},_removeListenersWithScope:function(e){var t=this.getPrivateEvents();for(var n in t)if(t[n].listeners){for(var r=t[n].listeners,i=[],s=0;s<r.length;s++)r[s].scopeObj!=e&&i.push(r[s]);i.length?t[n].listeners=i:(t[n].listeners=null,delete t[n])}},_removeListenersWithAllScopes:function(){var e=this.getPrivateEvents();for(var t in e)e[t].listeners&&(e[t].listeners=null,delete e[t])
},removeAllListeners:function(e){e?this._removeListenersWithScope(e):this._removeListenersWithAllScopes()},hasListeners:function(e){var t=this.getPrivateEvent(e);return t&&t.listeners.length>0},getListeners:function(){var e=this.getPrivateEvents(),t=[];for(var n in e){var r=e[n].listeners;if(r&&r.length>0){for(var i=[],s=0;s<r.length;s++){var a=r[s],o={name:"unknown",item:a};a.scopeObj&&a.scopeObj.bus&&a.scopeObj.bus.name?o.name=a.scopeObj.bus.name:a.scopeObj&&a.scopeObj.name&&(o.name=a.scopeObj.name),i.push(o)}t.push({name:n,items:r,count:r.length,listeners:i})}}return t},getListenersCount:function(){var e=this.getPrivateEvents(),t=0;for(var n in e)e[n].listeners&&(t+=e[n].listeners.length);return t},createChildEventEmitter:function(t){var n=this,r=["on","removeListener","removeAllListeners","hasListeners","getListeners","getListenersCount"],i=e.inject(r,function(e,t){return e[t]={writable:!1,value:n[t].bind(n)},e},{});return Object.create(n,e.extend(i,t))}};return s.addEventListener=s.on,s.unbind=s.removeAllListeners,r.prototype=s,r});