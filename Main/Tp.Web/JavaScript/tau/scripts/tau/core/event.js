define(["Underscore"],function(_){var a=function(){};a.implementOn=function(b){var c=a.prototype;for(var d in c)b[d]==undefined&&(b[d]=c[d]);return b};var b=function(a){var b={},c=a.split(":");return b.name=c[0],c.length>1&&(b.rule=c[1]),b};return a.signUpOnEvents=function(a,c,d,e,f){var g={},h=[],i={},j=function(a){g[a.name]=a;if(_(g).keys().length===h.length){var b={};for(var e=0,f=h.length;e<f;e++){var j=i[h[e]];b[j.name]=g[j.name];if(j.rule==="last")continue;delete g[j.name]}c[d].call(c,b)}};for(var k=0,l=a.length;k<l;k++){var m=b(a[k]),n=m.name;i[n]=m,h.push(n),e.on(n,j,c,null,f)}},a.subscribeOn=function(b){var c=_(b);_.each(c.keys(),function(c){var d=b[c];if(!d)return;if(_.isFunction(d.on)){var e=_(b).functionsExt();for(var f=0,g=e.length;f<g;f++){var h=e[f],i=h.split(" "),j=i[1],k=i[0],l;if(i.length<2)continue;i.length>2&&!isNaN(i[2])&&(l=i[2]);var m=j.split("+");k==c&&(m.length>1?a.signUpOnEvents(m,b,h,d,l):d.on(j,b[h],b,null,l))}}})},a.unSubscribe=function(a){var b=_(a);_.each(b.keys(),function(b){var c=a[b];c&&_.isFunction(c.removeAllListeners)&&c.removeAllListeners(a)})},a.prototype=function(){var b=function(a){var _=a.getPrivate&&a.getPrivate()||a._||(a._={});return _.events||(_.events={})},c=function(a){this.name=a,this.listeners=[]};return c.prototype={getListenerIndex:function(a,b){for(var c=0,d=this.listeners;c<d.length;c++)if(d[c].fn==a&&(d[c].scopeObj===b||!d[c].scopeObj&&(arguments.length==1||!b)))return c;return-1}},{on:function(d,e,f,g,h){if(_.isString(d)&&d.indexOf("+")>0){var i=d.split("+");a.signUpOnEvents(i,this,e,this,h);return}if(_.isArray(d)){var j=arguments.callee,k=this;_.each(d,function(a){j.call(k,a,e,f,g,h)});return}var l=b(this),m=l[d]||(l[d]=new c(d));if(m.getListenerIndex(e,f)<0){var n=m.listeners;f||(f=this),isNaN(h)&&(h=10);var o=this,p=function(a,b,c,h){var i={name:d,sender:this,caller:a,data:b,listenerData:g,stop:c,cancel:h,removeListener:function(){o.removeListener(d,e,f)}};return e.call(f,i),i.data};p.fn=e,p.scopeObj=f,p.priority=h;for(var q=n.length-1;q>=0;q--)if(n[q].priority<=h){n.splice(q+1,0,p);return}n.unshift(p)}return this},fire:function(){var a=!1,c=function(){a=!0},d=!1,e=function(){d=!0};return function(f,g,h){var i=b(this)[f],j=a,k=d;a=d=!1;if(i){var l=i.listeners;if(l.length){l=l.slice(0);for(var m=0;m<l.length;m++){var n=l[m].call(this,h,g,c,e);typeof n!="undefined"&&(g=n);if(a||d)break}}}var o=d||(typeof g=="undefined"?!1:g);return a=j,d=k,o}}(),fireOnce:function(a,c,d){var e=this.fire(a,c,d);return delete b(this)[a],e},removeListener:function(a,c,d){var e=b(this)[a];if(e){var f=e.getListenerIndex(c,d);f>=0&&e.listeners.splice(f,1)}},removeAllListeners:function(a){var c=b(this);for(var d in c)if(c[d].listeners)if(!a)delete c[d].listeners,delete c[d];else{var e=c[d].listeners,f=[];for(var g=0;g<e.length;g++)e[g].scopeObj!=a&&f.push(e[g]);c[d].listeners=f}},hasListeners:function(a){var c=b(this)[a];return c&&c.listeners.length>0},getListeners:function(){var a=b(this),c=[];for(var d in a){var e=a[d].listeners;if(e&&e.length>0){var f=[];for(var g=0;g<e.length;g++){var h=e[g],i={name:"unknown",item:h};h.scopeObj&&h.scopeObj.bus&&h.scopeObj.bus.name?i.name=h.scopeObj.bus.name:h.scopeObj&&h.scopeObj.name&&(i.name=h.scopeObj.name),f.push(i)}c.push({name:d,items:e,count:e.length,listeners:f})}}return c},getListenersCount:function(){var a=b(this),c=0;for(var d in a)a[d].listeners&&(c+=a[d].listeners.length);return c}}}(),a})