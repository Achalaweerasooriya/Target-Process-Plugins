define(["Underscore"],function(e){var t=function(e){var t=e.split(":"),n={name:t[0]};return t.length>1&&(n.rule=t[1]),n},n=function(t){return t.name?[t.data]:e.pluck(e.values(t),"data")},r=function(){};r.implementOn=function(e){var t=r.prototype;for(var n in t)void 0==e[n]&&(e[n]=t[n]);return e},r.extend=function(e){return r.implementOn(e.prototype),e},r.signUpOnEvents=function(r,i,s,a,o,v){for(var u={},l=[],c={},f=function(t){if(v)for(var a=e.indexOf(r,t.name),o=0;a>o;o++){var f=r[o].replace(":last","");if(!u.hasOwnProperty(f))return}if(u[t.name]=t,e.keys(u).length===l.length){for(var h={},p=0,g=l.length;g>p;p++){var m=c[l[p]];h[m.name]=u[m.name],"last"!==m.rule&&delete u[m.name]}h=[h].concat(n(h)),i[s].apply(i,h)}},h=0,p=r.length;p>h;h++){var g=t(r[h]),m=g.name;c[m]=g,l.push(m),a.on(m,f,i,null,o)}},r.subscribeOn=function(t){var n=[];for(var i in t)if(/\s/.test(i)){var s=t[i];s&&e.isFunction(s)&&n.push(i)}n.sort();for(var a=0,o=n.length;o>a;a++){var v=n[a],u=v.replace(/\s*\+\s*/g,"+").replace(/\s*>\s*/g,">"),l=u.split(/\s+/);if(!(l.length<2)){var c=l[0];if(e.has(t,c)){var f=t[c];if(f&&e.isFunction(f.on)){var h=l[1],p=h.split("+"),g=h.split(">");if(p.length>1&&g.length>1)throw new Error('"'+v+'": + and > can not be used together');var m;l.length>2&&!isNaN(l[2])&&(m=l[2]),p.length>1?r.signUpOnEvents(p,t,v,f,m,!1):g.length>1?r.signUpOnEvents(g,t,v,f,m,!0):f.on(h,t[v],t,null,m)}}}}},r.unSubscribe=function(t){e.each(t,function(n){n&&e.isFunction(n.removeAllListeners)&&n.removeAllListeners(t)})};var i=function(e){this.name=e,this.listeners=[]};i.prototype={getListenerIndex:function(e,t){for(var n=0,r=this.listeners;n<r.length;n++){var i=r[n];if(i.fn==e&&(i.scopeObj===t||!i.scopeObj&&!t))return n}return-1}};var s={getPrivateEvents:function(){var e=this.getPrivate&&this.getPrivate()||this._||(this._={});return e.events||(e.events={})},getPrivateEvent:function(e){var t=this.getPrivate&&this.getPrivate()||this._;return t&&t.events?t.events[e]:null},once:function(t,n,r,i,s){var a=e.bind(function(e){this.removeListener(t,e,r||this)
},this),o=function(){n.apply(this,e.toArray(arguments)),a(o)};this.on(t,o,r,i,s)},on:function(t,n,s,a,o){if(e.isString(t)&&t.indexOf("+")>0){var v=t.split("+");return r.signUpOnEvents(v,this,n,this,o),this}if(e.isArray(t)){var u=this;return e.each(t,function(e){u.on(e,n,s,a,o)}),this}var l=this.getPrivateEvents(),c=l[t]||(l[t]=new i(t));if(c.getListenerIndex(n,s)>=0)return this;var f=c.listeners;s||(s=this),isNaN(o)&&(o=10);var h=this,p=function(e,r,i,o,v){var u={name:t,sender:this,date:new Date,caller:e,data:r,listenerData:a,stop:i,cancel:o,suspendMain:function(){v&&v.lock()},cancelMain:function(){v&&v.cancel()},resumeMain:function(){v&&v.unlock()},removeListener:function(){h.removeListener(t,n,s)}};return n.call(s,u,u.data),u.data};p.fn=n,p.scopeObj=s,p.priority=o;for(var g=f.length-1;g>=0;g--)if(f[g].priority<=o)return f.splice(g+1,0,p),this;return f.unshift(p),this},fire:function(){var e=!1,t=function(){e=!0},n=!1,r=function(){n=!0};return function(i,s,a,o){var v=this.getPrivateEvent(i),u=e,l=n;if(e=n=!1,v){var c=v.listeners;if(c.length){c=c.slice(0);for(var f=0;f<c.length;f++){var h=c[f].call(this,a,s,t,r,o);if("undefined"!=typeof h&&(s=h),e||n)break}}}var p=n||("undefined"==typeof s?!1:s);return e=u,n=l,p}}(),fireOnce:function(e,t,n){var r=this.fire(e,t,n);return delete this.getPrivateEvents()[e],r},removeListener:function(e,t,n){var r=this.getPrivateEvent(e);if(r){var i=r.getListenerIndex(t,n);i>=0&&r.listeners.splice(i,1)}},removeAllListeners:function(e){var t=this.getPrivateEvents();for(var n in t)if(t[n].listeners)if(e){for(var r=t[n].listeners,i=[],s=0;s<r.length;s++)r[s].scopeObj!=e&&i.push(r[s]);t[n].listeners=i}else delete t[n].listeners,delete t[n]},hasListeners:function(e){var t=this.getPrivateEvent(e);return t&&t.listeners.length>0},getListeners:function(){var e=this.getPrivateEvents(),t=[];for(var n in e){var r=e[n].listeners;if(r&&r.length>0){for(var i=[],s=0;s<r.length;s++){var a=r[s],o={name:"unknown",item:a};a.scopeObj&&a.scopeObj.bus&&a.scopeObj.bus.name?o.name=a.scopeObj.bus.name:a.scopeObj&&a.scopeObj.name&&(o.name=a.scopeObj.name),i.push(o)
}t.push({name:n,items:r,count:r.length,listeners:i})}}return t},getListenersCount:function(){var e=this.getPrivateEvents(),t=0;for(var n in e)e[n].listeners&&(t+=e[n].listeners.length);return t},createChildEventEmitter:function(t){var n=this,r=["on","removeListener","removeAllListeners","hasListeners","getListeners","getListenersCount"],i=e.map(r,function(e){return{writable:!1,value:this[e].bind(this)}},this),s=e.extend(e.object(r,i),t);return Object.create(n,s)}};return s.addEventListener=s.on,s.unbind=s.removeAllListeners,r.prototype=s,r});