define(["jQuery","Underscore","libs/json2"],function($,_){return{find:function(list,$query){var result=[],self=this,filters=self._formWhere($query,"",function(operator,queryKey,value){return{operator:operator,key:queryKey,value:value}});return _.each(list,function(obj){var noMatch=!1;_.each(filters,function(filter){if(noMatch)return;var value=self._getObjectValue(obj,filter.key);_.isUndefined(value)&&(noMatch=!0),filter.operator.compare(value,filter.value)||(noMatch=!0)}),noMatch||result.push(obj)}),result},render:function($query,fnFormat){return this._getWhere($query,fnFormat)},_initializeDefaultRenders:function(operatorRenders){_.defaults(operatorRenders,{defaultRenderer:function(key,value){var self=this,outR=[];return _.isArray(value)||(value=[value]),_.each(value,function(v){outR.push("("+key+self.name+JSON.stringify(v)+")")}),outR},$in:function(key,value){var self=this,outR=[];_.isArray(value)||(value=[value]);var res=[];return _(value).each(function(vr){res.push(JSON.stringify(vr))}),outR.push("("+key+" "+self.name+" ["+res.join(",")+"])"),outR}})},_getObjectValue:function(obj,key){var path=key.split("."),value=obj;for(var i=0;i<path.length;i++){if(!obj.hasOwnProperty(path[i]))return undefined;value=obj[path[i]]}return value},_getQueryOperators:function(){var operatorRenders={};this._initializeDefaultRenders(operatorRenders);var operators={$in:{name:"in",compare:function(a,b){return _.any(b,function(v){return v==a})}},$ne:{name:"!=",compare:function(a,b){return a!=b}},$eq:{name:"==",compare:function(a,b){return a==b}}};return _.each(_(operators).keys(),function(op){var operator=operators[op];operator.render=operatorRenders.hasOwnProperty(op)?operatorRenders[op]:operatorRenders.defaultRenderer}),operators},_isQueryValueWithOperator:function(queryValue,operators){var keys=_(queryValue).keys();if(keys.length===0)return!1;var $operators=operators||this._getQueryOperators();return $operators.hasOwnProperty(keys[0])},_formWhere:function($query,prefix,fnForm){var filters=[];fnForm=fnForm||function(operator,queryKey,value){return operator.render(queryKey,value)};var self=this;prefix=prefix||"";var operators=self._getQueryOperators();return _.each(_($query).keys(),function(key){if(key[0]==="$")return;var value=$query[key],queryKey=prefix+key;if(_.isString(value)||_.isNumber(value)||_.isDate(value)||_.isArray(value)||_.isBoolean(value)||_.isNull(value)){var $operator=value===null?"$isNull":"$eq";filters=filters.concat(fnForm(operators[$operator],queryKey,value));return}if(self._isQueryValueWithOperator(value,operators)){_.each(_(value).keys(),function(op){filters=filters.concat(fnForm(operators[op],queryKey,value[op]))});return}var items=self._formWhere(value,key+".",fnForm);_.each(items,function(f){filters.push(f)})}),filters},_getWhere:function($query,formatFn){formatFn=formatFn||function(f){return"("+filters.join("and")+")"};var filters=this._formWhere($query);return filters.length===0?"":formatFn(filters)}}})