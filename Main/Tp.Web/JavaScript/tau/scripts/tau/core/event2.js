define(["Underscore"],function(e){var n=function(){};n.implementOn=function(e){var t=n.prototype;for(var r in t)void 0==e[r]&&(e[r]=t[r]);return e},n.parseName=function(n){n=e.trim(n),n=n.replace(/\s*\+\s*/g,"+").replace(/\s*>\s*/g,">");var t=!!n.match(/[+>]/),r=[n],i=!1;if(t){if(n.indexOf("+")>0&&n.indexOf(">")>0)throw new Error("Only + or > is accepted");r=n.split(/\s+/g)[0].split(/[+>]/g),i=n.indexOf(">")>0}return r=e.map(r,function(e){var n=e.split(":");return{name:n[0],rule:n[1]}}),{name:n,isCombination:t,isOrdered:i,parts:r,priority:0}},n.signUp=function(t,r,i,s){var a=n.parseName(r),o=a.parts;if(a.isCombination)for(var c=a.isOrdered,u=[],l=e.pluck(o,"name"),f=function(n){var t=e.indexOf(l,n.name);if(!(c&&e.compact(u).length<t)&&(u[t]||(u[t]=e.pick(o[t],"name","rule")),u[t].event=n,e.compact(u).length===o.length)){var r={};u=e.map(u,function(e){return r[e.name]=e.event,"last"===e.rule?e:void 0}),r=[r].concat(e.map(r,function(e){return e.data})),i.apply(s,r)}},v=0,p=o.length;p>v;v++)t._on(o[v].name,f,s,null,0);else t._on(o[0].name,i,s,null,a.priority)},n.subscribeOn=function(t){var r=e.functionsExt(t);e.each(t,function(i){if(i&&e.isFunction(i.on))for(var s=0,a=r.length;a>s;s++){var o=r[s],c=o.split(/\s/);n.signUp(i,c[1],t[o],t)}})},n.unSubscribe=function(n){e.each(n,function(t){t&&e.isFunction(t.removeAllListeners)&&t.removeAllListeners(n)})};var t=function(e){this.name=e,this.listeners=[]};t.prototype={getListenerIndex:function(e,n){for(var t=1==arguments.length||!n,r=0,i=this.listeners;r<i.length;r++){var s=i[r];if(s.fn==e&&(s.scopeObj===n||!s.scopeObj&&t))return r}return-1}};var r=function(e){var n=e.getPrivate&&e.getPrivate()||e._||(e._={});return n.events||(n.events={})},i={on:function(e,t,r){return n.signUp(this,e,t,r),this},_on:function(n,i,s,a,o){if(e.isArray(n)){var c=arguments.callee,u=this;return e.each(n,function(e){c.call(u,e,i,s,a,o)}),this}var l=r(this),f=l[n]||(l[n]=new t(n));if(f.getListenerIndex(i,s)>=0)return this;var v=f.listeners;s||(s=this),isNaN(o)&&(o=10);
var p=this,h=function(e,t,r,o,c){var u={name:n,sender:this,caller:e,data:t,listenerData:a,stop:r,cancel:o,suspendMain:function(){c&&c.lock()},cancelMain:function(){c&&c.cancel()},resumeMain:function(){c&&c.unlock()},removeListener:function(){p.removeListener(n,i,s)}};return i.call(s,u,u.data),u.data};h.fn=i,h.scopeObj=s,h.priority=o;for(var m=v.length-1;m>=0;m--)if(v[m].priority<=o)return v.splice(m+1,0,h),this;return v.unshift(h),this},fire:function(){var e=!1,n=function(){e=!0},t=!1,i=function(){t=!0};return function(s,a,o,c){var u=r(this)[s],l=e,f=t;if(e=t=!1,u){var v=u.listeners;if(v.length){v=v.slice(0);for(var p=0;p<v.length;p++){var h=v[p].call(this,o,a,n,i,c);if("undefined"!=typeof h&&(a=h),e||t)break}}}var m=t||("undefined"==typeof a?!1:a);return e=l,t=f,m}}(),fireOnce:function(e,n,t){var i=this.fire(e,n,t);return delete r(this)[e],i},removeListener:function(e,n,t){var i=r(this)[e];if(i){var s=i.getListenerIndex(n,t);s>=0&&i.listeners.splice(s,1)}},removeAllListeners:function(e){var n=r(this);for(var t in n)if(n[t].listeners)if(e){for(var i=n[t].listeners,s=[],a=0;a<i.length;a++)i[a].scopeObj!=e&&s.push(i[a]);n[t].listeners=s}else delete n[t].listeners,delete n[t]},hasListeners:function(e){var n=r(this)[e];return n&&n.listeners.length>0},getListeners:function(){var e=r(this),n=[];for(var t in e){var i=e[t].listeners;if(i&&i.length>0){for(var s=[],a=0;a<i.length;a++){var o=i[a],c={name:"unknown",item:o};o.scopeObj&&o.scopeObj.bus&&o.scopeObj.bus.name?c.name=o.scopeObj.bus.name:o.scopeObj&&o.scopeObj.name&&(c.name=o.scopeObj.name),s.push(c)}n.push({name:t,items:i,count:i.length,listeners:s})}}return n},getListenersCount:function(){var e=r(this),n=0;for(var t in e)e[t].listeners&&(n+=e[t].listeners.length);return n}};return i.addEventListener=i.on,n.prototype=i,n});