define(["Underscore"],function(e){var n=function(n){return n.name?[n.data]:e.pluck(e.values(n),"data")},t=function(){};return t.implementOn=function(e){var n=t.prototype;for(var r in n)void 0==e[r]&&(e[r]=n[r]);return e},t.parseName=function(n){n=e.trim(n),n=n.replace(/\s*\+\s*/g,"+").replace(/\s*>\s*/g,">");var t=!!n.match(/[+>]/),r=(n.match(/\s(\d+)$/)||0,[n]),i=!1;if(t){if(n.indexOf("+")>0&&n.indexOf(">")>0)throw new Error("Only + or > is accepted");r=n.split(/\s+/g)[0].split(/[+>]/g),i=n.indexOf(">")>0}return r=e.map(r,function(e){var n=e.split(":");return{name:n[0],rule:n[1]}}),{name:n,isCombination:t,isOrdered:i,parts:r,priority:0}},t.signUp=function(n,r,i,s){var a=t.parseName(r),o=a.parts;if(a.isCombination)for(var c=a.isOrdered,u=[],f=e.pluck(o,"name"),l=function(n){var t=e.indexOf(f,n.name);if(!(c&&e.compact(u).length<t)&&(u[t]||(u[t]=e.pick(o[t],"name","rule")),u[t].event=n,e.compact(u).length===o.length)){var r={};u=e.map(u,function(e){return r[e.name]=e.event,"last"===e.rule?e:void 0}),r=[r].concat(e.map(r,function(e){return e.data})),i.apply(s,r)}},p=0,v=o.length;v>p;p++)n._on(o[p].name,l,s,null,0);else n._on(o[0].name,i,s,null,a.priority)},t.subscribeOn=function(n){var r=e.functionsExt(n);e.each(n,function(i){if(i&&e.isFunction(i.on))for(var s=0,a=r.length;a>s;s++){var o=r[s],c=o.split(/\s/);t.signUp(i,c[1],n[o],n)}})},t.unSubscribe=function(n){e.each(n,function(t){t&&e.isFunction(t.removeAllListeners)&&t.removeAllListeners(n)})},t.prototype=function(){var r=function(e){var n=e.getPrivate&&e.getPrivate()||e._||(e._={});return n.events||(n.events={})},i=function(e){this.name=e,this.listeners=[]};i.prototype={},i.prototype.getListenerIndex=function(e,n){for(var t=0,r=this.listeners;t<r.length;t++)if(!(r[t].fn!=e||r[t].scopeObj!==n&&(r[t].scopeObj||1!=arguments.length&&n)))return t;return-1};var s={on:function(e,n,r){return t.signUp(this,e,n,r),this},_on:function(t,s,a,o,c){if(e.isArray(t)){var u=arguments.callee,f=this;return e.each(t,function(e){u.call(f,e,s,a,o,c)}),this}var l=r(this),p=l[t]||(l[t]=new i(t));if(p.getListenerIndex(s,a)<0){var v=p.listeners;a||(a=this),isNaN(c)&&(c=10);var h=this,m=function(e,r,i,c,u){var f={name:t,sender:this,caller:e,data:r,listenerData:o,stop:i,cancel:c,suspendMain:function(){u&&u.lock()},cancelMain:function(){u&&u.cancel()},resumeMain:function(){u&&u.unlock()},removeListener:function(){h.removeListener(t,s,a)}},l=[f].concat(n(f));return s.apply(a,l),f.data};m.fn=s,m.scopeObj=a,m.priority=c;for(var d=v.length-1;d>=0;d--)if(v[d].priority<=c)return v.splice(d+1,0,m),this;v.unshift(m)}return this},fire:function(){var e=!1,n=function(){e=!0},t=!1,i=function(){t=!0};return function(s,a,o,c){var u=r(this)[s],f=e,l=t;if(e=t=!1,u){var p=u.listeners;if(p.length){p=p.slice(0);for(var v=0;v<p.length;v++){var h=p[v].call(this,o,a,n,i,c);if("undefined"!=typeof h&&(a=h),e||t)break}}}var m=t||("undefined"==typeof a?!1:a);return e=f,t=l,m}}(),fireOnce:function(e,n,t){var i=this.fire(e,n,t);return delete r(this)[e],i},removeListener:function(e,n,t){var i=r(this)[e];if(i){var s=i.getListenerIndex(n,t);s>=0&&i.listeners.splice(s,1)}},removeAllListeners:function(e){var n=r(this);for(var t in n)if(n[t].listeners)if(e){for(var i=n[t].listeners,s=[],a=0;a<i.length;a++)i[a].scopeObj!=e&&s.push(i[a]);n[t].listeners=s}else delete n[t].listeners,delete n[t]},hasListeners:function(e){var n=r(this)[e];return n&&n.listeners.length>0},getListeners:function(){var e=r(this),n=[];for(var t in e){var i=e[t].listeners;if(i&&i.length>0){for(var s=[],a=0;a<i.length;a++){var o=i[a],c={name:"unknown",item:o};o.scopeObj&&o.scopeObj.bus&&o.scopeObj.bus.name?c.name=o.scopeObj.bus.name:o.scopeObj&&o.scopeObj.name&&(c.name=o.scopeObj.name),s.push(c)}n.push({name:t,items:i,count:i.length,listeners:s})}}return n},getListenersCount:function(){var e=r(this),n=0;for(var t in e)e[t].listeners&&(n+=e[t].listeners.length);return n}};return s.addEventListener=s.on,s}(),t});