define(["Underscore","tau/core/class"],function(_,a){var b=function(){},c=a.extend({init:function(a){a=a||{};var b=[];a.state||b.push("state"),a.service||b.push("service");if(b.length>0)throw"State manager should be initialized with following parameters: ["+b.join(",")+"]";this.subscriptions={},this.cfg=a},get:function(a){var c=this;if(!a.id)throw"StateManager.get operation requires parameter [id]";var d=_.defaults(a,{fields:[],callback:b}),e=this.cfg.service;return e.get(d),c},set:function(a){var c=this;if(!a.id)throw"StateManager.set operation requires parameter [id]";var d=_.defaults(a,{set:{},callback:b}),e=this.cfg.service;return e.set(d),c},update:function(a){var b=this,c=this.cfg.state,d=[];_(a).chain().keys().each(function(e){d.push(e);var f=c[e]||{},g=a[e];if(_.isString(g)||_.isString(f))return;var h=_(f).keys(),i=_(g).keys();_(_.union(h,i)).each(function(a){if(g[a]!==f[a]){var c=f.hasOwnProperty(a)?f[a]:null,d=g.hasOwnProperty(a)?g[a]:null;b.applyChanges({paramId:e,fieldName:a,value:d,delta:{prev:c,curr:d}})}})}),_(c).chain().keys().difference(d).each(function(a){var d=c[a];if(_.isString(d))return;_(d).chain().keys().each(function(c){b.applyChanges({paramId:a,fieldName:c,value:null,delta:{prev:d[c],curr:null}})})}),b.cfg.state=a},applyChanges:function(a){var b=this.subscriptions,c=(b[a.paramId]||{})[a.fieldName]||[];for(var d=0,e=c.length;d<e;d++){var f=c[d];f.callback.call(f.scope,a)}},bind:function(a){var b=a.paramId,c=a.fieldName,d=a.callback,e=a.listener,f=this.subscriptions;return f[b]=f[b]||{},f[b][c]=f[b][c]||[],f[b][c].push({callback:d,scope:e}),this},unbind:function(a){var b=this.subscriptions,c=_(b).keys();for(var d=0,e=c.length;d<e;d++){var f=c[d],g=_(b[f]).keys();for(var h=0,i=g.length;h<i;h++){var j=g[h],k=b[f][j];for(var l=0;l<k.length;)k[l].scope===a?k.splice(l,1):++l;b[f][j].length===0&&delete b[f][j]}_(b[f]).keys()===0&&delete b[f]}}});return c})