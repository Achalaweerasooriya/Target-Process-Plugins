define(["Underscore","tau/core/tau"],function(_,tau){var tauExtension=_.extend(tau,{ref:function(a,b){var c={};return c[a]=b,c},list:function(a,b){var c=tau.ref(a,b);return c.list=!0,c},getNextPage:function(a,b,c){c=c||[];var d={holder:a,url:b,fields:c};return a.getNextPage=function(){return d},d},parseFieldsFromString:function(value){var self=this;value=value.replace(/([\w-]+)\[+/ig,'{"$1":['),value=value.replace(/(\])/ig,"]}"),value=value.substr(0,value.length-1),value=value.replace(/([\w-]+)(,|\])/ig,"'$1'$2");var fields=eval("(function () { return "+value+";})();"),toLowerCase=function(a){var b=a.split("-");if(b.length>1){var c=[];return _.each(b,function(a){c.push(toLowerCase(a))}),c.join("-")}return a.charAt(0).toLowerCase()+a.substr(1)},formatFields=function(a){var b=[];return _.each(a,function(a){if(self.header.isSimple(a)){b.push(toLowerCase(a));return}var c={},d=self.header.getFieldName(a);c[toLowerCase(d)]=formatFields(a[d]),b.push(c)}),b};return fields=_.mergeFields([],fields),formatFields(fields)},formatObject:function(a,b){var c=this,d={data:[],nextPages:[]};if(_.isUndefined(a)||_.isNull(a))return d.data=null,d;if(typeof a!="object")return d.data=a,d;b=b?b:"Lower";var e=function(a){return a.charAt(0)["to"+b+"Case"]()+a.substr(1)};if(a&&(a.hasOwnProperty("Items")||a.hasOwnProperty("items"))){var f=a.next||a.Next;f&&d.nextPages.push(c.getNextPage(d.data,f,[])),a=a.Items||a.items}if(_.isArray(a))return _.each(a,function(a){var e=c.formatObject(a,b);d.nextPages=d.nextPages.concat(e.nextPages||[]),d.data.push(e.data)}),d;var g={};return _.each(_.keys(a),function(f){var h=e(f),i=h.split("-");if(i.length>1){var j=[];_.each(i,function(a){j.push(e(a))}),h=j.join("-")}var k=c.formatObject(a[f],b);d.nextPages=d.nextPages.concat(k.nextPages||[]),g[h]=k.data}),d.data=g,d},header:{getFieldName:function(a){return _.getFieldName(a)},isSimple:function(a){return _.isString(a)},isList:function(a){return a.list===!0}}});return tauExtension})