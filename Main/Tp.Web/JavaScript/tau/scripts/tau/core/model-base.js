define(["Underscore","tau/core/extension.base.stateful"],function(e,t){var n=t.extend({isCommandForEntityInContext:function(e){var t=e.data,n=t.cmd?t.cmd.config.id:t.obj?t.obj.id:null;return n===this.config.context.entity.id},isPropertyChanged:function(t,n){var i=n.changes,r=n.cmd&&n.cmd.config.$set||{};return e.any(t,function(e){return i&&i.hasOwnProperty(e)||r.hasOwnProperty(e)})},attachToChangePropertiesOfCurrentEntity:function(t){var n=e.isArray(t)?t:[t],i=this.config.context.entity.id,r=this,o=function(e){var t=e.data;r.isPropertyChanged(n,t)&&r.fire("propertyChanged",t)},a=function(e){var t=e.data;r.isPropertyChanged(n,t)&&r.fire("beforeChangeProperty",t)},s=function(e){var t=e.data;t.cmd.config.id==i&&r.isPropertyChanged(n,t)&&r.fire("propertyChanged",t)};r.store.unbind(r);var c=this.config.context.entity.entityType.name||"general";r.store.on({type:c,eventName:"afterSave",filter:{id:i},listener:r},o),r.store.on({type:c,eventName:"beforeSave",filter:{id:i},listener:r},a),r.store.on({eventName:"failure",listener:r},s),t[this.propertyName]=[this.displayField,this.valueField]},"bus evictData":function(){var e=this.config.entity||this.config.context.entity,t=e.id;this.store.config.proxy.evictPersistedObject(t,"context"),this.store.config.proxy.evictPersistedObject(t,e.type||e.entityType.name)}});return n});