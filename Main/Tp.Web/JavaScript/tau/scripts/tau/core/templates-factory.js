define(["Underscore","jQuery","tau/core/class","tau/nls/translator","tau/core/termProcessor","libs/caja/caja-sanitizer","tau/services/service.features"],function(e,t,r,n,s,i,o){var a,u=r.extend({config:null,init:function(e){this.config=e},render:function(t,r){var n=this.config,i=n.customFunctions.term;n.customFunctions.term=t&&t.context&&t.context.getTerms?function(r,n,i){var o;if(i)o=i.getTerm(r,n);else{var a=t.context.getTerms();o=s.getTerm(r,n,a)}return e.asString(o)}:a.jqote2customFunctions.term,n.pre&&(r=n.pre(r));var o=n.jqotecmpl.call(r,0,0,[r],n.customFunctions);return n.post&&(o=n.post(o,r)),n.customFunctions.term=i,o},bind:function(e,r){return t(this.render(e,r))},bindPure:function(e,t){return this.render(e,t)}});return a={templates:{},termProcessor:new s,features:new o,jqote2customFunctions:{sub:function(t,r){var n=a.get(t);e.isArray(r)||(r=[r]);for(var s=[],i=0,o=r.length;o>i;i++)s.push(n.render(null,r[i]));return s.join("")},term:function(t,r,n){return n||(n=a.termProcessor),e.asString(n.getTerm(t,r))},replaceTermTags:function(t,r){return r?a.termProcessor.replaceTermTags(t,r):e.asString(a.termProcessor.replaceTermTags(t))},isFeatureEnabled:function(e){return a.features.isEnabled(e)},cond:function(e,t,r){return(e?t:r)||""},uid:function(t){return e.uniqueId(t||"uid")},_:e,$:t,translate:n,T:n,sanitize:i},setTermProcessor:function(e){this.termProcessor=e},getTermProcessor:function(){return this.termProcessor},get:function(e){var t=this.templates[e];if(!t)throw new Error('Template "'+e+'" was not registered.');return this[t.engine+".get"](e)},"jquery.get":function(r){var n=this;if(!t.template.hasOwnProperty(r))throw new Error('jQuery template "'+r+'" was not found.');var s=function(r,n){var i=t.template(r);n=n||this.data,e.isArray(n)||(n=[n]);for(var o=[],a=0,u=n.length;u>a;a++){var c=i(t,{data:n[a],nest:s});o.push(c.join(""))}return o.join("")};return{render:function(e,t){return s(r,t)},bind:function(e,s){for(var i={},o=n.templates[r],a=o.tags||[],u=0;u<a.length;u++){var c=a[u];
c.register(e,i)}var m=t.template[r];return t.tmpl(m,s,i)}}},"jqote2.get":function(e){var t=this.templates[e];if(!t.jqotecmpl)throw new Error('Template "'+e+'" was not compiled.');return new u(t)},registerRecursively:function(r,n){n=n||{tags:[]};var s=this.templates[r];if(!s)throw new Error('Template "'+r+'" was not found.');s.tags&&(n.tags=n.tags.concat(s.tags)),t.template.hasOwnProperty(r)||(e.each(s.dependencies||[],function(e){this.registerRecursively(e,n)},this),s.tags=n.tags,t.template(r,s.markup))},"jquery.register":function(e){this.templates[e.name]=e,this.registerRecursively(e.name)},"jqote2.register":function(r){if(r.pre&&!e.isFunction(r.pre))throw new Error('Error in template "'+r.name+'": field "pre" is not a function');if(r.post&&!e.isFunction(r.post))throw new Error('Error in template "'+r.name+'": field "post" is not a function');try{r.jqotecmpl=t.jqotec(r.markup)}catch(n){throw new Error('Error in template "'+r.name+'": '+n.message)}r.customFunctions=e.extend({},r.customFunctions||{},this.jqote2customFunctions),this.templates[r.name]=r},register:function(t){return t.markup=e.isArray(t.markup)?t.markup.join(""):t.markup,t.engine=t.engine||"jquery",this[t.engine+".register"](t),{name:t.name,options:t.options||{},get:this.get.bind(this,t.name),render:function(e,t){return this.get().bind(t,e)},renderToString:function(e,t){return this.get().bindPure(t,e)}}}}});