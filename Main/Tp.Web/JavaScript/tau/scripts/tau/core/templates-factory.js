define(["Underscore","jQuery","tau/nls/translator","tau/core/termProcessor","libs/caja/caja-sanitizer"],function(e,r,t,n,s){var i={templates:{},termProcessor:new n,jqote2customFunctions:{sub:function(r,t){var n=i.get(r);e.isArray(t)||(t=[t]);for(var s=[],o=0,a=t.length;a>o;o++)s.push(n.render(null,t[o]));return s.join("")},term:function(r,t,n){return n||(n=i.termProcessor),e.asString(n.getTerm(r,t))},replaceTermTags:function(r,t){return t?i.termProcessor.replaceTermTags(r,t):e.asString(i.termProcessor.replaceTermTags(r))},cond:function(e,r,t){return(e?r:t)||""},uid:function(r){return e.uniqueId(r||"uid")},_:e,$:r,translate:t,T:t,sanitize:s},setTermProcessor:function(e){this.termProcessor=e},getTermProcessor:function(){return this.termProcessor},get:function(e){var r=this.templates[e];if(!r)throw new Error('Template "'+e+'" was not registered.');return this[r.engine+".get"](e)},"jquery.get":function(t){var n=this;if(!r.template.hasOwnProperty(t))throw new Error('jQuery template "'+t+'" was not found.');var s=function(t,n){var i=r.template(t);n=n||this.data,e.isArray(n)||(n=[n]);for(var o=[],a=0,u=n.length;u>a;a++){var c=i(r,{data:n[a],nest:s});o.push(c.join(""))}return o.join("")};return{render:function(e,r){return s(t,r)},bind:function(e,s){for(var i={},o=n.templates[t],a=o.tags||[],u=0;u<a.length;u++){var c=a[u];c.register(e,i)}var m=r.template[t];return r.tmpl(m,s,i)}}},"jqote2.get":function(t){var n=this.templates[t];if(!n.jqotecmpl)throw new Error('Template "'+t+'" was not compiled.');return{config:n,render:e.bind(function(r,t){var s=n.customFunctions||{};e.extend(s,this.jqote2customFunctions),e.isFunction(n.pre)&&(t=n.pre(t));var i=n.jqotecmpl.call(t,0,0,[t],s);return e.isFunction(n.post)&&(i=n.post(i,t)),i},this),bind:function(e,t){var n=this.render(e,t);return r(n)},bindPure:function(e,r){return this.render(e,r)}}},registerRecursively:function(t,n){n=n||{tags:[]};var s=this.templates[t];if(!s)throw new Error('Template "'+t+'" was not found.');s.tags&&(n.tags=n.tags.concat(s.tags)),r.template.hasOwnProperty(t)||(e.each(s.dependencies||[],function(e){this.registerRecursively(e,n)
},this),s.tags=n.tags,r.template(t,s.markup))},"jquery.register":function(e){this.registerRecursively(e.name)},"jqote2.register":function(e){try{e.jqotecmpl=r.jqotec(e.markup)}catch(t){throw new Error('Error in template "'+e.name+'": '+t.message)}},register:function(r){r.markup=e.isArray(r.markup)?r.markup.join(""):r.markup,r.engine=r.engine||"jquery";var t=r.name;return this.templates[t]=r,this[r.engine+".register"](r),{name:t,options:r.options||{},get:this.get.bind(this,t),render:function(e){return this.get(t).bind({},e)}.bind(this)}}};return i});