define(["Underscore","jQuery","tau/nls/translator","tau/core/termProcessor","libs/caja/caja-sanitizer","tau/services/service.features"],function(e,r,t,n,s,i){var o={templates:{},termProcessor:new n,features:new i,jqote2customFunctions:{sub:function(r,t){var n=o.get(r);e.isArray(t)||(t=[t]);for(var s=[],i=0,a=t.length;a>i;i++)s.push(n.render(null,t[i]));return s.join("")},term:function(r,t,n){return n||(n=o.termProcessor),e.asString(n.getTerm(r,t))},replaceTermTags:function(r,t){return t?o.termProcessor.replaceTermTags(r,t):e.asString(o.termProcessor.replaceTermTags(r))},isFeatureEnabled:function(e){return o.features.isEnabled(e)},cond:function(e,r,t){return(e?r:t)||""},uid:function(r){return e.uniqueId(r||"uid")},_:e,$:r,translate:t,T:t,sanitize:s},setTermProcessor:function(e){this.termProcessor=e},getTermProcessor:function(){return this.termProcessor},get:function(e){var r=this.templates[e];if(!r)throw new Error('Template "'+e+'" was not registered.');return this[r.engine+".get"](e)},"jquery.get":function(t){var n=this;if(!r.template.hasOwnProperty(t))throw new Error('jQuery template "'+t+'" was not found.');var s=function(t,n){var i=r.template(t);n=n||this.data,e.isArray(n)||(n=[n]);for(var o=[],a=0,u=n.length;u>a;a++){var c=i(r,{data:n[a],nest:s});o.push(c.join(""))}return o.join("")};return{render:function(e,r){return s(t,r)},bind:function(e,s){for(var i={},o=n.templates[t],a=o.tags||[],u=0;u<a.length;u++){var c=a[u];c.register(e,i)}var m=r.template[t];return r.tmpl(m,s,i)}}},"jqote2.get":function(t){var s=this.templates[t];if(!s.jqotecmpl)throw new Error('Template "'+t+'" was not compiled.');return{config:s,render:e.bind(function(r,t){var i=s.customFunctions||{};e.extend(i,this.jqote2customFunctions),r&&r.context&&r.context.getTerms&&(i.term=function(t,s,i){var o;if(i)o=i.getTerm(t,s);else{var a=r.context.getTerms();o=n.getTerm(t,s,a)}return e.asString(o)}),e.isFunction(s.pre)&&(t=s.pre(t));var o=s.jqotecmpl.call(t,0,0,[t],i);return e.isFunction(s.post)&&(o=s.post(o,t)),o
},this),bind:function(e,t){var n=this.render(e,t);return r(n)},bindPure:function(e,r){return this.render(e,r)}}},registerRecursively:function(t,n){n=n||{tags:[]};var s=this.templates[t];if(!s)throw new Error('Template "'+t+'" was not found.');s.tags&&(n.tags=n.tags.concat(s.tags)),r.template.hasOwnProperty(t)||(e.each(s.dependencies||[],function(e){this.registerRecursively(e,n)},this),s.tags=n.tags,r.template(t,s.markup))},"jquery.register":function(e){this.registerRecursively(e.name)},"jqote2.register":function(e){try{e.jqotecmpl=r.jqotec(e.markup)}catch(t){throw new Error('Error in template "'+e.name+'": '+t.message)}},register:function(r){r.markup=e.isArray(r.markup)?r.markup.join(""):r.markup,r.engine=r.engine||"jquery";var t=r.name;return this.templates[t]=r,this[r.engine+".register"](r),{name:t,options:r.options||{},get:this.get.bind(this,t),render:function(e,r){return this.get().bind(r,e)},renderToString:function(e,r){return this.get().bindPure(r,e)}}}};return o});