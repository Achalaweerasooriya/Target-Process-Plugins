define(["Underscore","tau/core/event"],function(e,t){var n=function(){t.call(this,arguments)};e.extend(n,t),e.extend(n.prototype,t.prototype);var o=null,s=function(n){var s=e.clone(n.originalArguments);s[0]="after_"+s[0],s[1]=s[1]||{},s[2]=s[2]||{},o&&0!=o.length?(o.push({arguments:n.originalArguments,scope:n.scope}),o.push({arguments:s,scope:n.scope})):(t.prototype.fire.apply(n.scope,n.originalArguments),t.prototype.fire.apply(n.scope,s))};return n.prototype.fire=function(){var n=e.toArray(arguments),c=e.clone(n);c[0]="before_"+c[0],c[1]=c[1]||{},c[2]=c[2]||{};var i=e.clone(n);if(i[0]="after_"+i[0],i[1]=i[1]||{},i[2]=i[2]||{},c[3]={lockCount:0,canceled:!1,originalArguments:n,scope:this,unlockedDelegate:function(){},setUnlockDelegate:function(e){this.unlockedDelegate=e},isCanceled:function(){return this.canceled},isLocked:function(){return this.lockCount>0},cancel:function(){this.canceled=!0},lock:function(){this.lockCount++},unlock:function(){this.lockCount--,0==this.lockCount&&(this.unlockedDelegate(this),delete this.originalArguments,delete this.scope)}},e.isNull(o)){for(o=[],o.push({arguments:c,scope:this}),o.push({arguments:n,scope:this}),o.push({arguments:i,scope:this});o.length>0;){var r=o.shift(),u=r.arguments,l=r.scope;t.prototype.fire.apply(l,u);var a=u&&u[3];a&&(a.isLocked()||a.isCanceled())&&(o.splice(0,2),0==a.isCanceled()&&a.setUnlockDelegate(s))}o=null}else o.push({arguments:c,scope:this}),o.push({arguments:n,scope:this}),o.push({arguments:i,scope:this})},n});