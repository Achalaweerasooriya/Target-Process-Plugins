define(["Underscore","tau/core/class"],function(_,BaseClass){var Factory=BaseClass.extend({init:function(configurator,options){this.serviceContainer=configurator,this.storage=configurator.getRestStorage(),this.options={groupName:"boards"},this.options=_.defaults(options||{},this.options),this.defaults={groupName:this.options.groupName,name:"New Board",zoomLevel:3,viewMode:"board",hierarchyMode:"inside",createdAt:null,isDraft:!0,edit:!1,ownerId:null,isShared:!1,menuIsVisible:!0,menuNumericPriority:999999,cells:{types:[],filter:""}}},createDefault:function(){var definition=_.cloneDeep(this.defaults),ts=+(new Date);return definition.createdAt=(new Date).toGMTString(),definition.menuNumericPriority=parseInt(ts,10),definition},createByOwner:function(owner){if(!_.isObject(owner))throw new Error("Should be owner");var definition=_.cloneDeep(this.defaults),ts=+(new Date);return definition.createdAt=(new Date).toGMTString(),definition.ownerId=owner.id,definition.edit=!0,definition.menuNumericPriority=parseInt(ts,10),definition},cloneDefinition:function(def){var configurator=this.serviceContainer,inheritedFields=["x","y","cells","limits","zoomLevel","viewMode"],r=this.createDefault(),n=_.pick(_.deepClone(def),inheritedFields);return n.isShared=!1,n.ownerId=configurator.getLoggedUser().id,n.name=def.name+" Cloned",n.edit=!0,r=_.extend(r,n),r},findDefault:function(user){return this.storage.select(this.options.groupName,{$where:"(ownerId == "+user.id+' or publicData.isShared == "true")',$fields:["key","ownerId","publicData.name","publicData.isShared","userData.menuIsVisible AS userMenuIsVisible","userData.menuNumericPriority AS userMenuNumericPriority","publicData.menuIsVisible","publicData.menuNumericPriority","publicData.acid"]}).pipe(function(result){var boards=result.data||[],board=_.chain(boards).map(function(v,k){return _.extend(v,{id:v.key,priority:v.userMenuNumericPriority||v.menuNumericPriority||0,visibility:v.userMenuIsVisible||v.menuIsVisible||0,acid:v.acid})}).sortBy(function(v){return v.visibility?v.priority-1:v.priority+99999}).first().value();return board})},findLast:function(id,owner){return this.storage.select(this.options.groupName,{$where:'key="'+id+'" and (ownerId == '+owner.id+' or publicData.isShared == "true")',$fields:["key","publicData.acid"]}).pipe(function(result){var boards=result.data||[],board=boards[0];return board&&(board.id=board.key),board})},getById:function(id,user){var defer=$.Deferred();return this.storage.data(this.options.groupName,id).then(function(result){var board=result.data||{};board.key&&(board.ownerId==user.id||board.publicData.isShared)?(board.id=board.key,defer.resolve(board)):defer.reject()}),defer}});return Factory})