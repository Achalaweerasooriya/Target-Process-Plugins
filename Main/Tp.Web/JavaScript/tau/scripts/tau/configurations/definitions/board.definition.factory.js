define(["Underscore","jQuery","tau/core/class","tau/utils/timeline/utils.timeline.date-range"],function(e,t,i,r){var n=i.extend({init:function(t,i){this.serviceContainer=t,this.storage=t.getRestStorage(),this.boardService=t.getBoardApiService(),this.boardAccess=t.getBoardAccessService(),this.options={groupName:"boards"},this.options=e.defaults(i||{},this.options),this.defaults={groupName:this.options.groupName,name:"New View",zoomLevel:{board:3},viewMode:"board",hierarchyMode:"inside",createdAt:null,isDraft:!0,edit:!1,ownerIds:[],isShared:!1,menuIsVisible:!0,menuNumericPriority:999999,prioritization:{mode:"shift"},cells:{types:[],filter:"",useFilter:!1},timelineSettings:{showPlannedInPast:!1,showForecast:!1}}},getLoggedUser:function(){return this.serviceContainer.getLoggedUser()},createDefault:function(){var t=new Date,i=e.cloneDeep(this.defaults);return i.createdAt=t.toGMTString(),i.menuNumericPriority=t.getTime(),i.timelineGlobalDateRange=r.createDefault().toISOString(),i},createByOwner:function(t){if(!e.isObject(t))throw new Error("Should be owner");var i=this.createDefault();return i.ownerIds=[t.id],i.edit=!0,i},createForLoggedUser:function(){return this.createByOwner(this.getLoggedUser())},createBoard:function(t){t=t||this.createForLoggedUser();var i=e.clone(t);return i.menuIsVisible=!0,this.boardService.createBoard(i).then(function(e){return t.id=e.data.key,t})},cloneDefinition:function(t,i){return this.getById(t).then(function(t){var r=["x","y","cells","limits","zoomLevel","viewMode","prioritization","cardSettings","isCustomizeDisabled","timelineLocalDateRange","timelineGlobalDateRange","timelineSettings"],n=this.createDefault(),o=e.pick(e.deepClone(t),r,i);o.isShared=!1,o.ownerIds=[this.getLoggedUser().id],o.name=t.name+" Cloned",o.edit=!0;var a=e.extend(n,o);return a}.bind(this))},findDefaultForLoggedUser:function(){return this.findDefault(this.getLoggedUser())},findDefault:function(t){return this.boardService.getBoardsForUser(t.id).then(function(t){var i=t.data||{},r=i.items||[];return e.chain(r).map(function(t){return e.extend(t,t.publicData,t.userData),e.extend(t,{id:t.key,priority:t.menuNumericPriority||0,visibility:t.menuIsVisible||0})}).sortBy(function(e){return e.visibility?e.priority-1:e.priority+99999}).first().value()})},findLast:function(e){var i=t.Deferred();return this.boardService.getBoardData(e).done(function(e){var t=e.data||{};t&&(t.id=t.key),i.resolve(t)}).fail(function(){i.resolve(null)}),i.promise()},getById:function(e){return this.boardService.getBoardData(e).then(function(e){var t=e.data||{};return t.id=t.key,t}.bind(this))}});return n});