define(["Underscore","jQuery","tau/core/class","tau/utils/timeline/utils.timeline.date-range"],function(e,t,i,r){return i.extend({init:function(t,i){this.serviceContainer=t,this.storage=t.getRestStorage(),this.boardService=t.getBoardApiService(),this._viewsMenuService=t.getViewsMenuService(),this.boardAccess=t.getBoardAccessService(),this.options={groupName:"boards"},this.options=e.defaults(i||{},this.options),this.defaults={groupName:this.options.groupName,name:"New View",zoomLevel:{board:3},viewMode:"board",hierarchyMode:"inside",createdAt:null,isDraft:!0,edit:!1,ownerIds:[],isShared:!1,menuIsVisible:!0,menuNumericPriority:999999,prioritization:{mode:"shift"},cells:{types:[],filter:"",useFilter:!1},timelineSettings:{showPlannedInPast:!1,showForecast:!0}}},getLoggedUser:function(){return this.serviceContainer.getLoggedUser()},createDefault:function(){var t=new Date,i=e.cloneDeep(this.defaults);return i.createdAt=t.toGMTString(),i.menuNumericPriority=t.getTime(),i.timelineGlobalDateRange=r.createDefault().toISOString(),i},_createDefaultGroupData:function(){var e=new Date;return{name:"New Group",createdAt:e.toGMTString(),isShared:!1,menuIsVisible:!0,menuNumericPriority:e.getTime()}},createByOwner:function(t){if(!e.isObject(t))throw new Error("Should be owner");var i=this.createDefault();return i.ownerIds=[t.id],i.edit=!0,i},createForLoggedUser:function(){return this.createByOwner(this.getLoggedUser())},createBoard:function(t){t=t||this.createForLoggedUser();var i=e.clone(t);return i.menuIsVisible=!0,this.boardService.createViewMenuItem(i).then(function(e){return t.id=e.data.key,t})},createViewGroup:function(t){var i=e.defaults(e.deepClone(t)||{},this._createDefaultGroupData());return this._viewsMenuService.groupsApi.createViewMenuItem(i)},cloneDefinition:function(t,i){return this.getById(t).then(function(t){var r=["x","y","cells","limits","zoomLevel","viewMode","prioritization","cardSettings","timelineLocalDateRange","timelineGlobalDateRange","timelineSettings"],n=this.createDefault(),a=e.pick(e.deepClone(t),r,i);
a.isShared=!1,a.ownerIds=[this.getLoggedUser().id],a.name=t.name+" Cloned",a.edit=!0;var o=e.extend(n,a);return o}.bind(this))},findDefaultForLoggedUser:function(){return this.findDefault(this.getLoggedUser())},findDefault:function(t){return this._viewsMenuService.getBoardsForUser(t.id).then(function(t){var i=t.data||{},r=i.items||[];return e.chain(r).map(function(t){return e.extend(t,t.publicData,t.userData),e.extend(t,{id:t.key,priority:t.menuNumericPriority||0,visibility:t.menuIsVisible||0})}).sortBy(function(e){return e.visibility?e.priority-1:e.priority+99999}).first().value()})},findLast:function(e){var i=t.Deferred();return this.boardService.getBoardData(e).done(function(e){var t=e.data||{};t&&(t.id=t.key),i.resolve(t)}).fail(function(){i.resolve(null)}),i.promise()},getById:function(e){return this.boardService.getBoardData(e).then(function(e){var t=e.data||{};return t.id=t.key,t}.bind(this))}})});