define(["Underscore","tau/core/class","tau/core/termProcessor","tau/components/extensions/comments/extensions.comments.refresher"],function(_,Class,TermProcessor,CommentRefresher){var Config=Class.extend({init:function(appConfig){var terms=appConfig.context.getTerms();this.termProcessor=new TermProcessor(terms),this.configurator=appConfig.context.configurator;var urlBuilder=this.configurator.getUrlBuilder();this.collections={};var entity=appConfig.context.entity;this.registerAction("Old View",{label:"Old View",url:urlBuilder.getViewUrl(entity.id)}),this.registerAction("Old Edit",{label:"Old Edit",url:urlBuilder.getEditUrl(entity.id,entity.entityType.name)}),this.registerAction("Print",{label:"Print View",command:function(menuComponent){menuComponent.redirectTo(urlBuilder.getPrintUrlRelative(entity.id,entity.entityType.name),"_blank")}}),this.registerAction("-----","-----"),this.registerAction("Delete",{label:"Delete",confirmation:"Are you sure?",command:function(menuComponent){menuComponent.removeEntity()},className:"ui-menu__item-action-delete ui-menu__item-dont-close"}),this.registerAction("Move or Copy",{label:"Move or Copy",command:function(menuComponent){menuComponent.moveOrCopy()},editions:["~board"]}),this.registerAction("Convert",{label:"Convert to&hellip;",roleAction:"convert",className:"ui-menu__item__parent",editions:["~innerList"]}),this.registerAction("Attach to Request",{label:"Attach To "+this.getTermName("Request"),command:function(menuComponent){menuComponent.attachToRequest()},editions:["Pro","~board"]}),this.registerAction("Add Impediment",{label:"Add "+this.getTermName("Impediment"),url:urlBuilder.getAddImpedimentUrl(entity.id)}),this.registerAdditionalInfoItem("Owner",{label:{type:"label",text:"Owner"},field:{type:"property.owner"}}),this.registerAdditionalInfoItem("Assigned Effort",{label:{type:"label",text:"Assigned Effort"},field:{type:"assignedEffort"}}),this.registerAdditionalInfoItem("Release Assigned Effort",{label:{type:"label",text:"Assigned Effort"},field:{type:"release.assignedEffort"}}),this.registerAdditionalInfoItem("Velocity",{label:{type:"label",text:"Velocity"},field:{type:"property.velocity"}}),this.registerAdditionalInfoItem("CycleTime",{label:{type:"label",text:"Cycle Time"},field:{type:"property.timeInterval",timeField:"cycleTime"}}),this.registerAdditionalInfoItem("LeadTime",{label:{type:"label",text:"Lead Time"},field:{type:"property.timeInterval",timeField:"leadTime"}}),this.registerAdditionalInfoItem("State",{label:{type:"label",text:"State"},field:{type:"property.entityState"}}),this.registerAdditionalInfoItem("Test Plan",{label:{type:"label",text:this.getTermName("TestPlan")},field:{type:"property.testPlan"}}),this.registerAdditionalInfoItem("Responsible",{label:{type:"label",text:"Responsible"},field:{type:"property.responsible"}}),this.registerAdditionalInfoItem("IsPrivate",{label:{type:"label",text:"Private?"},field:{type:"property.isPrivate"}}),this.registerAdditionalInfoItem("LastFailureComment",{label:{type:"label",text:"Last Failure Comment"},field:{type:"property.lastFailureComment"}}),appConfig.context.getProject()&&(this.registerAdditionalInfoItem("Release",{label:{type:"label",text:this.getTermName("Release")},field:{type:"property.release"},practices:["Planning"]}),this.registerAdditionalInfoItem("Iteration",{label:{type:"label",text:this.getTermName("Iteration")},field:{type:"property.iteration"},practices:["Iterations"]}),this.registerAdditionalInfoItem("Build",{label:{type:"label",text:this.getTermName("build")},field:{type:"property.build"}})),this.registerAdditionalInfoItem("ImpedimentDate",{label:{type:"label",text:"Creation Date"},field:{type:"property.impedimentDate"}}),this.registerAdditionalInfoItem("CreationDate",{label:{type:"label",text:"Creation Date"},field:{type:"property.createDate"}}),this.registerAdditionalInfoItem("FinishDate",{label:{type:"label",text:"Finish  Date"},field:{type:"property.completeDate",editable:!0}}),this.registerAdditionalInfoItem("StartDate",{label:{type:"label",text:"Start Date"},field:{type:"property.startDate",editable:!0}}),this.registerAdditionalInfoItem("ResolvedOn",{label:{type:"label",text:"Resolved On"},field:{type:"property.completeDate"}}),this.registerAdditionalInfoItem("CompletionDate",{label:{type:"label",text:"Completion  Date"},field:{type:"property.completeDate"}}),this.registerAdditionalInfoItem("Project",{label:{type:"label",text:this.getTermName("Project")},field:{type:"property.project"}}),this.registerAdditionalInfoItem("Priority",{label:{type:"label",text:this.getTermName("Priority")},field:{type:"property.priority"},practices:["Planning"]}),this.registerAdditionalInfoItem("Business Value",{label:{type:"label",text:"Business Value"},field:{type:"property.priority"},practices:["Planning"]}),this.registerAdditionalInfoItem("Initial Estimate",{label:{type:"label",text:"Initial Estimate"},field:{type:"property.initialEstimate"},practices:["Planning"]}),this.registerAdditionalInfoItem("Feature",{label:{type:"label",text:this.getTermName("Feature")},field:{type:"property.feature"},practices:["Requirements"]}),this.registerAdditionalInfoItem("Team",{label:{type:"label",text:"Team"},field:{type:"property.team"},editions:["hasTeams"]}),this.registerAdditionalInfoItem("Team Iteration",{label:{type:"label",text:"Team Iteration"},field:{type:"property.teamIteration"},editions:["hasTeams"]}),this.registerAdditionalInfoItem("User Story",{label:{type:"label",text:this.getTermName("userStory")},field:{type:"property.userStory"}}),this.registerAdditionalInfoItem("Assignable",{label:{type:"label",text:this.getTermName("Assignable")},field:{type:"property.assignable"}}),this.registerAdditionalInfoItem("Last Status",{label:{type:"label",text:"Last Status"},field:{type:"property.lastStatus"}}),this.registerAdditionalInfoItem("Last Run Date",{label:{type:"label",text:"Last Run Date"},field:{type:"property.lastRunDate"}}),this.registerAdditionalInfoItem("User Story For Task",{label:{type:"label",text:this.getTermName("userStory")},field:{type:"property.userStory",resetDisabled:!0}}),this.registerAdditionalInfoItem("Severity",{label:{type:"label",text:this.getTermName("Severity")},field:{type:"property.severity"},practices:["Planning"]}),this.registerTab("Description",{selected:!0,label:"description",header:[{type:"label",text:"Description"}],items:[{type:"tagsEditor",layout:"selectable",children:[{type:"tags",selector:".i-role-tagslistcontainer"},{type:"container",name:"tagsCloud.container",selector:".i-role-tagscloudcontainer",visible:!1,children:[{type:"tagsCloud"}]}]},{type:"container",name:"description container",cssClass:"ui-sub-control",children:[{type:"description"}]},this._buildRichTextCustomFieldsSummary(appConfig),{type:"attachments"},{type:"label",text:"Comments",cssClass:"ui-ctrl-title"},{type:"container",name:"comments container",cssClass:"ui-sub-control",children:[{type:"comments",extensions:[CommentRefresher]}]}]}),this.registerTab("Track",{label:"track",header:[{type:"label",text:"Track"}],items:[{type:"auditHistory",stateName:"audit",editions:["~board"]}],printable:!1}),this.registerTab("Flow",{label:"implementationHistory",printable:!1,header:[{type:"label",text:"Flow"}],items:[{type:"implementationHistory"}]}),this.registerTab("Relations",{label:"relations",printable:!1,header:[{type:"label",text:"Relations",countFieldNames:["masterRelations","slaveRelations"]}],items:[{name:"relations container",type:"relations.container"}]}),this.registerPanel("Additional Info",{type:"collapsible",name:"additional info container",collapsed:!1,stateName:"additionalInfo",header:[{type:"label",text:"Info"}],items:[{type:"additionalInfo",children:this.getAdditionalInfoItems(appConfig)}]}),this.registerPanel("Lead Cycle Time",{type:"collapsible",name:"Lead Cycle Time",stateName:"leadTime",collapsed:!1,header:[{type:"label",text:"Lead Cycle Time"}],items:[{type:"leadCycleTime"}]});var cf=this._buildCustomFieldsSummary(appConfig);cf.length&&this.registerPanel("Custom Fields",{type:"collapsible",name:"custom fields collapsible",collapsed:!1,stateName:"customFields",header:[{type:"label",text:"Custom Fields"}],items:cf}),window.appIsInDebugMode===!0&&this.registerPanel("Diagnostic",{type:"collapsible",name:"diagnostics container",printable:!1,collapsed:!0,header:[{type:"diagnostics"}],items:[{type:"collapsible",collapsed:!0,header:[{type:"label",text:"Global Bus Listeners"}],items:[{type:"diagnostics.globalListeners"}]},{type:"collapsible",collapsed:!0,header:[{type:"label",text:"Store Listeners"}],items:[{type:"diagnostics.store"}]}]}),this.registerPanel("Look Switcher",{type:"lookswitcher",printable:!1,editions:["~board"]})},getCollection:function(name){var collection={};return name in this.collections||(this.collections[name]={}),collection=this.collections[name],collection},addToCollection:function(collName,key,value){var coll=this.getCollection(collName);return coll[key]=value,this},registerAction:function(alias,config){config.alias=alias,config.className=config.className||"",this.addToCollection("actions",alias,config)},getActions:function(appConfig){var config=_.compact(this.getActionsAliases()),collection=this.getCollection("actions"),actions=[];return _.forEach(config,function(alias){alias in collection?actions.push(collection[alias]):actions.push({label:"--"+alias,command:function(){alert("Still working on it")}})}),actions},getActionsAliases:function(){return["Old View","Old Edit","Print","-----","Delete"]},registerAdditionalInfoItem:function(alias,config){config.field&&_.defaults(config.field,{name:alias+" "+config.field.type}),config.label&&_.defaults(config.label,{name:alias+" "+config.label.type}),this.addToCollection("additionalInfo",alias,config)},getAdditionalInfoItems:function(appConfig){var config=this.getAdditionalInfoAliases(),collection=this.getCollection("additionalInfo"),actions=[];return _.forEach(config,function(alias){alias in collection&&actions.push(collection[alias])}),actions},getAdditionalInfoAliases:function(){return[]},registerTab:function(alias,config){this.addToCollection("tabs",alias,config)},getTabs:function(appConfig){var config=this.getTabsAliases(),collection=this.getCollection("tabs"),actions=[];return _.forEach(config,function(alias){alias in collection&&actions.push(collection[alias])}),actions},getTabsAliases:function(){return["Description","Relations"]},registerPanel:function(alias,config){this.addToCollection("panels",alias,config)},getPanels:function(appConfig){var config=this.getPanelsAliases(),collection=this.getCollection("panels"),actions=[],self=this;return _.forEach(config,function(alias){alias in collection&&(alias=="Additional Info"&&(collection[alias].items[0].children=self.getAdditionalInfoItems(appConfig)),actions.push(collection[alias]))}),actions},getPanelsAliases:function(){return["Look Switcher","Diagnostic","Additional Info","Custom Fields"]},_buildCustomFieldsSummary:function(appConfig){var ctx=appConfig.context,fields=ctx.getCustomFields(),entityType=ctx.entity.entityType.name.toLowerCase(),filteredFields=_(fields).select(function(cf){return entityType===cf.entityKind.toLowerCase()&&cf.type.toLowerCase()!=="richtext"&&cf.type.toLowerCase()!=="multipleentities"}),items=[];for(var i=0;i<filteredFields.length;i++){var cf=filteredFields[i],typeCf=cf.type.toLowerCase();typeCf==="multipleselectionlist"&&(typeCf="multiselect"),items.push({type:"customField."+typeCf,customField:cf})}return items},_buildRichTextCustomFieldsSummary:function(appConfig){var ctx=appConfig.context,fields=ctx.getCustomFields(),entityType=ctx.entity.entityType.name.toLowerCase(),filteredFields=_(fields).select(function(cf){return entityType===cf.entityKind.toLowerCase()&&cf.type.toLowerCase()==="richtext"}),result={type:"container",name:"custom fields container",visible:filteredFields.length>0,children:[]};for(var i=0;i<filteredFields.length;i++){var cf=filteredFields[i];result.children.push({type:"label",text:cf.name,cssClass:"ui-ctrl-title"}),result.children.push({type:"container",name:"custom field container for "+cf.type.toLowerCase(),cssClass:"ui-sub-control",children:[{type:"customField."+cf.type.toLowerCase(),customField:cf}]})}return result},getNames:function(entityType){return this.termProcessor.getTerms(entityType).names},getTermName:function(entityType){return this.termProcessor.getTerms(entityType).name},getEntityQuickAddOptions:function(){return{}},getConfig:function(appConfig){var terms=appConfig.context.getTerms();this.termProcessor=new TermProcessor(terms);var features=this.configurator.getFeaturesService(),generalInfoId=_.uniqueId("entitygeneralinfo"),additionalInfoId=_.uniqueId("entityadditionalinfo");return{children:[{type:"container",name:"main entity container",layout:"selectable",template:{name:"main.entity.container",engine:"jqote2",markup:["<div class=\"main-container <%= this.cssClass || '' %>\">",'<div id="'+generalInfoId+'" class="general-info"></div>','<div id="'+additionalInfoId+'"  class="additional-info"></div>',"</div>"]},children:[{type:"container",name:"general info column container",layout:"list",selector:"#"+generalInfoId,children:[{type:"breadcrumbs"},{type:"title"},{type:"tabs",cssClass:"tau-tabs",stateName:"generalTab",tabs:this.getTabs(appConfig),additionalHeaders:[{type:"container",cssClass:"inner",children:_.compact([{name:"entity general info menu actions",type:"menu.actions",items:this.getActions(appConfig)},features.isEnabled("entity.quickAdd")?{type:"entity.quickAddTrigger",options:this.getEntityQuickAddOptions(),className:"tau-tab-item-quick-add"}:null])}]}]},{type:"container",name:"additional info column container",layout:"list",selector:"#"+additionalInfoId,children:this.getPanels(appConfig)}]}]}},isIE9:function(){return $.browser.msie&&$.browser.version=="9.0"}});return Config})