define(["Underscore","jQuery","tau/core/class","tau/core/termProcessor","tau/configurations/const.page.entity.modes","tau/configurations/component.config.helper","tau/components/extensions/customField/extension.customField.multipleEntities.count.label.setter"],function(e,t,i,n,a,r,s){return i.extend({init:function(e){var t=e.context.getTerms(),i=e.context.entity;this.termProcessor=new n(t),this.configurator=e.context.configurator,this.features=this.configurator.getFeaturesService(),this.collections={},this.helper=new r({context:e.context,mode:e.mode||a.FULL});var s=this.configurator.getUrlBuilder();this._registerActions(i,s),this._registerAdditionalInfoItems(e),this._registerTabs(e),this._registerPanels(e)},_registerActions:function(e,t){this.registerAction("Old Edit",{disabledIf:{feature:"tp3.only"},label:"Old Edit",url:t.getEditUrl(e.id,e.entityType.name)}),this.registerAction("Print",{label:"Print View",command:function(i){i.redirectTo(t.getPrintUrlRelative(e.id,e.entityType.name),"_blank")}}),this.registerAction("-----","-----"),this.registerAction("Delete",{label:"Delete",confirmation:"Are you sure?",command:function(e){e.removeEntity()},className:"ui-menu__item-action-delete ui-menu__item-dont-close"}),this.registerAction("Move or Copy",{label:"Move or Copy",command:function(e){e.moveOrCopy()},editions:["~board"]}),this.registerAction("Copy to project",{label:"Copy to project&hellip;",command:function(e,t){e.copyToProject(t)},editions:["board"]}),this.registerAction("Convert",{label:"Convert to&hellip;",roleAction:"convert",className:"ui-menu__item__parent",editions:["~innerList"]}),this.registerAction("Create",{label:"Create&hellip;",roleAction:"create",className:"ui-menu__item__parent",editions:["~innerList"]}),this.registerAction("Attach to Request",{label:"Attach to "+this.getTermName("Request"),command:function(e){e.attachToRequest()},editions:["Pro"]})},_registerAdditionalInfoItems:function(e){this.registerAdditionalInfoItem("PlannedStartDate",{label:{text:"Planned Start"},field:{type:"property.plannedStartDate",editable:!0}}),this.registerAdditionalInfoItem("PlannedEndDate",{label:{text:"Planned End"},field:{type:"property.plannedEndDate",editable:!0}}),this.registerAdditionalInfoItem("Owner",{label:{text:"Owner"},field:{type:"property.owner"}}),this.registerAdditionalInfoItem("Assigned Effort",{label:{text:"Assigned Effort"},field:{type:"assignedEffort"}}),this.registerAdditionalInfoItem("Release Assigned Effort",{label:{text:"Assigned Effort"},field:{type:"release.assignedEffort"}}),this.registerAdditionalInfoItem("Velocity",{label:{text:"Velocity"},field:{type:"property.velocity"}}),this.registerAdditionalInfoItem("State",{label:{text:"State"},field:{type:"property.entityState"}}),this.registerAdditionalInfoItem("Test Plan",{label:{text:this.getTermName("TestPlan")},field:{type:"property.testPlan"}}),this.registerAdditionalInfoItem("Responsible",{label:{text:"Responsible"},field:{type:"property.responsible"}}),this.registerAdditionalInfoItem("IsPrivate",{label:{text:"Private?"},field:{type:"property.isPrivate"}}),this.registerAdditionalInfoItem("Last Note",{label:{text:"Last Note"},field:{type:"property.lastNote"}}),e.context.getProject()&&(this.registerAdditionalInfoItem("Release",{label:{text:this.getTermName("Release")},field:{type:"property.release"},practices:["Planning"]}),this.registerAdditionalInfoItem("Release For Iteration",{label:{text:this.getTermName("Release")},field:{type:"property.release",resetDisabled:!0}}),this.registerAdditionalInfoItem("Iteration",{label:{text:this.getTermName("Iteration")},field:{type:"property.iteration"},practices:["Iterations"]}),this.registerAdditionalInfoItem("Build",{label:{text:this.getTermName("build")},field:{type:"property.build"}})),this.registerAdditionalInfoItem("ImpedimentDate",{label:{text:"Creation Date"},field:{type:"property.impedimentDate"}}),this.registerAdditionalInfoItem("CreationDate",{label:{text:"Creation Date"},field:{type:"property.createDate"}}),this.registerAdditionalInfoItem("FinishDate",{label:{text:"Finish Date"},field:{type:"property.completeDate",editable:!0}}),this.registerAdditionalInfoItem("StartDate",{label:{text:"Start Date"},field:{type:"property.startDate",editable:!0}}),this.registerAdditionalInfoItem("ResolvedOn",{label:{text:"Resolved On"},field:{type:"property.completeDate",editable:!0}}),this.registerAdditionalInfoItem("CompletionDate",{label:{text:"Completion  Date"},field:{type:"property.completeDate",editable:!0}}),this.registerAdditionalInfoItem("Project",{label:{text:this.getTermName("Project")},field:{type:"property.project"}}),this.registerAdditionalInfoItem("Priority",{label:{text:this.getTermName("Priority")},field:{type:"property.priority"},practices:["Planning"]}),this.registerAdditionalInfoItem("Business Value",{label:{text:"Business Value"},field:{type:"property.priority"},practices:["Planning"]}),this.registerAdditionalInfoItem("Priority",{label:{text:"Priority"},field:{type:"property.priority"},practices:["Planning"]}),this.registerAdditionalInfoItem("Initial Estimate",{label:{text:"Initial Estimate"},field:{type:"property.initialEstimate"},practices:["Planning"]}),this.registerAdditionalInfoItem("Epic",{label:{text:this.getTermName("Epic")},field:{type:"property.epic"},practices:["Requirements"]}),this.registerAdditionalInfoItem("Feature",{label:{text:this.getTermName("Feature")},field:{type:"property.feature"},practices:["Requirements"]}),this.registerAdditionalInfoItem("Team",{label:{text:"Team"},field:{type:"property.team"},editions:["hasTeams"]}),this.registerAdditionalInfoItem("Team Iteration",{label:{text:this.getTermName("teamIteration")},field:{type:"property.teamIteration"},editions:["hasTeams"]}),this.registerAdditionalInfoItem("User Story",{label:{text:this.getTermName("userStory")},field:{type:"property.userStory"}}),this.registerAdditionalInfoItem("Assignable",{label:{text:this.getTermName("Assignable")},field:{type:"property.assignable"}}),this.registerAdditionalInfoItem("Last Run Result",{label:{text:"Last Run Result"},field:{type:"property.lastStatus"}}),this.registerAdditionalInfoItem("Last Run Date",{label:{text:"Last Run Date"},field:{type:"property.lastRunDate"}}),this.registerAdditionalInfoItem("User Story For Task",{label:{text:this.getTermName("userStory")},field:{type:"property.userStory",resetDisabled:!0}}),this.registerAdditionalInfoItem("Severity",{label:{text:this.getTermName("Severity")},field:{type:"property.severity"},practices:["Planning"]}),this.registerAdditionalInfoItem("Test Case",{label:{text:"Test Case"},field:{type:"property.testCase"}}),this.registerAdditionalInfoItem("Test Plan Run",{label:{text:"Test Plan Run"},field:{type:"property.testPlanRun"}}),this.registerAdditionalInfoItem("Run Result",{label:{text:"Run Result"},field:{type:"property.status.testCaseRun"}}),this.registerAdditionalInfoItem("Run Date",{label:{text:"Run Date"},field:{type:"property.runDate"}}),this.registerAdditionalInfoItem("BuildDate",{label:{text:this.getTermName("Build")+" Date"},field:{type:"property.buildDate",editable:!0}})
},_registerTabs:function(e){this.registerTab("Description",{selected:!0,label:"description",containsNestedContainers:!0,header:[{type:"label",text:"Description"}],items:[{type:"container",spinnerConfigForLazy:this.getSpinnerConfigForLazy(),children:[{type:"container",lazy:!0,name:"lazyPlaceholder container",children:[{type:"tagsEditor",layout:"selectable",children:[{type:"tags",selector:".i-role-tagslistcontainer"},{type:"container",name:"tagsCloud.container",selector:".i-role-tagscloudcontainer",visible:!1,children:[{type:"tagsCloud"}]}]},{type:"container",name:"description container",cssClass:"ui-sub-control",children:[{type:"description"}]},{type:"container",lazy:!0,name:"lazyPlaceholder container",children:[this._buildRichTextCustomFieldsSummary(e),{type:"attachments"},{type:"container",label:"comments",name:"comments container",cssClass:"ui-sub-control",isNestedTopContainer:!0,children:[{type:"label",text:"Comments",cssClass:"ui-ctrl-title"},{type:"comments"}]}]}]}]}]}),this.registerTab("Relations",{label:"relations",printable:!1,header:[{type:"label.relationCount",text:"Relations"}],items:[{type:"container",spinnerConfigForLazy:this.getSpinnerConfigForLazy(),children:[{type:"container",lazy:!0,name:"lazyPlaceholder container",children:[{name:"relations container",type:"relations.container"}]}]}]}),this.registerTab("Flow",{label:"implementationHistory",printable:!1,header:[{type:"label",text:"Flow"}],items:[{type:"container",spinnerConfigForLazy:this.getSpinnerConfigForLazy(),children:[{type:"implementationHistory"}]}]}),this.registerTab("History",{label:"History",printable:!1,header:[{type:"label",text:"History"}],items:[{type:"container",spinnerConfigForLazy:this.getSpinnerConfigForLazy(),children:[{type:"container",lazy:!0,name:"lazyPlaceholder container",children:[{type:"auditHistory",name:"audit history"}]}]}]}),this._registerMultipleEntitiesCustomFieldsTabs(e)},_registerPanels:function(e){this.registerPanel("Additional Info",{type:"collapsible",name:"additional info container",collapsed:!1,stateName:"additionalInfo",header:[{type:"label",text:"Info"}],items:[{type:"additionalInfo",children:this.getAdditionalInfoItems()}]}),this.registerPanel("Lead Cycle Time",{type:"collapsible",name:"Lead Cycle Time",stateName:"leadTime",collapsed:!1,header:[{type:"label",text:"Lead Cycle Time"}],items:[{type:"leadCycleTime"}]});
var t=this._buildCustomFieldsSummary(e);t.length&&this.registerPanel("Custom Fields",{type:"collapsible",name:"custom fields collapsible",collapsed:!1,stateName:"customFields",header:[{type:"label",text:"Custom Fields"}],items:t}),window.appIsInDebugMode&&this.registerPanel("Diagnostic",{type:"collapsible",name:"diagnostics container",printable:!1,collapsed:!0,header:[{type:"diagnostics"}],items:[{type:"collapsible",collapsed:!0,header:[{type:"label",text:"Global Bus Listeners"}],items:[{type:"diagnostics.globalListeners"}]},{type:"collapsible",collapsed:!0,header:[{type:"label",text:"Store Listeners"}],items:[{type:"diagnostics.store"}]}]})},getCollection:function(e){return e in this.collections||(this.collections[e]={}),this.collections[e]},getSpinnerConfigForLazy:function(){return{isShow:!0,selectorForHeight:".tau-page-entity"}},addToCollection:function(e,t,i){return this.getCollection(e)[t]=i,this},registerAction:function(e,t){t.alias=e,t.className=t.className||"",this.addToCollection("actions",e,t)},getActions:function(){var t=e.compact(this.getActionsAliases()),i=this.helper.collection(this.getCollection("actions")),n=[];return e.forEach(t,function(e){e in i&&n.push(i[e])}),n},getActionsAliases:function(){return["Old Edit","Print","-----","Delete"]},registerAdditionalInfoItem:function(t,i){i.field&&e.defaults(i.field,{name:t+" "+i.field.type}),i.label&&(i.label.type=i.label.type||"label",i.label.name=i.label.name||t+" "+i.label.type),this.addToCollection("additionalInfo",t,i)},getAdditionalInfoItems:function(){var t=this.getAdditionalInfoAliases(),i=this.helper.collection(this.getCollection("additionalInfo")),n=[];return e.forEach(t,function(e){e in i&&n.push(i[e])}),n},getAdditionalInfoAliases:function(){return[]},registerTab:function(e,t){this.addToCollection("tabs",e,t)},getTabsHeader:function(){return{type:"tabsHeader",options:{more:!0}}},getTabs:function(){var t=e.union(this.getTabsAliases(),this._getCustomFieldTabsAliases()),i=this.helper.collection(this.getCollection("tabs")),n=[];
return e.forEach(t,function(e){e in i&&n.push(i[e])}),n},getTabsAliases:function(){return["Description","Relations"]},_getCustomFieldTabsAliases:function(){return e.reduce(this.getCollection("tabs"),function(e,t,i){return t.isCustomFieldTab&&e.push(i),e},[])},registerPanel:function(e,t){this.addToCollection("panels",e,t)},getPanels:function(){var t=this.getPanelsAliases(),i=this.helper.collection(this.getCollection("panels")),n=[],a=this;return e.forEach(t,function(e){e in i&&("Additional Info"==e&&(i[e].items[0].children=a.getAdditionalInfoItems()),n.push(i[e]))}),n},getPanelsAliases:function(){return["Diagnostic","Additional Info","Custom Fields"]},_buildCustomFieldsSummary:function(t){for(var i=t.context,n=i.getCustomFields(),a=i.entity.entityType.name.toLowerCase(),r=e(n).select(function(e){return a===e.entityKind.toLowerCase()&&"richtext"!==e.type.toLowerCase()&&"multipleentities"!==e.type.toLowerCase()}),s=[],l=0;l<r.length;l++){var o=r[l],d=o.type.toLowerCase();"multipleselectionlist"===d&&(d="multiselect"),s.push({type:"customField."+d,customField:o})}return s},_buildRichTextCustomFieldsSummary:function(t){for(var i=t.context,n=i.getCustomFields(),a=i.entity.entityType.name.toLowerCase(),r=e.filter(n,function(e){return a===e.entityKind.toLowerCase()&&"richtext"===e.type.toLowerCase()}),s={type:"container",name:"custom fields container",isNestedTopContainer:!0,visible:r.length>0,children:[]},l=0;l<r.length;l++){var o=r[l];s.children.push({type:"label",text:o.name,cssClass:"ui-ctrl-title"}),s.children.push({type:"container",name:"custom field container for "+o.type.toLowerCase(),cssClass:"ui-sub-control",children:[{type:"customField."+o.type.toLowerCase(),customField:o}]})}return s},_registerMultipleEntitiesCustomFieldsTabs:function(t){var i=t.context,n=i.entity.entityType.name.toLowerCase(),a=e.filter(i.getCustomFields(),function(e){return n===e.entityKind.toLowerCase()&&"multipleentities"===e.type.toLowerCase()});e.forEach(a,function(e,t){this.registerTab(e.name,{label:"MultipleEntitiesCustomFieldEditor"+t,isCustomFieldTab:!0,header:[{type:"label",text:e.name,extensions:[s],customField:{name:e.name,type:e.type}}],items:[{type:"container",spinnerConfigForLazy:{isShow:!0,selectorForHeight:".tau-page-entity"},children:[{type:"container",lazy:!0,name:"lazyPlaceholder container",children:[{type:"customField.multipleEntities.container",customField:{name:e.name,type:e.type,value:e.value}}]}]}]})
},this)},getNames:function(e){return this.termProcessor.getTerms(e).names},getTermName:function(e){return this.termProcessor.getTerms(e).name},getEntityQuickAddOptions:function(){return{}},getEntityMenuOptions:function(){return{type:"menu.actions",items:this.getActions()}},getConfig:function(t){var i=e.uniqueId("entitygeneralinfo"),n=e.uniqueId("entityadditionalinfo");return this._mergeConfigRegistries(t,{children:[{type:"container",name:"main entity container",layout:"selectable",template:{name:"main.entity.container",engine:"jqote2",markup:["<div class=\"main-container <%= this.cssClass || '' %>\">",'<div id="'+i+'" class="general-info"></div>',this.helper.valueOrDefault({enabledIf:{modeIn:[a.FULL]},value:'<div id="'+n+'" class="additional-info"></div>'}),"</div>"]},children:this.helper.children([{type:"container",name:"general info column container",layout:"list",selector:"#"+i,cssClass:this.helper.valueOrDefault({enabledIf:{modeIn:[a.FULL]},disabledIf:{entityTypeIn:["team","project","testcaserun"]},value:"tau-sharelink-enabled"}),children:this.helper.children([{type:"breadcrumbs"},{type:"container",cssClass:"ui-popup-header",children:this.helper.children([{type:"title",editable:this.helper.valueOrDefault({enabledIf:{entityTypeIn:["testcaserun"]},value:!1,"default":!0})},{cssClass:"header-button-wrap",type:"container",children:this.helper.children([{type:"followButton",disabledIf:{entityTypeIn:["user","testcaserun","team"]},enabledIf:{feature:"follow"}},{enabledIf:{modeIn:[a.FULL]},disabledIf:{entityTypeIn:["team","project","testcaserun"]},type:"shareLink"}])}])},{type:"tabs",cssClass:"tau-tabs",stateName:"generalTab",tabsHeader:this.getTabsHeader(),tabs:this.getTabs(t),additionalHeaders:this.helper.containers([{type:"container",cssClass:"inner",children:this.helper.children([{enabledIf:{modeIn:[a.FULL]},type:"entity.menuTrigger",options:this.getEntityMenuOptions(t),className:"tau-tab-item-quick-add",printable:!1},{enabledIf:{modeIn:[a.FULL]},type:"entity.quickAddTrigger",options:this.getEntityQuickAddOptions(),className:"tau-tab-item-quick-add",printable:!1}])}])}])},{enabledIf:{modeIn:[a.FULL]},type:"container",name:"additional info column container",layout:"list",selector:"#"+n,spinnerConfigForLazy:this.getSpinnerConfigForLazy(),children:[{type:"container",lazy:!0,name:"additional_lazy info column container",children:this.getPanels()}]}])},{name:"imagePreview",type:"attachmentsPreview"}]})
},_mergeConfigRegistries:function(t,i){return i.context=t.context,i.context.registry=e.extend(i.context.registry||{},this.getContainerRegistry(t),t.registry),i},getContainerRegistry:function(){return{componentConfigHelper:this.helper}}})});