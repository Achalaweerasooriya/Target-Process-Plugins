define(["require","Underscore","libs/jquery/jquery","tau/core/class","tau/core/bus.reg","tau/core/global.bus","tau/store/factory","tau/services/keyboard.manager","tau/services/state.manager","tau/services/service.routing","tau/services/service.hash","tau/utils/utils.routing","tau/utils/utils.history","tau/utils/utils.urlBuilder.service","libs/parseUri","tau/nls/translator","tau/store/services/service.globalSettings","tau/services/service.applicationContext","tau/store/services/service.notifications","tau/store/services/service.actions","tau/storage/api","tau/libs/boardSettings/factory.board.settings","tau/services/boards/service.boards.api","tau/slice/slice.factory","tau/utils/utils.titleManager","tau/utils/utils.base64hashEncoder","tau/services/service.componentBuilder","tau/core/bus.collection","tau/libs/clipboard/clipboard.manager","tau/ui/ui.templateFactory","tau/routers/routers.base","tau/utils/utils.redirect","tau/utils/utils.date/utils.date.wrapper","tau/utils/utils.date","tau/utils/utils.constants","tau/services/service.avatar","tau/services/service.features","tau/services/comet/comet.connection","tau/services/comet/service.comet","tau/services/service.tp2","tau/services/service.boardCacheData","tau/services/customize/service.customize.units.registry","tau/services/customize/service.customize.units.customField.factory","tau/services/service.help-scenarios","tau/services/service.board.access","tau/components/board.changelog/controllers/controller.board.changelog","tau/store/services/service.auditHistory","tau/libs/store2/store2","tau/services/service.prototypeContextEntity","tau/services/service.diagnostics","tau/services/service.sample.data.api"],function(t){var e=t("Underscore"),i=t("libs/jquery/jquery"),r=t("tau/core/class"),s=t("tau/core/bus.reg"),n=t("tau/core/global.bus"),o=t("tau/store/factory"),a=t("tau/services/keyboard.manager"),c=t("tau/services/state.manager"),u=t("tau/services/service.routing"),h=t("tau/services/service.hash"),g=t("tau/utils/utils.routing"),v=t("tau/utils/utils.history"),l=t("tau/utils/utils.urlBuilder.service"),S=t("libs/parseUri"),d=t("tau/nls/translator"),p=t("tau/store/services/service.globalSettings"),f=t("tau/services/service.applicationContext"),y=t("tau/store/services/service.notifications"),b=t("tau/store/services/service.actions"),w=t("tau/storage/api"),m=t("tau/libs/boardSettings/factory.board.settings"),C=t("tau/services/boards/service.boards.api"),F=t("tau/slice/slice.factory"),P=t("tau/utils/utils.titleManager"),x=t("tau/utils/utils.base64hashEncoder"),R=t("tau/services/service.componentBuilder"),B=t("tau/core/bus.collection"),A=t("tau/libs/clipboard/clipboard.manager"),E=t("tau/ui/ui.templateFactory"),M=t("tau/routers/routers.base"),O=t("tau/utils/utils.redirect"),D=t("tau/utils/utils.date/utils.date.wrapper"),H=t("tau/utils/utils.date"),U=t("tau/utils/utils.constants"),k=t("tau/services/service.avatar"),q=t("tau/services/service.features"),W=t("tau/services/comet/comet.connection"),z=t("tau/services/comet/service.comet"),I=t("tau/services/service.tp2"),j=t("tau/services/service.boardCacheData"),L=t("tau/services/customize/service.customize.units.registry"),T=t("tau/services/customize/service.customize.units.customField.factory"),N=t("tau/services/service.help-scenarios"),_=t("tau/services/service.board.access"),G=t("tau/components/board.changelog/controllers/controller.board.changelog"),K=t("tau/store/services/service.auditHistory"),J=t("tau/libs/store2/store2"),Q=t("tau/services/service.prototypeContextEntity"),V=t("tau/services/service.diagnostics"),X=t("tau/services/service.sample.data.api"),Y=r.extend({_config:{},isBoardEdition:!1,init:function(){this.registeredServices={hashEncoder:x},this.registerService("urlBuilder",new l(this))},getUrlBuilder:function(){return this.service("urlBuilder")},setLoggedUser:function(t){this.loggedUser=t},getLoggedUser:function(){return this.loggedUser||this.getWindow().loggedUser},setSystemInfo:function(t){this.systemInfo=t},getSystemInfo:function(){var t=this.systemInfo||this.getWindow().tauSystemInfo;return e.clone(t)},setRequireLoader:function(t){this.require=t},getRequireLoader:function(){return this.require||window.require},getComponentBuilder:function(){return this.componentBuilder=this.componentBuilder||new R(this),this.componentBuilder},require:function(t,e){var i=this.require||window.require;i(t,e)},setRestStorage:function(t){this.restStorage=t},getRestStorage:function(){return this.restStorage||(this.restStorage=new w({service:this.getRestStorageService()})),this.restStorage},setRestStorageService:function(t){this.restStorageService=t},getRestStorageService:function(){return this.restStorageService||(this.restStorageService=i.ajax),this.restStorageService},setBoardSettingsOptions:function(t){this.boardSettingsOptions=t},getBoardSettingsOptions:function(){return this.boardSettingsOptions},getBoardSettingsFactory:function(){return this.boardSettingsFactory||(this.boardSettingsFactory=new m(this)),this.boardSettingsFactory},getBoardApiService:function(){return this.boardApiService||(this.boardApiService=new C({service:this.getRestStorageService()})),this.boardApiService},setBoardApiService:function(t){this.boardApiService=t},getStoreFactory:function(){return this.storeFactory||(this.storeFactory=new o),this.storeFactory},setStoreFactory:function(t){this.storeFactory=t},setSliceFactoryOptions:function(t){this.sliceFactoryOptions=t||{}},mergeSliceFactoryOptions:function(t){this.sliceFactoryOptions=e.extend(this.sliceFactoryOptions||{},t)},getSliceFactoryOptions:function(){return e.defaults(this.sliceFactoryOptions||{},{base64:!0,options:{DnDTurnOffCometWhenItemsCountExceed:50},service:this.getSliceService()})},getSliceFactory:function(){if(!this.sliceFactory){var t=this.getSliceFactoryOptions();this.sliceFactory=new F(t)}return this.sliceFactory},setSliceService:function(t){this.sliceService=t},getSliceService:function(){return this.sliceService||(this.sliceService=i.ajax),this.sliceService},getKeyBoardManager:function(){if(!this.keyboardManager){this.keyboardManager=new a;var t={handleKeyDown:function(t){t.keyCode==i.ui.keyCode.ESCAPE&&(t.preventDefault(),t.stopPropagation())}};this.keyboardManager.pushHandler(t)}return this.keyboardManager},setGlobalSettingsService:function(t){this.globalSettingsService=t},getGlobalSettingsService:function(){if(!this.globalSettingsService){var t={appPath:this.getApplicationPath()};this.globalSettingsService=new p(t)}return this.globalSettingsService},setApplicationContextService:function(t){this.applicationContextService=t},getApplicationContextService:function(){return this.applicationContextService||(this.applicationContextService=new f(this),this.applicationContextService.isBoardEdition=this.isBoardEdition),this.applicationContextService},setNotificationService:function(t){this.notificationService=t},getNotificationService:function(){if(!this.notificationService){var t={appPath:this.getApplicationPath()};this.notificationService=new y(t)}return this.notificationService},setActionsService:function(t){this.actionsService=t},getActionsService:function(){if(!this.actionsService){var t={appPath:this.getApplicationPath()};this.actionsService=new b(t)}return this.actionsService},clearSingles:function(){this.getStoreFactory().clearSingles()},clear:function(){this.clearSingles(),delete this.currentDate,delete this.external,delete this.window,delete this.routing,delete this.stateManager,this.getStoreFactory().clear(),this.getBoardSettingsFactory().clear(),this.getBusRegistry().clear()},getAppStateStore:function(){return this.acidStore=this.acidStore||this.getBoardSettingsFactory().createAcidSettings({id:"appConfig"}),this.acidStore},getAuditHistoryService:function(){return this.auditHistoryService=this.auditHistoryService||new K(this.getApplicationPath()),this.auditHistoryService},getCurrentAcid:function(){var t="",e=this.getWindow();return e.location&&e.location.href&&(t=S(e.location.href).queryKey.acid||t),t},setWindow:function(t){this.window=t},getWindow:function(){return this.window||window},getHistory:function(){return this.history||(this.history=new v),this.history},createRouting:function(t){var e={window:this.getWindow()};return t&&(e.safe=!0,e.v2=!0,e.safeParameterName=t,e.configurator=this),new g(e)},getRouting:function(t){return this.routing||(this.routing=this.createRouting(t)),this.routing},getTitleManager:function(){return this.titleManager||(this.titleManager=new P({window:this.getWindow()})),this.titleManager},getTranslator:function(){return d},setCurrentDate:function(t){this.currentDate=new D(t)},getCurrentDate:function(){return this.currentDate?this.currentDate:H.getServerNow()},getGlobalBus:function(){return n.get()},getBusRegistry:function(){return s},getComponentBusRegistry:function(){return this.componentBusRegistry||(this.componentBusRegistry=new B),this.componentBusRegistry},setApplicationPath:function(t){this.getStoreFactory().setApplicationPath(t)},getApplicationPath:function(){return this.getStoreFactory().getApplicationPath()},getCkPath:function(){return this.ckPath||(this.ckPath=this.getApplicationPath()+"/Ckeditor"),this.ckPath},setCkPath:function(t){this.ckPath=t},setInitialData:function(t){this.getStoreFactory().setInitialData(t)},setService:function(t){this.getStoreFactory().setService(t)},getService:function(){return this.getStoreFactory().getService()},getRestPath:function(){return this.getStoreFactory().getRestPath()},setProxy:function(t){this.getStoreFactory().setProxy(t)},getProxy:function(){return this.getStoreFactory().getProxy()},disableRules:function(){this.getStoreFactory().disableRules()},enableRules:function(){this.getStoreFactory().enableRules()},initRules:function(){this.getStoreFactory().initRules()},getStore:function(t){return t=t||{},t.services=t.services||this,this.getStoreFactory().getStore(t)},getStore2:function(){return this.store2=new J(this),this.store2},setConfig:function(t,e){this._config[t]=e},getConfig:function(t,e){return this._config.hasOwnProperty(t)?this._config[t]:e},setHashEncoder:function(t){return this.registerService("hashEncoder",t)},getHashEncoder:function(){return this.service("hashEncoder")},getStateManager:function(){var t=this;if(!t.stateManager){var e=t.getExternal(),i=new u({external:e});t.stateManager=new c({service:i,state:e.hashParams()});var r=function(){var i=e.hashParams();t.stateManager?t.stateManager.update(i):e.unbindHashChange(r)};e.onHashChange(r)}return t.stateManager},getSettingsManager:function(){return this.settingsManager=this.settingsManager||this.getBoardSettingsFactory().createComponentSettings({id:"board"}),this.settingsManager},setClipboardManagerOptions:function(t){this.clipboardManagerOptions=t},getClipboardManagerOptions:function(){return e.defaults(this.clipboardManagerOptions||{},{id:"clipboard"})},getClipboardManager:function(){return this.clipboardManager||(this.clipboardManager=new A(this.getBoardSettingsFactory().createComponentSettings(this.getClipboardManagerOptions()))),this.clipboardManager},setRouter:function(t){this.router=t},getRouter:function(){return this.router||(this.router=new M),this.router},setRedirect:function(t){this.redirect=t},getRedirect:function(){return this.redirect||(this.redirect=new O(this.getWindow(),this.getApplicationPath())),this.redirect},getTemplateFactory:function(){return E},getConstObject:function(){return U},getAvatarService:function(){return this.avatarService||(this.avatarService=new k(this.getApplicationPath())),this.avatarService},setAvatarService:function(t){this.avatarService=t},createChild:function(){var t=new Y;return t.getStoreFactory().setStore(this.getStore()),t.isBoardEdition=this.isBoardEdition,t.featuresService=this.getFeaturesService(),t.acidStore=this.getAppStateStore(),t.setPrototypeContextEntityService(this.getPrototypeContextEntityService()),t.applicationContextService=this.getApplicationContextService(),t.loggedUser=this.getLoggedUser(),t},getFeaturesService:function(t){return this.featuresService||(this.featuresService=new q(t)),this.featuresService},setFeaturesService:function(t){return this.featuresService=new q(t),this.featuresService},getCometConnection:function(){var t="comet-connection";return this.registeredServices.hasOwnProperty(t)||this.registerService(t,W),this.service(t)},getComet:function(){return this.cometApi||(this.cometApi=new z(this.getCometConnection()),this.cometApi.logging=this.getFeaturesService().isEnabled("comet.collect-server-statistics")),this.cometApi},registerService:function(t,e){this.registeredServices[t]=e},service:function(t){if(!this.registeredServices.hasOwnProperty(t))throw new Error("Service ["+t+"] is not registered");return this.registeredServices[t]},setHashService:function(t){this.registerService("hash",t)},getHashService:function(){return this.registeredServices.hasOwnProperty("hash")||this.registerService("hash",new h(this)),this.service("hash")},createExternal:function(t){var e=this.getHashService();return e.setWindow(t),e},setExternal:function(t){this.setHashService(this.createExternal(t))},getExternal:function(){return this.getHashService()},setExternalService:function(t){return this.setHashService(t)},getTp2Service:function(){return this.registeredServices.hasOwnProperty("tp2")||this.registerService("tp2",new I(this)),this.service("tp2")},getBoardCacheService:function(){return this.registeredServices.hasOwnProperty("boardCacheData")||this.registerService("boardCacheData",new j(this)),this.service("boardCacheData")},getPrototypeContextEntityService:function(){return this.registeredServices.hasOwnProperty("prototypeContextEntity")||this.registerService("prototypeContextEntity",new Q),this.service("prototypeContextEntity")},setPrototypeContextEntityService:function(t){return this.registerService("prototypeContextEntity",t),this.service("prototypeContextEntity")},getChangelogController:function(){if(!this.registeredServices.hasOwnProperty("changelog")){var t=new G,e=this.service("errorBar");t.onError.add(e.fire.bind(e,"error")),this.registerService("changelog",t)}return this.service("changelog")},getUnitsRegistry:function(){return this.unitsRegistry||(this.unitsRegistry=new L),this.unitsRegistry},setUnitsRegistry:function(t){return this.unitsRegistry=t,this.unitsRegistry},getHelpScenarioService:function(){return this.registeredServices.hasOwnProperty("flow-help")||this.registerService("flow-help",new N({configurator:this})),this.service("flow-help")},getCustomFieldsUnitsFactory:function(){return this.customFieldsUnitsRegistry||(this.customFieldsUnitsRegistry=new T(this)),this.customFieldsUnitsRegistry},getBoardAccessService:function(){return _},getDiagnosticsService:function(){return this.diagnosticsService||(this.diagnosticsService=new V({configurator:this})),this.diagnosticsService},getSampleDataService:function(){return this.sampleDataService||(this.sampleDataService=new X({configurator:this})),this.sampleDataService}});return Y});