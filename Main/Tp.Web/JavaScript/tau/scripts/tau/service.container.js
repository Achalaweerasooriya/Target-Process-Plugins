define(["tau/core/Class","tau/core/bus.reg","tau/core/global.bus","tau/store/factory","tau/core/keyboard.manager","tau/core/external","tau/core/state.manager","tau/services/service.routing","tau/utils/utils.routing","tau/utils/utils.history","tau/utils/utils.urlBuilder.service","libs/parseUri","tau/nls/translator","tau/store/services/service.globalSettings","tau/services/service.applicationContext","tau/store/services/service.notifications","tau/store/services/service.actions","tau/storage/api","tau/store/acid.store","tau/libs/boardSettings/factory.board.settings","tau/slice/slice.factory","tau/utils/utils.titleManager","tau/utils/utils.base64hashEncoder","tau/utils/utils.componentsCreator","tau/core/bus.collection","tau/libs/clipboard/clipboard.manager","tau/ui/ui.templateFactory","tau/routers/routers.base","tau/utils/utils.redirect","tau/utils/utils.date/utils.date.wrapper","tau/utils/utils.constants","tau/services/service.avatar","tau/services/service.features","tau/comet/comet.api"],function(Class,busRegistry,globalBus,StoreFactory,KeyboardManger,External,StateManager,StateAccessService,Routing,History,UrlBuilder,parseUri,Translator,GlobalSettingsService,ApplicationContextService,NotificationsService,ActionsService,RestStorage,AcidStore,BoardSettingsFactory,SliceFactory,TitleManager,base64hashEncoder,ComponentsCreator,BusCollection,ClipboardManager,templateFactory,Router,Redirect,Date,constObject,AvatarService,FeaturesService,CometApi){var ServiceContainer=Class.extend({hashEncoder:base64hashEncoder,ckPath:"../Ckeditor/",_config:{},isBoardEdition:!1,getUrlBuilder:function(){return this.urlBuilder=this.urlBuilder||new UrlBuilder(this),this.urlBuilder},setLoggedUser:function(loggedUser){this.loggedUser=loggedUser},getLoggedUser:function(){return this.loggedUser},setRequireLoader:function(loader){this.require=loader},getRequireLoader:function(){return this.require||window.require},getComponentsCreator:function(){return this.componentsCreator=this.componentsCreator||new ComponentsCreator(this.getRequireLoader()),this.componentsCreator},require:function(dependencies,callback){var r=this.require||require;r(dependencies,callback)},setRestStorage:function(storage){this.restStorage=storage},getRestStorage:function(){return this.restStorage||(this.restStorage=new RestStorage({service:this.getRestStorageService()})),this.restStorage},setRestStorageService:function(service){this.restStorageService=service},getRestStorageService:function(){return this.restStorageService||(this.restStorageService=$.ajax),this.restStorageService},setBoardSettingsOptions:function(options){this.boardSettingsOptions=options},getBoardSettingsOptions:function(){return this.boardSettingsOptions},getBoardSettingsFactory:function(){return this.boardSettingsFactory||(this.boardSettingsFactory=new BoardSettingsFactory(this)),this.boardSettingsFactory},getStoreFactory:function(){return this.storeFactory||(this.storeFactory=new StoreFactory),this.storeFactory},setStoreFactory:function(storeFactory){this.storeFactory=storeFactory},setSliceFactoryOptions:function(options){this.sliceFactoryOptions=options||{}},getSliceFactoryOptions:function(options){return _.defaults(this.sliceFactoryOptions||{},{base64:!0,options:{DnDTurnOffCometWhenItemsCountExceed:50}})},getSliceFactory:function(){if(!this.sliceFactory){var options=this.getSliceFactoryOptions(),sliceCfg=_.extend({service:this.getSliceService()},options);this.sliceFactory=new SliceFactory(sliceCfg)}return this.sliceFactory},setSliceService:function(service){this.sliceService=service},getSliceService:function(){return this.sliceService||(this.sliceService=$.ajax),this.sliceService},getKeyBoardManager:function(){if(!this.keyboardManager){this.keyboardManager=new KeyboardManger;var keyBoardHandler={handleKeyDown:function(event){event.keyCode==$.ui.keyCode.ESCAPE&&(event.preventDefault(),event.stopPropagation())}};this.keyboardManager.pushHandler(keyBoardHandler)}return this.keyboardManager},setGlobalSettingsService:function(instance){this.globalSettingsService=instance},getGlobalSettingsService:function(){if(!this.globalSettingsService){var config={appPath:this.getApplicationPath()};this.globalSettingsService=new GlobalSettingsService(config)}return this.globalSettingsService},setApplicationContextService:function(instance){this.applicationContextService=instance},getApplicationContextService:function(){return this.applicationContextService||(this.applicationContextService=new ApplicationContextService(this.getStore()),this.applicationContextService.isBoardEdition=this.isBoardEdition),this.applicationContextService},setNotificationService:function(instance){this.notificationService=instance},getNotificationService:function(){if(!this.notificationService){var config={appPath:this.getApplicationPath()};this.notificationService=new NotificationsService(config)}return this.notificationService},setActionsService:function(instance){this.actionsService=instance},getActionsService:function(){if(!this.actionsService){var config={appPath:this.getApplicationPath()};this.actionsService=new ActionsService(config)}return this.actionsService},clearSingles:function(){this.getStoreFactory().clearSingles()},clear:function(){this.clearSingles(),delete this.currentDate,delete this.external,delete this.window,delete this.routing,delete this.stateManager,this.getStoreFactory().clear(),this.getBoardSettingsFactory().clear(),this.getBusRegistry().clear()},getAppStateStore:function(){return this.acidStore=this.acidStore||this.getBoardSettingsFactory().createAcidSettings({id:"appConfig"}),this.acidStore},getCurrentAcid:function(){var acid="",window=this.getWindow();if(window.location&&window.location.href){var string=window.location.href;acid=parseUri(string).queryKey.acid||acid}return acid},setWindow:function(window){this.window=window},getWindow:function(){return this.window||window},getHistory:function(){return this.history||(this.history=new History),this.history},createRouting:function(safeRouteParameter){var parameters={window:this.getWindow()};safeRouteParameter&&(parameters.safe=!0,parameters.v2=!0,parameters.safeParameterName=safeRouteParameter,parameters.configurator=this);var routing=new Routing(parameters);return routing},getRouting:function(safeRouteParameter){return this.routing||(this.routing=this.createRouting(safeRouteParameter)),this.routing},getTitleManager:function(){return this.titleManager||(this.titleManager=new TitleManager({window:this.getWindow()})),this.titleManager},getTranslator:function(){return Translator},setCurrentDate:function(date){this.currentDate=new Date(date)},getCurrentDate:function(){return this.currentDate?this.currentDate:new Date},getGlobalBus:function(){return globalBus.get()},getBusRegistry:function(){return busRegistry},getComponentBusRegistry:function(){return this.componentBusRegistry||(this.componentBusRegistry=new BusCollection),this.componentBusRegistry},setApplicationPath:function(appPath){this.getStoreFactory().setApplicationPath(appPath)},getApplicationPath:function(){return this.getStoreFactory().getApplicationPath()},getCkPath:function(){return this.ckPath},setCkPath:function(path){this.ckPath=path},setInitialData:function(data){this.getStoreFactory().setInitialData(data)},setService:function(service){this.getStoreFactory().setService(service)},getService:function(){return this.getStoreFactory().getService()},getRestPath:function(){return this.getStoreFactory().getRestPath()},setProxy:function(proxy){this.getStoreFactory().setProxy(proxy)},getProxy:function(){return this.getStoreFactory().getProxy()},disableRules:function(){this.getStoreFactory().disableRules()},enableRules:function(){this.getStoreFactory().enableRules()},initRules:function(){this.getStoreFactory().initRules()},getStore:function(config){return config=config||{},_.defaults(config,{services:this}),this.getStoreFactory().getStore(config)},setConfig:function(name,value){this._config[name]=value},getConfig:function(name,defaultValue){var val=defaultValue;return this._config.hasOwnProperty(name)&&(val=this._config[name]),val},setHashEncoder:function(hashEncoder){this.hashEncoder=hashEncoder},getHashEncoder:function(){return this.hashEncoder},createExternal:function(externalConfig){var hashEncoder=this.getHashEncoder();return new External(externalConfig,hashEncoder)},setExternal:function(externalConfig){this.external=this.createExternal(externalConfig)},getExternal:function(){return this.external||(this.external=this.createExternal(window)),this.external},setExternalService:function(service){this.external=service},getStateManager:function(){var self=this;if(!self.stateManager){var external=self.getExternal(),service=new StateAccessService({external:external});self.stateManager=new StateManager({service:service,state:external.hashParams()});var stateManagerComet=function(ext){var hash=ext.hashParams();self.stateManager?self.stateManager.update(hash):external.unbindHashChange(stateManagerComet)};external.onHashChange(stateManagerComet)}return self.stateManager},getSettingsManager:function(){return this.settingsManager=this.settingsManager||this.getBoardSettingsFactory().createComponentSettings({id:"board"}),this.settingsManager},setClipboardManagerOptions:function(options){this.clipboardManagerOptions=options},getClipboardManagerOptions:function(options){return _.defaults(this.clipboardManagerOptions||{},{id:"clipboard"})},getClipboardManager:function(){return this.clipboardManager||(this.clipboardManager=new ClipboardManager(this.getBoardSettingsFactory().createComponentSettings(this.getClipboardManagerOptions()))),this.clipboardManager},setRouter:function(router){this.router=router},getRouter:function(){return this.router||(this.router=new Router),this.router},setRedirect:function(redirect){this.redirect=redirect},getRedirect:function(){return this.redirect||(this.redirect=new Redirect(this.getWindow(),this.getApplicationPath())),this.redirect},getTemplateFactory:function(){return templateFactory},getConstObject:function(){return constObject},getAvatarService:function(){return this.avatarService||(this.avatarService=new AvatarService(this.getApplicationPath())),this.avatarService},setAvatarService:function(avatarService){this.avatarService=avatarService},createChild:function(){var child=new ServiceContainer;return child.getStoreFactory().setStore(this.getStoreFactory().getStore()),child.featuresService=this.getFeaturesService(),child.acidStore=this.getAppStateStore(),child.applicationContextService=this.getApplicationContextService(),child.loggedUser=this.getLoggedUser(),child},getFeaturesService:function(storage){return this.featuresService||(this.featuresService=new FeaturesService(storage)),this.featuresService},setFeaturesService:function(storage){return this.featuresService=new FeaturesService(storage)},getComet:function(){return CometApi.logging=this.getFeaturesService().isEnabled("comet.collect-server-statistics"),CometApi},registerService:function(id,service){this.registeredServices=this.registeredServices||{};if(this.registeredServices.hasOwnProperty(id))throw new Error("Service ["+id+"] has already been registered");this.registeredServices[id]=service},service:function(id){if(!this.registeredServices.hasOwnProperty(id))throw new Error("Service ["+id+"] is not registered");return this.registeredServices[id]}});return ServiceContainer})