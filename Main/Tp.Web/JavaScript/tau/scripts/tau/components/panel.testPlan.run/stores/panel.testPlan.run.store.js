define(["require","Underscore","jQuery","tau/components/panel.tab.switching/stores/panel.tab.switching.store","tau/components/panel.testPlan.run/helper/testPlan.run.helper"],function(t){var e=t("Underscore"),n=t("jQuery"),s=t("tau/components/panel.tab.switching/stores/panel.tab.switching.store"),a=t("tau/components/panel.testPlan.run/helper/testPlan.run.helper");return s.extend({results:null,openedRunCount:0,isOnTestPlanRunsTab:!0,_entityTypeName:"testPlanRun",_testPlanRunsTabName:"testPlanRuns",init:function(t,e,n,s,i){this._super(i),this._store=e,this._store2=n,this._testPlanId=t,this._testPlanRunHelper=new a(s),this._retrieveData(),this._getIsOnTestPlanRunsTab(),this._observe()},destroy:function(){this._super(),this._stopObserving(),this._setData=n.noop},createRunAndNavigate:function(){return this._testPlanRunHelper.createRunAndNavigate(this._testPlanId,this._store)},openTestPlanRunsTab:function(){this._switchToTab(this._testPlanRunsTabName)},_retrieveData:function(){this._store2.findAll(this._retrieveDataSpecification()).then(function(t){var n=e.first(t);this._setData(n)}.bind(this))},_retrieveDataSpecification:function(){return e.sprintf(["testPlan?where=(id==%d)&select={","results:{","passed:lastStartedTestPlanRun.passedCount,","failed:lastStartedTestPlanRun.failedCount,","notrun:lastStartedTestPlanRun.notRunCount,","onhold:lastStartedTestPlanRun.onHoldCount,","blocked:lastStartedTestPlanRun.blockedCount","},","openedRunCount:testPlanRuns.where(entityState.isFinal!=true).count()","}"].join(""),this._testPlanId)},_getIsOnTestPlanRunsTab:function(){this._isOnTab(this._testPlanRunsTabName).done(this._setIsOnTestPlanRunsTab.bind(this))},_setIsOnTestPlanRunsTab:function(t){this.isOnTestPlanRunsTab=t,this._notifyChanged()},_handleOnSwitchedToTab:function(t){this._setIsOnTestPlanRunsTab(t===this._testPlanRunsTabName)},_observe:function(){this._store.on({eventName:"afterRemove",type:this._entityTypeName,filter:{testPlan:{id:this._testPlanId}},listener:this},this._retrieveData.bind(this)),this._store.on({eventName:"afterSave",type:this._entityTypeName,filter:{testPlan:{id:this._testPlanId}},listener:this},this._onRunSaved.bind(this))
},_onRunSaved:function(t){var e=t.data&&t.data.changes;e&&!e.id&&this._retrieveData()},_stopObserving:function(){this._store.unbind(this)},_setData:function(t){this.results=t.results,this.openedRunCount=t.openedRunCount,this._notifyChanged()}})});