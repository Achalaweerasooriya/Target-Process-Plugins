define(["Underscore","jQuery","tau/components/extensions/component.extension.base"],function(_,$,ComponentExtensionBase){return ComponentExtensionBase.extend({"bus permissionsReady+afterRender":function(evt){this.$element=evt.afterRender.data.element;var permissions=evt.permissionsReady.data;permissions.deletable&&this._createDeleteTriggers()},"bus attachmentUploaded":function(evt){this._createDeleteTriggers()},"bus afterAttachmentRemove":function(evt){var self=this,attachmentId=evt.data.id,$attachmentElement=this.$element.find("#attach-"+attachmentId);$attachmentElement.animate({opacity:0},{complete:function(){$attachmentElement.remove()}})},_getDeleteTriggerProto:function(){return this._deleteTriggerProto||(this._deleteTriggerProto=$('<button class="delete" type="button">delete</button>').click($.proxy(this,"_onAttachmentDelete"))),this._deleteTriggerProto},_createDeleteTriggers:function(){var self=this;this.$element.find(".ui-attach:not(.deletable)").each(function(index,attachElement){$(attachElement).addClass("deletable").find(".toolbar").append(self._getDeleteTriggerProto().clone(!0))})},_onAttachmentDelete:function(evt){var $confirmationPlaceholder=this._findUpConfirmationPlaceholder($(evt.target));$confirmationPlaceholder.data("confirmation")||this._createConfirmation($confirmationPlaceholder),this._showConfirmation($confirmationPlaceholder)},_findUpConfirmationPlaceholder:function($trigger){return $trigger.closest(".ui-attach").children(".inner")},_findUpAttachElement:function($trigger){return $trigger.closest(".ui-attach")},_createConfirmation:function($placeholder){$placeholder.confirmation({message:"Delete attachment?",ok:$.proxy(this,"_deleteAttachment"),cancel:$.proxy(this,"_cancelAttachmentDelete")})},_showConfirmation:function($placeholder){$placeholder.confirmation("show")},_hideConfirmation:function($placeholder){$placeholder.confirmation("hide")},_deleteAttachment:function(evt){var $target=$(evt.target);this._hideConfirmation(this._findUpConfirmationPlaceholder($target));var $attachElement=this._findUpAttachElement($target);this.bus.fire("markElementToBeDeleted",{element:$attachElement}),this.bus.fire("remove",{id:$attachElement.attr("id").replace(/[^\d]/g,""),typeName:"attachment"})},_cancelAttachmentDelete:function(evt){this._hideConfirmation(this._findUpConfirmationPlaceholder($(evt.target)))}})})