define(["Underscore","jQuery","tau/core/event.emitter","tau/configurations/definitions/board.definition.factory"],function(_,$,EventEmitter,BoardDefinitionFactory){return EventEmitter.extend({init:function(config){var self=this;this._super(config),self.config=config,self.routingPatterns=[],self.routingPattern404={callback:function(){self.fire("error",{message:"URL is not found"})}};var configurator=self.config.context.configurator,external=configurator.getExternal();self.defaultHash=external.getHash(),configurator.boardDefinitionFactory=new BoardDefinitionFactory(configurator),configurator.getBoardDefinitionFactory=function(){return this.boardDefinitionFactory},self.config.startUrl&&external.setHash(self.config.startUrl)},matchPatterns:function(patterns,notFound){var self=this,appId=self.config.applicationId,configurator=self.config.context.configurator,external=configurator.getExternal(),currentValue=null,onHashChangeHandler=function(r){var hashValue=null;appId?hashValue=r.getHashParam(appId):hashValue=r.getHash().split("&")[0];if(currentValue===hashValue)return;currentValue=hashValue;var index=-1,matchedRegexp=null;_(patterns).find(function(p,i){matchedRegexp=_.isString(p.pattern)?new RegExp(p.pattern):p.pattern;var pass=matchedRegexp.test(hashValue);return pass&&(index=i),pass});if(index!==-1){var item=patterns[index],r=matchedRegexp.exec(hashValue),args=r.slice(1);item.callback.apply(self,args)}else notFound.callback.call(self)};external.onHashChange(onHashChangeHandler);var disposer=function(){external.unbindHashChange(onHashChangeHandler)};return disposer},"bus registerRoute":function(evt){this.routingPatterns.push(evt.data)},"bus registerRouteNotFound":function(evt){this.routingPattern404=evt.data},"bus afterInit":function(){var self=this,routes=self.config.routes;for(var i=0;i<routes.length;i++){var ri=routes[i],itemToRegister={pattern:ri.pattern,callback:self.createPatternCallback(ri)};self.fire("registerRoute",itemToRegister)}},"bus afterRender":function(){var self=this,patterns=self.routingPatterns,pattern404=self.routingPattern404;self.matchDispose=self.matchPatterns(patterns,pattern404),self.config.context.configurator.getExternal().triggerHashChange()},createPatternCallback:function(ri){var self=this,fnResolve=function(cfg){self.fire("application.navigate",{host:ri.host,type:ri.type,args:cfg})};return function(){ri.adapter.apply({configurator:self.config.context.configurator,resolve:fnResolve},arguments)}},destroy:function(){this._super(),this.matchDispose(),delete this.matchDispose;var cfg=this.config;if(cfg.applicationId){var external=cfg.context.configurator.getExternal();external.unbindHashChange(this.onCleanAppId),delete this.onCleanAppId,external.setHashParam(cfg.applicationId,null)}!cfg.applicationId&&cfg.integration&&cfg.integration.showInPopup&&cfg.context.configurator.getExternal().setHash(this.defaultHash),delete this.config,delete this.defaultHash}})})