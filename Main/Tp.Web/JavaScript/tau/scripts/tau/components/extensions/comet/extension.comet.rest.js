define(["Underscore","tau/core/extension.base"],function(_,BaseExtension){var unSubscribe=function(e,subscription){subscription&&subscription.stop()},cometHandlers={updated:function(configurator,r){var reason=r.reason;reason.push("id"),r.data.assignable&&reason.push("assignable");var data=_.pick(r.data,reason);data.__type=r.type,configurator.getStore().registerWithEvents(data)},removed:function(configurator,r){var data=r.data,type=r.type;configurator.getStore().removeWithEvents(data,type)},added:function(configurator,r){var reason=r.reason;reason.push("id"),r.data.assignable&&reason.push("assignable");var data=r.data;data.__type=r.type,configurator.getStore().registerWithEvents(data)}};return BaseExtension.extend({init:function(){this._super.apply(this,arguments),this.fireSubscriptionReady(null)},fireSubscriptionReady:function(v){this.fire("comet.subscription.ready",v)},createResourceCometHandler:function(configurator){var cometState={};return function(r){window.appIsInDebugMode===!0&&console.log("resource comet: ",r);var d=r.data,dKey=d.type+d.id,newTimestamp=r.timestamp,reasons=_.map(d.reason,_.toCamelCase);cometState.hasOwnProperty(dKey)||(cometState[dKey]={});var state=cometState[dKey],actualReasons=_.filter(reasons,function(x){var match=newTimestamp>(state[x]||0);return match&&(state[x]=newTimestamp),match}),tickType=d.modification.toLowerCase();d.reason=actualReasons,cometHandlers[tickType](configurator,d)}},"bus configurator.ready:last + comet.subscription.ready:last + application.navigate.entity":function(e,configurator,lastSubscription,ctx){var self=this;unSubscribe(null,lastSubscription);var type=ctx.entity||ctx.type,subscription=configurator.getComet().listen("resource",[{parameters:{acid:ctx.acid,resourceType:type,filter:"Id is "+ctx.id}},{parameters:{acid:ctx.acid,resourceType:"assignment",filter:"assignable.Id is "+ctx.id}},{parameters:{acid:ctx.acid,resourceType:"roleEffort",filter:"assignable.Id is "+ctx.id}}]).on({callback:self.createResourceCometHandler(configurator)}).start();self.fireSubscriptionReady(subscription)},"bus comet.subscription.ready:last + application.exit":unSubscribe,"bus comet.subscription.ready:last + destroy":unSubscribe})})