define(["Underscore","tau/core/class","tau/core/tau","tau/components/component.entity","tau/configurator","tau/utils/utils.redirect","tau/core/event","tau/core/types","tau/components/extensions/print.convert.extension"],function(a,b,c,d,e,f,g,h,i){return b.extend({init:function(a){this.config=a,this.bus=a.bus,g.subscribeOn(this),this._initGlobalEvents()},_initParameters:function(){var a={id:c.getValueFromQueryString("id"),type:null,action:null},b=c.getValueFromQueryString("type").split(".");a.entity=b[b.length-1];var d=/\/(\w+?).aspx$/.exec(window.location.pathname);return d=d&&d.length?d[1]:null,d=d&&typeof d!="undefined"&&d.toLocaleLowerCase()!="demoview"&&d.toLocaleLowerCase()!="tpview"?d.toLocaleLowerCase():"show",a.action=d,a},_initGlobalEvents:function(){var b=this,c=function(a){var c=a.data,d={project:{id:c.project.id}},e={id:c.entity.id,changes:d,cmd:{config:{$set:d}}};b.bus.fire("application.reload",e)},d=function(a){var c=a.data,d={},e={id:c.bugId,changes:d,cmd:{config:{$set:d}}};b.bus.fire("application.reload",e)};b.bus.getGlobalBus().on("bugWasMarkedAsDuplicate",d,b),b.bus.getGlobalBus().on("entityWasMovedToProject",c,b),b.bus.getGlobalBus().on("processChanged",c,b);var f=["general","assignment","roleEffort"],g=e.getStore(),h=function(a){b.bus.fire("application.reload",a.data)};a.each(f,function(a){g.on({type:a,eventName:"afterSave",listener:b},h),g.on({type:a,eventName:"afterRemove",listener:b},h)})},"bus routing.registered":function(b){var c=this._initParameters(),d=this,e=a.bind(this.execute,this);this.bus.fire("registerRoute",{pattern:"",callback:function(a){e(c.action,c)}}),this.bus.fire("registerRoute",{pattern:"{entity}/{id}",callback:function(a){e("show",a)}}),this.bus.fire("registerRoute",{pattern:"{entity}/{id}/{action}",callback:function(a){e(a.action,a)}}),this.bus.fire("registerRouteNotFound",{callback:function(a){d.bus.fire("error",{message:"URL is not found"})}}),this.bus.fire("dataBind",{})},"bus afterRender":function(a){this.$element=a.data.element,this.bus.fire("controller.ready")},"bus beforeRender":function(a){},_getItemConfig:function(b,c){var d={context:{id:b,entityType:{name:c}}},e=d.context;return a.extend(d.context,{assignable:e}),a.extend(d.context,{entity:e}),a.extend(d.context,{general:e}),d},execute:function(a,b){if(!b.id&&!b.entity){var c=e.getRouting(),d=c.getReferer()?c.getReferer().url:null;d?c.redirect("#"+d):this.bus.fire("application.exit");return}var f=this;a="action"+a,this[a]||(a="actionshow"),this.bus.fire("controller.preExecute",{action:a,parameters:b}),this[a].call(this,b.id,b.entity),this.bus.fire("controller.postExecute")},actionshow:function(a,b){this._action(a,b)},actionprint:function(a,b){this._action(a,b,{extensions:[i]}),jQuery("body").addClass("print-mode")},_action:function(a,b,c){this.current&&(this.current.destroy(),e.clearSingles());var f=this;this.current=d.create(this._getItemConfig(a,b),c||{}),this.current.on("beforeDelete",function(a){f.bus.fire("initProgress")}),this.current.on("deleted",function(a){f.bus.fire("application.exit")}),this.current.on("error",function(a){f.bus.fire("application.error")}),this.current.on("afterRender",function(a){f.$element.length&&(f.$element.append(a.data.element),f.bus.fire("contentRendered",{element:a.data.element}))}),this.current.initialize()},"bus destroy":function(){e.getStore().unbind(this),e.getGlobalBus().removeAllListeners(this),this.current&&this.current.fire("destroy")}})})