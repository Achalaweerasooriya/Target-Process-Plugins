define(["Underscore","jQuery","tau/core/model-base"],function(e,t,n){return n.extend({category:"edit",init:function(){var e=this;e._super.apply(e,arguments),e.animations=[]},"bus dataBind":function(e){this.bindedData=e.data},"bus afterRender":function(e){this.refresh=this._innerRefresh,this.$el=e.data.element,this.startAnimations()},"bus permissionsReady+afterRender":function(e){var t=e.permissionsReady.data;if(t.editable){var n=this;n.$el.removeClass("assignments-table-readonly"),n.$el.find(".group .effort").editableText({mask:/^\d*\.?\d*$/,restoreText:!0,onSave:function(e){var t=this.$element.parents(".group").tmplItem().data,i=n.normalizeEffort(t.roleEffort.effort),r=n.normalizeEffort(e);if(i===r)return this.restoreInitialText(),!1;var s={typeName:"roleEffort",$include:["id"],id:t.roleEffort.id,$set:{effort:r}};n.bus.fire("save",s)},onEditStart:function(){this.$element.data("points",this.$element.find("span").detach())},onEditEnd:function(){this.$element.append(this.$element.data("points"))}})}},"bus beforeSaveAssignment":function(e){var t,n,i=this,r=e.data.assignmentId;r&&(t=this.getAssignmentSelector(r),n=this.$el.find(t),n&&(this.fire("markElementToBeUpdated",{element:n}),this.addAnimation(function(){i.fire("updateElement",{element:i.$el.find(t)})})))},"bus beforeStateChanged":function(){var e=this;e.fire("markElementToBeUpdated",{element:this.$el}),e.addAnimation(function(){e.fire("updateElement",{element:e.$el})})},"bus dataDidUpdated":function(){this.refresh()},"bus avatarChanged":function(){this.refresh()},"bus afterSaveRoleEffort":function(e){var t=e.data.roleEffortId,n=this;n.addAnimation(function(){var e=n.findRoleEffortElementByRoleEffortId(t);n.fire("updateElement",{element:e}),n.fire("updateElement",{element:n.$el.find(".total-row .effort-cell span")})}),this.refresh()},"bus afterAssignmentSaved":function(){this.refresh()},"bus afterAssignmentRemoved":function(){this.refresh()},"bus afterStateChanged":function(){this.refresh()},"bus afterAssignmentAdded":function(){this.refresh()
},"bus beforeAddAssignment":function(e){var n=e.data,i=this,r=i.generateAssignmentIdForNewAssignment(n),s={name:"",role:{},assignmentId:r};t.tmpl("user",s).appendTo(i.$el.find(".group[roleId="+n.role.id+"]"));var a=i.getUserSelector({roleId:n.role.id,id:n.generalUser.id});i.addAnimation(function(){i.fire("updateElement",{element:i.$el.find(a)})})},"bus beforeRemoveAssignment":function(e){var t=e.assignmentId,n=this.$el.find(this.getAssignmentSelector(t));this.fire("markElementToBeDeleted",{element:n})},"bus beforeSaveRoleEffort":function(e){var t=e.data,n=t.roleEffortId,i=this.findRoleEffortElementByRoleEffortId(n);this.fire("markElementToBeUpdated",{element:i})},getUserSelector:function(e){return".group[roleId="+e.roleId+"] .user[userId="+e.id+"]"},getAssignmentSelector:function(e){var t,n=this,i=".user",r=n.$el.find(i);return r.each(function(n){var s=r.eq(n);return s.tmplItem().data.assignmentId==e?(t=s,i+=":eq("+n+")",!1):void 0}),i},generateAssignmentIdForNewAssignment:function(e){return[this.config.context.entity.id,e.role.id,e.generalUser.id].join(",")},findRoleEffortElementByRoleEffortId:function(e){var n=this.$el.find(".role-effort .effort"),i=t();return n.each(function(){var n=t(this),r=n.parents(".group"),s=r.tmplItem().data;return s.roleEffort=s.roleEffort||{},s.roleEffort.id===e?(i=n,!1):void 0}),i},addAnimation:function(e){this.animations.push(e)},startAnimations:function(){e.each(this.animations,function(e){e()}),this.animations=[]},_innerRefresh:function(){this.refresh=function(){},this.fire("refresh")},refresh:function(){},normalizeEffort:function(e){return Math.abs(Math.round(100*parseFloat(e))/100)||0},destroy:function(){delete this.$el,delete this.bindedData,delete this.animations,this._super()}})});