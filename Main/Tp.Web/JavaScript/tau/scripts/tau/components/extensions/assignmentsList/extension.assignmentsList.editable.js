define(["Underscore","jQuery","tau/core/model-base"],function(_,$,a){return a.extend({category:"edit",init:function(){var a=this;a._super.apply(a,arguments),a.animations=[]},"bus dataBind":function(a){this.bindedData=a.data},"bus afterRender":function(a){this.$el=a.data.element,this.startAnimations()},"bus permissionsReady+afterRender":function(a){var b=a.permissionsReady.data;if(b.editable){var c=this;c.$el.removeClass("assignments-table-readonly"),c.$el.find(".group .effort").editableText({mask:/^\d*\.?\d*$/,restoreText:!0,onSave:function(a){var b=this.$element.parents(".group").tmplItem().data,d=c.normalizeEffort(b.roleEffort.effort),e=c.normalizeEffort(a);if(d===e)return this.restoreInitialText(),!1;var f={typeName:"roleEffort",$include:["id"],id:b.roleEffort.id,$set:{effort:e}};c.bus.fire("save",f)},onEditStart:function(){this.$element.data("points",this.$element.find("span").detach())},onEditEnd:function(){this.$element.append(this.$element.data("points"))}})}},"bus afterAssignmentSaved":function(){this.refresh()},"bus beforeSaveAssignment":function(a){var b=this,c=a.data.assignmentId,d,e;c&&(d=this.getAssignmentSelector(c),e=this.$el.find(d),e&&(this.fire("markElementToBeUpdated",{element:e}),this.addAnimation(function(){b.fire("updateElement",{element:b.$el.find(d)})})))},"bus beforeStateChanged":function(a){var b=this;b.fire("markElementToBeUpdated",{element:this.$el}),b.addAnimation(function(){b.fire("updateElement",{element:b.$el})})},"bus afterStateChanged":function(a){this.refresh()},"bus afterAssignmentAdded":function(a){this.refresh()},"bus beforeAddAssignment":function(a){var b=a.data,c=this,d=c.generateAssignmentIdForNewAssignment(b),e={name:"",role:{},assignmentId:d};$.tmpl("user",e).appendTo(c.$el.find(".group[roleId="+b.role.id+"]"));var f=c.getUserSelector({roleId:b.role.id,id:b.generalUser.id});c.addAnimation(function(){c.fire("updateElement",{element:c.$el.find(f)})})},"bus afterAssignmentRemoved":function(){this.refresh()},"bus beforeRemoveAssignment":function(a){var b=a.assignmentId,c=this.$el.find(this.getAssignmentSelector(b));this.fire("markElementToBeDeleted",{element:c})},"bus afterSaveRoleEffort":function(a){var b=a.data.roleEffortId,c=this;c.addAnimation(function(){var a=c.findRoleEffortElementByRoleEffortId(b);c.fire("updateElement",{element:a}),c.fire("updateElement",{element:c.$el.find(".total-row .effort-cell span")})}),this.refresh()},"bus beforeSaveRoleEffort":function(a){var b=a.data,c=b.roleEffortId,d=this.findRoleEffortElementByRoleEffortId(c);this.fire("markElementToBeUpdated",{element:d})},getUserSelector:function(a){return".group[roleId="+a.roleId+"] .user[userId="+a.id+"]"},getAssignmentSelector:function(a){var b=this,c=".user",d=b.$el.find(c),e;return d.each(function(b){var f=d.eq(b);if(f.tmplItem().data.assignmentId==a)return e=f,c+=":eq("+b+")",!1}),c},generateAssignmentIdForNewAssignment:function(a){return[this.config.context.entity.id,a.role.id,a.generalUser.id].join(",")},findRoleEffortElementByRoleEffortId:function(a){var b=this.$el.find(".role-effort .effort"),c=$();return b.each(function(){var b=$(this),d=b.parents(".group"),e=d.tmplItem().data;e.roleEffort=e.roleEffort||{};if(e.roleEffort.id===a)return c=b,!1}),c},addAnimation:function(a){this.animations.push(a)},startAnimations:function(){_.each(this.animations,function(a){a()}),this.animations=[]},refresh:function(){this.fire("refresh")},normalizeEffort:function(a){return Math.abs(Math.round(parseFloat(a)*100)/100)||0},destroy:function(){delete this.$el,delete this.bindedData,delete this.animations,this._super()}})})