define(["Underscore","jQuery","tau/components/extensions/component.extension.base"],function(e,t,n){return n.extend({category:"edit",init:function(e){this._super(e),this.containers=[]},"bus initBubble":function(t,n){var o=this.config.context,i=e.defaults(n,{closeOnStoreActions:!0});this.initBubble(i,e.defaults(i.context||{},o))},"bus $target.ready:last + toggleBubble":function(e,n){window.appIsInDebugMode&&!t.contains(document.documentElement,n[0])&&window.console.error("$target.ready:last - bubble target is detached",n[0]),n.tauBubble("toggle")},initBubble:function(n,o){this.destroyContainers();var i=t(n.target);n.destroyExistingBubble&&i.data("ui-tauBubble")&&i.tauBubble("destroy"),this.fire("$target.ready",i);var a=e.extend({},n,{alignTo:n.alignTo||i,content:n.html,onHide:function(e){n.cleanupOnHide&&i.data("bubbleLoaded",!1),n.onHide&&n.onHide(e)},onBeforeShow:e.bind(this.onBeforeShowBubble,this,n,i),onShow:e.bind(this.onShowBubble,this,o,n,i)});i.tauBubble(a),n.applyBubbleClasses!==!1&&(i.addClass("tau-bubble-target"),i.tauBubble("getAlignTo").addClass("ui-link"))},onBeforeShowBubble:function(e,t,n){var o=!0;return e.onBeforeShow&&(o=e.onBeforeShow(n)),t.data("bubbleLoaded")!==!0&&(this.destroyContainers(),t.tauBubble("setContent",'<div class="ui-loading-message-container"><div class="ui-loading-message">Loading&hellip;</div></div>')),o},onShowBubble:function(e,t,n,o){t.onShow&&t.onShow(o),t.componentsConfig&&n.data("bubbleLoaded")!==!0&&this.createContainer(n,o,t,e)},createContainer:function(e,n,o,i){var a=this,s=o.componentsConfig;s.store=this.config.store,s.context=i,a.createComponents(s,function(i){var u=i[0].component,r=i[0].config;a.fire("childComponentCreated",u),a.addContainer(u),a.processContainer(e,n,u,o,r),r.context=s.context,r.store=s.store;var b=r.onBeforeInitializeComponent||t.noop;b.apply(r,[u]),u.initialize(r),u.fire("$outerBubbled.ready",e)})},processContainer:function(e,t,n,o,i){var a=function(){e.data("ui-tauBubble")&&e.tauBubble("adjust")};n.on("afterRender",function(t,o){t.removeListener();var i=o.element;i.css("visibility","hidden"),e.data("bubbleLoaded",!0),e.tauBubble("setContent",i),n.fire("focus.before",{}),n.fire("popupResize",e),i.css("visibility","visible"),a(),n.fire("focus",{}),e.trigger("taububbleloadcontent")}),n.on("afterRender",a),n.on("dataRendered",function(){n.fire("popupResize",e),n.fire("focus"),a()}),e.on("show",function(){n.fire("$outerBubbled.show")}),e.on("close",function(){n.fire("blur",{})});var s=function(t){e.data("ui-tauBubble")&&(t.data&&t.data.animated?e.tauBubble("widget").fadeOut(function(){e.tauBubble("empty")}):e.tauBubble("empty"))},u=function(){e.data("ui-tauBubble")&&e.tauBubble("destroy"),n.destroy()};n.on("close",s),n.on("reset",u),o.closeOnStoreActions&&(n.on("beforeSave",s),n.on("beforeRemove",s),n.on("afterSave",u),n.on("afterRemove",u));var r=i.handleComponentEvents;if(r){var b=function(e,t,o){n.on(e,t.bind(o||null))},d={closeBubble:s,destroyBubble:u};r(b,d)}n.on("adjustPosition",a)},destroy:function(){this.destroyContainers(),this._super()},addContainer:function(e){this.containers.push(e)},destroyContainers:function(){e.invoke(this.containers,"destroy"),this.containers=[]}})});