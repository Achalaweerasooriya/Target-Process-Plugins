define(["jQuery","tau/components/extensions/component.extension.base"],function($,ExtensionBase){return ExtensionBase.extend({category:"edit",init:function(config){this._super(config),this.containers=[]},"bus initBubble":function(evt,bubbleConfig){var context=this.config.context;this.initBubble(bubbleConfig,context)},"bus $target.ready:last+toggleBubble":function(evt,$target){$target.tauBubble("toggle")},initBubble:function(config,context){var self=this;self.destroyContainers();var $target=$(config.target);self.fire("$target.ready",$target);var $alignTo=config.alignTo?$(config.alignTo):$target;config.applyBubbleClasses!==!1&&($target.addClass("tau-bubble-target"),$alignTo.addClass("ui-link")),$target.tauBubble({className:config.className,stackName:config.stackName,alignTo:$alignTo,showOnCreation:config.showOnCreation,showCloseButton:config.showCloseButton,onPositionConfig:config.onPositionConfig||$.noop,onArrowPositionConfig:config.onArrowPositionConfig||$.noop,appendTo:config.appendTo,showEvent:config.showEvent,hideEvent:config.hideEvent,hideOnScroll:_.has(config,"hideOnScroll")?config.hideOnScroll:!0,content:config.html,onHide:function(){config.cleanupOnHide&&$target.data("bubbleLoaded",!1),config.onHide&&config.onHide()},zIndex:config.zIndex,dontCloseSelectors:config.dontCloseSelectors||[],onBeforeShow:config.onBeforeShow||$.noop,onShow:_.bind(function(context,componentsConfig,$target,$bubble){config.onShow&&config.onShow(),this.initializeContainer($target,$bubble,componentsConfig,context)},this,context,config.componentsConfig,$target)})},initializeContainer:function($target,$bubble,config,context){var self=this,isLoaded=$target.data("bubbleLoaded");if(isLoaded===!0||!config)return;this.destroyContainers(),$bubble.find("[role=content]").html('<div class="ui-loading-message">Loading...</div>'),self.createContainer($target,$bubble,config,context)},createContainer:function($target,$bubble,config,context){var self=this;config.store=this.config.store,config.context=context,self.createComponents(config,function(data){var containerBus=data[0].component,componentConfig=data[0].config;self.fire("childComponentCreated",containerBus),self.addContainer(containerBus),self.processContainer($target,$bubble,containerBus),componentConfig.context=config.context,componentConfig.store=config.store,containerBus.initialize(componentConfig)})},processContainer:function($target,$bubble,componentBus){componentBus.on("afterRender",function(evt,renderData){evt.removeListener();var $html=renderData.element;$target.data("bubbleLoaded",!0),$html.css("visibility","hidden"),$bubble.find("[role=content]").html($html),componentBus.fire("popupResize",$target),$target.tauBubble("adjustPosition"),$html.css("visibility","visible"),$target.trigger("taububbleloadcontent")}),componentBus.on("listOptionsReady",function(){$target.tauBubble("adjustPosition")}),componentBus.on("dataRendered",function(){componentBus.fire("popupResize",$target),$target.tauBubble("adjustPosition")}),componentBus.on("afterRender",function(){setTimeout(function(){$target.tauBubble("adjustPosition")},10),setTimeout(function(){componentBus.fire("focus",{})},500)}),$target.bind("close",function(){componentBus.fire("blur",{})}),$target.bind("externalClose",function(){componentBus.fire("blur",{})}),$target.bind("show.before",function(){componentBus.fire("focus.before",{})}),$target.bind("show",function(){componentBus.fire("popupResize",$target),$(this).tauBubble("adjustPosition"),componentBus.fire("focus",{})});var closeBubble=function(evt){$target.data("bubbleLoaded",!1),evt.data&&evt.data.animated?$target.tauBubble("widget").fadeOut(function(){$target.tauBubble("empty")}):$target.tauBubble("empty")},destroyBubble=function(){$target.tauBubble("destroy"),componentBus.destroy()},adjustPosition=function(){$target.tauBubble("adjustPosition")};componentBus.on("beforeSave",closeBubble),componentBus.on("beforeRemove",closeBubble),componentBus.on("reset",destroyBubble),componentBus.on("afterSave",destroyBubble),componentBus.on("afterRemove",destroyBubble),componentBus.on("close",closeBubble),componentBus.on("adjustPosition",adjustPosition)},destroy:function(){this.destroyContainers(),this._super()},addContainer:function(container){this.containers.push(container)},destroyContainers:function(){var containers=this.containers;_.each(containers,function(container){container.destroy()}),this.containers=[]}})})