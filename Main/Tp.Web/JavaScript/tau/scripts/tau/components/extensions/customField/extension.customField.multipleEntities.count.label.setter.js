define(["Underscore","tau/core/extension.base"],function(_,ExtensionBase){return ExtensionBase.extend({"bus afterInit":function(eventArgs,init){var store=init.config.context.configurator.getStore(),entity=init.config.context.entity,customField=init.config.customField;this._calculateCount(store,entity,customField),this._subscribeToStore(store,entity,customField)},_calculateCount:function(store,entity,customField){if(!customField||customField.type!=="MultipleEntities"){this._publishCount(0);return}var cmd={id:entity.id,fields:["customFields"]};store.get(entity.entityType.name,cmd,{success:function(e){this._getActualEntitiesAndPublishCount(store,this._findOwnCustomField(e.data.customFields,customField))},scope:this}).done()},_subscribeToStore:function(store,entity,customField){store.unbind(this);var self=this,filter={type:entity.entityType.name,eventName:"afterSave",hasChanges:["customFields"],filter:{id:entity.id},listener:this};store.on(filter,function(eventArgs){self._getActualEntitiesAndPublishCount(store,self._findOwnCustomField(eventArgs.data.changes.customFields,customField))})},_publishCount:function(count){this.fire("setBadgeText",{text:count})},_getActualEntitiesAndPublishCount:function(store,customField){if(!customField.value){this._publishCount(0);return}var self=this,ids=_.map(customField.value.split(","),function(i){return i.split(" ")[0]});store.find("general",{fields:["id"],$query:{id:{$in:ids}}}).done({success:function(r){self._publishCount(r[0].data.length)}})},_findOwnCustomField:function(customFields,fieldConfig){return _.chain(customFields).select(function(i){return i.name==fieldConfig.name}).first().value()}})})