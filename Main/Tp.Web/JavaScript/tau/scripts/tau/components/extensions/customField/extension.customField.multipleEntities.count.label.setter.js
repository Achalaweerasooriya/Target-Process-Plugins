define(["Underscore","tau/core/extension.base"],function(t,e){return e.extend({"bus afterInit":function(t,e){var n=e.config.context.configurator.getStore(),i=e.config.context.entity,s=e.config.customField;this._calculateCount(n,i,s),this._subscribeToStore(n,i,s)},_calculateCount:function(e,n,i){if(!i||"MultipleEntities"!==i.type)return void this._publishCount(0);var s={id:n.id,fields:["customFields"]};e.freeze(!0).done(t.bind(function(t){e.get(n.entityType.name,s,{success:function(t){this._getActualEntitiesAndPublishCount(e,this._findOwnCustomField(t.data.customFields,i))},scope:this}).done(),t.unfreeze()},this))},_subscribeToStore:function(t,e,n){t.unbind(this);var i=this,s={type:e.entityType.name,eventName:"afterSave",hasChanges:["customFields"],filter:{id:e.id},listener:this};t.on(s,function(e){i._getActualEntitiesAndPublishCount(t,i._findOwnCustomField(e.data.changes.customFields,n))})},_publishCount:function(t){this.fire("setBadgeData",t.toString())},_getActualEntitiesAndPublishCount:function(e,n){if(n){if(!n.value)return void this._publishCount(0);var i=this,s=t.map(n.value.split(","),function(t){return t.split(" ")[0]});e.find("general",{fields:["id"],$query:{id:{$in:s}}}).done({success:function(t){i._publishCount(t[0].data.length)}})}},_findOwnCustomField:function(e,n){return t.chain(e).select(function(t){return t.name==n.name}).first().value()}})});