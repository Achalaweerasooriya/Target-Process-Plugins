define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/utils/utils.uploadFiles","libs/jquery/jquery.fileupload","tau/ui/templates/attachments/ui.template.attachments.fileupload","tau/ui/templates/attachments/ui.template.attachments.attachment"],function(e,t,n,a,i,l,r){var o=!!window.FileReader;return n.extend({"bus permissionsReady+afterRender":function(e,t,n){this._initialized||(this._initialized=!0,this.element=n.element,t.editable&&t.deletable&&this._initUploader())},"bus afterRender":function(e,n){t.when.elementIsInDom(n.element).then(function(){this.fire("view.dom.ready")}.bind(this))},_initUploader:function(){var e={uploaderText:o?"Drag and drop files here or click to select files":"Click here to select files",uploaderTextActive:o?"Drop here...":"",multiple:/\bapple\b/i.test(navigator.vendor)?"":"multiple"},t=l.render(e);t.find(".i-role-fileinput").fileupload({url:this._getUploadUrl(),formData:this._getFormData(),add:this._onFileAdd.bind(this),dropZone:this.element,pasteZone:this.element}),t.appendTo(this.element)},_getUploadUrl:function(){return this.config.context.configurator.getApplicationPath()+"/UploadFile.ashx"},_getFormData:function(){return[{name:"generalId",value:this._getGeneralId()}]},_getGeneralId:function(){return this.config.context.entity.id},_onFileAdd:function(e,t){var n=this;if(this.element.find(".uploader-toolbar").removeClass("dragged-over"),t.files&&0!==t.files.length){var i=this._createAttachmentDummy(t.files[0].name);i.appendTo(this._getAttachmentsPlaceholder()),a.upload(t).then(function(e){n.bus.fire("attachmentUploaded",{element:n._updateAttachmentElement(i,e),data:e})},function(e){n._onAttachmentUploadFail(i,e)})}},_updateAttachmentElement:function(e,t){var n=this._createAttachmentElement(t);return e.replaceWith(n),n},_onAttachmentUploadFail:function(e,t){this._deleteFailedAttachmentElement(e,t)},_createAttachmentDummy:function(e){var t=this._createAttachmentElement({name:e});return t.addClass("uploading").find(".toolbar").remove(),t
},_deleteFailedAttachmentElement:function(e,n){n=n||"Upload failed",this.fire("error",{message:n}),e.addClass("failed"),t('<p class="error">Upload failed</p>').insertAfter(e.find(".name")),e.fadeOut(1500,function(){e.remove()})},_getAttachmentsPlaceholder:function(){return this.element.find(".ui-attachments-content")},_createAttachmentElement:function(e){return r.render(e)}})});