define(["Underscore","jQuery","tau/components/extensions/component.extension.base"],function(_,$,a){return a.extend({"bus afterRender":function(a){this._$element=a.data.element,this._data=a.data.data,this._render()},_render:function(){this._createFlowIndicators(),this._connectMarkers(),this.fire("stateProgressRendered")},_createFlowIndicators:function(){var a=this._$element.find(".tau-historyGrid .tau-historyItem");_.each(this._data.historyItems,function(b,c){this._markProgressStep(a.eq(c),b)},this)},_getHistoryItemStateIndex:function(a){return _.indexOf(this._data.entityStates,a)},_getFlowType:function(a){var b="NORMAL";return a.state.isFinal?b="DONE":this._isUnderImpediment(a)?b="IMPEDIMENT":a.transitions>1&&(b="MULTITRANS"),b},_isUnderImpediment:function(a){var b=_.any(this._getImpedimentRangeList(),function(b){return this._isInImpedimentRange(a,b)},this);return b},_getImpedimentRangeList:function(){if(!this._impedimentRangeList){this._impedimentRangeList=[];var a=this._getAllImpediments();_.each(a.opened,function(b,c){this._impedimentRangeList.push({start:b,end:a.closed[c]||Number.POSITIVE_INFINITY})},this),this._impedimentRangeList.sort(function(a,b){return b.end-b.start-(a.end-a.start)})}return this._impedimentRangeList},_getAllImpediments:function(){var a={opened:{},closed:{}};return _.each(this._data.historyItems,function(b){b.relatedEntities&&(_.each(b.relatedEntities.opened,function(c){this._isImpediment(c)&&(a.opened[c.id]=b.date)},this),_.each(b.relatedEntities.closed,function(c){this._isImpediment(c)&&(a.closed[c.id]=b.date)},this))},this),a},_isImpediment:function(a){return a.type.toLowerCase()=="impediment"},_isInImpedimentRange:function(a,b){return a.date>=b.start&&a.date<=b.end},_markProgressStep:function(a,b){var c=this._getHistoryItemStateIndex(b.state.name),d=this._getFlowType(b),e=this._createFlowIndicator(d),f=b.state.dateSpan;f&&!b.state.isFinal&&$("<span/>").addClass("datespan").text(f).attr("title",f+" consecutive days in this state").appendTo(e),a.find(".tau-progressSteps .tau-step:nth-child("+(c+1)+") .tau-marker").append(e)},_createFlowIndicator:function(a){var b=$("<div/>").addClass("tau-flow");switch(a){case"NORMAL":b.addClass("tau-normal");break;case"MULTITRANS":b.addClass("tau-transitions");break;case"IMPEDIMENT":b.addClass("tau-impediment");break;case"DONE":b.addClass("tau-done")}return b},_connectMarkers:function(){_.each(this._data.historyItems,function(a,b){var c=this._getHistoryItemStateIndex(a.state.name);this._connect(b,c,b-1,"in"),this._connect(b,c,b+1,"out")},this)},_connect:function(a,b,c,d){var e=this._data.historyItems[c];if(e){var f=this._getHistoryItemStateIndex(e.state.name),g=b-f;g>0&&this._$element.find(".tau-historyGrid .tau-historyItem").eq(a).find(".tau-progressSteps .tau-step").filter(function(a){return a>=f+1&&a<=b}).find(".tau-marker").addClass("tau-"+d)}}})})