define(["Underscore","jQuery","tau/components/extensions/component.extension.base"],function(t,e,n){return n.extend({"bus afterRender":function(t){this._$element=t.data.element,this._data=t.data.data,this._render()},_render:function(){this._createFlowIndicators(),this._connectMarkers(),this.fire("stateProgressRendered")},_createFlowIndicators:function(){var e=this._$element.find(".tau-historyGrid .tau-historyItem");t.each(this._data.historyItems,function(t,n){this._markProgressStep(e.eq(n),t)},this)},_getHistoryItemStateIndex:function(e){return t.indexOf(this._data.entityStates,e)},_getFlowType:function(t){var e="NORMAL";return t.state.isFinal?e="DONE":this._isUnderImpediment(t)?e="IMPEDIMENT":t.transitions>1&&(e="MULTITRANS"),e},_isUnderImpediment:function(e){var n=t.any(this._getImpedimentRangeList(),function(t){return this._isInImpedimentRange(e,t)},this);return n},_getImpedimentRangeList:function(){if(!this._impedimentRangeList){this._impedimentRangeList=[];var e=this._getAllImpediments();t.each(e.opened,function(t,n){this._impedimentRangeList.push({start:t,end:e.closed[n]||Number.POSITIVE_INFINITY})},this),this._impedimentRangeList.sort(function(t,e){return e.end-e.start-(t.end-t.start)})}return this._impedimentRangeList},_getAllImpediments:function(){var e={opened:{},closed:{}};return t.each(this._data.historyItems,function(n){n.relatedEntities&&(t.each(n.relatedEntities.opened,function(t){this._isImpediment(t)&&(e.opened[t.id]=n.date)},this),t.each(n.relatedEntities.closed,function(t){this._isImpediment(t)&&(e.closed[t.id]=n.date)},this))},this),e},_isImpediment:function(t){return"impediment"==t.type.toLowerCase()},_isInImpedimentRange:function(t,e){return t.date>=e.start&&t.date<=e.end},_markProgressStep:function(t,n){var i=this._getHistoryItemStateIndex(n.state.name),s=this._getFlowType(n),a=this._createFlowIndicator(s),r=n.state.dateSpan;r&&!n.state.isFinal&&e("<span/>").addClass("datespan").text(r).attr("title",r+" days in this state").appendTo(a),t.find(".tau-progressSteps .tau-step:nth-child("+(i+1)+") .tau-marker").append(a)},_createFlowIndicator:function(t){var n=e("<div/>").addClass("tau-flow");switch(t){case"NORMAL":n.addClass("tau-normal");break;case"MULTITRANS":n.addClass("tau-transitions");break;case"IMPEDIMENT":n.addClass("tau-impediment");break;case"DONE":n.addClass("tau-done")}return n},_connectMarkers:function(){t.each(this._data.historyItems,function(t,e){var n=this._getHistoryItemStateIndex(t.state.name);this._connect(e,n,e-1,"in"),this._connect(e,n,e+1,"out")},this)},_connect:function(t,e,n,i){var s=this._data.historyItems[n];if(s){var a=this._getHistoryItemStateIndex(s.state.name),r=e-a;r>0&&this._$element.find(".tau-historyGrid .tau-historyItem").eq(t).find(".tau-progressSteps .tau-step").filter(function(t){return t>=a+1&&e>=t}).find(".tau-marker").addClass("tau-"+i)}}})});