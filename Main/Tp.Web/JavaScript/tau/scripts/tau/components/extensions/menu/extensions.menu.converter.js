define(["tau/components/extensions/component.extension.base","tau/services/service.actions","tau/core/templates-factory","tau/ui/templates/actions/ui.template.convert"],function(a,b,c){var d=46,e=0;return a.extend({"bus convertEntity":function(a){var b=a.data.projectID,c=a.data.generalID;this.convert(c,b)},convert:function(a,f){var g=this.bus.getGlobalBus(),h=new b;Ext.WindowMgr.zseed=99999;var i=this,j=[],k=function(b){function n(){var a=k.find("#entityType").val();k.find("textarea").unbind("keypress"),k.find("textarea").unbind("keyup"),k.find("#pnlLookupUserStory").css("display",a==d?"block":"none"),a==0?k.find(".convert-btn").attr("disabled","disabled"):a==d?(k.find("textarea").bind("keypress ",function(a){a.keyCode==13&&(a.stopPropagation(),a.preventDefault())}),k.find("textarea").bind("keyup",m),k.find("textarea").bind("change",m),m()):k.find(".convert-btn").removeAttr("disabled")}e++;var k=c.get("convert").bind(i.config,{types:b.d}).appendTo("body"),l="convertEntityPanel"+e;k=k.find("#convertEntityPanel").prop("id",l);var m=function(){k.find("textarea").val().length==0?k.find(".convert-btn").attr("disabled","disabled"):k.find(".convert-btn").removeAttr("disabled")};$create(Tp.Atlas.Extenders.Lookup.GeneralLookupBehavior,{TargetControl:k.find("#txtGeneralsLookup")[0],clearLink:k.find("#lnkClear")[0],entityTypeIDs:[4],excludeEntityID:a,findLink:k.find("#lnkFind")[0],generalElement:k.find("#hdnGeneralID")[0],id:"lkpUserStories",projectID:f,projectIDs:j,showEntityTypeFilter:!1,showProjectFilter:!0,showReleaseIterationFilter:!0,onFindDelegate:function(){k.find(".convert-btn").removeAttr("disabled")},showStateFilter:!1},null,null),k.find(".convert-btn").click(function(){var b=k.find("#entityType").val();o.hide(),i.fire("showProgress",{text:"Converting..."});var c={generalId:a},e=function(a){o.close(),i.fire("hideProgress");var b=a.d,c=b.EntityTypeName.split("."),d=c[c.length-1],e={entity:{id:b.GeneralID},entityType:{name:d}};i.fire("generalWasConverted",e),g.fire("history.clearCurrent"),g.fire("routing.redirect",{url:"#"+d.toLowerCase()+"/"+b.GeneralID}),window._criticalTauChanges=!0},f=function(a){o.close(),i.fire("hideProgress");var b=jQuery.parseJSON(a.responseText)||{Message:"Server is not available"},c=b.Message;i.fire("error",{message:c})};if(b==d){var j=k.find("#hdnGeneralID").val();if(!j){i.fire("error",{message:"Parent user story is not specified"});return}h.convertGeneralToTask(a,j,e,f)}else c.entityTypeId=b,h.convertGeneralToType(a,b,e,f)}),k.find("#entityType").change(function(){n()}),n();var o=showModalPopup(l,{title:"Convert",width:600,height:220})};h.getProjectIds(function(b){j=b.d,h.generalCanConvertTo(a,k)})}})})