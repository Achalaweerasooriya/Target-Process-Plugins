define(["tau/components/extensions/component.extension.base","tau/core/termProcessor","tau/components/component.finder","tau/models/finder/model.userStory.search"],function(ExtensionBase,TermProcessor,Finder,UserStorySearch){return ExtensionBase.extend({"bus configurator.ready:last + $submenu.ready":function(evt,configurator,$submenu){var self=this,entity=this.config.context.entity,tp=new TermProcessor(this.config.context.getTerms()),$items=$submenu.find(".ui-menu__item"),thisEntityType=tp.getTerms(entity.entityType.name).name,$item=$items.filter("[data-alias=convertToTask]");if($item.length){var finder=Finder.create({resetDisabled:!0,searchModel:UserStorySearch}),name=$item.data("name"),id=$item.data("id"),entityType={id:id,name:name};finder.on("afterRender",function(evt,data){var $wrapped=$("<div/>").append(data.element),thatEntityType=tp.getTerms(name).name,$content=$wrapped.append(['<div class="i-role-confirmation-content" style="display: none">',"<h3>Do you really want to convert "+thisEntityType+" to "+thatEntityType+"?</h3>",'<div class="tau-buttons">','<button type="button" class="tau-btn tau-primary i-role-actionok">Yes, I\'m sure</button>','<button type="button" class="tau-btn i-role-actioncancel">No</button>',"</div>","</div>"].join("")),$bubbled=$item.tauBubble({template:['<div class="tau-bubble">','<div class="tau-bubble__arrow" role="arrow"></div>','<div class="tau-bubble__inner tau-container"  role="content"></div>',"</div>"].join(""),content:$content,onPositionConfig:function(conf){conf.my="center top",conf.at="center bottom",conf.offset="0 0",conf.collision="flip flip"},onHide:function(){configurator.getKeyBoardManager().popHandler(),$submenu.toggleClass("sub-ui-menu_dont-hide",!1),$item.find(".drop-down-option").toggleClass("drop-down-option_hover",!1)},onShow:function(){configurator.getKeyBoardManager().pushHandler({}),$submenu.toggleClass("sub-ui-menu_dont-hide",!0),$item.find(".drop-down-option").toggleClass("drop-down-option_hover",!0);var $w=$bubbled.tauBubble("widget");$w.find(".ui-finder-placeHolder").show(),$w.find(".i-role-confirmation-content").hide(),$w.removeClass("tau-warning-bubble"),$w.find(".filter-field").focus(),$w.unbind("click"),finder.fire("popupResize",$bubbled),$item.tauBubble("adjustPosition"),$w.one("click",".i-role-actioncancel",function(){$bubbled.tauBubble("hide")}),$w.one("click",".i-role-actionok",function(){$bubbled.tauBubble("hide"),self.fire("convertToTask",entityType)})},zIndex:130})}),finder.on("entitySelected",function(evt,entity){var $w=$item.tauBubble("widget");$w.find(".ui-finder-placeHolder").hide(),$w.find(".i-role-confirmation-content").show(),$w.addClass("tau-warning-bubble"),$item.tauBubble("adjustPosition"),self.fire("entitySelected",entity)}),this.reFire(finder),finder.initialize()}},reFire:function(finder){var childBus=finder,bus=this.bus,originalFire=childBus.fire,childName=childBus.name;childBus.fire=function(eventName,data){var params=_.toArray(arguments);originalFire.apply(childBus,params),bus.fire(childName+"."+eventName,data)}},"bus entitySelected + convertToTask":function(evt,userStory,entityType){this.fire("convertTo",{entityType:entityType,userStory:userStory.entity})}})})