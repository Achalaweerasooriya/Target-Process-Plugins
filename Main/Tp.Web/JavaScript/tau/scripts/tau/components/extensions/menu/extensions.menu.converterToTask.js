define(["Underscore","tau/components/extensions/component.extension.base","tau/core/termProcessor","tau/components/component.finder.entity"],function(e,t,n,o){return t.extend({"bus beforeInit:last + configurator.ready:last + $convert.submenu.ready":function(e,t,i,a){var r=this,u=this.config.context.entity,s=new n(this.config.context.getTerms()),l=a.find(".ui-menu__item"),c=s.getTerms(u.entityType.name).name,d=l.filter("[data-alias=convertToTask]");if(d.length){var b=o.createAsChild(this,{entityType:"userstory"}),f=d.data("name"),p=d.data("id"),m={id:p,name:f};b.on("afterRender",function(e,t){var n=$("<div/>").append(t.element),o=s.getTerms(f).name,u=n.append(['<div class="i-role-confirmation-content" style="display: none">',"<h3>Do you really want to convert "+c+" to "+o+"?</h3>",'<div class="tau-buttons">','<button type="button" class="tau-btn tau-primary i-role-actionok">Yes, I\'m sure</button>','<button type="button" class="tau-btn i-role-actioncancel">No</button>',"</div>","</div>"].join("")),l=d.tauBubble({template:['<div class="tau-bubble">','<div class="tau-bubble__arrow" role="arrow"></div>','<div class="tau-bubble__inner tau-container" role="content"></div>',"</div>"].join(""),content:u,onPositionConfig:function(e){e.my="center top",e.at="center bottom",e.collision="flipfit flipfit"},onHide:function(){i.getKeyBoardManager().popHandler(),a.toggleClass("sub-ui-menu_dont-hide",!1),d.find(".drop-down-option").toggleClass("drop-down-option_hover",!1)},onShow:function(){i.getKeyBoardManager().pushHandler({}),a.toggleClass("sub-ui-menu_dont-hide",!0),d.find(".drop-down-option").toggleClass("drop-down-option_hover",!0);var e=l.tauBubble("widget");e.find(".tau-lookup-block").show(),e.find(".i-role-confirmation-content").hide(),e.removeClass("tau-warning-bubble"),e.find(".filter-field").focus(),e.unbind("click"),b.fire("popupResize",l),d.tauBubble("adjustPosition"),e.one("click",".i-role-actioncancel",function(){l.tauBubble("hide")}),e.one("click",".i-role-actionok",function(){l.tauBubble("hide"),r.fire("convertToTask",m)})},zIndex:10002});r.fire("$taskBubble.ready",l),b.fire("$outerBubbled.ready",l)}),b.on("entitySelected",function(e,t){var n=d.tauBubble("widget");n.find(".tau-lookup-block").hide(),n.find(".i-role-confirmation-content").show(),n.addClass("tau-warning-bubble"),d.tauBubble("adjustPosition"),r.fire("entitySelected",t)}),this.reFire(b),b.initialize({context:t.config.context})}},reFire:function(t){var n=t,o=this.bus,i=n.fire,a=n.name;n.fire=function(t,r){var u=e.toArray(arguments);i.apply(n,u),o.fire(a+"."+t,r)}},"bus entitySelected + convertToTask":function(e,t,n){this.fire("convert",{entityType:n,userStory:t.entity})}})});