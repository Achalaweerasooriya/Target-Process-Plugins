define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/utils/utils.date","libs/jquery/jquery.fileupload","libs/jquery/jquery.iframe-transport"],function(_,$,ComponentExtensionBase,dateUtils,fileUploader,transport){var errorRegExp=/<title\b[^>]*>(.*?)<\/title>/;return ComponentExtensionBase.extend({"bus permissionsReady+afterRender":function(evt){if(!this._initialized){this._initialized=!0,this.element=evt.afterRender.data.element;var permissions=evt.permissionsReady.data;permissions.editable&&permissions.deletable&&this._initUploader()}},_initUploader:function(){this._createToolbar(),this._bindUploader()},_createToolbar:function(){var $toolbar=$('<div class="uploader-toolbar"></div>'),$fileBrowser=this._createFileBrowser();$toolbar.append($fileBrowser).prependTo(this.element),this._$fileInput=$fileBrowser.find("input"),/\bapple\b/i.test(navigator.vendor)&&this._$fileInput.removeAttr("multiple")},_bindUploader:function(){this._$fileInput.fileupload({url:this._getUploadUrl(),formData:this._getFormData(),add:$.proxy(this,"_onFileAdd")})},_createFileBrowser:function(){return $('<span class="fileBrowser"><i>Attach files</i></span>').append($('<input type="file" multiple/>'))},_getUploadUrl:function(){return this.config.context.configurator.getApplicationPath()+"/UploadFile.ashx"},_getFormData:function(){return[{name:"generalId",value:this._getGeneralId()}]},_getGeneralId:function(){return this.config.context.entity.id},_getGeneralType:function(){return this.config.context.entity.entityType.name},_onFileAdd:function(event,data){var self=this;if(!data.files||data.files.length==0)return;var $newAttachment=this._createAttachmentDummy(data.files[0].name);$newAttachment.appendTo(this._getAttachmentsPlaceholder()),data.submit().success(function(result){var responseText=self._getResponseText(result);try{var attachmentData=self._parseResponse(responseText)}catch(e){self._onAttachmentUploadFail($newAttachment);return}self.bus.fire("attachmentUploaded",{element:self._updateAttachmentElement($newAttachment,attachmentData),data:attachmentData})}).error(function(jqXHR,textStatus,errorThrown){var matches=jqXHR.responseText.match(errorRegExp),error="Looks like application is not available. Please check your connection or server availability";matches&&matches.length>0&&(error=matches[1]),self._onAttachmentUploadFail($newAttachment,error)})},_updateAttachmentElement:function($attachmentElement,attachmentData){var $updatedAttachmentElement=this._createAttachmentElement(attachmentData);return $attachmentElement.replaceWith($updatedAttachmentElement),$updatedAttachmentElement},_onAttachmentUploadFail:function($attachmentElement,error){this._deleteFailedAttachmentElement($attachmentElement,error)},_getResponseText:function(result){var responseText="";return typeof result=="string"?responseText=result:result.jquery&&(responseText=result.text()),responseText},_createAttachmentDummy:function(name){var $attachmentDummy=this._createAttachmentElement({name:name});return $attachmentDummy.addClass("uploading").find(".toolbar").remove(),$attachmentDummy},_deleteFailedAttachmentElement:function($attachmentElement,error){error=error||"Upload failed",this.fire("error",{message:error}),$attachmentElement.addClass("failed");var $errorLabel=$('<p class="error"></p>').insertAfter($attachmentElement.find(".name"));$errorLabel.text("Upload failed"),$attachmentElement.fadeOut(1500,function(){$attachmentElement.remove()})},_getAttachmentsPlaceholder:function(){return this.element.find(".ui-attachments-content")},_createAttachmentElement:function(data){return $.tmpl("attachments-attachment",data)},_parseResponse:function(responseText){var xArray;try{xArray=JSON.parse(responseText),xArray=xArray.items||xArray,xArray=xArray.pop()}catch(e){}var date=dateUtils.parse(dateUtils.convertToTimezone(xArray[1])),result={id:xArray[0],uri:xArray[4],thumbnailUri:xArray[5],mimeType:xArray[3],name:xArray[2],ownerName:xArray[6][1]+" "+xArray[6][2],date:dateUtils.format.date.short(date)};return result}})})