define(["Underscore","jQuery","tau/core/event.emitter"],function(_,$,EventEmitter){return EventEmitter.extend({init:function(config){var self=this;this._super(config),this.config=config,this.routingPatterns=[],this.routingPattern404={callback:$.noop};var configurator=this.config.context.configurator,external=configurator.getExternal();this.defaultHash=external.getHash(),self.config.startUrl&&external.setHash(self.config.startUrl)},normalizeUrl:function(){var self=this,appId=self.config.applicationId,pageType=self.config.pageType,pageId=self.config.pageId;if(appId&&pageType&&pageId){var external=self.config.context.configurator.getExternal(),appValue=pageType+"/"+pageId;external.setHashParam(appId,appValue),self.onCleanAppId=function(){var appValue=external.getHashParam(appId,null);appValue||self.fire("destroy")},external.onHashChange(self.onCleanAppId)}},matchPatterns:function(patterns,notFound){var self=this,appId=self.config.applicationId,configurator=self.config.context.configurator,external=configurator.getExternal(),currentValue=null,onHashChangeHandler=function(r){var hashValue=null;appId?hashValue=r.getHashParam(appId):hashValue=r.getHash().split("&")[0];if(currentValue===hashValue)return;currentValue=hashValue;var index=-1,matchedRegexp=null;_(patterns).find(function(p,i){matchedRegexp=_.isString(p.pattern)?new RegExp(p.pattern):p.pattern;var pass=matchedRegexp.test(hashValue);return pass&&(index=i),pass});if(index!==-1){var item=patterns[index],r=matchedRegexp.exec(hashValue),args=r.slice(1);item.callback.apply(self,args)}else notFound.callback.call(self)};this.config.options.routing.silent||external.onHashChange(onHashChangeHandler);var disposer=function(){external.unbindHashChange(onHashChangeHandler)};return disposer},"bus registerRoute":function(evt){this.routingPatterns.push(evt.data)},"bus registerRouteNotFound":function(evt){this.routingPattern404=evt.data},"bus afterInit":function(){this.normalizeUrl(),this.fire("routing.registered",{})},"bus options.ready:last+controller.ready":function(evt,options){var self=this,patterns=self.routingPatterns,pattern404=self.routingPattern404;self.matchDispose=self.matchPatterns(patterns,pattern404),options.routing.executeOnStart&&self.config.context.configurator.getExternal().triggerHashChange()},destroy:function(){this._super(),this.matchDispose(),delete this.matchDispose;var cfg=this.config;if(cfg.applicationId){var external=cfg.context.configurator.getExternal();external.unbindHashChange(this.onCleanAppId),delete this.onCleanAppId,external.setHashParam(cfg.applicationId,null)}!cfg.applicationId&&cfg.integration&&cfg.integration.showInPopup&&cfg.context.configurator.getExternal().setHash(this.defaultHash),delete this.config,delete this.defaultHash}})})