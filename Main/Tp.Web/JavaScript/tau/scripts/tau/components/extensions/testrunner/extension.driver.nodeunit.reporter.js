define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/components/extensions/testrunner/utils/utils.testrunner.diff","tau/components/extensions/testrunner/utils/utils.testrunner.dump"],function(_,$,a,b,c){function d(a){return a?(a+="",a.replace(/[\&<>]/g,function(a){switch(a){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";default:return a}})):""}function e(a){if(a.stacktrace)return a.stacktrace.split("\n")[6];if(a.stack)return a.stack.split("\n")[0];!a.sourceURL}window.jsErrors=[],window.onerror=function(a){window.jsErrors[window.jsErrors.length]=a};var f=function(a){var f=a.message;f=f?f:_.isString(a.error)?a.error:"";var g=!a.error,h=a.error?a.error.expected:"",i=a.error?a.error.actual:"",j=a.error?a.error.operator:null;f=d(f)||(g?"okay":"failed"),f='<span class="test-message">'+f+"</span>",h=d(c.parse(h)),i=d(c.parse(i));var k=f;k+="<table>",j&&(k+='<tr class="test-expected"><th>Expected: </th><td><pre>'+h+"</pre></td></tr>",i!=h&&(k+='<tr class="test-actual"><th>Result: </th><td><pre>'+i+"</pre></td></tr>",k+='<tr class="test-diff"><th>Diff: </th><td><pre>'+b(h,i)+"</pre></td></tr>"));if(!g){var l=e(a.error);l&&(k+='<tr class="test-source"><th>Source: </th><td><pre>'+d(l)+"</pre></td></tr>")}return k+="</table>",k};return a.extend({"bus afterRender":function(a){this.sourceTitle=document.title,document.title="♒ In Progress "+this.sourceTitle,this.$el=a.data.element,this.startedAt=(new Date).getTime()},"bus module.start":function(a){var module=a.data.module,b=this.$el.find("#"+module.id);b.toggleClass("nodeunit-pending",!1),b.toggleClass("nodeunit-inprogress",!0);var c=this.$el.find("#nodeunit-banner");c.toggleClass("nodeunit-pending",!1),c.toggleClass("nodeunit-inprogress",!0)},"bus test.start":function(a){var b=a.data.names,c=a.data.moduleId,d=_.underscored(b.join(" ").replace(/[^a-z\d]/gi," ")),e=b.join(" "),f=b.slice(1).join(" "),g=$(["<li id="+d+' role="test">',"<strong>"+f,'<b class="counts"> (','<b class="failed" role="failed">&infin;</b>,','<b class="passed" role="passed">&infin;</b>,','<b class="all" role="all">&infin;</b>',")</b> ",'<b class="all" role="time">&infin;</b> ms',"</strong>",'<a href="?filter='+e+'">Rerun</a>',"</li>"].join(""));this.$el.find("#"+c).find("[role=tests]").append(g)},"bus test.done":function(a){var b=a.data.names,c=a.data.assertions,d=a.data.moduleId,e=_.underscored(b.join(" ").replace(/[^a-z\d]/gi," ")),g=this.$el.find("#"+d).find("#"+e);g.find("[role=time]").text(c.duration),g.find("[role=passed]").text(c.passes()),g.find("[role=failed]").text(c.failures()),g.find("[role=all]").text(c.length);var h=$(["<ol>","</ol>"].join(""));_.forEach(c,function(a){var b=$("<li></li>"),c=f(a);a.failed()?(b.html(c),b.addClass("fail"),window.jsErrors.push("failure:"+a.message)):(b.html(a.message||a.method||"no message"),b.addClass("pass")),b.appendTo(h)}),c.failures()||h.hide(),g.find("strong").click(function(){h.toggle()}),h.appendTo(g)},"bus module.done":function(a){var module=a.data.module,b=a.data.assertions,c=this.$el.find("#"+module.id),d=!!b.failures();c.toggleClass("nodeunit-inprogress",!1),c.toggleClass("nodeunit-failed",d),c.toggleClass("nodeunit-passed",!d);var e=c.find("[role=result]");e.find("[role=time]").text(b.duration),e.find("[role=passed]").text(b.passes()),e.find("[role=failed]").text(b.failures()),e.find("[role=all]").text(b.length);var f=c.find("[role=test]");f.length==0&&c.hide()},"bus modules.done":function(a){if(!this.$el)return;var b=a.data.assertions,c=(new Date).getTime(),d=c-this.startedAt,e=b.failures(),f=!!e,g=this.$el.find("#nodeunit-banner");g.toggleClass("nodeunit-inprogress",!1),g.toggleClass("nodeunit-fail",f),g.toggleClass("nodeunit-pass",!f),document.title=f?"✖ Failed "+this.sourceTitle:"✔ Passed "+this.sourceTitle,window.allTestsCompleted=!0;var h=this.$el.find("[role=result-total]");h.find("[role=time]").text(b.duration),h.find("[role=passed]").text(b.passes()),h.find("[role=failed]").text(b.failures()),h.find("[role=all]").text(b.length)}})})