define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/components/extensions/testrunner/utils/utils.testrunner.diff","tau/components/extensions/testrunner/utils/utils.testrunner.dump"],function(e,t,s,n,r){function i(e){return e.replace(/(http:\/\/.+\.js)(?:\?[^:]+)?(:(\d+(:\d+)?))?/g,'<a href="$1#$3">$&</a>')}function a(e){return e?(e+"").replace(/[&<>]/g,function(e){switch(e){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";default:return e}}):""}function o(e){return e.stack?e.stack.split("\n").slice(0,3).join("\n"):e.stacktrace?e.stacktrace.split("\n").slice(0,3).join("\n"):""}function l(t){return t.message||(e.isString(t.error)?t.error:"")}window.jsErrors=[],window.notExecutedTests={},window.getNotExecutedTests=function(){return e.values(window.notExecutedTests)},window.onerror=function(e,t,s){window.jsErrors.push(e+(t?" url: "+t+" line: "+s:""))};var d=function(e){var t=!e.error,s=e.error?e.error.expected:"",d=e.error?e.error.actual:"",u=e.error?e.error.operator:null,f=l(e);f=i(a(f))||(t?"okay":"failed"),f='<span class="test-message">'+f+"</span>",s=a(r.parse(s)),d=a(r.parse(d));var c=f;if(c+="<table>","!="===u?c+='<tr class="test-expected"><th>Expected: </th><td><pre>'+d+" != "+s+"</pre></td></tr>":u&&(c+='<tr class="test-expected"><th>Expected: </th><td><pre>'+s+"</pre></td></tr>",d!=s&&(c+='<tr class="test-actual"><th>Result: </th><td><pre>'+d+"</pre></td></tr>",c+='<tr class="test-diff"><th>Diff: </th><td><pre>'+n(s,d)+"</pre></td></tr>")),!t){var p=o(e.error);p&&(c+='<tr class="test-source"><th>Source: </th><td><pre>'+i(a(p))+"</pre></td></tr>")}return c+="</table>"};return s.extend({TITLE:{inProgress:"♒ In Progress",failed:"✖ Failed",passed:"✔ Passed"},"bus afterRender":function(e){this.$el=e.data.element,this._setTitle(this.TITLE.inProgress),this.$el.find("#togglePassedModules").on("click",function(){t("body").toggleClass("nodeunit-hide-passed")})},"bus module.start":function(e){var t=e.data.module,s=this.$el.find("#"+t.id);
s.removeClass("nodeunit-pending").addClass("nodeunit-inprogress");var n=this.$el.find("#nodeunit-banner");n.removeClass("nodeunit-pending").addClass("nodeunit-inprogress")},"bus test.start":function(s){var n=s.data.names,r=s.data.moduleId,i=e.underscored(n.join(" ").replace(/[^a-z\d]/gi," ")),a=n.join(" "),o=n.slice(1).join(" ");window.notExecutedTests[i]=a;var l=t(["<li id="+i+' role="test">',"<strong>"+o,'<b class="counts"> (','<b class="failed" role="failed">&infin;</b>,','<b class="passed" role="passed">&infin;</b>,','<b class="all" role="all">&infin;</b>',")</b> ",'<b class="all" role="time">&infin;</b> ms',"</strong>",'<a href="?filter='+encodeURIComponent(a)+'">Rerun</a>',"</li>"].join(""));this.$el.find("#"+r).find("[role=tests]").append(l)},"bus test.done":function(s){var n=s.data.names,r=s.data.assertions,i=s.data.moduleId,a=e.underscored(n.join(" ").replace(/[^a-z\d]/gi," "));delete window.notExecutedTests[a];var o=this.$el.find("#"+i).find("#"+a);o.find("[role=time]").text(r.duration),o.find("[role=passed]").text(r.passes()),o.find("[role=failed]").text(r.failures()),o.find("[role=all]").text(r.length);var u=t("<ol></ol>");e.each(r,function(e){var s,n;e.failed()?(s=d(e),n="fail",window.jsErrors.push("failure: "+l(e))):(s=e.message||e.method||"no message",n="pass"),t("<li></li>").html(s).addClass(n).appendTo(u)}),r.failures()||u.hide(),o.find("strong").click(function(){u.toggle()}),u.appendTo(o)},"bus module.done":function(e){var t=e.data.module,s=e.data.assertions,n=this.$el.find("#"+t.id),r=!!s.failures();n.removeClass("nodeunit-inprogress").toggleClass("nodeunit-failed",r).toggleClass("nodeunit-passed",!r);var i=n.find("[role=result]");i.find("[role=time]").text(s.duration),i.find("[role=passed]").text(s.passes()),i.find("[role=failed]").text(s.failures()),i.find("[role=all]").text(s.length);var a=this.$el.find("[role=result-total]"),o=a.find("[role=passed]"),l=parseInt(o.text(),10)||0;o.text(l+s.passes());var d=a.find("[role=failed]"),u=parseInt(d.text(),10)||0;
d.text(u+s.failures());var f=n.find("[role=test]");f.length||n.hide()},"bus modules.done":function(e){if(this.$el){var t=e.data.assertions,s=t.failures(),n=!!s,r=this.$el.find("#nodeunit-banner");r.removeClass("nodeunit-inprogress").toggleClass("nodeunit-fail",n).toggleClass("nodeunit-pass",!n),this._setTitle(n?this.TITLE.failed:this.TITLE.passed),window.allTestsCompleted=!0;var i=this.$el.find("[role=result-total]");i.find("[role=time]").text(t.duration),i.find("[role=passed]").text(t.passes()),i.find("[role=failed]").text(t.failures()),i.find("[role=all]").text(t.length)}},_setTitle:function(e){var t=this.config.context.configurator;t.getTitleManager().setTitle(e)}})});