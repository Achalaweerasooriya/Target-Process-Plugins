define(["require","jQuery","Underscore","tau/core/extension.base","../customReport.renderer"],function(t){var e=t("jQuery"),r=t("Underscore"),i=t("tau/core/extension.base"),s=t("../customReport.renderer");return i.extend({init:function(t){this._super(t),this._lastTick=null,this._lastChart=null,this._lastRenderer=null},"bus afterInit":function(){this.fire("dataBind")},"bus configurator.ready":function(t,e){var i={callbacks:[],finish:function(){r.each(i.callbacks,function(t){t()})},onFinish:function(t){i.callbacks.push(t)}};e.registerService("report.rendering",i)},"bus boardSettings.ready:last +  afterRender + configurator.ready + view.dom.ready:last":function(t,e,r,i){var s=e.boardSettings;this._$report=r.element,this._drawReportOnInit(i,s),this._subscribeOnAppStateChanged(i,s),this._subscribeOnBoardSettingsChanged(i,s);var n=i.getSettingsManager();n.unbind({listener:this}),n.bind({fields:["collapser_aside_collapsed"],listener:this,callback:function(){this._resizeChart()}})},destroy:function(){this._destroyRendererIfRequired(),this._destroyChartIfRequired(),this._super()},_resizeChart:function(){this._lastChart&&this._lastChart.resize()},"bus boardSettings.ready:last + configurator.ready:last + destroy":function(t,e,r){e.boardSettings.unbind(this),r.getAppStateStore().unbind(this);var i=r.getSettingsManager();i.unbind({listener:this})},_subscribeOnBoardSettingsChanged:function(t,e){e.unbind({listener:this}),e.bind({fields:["edit"],listener:this,callback:function(){setTimeout(this._resizeChart.bind(this),300)}}),e.bind({fields:["reportSettings","reportError"],listener:this,callback:this.safeCallback(function(r){this._getReportSettingsWithDescriptions(e).then(function(i){r.reportError?(this._destroyChartIfRequired(),this._createRenderer(t).renderCustomReportError(r.reportError,i,this._$report)):this._drawReport(i,t,e)}.bind(this))})})},_subscribeOnAppStateChanged:function(t,e){var i=t.getAppStateStore();i.unbind({listener:this}),i.bind({fields:["acid"],listener:this,callback:function(i){this._getReportSettingsWithDescriptions(e).done(function(s){var n=r.cloneDeep(s),a=n.reportSettings.dataSource.global;
n.reportSettings.tick=a&&a.acid===i.acid?n.reportSettings.tick:(new Date).getTime(),n.reportSettings.dataSource.global={acid:i.acid},this._drawReport(n,t,e,!1)}.bind(this))}.bind(this)})},_getReportSettingsWithDescriptions:function(t){return t.get({fields:["reportSettings","description"]}).then(this.safeCallback(function(t){return t}))},_drawReportOnInit:function(t,e){this._getReportSettingsWithDescriptions(e).done(function(r){this._lastTick=null,this._drawReport(r,t,e)}.bind(this))},_drawReport:r.debounce(function(t,e,i,s){if(t.reportSettings.tick!==this._lastTick&&null!==this._$report){var n=t.reportSettings.dataSource.global;t=r.cloneDeep(t),this._destroyChartIfRequired(),this._$report.tauProgressIndicator(),this._$report.tauProgressIndicator("show"),this._getAcid(e,i,t).then(this.safeCallback(function(r){return t.reportSettings.dataSource.global={acid:r},this._createRenderer(e).renderCustomReport(this._$report,t,{boardSettings:i})})).then(this.safeCallback(function(t){if(s!==!1){var e=t.chartSettings;e.tick=e.tick||(new Date).getTime(),e.dataSource.global=n,this._lastTick=e.tick,i.set({set:{reportSettings:e}})}this._destroyChartIfRequired(),this._lastChart=t.chart}.bind(this))).fail(this.safeCallback(function(){this._destroyChartIfRequired()}.bind(this))).always(this.safeCallback(function(){this._$report.tauProgressIndicator("hide"),e.service("report.rendering").finish()}))}},200),_createRenderer:function(t){return this._destroyRendererIfRequired(),this._lastRenderer=new s(t),this._lastRenderer},_destroyChartIfRequired:function(){this._lastChart&&(this._lastChart.destroy(),this._lastChart=null)},_destroyRendererIfRequired:function(){this._lastRenderer&&this._lastRenderer.destroy()},_getAcid:function(t,r,i){var s=e.Deferred(),n=i.reportSettings.dataSource.global;return n&&n.acid?s.resolve(n.acid):r.get({fields:["acid"]}).then(function(e){e&&e.acid?s.resolve(e.acid):t.getAppStateStore().get({fields:["acid"]}).then(function(t){s.resolve(t.acid)})}),s}})});