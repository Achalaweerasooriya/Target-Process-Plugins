define(["require","Underscore","tau/core/class","./entityColorBrewer","tau/utils/customReport/customReport.modelParser"],function(e){var t=e("Underscore"),r=e("tau/core/class"),i=e("./entityColorBrewer"),n=e("tau/utils/customReport/customReport.modelParser");return r.extend({init:function(e){this._reportSettings=e.reportSettings,this._metaInfo=e.metaInfo},getGuide:function(){var e=t.cloneDeep(this._reportSettings.report),r=this._safeGuide(t.cloneDeep(e.guide));return this._applyLabels(r),r},getDimensions:function(){return t.reduce(this._reportSettings.dataSource.dimensions,function(e,t){var r=this._getDimension(t);return r&&(e[t.id]=r),e},{},this)},getType:function(){if("bar"===this._reportSettings.report.type){var e=this._reportSettings.report.dimensions||{},t=this._makeArray(this._reportSettings.report.x),r=e[t[t.length-1]];if(r&&"measure"===r.type)return"horizontalBar"}return this._reportSettings.report.type},applyColorBrewer:function(e){if(e=this._safeGuide(e),this._reportSettings.report.color){var r=t.find(this._reportSettings.dataSource.dimensions,function(e){return e.id===this._reportSettings.report.color&&0===e.model.toLowerCase().indexOf("entitytype")}.bind(this));if(r){var n=e.length-1;e[n].color||(e[n].color={}),e[n].color.brewer||(e[n].color={brewer:i})}}},_safeGuide:function(e){return t.isArray(e)||(e=[e||{}]),e},_getDimension:function(e){var r=t.find(this._metaInfo.dimensions,function(t){return t.id===e.id});if(!r)return null;switch(r.type.toLowerCase()){case"date":return{type:"order",scale:"period"};case"float":case"int":return{type:"measure",scale:"linear"};default:return{type:"category",scale:"ordinal"}}},_applyLabels:function(e){var r={},i=this._reportSettings.dataSource.dimensions;t.each(i,function(e){r[e.id]=this._getGuidePart(e)}.bind(this)),this._applyXY(e,r),this._applyDimension(e,r,"color"),this._applyDimension(e,r,"size")},_applyDimension:function(e,t,r){t[r]&&(e[e.length-1][r]=t[r])},_makeArray:function(e){return t.isArray(e)?e:[e]},_applyXY:function(e,r){for(var i=this._makeArray(t.cloneDeep(this._reportSettings.report.x)),n=this._makeArray(t.cloneDeep(this._reportSettings.report.y)),o=(i.length>n.length?i.length:n.length)-1;o>=0;)e[o]||(e[o]={}),this._setAxisToGuide(r,{name:"x",value:i},e,o),this._setAxisToGuide(r,{name:"y",value:n},e,o),o--
},_setAxisToGuide:function(e,t,r,i){var n=t.value.pop();n&&(r[i][t.name]=this._getAxisById(e,n))},_getAxisById:function(e,r){var i=t.find(t.keys(e),function(e){return e===r});return e[i]},_getGuidePart:function(e){var r=e.model;try{var i=n.parse(r);if("string"==typeof i){var o={label:t.humanize(i)};return this._processTick(e,o),o}return{label:t.humanize(i.label),tickPeriod:i.tickPeriod}}catch(s){return{label:r}}},_processTick:function(e,r){var i=e.model;i.toLowerCase().indexOf("progress")>=0&&(r.tickFormat="%");var n=t.find(this._metaInfo.dimensions,function(t){return e.id==t.id});"date"===n.type.toLowerCase()&&(r.tickPeriod="day")}})});