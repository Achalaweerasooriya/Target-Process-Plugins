define(["require","Underscore","tau/core/class","./entityColorBrewer","tau/utils/customReport/customReport.modelParser"],function(e){var t=e("Underscore"),r=e("tau/core/class"),n=e("./entityColorBrewer"),i=e("tau/utils/customReport/customReport.modelParser");return r.extend({init:function(e){this._reportSettings=e.reportSettings,this._metaInfo=e.metaInfo},getGuide:function(){var e=t.cloneDeep(this._reportSettings.report),r=this._safeGuide(t.cloneDeep(e.guide));return this._applyLabels(r),r},getDimensions:function(){return t.reduce(this._reportSettings.dataSource.dimensions,function(e,t){var r=this._getDimension(t);return r&&(e[t.id]=r),e},{},this)},getType:function(){if("bar"===this._reportSettings.report.type){var e=this._reportSettings.report.dimensions||{},t=this._makeArray(this._reportSettings.report.x),r=e[t[t.length-1]];if(r&&"measure"===r.type&&"time"!==r.scale)return"horizontalBar"}return this._reportSettings.report.type},applyColorBrewer:function(e){if(e=this._safeGuide(e),this._reportSettings.report.color){var r=this.entityTypeAsColorDimension();if(r){var i=e.length-1;e[i].color||(e[i].color={}),e[i].color.brewer||t.extend(e[i].color,{brewer:n})}}},entityTypeAsColorDimension:function(){return t.find(this._reportSettings.dataSource.dimensions,function(e){var t=e.model.toLowerCase();return e.id===this._reportSettings.report.color&&("entitytype"===t||"entitytype.name"===t)}.bind(this))},_safeGuide:function(e){return t.isArray(e)||(e=[e||{}]),e},_getMetaInfo:function(e){return t.find(this._metaInfo.dimensions,function(t){return t.id===e.id})},_getDimension:function(e){var t=this._getMetaInfo(e);if(!t)return null;switch(t.type.toLowerCase()){case"date":var r=i.parse(e.model);return"string"==typeof r?{type:"measure",scale:"time"}:{type:"order",scale:"period"};case"float":case"int":return{type:"measure",scale:"linear"};case"entity":case"user":return{type:"category",scale:"ordinal",value:"id"};default:return{type:"category",scale:"ordinal"}}},_applyLabels:function(e){var r={},n=this._reportSettings.dataSource.dimensions;
t.each(n,function(e){r[e.id]=this._getGuidePart(e)}.bind(this)),this._applyXY(e,r),this._applyDimension(e,r,"color"),this._applyDimension(e,r,"size")},_applyDimension:function(e,t,r){var n=t[this._reportSettings.report[r]];n&&(e[e.length-1][r]=n)},_makeArray:function(e){return t.isArray(e)?e:[e]},_applyXY:function(e,r){for(var n=this._makeArray(t.cloneDeep(this._reportSettings.report.x)),i=this._makeArray(t.cloneDeep(this._reportSettings.report.y)),o=(n.length>i.length?n.length:i.length)-1;o>=0;)e[o]||(e[o]={}),this._setAxisToGuide(r,{name:"x",value:n},e,o),this._setAxisToGuide(r,{name:"y",value:i},e,o),o--},_setAxisToGuide:function(e,t,r,n){var i=t.value.pop();i&&(r[n][t.name]=this._getAxisById(e,i))},_getAxisById:function(e,r){var n=t.find(t.keys(e),function(e){return e===r});return e[n]},_getGuidePart:function(e){var r,n=e.model;try{var o=i.parse(n);if("string"==typeof o){var s={label:t.humanize(o)};this._processTick(e,s),r=s}else r={label:t.humanize(o.label),tickPeriod:o.tickPeriod}}catch(a){r={label:n}}var u=this._getMetaInfo(e);if(u){var c={Entity:"name",User:"fullName"},l=c[u.type];l&&(r.tickLabel=l)}return r},_processTick:function(e,t){var r=e.model;r.toLowerCase().indexOf("progress")>=0&&(t.tickFormat="%")},calcFacetSizeInfo:function(e){var r=this._reportSettings.report,n=this._reportSettings.dataSource.dimensions,i=function(e){var r=t.reduce(e,function(e,t){return e.push(t),e},[null,null]);return r.slice(r.length-2)},o=function(e){return null===e||"measure"!==r.dimensions[e].type},s=function(e){return JSON.stringify(e)},a=function(e,r){var i=t.filter(n,function(t){return t.id===e}),o=(i[0]||{}).model||r;return t.humanize(o)},u=function(e){var r=t.isString(e)?[e]:e,n=i(r);return t.filter(n,o)[0]},c=function(e,r){var n=null===e?[]:t(r).chain().pluck(e).unique(s).value();return n.length||1},l=u(r.x),p=u(r.y);return{x:c(l,e),y:c(p,e),xName:a(l,"X"),yName:a(p,"Y")}}})});