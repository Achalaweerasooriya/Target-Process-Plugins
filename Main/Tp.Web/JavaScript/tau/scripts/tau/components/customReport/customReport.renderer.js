define(["require","jQuery","Underscore","tau/core/class","tau/utils/utils.date","vendors/tauCharts/tauCharts","../customReport.editor/customReport.settings.parser","tau/customReport/api","./customReport.report.processor","vendors/tauCharts/tauCharts.tooltip","vendors/tauCharts/tauCharts.legend","./openEntity.plugin","vendors/tauCharts/tauCharts.trendline"],function(t){var e=t("jQuery"),r=t("Underscore"),n=t("tau/core/class"),o=t("tau/utils/utils.date"),i=t("vendors/tauCharts/tauCharts"),s=t("../customReport.editor/customReport.settings.parser"),a=t("tau/customReport/api"),u=t("./customReport.report.processor"),p=t("vendors/tauCharts/tauCharts.tooltip"),d=t("vendors/tauCharts/tauCharts.legend"),g=t("./openEntity.plugin"),l=t("vendors/tauCharts/tauCharts.trendline"),c=n.extend({init:function(t){this._configurator=t},renderCustomReportError:function(t,e){this._showError(e,t.name+": "+t.message)},renderCustomReport:function(t,e,r){t.empty();var n=new s({reportSettings:e}),o=n.isEmpty();return t.toggleClass("i-role-custom-report-container--is-empty",o),o?this._showError(t,"No report"):this._drawReport(e,t,r||{})},_drawReport:function(t,e,r){return(new a).report(t.dataSource).then(function(n){var o=this._process(n.data);if(0===o.length)return this._showError(e,"There is no data to build Report");var i=this._processDataLength(e,o);return this._buildReport(t,i,n.metaInfo,e,r)}.bind(this))},_process:function(t){return r.map(t,function(t){return r.each(r.pairs(t),function(e){o.isTimestamp(e[1])&&(t[e[0]]=o.convertToTimezone(e[1])[0])}),t.dataItem&&(t.id=t.dataItem.id,t.name=t.dataItem.data.name,t.type=t.dataItem.type),t})},_processDataLength:function(t,e){var r=e.length>5e3;return this._toggleDataLengthWarning(t,r),r?e.slice(0,4999):e},_buildReport:function(t,n,o,s,a){try{var u=this._completeReportSettings(t,o),p=u.settingsToApply,d="<pre>There is no data to build Report</pre>",g=p.report.type?new i.Chart(r.extend({data:n,plugins:this.getChartPlugins(t,o,n),autoResize:a.autoResize},p.report)):new i.Plot({data:n,emptyContainer:d,spec:p.report});
return g.renderTo(s.get(0),a.size),e.Deferred().resolve({chart:g,chartSettings:u.settingsToReturn})}catch(l){return this._showError(s,l.stack||l)}},getChartPlugins:function(t,e,r){return[this.getTooltipPlugin(t,r),this.getLegendPlugin(),this.getTrendlinePlugin(),this.getOpenEntityPlugin()]},getTooltipPlugin:function(t,e){var r=this._createTooltipPluginConfig(t.dataSource.dimensions,e);return p(r)},getOpenEntityPlugin:function(){return g(this._configurator)},getTrendlinePlugin:l,getLegendPlugin:d,_createTooltipPluginConfig:function(t,e){var n=r.pluck(t,"id");return r.isUndefined(e[0].id)||(n.indexOf("name")<0&&n.push("name"),n.indexOf("type")<0&&n.indexOf("entityType")<0&&n.push("type"),n.push("id")),{fields:n}},_completeReportSettings:function(t,e){var n=r.deepClone(t),o=new u({reportSettings:n,metaInfo:e});n.report.guide=n.report.guide||o.getGuide(),n.report.dimensions=n.report.dimensions||o.getDimensions(),n.report.type=o.getType();var i=r.deepClone(n);return o.applyColorBrewer(i.report.guide),{settingsToApply:i,settingsToReturn:n}},_showError:function(t,r){var n=e("<pre>").text(r);return t.empty().append(n).removeClass("i-role-custom-report-container--no-error"),e.Deferred().reject({message:r})},_toggleDataLengthWarning:function(t,e){t.parent().find(".i-role-dataLength-warning").toggleClass("tau-hide",!e)}});return c});