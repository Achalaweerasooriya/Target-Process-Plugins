define(["require","jQuery","Underscore","tau/core/class","tau/utils/utils.date","vendors/tauCharts/tauCharts","../customReport.editor/customReport.settings.parser","tau/customReport/api","./customReport.report.processor","./customReport.errorParser","./customReport.renderer.description","./tooltip.plugin","vendors/tauCharts/tauCharts.legend","./openEntity.plugin","vendors/tauCharts/tauCharts.trendline","vendors/tauCharts/tauCharts.export","template!tau/components/customReport/templates/customReport.empty.template","template!tau/components/customReport/templates/customReport.noData.template","template!tau/components/customReport/templates/customReport.error.template","template!tau/components/customReport/templates/customReport.error.common.template","tau/utils/utils.customFields"],function(t){var e=t("jQuery"),r=t("Underscore"),n=t("tau/core/class"),o=t("tau/utils/utils.date"),s=t("vendors/tauCharts/tauCharts"),a=t("../customReport.editor/customReport.settings.parser"),i=t("tau/customReport/api"),u=t("./customReport.report.processor"),p=t("./customReport.errorParser"),c=t("./customReport.renderer.description"),g=t("./tooltip.plugin"),l=t("vendors/tauCharts/tauCharts.legend"),m=t("./openEntity.plugin"),h=t("vendors/tauCharts/tauCharts.trendline"),d=t("vendors/tauCharts/tauCharts.export"),f=t("template!tau/components/customReport/templates/customReport.empty.template"),_=t("template!tau/components/customReport/templates/customReport.noData.template"),R=t("template!tau/components/customReport/templates/customReport.error.template"),y=t("template!tau/components/customReport/templates/customReport.error.common.template"),v=t("tau/utils/utils.customFields"),C=1e3,D=500,E=100,T={ERROR_FACET_SIZE:"error.facet.size"},w=n.extend({init:function(t){this._configurator=t,this._noDataHtml=_.render(),this._descriptionRenderer=null,this._emptyChart=f.render()},renderCustomReportError:function(t,e,r){var n=this._getReportEl(r),o=t.name+": "+t.message;this._showErrorHtml(n,o),this._trackError(o)
},renderCustomReport:function(t,e,r){r=r||{};var n=this._getReportEl(t);this._toggleDataLengthWarning(n,".i-role-manyCategory-warning",!1),this._toggleDataLengthWarning(n,".i-role-dataLength-warning",!1),n.empty(),r.getLoaderTemplate&&n.append(r.getLoaderTemplate());var o=new a({reportSettings:e.reportSettings}),s=o.isEmpty();return n.toggleClass("i-role-custom-report-container--is-empty",s),s?this._showError(n,this._emptyChart):(this._setDescription(t,e,r),o.hasDataSource()?this._drawReport(e,n,r):this._showError(n,this._noDataHtml))},destroy:function(){this._descriptionRenderer&&this._descriptionRenderer.destroy()},_getReportEl:function(t){return t.find(".i-role-report-content")},_setDescription:function(t,e,r){this._descriptionRenderer=new c(t);var n=this._configurator.getLoggedUser(),o=this._configurator.getBoardAccessService(),s=r.boardSettings?o.isEditable(r.boardSettings.settings,n):!1;s?this._descriptionRenderer.bindDescription(r.boardSettings):this._descriptionRenderer.setDescription(e)},_drawReport:function(t,n,o){var s=t.reportSettings,a={startedAt:this._getTimestamp(),reportSettings:s};return(new i).report(s.dataSource).then(function(i){var p=i.data.length;if(a.serverDoneAt=this._getTimestamp(),a.dataLength=p,0===p)return e.Deferred().reject({noData:!0,message:"There is no data to create the chart"});var c=r.deepClone(s),g=new u({reportSettings:c,metaInfo:i.metaInfo}),l=this._completeReportSettings(c,g),m=this._processData(n,g,i);a.reportSettings=l.settingsToReturn;var h=g.calcFacetSizeInfo(m);if(h.x*h.y>E){var d=this._buildFacetWarningMessage(h);return this._toggleDataLengthWarning(n,".warning-message",!1),e.Deferred().reject({message:d,errType:T.ERROR_FACET_SIZE,noData:!1})}var f=r.extend({},o,{hasDescription:Boolean(t.description)});return this._buildReport(l,m,i.metaInfo,n,f)}.bind(this)).always(function(){a.clientDoneAt=this._getTimestamp(),this._trackPerformance(a)}.bind(this)).fail(function(t){t.noData?o.getEmptyTemplate?this._showError(n,o.getEmptyTemplate(t.message)):this._showError(n,this._noDataHtml):t.errType===T.ERROR_FACET_SIZE?(this._showError(n,y.render({header:"Too many facets",message:t.message,iconClass:"tau-icon-message-too-many-facets",helpArticleId:"customreport.error.facet.size"})),this._trackError(t.message)):(this._showErrorHtml(n,t.message),this._trackError(t.message))
}.bind(this))},_trackPerformance:function(t){var e={serverTime:t.serverDoneAt-t.startedAt,reportSettings:t.reportSettings,dataLength:t.dataLength};e.clientTime=t.clientDoneAt?t.clientDoneAt-t.serverDoneAt:0,e.totalTime=e.clientTime+e.serverTime,taus.track("customReport",{action:"performance",data:e})},_trackError:function(t){taus.track("customReport",{action:"error",error:t})},_processData:function(t,e,n){var o=this._normalizeData(n);this._toggleDataLengthWarning(t,".i-role-manyCategory-warning",!1),this._toggleDataLengthWarning(t,".i-role-dataLength-warning",!1);var s=!1,a=!1;o.length>C&&(s=!0,o=o.slice(0,C));var i=r.filter(n.metaInfo.dimensions,function(t){var e=t.type.toLowerCase();return"string"==e||"entity"==e||"user"==e}),u=r.toObject(i,"id",function(t){return{type:t.type,values:{},length:0}}),p=r.pluck(i,"id");r.find(o,function(t){return r.each(p,function(e){var r=t[e];r=r?r.id||r:null,u[e].values[r]||(u[e].values[r]=!0,u[e].length++,u[e].length>D&&(a=!0))}),a}),a?(o=o.slice(0,D),this._toggleDataLengthWarning(t,".i-role-manyCategory-warning",!0)):s&&this._toggleDataLengthWarning(t,".i-role-dataLength-warning",!0);var c=e.entityTypeAsColorDimension();return c&&r.each(o,function(t){var e=t[c.id],n=r.isObject(e);n&&(e.name=r.humanize(e.name)),t[c.id]=n?e:r.humanize(t[c.id])}),o},_buildFacetWarningMessage:function(t){var e=t.x*t.y,n=[],o=[],s=function(t,e){t>1&&(n.push(t+" "+r.pluralize(e)),o.push(e))};return s(t.x,t.xName),s(t.y,t.yName),["You have ",n.join(" and "),", so the resulting report has ",e," facets and it is too large to display. ","Use filters to narrow down ",o.join(" and ")," axes to have less than 100 facets."].join("")},_normalizeData:function(t){var e=r.toObject(t.metaInfo.dimensions,"id");return r.map(t.data,function(t){return r.each(r.pairs(t),function(n){var s=n[0],a=n[1],i=a;v.isNA(a)?i=null:o.isTimestamp(a)?i=o.convertToTimezone(a)[0]:r.isNumber(a)&&(i=Math.round(100*a)/100),t[s]=i;var u=e[s];u&&u.type&&"user"==u.type.toLowerCase()&&(a.fullName=[a.firstName,a.lastName].join(" "))
}),t})},_buildReport:function(t,n,o,a,i){try{var u=t.settingsToApply,p=this._noDataHtml.get(0).outerHTML,c=u.report.type||!u.report.hasOwnProperty("unit")?new s.Chart(r.extend({data:n,emptyContainer:p,plugins:this.getChartPlugins(u,n),lineOrientation:"none",autoResize:i.autoResize},u.report)):new s.Plot({data:n,emptyContainer:p,spec:u.report});return a.empty(),c.renderTo(a.get(0),this._getSize(a,i)),e.Deferred().resolve({chart:c,chartSettings:t.settingsToReturn})}catch(g){return e.Deferred().reject({message:g.stack&&g.stack.split("\n")[0]||g,noData:!1})}},_getSize:function(t,e){return e.size?r.clone(e.size):e.hasDescription?{height:t.outerHeight()-70}:null},_getTimestamp:function(){return(new Date).getTime()},getChartPlugins:function(t,e){return[this.getTooltipPlugin(t,e),this.getLegendPlugin(),this.getTrendlinePlugin(),this.getOpenEntityPlugin(),this.getExportPlugin()]},getExportPlugin:function(){var t=this._configurator.getApplicationPath();return d({cssPaths:[t+"/JavaScript/tau/scripts/vendors/tauCharts/tauCharts.css",t+"/JavaScript/tau/scripts/vendors/tauCharts/tauCharts.trendline.css",t+"/JavaScript/tau/css.board/css/entity-colors.css"]})},getTooltipPlugin:function(t,e){return g.getPlugin(this._configurator,t,e)},getOpenEntityPlugin:function(){return m(this._configurator)},getTrendlinePlugin:h,getLegendPlugin:l,_completeReportSettings:function(t,e){t.report.guide=t.report.guide||e.getGuide(),t.report.dimensions=t.report.dimensions||e.getDimensions(),t.report.type=e.getType();var n=r.deepClone(t);return e.applyColorBrewer(n.report.guide),{settingsToApply:n,settingsToReturn:t}},_showError:function(t,r){return t.empty().append(r).removeClass("i-role-custom-report-container--no-error"),e.Deferred().reject()},_toggleDataLengthWarning:function(t,e,r){t.parent().find(e).toggleClass("tau-hide",!r)},_showErrorHtml:function(t,e){var r=p.getMessage(e),n=r.indexOf("Not supported python")>=0||r.indexOf("DSL processing failed:")>=0;return this._showError(t,R.render({message:r,isFilterError:n}))
}});return w});