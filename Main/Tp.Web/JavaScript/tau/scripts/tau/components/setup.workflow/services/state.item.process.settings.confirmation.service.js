define(["require","Underscore","jQuery","libs/react/react-ex","tau/core/class","template!tau/components/tauBubble/templates/board.bubble","jsx!../views/unassign.role.confirmation","jsx!../views/delete.confirmation"],function(e){var t=e("Underscore"),n=e("jQuery"),i=e("libs/react/react-ex"),s=e("tau/core/class"),o=e("template!tau/components/tauBubble/templates/board.bubble"),r=e("jsx!../views/unassign.role.confirmation"),a=e("jsx!../views/delete.confirmation");return s.extend({init:function(e){this._stateSettings=e},confirmSave:function(e,i,s){var o=t.findWhere(e.states,{id:i.id}),r=o.activeRoleId,a=r!=i.activeRoleId;return a&&this._isTheOnlyRoleUsage(e.states,r)?this._stateSettings.getRoleAssignmentsCount({id:r}).then(this._openUnassignConfirmationIfRequired.bind(this,e,n(s),r)):n.when()},_isTheOnlyRoleUsage:function(e,n){return 1===t.filter(e,t.matches({activeRoleId:n})).length},_openUnassignConfirmationIfRequired:function(e,t,i,s){if(s){var o=n.Deferred().fail(this._closeBubble.bind(this,t)),a=this._createUnassignConfirmationViewProps(o,e,i,s);return this._showBubble(t,this._createReactContents(r,a)),o}return n.when()},_createUnassignConfirmationViewProps:function(e,n,i,s){return{role:t.findWhere(n.roles,{id:i}),terms:n.terms,roleAssignmentsCount:s,onSubmit:e.resolve.bind(e),onCancel:e.reject.bind(e)}},confirmDelete:function(e,i,s){var o=t.findWhere(e.states,{id:i.id}),r=o.activeRoleId,c=this._isTheOnlyRoleUsage(e.states,r)?this._stateSettings.getRoleAssignmentsCount({id:o.activeRoleId}):0;return n.when(this._stateSettings.getAffectedEntitiesCount(o),c).then(function(t,i){var r=n.Deferred(),c=this._createDeleteConfirmationViewProps(r,e,o,t,i),u=n(s);return this._showBubble(u,this._createReactContents(a,c)),n.when(r,t).fail(this._closeBubble.bind(this,u))}.bind(this))},_createDeleteConfirmationViewProps:function(e,n,i,s,o){return{affectedEntitiesCount:s,roleAssignmentsCount:o,subStatesCount:i.subEntityStatesCount,role:t.findWhere(n.roles,{id:i.activeRoleId}),states:s>0&&t.reject(n.states,t.matches({id:i.id})),terms:n.terms,onSubmit:e.resolve.bind(e),onCancel:e.reject.bind(e)}
},_createReactContents:function(e,t){var n=document.createElement("div");return i.renderClass(e,t,n),{content:n,destroy:function(){i.unmountComponentAtNode(this.content)}}},_showBubble:function(e,t){e.tauBubble({className:"tau-bubble-tooltipArticle",template:o.render(),showOnCreation:!0,content:t.content,onPositionConfig:function(e){e.my="center top",e.at="center bottom"},onHide:function(){t.destroy(),this.destroy()},zIndex:1e3})},_closeBubble:function(e){e.tauBubble("destroy")}})});