define(["require","jQuery","Underscore","tau/core/class","libs/react/react-ex","./state.item.process.settings.confirmation.service","tau/services/rename.service","jsx!../views/state.settings"],function(e){"use strict";var t=e("jQuery"),i=e("Underscore"),n=e("tau/core/class"),s=e("libs/react/react-ex"),o=e("./state.item.process.settings.confirmation.service"),a=e("tau/services/rename.service"),r=e("jsx!../views/state.settings");return n.extend({init:function(e,n,s){this._getToggle=i.compose(t,e),this._getNamePlaceholder=n,this._stateSettings=s,this.onToggleRename=i.Callbacks(),this.onRename=i.Callbacks(),this._disposed=!1},isOpened:function(){return!this._disposed&&Boolean(this._getToggle().tauBubble("instance"))},showNameEditor:function(e){var t={preventDefaultBlur:e,className:"editableText i-role-taububble-ignore"};return this.onToggleRename.fire(!0),a.startRenamingActivity(this._getNamePlaceholder(),t).always(this.onToggleRename.fire.bind(this.onToggleRename,!1)).done(this._fireRenameIfChanged.bind(this,e))},toggleSettings:function(e){if(this.isOpened())this.closeSettings();else{var t=this.showNameEditor(!0);this._stateSettings.get(e).then(function(e){this._openSettings(e).always(this._hideNameEditor.bind(this)).done(this._commitSettings.bind(this,t)).fail(this._commitRename.bind(this,t)),t.always(this.closeSettings.bind(this))}.bind(this))}},closeSettings:function(){this.isOpened()&&this._getToggle().tauBubble("hide")},_hideNameEditor:function(){this._disposed||a.stopRenaming(this._getNamePlaceholder())},_commitSettings:function(e,t){e.done(this._saveSettings.bind(this,t))},_commitRename:function(e){e.done(this._fireRenameIfChanged.bind(this,!1))},_saveSettings:function(e,t){e.name=t,this._stateSettings.save(e)},_openSettings:function(e){var i=t.Deferred(),n=document.createElement("div"),a=new o(this._stateSettings);return s.renderClass(r,{config:e,saveStateAction:function(t,n){a.confirmSave(e,t,n).then(function(){i.resolve(t),this.closeSettings()}.bind(this))}.bind(this),deleteStateAction:function(t,n){a.confirmDelete(e,t,n).then(function(e,n){i.reject(),n>0?this._stateSettings.migrate(t,e).then(this._stateSettings.performDelete.bind(this._stateSettings,t)):this._stateSettings.performDelete(t)
}.bind(this))}.bind(this)},n),this._getToggle().tauBubble({showOnCreation:!0,content:n,onPositionConfig:function(e){e.collision="fit flip",e.within=t(".i-role-views-workflow-container"),e.my="center top",e.at="right bottom"},onShow:function(){this._getToggle().addClass("t3-opened")}.bind(this),onHide:function(){s.unmountComponentAtNode(n),this._getToggle().removeClass("t3-opened"),this._getToggle().tauBubble("destroy"),i.reject()}.bind(this),onResize:function(e){var i=t(".tau-bubble__inner"),n=i.outerHeight(!0)-i.height(),s=t(window).height()-e.offset().top-n;e.find(".tau-bubble__inner").css({maxHeight:s+"px",overflowX:"hidden",overflowY:"auto"})},zIndex:999}),i.promise()},_fireRenameIfChanged:function(e,t,i){var n=t!==i;n&&this.onRename.fire(t,{isManaged:e})},dispose:function(){this._disposed=!0}})});