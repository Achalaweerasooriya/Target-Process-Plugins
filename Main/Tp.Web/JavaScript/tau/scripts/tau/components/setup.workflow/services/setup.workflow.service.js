define(["require","Underscore","jQuery","tau/services/data.service","tau/core/termProcessor","tau/components/setup.workflow/services/team.workflow.dsl"],function(e){"use strict";var t=e("Underscore"),r=e("jQuery"),n=e("tau/services/data.service"),i=e("tau/core/termProcessor"),s=e("tau/components/setup.workflow/services/team.workflow.dsl"),o=n.extend({init:function(e,t,r,n){this._super(e,t,r),this._longTaskRunner=n},getStates:function(e,t){return this._find("entityState",{select:["Id","Name","NumericPriority","IsInitial","IsFinal","IsPlanned","Role.Id as ActiveRoleId","NextStates.Select(Id) as NextStateIds","PreviousStates.Select(Id) as PreviousStateIds","SubEntityStates.Count as SubEntityStatesCount","SubEntityStates.Where(IsInitial = true).Count AS InitialSubEntityStatesCount","SubEntityStates.Where(IsFinal = true).Count AS FinalSubEntityStatesCount"],where:this._workflowQuery(e,t)})},getProcessWorkflow:function(e,t,r){return this._findOne("workflow",{select:["Id","EntityType","Process"],where:{"process.id":e,"entityType.name":'"'+t+'"',parentWorkflow:"null"}},r).fail(this._handleStoreErrorResponse.bind(this))},getTeamWorkflows:function(e,n){return this.getProcessWorkflow(e,n,null).then(function(e){return e?e:r.Deferred().reject()}).then(function(e){var r=["Id","Name","IsInitial","IsFinal","ParentEntityState"].join(",");return this._find("workflow",{select:["Id","Name","EntityStates.Select({"+r+"}) as EntityStates","TeamProjects.Select({Team:{Team.Id,Team.Name}}) as AffectedTeamsProjects"],where:{"parentWorkflow.id":e.id,"entityType.name":'"'+n+'"'}}).then(function(e){return t.each(e,function(e){var r=t.pluck(e.affectedTeamsProjects,"team");e.affectedTeams=t.uniq(r,function(e){return e.id})}),e})}.bind(this))},getProcessTeams:function(e){return this._find("team",{select:["Id","Name"],where:"TeamProjects.Count(Project.Process.Id == "+e+") > 0"})},getAffectedAssignableCount:function(e){return e.parentEntityState&&e.parentEntityState.id?this._findOne("entityState",{select:["Assignables.Select({TeamStates.Count(EntityState.Id = "+e.id+") as TeamStateCount}).Count(TeamStateCount > 0) as AssignablesCount"],where:{id:e.parentEntityState.id}}).then(t.property("assignablesCount")):this._findOne("entityState",{select:["Assignables.Count"],where:{id:e.id}}).then(t.property("count"))
},getRoleAssignmentsCount:function(e,r,n){var i=this._query.where({"assignable.entityState.workflow.process.id":e,"assignable.entityState.workflow.entityType.name":'"'+r+'"'});return this._findOne("role",{select:["assignments.where("+i+").count"],where:{id:n.id}}).then(t.property("count"))},getTerms:function(e,t){return this._find("term",{select:["wordKey","value","process:{id}"],where:this._workflowQuery(e,t)}).then(function(e){return new i(e).getTerms(t)})},getProcess:function(e,t){return this._findOne("process",{where:{id:e}},t)},getRoles:function(){return this._find("role",{})},addEntityState:function(e){return this._store.saveDef("entitystate",{$set:e}).then(function(e){return e.data},this._handleStoreErrorResponse.bind(this))},saveEntityState:function(e,t){return this._store.saveDef("entitystate",{id:e,$set:t}).fail(this._handleStoreErrorResponse.bind(this))},deleteEntityState:function(e){var t=e.subEntityStatesCount,r="";if(t){var n=t>1;r="and "+(n?t+" ":"")+"Team Workflow state"+(n?"s ":" ")}var i=t>0?"have":"has",s={message:"'"+e.name+"' state "+r+i+" been deleted"};return this._store.removeDef("entitystate",{id:e.id}).done(this._errorBar.fire.bind(this._errorBar,"notification",s)).fail(this._handleStoreErrorResponse.bind(this))},migrateEntityState:function(e,t){return this._longTaskRunner.migrateEntityState(e.id,t.id).progress(this._errorBar.fire.bind(this._errorBar,"notification")).done(this._errorBar.fire.bind(this._errorBar,"clearError")).fail(this._handleXhrErrorResponse.bind(this))},getEntityTypeId:function(e){return this._findOne("entityType",{select:["Id"],where:{name:'"'+e+'"'}}).then(t.property("id"))},addTeamWorkflow:function(e){return this._store.saveDef("workflow",{$set:e,fields:t.keys(e)}).then(function(e){return e.data.id},this._handleStoreErrorResponse.bind(this))},renameTeamWorkflow:function(e,r){return this._store.saveDef("workflow",{id:e,$set:{name:r}}).then(t.identity,this._handleStoreErrorResponse.bind(this))},deleteTeamWorkflow:function(e){return this._store.removeDef("workflow",{id:e}).then(t.identity,this._handleStoreErrorResponse.bind(this))
},migrateWorkflow:function(e,t){return this._longTaskRunner.migrateWorkflow(e,t).progress(this._errorBar.fire.bind(this._errorBar,"notification")).done(this._errorBar.fire.bind(this._errorBar,"clearError")).fail(this._handleXhrErrorResponse.bind(this))},createTeamWorkflowFromText:function(e,t,r){return s.createTeamWorkflowFromText(e,t,r).fail(this._handleError.bind(this))},sendNotification:function(e){this._errorBar.fire("notification",{message:e})},_workflowQuery:function(e,t){return{"process.id":e,"entityType.name":'"'+t+'"'}}});return o});