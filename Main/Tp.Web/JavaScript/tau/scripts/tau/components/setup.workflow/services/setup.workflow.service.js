define(["require","Underscore","tau/core/class","tau/utils/utils.serverErrorTranslator","tau/core/termProcessor"],function(e){"use strict";var r=e("Underscore"),t=e("tau/core/class"),s=e("tau/utils/utils.serverErrorTranslator"),i=e("tau/core/termProcessor");return t.extend({MAX_STATE_COUNT:1e3,init:function(e,t,s,i){this._store=e,this._store2=t,this._errorBar=s,this._longTaskRunner=i,this.statesChanged=r.Callbacks()},getStates:function(e,r){var t=["Id","Name","IsInitial","IsFinal","IsPlanned","Role.Id as ActiveRoleId","NextStates.Select(Id) as NextStateIds","PreviousStates.Select(Id) as PreviousStateIds"].join(","),s="&take="+this.MAX_STATE_COUNT;return this._store2.findAll("entityState?select={"+t+"}"+this._whereClause(e,r)+s).fail(this._handleStoreErrorResponse.bind(this))},getTerms:function(e,r){return this._store2.findAll("term?select={wordKey,value,process:{id}}"+this._whereClause(e,r)).fail(this._handleStoreErrorResponse.bind(this)).then(function(e){return new i(e).getTerms(r)})},getRoles:function(){return this._store2.findAll("role").fail(this._handleStoreErrorResponse.bind(this))},saveEntityState:function(e,r){return this._store.saveDef("entitystate",{id:e,$set:r}).fail(this._handleStoreErrorResponse.bind(this))},deleteEntityState:function(e){var r={message:"Entity State "+e.name+" has been deleted"};return this._store.removeDef("entitystate",{id:e.id}).done(this._errorBar.fire.bind(this._errorBar,"notification",r)).fail(this._handleStoreErrorResponse.bind(this))},migrateEntityState:function(e,r){return this._longTaskRunner.migrateEntityState(e.id,r.id).progress(this._errorBar.fire.bind(this._errorBar,"notification")).done(this._errorBar.fire.bind(this._errorBar,"clearError")).fail(this._handleXhrErrorResponse.bind(this))},_whereClause:function(e,r){return"&where=(process.id="+e+' and entityType.name = "'+r+'")'},_handleStoreErrorResponse:function(e){this._errorBar.fire("error",s.translateServerError(e))},_handleXhrErrorResponse:function(e){this._errorBar.fire("error",s.translateXhrError(e))
}})});