define(["require","Underscore","jQuery","tau/core/class","tau/utils/utils.text"],function(t){"use strict";var e=t("Underscore"),i=t("jQuery"),r=t("tau/core/class"),n=t("tau/utils/utils.text");return r.extend({EMPTY_ROLE:{id:"",name:"- Select Role -"},init:function(t,i,r,n){this._workflowService=t,this._processId=i,this._entityType=r,this._isAdminisrator=n,this.statesChanged=e.Callbacks(),this.updateProgress=e.Callbacks()},getProcessId:function(){return this._processId},getEntityType:function(){return this._entityType},refresh:function(){return this._refreshWithInterceptor()},getAffectedEntitiesCount:function(t){return this._workflowService.getAffectedAssignableCount(t)},getRoleAssignmentsCount:function(t){return t.id?this._workflowService.getRoleAssignmentsCount(this.getProcessId(),this.getEntityType(),t):i.when(0)},_refreshWithInterceptor:function(t){return i.when(this._getStates(),this._getTerms(),this._getTeamWorkflows(),this._getProcess(null),this._getProcessTeams(),t).then(this._fireStatesChanged.bind(this)).then(this._fireStateUpdated.bind(this))},getStateSettings:function(t){return i.when(this._getStates(),this._workflowService.getRoles(),this._getTerms()).then(function(i,r,n){var s=e.findWhere(i,{id:t});return s.isCurrent=!0,{states:i,roles:e.union([this.EMPTY_ROLE],r),terms:n,settings:s}}.bind(this))},addState:function(t,r){this._fireNewStateCreating(),i.when(this._getStates(),this._getEntityTypeId()).then(function(i,n){var s=this._buildNewState(t,r,i,n);return this._workflowService.addEntityState(s).then(function(t){return this._refreshWithInterceptor(function(i){e.findWhere(i.states,{id:t.id}).isNew=!0})}.bind(this))}.bind(this)).fail(this.refresh.bind(this))},_buildNewState:function(t,i,r,s){return{name:n.getUniqueName("New state",e.pluck(r,"name")),numericPriority:(t.numericPriority+i.numericPriority)/2,process:{id:this.getProcessId()},entityType:{id:s}}},saveStateSettings:function(t){var r=function(i){if(i.id===t.id)return t;var r=e.contains(i.nextStateIds,t.id),n=e.contains(t.previousStateIds,i.id);
return r&&!n?(i.nextStateIds=e.without(i.nextStateIds,t.id),i):!r&&n?(i.nextStateIds=e.union(i.nextStateIds,[t.id]),i):null},n=function(t){return this._workflowService.saveEntityState(t.id,{name:t.name,isPlanned:t.isPlanned,role:t.activeRoleId&&t.activeRoleId!==this.EMPTY_ROLE.id?{id:t.activeRoleId}:null,nextStates:e.map(t.nextStateIds,function(t){return{id:t}})})}.bind(this);this._fireStateUpdating(t.id),this._getStates().then(function(t){var s=e.chain(t).map(r).compact().map(n).value();i.when.all(s).always(this.refresh.bind(this))}.bind(this))},renameState:function(t){this._fireStateUpdating(t.id),this._workflowService.saveEntityState(t.id,{name:t.name}).always(this.refresh.bind(this))},reorderState:function(t,i){this._fireStateUpdating(t.id);var r=e.pluck(i,"numericPriority"),n=e.sum(r)/r.length;this._workflowService.saveEntityState(t.id,{numericPriority:n}).always(this.refresh.bind(this))},migrateEntityState:function(t,e){return this._fireStateUpdating(t.id),this._workflowService.migrateEntityState(t,e).then(this._fireStateUpdated.bind(this))},deleteEntityState:function(t){return this._fireStateUpdating(t.id),this._workflowService.deleteEntityState(t).always(this.refresh.bind(this))},addTeamWorkflow:function(t,e){return i.when(this._getStates(),this._getProcessWorkflow()).then(function(i,r){return this._workflowService.createTeamWorkflowFromText(t,e,i).then(function(t){return t.parentWorkflow={id:r.id},t.entityType={id:r.entityType.id},t.process={id:r.process.id},this._workflowService.addTeamWorkflow(t)}.bind(this))}.bind(this)).then(this.refresh.bind(this))},editTeamWorkflow:function(t,r,n,s,o){return i.when(this._getStates(),this._getProcessWorkflow(),this._getTeamWorkflows()).then(function(t,e,s){return i.when(this._workflowService.createTeamWorkflowFromText(r,n,t),this._workflowService.createTeamWorkflowFromText(r,o,t),e,s)}.bind(this),this.refresh.bind(this)).then(function(n,o,a,h){return e.isEqual(n,o)&&r===s?i.when(t):this._updateTeamWorkflow(t,n,o,a,h)}.bind(this))
},_updateTeamWorkflow:function(t,i,r,s,o){this._fireNewStateCreating();var a=i.name,h=i.name===r.name;if(e.isEqual(i,r))return this._workflowService.renameTeamWorkflow(t,i.name).then(this.refresh.bind(this),this.refresh.bind(this));h&&(i.name=n.getUniqueName(i.name+" NEW",e.pluck(o,"name"))),i.parentWorkflow={id:s.id},i.entityType={id:s.entityType.id},i.process={id:s.process.id};var d="'"+a+"' Team Workflow is still updating",f="'"+a+"' Team Workflow has been updated";return this._workflowService.addTeamWorkflow(i).then(function(i){return this._workflowService.migrateWorkflow(t,i).then(this._workflowService.sendNotification.bind(this._workflowService,d)).then(this._workflowService.deleteTeamWorkflow.bind(this._workflowService,t)).then(h?this._workflowService.renameTeamWorkflow.bind(this._workflowService,i,a):e.identity).then(this._workflowService.sendNotification.bind(this._workflowService,f)).then(this.refresh.bind(this),this.refresh.bind(this))}.bind(this),this._fireStateUpdated.bind(this))},deleteTeamWorkflow:function(t){var e="'"+t.name+"' Team Workflow has been deleted";return this._workflowService.deleteTeamWorkflow(t.id).then(this._workflowService.sendNotification.bind(this._workflowService,e)).then(this.refresh.bind(this),this.refresh.bind(this))},_getStates:function(){return this._workflowService.getStates(this.getProcessId(),this.getEntityType())},_getTerms:function(){return this._workflowService.getTerms(this.getProcessId(),this.getEntityType())},_getProcess:function(t){return this._workflowService.getProcess(this.getProcessId(),t)},_getEntityTypeId:function(){return this._workflowService.getEntityTypeId(this.getEntityType())},_getTeamWorkflows:function(){return this._workflowService.getTeamWorkflows(this.getProcessId(),this.getEntityType())},_getProcessWorkflow:function(){return this._workflowService.getProcessWorkflow(this.getProcessId(),this.getEntityType())},_getProcessTeams:function(){return this._workflowService.getProcessTeams(this.getProcessId())},_fireStatesChanged:function(t,i,r,n,s,o){this.statesChanged.fire(e.tap({states:t,entityTerms:i,teamWorkflows:r,process:n,processTeams:s},o||e.identity))
},_fireNewStateCreating:function(){this.updateProgress.fire({updatingStateId:null,allowEditing:!1})},_fireStateUpdating:function(t){this.updateProgress.fire({updatingStateId:t,allowEditing:!1})},_fireStateUpdated:function(){this.updateProgress.fire({updatingStateId:null,allowEditing:this._isAdminisrator})}})});