define(["require","Underscore","jQuery","tau/core/class","tau/utils/utils.text"],function(t){"use strict";var e=t("Underscore"),i=t("jQuery"),n=t("tau/core/class"),r=t("tau/utils/utils.text");return n.extend({EMPTY_ROLE:{id:"",name:"- Select Role -"},init:function(t,i,n,r){this._workflowService=t,this._processId=i,this._entityType=n,this._isAdminisrator=r,this.statesChanged=e.Callbacks(),this.updateProgress=e.Callbacks()},getProcessId:function(){return this._processId},getEntityType:function(){return this._entityType},refresh:function(){return this._refreshWithInterceptor()},getAffectedEntitiesCount:function(t){return this._workflowService.getAffectedAssignableCount(t)},getRoleAssignmentsCount:function(t){return t.id?this._workflowService.getRoleAssignmentsCount(this.getProcessId(),this.getEntityType(),t):i.when(0)},_refreshWithInterceptor:function(t){return i.when(this._getStates(),this._getTerms(),this._getTeamWorkflows(),this._getProcess(null),t).then(this._fireStatesChanged.bind(this)).then(this._fireStateUpdated.bind(this))},getStateSettings:function(t){return i.when(this._getStates(),this._workflowService.getRoles(),this._getTerms()).then(function(i,n,r){var s=e.findWhere(i,{id:t});return s.isCurrent=!0,{states:i,roles:e.union(this.EMPTY_ROLE,n),terms:r,settings:s}}.bind(this))},addState:function(t,n){this._fireNewStateCreating(),i.when(this._getStates(),this._getEntityTypeId()).then(function(i,r){var s=this._buildNewState(t,n,i,r);return this._workflowService.addEntityState(s).then(function(t){return this._refreshWithInterceptor(function(i){e.findWhere(i.states,{id:t.id}).isNew=!0})}.bind(this))}.bind(this)).fail(this.refresh.bind(this))},_buildNewState:function(t,i,n,s){return{name:r.getUniqueName("New state",e.pluck(n,"name")),numericPriority:(t.numericPriority+i.numericPriority)/2,process:{id:this.getProcessId()},entityType:{id:s}}},saveStateSettings:function(t){var n=function(i){if(i.id===t.id)return t;var n=e.contains(i.nextStateIds,t.id),r=e.contains(t.previousStateIds,i.id);
return n&&!r?(i.nextStateIds=e.without(i.nextStateIds,t.id),i):!n&&r?(i.nextStateIds=e.union(i.nextStateIds,t.id),i):null},r=function(t){return this._workflowService.saveEntityState(t.id,{name:t.name,isPlanned:t.isPlanned,role:t.activeRoleId&&t.activeRoleId!==this.EMPTY_ROLE.id?{id:t.activeRoleId}:null,nextStates:e.map(t.nextStateIds,function(t){return{id:t}})})}.bind(this);this._fireStateUpdating(t.id),this._getStates().then(function(t){var s=e.chain(t).map(n).compact().map(r).value();i.when.all(s).always(this.refresh.bind(this))}.bind(this))},renameState:function(t){this._fireStateUpdating(t.id),this._workflowService.saveEntityState(t.id,{name:t.name}).always(this.refresh.bind(this))},reorderState:function(t,i){this._fireStateUpdating(t.id);var n=e.pluck(i,"numericPriority"),r=e.sum(n)/n.length;this._workflowService.saveEntityState(t.id,{numericPriority:r}).always(this.refresh.bind(this))},migrateEntityState:function(t,e){return this._fireStateUpdating(t.id),this._workflowService.migrateEntityState(t,e).then(this._fireStateUpdated.bind(this))},deleteEntityState:function(t){return this._fireStateUpdating(t.id),this._workflowService.deleteEntityState(t).always(this.refresh.bind(this))},addTeamWorkflow:function(t,e){return i.when(this._getStates(),this._getProcessWorkflow()).then(function(i,n){return this._workflowService.createTeamWorkflowFromText(t,e,i).then(function(t){return t.parentWorkflow={id:n.id},t.entityType={id:n.entityType.id},t.process={id:n.process.id},this._workflowService.addTeamWorkflow(t)}.bind(this))}.bind(this)).then(this.refresh.bind(this))},deleteTeamWorkflow:function(t){return this._workflowService.deleteTeamWorkflow(t).always(this.refresh.bind(this))},_getStates:function(){return this._workflowService.getStates(this.getProcessId(),this.getEntityType())},_getTerms:function(){return this._workflowService.getTerms(this.getProcessId(),this.getEntityType())},_getProcess:function(t){return this._workflowService.getProcess(this.getProcessId(),t)},_getEntityTypeId:function(){return this._workflowService.getEntityTypeId(this.getEntityType())
},_getTeamWorkflows:function(){return this._workflowService.getTeamWorkflows(this.getProcessId(),this.getEntityType())},_getProcessWorkflow:function(){return this._workflowService.getProcessWorkflow(this.getProcessId(),this.getEntityType())},_fireStatesChanged:function(t,i,n,r,s){this.statesChanged.fire(e.tap({states:t,entityTerms:i,teamWorkflows:n,process:r},s||e.identity))},_fireNewStateCreating:function(){this.updateProgress.fire({updatingStateId:null,allowEditing:!1})},_fireStateUpdating:function(t){this.updateProgress.fire({updatingStateId:t,allowEditing:!1})},_fireStateUpdated:function(){this.updateProgress.fire({updatingStateId:null,allowEditing:this._isAdminisrator})}})});