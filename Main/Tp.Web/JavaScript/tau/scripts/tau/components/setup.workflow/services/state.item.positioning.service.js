define(["require","Underscore","tau/core/class"],function(t){"use strict";var e=t("Underscore"),i=t("tau/core/class");return i.extend({MIN_STATE_WIDTH:100,STATE_HEIGHT:84,init:function(t,e){this._processStates=t,this._teamWorkflows=e},positioningStates:function(){this._prepareProcessStatePositions(this._processStates,this._teamWorkflows),this._teamWorkflows&&this._prepareTeamWorkflowPositions(this._processStates,this._teamWorkflows)},getMinWidth:function(){return this._calculateTotalWeight(this._processStates)*this.MIN_STATE_WIDTH+"px"},getHeight:function(){return 90+this.STATE_HEIGHT*(this._teamWorkflows?this._teamWorkflows.length:0)+"px"},_prepareProcessStatePositions:function(t,i){e.each(t,function(t){t.weight=this._calculateProcessStateWeight(t,i)}.bind(this));var a=this._calculateTotalWeight(t),n=100/a;e.each(t,function(t){t.width=t.weight*n})},_prepareTeamWorkflowPositions:function(t,i){e.each(i,function(e,i){var a=this._calculateTeamWorkflowPosition(e.entityStates,t);e.position={left:a.left+"%",width:a.width+"%",top:40+this.STATE_HEIGHT*i+"px"},this._prepareTeamWorkflowStatePositions(e.entityStates,t)}.bind(this))},_prepareTeamWorkflowStatePositions:function(t,i){var a=e.reduce(t,function(t,i){var a=i.parentEntityState.id;return e.has(t,a)||(t[a]=0),t[a]+=1,t},{}),n=e.chain(t).map(e.complexProperty("parentEntityState.id")).uniq().value(),o=e.map(n,function(t){return e.findWhere(i,{id:t})}),r=this._calculateTotalWeight(o),s=100/r,c=0;e.each(t,function(t){var n=t.parentEntityState.id,o=e.findWhere(i,{id:n}),r=o.weight*s/a[n];t.width=r+"%",t.left=0===c?"2px":c+"%",c+=r}.bind(this))},_calculateTotalWeight:function(t){return this._calculateTotal(t,"weight")},_calculateTotalWidth:function(t){return this._calculateTotal(t,"width")},_calculateTotal:function(t,i){return e.chain(t).pluck(i).reduce(function(t,e){return t+e},0).value()},_calculateProcessStateWeight:function(t,i){return e.chain(i).map(function(i){return e.filter(i.entityStates,function(e){return e.parentEntityState.id===t.id
}).length}).union([1]).max().value()},_calculateTeamWorkflowPosition:function(t,i){var a=function(t){var a=e.findWhere(i,{id:t.parentEntityState.id});return e.indexOf(i,a)},n=a(e.first(t)),o=a(e.last(t)),r=this._calculateTotalWidth(i.slice(0,n)),s=this._calculateTotalWidth(i.slice(n,o+1));return{left:r,width:s}}})});