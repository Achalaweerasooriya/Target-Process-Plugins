define(["require","jQuery","Underscore","tau/core/class","libs/react/react-ex","tau/services/rename.service","template!tau/components/tauBubble/templates/board.bubble","jsx!../views/state.settings","jsx!../views/delete.confirmation"],function(e){"use strict";var t=e("jQuery"),n=e("Underscore"),i=e("tau/core/class"),o=e("libs/react/react-ex"),s=e("tau/services/rename.service"),a=e("template!tau/components/tauBubble/templates/board.bubble"),r=e("jsx!../views/state.settings"),c=e("jsx!../views/delete.confirmation");return i.extend({init:function(e,i,o){this._$toggle=t(e),this._namePlaceholder=i,this._stateSettings=o,this.onToggleRename=n.Callbacks(),this.onRename=n.Callbacks()},isOpened:function(){return Boolean(this._$toggle.tauBubble("instance"))},showNameEditor:function(e){var t={preventDefaultBlur:e,className:"editableText i-role-taububble-ignore"};return this.onToggleRename.fire(!0),s.startRenamingActivity(this._namePlaceholder,t).done(function(t){e||this.onRename.fire(t)}.bind(this)).always(this.onToggleRename.fire.bind(this.onToggleRename,!1))},toggleSettings:function(e){if(this.isOpened())this.closeSettings();else{var t=this.showNameEditor(!0);this._stateSettings.get(e).then(function(e){this._openSettings(e).always(this._hideNameEditor.bind(this)).done(this._commitSettings.bind(this,t)).fail(this._commitRename.bind(this,t)),t.always(this.closeSettings.bind(this))}.bind(this))}},closeSettings:function(){this.isOpened()&&this._$toggle.tauBubble("hide")},_hideNameEditor:function(){s.stopRenaming(this._namePlaceholder)},_commitSettings:function(e,t){e.done(this._saveSettings.bind(this,t))},_commitRename:function(e){e.done(this.onRename.fire.bind(this.onRename))},_saveSettings:function(e,t){e.name=t,this._stateSettings.save(e)},_openSettings:function(e){var n=t.Deferred(),i=document.createElement("div");return o.renderComponent(new r({config:e,saveStateAction:function(e){n.resolve(e),this.closeSettings()}.bind(this),deleteStateAction:this._openDeleteStateConfirmation.bind(this,e,n)}),i),this._$toggle.tauBubble({showOnCreation:!0,content:i,onPositionConfig:function(e){e.collision="fit flip",e.within=t(".i-role-views-workflow-container"),e.my="center top",e.at="right bottom"
},onShow:function(){this._$toggle.addClass("t3-opened")}.bind(this),onHide:function(){o.unmountComponentAtNode(i),this._$toggle.removeClass("t3-opened"),this._$toggle.tauBubble("destroy"),n.reject()}.bind(this),onResize:function(e){var t=.7*e.parent().height();e.find(".tau-states-order").css({maxHeight:t,overflowY:"auto"})},zIndex:999}),n.promise()},_openDeleteStateConfirmation:function(e,i,s,r){var l=t(r),u=document.createElement("div"),d=n.reject(e.states,function(e){return e.id===s.id});o.renderComponent(new c({states:d,terms:e.terms,onCancel:function(){l.tauBubble("destroy")},onSubmit:function(e){i.reject(),this._stateSettings.delete(s,e)}.bind(this)}),u),l.tauBubble({className:"tau-bubble-tooltipArticle",template:a.render(),showOnCreation:!0,content:u,onPositionConfig:function(e){e.my="center top",e.at="center bottom"},onHide:function(){o.unmountComponentAtNode(u),this.destroy()},zIndex:1e3})}})});