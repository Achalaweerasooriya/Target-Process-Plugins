define(["jQuery","Underscore","tau/configurator","tau/components/component.creator","tau/ui/templates/quick.add/ui.template.quick.add","tau/components/extensions/component.extension.base","tau/ui/templates/quick.add/ui.template.quick.add.content","tau/ui/templates/quick.add/ui.template.quick.add.line","tau/ui/behaviour/common/ui.behaviour.tauBubble","tau/ui/behaviour/common/ui.behaviour.editableText"],function($,_,a,b,c,d,e,f){return{create:function(g){var h=d.extend({"bus beforeInit":function(){var a=this;a.fire("dataBind",{label:this.config.label,entityType:this.config.entityType})},_attachKeyBoardHandling:function(){var b=this,c={handleKeyDown:function(){}};a.getKeyBoardManager().pushHandler(c)},_getEntityId:function(){return this.config.context.entity.id},_getEntityType:function(){return this.config.context.entity.entityType.name},"bus close":function(){var b=this;a.getKeyBoardManager().popHandler();if(!b.itemsAdded)return;b.config.store.evictProperties(b._getEntityId(),this._getEntityType(),b.config.evictProperties),setTimeout(function(){b.bus.fire(b.config.entityType+".items.added",b.config.context)},1)},_appendAddLine:function(a){var b=this,c=$(".ui-quick-add-new-item",a);if(c.length>0){setTimeout(function(){c.click()},1);return}var d=f.get().bind({},{entityType:b.config.entityType});a.find(".quick-add-lines").append(d);var e=$(".quick-add-input",d);e.editableText({restoreText:!0,resetOnBlur:!0,onSave:function(c){if(!c||!c.trim())return;c.length>255&&(c=c.substring(0,254));var f=b.config.store;if(e.hasClass("ui-quick-add-saving"))return;e.removeClass("ui-quick-add-new-item").addClass("ui-quick-add-saving");var g={name:c};g[b.config.property]={id:b._getEntityId()};var h={};h[b.config.property]=["id"];var i=["id","name",h],j={$set:g,fields:i};d.data("item-id")&&(j.id=d.data("item-id"));var k=function(c){j.$set.project={id:c.id},f.save(b.config.entityType,j,{success:function(c){d.data("item-id",c.data.id),d.addClass("ui-quick-add-item-saved"),e.removeClass("ui-quick-add-saving").text(c.data.name),b.itemsAdded=!0;var f=$(".ui-quick-add-item-saved",a).length+" item(s) saved";$(".ui-quick-add-stats",a).text(f)}}).done()};$(".ui-quick-add-stats",a).text("saving..."),f.get(b._getEntityType(),{id:b._getEntityId(),fields:[{project:["id"]}]},{success:function(a){var b=a.data.project;k(b)}}).done(),b._appendAddLine(a)}}),setTimeout(function(){e.click()},1)},"bus displayQuickAdd":function(a){var b=a.data,c=this;c.itemsAdded=!1;var d=b.popup.find(".tau-bubble__inner");if(d.find(".ui-quick-add-content").length==0){var f=e.get().bind({},{});d.append(f)}b.api.adjustPosition(),d.find(".quick-add-lines").html(""),d.find(".ui-quick-add-stats").text(""),d.find(".button-box").click(function(){b.api.hide()}),this._appendAddLine(d),c._attachKeyBoardHandling()},"bus afterRender":function(a){var b=this,c=a.data.element,d=$(".ui-quick-add-link",c).tauBubble();d.bind("show",function(a,c){b.bus.fire("displayQuickAdd",c)}),d.bind("close",function(a,c){c.event&&(c.event.preventDefault(),c.event.stopPropagation()),b.bus.fire("close",c)})}}),i={extensions:[h],template:c};return b.create(i,g)}}})