define(["require","Underscore","tau/core/class"],function(t){var e=t("Underscore"),a=t("tau/core/class"),n=a.extend({init:function(t,a){this._service=t,this._assignableId=a.id,this._entityType=a.entityType.name,this._currentStateIds={},this._clearCache(),this.onStateChangeNotification=e.Callbacks();var n=this._handleStateChanged.bind(this);this._service.addStateChangeHandler(this._entityType,{id:this._assignableId},n),this._service.addStateChangeHandler("teamState",{},n)},_clearCache:function(){this._assignableCache=null,this._workflowCache=null},destroy:function(){this._service.removeStateChangeHandlers()},forceRefreshCurrentStates:function(){return this._clearCache(),this._getCurrentStates()},refreshCurrentStates:function(t){var a=e.extend({},this._currentStateIds,t);return e.isEqual(a,this._currentStateIds)||(this._clearCache(),this._currentStateIds=a),this._getCurrentStates()},_getCurrentStates:function(){return this._getAssignable().then(this._extractCurrentStates.bind(this)).then(function(t){return this._currentStateIds={parentStateId:t.parentState.id,teamStateId:t.teamState&&t.teamState.state.id},t}.bind(this)).promise()},_extractCurrentStates:function(t){var a=t.entityState,n=e.first(t.teamStates),i=n&&n.entityState;return{parentState:e.pick(a,"id","name"),teamState:i?{team:e.pick(n.team,"id","name","icon"),state:e.pick(n.entityState,"id","name")}:null}},getCurrentWorkflow:function(){return this._workflowCache?this._workflowCache:(this._workflowCache=this._getAssignable().then(function(t){return this._collectTeamWorkflowIds(t).then(this._retrieveTeamWorkflows.bind(this,t.entityState))}.bind(this)).promise(),this._workflowCache)},updateParentState:function(t,e){return this._service.updateAssignableState(this._entityType,this._assignableId,t,e).then(function(t){return{parentStateId:t.data.entityState.id}})},updateTeamState:function(t,a,n){return this._getAssignable().then(function(i){var r=e.find(i.teamStates,function(e){return e.team.id===t});return this._service.updateAssignableTeamState(this._entityType,this._assignableId,r.id,a,n).then(function(t){var a=e.first(t.data.teamStates),n=a&&a.entityState;
return{teamStateId:n?a.entityState.id:null}})}.bind(this))},_getAssignable:function(){return this._assignableCache?this._assignableCache:(this._assignableCache=this._service.getAssignableWithCurrentStates(this._assignableId),this._assignableCache)},_handleStateChanged:function(t){var a={},n=t.data.changes.entityState;n&&(a.parentStateId=n.id);var i=t.data.changes.teamStates&&e.first(t.data.changes.teamStates);i&&i.entityState&&(a.teamStateId=i.entityState.id),this.onStateChangeNotification.fire(a)},_collectTeamWorkflowIds:function(t){var a=this._extractTeam(t),n=t.project,i=this._service.getTeamWorkflowIds(a,n,this._entityType);return i.then(function(n){return e.chain(n).map(function(t){return{workflowId:t,team:a}}).union([{workflowId:t.entityState.workflowId,team:null}]).uniq(!1,e.property("workflowId")).value()})},_extractTeam:function(t){return e.size(t.teamStates)?e.first(t.teamStates).team:null},_retrieveTeamWorkflows:function(t,a){var n=e.pluck(t.nextStates.items,"id");return this._service.getWorkflowsByIds(e.pluck(a,"workflowId")).then(function(t){var i=e.filter(t,function(t){return e.has(t,"parentEntityState")}),r=e.difference(t,i);return e.chain(r).map(this._getEntityStateDetails.bind(this,i,n)).reduce(this._groupByTeamWorkflow.bind(this,a),{prevWorkflowId:null,groups:[]}).value().groups}.bind(this))},_getEntityStateDetails:function(t,a,n){var i=e.filter(t,function(t){return t.parentEntityState.id===n.id});return{id:n.id,name:n.name,isTransitionAllowed:e.any(a,function(t){return t===n.id}),isCommentRequired:n.isCommentRequired,subStates:i,subWorkflowId:e.first(e.pluck(i,"workflowId"))}},_groupByTeamWorkflow:function(t,a,n){var i=n.subWorkflowId;if(!e.size(a.groups)||a.prevWorkflowId!==i){var r=e.findWhere(t,{workflowId:i});a.groups.push({team:r&&r.team,entityStates:[],hasSubStates:!1})}var s=e.last(a.groups);return s.entityStates.push(n),s.hasSubStates=s.hasSubStates||n.subStates.length>0,a.prevWorkflowId=i,a}});return n});