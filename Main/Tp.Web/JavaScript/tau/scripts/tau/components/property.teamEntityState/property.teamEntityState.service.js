define(["require","Underscore","jQuery","tau/services/data.service"],function(t){var e=t("Underscore"),n=t("jQuery"),i=t("tau/services/data.service"),a=i.extend({_entityStateFields:["Id","Name"],getAssignableWithCurrentStates:function(t){var n=this._prepareEntityStateFields(e.union(this._entityStateFields,["NextStates","Workflow.Id as WorkflowId"])),i=this._prepareEntityStateFields(e.union(this._entityStateFields,["Workflow.Id as WorkflowId"]));return this._findOne("assignable",{where:{id:t},select:["Project:{Project.Id}","EntityState:{"+n+"}","TeamStates.Select({Id,Team:{Team.Id,Team.Name,Team.Icon},EntityState:{"+i+"}}) as TeamStates"]}).then(function(t){return e.each(t.teamStates,function(t){e.isEmpty(t.entityState)&&(t.entityState=null)}),t})},getTeamWorkflowIds:function(t,i,a){return t?this._findOne("teamProject",{where:{"Team.Id":t.id,"Project.Id":i.id},select:['Workflows.Where(EntityType.Name="'+a+'").Select({Id,Name}) as Workflows']}).then(function(t){return[e.first(t.workflows).id]}):n.when([])},getWorkflowsByIds:function(t){var n=e.union(this._entityStateFields,["ParentEntityState","IsCommentRequired","Workflow.Id as WorkflowId"]);return this._find("entityState",{where:{"Workflow.Id":{is:"in ["+t.join(",")+"]"}},select:n})},updateAssignableState:function(t,e,n,i){return this._updateAssignableState(t,e,{entityState:{id:n}},["id",{entityState:["id"]}],i)},updateAssignableTeamState:function(t,e,n,i,a){return this._updateAssignableState(t,e,{teamStates:[{id:n,entityState:{id:i}}]},["id",{teamStates:["id",{entityState:["id"]}]}],a)},addStateChangeHandler:function(t,e,n){this._store.on({eventName:"afterSave",type:t,filter:e,hasChanges:["entityState"],listener:this},n)},removeStateChangeHandlers:function(){this._store.unbind(this)},_updateAssignableState:function(t,e,n,i,a){return a&&(n.comments=[{description:a}],i.push({comments:["id"]})),this._store.saveDef(t,{id:e,$set:n,fields:i})},_prepareEntityStateFields:function(t){return t.map(function(t){return"EntityState."+t
}).join(",")}});return a});