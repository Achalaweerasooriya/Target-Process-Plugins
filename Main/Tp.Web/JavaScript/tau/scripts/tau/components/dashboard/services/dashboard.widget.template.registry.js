define(["require","Underscore","jQuery","tau/core/class"],function(e){var t=e("Underscore"),r=e("jQuery"),i=e("tau/core/class");return i.extend({init:function(e){e=t.filter(e,this._validateTemplateSource,this),this._registry=[],this.widgetTemplateAdded=t.Callbacks(),this._loadTemplatesFromSources(e)},addWidgetTemplateSource:function(e){this._validateTemplateSource(e)&&this._loadTemplatesFromSources([e])},addWidgetTemplate:function(e){if(this._validateTemplate(e)){var t=this._getOrAddRegistryItem(e.id);if("pending"!==t.state())return void console.error('Dashboard widget template "'+e.id+'" is already defined.');t.resolve(e),this.widgetTemplateAdded.fire(e)}},getRegisteredWidgetTemplates:function(){return t.values(this._registry)},getLoadedWidgetTemplates:function(){var e=this.getRegisteredWidgetTemplates();return t.reduce(e,function(e,t){var r;return"resolved"===t.state()&&(t.done(function(e){r=e}),e.push(r)),e},[])},getWidgetTemplate:function(e){return this._getOrAddRegistryItem(e)},_loadTemplatesFromSources:function(e){var i=t.map(e,function(e){return e.getWidgetTemplates().then(this._loadTemplatesFromSourceStream.bind(this,e))},this);return r.when.all(i).then(function(e){return t.chain(e).filter(t.identity).flatten().value()})},_loadTemplatesFromSourceStream:function(e,i){var a=t.map(i,function(e){var t=r.Deferred();return e.done(function(e){this.addWidgetTemplate(e),t.resolve(e)}.bind(this)),e.fail(function(e){console.error("Unable to load widget template",e),t.resolve(null)}),t.promise()},this);return r.when.all(a)},_getOrAddRegistryItem:function(e){return this._registry[e]||(this._registry[e]=r.Deferred()),this._registry[e]},_validateTemplateSource:function(e){return e.id?!0:(console.error('Widget template source should have "id" property.'),!1)},_validateTemplate:function(e){return e.id?t.isFunction(e.insert)?!0:(console.error('Dashboard widget template should have "insert" method'),!1):(console.error('Dashboard widget template should have "id" property'),!1)}})
});