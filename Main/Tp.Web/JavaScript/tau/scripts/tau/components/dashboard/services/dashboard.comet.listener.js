define(["require","jQuery","tau/core/class","Underscore","./dashboard.comet.notification.parser"],function(e){var i=e("jQuery"),t=e("tau/core/class"),r=e("Underscore"),s=e("./dashboard.comet.notification.parser");return t.extend({init:function(e,i,t){this._cometApi=e,this._viewsMenuApi=i,this._dashboardId=t,this.dashboardUpdateRequired=r.Callbacks(),this._cometApi.refreshRequired.add(this._onRefreshRequired,this)},startListen:function(){this._subscription&&(console.error("Dashboard comet subscription already exists"),this._tryClearSubscription());var e=i.Deferred();return this._subscription=this._cometApi.subscribe("view-menu",{parameters:{clientId:this._viewsMenuApi.getViewsMenuClientId(),where:this._buildFilter(this._dashboardId)},started:function(i){e.resolve(i.subscription)}.bind(this),batchCallback:this._batchCometCallback.bind(this)}),e.promise()},_buildFilter:function(e){if(!r.isString(e))throw new Error("Dashboard ID should be a string");if(!e.length)throw new Error("Dashboard ID should not be empty");return'Key == "'+e+'"'},_batchCometCallback:function(e){var i;try{i=JSON.parse(e.Data)}catch(t){return void console.error("Error while parsing dashboard comet notification data",t)}this._tryApplyAllChanges(i)},_tryApplyAllChanges:function(e){try{var i=(new s).parseDashboardUpdate({dashboardId:this._dashboardId},e);i&&this.dashboardUpdateRequired.fire({dashboardId:this._dashboardId,newLayout:i.layout})}catch(t){console.error("Unable to parse dashboard comet notification",t)}},_onRefreshRequired:function(){this._subscription&&this._viewsMenuApi.viewsApi.getViewMenuItemNoCache(this._dashboardId).then(function(e){this._fireUpdateRequired(e.data)}.bind(this))},_fireUpdateRequired:function(e){this._subscription&&this.dashboardUpdateRequired.fire({dashboardId:this._dashboardId,newLayout:e.layout})},_tryClearSubscription:function(){this._subscription&&(this._subscription.stop(),this._subscription=null)},destroy:function(){this._tryClearSubscription(),this.dashboardUpdateRequired.removeAll(),this._cometApi.refreshRequired.remove(this)
}})});