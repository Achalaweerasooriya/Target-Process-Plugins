define(["require","jQuery","tau/core/class","Underscore","./dashboard.comet.notification.parser"],function(t){var e=t("jQuery"),i=t("tau/core/class"),r=t("Underscore"),s=t("./dashboard.comet.notification.parser");return i.extend({init:function(t,e,i){this._cometApi=t,this._viewsMenuApi=e,this._dashboardId=i,this.dashboardUpdateRequired=r.Callbacks(),this._cometApi.refreshRequired.add(this._onRefreshRequired,this)},startListen:function(){this._subscription&&(console.error("Dashboard comet subscription already exists"),this._tryClearSubscription());var t=e.Deferred();return this._subscription=this._cometApi.subscribe("view-menu",{parameters:{clientId:this._viewsMenuApi.getViewsMenuClientId(),where:this._buildFilter(this._dashboardId)},started:function(e){t.resolve(e.subscription)}.bind(this),batchCallback:this._batchCometCallback.bind(this)}),t},_buildFilter:function(t){if(!r.isString(t))throw new Error("Dashboard ID should be a string");if(!t.length)throw new Error("Dashboard ID should not be empty");return'Key == "'+t+'"'},_batchCometCallback:function(t){var e;try{e=JSON.parse(t.Data)}catch(i){return void console.error("Error while parsing dashboard comet notification data",i)}this._tryApplyAllChanges(e)},_tryApplyAllChanges:function(t){try{var e=(new s).parseDashboardUpdate({dashboardId:this._dashboardId},t);e&&this.dashboardUpdateRequired.fire({dashboardId:this._dashboardId,newLayout:e.layout})}catch(i){console.error("Unable to parse dashboard comet notification",i)}},_onRefreshRequired:function(){this._subscription&&this._viewsMenuApi.viewsApi.getViewMenuItemNoCache(this._dashboardId).then(function(t){this._fireUpdateRequired(t.data)}.bind(this))},_fireUpdateRequired:function(t){this._subscription&&this.dashboardUpdateRequired.fire({dashboardId:this._dashboardId,newLayout:t.layout})},_tryClearSubscription:function(){this._subscription&&(this._subscription.stop(),this._subscription=null)},destroy:function(){this._tryClearSubscription(),this.dashboardUpdateRequired.removeAll(),this._cometApi.refreshRequired.remove(this)
}})});