define(["require","Underscore","./dashboard.layout.model.base","./dashboard.column.selection.strategy","tau/core/class"],function(t){var e,n=t("Underscore"),i=t("./dashboard.layout.model.base"),o=t("./dashboard.column.selection.strategy"),s=t("tau/core/class"),u=i.extend({init:function(t,e,i){this._super(u.LAYOUT_TYPE_NAME),this._storeLayout(t),this.isEditable=e,this._widgetFactory=i,this._columnSelectionStrategy=null,this.columnCountChanged=n.Callbacks(),this._createColumns()},getLayout:function(){return this._layout},updateLayout:function(t){this._storeLayout(t)&&(this._createColumns(),this._notifyUpdated())},addWidgetFromTemplate:function(t){var e=this._getBestOrCreateColumnForNewWidget();return e.addWidgetFromTemplate(t)},addColumn:function(){var t=u._setDefaultColumnProperties({}),e=this._createColumn([],t,this.columns.length);return this.columns.push(e),this._notifyChanged(),this._notifyColumnCountChanged(),e},removeColumn:function(t){this.columns=n.without(this.columns,t),this._notifyChanged(),this._notifyColumnCountChanged()},setColumnCount:function(t){if(!t||0>t)throw new Error("Column count should be greater than 0");t!=this.columns.length&&this._layoutBuffer(function(){if(t>this.columns.length)n.each(n.range(this.columns.length,t),this.addColumn,this);else{var e=n.take(this.columns,t),i=n.rest(this.columns,t);n.each(i,function(t){var i=n.toArray(t.widgets);n.each(i,function(n){this._moveWidgetToShortestColumn(t,n,e)},this),this.removeColumn(t)},this)}})},_moveWidgetToShortestColumn:function(t,e,i){var o=n.min(i,function(t){return t.widgets.length});t.moveWidgetToColumn(e,o,!0)},moveWidget:function(t,e,n){var i=this._findColumnByWidgetId(t),o=this._findColumnByWidgetId(e);i.moveWidget(t,o,e,n)},moveWidgetToColumn:function(t,e,i){var o=this._findColumnByWidgetId(t),s=n.findWhere(this.columns,{instanceId:e});o.moveWidgetToColumn(t,s,i)},createWidgetFromView:function(t,e,n){var i,o={name:e.name,templateId:t,settings:{selectedViewId:e.id}};if(n.columnId)i=this._findColumnByColumnId(n.columnId),i.addWidgetFromTemplate(o);
else{i=this._findColumnByWidgetId(n.widgetId);var s=i.findTargetIndex(n.widgetId,n.placeAfter);i.addWidgetFromTemplate(o,s)}},setColumnSelectionStrategy:function(t){return t&&n.isFunction(t.selectBestColumnForNewWidget)?void(this._columnSelectionStrategy=t):void console.error("Column selection strategy should be an object with `selectBestColumnForNewWidget` method")},clearColumnSelectionStrategy:function(){this._columnSelectionStrategy=null},_storeLayout:function(t){return t=u.mergeDefaultLayout(t),n.isEqual(this._layout,t)?!1:(this._layout=t,!0)},_getBestOrCreateColumnForNewWidget:function(){if(!this.columns.length)return this.addColumn();if(!this._columnSelectionStrategy)return this._getDefaultColumnForNewWidget();try{return this._columnSelectionStrategy.selectBestColumnForNewWidget(this.columns)}catch(t){return console.error("Unable to select the best column with custom strategy. Falling back to default one.",t),this._getDefaultColumnForNewWidget()}},_getDefaultColumnForNewWidget:function(){return(new o).selectBestColumnForNewWidget(this.columns)},_createColumns:function(){var t=this.columns||[],e=t.length,i=n.flatMap(t,n.property("widgets"));this.columns=n.map(this._layout.columns,this._createColumn.bind(this,i)),n.each(i,function(t){t.remove()}),this.columns.length!==e&&this._notifyColumnCountChanged()},_createColumn:function(t,n,i){return new e(t,n,i,this)},_findColumnByWidgetId:function(t){return n.find(this.columns,function(e){return e.findWidgetIndexById(t)>=0},this)},_findColumnByColumnId:function(t){return n.findWhere(this.columns,{instanceId:t})},_getOrCreateWidget:function(t,e){if(e.widgetId){var i=n.findIndex(t,n.matches({instanceId:e.widgetId}));if(i>=0){var o=t[i];return t.splice(i,1),o.applyNewDefinition(e),o}}return this._createWidget(e)},_createWidget:function(t){var e=this._widgetFactory.createWidgetModel(t,!this.isEditable);return e.settingsChanged.add(this._notifyChanged.bind(this)),e},_notifyColumnCountChanged:function(){this.columnCountChanged.fire(this)
},_notifyChanged:function(){this._layout=n.extend({},this._layout,{columns:n.invoke(this.columns,"getDefinition")}),this._super()},_layoutBuffer:function(t){this.changed.buffer(function(){this.columnCountChanged.buffer(t,this)},this)}});return u.LAYOUT_TYPE_NAME="columns",u.mergeDefaultLayout=function(t){var e=n.defaults(n.deepClone(t||{}),{columns:[]});return n.each(e.columns,u._setDefaultColumnProperties),e},u._setDefaultColumnProperties=function(t){return n.defaults(t,{widgets:[]}),n.each(t.widgets,u._setDefaultWidgetProperties),t},u._setDefaultWidgetProperties=function(t){if(!t.widgetId){var e=n.UUID();console.error('Widget should have an ID. Setting auto-generated ID "'+e+'" for widget',t),t.widgetId=e}return n.defaults(t,{settings:{},name:void 0})},e=s.extend({instanceId:null,definition:null,layout:null,widgets:null,init:function(t,e,i,o){this.instanceId=String(i),this.definition=n.deepClone(e),this.layout=o,this.widgets=n.map(this.definition.widgets,o._getOrCreateWidget.bind(o,t))},getDefinition:function(){return n.extend({},this.definition,{widgets:n.invoke(this.widgets,"getDefinition")})},getDesiredColumnWidth:function(){return this.definition?this.definition.width:null},_createWidget:function(t){var e={templateId:t.templateId,widgetId:n.UUID(),name:t.name,settings:t.settings};return u._setDefaultWidgetProperties(e),this.layout._createWidget(e)},addWidgetFromTemplate:function(t,e){var i=this._createWidget(t);return n.isUndefined(e)?this.widgets.push(i):this.insertWidget(i,e),this.layout._notifyChanged(),i},removeWidget:function(t){this.widgets=n.without(this.widgets,t),this.layout._notifyChanged()},insertWidget:function(t,e){this.widgets.splice(e,0,t),this.layout._notifyChanged()},findTargetIndex:function(t,e){var n=this.findWidgetIndexById(t);return e&&n++,n},moveWidget:function(t,e,n,i){var o=this._removeWidgetById(t),s=e.findTargetIndex(n,i);e.insertWidget(o,s)},moveWidgetToColumn:function(t,e,n){var i=t.instanceId||t;t=this._removeWidgetById(i);var o=n?e.widgets.length:0;
e.insertWidget(t,o)},_removeWidgetById:function(t){var e=this.findWidgetIndexById(t);return this.widgets.splice(e,1)[0]},findWidgetIndexById:function(t){return n.findIndex(this.widgets,n.matches({instanceId:t}))}}),u});