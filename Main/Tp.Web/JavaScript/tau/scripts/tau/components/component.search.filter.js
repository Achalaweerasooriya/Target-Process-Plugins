define(["Underscore","jQuery","tau/components/component.creator","tau/models/model.search-resolver","tau/components/extensions/error/extension.errorBar"],function(e,t,i,a,r){return{create:function(n){n["queue.bus"]=!0;var s={"queue.bus":!0,extensions:[r],template:{engine:"jqote2",name:"search-filter-template",markup:['<div class="tau-search-header">','<form action="">','<div class="tau-search-wrap">','<span class="tau-inline-group tau-search">','<input type="text" class="tau-in-text i-role-search-string" placeholder="Search" value="<%! this.params.searchString %>">','<button class="tau-btn tau-search i-role-search-trigger"></button>',"</span>","</div>",'<div class="search-settings">',"<span>Search in</span>",'<select class="tau-select i-role-entity-type-filter">','<option value=""<% if (!this.params.entityTypeId) { %> selected<% } %>>Any entities</option>',"<% for(var i = 0; i < this.entityTypes.length; i++) { %>","<% var et = this.entityTypes[i]; %>",'<option value="<%= et.id %>"<% if (et.id == this.params.entityTypeId) { %> selected<% } %>>',"<%= et.term %>","</option>","<% } %>","</select>",'<select class="tau-select i-role-entity-state-filter">','<option value=""<% if (!this.params.entityStateIds) { %> selected<% } %>>Any states</option>',"<% for(var i = 0; i < this.entityStates.length; i++) { %>","<% var es = this.entityStates[i]; %>",'<option value="<%= es.id %>" available="<%= es.availableId %>"<% if (es.id == this.params.entityStateIds) { %> selected<% } %>>',"<%= es.name %>","</option>","<% } %>","</select>",'<label class="tau-checkbox">','<input<% if (this.params.isAllProjects) { %> checked<% } %> type="checkbox" class="i-role-all-projects-filter">',"<i></i>","<span>All projects <% if (this.isBoardEdition) { %>&amp; teams<% } %></span>","</label>","</div>","</form>","</div>"]}},o=i.create(s,n);return o.on("afterInit",function(e){var t=e.data.config.context.configurator,i=t.service("search"),a=i.params().get();i.getSearchDomain(a).done(function(e){e.isBoardEdition=t.isBoardEdition,o.fire("dataBind",e)})}),o.on("afterRender",function(i){var r=i.data.element,s=n.context.configurator,l=function(e){var t=[".i-role-search-string",".i-role-entity-type-filter",".i-role-entity-state-filter",".i-role-all-projects-filter"].join(","),i=r.find(t);e===!1?i.attr("disabled","disabled"):i.removeAttr("disabled")},c=s.service("search"),d=function(){var t=c.params();return t.set("entityStateIds",null),c.getSearchDomain(t.get()).done(function(t){var i=r.find(".i-role-entity-state-filter"),a=i.val(),n=i.find('option[value="'+a+'"]').text();n=e.trim(n),i.empty().append('<option value="">Any state</option>'),e(t.entityStates).each(function(e){var t=e.name===n?" selected":"";i.append('<option value="'+e.id+'" available="'+e.availableId+'"'+t+">"+e.name+"</option>")})})},p=function(){o.fire("clearError"),l(!1);var t=e.trim(r.find(".i-role-search-string").val());a.resolveSearchToken(t,s).fail(function(e){l(!0),o.fire("error",{message:e})}).done(function(e){if("search"===e.entity){var i=s.service("search");i.offSearch(l),i.onSearch(l);var a=r.find(".i-role-all-projects-filter").prop("checked"),n=r.find(".i-role-entity-state-filter"),o=n.val();a===!0&&o&&(o=n.find('option[value="'+o+'"]').attr("available")),i.params().set("searchString",t).set("entityTypeId",r.find(".i-role-entity-type-filter").val()||null).set("entityStateIds",o).set("isAllProjects",a).set("isAllTeams",!s.isBoardEdition||a).submit()}else s.service("navigator").to(e.entity+"/"+e.id)})};r.find(".i-role-search-trigger").click(function(e){e.preventDefault(),p()}),r.on("change",".i-role-entity-type-filter",function(e){e.preventDefault(),c.params().set("entityTypeId",t(this).val()),d().done(p)}),r.on("change",".i-role-entity-state-filter,.i-role-all-projects-filter",function(e){e.preventDefault();var t=c.params(),i=r.find(".i-role-all-projects-filter").prop("checked");t.set("isAllProjects",i),t.set("isAllTeams",!s.isBoardEdition||i),d().done(p)})}),o}}});