define(["Underscore","jQuery","tau/components/component.creator","tau/components/extensions/error/extension.errorBar"],function(_,$,ComponentCreator,ErrorBar){return{create:function(config){config["queue.bus"]=!0;var creatorConfig={"queue.bus":!0,extensions:[ErrorBar],template:{engine:"jqote2",name:"search-filter-template",markup:['<div class="tau-search-header">','<form action="">','<div class="tau-search-wrap">','<span class="tau-inline-group tau-search">','<input type="text" class="tau-in-text i-role-search-string" placeholder="Search" value="<%! this.params.searchString %>">','<button class="tau-btn tau-search i-role-search-trigger"></button>',"</span>","</div>",'<div class="search-settings">',"<span>Search in</span>",'<select class="tau-select i-role-entity-type-filter">','<option value=""<% if (!this.params.entityTypeId) { %> selected<% } %>>Any entities</option>',"<% for(var i = 0; i < this.entityTypes.length; i++) { %>",'<option value="<%= this.entityTypes[i].id %>"<% if (this.entityTypes[i].id == this.params.entityTypeId) { %> selected<% } %>>',"<%= this.entityTypes[i].term %>","</option>","<% } %>","</select>",'<label class="tau-checkbox">','<input<% if (this.params.isAllProjects) { %> checked<% } %> type="checkbox" class="i-role-all-projects-filter"><i></i><span>All projects</span>',"</label>","</div>","</form>","</div>"]}},component=ComponentCreator.create(creatorConfig,config),resolveSearchToken=function(searchToken,configurator){var $tokenResolver=$.Deferred();if(/^\d+$/.test(searchToken)){var store=configurator.getStore();store.get("general",{id:searchToken,fields:["id",{entityType:["id","name"]}]}).done({success:function(r){var d=r[0].data;"project"===d.entityType.name.toLowerCase()?store.get("project",{id:d.id,fields:["id","name"]}).done({success:function(r){$tokenResolver.resolve({id:d.id,entity:d.entityType.name})},failure:function(r){$tokenResolver.resolve({id:null,entity:"search"})}}):$tokenResolver.resolve({id:d.id,entity:d.entityType.name})},failure:function(){$tokenResolver.resolve({id:null,entity:"search"})}})}else searchToken.length>2?$tokenResolver.resolve({id:null,entity:"search"}):$tokenResolver.reject("Enter more than 2 chars");return $tokenResolver};return component.on("afterInit",function(e){var configurator=e.data.config.context.configurator,searchServiceInstance=configurator.service("search");searchServiceInstance.getSearchDomain().done(function(d){d.params=searchServiceInstance.params().get(),component.fire("dataBind",d)})}),component.on("afterRender",function(e){var $node=e.data.element,configurator=config.context.configurator,enableForm=function(enable){var selectors=[".i-role-search-string",".i-role-entity-type-filter",".i-role-entity-state-filter",".i-role-all-projects-filter"].join(",");enable===!1?$node.find(selectors).attr("disabled","disabled"):$node.find(selectors).removeAttr("disabled")},triggerSearch=function(){component.fire("clearError"),enableForm(!1);var searchString=_.trim($node.find(".i-role-search-string").val());resolveSearchToken(searchString,configurator).fail(function(message){enableForm(!0),component.fire("error",{message:message})}).done(function(d){if(d.entity!=="search")configurator.service("navigator").to(d.entity+"/"+d.id);else{var entityType=$node.find(".i-role-entity-type-filter").val(),entityState=$node.find(".i-role-entity-state-filter").val(),isAllProjects=$node.find(".i-role-all-projects-filter").prop("checked"),searchService=configurator.service("search");searchService.offSearch(enableForm),searchService.onSearch(enableForm),searchService.params().set("searchString",searchString).set("entityTypeId",entityType?entityType:null).set("entityStateIds",entityState?[entityState]:[]).set("isAllProjects",isAllProjects).submit()}})};$node.find(".i-role-search-trigger").click(function(e){e.preventDefault(),triggerSearch()}),$node.on("change",".i-role-entity-type-filter,.i-role-entity-state-filter,.i-role-all-projects-filter",function(e){e.preventDefault(),triggerSearch()})}),component}}})