define(["require","tau/core/extension.base","tau/services/boards/view.types","template!tau/components/comet.status/templates/comet.status.reconnecting.template","template!tau/components/comet.status/templates/comet.status.reconnected.template"],function(e){var t=e("tau/core/extension.base"),n=e("tau/services/boards/view.types"),s=e("template!tau/components/comet.status/templates/comet.status.reconnecting.template"),o=e("template!tau/components/comet.status/templates/comet.status.reconnected.template");return t.extend({"bus afterInit":function(e,t){this._comet=t.config.context.configurator.getComet(),this._comet.whenStarted().then(function(){this.fire("connection.started")}.bind(this)),this.fire("dataBind")},"bus afterRender:last + boardSettings.ready + connection.started:last":function(e,t,s){this._cleanUpCometEventHandlers();var o=s.boardSettings.settings.itemType,c=o===n.BOARD||o===n.DASHBOARD;c&&(this._comet.state==this._comet.CONNECTED?this._onAlreadyConnected(t.element):this._comet.start(this._onAlreadyConnected.bind(this,t.element)),this._comet.connecting.add(function(){this._onConnecting(t.element)},this),this._comet.disconnected.add(function(){this._onDisconnected(t.element),this._comet.refreshRequired.once(this._onRefresh.bind(this,t.element),this)},this),this._comet.connected.add(function(){this._onConnected(t.element)},this))},_onAlreadyConnected:function(e){e.fadeOut(),this._comet.refreshRequired.remove(this._onRefresh,this)},_onConnecting:function(e){this._toggleClasses(e,"connecting")},_onDisconnected:function(e){this._destroyConfirmIfNecessary(e);var t=this;this._toggleClasses(e,"disconnected").show().tauConfirm({content:["<div>",'<p class="i-role-message-offline tau-message-offline">Live updates are offline</p>','<p class="i-role-reconnect">Reconnecting in <span class="i-role-time-till-reconnect">',t._comet.secondsTillReconnect(),"</span> second(s)...</p>","</div>"].join(""),zIndex:2,template:s.render(),className:"tau-comet-indicator-message",callbacks:{success:function(){t._comet.start(function(){t._comet.refreshRequired.fire()
})}},onBeforeShow:function(e){t._setSecondsTillReconnect(e),this._timeTillReconnect=window.setInterval(function(){t._setSecondsTillReconnect(e)},200),t._comet.connecting.once(this.hide,this)},onHide:function(){this._timeTillReconnect&&window.clearInterval(this._timeTillReconnect)}})},_onRefresh:function(e){this._destroyConfirmIfNecessary(e),this._toggleClasses(e,"connected").fadeOut()},_setSecondsTillReconnect:function(e){e.find(".i-role-time-till-reconnect").text(this._comet.secondsTillReconnect())},_onConnected:function(e){this._destroyConfirmIfNecessary(e),this._toggleClasses(e,"connected").tauConfirm({content:["<div>",'<p class="i-role-message-restored tau-message-restored">Connection restored</p>',"</div>"].join(""),zIndex:2,template:o.render(),className:"tau-comet-indicator-message",callbacks:{success:function(){e.fadeOut(),this._comet.refreshRequired.fire()}.bind(this)}})},_destroyConfirmIfNecessary:function(e){e.tauConfirm("instance")&&e.tauConfirm("destroy")},_toggleClasses:function(e,t){return e.toggleClass("connected","connected"===t).toggleClass("disconnected","disconnected"===t).toggleClass("connecting","connecting"===t)},_cleanUpCometEventHandlers:function(){this._comet.removeEventHandlers(this)},destroy:function(){this._cleanUpCometEventHandlers(),this._super()}})});