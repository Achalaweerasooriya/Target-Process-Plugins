define(["Underscore","tau/core/class","./models/hierarchy.innerLevels"],function(e,t,i){return t.extend({init:function(e,t,i,s){this._newListModel=e,this._definition=t,this._store=s,this._apiService=i},attach:function(){this._apiService.innerLevelsDefinitionChanged.add(this._subscribeToStore,this),this._subscribeToStore()},_getTypesToSubscribeTo:function(t){var s=e.pluck(t.cells.types,"type"),n=t.x?t.x.types:[],r=t.y?t.y.types:[],o=i.getInnerTypes(t);return e.union(s,n,r,o)},_subscribeToStore:function(){this._unsubscribeFromStore();var t=this._getTypesToSubscribeTo(this._definition);e.forEach(t,e.bind(function(t){this._store.on({eventName:"afterRemove",type:t,listener:this},e.bind(function(e){this._newListModel.deleteCard(e.data.id,e.data.type)},this));var i=this._store.getEvictedPropertiesByType(t);e.forEach(i,function(e){this._store.on({eventName:"afterSave",type:t,listener:this,hasChanges:[e]},function(e){this._store.evictPersistedObject(e.data.id,e.data.type)}.bind(this))},this)},this)),this._store.on({eventName:"failure",listener:this},e.bind(function(i){var s=e.complexKey(i||{},"data.cmd");if(e.isObject(s)&&e.contains(t,s.type.toLowerCase())){var n=s.config.id;n&&e.contains(["save","remove"],s.name)&&this._newListModel.refreshCard(n,s.type)}},this))},destroy:function(){this._unsubscribeFromStore(),this._apiService.innerLevelsDefinitionChanged.remove(this)},_unsubscribeFromStore:function(){this._store.unbind(this)}})});