define(["Underscore","tau/core/class"],function(n,e){return e.extend({init:function(n){this._node=n},getExpandedModelsAtLevel:function(e){if(0===e)return[this._node];var t=n.filter(this._node.nodes.items,function(n){return n.nodes});return n.flatMap(t,function(n){return n.hierarchy.getExpandedModelsAtLevel(e-1)})},accept:function(e){e.visit(this._node),this._node.nodes&&n.each(this._node.nodes.items,function(n){n.hierarchy.accept(e)})},getAllNodesAtLevel:function(e){if(0===e)return[this._node];var t=this._node.nodes.items;return n.flatMap(t,function(n){return n.hierarchy.getAllNodesAtLevel(e-1)})},findNodeByPath:function(n){return this._findNodeByPathInternal(this._node,n,function(n,e){return n.hierarchy.findChildByCardId(e)})},findRawNodeByPath:function(e,t){return this._findNodeByPathInternal(e,t,function(e,t){return n.find(e.nodes.items,function(n){return n.dataItem.id==t})})},_findNodeByPathInternal:function(e,t,r){if(!t.length)return e;var d=r(e,t[0]);return d?this._findNodeByPathInternal(d,n.rest(t),r):null},findChildByCardId:function(e){return this._node.nodes?n.find(this._node.nodes.items,this._getCardIdComparison(e)):null},findAllDescendantNodesByCardIdAndType:function(e,t){var r=this._getCardIdComparison(e),d=function(e,i){return i.nodes?(t=t.toLowerCase(),n.each(i.nodes.items,function(n){r(n)&&n.getCardType().toLowerCase()===t&&e.push(n),d(e,n)}),e):e};return d([],this._node)},getPath:function(){for(var n=[],e=this._node;e&&e.card;)n.unshift(e.card.id.toString()),e=e.parent;return n},_getCardIdComparison:function(e){if(n.isString(e)&&0===e.indexOf("b64_"))return function(n){return n.card&&n.card.getEncodedId()===e};var t=parseFloat(e);return n.isNaN(t)?function(n){return n.card&&n.card.getId()===e}:function(n){return n.card&&n.card.getId()===t}}})});