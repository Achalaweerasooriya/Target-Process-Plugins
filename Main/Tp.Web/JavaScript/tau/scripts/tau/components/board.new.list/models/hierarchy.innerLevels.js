define(["jQuery","Underscore","tau/models/board.customize.units/board.customize.cards.builderSelector","tau/models/board.customize.units/const.card.sizes"],function(e,n,t,r){return{getInnerTypes:function(e){return e.innerLevels?n.flatMap(e.innerLevels.items,function(e){return n.flatMap(e.items,function(e){return n.map(e.items,function(e){return e.id})})}):[]},createInnerLevelsDefinition:function(t,r){var i=t.getMetaForCells()||{},u=n.chain(i.cardTypes).map(function(e){return e.canExpand?this._getCardDataForInnerTypes(e.innerTypes,r).then(function(n){return{parentEntityType:e.valueType,items:n}}):null},this).compact().value();return e.when.all(u).then(function(e){return{items:[{items:e}]}})},_getCardDataForInnerTypes:function(i,u){if(!i||!i.length)return e.Deferred().resolve();i=n.map(i,function(e){return e.toLowerCase()});var a=new t;return u.getCardLayoutsByTypesAndSize(i,r.LIST).then(function(e){return n.map(e,function(e,n){return{id:n,data:a.build(n,e)}})})}}});