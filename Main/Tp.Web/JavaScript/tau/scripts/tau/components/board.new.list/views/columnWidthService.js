define(["require","Underscore","jQuery","tau/core/class","tau/utils/debug/utils.debug","tau/components/board.new.list/views/units/unit","tau/components/board.new.list/views/units/nameUnit"],function(t){var e=t("Underscore"),n=t("jQuery"),i=t("tau/core/class"),s=t("tau/utils/debug/utils.debug"),r=t("tau/components/board.new.list/views/units/unit"),a=t("tau/components/board.new.list/views/units/nameUnit");return i.extend({COLUMN_WIDTHS_STYLE_ID:"-list-columns-level-",SETTING_NAME:"listUserSettings",init:function(t,e){this.resetCache(),this._boardSettings=t,this._widthOptions=e||{}},resetCache:function(){this.layout={items:{}}},setElementScope:function(t){this.$boardBody=t,this.boardBodyId=t.attr("id"),s.assertError(!!this.boardBodyId,"board body id should be set")},calculateColumnWidths:function(t,i){var s=taus.start("statistics_newlist_columnWidths",this._createStatsDataFromRequests(t)),r=e.chain(t).groupBy(function(t){return t.levelKey}).map(function(t,s){var r=n(e.map(t,function(t){return t.levelContainer})),a="0"===s?this._calculateRootLevel(r):this._calculateNestedLevel(s,r,i);return n.when(a).then(function(t){return{levelKey:s,cssRules:t}})}.bind(this)).value();return n.when.all(r).then(function(t){var n=e.filter(t,function(t){return!!t.cssRules});this._createColumnWidthStyles(n),s.stop()}.bind(this))},_calculateRootLevel:function(t){return n.when(this.layout.name?this.layout:this._getColumnSizeSettings()).then(function(e){this.layout.name=e.name,this._calculateUnitWidths("0",t);var n=this._generateCssRules("0"),i=this._getForLevel("0");return this.layout.name=i&&i.name&&i.name.calculated,n}.bind(this))},_calculateNestedLevel:function(t,e,n){return this._shouldSkipCalculationFor(t,e,n)?void 0:(this._calculateUnitWidths(t,e),this._generateCssRules(t))},_calculateUnitWidths:function(t,n){var i=".tau-elems-table-level-"+t,s=n.eq(0).find(".i-role-headerholder "+i);if(!s.length)return console.warn("_calculateUnitWidths: empty level "+t),void this._setForLevel(t,null);
this._removeColumnWidthsStyle(t),this.layout.dragHandler=this.layout.dragHandler||s.find(".tau-drag-handler-cell").width();var u=this.layout.dragHandler+a.prototype.COLLAPSER_WIDTH,l={},o=s.find(".tau-elems-cell"),h=e.tail(o);e.each(h,function(e){var i=new r(e,t,n,{minWidth:this._widthOptions.minUnitWidth}),s=i.calculateWidth();l[i.unitId]=s,l.hasItems=l.hasItems||i.hasItems,u+=s.calculated},this);var c=this._createNameUnit(o[0],t,n);if(this.layout.name)l.name=c.setupForcedWidth(this.layout.name);else{var d=this.$boardBody.closest(".tau-board-list-view__inner");l.name=c.setupWidth(d,u)}this._setForLevel(t,l)},_generateCssRule:function(t){return"#"+this.boardBodyId+" "+t.selector+" { width: "+t.calculated+"px; }"},_generateCssRules:function(t){var n=[],i=this._getForLevel(t);return i?(e.each(i,function(t,e){t.hasItems&&"name"!==e&&n.push(this._generateCssRule(t))},this),n.push(this._generateCssRule(i.name)),n):(console.warn("_generateCssRules: empty level "+t),n)},resize:function(){},setNameWidth:function(t,n){return this._setColumnSizeSettings({name:t}).then(function(){this.layout.name=t;var i=n.closest(".i-role-board-body");e.each(this.layout.items,function(t,e){var n=this._createNameUnit(null,e,i);t.name.calculated=n.setupForcedWidth(this.layout.name).calculated;var s=this._generateCssRules(e);this._createColumnWidthStyles([{levelKey:e,cssRules:s}])},this)}.bind(this))},getMinNameUnitWidth:function(){return this._widthOptions.minNameUnitWidth||a.prototype.MIN_UNIT_WIDTH},_getColumnSizeSettings:function(){return this._getListUserSettings().then(function(t){return t.columnSizes||{}}.bind(this))},_setColumnSizeSettings:function(t){return this._setListUserSettings({columnSizes:t})},_getListUserSettings:function(){return this._boardSettings.get([this.SETTING_NAME]).then(function(t){return t[this.SETTING_NAME]||{}}.bind(this))},_setListUserSettings:function(t){return this._getListUserSettings().then(function(n){e.extend(n,t);var i={};return i[this.SETTING_NAME]=n,i}.bind(this)).then(function(t){return this._boardSettings.set({set:t})
}.bind(this))},_getForLevel:function(t){return this.layout.items[t]},_setForLevel:function(t,e){this.layout.items[t]=e},_createColumnWidthStyles:function(t){e.each(t,function(t){this._removeColumnWidthsStyle(t.levelKey)},this);var i=e.map(t,function(t){var e=this._createColumnWidthStyleId(t.levelKey);return'<style id="'+e+'">'+t.cssRules.join("\n")+"</style>"},this).join("\n");n(i).appendTo(this.$boardBody)},_removeColumnWidthsStyle:function(t){n("#"+this._createColumnWidthStyleId(t)).remove()},_createColumnWidthStyleId:function(t){return this.boardBodyId+this.COLUMN_WIDTHS_STYLE_ID+t},_shouldSkipCalculationFor:function(t,e,n){var i=this._getForLevel(t);if(!i)return!1;if(n){if(i.hasItems)return!0;if(i.hasItems===!1&&!e.find(".i-role-card:first-child").length)return!0}return!1},_createStatsDataFromRequests:function(t){return e.chain(t).groupBy(function(t){return t.levelKey}).reduce(function(t,e,n){return t[n]=e.length,t},{}).value()},_createNameUnit:function(t,e,n){return new a(t,e,n,{minWidth:this._widthOptions.minNameUnitWidth})}})});