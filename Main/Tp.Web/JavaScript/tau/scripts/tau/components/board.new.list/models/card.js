define(["Underscore","tau/core/class"],function(t,e){return e.extend({init:function(e){t.each(e,function(t,e){this[e]=t},this),this._updateEntityInfo(e)},getCardProperties:function(){return t.chain(t.keys(this)).filter(function(e){return!t.isObject(this[e])},this).map(function(t){return{key:t,propertyName:t,getValue:function(e){return e[t]},setValue:function(e,n){e[t]=n}}},this).union(t.map(this.data,function(t,e){return{key:"data__"+e,propertyName:e,getValue:function(t){return t.data[e]},setValue:function(t,n){t.data[e]=n}}},this)).value()},getDiff:function(e){var n=this,i=e.getCardProperties();return t.chain(this.getCardProperties()).map(function(a){var r=t.find(i,function(t){return a.key==t.key});if(!r)return null;var u=t.isEqual(r.getValue(e),a.getValue(n));return u?null:r}).compact().value()},getId:function(){return this.data.cardData.id},getEncodedId:function(){return this.id},getEntityType:function(){return this.data.cardData.type},isNoValueCard:function(){return!!this.data.empty},updateWith:function(e){var n=t.object(t.map(this.getDiff(e),function(t){var n=t.getValue(e);return t.setValue(this,n),[t.propertyName,n]},this));return this._updateEntityInfo(e),this._updateCoords(e),this.entity.isFinal=e.entity.isFinal,n},_updateCoords:function(t){this.coords=t.coords},_updateEntityInfo:function(e){this.entity=t.extend(e.data.cardData||{},{entityType:{name:e.type}})}})});