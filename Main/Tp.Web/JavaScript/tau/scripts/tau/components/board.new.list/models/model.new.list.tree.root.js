define(["require","jQuery","Underscore","./model.new.list.tree.base","./model.new.list.tree.node","./paging","./hierarchy.meta","../bus.new.list.event.aggregator"],function(e){var t=e("jQuery"),n=e("Underscore"),a=e("./model.new.list.tree.base"),r=e("./model.new.list.tree.node"),i=e("./paging"),o=e("./hierarchy.meta"),d=e("../bus.new.list.event.aggregator");return a.extend({init:function(e,t){var n=2;if(arguments.length!==n&&console.error("model.new.list.tree.root constructor contract violation.","Expected argument count: ",n,"Actual argument count: ",arguments.length),!(e instanceof d))throw new Error("model.new.list.tree.root constructor contract violation. Event aggregator should have expected type");this._super(t),this.eventAggregator=e,this.countsModel.dataLoaded.add(function(){this.pagingModel.totalCount=this.countsModel.getAllCount(),this.pagingUpdated.fire()},this)},_createPaging:function(){var e=new i,t=this._modelSettings.paging;return e.pageSize=t?t.onPage:50,e},_getNodeConstructor:function(){return r},loadTreeData:function(){return this._loadTreeDataInternal(this.pagingModel.getSkip(),this.pagingModel.getTake()).then(this._updatePagingState.bind(this))},_loadTreeDataInternal:function(e,t){var n={$skip:e,$take:t};return this._executeTreeDataWorkflow(function(e){return e.treeView(n)})},_handleTreeResponse:function(e,t){return this._globalMeta=new o(t),this._super(e,t)},goToPage:function(e){var t=e*this.pagingModel.getTake();return this._loadTreeDataInternal(t,this.pagingModel.getTake()).done(function(){this.pagingModel.setCurrentPage(e),this._updatePagingState()}.bind(this))},goToNextPage:function(){return this.pagingModel.hasNext?this.goToPage(this.pagingModel.getCurrentPage()+1):t.Deferred().resolve()},goToPreviousPage:function(){return this.pagingModel.hasPrev?this.goToPage(this.pagingModel.getCurrentPage()-1):t.Deferred().resolve()},goToLastPage:function(){return this.goToPage(this.countsModel.getPagesCount()-1)},goToFirstPage:function(){return this.goToPage(0)
},setPageSize:function(e){this._modelSettings.listSettings.boardSettingsService.set({set:{cellPaging:{onPage:e}},callback:function(){var t=e;this._loadTreeDataInternal(0,t).done(function(){this.pagingModel.pageSize=t,this.pagingModel.setCurrentPage(0),this._updatePagingState()}.bind(this))}.bind(this)})},updateOrAddUpdatedCards:function(e,t){n.each(e,function(e){var n=e.card,a=this.hierarchy.findNodeByPath(e.path);if(a)if(a.nodes){var r=a.hierarchy.findChildByCardId(n.id);r?t.updateCard(a.nodes,r,n):t.addCardForExistingEntity(a,n)}else t.increaseCardCount(a,n)},this)},deleteCards:function(e){n.each(e,function(e){var t=e.card,n=this.hierarchy.findNodeByPath(e.path);if(n&&n.nodes){var a=n.hierarchy.findChildByCardId(t.id);a&&n.nodes.deleteCard(t)}},this)},deleteDescendantsByCardIdAndType:function(e,t){var a=this.hierarchy.findAllDescendantNodesByCardIdAndType(e,t);n.each(a,function(e){e.parent.nodes.deleteCard(e.card)})},deleteDescendantsByCardIdAndTypeAndPath:function(e,t,a){var r=this.hierarchy.findAllDescendantNodesByCardIdAndType(e,t),i=a.pop();n.each(r,function(e){var t=e.parent.hierarchy.getPath(),n=t.pop();n==i&&e.parent.nodes.deleteCard(e.card)})},refreshDescendantsByCardIdAndType:function(e,t){var a=this.hierarchy.findAllDescendantNodesByCardIdAndType(e,t);n.each(a,this._refreshNode,this)},_refreshNode:function(e){var t=n.object(n.map(e.card.getCardProperties(),function(t){return[t.propertyName,t.getValue(e.card)]}));e.parent.nodes.cardUpdated.fire({card:e.card,properties:t})},updateExpansionState:function(){this.eventAggregator.expansionStateChanged.fire(this.getExpansionState(!1))}})});