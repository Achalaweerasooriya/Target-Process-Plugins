define(["require","Underscore","jQuery","./view.new.list.tree.dragndrop.base"],function(e){var t=e("Underscore"),i=e("jQuery"),o=e("./view.new.list.tree.dragndrop.base"),n={placeholders:null};return o.extend({PRIORITIZATION_OPTIONS:{enabled:{prioritizationPossible:!0,fixedContent:"Prioritization on",floatContent:"Prioritization on",isMovedWithPrioritization:t.constant(!0)},disabled:{prioritizationPossible:!1,fixedContent:"Prioritization off",floatContent:"Prioritization off",isMovedWithPrioritization:t.constant(!1)},shift:{prioritizationPossible:!0,fixedContent:'Hold <span class="shiftButton"></span> to prioritize',floatContent:'Hold <span class="shiftButton"></span> to prioritize',isMovedWithPrioritization:function(e){return!!e.shiftKey}},"non-prioritizable":{prioritizationPossible:!1,fixedContent:"The current View settings do not allow prioritization",floatContent:"The current View settings do not allow prioritization",isMovedWithPrioritization:t.constant(!1)}},NODE_EXPAND_NAMESPACE:".dnd-node-expand-helper",init:function(e,t,i,o,n){this._super(e,t,i,o),this._dataIsPrioritizable=this.treeModel.hierarchyMetaInfo.isPrioritizable,this._dataIsMovableToAnyLevel=!1,this._dataIsMovableToSameLevel=this.treeModel.hierarchyMetaInfo.isMovable&&this.level>0,this._dataIsMovable=this._dataIsMovableToAnyLevel||this._dataIsMovableToSameLevel,this._placeholders=null,this._treeDragNDropExpander=n,(this._dataIsMovable||this._dataIsPrioritizable)&&this._makeSortable()},_getSortableOptions:function(){var e=this._dataIsMovable;return{items:"> .i-role-card:not(.tau-axis-card-no-value), > .tau-list-level",cancel:"."+this.IS_BEING_MOVED_CLASS,handle:".tau-drag-handler-enabled.tau-drag-handler-level-"+this.level,connectWith:this._getMovableConnectionSelector(),axis:"y",opacity:.8,containment:e?null:this.containment,scrollSensitivity:33,tolerance:this.dndOptions.tolerance||"intersect",placeholder:this._createPlaceholder(),helper:this._createHelper.bind(this),start:function(e,t){this._isSourceOfDraggedItem=!0,this._updatePlaceholders(this._placeholders);
var i=t.item;this._refreshPositions(),this._storeStartCoordinates(i),this._createNodeExpandHelper()}.bind(this),activate:function(){this.$treeContainer.addClass("tau-list-sortable-active")}.bind(this),deactivate:function(){this.$treeContainer.prev(".i-role-headerholder").addBack().removeClass("tau-list-sortable-connected tau-list-sortable-active")}.bind(this),over:function(){this.containment.find(".tau-list-sortable-connected").removeClass("tau-list-sortable-connected"),this._isSourceOfDraggedItem||this.$treeContainer.prev(".i-role-headerholder").addBack().addClass("tau-list-sortable-connected"),this._updatePlaceholders(n.placeholders)}.bind(this),change:e?function(e,t){this._forcePlaceholderAfterExpandedLevel(t.placeholder)}.bind(this):i.noop,stop:function(e,t){this._isSourceOfDraggedItem=!1;var i=t.item;this._removePlaceholder(),this._getFinishCoordinates(i)||this._storeFinishCoordinates(i),this._removeNodeExpandHelper(),this._moveCardWithSubTree(i)}.bind(this),receive:function(e,t){var i=t.item;this._storeFinishCoordinates(i),this._removeSubTree(i)}.bind(this)}},_getPrioritizationOptions:function(){var e=this._dataIsPrioritizable?this.dndOptions.prioritization:"non-prioritizable";return this.PRIORITIZATION_OPTIONS[e]},_createPlaceholder:function(){return{element:function(e){var t=this._getPrioritizationOptions(),o=i(this._createPlaceholderElement("tau-list-sortable-placeholder-fixed",t.fixedContent)).hide(),r=i(this._createPlaceholderElement("tau-list-sortable-placeholder-float",t.floatContent)).hide();return this._placeholders={$fixed:o,$floating:r},n.placeholders=this._placeholders,e.before(o),r}.bind(this),update:function(){this._refreshPositions()}.bind(this)}},_removePlaceholder:function(){this._placeholders.$fixed.remove(),this._placeholders=null,n.placeholders=null},_updatePlaceholders:function(e){if(e){var t=e.$fixed,i=e.$floating,o=this.dndOptions.prioritization;this._dataIsPrioritizable&&("enabled"===o||this.dndOptions.shiftKey&&"shift"===o)?(t.hide(),i.show()):(t.show(),i.hide())
}},_createNodeExpandHelper:function(){var e=this.containment.find(".i-role-list-root-container");e.find(".tau-board-list-view-resizer").css("pointer-events","none"),e.on(["mouseenter"+this.NODE_EXPAND_NAMESPACE,"mouseleave"+this.NODE_EXPAND_NAMESPACE].join(" "),".i-role-card:not(.tau-list-entity-open)",function(e){var t=i(e.currentTarget),o=t.data("dataItem");o&&o.level<this.level&&(this._treeDragNDropExpander.clearTimeout(),"mouseenter"===e.type&&this._treeDragNDropExpander.setTimeout(t,this._activateSortableOnExpandedNode.bind(this)))}.bind(this))},_removeNodeExpandHelper:function(){this._treeDragNDropExpander.clearTimeout();var e=this.containment.find(".i-role-list-root-container");e.find(".tau-board-list-view-resizer").css("pointer-events",""),e.off(this.NODE_EXPAND_NAMESPACE)},_activateSortableOnExpandedNode:function(){var e=this.$treeContainer.sortable("instance");this._refreshPositions(),t.each(e.containers,function(t){t.element.hasClass("tau-list-sortable-active")||(t._trigger("activate",null,t._uiHash()),e._rearrange(null,null,t.element,!0))})},setDndOptions:function(e){this.dndOptions=e,this._updateSortableClasses(),this._updatePlaceholders(this._placeholders)},isMovedWithPrioritization:function(){return this._getPrioritizationOptions().isMovedWithPrioritization(this.dndOptions)}})});