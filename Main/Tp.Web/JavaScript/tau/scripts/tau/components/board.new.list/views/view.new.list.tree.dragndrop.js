define(["Underscore","jQuery","tau/core/class","tau/ui/extensions/board.plus/ui.board.plus.dom.utils"],function(t,i,e,s){return e.extend({PRIORITIZATION_OPTIONS:{enabled:{prioritizationPossible:!0,content:"Prioritization on",isMovedWithPrioritization:function(){return!0}},disabled:{prioritizationPossible:!1,content:"Prioritization off",isMovedWithPrioritization:function(){return!1}},shift:{prioritizationPossible:!0,content:'Hold <span class="shiftButton"></span> to prioritize',isMovedWithPrioritization:function(t){return t.shiftKey}}},options:{},init:function(t,i){this.$treeContainer=t.$treeContainer,this.treeModel=t.treeModel,this.dndOptions=i.dndOptions,this.applyDndMove=i.applyDndMove.bind(i),this.containment=i.skeletonView.$el.find(".tau-board-list-view__inner"),this.level=this.treeModel.level,this.isDataPrioritizable()&&this._makeSortable()},_makeSortable:function(){var t=this.isDndPossible(),i=this.treeModel.level;this.$scrollParent=this.$treeContainer.scrollParent(),this.$treeContainer.toggleClass("tau-sortable",t).sortable({disabled:!t,items:"> .i-role-card:not(.tau-axis-card-no-value), > .tau-list-level",handle:".tau-drag-handler-enabled.tau-drag-handler-level-"+i,axis:"y",opacity:.8,containment:this.containment,scrollSensitivity:33,tolerance:this.dndOptions.tolerance||"intersect",placeholder:this._createPlaceholder(),helper:this._createHelper.bind(this),create:function(){var t=this._getSortableInstance();this._fixWidgetIntersectionLogic(t),this._fixWidgetScrollLogic(t),this._fixWidgetContainmentLogic(t)}.bind(this),start:function(t,i){var e=i.item;e.hasClass("tau-list-entity-open")&&this._refreshPositions(),e.data("list-startCoordinates",this._getCoordinates(e))}.bind(this),stop:function(t,i){this.$treeContainer.find(".tau-list-sortable-placeholder-fixed").remove(),this._moveCardWithSubTree(i.item)}.bind(this)})},_getSortableInstance:function(){return this.$treeContainer.data("ui-sortable")},_getPrioritizationOptions:function(){return this.PRIORITIZATION_OPTIONS[this.dndOptions.prioritization]
},_createPlaceholderElement:function(i){var e=this._getPrioritizationOptions().content,s=t.compact(["i-role-card","tau-list-entity",i]);return'<div class="'+s.join(" ")+'"><div class="tau-list-line"><div class="tau-elems-table tau-sortable__placeholder-inner">'+e+"</div></div></div>"},_createPlaceholder:function(){return{element:function(t){return t.before(this._createPlaceholderElement("tau-list-sortable-placeholder-fixed")),this._createPlaceholderElement("tau-list-sortable-placeholder-float")}.bind(this),update:function(){this._restoreScrollPosition(),this._refreshPositions()}.bind(this)}},_createHelper:function(t,i){this._saveScrollPosition();var e=i.next(".tau-list-level");return e.length?(e.slideUp(this._refreshPositions.bind(this)),i.data("list-subtree",e)):i.data("list-subtree",null),i},isDataPrioritizable:function(){return this.treeModel.hierarchyMetaInfo.isPrioritizable},isDndPossible:function(){return this.isDataPrioritizable()&&this._getPrioritizationOptions().prioritizationPossible},isMovedWithPrioritization:function(){return this._getPrioritizationOptions().isMovedWithPrioritization(this.dndOptions)},_refreshPositions:function(){this.$treeContainer.sortable("refreshPositions")},_saveScrollPosition:function(){this.scrollTop=this.$scrollParent[0].scrollTop},_restoreScrollPosition:function(){this.$scrollParent[0].scrollTop=this.scrollTop},_fixWidgetIntersectionLogic:function(i){i._intersectsWithPointer=t.wrap(i._intersectsWithPointer.bind(i),function(t,i){var e=t(i);return e&&(i.item.hasClass("tau-list-entity-open")?e=1:i.item.hasClass("tau-list-level")&&(e=2)),e})},_fixWidgetContainmentLogic:function(i){i._generatePosition=t.wrap(i._generatePosition.bind(i),function(t,i){if(this.containment){var e=this.containment[3]+this.offset.click.top-11;i.pageY>e&&(i.pageY=e)}return t(i)})},_fixWidgetScrollLogic:function(t){t._mouseDrag=function(t){var e,s,o,r,n=this.options,l=!1;if(this.position=this._generatePosition(t),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll){var a=this.scrollParent[0];
if(a!==document&&"HTML"!==a.tagName){if(this.overflowOffset.top+a.offsetHeight-t.pageY<n.scrollSensitivity){var h=this.items[this.items.length-1];h.item[0]===this.currentItem[0]&&(h=this.items[this.items.length-2]);var c=h?h.top+h.height:0,d=c-this.positionAbs.top;d>0&&(a.scrollTop=l=a.scrollTop+Math.min(n.scrollSpeed,d))}else t.pageY-this.overflowOffset.top<n.scrollSensitivity&&(a.scrollTop=l=a.scrollTop-n.scrollSpeed);this.overflowOffset.left+a.offsetWidth-t.pageX<n.scrollSensitivity?a.scrollLeft=l=a.scrollLeft+n.scrollSpeed:t.pageX-this.overflowOffset.left<n.scrollSensitivity&&(a.scrollLeft=l=a.scrollLeft-n.scrollSpeed)}else{var f=i(document);t.pageY-f.scrollTop()<n.scrollSensitivity?l=f.scrollTop(f.scrollTop()-n.scrollSpeed):i(window).height()-(t.pageY-f.scrollTop())<n.scrollSensitivity&&(l=f.scrollTop(f.scrollTop()+n.scrollSpeed)),t.pageX-f.scrollLeft()<n.scrollSensitivity?l=f.scrollLeft(f.scrollLeft()-n.scrollSpeed):i(window).width()-(t.pageX-f.scrollLeft())<n.scrollSensitivity&&(l=f.scrollLeft(f.scrollLeft()+n.scrollSpeed))}l!==!1&&i.ui.ddmanager&&!n.dropBehaviour&&i.ui.ddmanager.prepareOffsets(this,t),l!==!1&&this.refreshPositions(!0)}for(this.positionAbs=this._convertPositionTo("absolute"),this.options.axis&&"y"===this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"===this.options.axis||(this.helper[0].style.top=this.position.top+"px"),e=this.items.length-1;e>=0;e--)if(s=this.items[e],o=s.item[0],r=this._intersectsWithPointer(s),r&&s.instance===this.currentContainer&&o!==this.currentItem[0]&&this.placeholder[1===r?"next":"prev"]()[0]!==o&&!i.contains(this.placeholder[0],o)&&("semi-dynamic"===this.options.type?!i.contains(this.element[0],o):!0)){if(this.direction=1===r?"down":"up","pointer"!==this.options.tolerance&&!this._intersectsWithSides(s))break;this._rearrange(t,s),this._trigger("change",t,this._uiHash());break}return this._contactContainers(t),i.ui.ddmanager&&i.ui.ddmanager.drag(this,t),this._trigger("sort",t,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1
}},_findSibling:function(t,i){var e=t;do e=e[i]();while(e.length&&!e.is(".i-role-card[id]"));return e},_getCoordinates:function(t){var i=t.closest(".tau-list-level");return{itemId:t.data("id").toString(),parentId:i.data("listParentId"),itemBefore:this._findSibling(t,"prev"),itemAfter:this._findSibling(t,"next")}},_moveCardWithSubTree:function(t){var e=i.Deferred(),o=t.data("list-startCoordinates"),r=this._getCoordinates(t);if(r.itemBefore[0]===o.itemBefore[0]&&r.itemAfter[0]===o.itemAfter[0])return this._showSubTree(t),e.resolve();e.fail(function(){this._moveCardToCoordinates(t,o),this._showSubTree(t),s.animated(t,"tau-card_dnd_failed")}.bind(this));var n={item:t,treeModel:this.treeModel};return this.isMovedWithPrioritization()?(n.itemBefore=r.itemBefore,n.itemAfter=r.itemAfter,this.applyDndMove(n).then(function(){e.resolve()}.bind(this),function(){e.reject()}.bind(this)),this._showSubTree(t),e):(this._restoreScrollPosition(),e.reject())},_moveCardToCoordinates:function(t,i){if(i.itemBefore.length){var e=i.itemBefore,s=e.next(".tau-list-level");t.insertAfter(s.length?s:e)}else i.itemAfter.length?t.insertBefore(i.itemAfter):console.error("Move card after d&d: cannot find position in DOM",i)},_showSubTree:function(t){var i=t.data("list-subtree");i&&i.length&&i.insertAfter(t).slideDown()},setDndOptions:function(t){this.dndOptions=t;var i=this.isDndPossible();this.$treeContainer.toggleClass("tau-sortable",i).sortable({disabled:!i})}})});