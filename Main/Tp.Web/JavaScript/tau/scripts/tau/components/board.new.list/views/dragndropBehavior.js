define(["Underscore","jQuery","tau/core/class","tau/utils/debug/utils.debug","tau/components/board.new.list/views/view.new.list.tree.dragndrop","tau/components/board.new.list/models/node.modification.strategies"],function(t,i,e,n,o,s){return e.extend({_eventNamespace:".newlist-dragndrop-behavior",_fields:["prioritization"],init:function(i){this._eventAggregator=i.eventAggregator,this.skeletonView=i.skeletonView,this._boardSettingsService=i.modelSettings.listSettings.boardSettingsService,this._apiService=i.modelSettings.listSettings.apiService,this._configurator=i.configurator,this.dndOptions=i.behaviorsSettings.dndOptions||{},this._treeRootModel=i.treeRootModel,this._dndEventNamespace=t.uniqueId(this._eventNamespace)},attach:function(){i(this._configurator.getWindow()).on("keydown"+this._dndEventNamespace,this._trackShiftKeyState.bind(this)).on("keyup"+this._dndEventNamespace,this._trackShiftKeyState.bind(this)),this._eventAggregator.treeRendered.once(this._onInitialTreeRendered,this),this._boardSettingsService.get(this._fields).then(function(t){this._setPrioritization(t.prioritization)}.bind(this)),this._boardSettingsService.bind({fields:this._fields,listener:this,callback:function(t){this._setPrioritization(t.prioritization)}.bind(this)})},_onInitialTreeRendered:function(){t.each(this.skeletonView.getAllTreeViews(),this._onTreeViewCreated,this),this.skeletonView.treeViewCreated.add(this._onTreeViewCreated,this)},_setPrioritization:function(i){i=t.defaults({},i,{mode:"enabled"}),this.dndOptions.prioritization!==i.mode&&(this.dndOptions.prioritization=i.mode,this.setDndOptions())},_trackShiftKeyState:function(t){this.dndOptions.shiftKey!==t.shiftKey&&(this.dndOptions.shiftKey=t.shiftKey,this.setDndOptions())},setDndOptions:function(){this.skeletonView.$el.toggleClass("tau-list-prioritization-enabled","enabled"===this.dndOptions.prioritization).toggleClass("tau-list-prioritization-shiftDown","shift"===this.dndOptions.prioritization&&!!this.dndOptions.shiftKey),this.setDndOptionsForView(this.skeletonView._rootView)
},setDndOptionsForView:function(i){i&&(i.dndView&&i.dndView.setDndOptions(this.dndOptions),t.each(i.subViews,this.setDndOptionsForView,this))},_onTreeViewCreated:function(t){t.dndView=new o(t,this)},applyDndMove:function(i){var e=!t.isEqual(i.fromPath,i.toPath),n=e?this._moveAndPrioritizeBatch:this._prioritizeBatch;return n.call(this,i).done(function(t){this._trackDnd(i,e),this._applyDndChanges(i,t.data)}.bind(this))},_prioritizeBatch:function(t){var i=this._toCommonApiParameters(t);return i.path=t.fromPath,this._apiService.treeViewPrioritizeBatch({$set:{items:[i]}})},_moveAndPrioritizeBatch:function(t){var i=this._toCommonApiParameters(t);return i.fromPath=t.fromPath,this._apiService.treeViewMoveAndPrioritizeBatch({$set:{toPath:t.toPath,items:[i]}})},_toCommonApiParameters:function(t){return{itemId:t.item.data("id"),afterItemId:t.itemAfter.data("id"),beforeItemId:t.itemBefore.data("id")}},_trackDnd:function(i,e){taus.track({action:e?"drag and drop(move and prioritize)":"drag and drop(prioritize)",cardTypes:t.map(i.treeModel.hierarchyMetaInfo.cardTypes,function(t){return t.typeName}),tags:["newlist"]})},_applyDndChanges:function(i,e){t.each(e,function(e){var n=this._treeRootModel.hierarchy.findAllDescendantNodesByCardIdAndType(e.dataItem.id,e.dataItem.type),o=t.map(n,function(t){return t.parent.hierarchy.getPath()}),r=!t.isEqual(e.path,i.fromPath),a=t.reduce(o,function(n,o){var s=r&&t.find(n,function(i){return t.isEqual(i.path,o)});return s||n.push({dataItem:e.dataItem,path:t.isEqual(o,i.fromPath)?e.path:o}),n},[]),d=this._treeRootModel.hierarchy.findNodeByPath(e.path);d.applyCardsChanges(s.regular,n,{data:a})},this)},destroy:function(){i(this._configurator.getWindow()).off(this._dndEventNamespace),this._boardSettingsService.unbind({listener:this})}})});