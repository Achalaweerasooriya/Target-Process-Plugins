define(["Underscore","tau/core/class"],function(i,e){return e.extend({init:function(i,e,s,t){this._finishedEvent=s.finishedEvent,this._savingEvent=s.savingEvent,this._savedEvent=s.savedEvent,this._saveFailedEvent=s.saveFailedEvent,this._$bubbled=i,this._editorBus=e,this._events=t,this._shouldFinishOnFirstSave=this._finishedEvent===this._savedEvent},start:function(){var i=this._editorBus,e={isFinished:!1,isSaving:!1,isCleanedUp:!1};this._savedEvent?this._savingEvent?(i.on(this._savingEvent,this._onSaving.bind(this,e),this),i.on(this._savedEvent,this._onSaved.bind(this,e),this),i.on(this._saveFailedEvent,this._onSaveFailed.bind(this,e),this)):(console.warn('"savedEvent" was specified without the matching "savingEvent". This will probably cause card update issues when bubble is closed while saving is in progress'),i.on(this._savedEvent,function(){this._onSaving(e),this._onSaved(e)}.bind(this),this),i.on(this._saveFailedEvent,function(){this._onSaving(e),this._onSaveFailed(e)}.bind(this),this)):(this._saveFailedEvent&&console.error('"saveFailedEvent" was specified without matching "savedEvent"'),this._savingEvent&&console.error('"savingEvent" was specified without matching "savedEvent"')),this._finishedEvent&&i.once(this._finishedEvent,this.onFinished.bind(this,e),this),i.once("destroy",this.onFinished.bind(this,e),this),this._$bubbled.one("taububblehide.adapterDefault",function(){this.onFinished(e)}.bind(this))},onFinished:function(i){i.isFinished||(i.isFinished=!0,this._events.editFinished.fire());var e=!i.isCleanedUp&&i.isFinished&&!i.isSaving;e&&(i.isCleanedUp=!0,this._editorBus.removeAllListeners(this),this._$bubbled.off(".adapterDefault"),this._tryDestroyBubble(this._$bubbled),this._events.cleanedUp.fire())},_onSaving:function(i){i.isSaving=!0,this._events.editorSaving.fire(),this._shouldFinishOnFirstSave&&this._$bubbled.tauBubble("hide")},_onSaved:function(i){i.isSaving=!1,this._events.editorSaved.fire(),(this._shouldFinishOnFirstSave||i.isFinished)&&this.onFinished(i)
},_onSaveFailed:function(i){this._onSaved(i)},_tryDestroyBubble:function(i){i&&i.data("ui-tauBubble")&&i.tauBubble("destroy")}})});