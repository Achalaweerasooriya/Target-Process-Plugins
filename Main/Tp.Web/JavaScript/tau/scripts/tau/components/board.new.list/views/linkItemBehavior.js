define(["require","Underscore","jQuery","tau/components/board.new.list/models/node.modification.strategies","tau/core/class"],function(e){var t=e("Underscore"),i=e("jQuery"),r=e("tau/components/board.new.list/models/node.modification.strategies"),n=e("tau/core/class");return n.extend({lookupTriggerHTML:'<button class="tau-btn tau-search"></button>',lookupTriggerComponentName:"entity.new.list.lookup.trigger",lookupTriggerPlaceHolder:".i-role-list-controls",init:function(e){this._skeletonView=e.skeletonView,this._configurator=e.configurator,this._bus=e.componentBus,this._entity=e.behaviorsSettings.entity,this._$trigger=i(this.lookupTriggerHTML),this._sliceService=e.modelSettings.listSettings.apiService,this._treeRootModel=e.treeRootModel},attach:function(){t.each(this._skeletonView.getAllTreeViews(),this._onTreeViewCreated,this),this._skeletonView.treeViewCreated.on(this._onTreeViewCreated,this)},_onTreeViewCreated:function(e){var t=this._createLookupTrigger(e);e.treeRendered.once(this._insertLookupTrigger.bind(this,t,e,this._$trigger.clone()))},_createLookupTrigger:function(e){return this._configurator.getComponentBuilder().createAsChild({type:this.lookupTriggerComponentName},this._bus).done(this._initLookupTrigger.bind(this,e))},_initLookupTrigger:function(e,i){var r=e.treeModel,n=r.hierarchy.getAllParentCards(),o=t.last(n);i.fire("initialize",{context:{configurator:this._configurator},entity:this._entity,entityTypes:t.pluck(r.getCardTypes(),"typeName"),immediateParentId:o?o.getId():this._entity.id,allParentCards:n,treeCardPath:r.hierarchy.getPath()})},_insertLookupTrigger:function(e,t,i){e.done(function(e){i.prependTo(t.$el.find(this.lookupTriggerPlaceHolder)),e.fire("afterRender",{element:i}),e.on("link.entity",this._linkEntity.bind(this))}.bind(this))},_linkEntity:function(e,t){this._sliceService.treeViewAssign({$set:{path:t.path,assignEntityId:t.entityId}}).then(this._assignCard.bind(this,t.entityId,t.lookupBus),this._handleError.bind(this))},_handleError:function(e){this._bus.fire("error",e.data.responseText&&e.data.responseText.Message||e.data.statusText)
},_assignCard:function(e,t,i){this._treeRootModel.applyCardsChanges(r.regular,null,i),t.fire("remove.entity.item",{entityId:e})},destroy:function(){this._skeletonView.treeViewCreated.remove(this)}})});