define(["Underscore","tau/core/class","./card.prioritizer"],function(r,d,n){var i=d.extend({increaseCardCount:function(r,d){r.countsModel.increaseCount(d.type)},addCardForNewEntity:function(r,d){var n=r.hierarchy.findChildByCardId(d.id);return n?!1:(this._addCardInternal(r.nodes,d,!0),!0)},addCardForExistingEntity:function(r,d){return this.addCardForNewEntity(r,d)},_addCardInternal:function(r,d,n){var i=r.createChildNode(d),e=r.items,a="head"===r.options.addStrategy?e.unshift.bind(e):e.push.bind(e);a(i),n&&r.sortCards(),r.cardAdded.fire({nodeModel:i,card:i.card,index:r.findCardIndex(i.card)})},updateCard:function(r,d){var n=r.hierarchy.findChildByCardId(d.id);if(!n)return void this.addCardForExistingEntity(r,d);var i=r.nodes,e=i.createCard(d),a=this._isOnPage(i,e),t=i.isPrioritizable,o=t&&a;n.card?a||!t?i.updateCardWith(e,n.card,o):i.removeCardFromView(n.card):o&&this._addCardInternal(i,e,!0)},_isOnPage:function(d,i){if("Rank"!=d.ordering.name)return!0;var e=r.chain(d.items).filter(function(r){return!r.hasNoValueCard()&&r.card.id!==i.id}).map(function(r){return r.card.orderingValue}).value(),a="asc"==d.ordering.direction.toLowerCase();return n.isCardOnPage(i.orderingValue,e,a,d.pagingModel)}}),e=i.extend({addCardForNewEntity:function(r,d){var n=!r.nodes;if(n)return this.increaseCardCount(r,d),!1;var i=r.hierarchy.findChildByCardId(d.id);if(i)return!1;var e=this._isOnPage(r.nodes,d);return e?(this._addCardInternal(r.nodes,d,r.nodes.isPrioritizable),!0):(this.increaseCardCount(r,d),!1)},addCardForExistingEntity:function(r,d){var n=!r.nodes;if(n)return this.increaseCardCount(r,d),!1;var i=r.hierarchy.findChildByCardId(d.id);if(i)return!1;var e=this._isOnPageForAddingExisting(r.nodes,d);return e?(this._addCardInternal(r.nodes,d,r.nodes.isPrioritizable),!0):!1},_isOnPageForAddingExisting:function(r,d){return"Rank"!==r.ordering.name&&0===r.level?!1:this._isOnPage(r,d)}});return{regular:new i,comet:new e}});