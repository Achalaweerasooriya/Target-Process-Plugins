define(["Underscore","tau/core/class","./card.prioritizer"],function(r,n,e){var d=n.extend({increaseCardCount:function(r,n){r.countsModel.increaseCount(n.type)},addCardForNewEntity:function(r,n){var e=r.hierarchy.findChildByCardId(n.id);return e?!1:(this._addCardInternal(r.nodes,n,!0),!0)},addCardForExistingEntity:function(r,n){return this.addCardForNewEntity(r,n)},_addCardInternal:function(r,n,e){var d=r.createChildNode(n);r.items.push(d),e&&r.sortCards(),r.cardAdded.fire({nodeModel:d,card:d.card,index:r.findCardIndex(d.card)})},updateCard:function(r,n,e){var d=r.createCard(e),i=n.card,a=!!i,t=this._isOnPage(r,d),o=r.isPrioritizable,s=o&&t;a?t||!o?r.updateCardWith(d,i,s):r.removeCardFromView(i):s&&this._addCardInternal(r,d,!0)},_isOnPage:function(n,d){if("Rank"!=n.ordering.name)return!0;var i=r.chain(n.items).filter(function(r){return!r.hasNoValueCard()&&r.card.id!==d.id}).map(function(r){return r.card.orderingValue}).value(),a="asc"==n.ordering.direction.toLowerCase();return e.isCardOnPage(d.orderingValue,i,a,n.pagingModel)}}),i=d.extend({addCardForNewEntity:function(r,n){var e=!r.nodes;if(e)return this.increaseCardCount(r,n),!1;var d=r.hierarchy.findChildByCardId(n.id);if(d)return!1;var i=this._isOnPage(r.nodes,n);return i?(this._addCardInternal(r.nodes,n,r.nodes.isPrioritizable),!0):(this.increaseCardCount(r,n),!1)},addCardForExistingEntity:function(r,n){var e=!r.nodes;if(e)return this.increaseCardCount(r,n),!1;var d=r.hierarchy.findChildByCardId(n.id);if(d)return!1;var i=this._isOnPageForAddingExisting(r.nodes,n);return i?(this._addCardInternal(r.nodes,n,r.nodes.isPrioritizable),!0):!1},_isOnPageForAddingExisting:function(r,n){return"Rank"!==r.ordering.name&&0===r.level?!1:this._isOnPage(r,n)}});return{regular:new d,comet:new i}});