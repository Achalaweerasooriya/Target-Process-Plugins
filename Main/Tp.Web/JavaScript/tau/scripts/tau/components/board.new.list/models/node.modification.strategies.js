define(["Underscore","tau/core/class","./card.prioritizer"],function(r,e,d){var n=e.extend({addCard:function(r,e){var d=r.hierarchy.findChildByCardId(e.id);return d?!1:(this._addCardInternal(r.nodes,e,!0),!0)},_addCardInternal:function(r,e,d){var n=r.createChildNode(e);r.items.push(n),d&&r.sortCards(),r.cardAdded.fire({nodeModel:n,card:n.card,index:r.findCardIndex(n.card)})},updateCard:function(r,e,d){var n=r.createCard(d),a=e.card,i=!!a,t=this._isOnPage(r,n),o=r.isPrioritizable,s=o&&t;i?t||!o?r.updateCardWith(n,a,s):r.removeCardFromView(a):s&&this._addCardInternal(r,n,!0)},_isOnPage:function(e,n){if("Rank"!=e.ordering.name)return!0;var a=r.chain(e.items).filter(function(r){return!r.hasNoValueCard()&&r.card.id!==n.id}).map(function(r){return r.card.orderingValue}).value(),i="asc"==e.ordering.direction.toLowerCase();return d.isCardOnPage(n.orderingValue,a,i,e.pagingModel)}}),a=n.extend({addCard:function(r,e){var d=!r.nodes;if(d)return this._increaseCount(r,e),!1;var n=r.hierarchy.findChildByCardId(e.id);if(n)return!1;var a=this._isOnPage(r.nodes,e);return a?(this._addCardInternal(r.nodes,e,r.nodes.isPrioritizable),!0):(this._increaseCount(r,e),!1)},_increaseCount:function(r,e){r.countsModel.increaseCount(e.type)}});return{regular:new n,comet:new a}});