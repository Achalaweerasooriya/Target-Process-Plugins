define(["Underscore","tau/core/class","./card.prioritizer"],function(r,e,n){var a=e.extend({addCard:function(r,e){var n=r.hierarchy.findChildByCardId(e.id);return n?!1:(this._addCardInternal(r.nodes,e,!0),!0)},_addCardInternal:function(r,e,n){var a=r.createChildNode(e);r.items.push(a),n&&r.sortCards(),r.cardAdded.fire({nodeModel:a,card:a.card,index:r.findCardIndex(a.card)})},updateCard:function(r,e,n){var a=r.createCard(n),d=e.card,i=!!d,t=this._isOnPage(r,a.orderingValue),o=r.isPrioritizable,s=o&&t;i?t||!o?r.updateCardWith(a,d,s):r.removeCardFromView(d):s&&this._addCardInternal(r,a,!0)},_isOnPage:function(e,a){if("Rank"!=e.ordering.name)return!0;var d=r.chain(e.items).filter(function(r){return!r.hasNoValueCard()}).map(function(r){return r.card.orderingValue}).value(),i="asc"==e.ordering.direction.toLowerCase();return n.isCardOnPage(a,d,i,e.pagingModel)}}),d=a.extend({addCard:function(r,e){var n=!r.nodes;if(n)return this._increaseCount(r,e),!1;var a=r.hierarchy.findChildByCardId(e.id);if(a)return!1;var d=this._isOnPage(r.nodes,e.orderingValue);return d?(this._addCardInternal(r.nodes,e,r.nodes.isPrioritizable),!0):(this._increaseCount(r,e),!1)},_increaseCount:function(r,e){r.countsModel.increaseCount(e.type)}});return{regular:new a,comet:new d}});