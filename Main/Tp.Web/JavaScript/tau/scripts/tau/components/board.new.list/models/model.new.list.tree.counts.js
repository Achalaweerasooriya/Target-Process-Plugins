define(["jQuery","Underscore","tau/components/board.new.list/models/model.new.list.tree.data"],function(t,e,a){return a.extend({init:function(t,e){this._super(t,e),this.data=this._getInitialDataValue(),this.treeModel.nodeCollectionCreated.add(this._onNodeCollectionCreated.bind(this))},_getInitialDataValue:function(){return{types:[]}},_onNodeCollectionCreated:function(t){var e=t.nodes;e.cardAdded.add(function(t){this._onCardAdded(t.card)},this),e.cardDeleted.add(function(t){this._onCardDeleted(t.card)},this)},_loadData:function(t){return this.slice.treeViewCounts(t)},getExpansionStateForLoadData:function(){return this.treeModel.getNodesPaths()},_bindData:function(t){this._resetCounts(),t.dataItem.dataItem.data&&e.each(t.dataItem.dataItem.data.types,function(t){var e=this._getTypeCount(t.type);e&&(e.count=t.count)},this),this.dataLoaded.fire(),e.each(t.nodes.items,function(t){var e=this.treeModel.hierarchy.findChildByCardId(t.dataItem.nodeId);e&&this._getDataModelFromNodeModel(e)&&this._getDataModelFromNodeModel(e)._bindData(t)},this)},_initializeCountsIfRequired:function(){this.data.types.length||(this.data.types=e.map(this.treeModel.hierarchyMetaInfo.cardTypes,function(t){return{type:t.valueType,typeName:t.typeName,count:0}}))},_resetCounts:function(){this.data=this._getInitialDataValue(),this._initializeCountsIfRequired()},_onCardAdded:function(t){this.increaseCount(t.type)},increaseCount:function(t){this._initializeCountsIfRequired();var e=this._getTypeCount(t);e&&(e.count+=1),this.dataLoaded.fire()},_onCardDeleted:function(t){var e=this._getTypeCount(t.type);e&&(e.count-=1),this.dataLoaded.fire()},_getTypeCount:function(t){return e.find(this.data.types,function(e){return e.type.toLowerCase()===t.toLowerCase()})},getAllCount:function(){var t=0;return e.each(this.data.types,function(e){t+=e.count}),t},getPagesCount:function(){return Math.ceil(this.getAllCount()/this.treeModel.pagingModel.getTake())},_getDataModelFromNodeModel:function(t){return t.countsModel},collapse:function(){this.data=this._getInitialDataValue()}})});