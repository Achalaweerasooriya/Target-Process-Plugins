define(["require","tau/core/extension.base","Underscore"],function(e){var t=e("tau/core/extension.base"),s=e("Underscore"),r=function(e,t){return t.map(function(t){var s=e.getColorEncodingService().mapColorClassToColor(t.value);return t.value=s?s.className:t.value,t})},i=function(e){return e.map(function(e){return e.UUID||(e.UUID=s.UUID()),e})};return t.extend({init:function(e){this._super(e),this._rules=[]},"bus configurator.ready:last + boardSettings.ready + afterRender":function(e,t,u){this._getDefaultRule=function(){var e=s.last(this._rules)||{value:""};return{filter:"",value:t.getColorEncodingService().generateNextClassName(e.value)}},u.boardSettings.get({fields:["ownerIds","colorSettings"]}).then(function(e){this._rules=s.clone(e.colorSettings&&e.colorSettings.customEncoding)||[],0===this._rules.length&&this._rules.push(this._getDefaultRule()),this._rules=i(this._rules),this._rules=r(t,this._rules);var n=t.getLoggedUser();this.fire("props.ready",{model:{bus:this.bus,isEditable:Boolean(t.getBoardAccessService().isEditable(e,n)),boardSettings:u.boardSettings,configurator:t},items:this._rules})}.bind(this))},"bus boardSettings.ready:last + addNewRule":function(){this._rules.push(this._getDefaultRule()),this._rules=i(this._rules),this.fire("props.ready",{items:this._rules})},_saveRules:function(e,t){e.set({set:{colorSettings:{customEncoding:t.filter(function(e){return s.trim(e.filter)})}}})},"bus boardSettings.ready:last + removeRule":function(e,t,s){this._rules=this._rules.filter(function(e){return e.UUID!==s.UUID}),this.fire("props.ready",{items:this._rules}),this._saveRules(t.boardSettings,this._rules)},"bus boardSettings.ready:last + prioritizeRuleStop":function(e,t,s){var r=s.key,i=s.overKey,u=s.placeAfter,n=this._rules.reduce(function(e,t){return t.UUID===r?e.draggedElement=t:(e.rules.push(t),t.UUID===i&&(e.toMove=e.rules.length-(u?0:1))),e},{rules:[],draggedElement:{},toMove:-1});n.rules.splice(n.toMove,0,n.draggedElement),this._rules=n.rules,this.fire("props.ready",{items:this._rules}),this._saveRules(t.boardSettings,this._rules)
},"bus boardSettings.ready:last + saveRule":function(e,t,s){this._rules=this._rules.map(function(e){return e.UUID===s.UUID&&(e.value=s.value,e.filter=s.filter),e}),this.fire("props.ready",{items:this._rules}),this._saveRules(t.boardSettings,this._rules)}})});