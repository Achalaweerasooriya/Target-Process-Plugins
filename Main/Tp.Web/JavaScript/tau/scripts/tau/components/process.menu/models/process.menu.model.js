define(["require","tau/core/class","tau/components/setup.process/process.optionGroups","tau/components/setup.workflow/models/workflow.entitytypes","jQuery","Underscore","tau/core/termProcessor"],function(e){"use strict";var s=e("tau/core/class"),t=e("tau/components/setup.process/process.optionGroups"),i=e("tau/components/setup.workflow/models/workflow.entitytypes"),r=e("jQuery"),n=e("Underscore"),o=e("tau/core/termProcessor");return s.extend({init:function(e,s,t){this.processesChanged=n.Callbacks(),this.activePageChanged=n.Callbacks(),this._processService=e,this._routing=s,this._urlBuilder=t,this._processes=null,this.processesChanged.add(this._initializeActiveProcess,this)},getActivePage:function(){return n.pick(this._routing.getCurrentRoute().args,"processId","optionGroupId","entityType")},setActivePage:function(e){e=n.defaults(e||{},this.getActivePage(),{optionGroupId:t.groups.Workflows});var s=n.find(this._processes,function(s){return s.id===e.processId});if(s){var i=n.pluck(s.entityTypes,"entityType");n.contains(i,e.entityType)||(e.entityType=n.first(i))}this.activePageChanged.fire(e);var r=t.create(this._urlBuilder,e.optionGroupId,e.processId);this._routing.redirect(r.getTp3Url(e.entityType))},_initializeActiveProcess:function(e){var s=n.pluck(e,"id"),t=n.contains(s,this.getActivePage().processId);n.size(e)&&!t&&this.setActivePage({processId:n.first(s)})},refresh:function(){return this._processService.getProcesses().then(function(e){this._processes=n.map(e,function(e){var s=new o(e.terms),t=n.chain(i).filter(function(s){return n.contains(e.practices,s.practice)}).pluck("id").map(function(e){return{entityType:e,terms:n.pick(s.getTerms(e),"name","iconSmall")}}).value();return n.extend(n.pick(e,["id","name","projects","isDefault"]),{entityTypes:t})},this),this.processesChanged.fire(this._processes)}.bind(this))},renameProcess:function(e,s){this._processes=n.map(this._processes,function(t){return t.id===e&&(t.name=s),t}),this.processesChanged.fire(this._processes),this._processService.updateProcess(e,{name:s}).fail(function(){this.refresh()
}.bind(this))},cloneProcess:function(e){return this._processService.cloneProcess(e.id).then(function(e){return r.when(e.Id,this.refresh())}.bind(this))},deleteProcess:function(e){this._processService.deleteProcess(e.id).then(function(e){e&&(this._processes=n.filter(this._processes,function(s){return s.id!==e}),this.processesChanged.fire(this._processes))}.bind(this),this.refresh.bind(this))},destroy:function(){this.processesChanged.removeAll(),this.activePageChanged.removeAll()}})});