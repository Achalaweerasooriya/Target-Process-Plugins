define(["require","tau/core/class","tau/components/setup.process/process.optionGroups","jQuery","Underscore","tau/core/termProcessor","./workflow.entitytypes.order","tau/utils/utils.text"],function(e){"use strict";var s=e("tau/core/class"),t=e("tau/components/setup.process/process.optionGroups"),i=e("jQuery"),r=e("Underscore"),n=e("tau/core/termProcessor"),c=e("./workflow.entitytypes.order"),o=e("tau/utils/utils.text");return s.extend({init:function(e,s,t){this._processService=e,this._routing=s,this._initialActivePage=t,this.processesChanged=r.Callbacks(),this.activePageChanged=r.Callbacks(),this.updateProgress=r.Callbacks(),this._processes=null,this.processesChanged.add(this._initializeActiveProcess,this)},getActivePage:function(){return r.pick(this._routing.getCurrentRoute().args,"processId","optionGroupId","entityType")},_getVisibleProcesses:function(){return r.where(this._processes,{isVisible:!0})},setActivePage:function(e){e=r.defaults(e||{},this.getActivePage(),{optionGroupId:t.groups.Workflows});var s=r.findWhere(this._getVisibleProcesses(this._processes),{id:e.processId})||r.first(this._getVisibleProcesses(this._processes));if(s){e.processId=s.id;var i=r.pluck(s.entityTypes,"entityType");if(e.entityTypes){var n=r.intersection(e.entityTypes,i);e.entityTypes=null,e.entityType=n.length>0?n[0]:null}r.contains(i,e.entityType)||(e.entityType=r.first(i))}this.activePageChanged.fire(e)},_initializeActiveProcess:function(e){var s=r.pluck(this._getVisibleProcesses(e),"id"),t=r.contains(s,this.getActivePage().processId);r.size(e)&&!t&&(this._initialActivePage?(this.setActivePage(this._initialActivePage),this._initialActivePage=null):this.setActivePage({processId:r.first(s)}))},refresh:function(){return i.when(this._processService.getProcesses(),this._processService.getWorkflowEntityTypes()).then(function(e,s){this._processes=r.map(e,function(e){var t=new n(e.terms),i=r.chain(s).filter(function(s){return r.contains(e.practices,s.practice)}).sortBy(function(e){return r.indexOf(c,e.type)
}).map(function(e){return{entityType:e.type,terms:r.pick(t.getTerms(e.type),"name","iconSmall")}}).value();return r.extend(r.pick(e,["id","name","projects","isDefault","isVisible"]),{entityTypes:i})},this),this.processesChanged.fire(this._processes),this._fireUpdated()}.bind(this))},_buildNewProcess:function(){return i.when(this._processService.getWorkflowEntityTypes(),this._processService.getAllPractices(),this._processService.getRole("Developer")).then(function(e,s,t){return{name:o.getUniqueName("New process",r.pluck(this._processes,"name")),workflows:r.map(e,function(e){return{name:"Project workflow",entityType:{id:e.id},entityStates:this._setNumericPriorities([{name:"Open",isInitial:!0},{name:"In Progress",role:t},{name:"Done",isFinal:!0}])}},this),practices:s}}.bind(this))},_setNumericPriorities:function(e){return r.map(e,function(e,s){return e.numericPriority=s,e})},createProcess:function(){return this._fireUpdating(),this._buildNewProcess().then(this._processService.saveProcess.bind(this._processService)).fail(this.refresh.bind(this)).then(function(e){return this.refresh().then(r.constant(e))}.bind(this))},renameProcess:function(e,s){var t=r.findWhere(this._processes,{id:e});t.name=s,this.processesChanged.fire(this._processes),this._processService.updateProcess(e,{name:s}).fail(this.refresh.bind(this))},cloneProcess:function(e){return this._fireUpdating(),this._processService.cloneProcess(e.id).then(function(e){return this.refresh().then(r.constant(e))}.bind(this),this.refresh.bind(this))},deleteProcess:function(e){this._fireUpdating(),this._processService.deleteProcess(e.id).always(this.refresh.bind(this))},destroy:function(){this.processesChanged.removeAll(),this.activePageChanged.removeAll()},_fireUpdating:function(){this.updateProgress.fire({isUpdating:!0})},_fireUpdated:function(){this.updateProgress.fire({isUpdating:!1})}})});