define(["require","tau/core/class","Underscore","./filter.builder.field.model","./filter.builder.field.definition.container"],function(e){var i=e("tau/core/class"),t=e("Underscore"),n=e("./filter.builder.field.model"),l=e("./filter.builder.field.definition.container"),d=i.extend({init:function(e,i,n){this._dataContext=e,this._fieldContainer=new l(i),this._defaultFieldStrategy=n,this.builderValueChanged=t.Callbacks(),this._fields=this._useDefaultFieldsIfPossible(this._constructFields(this._dataContext.getCurrentValue())),this._dataContext.valueChanged.add(this._onBuilderValueChangedExternal,this)},addField:function(e){var i=this._fieldContainer.findFieldDefinition(e);if(!i)return void console.error('Field "'+e+'" not found.');var t=i.getDefaultValue?[i.getDefaultValue()]:[],n=this._createFieldModel(t,i);return this._fields.push(n),this._notifyChanged(),n},getFieldModels:function(){return t.toArray(this._fields)},getAvailableNewFields:function(){return this._fieldContainer.getAllFieldDefinitionsExcept(t.pluck(this._fields,"fieldName"))},clearAllFields:function(){this.builderValueChanged.buffer(function(){t.each(this._fields,function(e){e.removeAllFilters()})},this)},_useDefaultFieldsIfPossible:function(e){return!this._defaultFieldStrategy||e.length?e:t.map(this._defaultFieldStrategy(this._fieldContainer),function(e){return this._createFieldModel([],e)},this)},_constructFields:function(e){return t.reduce(e.items,function(e,i){var t=this._fieldContainer.findFieldDefinition(i.fieldName);return t&&e.push(this._createFieldModel(i.items,t)),e},[],this)},_createFieldModel:function(e,i){return new n({filterValues:e,fieldDefinition:i,onChanged:this._notifyChanged.bind(this),deleteField:this._removeField.bind(this)})},_onBuilderValueChangedExternal:function(){},_getCurrentValue:function(){return{items:t.map(this._fields,function(e){return{fieldName:e.fieldName,fieldDefinition:e.fieldDefinition,items:t.map(e.getFilterModels(),function(e){return e.getCurrentValue()})}})}},_removeField:function(e){this._fields=t.without(this._fields,e),this._notifyChanged()
},_notifyChanged:function(){this._dataContext.setNewValue(this._getCurrentValue()),this.builderValueChanged.fire(this)},destroy:function(){this._dataContext.valueChanged.remove(this)}});return d});