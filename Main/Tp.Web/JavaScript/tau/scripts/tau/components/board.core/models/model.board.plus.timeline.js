define(["require","Underscore","jQuery","tau/components/board.core/models/model.board.plus.grid","tau/utils/timeline/utils.timeline.date-range","tau/slice/timeline.factory","tau/utils/timeline/utils.timeline.local-period-calculator"],function(e){var t=e("Underscore"),n=e("jQuery"),i=e("tau/components/board.core/models/model.board.plus.grid"),a=e("tau/utils/timeline/utils.timeline.date-range"),l=e("tau/slice/timeline.factory"),o=e("tau/utils/timeline/utils.timeline.local-period-calculator"),r=i.extend({init:function(e){this.timelineRangeModel=e,this.onTimelineError=t.Callbacks(),this.onTimelineLocalDateRangeChanged=t.Callbacks(),this.onTimelineGlobalDateRangeChanged=t.Callbacks(),this.localRangeCalculator=new o,this._super(e)},setDateRange:function(e){this.timelineRangeModel.setDateRange(e)},startLifeCycle:function(e,t){this._queryDeferred=n.Deferred(),this._super(e,t)},getViewMode:function(){return"timeline"},getSliceFactory:function(){var e=this.getConfigurator().getSliceFactoryOptions();return new l(e)},createDefinition:function(){var e=this._super(),t=this._boardConfig.timelineGlobalDateRange;return e.timelineGlobalDateRange=t,e.user.globalDateRange=a.tryParseWithRoundedDays(t).toJSON(),e.user.plannedInPast=this._boardConfig.timelineSettings.showPlannedInPast,e.user.showForecast=this._boardConfig.timelineSettings.showForecast,e},updateBoardSettings:function(e){this._super(e),e.bind({fields:["timelineLocalDateRange"],listener:this,callback:this._onTimelineLocalDateRangeChanged.bind(this)}),e.bind({fields:["timelineGlobalDateRange"],listener:this,callback:this._onTimelineGlobalDateRangeChanged.bind(this)})},_boardConfigReady:function(e,t){this._super(e,t),this._onTimelineGlobalDateRangeChanged(t),this._onTimelineLocalDateRangeChanged(t)},_getDefaultTimelineLocaDateRange:function(e){return this.localRangeCalculator.setLocalDateRangeCloseToNow(e)},_onTimelineLocalDateRangeChanged:function(e){var t=a.tryParse(e.timelineLocalDateRange);if(!t.isValid){var n=a.tryParseWithRoundedDays(e.timelineGlobalDateRange);if(!n.isValid)return;t=this._getDefaultTimelineLocaDateRange(n),e.timelineLocalDateRange=t.toFullISOString(),this.setTimelineLocalDateRange(t)}this.timelineRangeModel.setDateRange(t),this.onTimelineLocalDateRangeChanged.fire(t)},_onTimelineGlobalDateRangeChanged:function(e){var t=a.tryParseWithRoundedDays(e.timelineGlobalDateRange);this.onTimelineGlobalDateRangeChanged.fire(t)},setQuery:function(e){this._queryDeferred.resolve(e)},queryCells:function(e){return this._getSliceDeferred.then(function(t){return t().cell(e)})},queryDensity:function(e){var i={$set:{BucketsCount:e}};return n.when(this._getSliceDeferred,this._queryDeferred).then(function(e,n){return e().density(t.extend(i,n))}.bind(this))},movePlannedDates:function(e){var i={itemId:e.id,position:{plannedStartDate:e.plannedStartDate?e.plannedStartDate:null,plannedEndDate:e.plannedEndDate?e.plannedEndDate:null}},a={$set:{items:[i]}};return n.when(this._getSliceDeferred).then(function(n){return n().movePlannedDatesBatch(a).fail(e.onError.bind(e)).done(function(n){var i=t.find(n.data.items[0].items,function(t){return t.dataItem.id==e.id});t.extend(e,i.dataItem),e.onSuccess()})})},setTimelineLocalDateRange:function(e){this.getBoardSettings().set({set:{timelineLocalDateRange:e.toFullISOString()}})},requestMarks:function(e,n,i){var a=t.clone(n);return n.focus.x=[],this._super(e,a,i)},_forceUpdateSliceOnZoomLevelChanged:function(){}});return r});