define(["Underscore","jQuery","tau/components/board.core/models/model.board.core","tau/models/board.plus/model.board.slice.extender","tau/services/customize/service.customize.card.layout.factory","tau/models/board.customize.units/const.card.sizes","tau/libs/boardSettings/board.settings.to.definition.translator"],function(e,i,t,o,n,a,s){return t.extend({init:function(){this._super.apply(this,arguments),this.onZoomLevelChanged=e.Callbacks(),this.onPageChanged=e.Callbacks(),this.onSliceInfoRetrieved=e.Callbacks(),this.onBoardPagingSettingsRetrieved=e.Callbacks(),this.onAcidReady=e.Callbacks(),this.onBoardConfigurationReady=e.Callbacks(),this.onViewModeReady=e.Callbacks(),this.onDefinitionReady=e.Callbacks(),this.onPageReady=e.Callbacks(),this.onSliceReady=e.Callbacks(),this.onCardLayoutFactoryReady=e.Callbacks(),this.onBoardDefinitionReady=e.Callbacks(),this.onCacheInvalidated=e.Callbacks(),this._getSliceDeferred=i.Deferred()},_zoomToSize:function(e){var i=a.zoomToSize(e.zoomLevel);return i||1!==e.zoomLevel||(i="min"),i},startLifeCycle:function(e,t){this.updateBoardSettings(t),this._layoutFactory=new n(e,this.getBoardSettings()),this._configurator=e,this.onCardLayoutFactoryReady.fire(this._layoutFactory);var o=i.Deferred();e.getAppStateStore().get({fields:["acid"],callback:function(e){this.onAcidReady.fire(e.acid),o.resolve(e.acid)}.bind(this)});var a=i.Deferred();this.getBoardSettings().get({fields:["x","y","cells","zoomLevel","viewMode","page","focus","selectedMarks","cardSettings","user","acid","timelineLocalDateRange","timelineGlobalDateRange","timelineSettings","colorSettings"]}).then(function(e){this.onBoardConfigurationReady.fire(e),this.onViewModeReady.fire(e.viewMode),a.resolve(e)}.bind(this)),i.when(o,a).then(this._boardConfigReady.bind(this))},_boardConfigReady:function(i,t){this._acid=i,this._boardConfig=t,this._updateSlice(),this.onZoomLevelChanged.fire(e.pick(t,"zoomLevel"))},_updateSlice:function(i){this.abortCurrentSlice();var t=this._updateDefinition(i),n={definition:e.deepClone(t)};
n.definition.global={acid:this._acid},this._sliceData={slice:this.getSliceFactory().create(n)};var a=new o;a.extend(this._sliceData,this._layoutFactory).done(function(e){this._sliceData=e,this.onSliceReady.fire(e)}.bind(this)),this._getSliceDeferred.resolve(function(){return this._sliceData.slice}.bind(this))},getSliceFactory:function(){return this.getConfigurator().getSliceFactory()},getConfigurator:function(){return this._configurator},_updateDefinition:function(i){var t=this.createDefinition();return this.onDefinitionReady.fire(t),this.onPageReady.fire(e.deepClone(t.page)),this.onBoardDefinitionReady.fire(t,this._boardConfig),i&&i.zoomLevel&&(t.zoomLevel=i.zoomLevel),t},createDefinition:function(){return s.prototype.createDefinition(this._boardConfig)},unbindBoardSettings:function(){this.getBoardSettings()&&this.getBoardSettings().unbind({listener:this})},abortCurrentSlice:function(){this._sliceData&&e.each(this._sliceData,function(e){e.abort()})},getBoardSettings:function(){return this._boardSettings},updateBoardSettings:function(e){this.unbindBoardSettings(),this._boardSettings=e,this._boardSettings.bind({fields:["zoomLevel"],listener:this,callback:this._onZoomLevelChanged.bind(this)}),this._boardSettings.bind({fields:["page"],listener:this,callback:this.onPageChanged.fire.bind(this.onPageChanged)})},onGetSliceInfo:function(){},_onZoomLevelChanged:function(i){i.name||(this.onZoomLevelChanged.fire(e.pick(i,"zoomLevel")),this._boardConfig&&this._forceUpdateSliceOnZoomLevelChanged())},_forceUpdateSliceOnZoomLevelChanged:function(){this._updateSlice()}})});