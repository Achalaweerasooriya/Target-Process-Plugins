define(["Underscore","jQuery","tau/core/class","tau/components/board.timeline/models/cell/model.cell.timeline","tau/components/board.timeline/models/cell/model.cell.board"],function(e,n,t,i,r){return t.extend({init:function(e){this.timelineRangeModel=e,this.clear()},setDefinition:function(e){this.definition=e},_getSliceItemDeferred:function(t,i,r){var a=e.find(t,function(e){return e.x===i.x&&e.y===i.y});if(a&&r){var l=t.indexOf(a);t.splice(l,1),a=null}return a||(a={x:i.x,y:i.y,value:n.Deferred()},t.push(a)),a},_getCellDeferred:function(e,n){return this._getSliceItemDeferred(this.cellDeferreds,e,n)},registerCell:function(n,t,a){var l=this._getCellDeferred(t,!0),o=e.find(n.fixed.items,function(e){return"timeline"===e.type}),d=o?new i(this.definition,n,this.timelineRangeModel,a):new r(this.definition,n,a);return l.value.resolve(d),d},clear:function(){this.cellDeferreds=[]},whenCellRegistered:function(e){var n=this._extractCellCoords(e);return this._getCellDeferred(n).value.promise()},broadcastCells:function(n){e.each(this.cellDeferreds,function(e){e.value.done(n)})},extendUnfinishedCardsToNow:function(){var n=function(e){e.isTimeline&&e.extendUnfinishedCardsToNow(!1)};e.each(this.cellDeferreds,function(e){e.value.done(n)})},updateCardsPositions:function(){var n=function(e){e.isTimeline&&e.updateCardsPositions()};e.each(this.cellDeferreds,function(e){e.value.done(n)})},getRelativeNowOffset:function(){return this.timelineRangeModel.getRelativeNowOffset()},addCards:function(n,t){var i=function(e,n){n.addCard(e.data,t)};e.each(n,function(n){this.whenCellRegistered(n).done(e.bind(i,null,n))},this)},removeCards:function(n,t){var i=function(e,n){n.removeCard(e,t)};e.each(n,function(n){this.broadcastCells(e.bind(i,null,n.data.id))},this)},updateCards:function(n,t){var i=function(e,n){n.clearCard(e)},r=function(e,n){n.updateCard(e.data,t)},a=e.map(n,function(n){return this.whenCellRegistered(n).done(e.bind(r,null,n)),this._extractCellCoords(n)},this);e(n).chain().map(function(e){return e.data.id}).uniq().each(function(n){this.broadcastCells(function(t){e.any(a,t.hasCoords.bind(t))||i(n,t)})}.bind(this)).value()},moveCards:function(n,t){e.each(n,function(e){this.broadcastCells(function(n){n.clearCard(e.dataItem.id)})},this),e.each(n,function(n){this.whenCellRegistered(n).then(function(i){i.updateCard(n.dataItem,e.extend(e.pick(n,"track"),t,{forceUnlock:!0}))})},this)},_extractCellCoords:function(n){return e(n).chain().pick("x","y").defaults({x:"null",y:"null"}).value()},registerLazyData:function(e){this.broadcastCells(function(n){n.augmentCards(e)})}})});