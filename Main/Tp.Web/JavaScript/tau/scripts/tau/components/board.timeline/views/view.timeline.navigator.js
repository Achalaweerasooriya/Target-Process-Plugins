define(["Underscore","jQuery","tau/core/class","tau/components/board.timeline/templates/template.timeline.navigator","tau/components/board.timeline/views/timeline.navigator.histogram","tau/components/board.timeline/views/board.timeline.view.now-marker"],function(e,t,i,n,a,r){var h=4,l=1;return i.extend({init:function(t){this._model=t,this.bucketWidth=h+l,this.onDateRangeChanged=e.Callbacks(),this._nowMarker=new r(t)},_getBucketsCount:function(){return Math.floor(this._containerBaseWidth/this.bucketWidth)},_refreshDensity:function(){return t.when(this._model.queryDensity(this._getBucketsCount())).then(this._render.bind(this))},renderTo:function(e){this._$placeholder&&this._$placeholder[0]==e[0]||(this._$placeholder=e,this._$placeholder.tauProgressIndicator(),this._containerBaseWidth=this._$placeholder.outerWidth(),this._model.globalDateRangeIsDefined()&&this._refreshDensity())},_alignRange:function(e,t,i){var n=i.position().left+i.outerWidth()-t.position().left;e.css("width",(100*n/this._$placeholder.outerWidth()).toFixed(2)+"%")},_render:function(e){var t=new a(e),i=t.gerRenderData(this._$placeholder.height());if(this._$placeholder.html(this._html(i)),i.length>0){var n=this._model.getRelativeSelectedRange(),r=Math.round(n.start*i.length),h=Math.round(n.end*i.length),l=this._$placeholder.find(".tc-item"),o=this._$placeholder.find(".tc-focus-range");this._alignRange(o,l.eq(r),l.eq(h-1)),this._$placeholder.tauSlider({grid:l,value:r,handle:o,selectionWidth:h-r,min:o.data("range-min"),max:o.data("range-max"),animate:!0,slide:function(e,t){var n=t.value,a=n+this._$placeholder.tauSlider("option","selectionWidth");this.onDateRangeChanged.fire(this._model.convertToDateRange(n/i.length,a/i.length))}.bind(this),change:function(e,t){var n=this._$placeholder.tauSlider("option","selectionWidth"),a=t.value+n-1;o.tauResizable("option",{startValue:t.value,endValue:a}),this._model.setRelativeSelectedRange(t.value/i.length,(a+1)/i.length)}.bind(this)}),o.tauResizable({gridContainment:l,handles:{e:".ui-resizable-e",w:".ui-resizable-w"},startValue:r,endValue:h-1,resize:function(e,t){this.onDateRangeChanged.fire(this._model.convertToDateRange(t.startValue/i.length,(t.endValue+1)/i.length))
}.bind(this),stop:function(e,t){this._$placeholder.tauSlider("option",{selectionWidth:t.endValue-t.startValue+1}),this._$placeholder.tauSlider("setValueWithoutEvents",t.startValue);var n=100*t.size.width/this._$placeholder.outerWidth();o.css("width",n+"%"),this._model.setRelativeSelectedRange(t.startValue/i.length,(t.endValue+1)/i.length)}.bind(this)}),this._$placeholder.find(".refresh-histogram").on("click",function(){this._$placeholder.tauSlider("destroy")}.bind(this))}this._renderNowMarker(l),this._$placeholder.find(".refresh-histogram").on("click",this._refresh.bind(this))},_refresh:function(){taus.track("action",{name:"timeline-navigator-refresh"}),this._$placeholder.tauProgressIndicator("show",{hover:!0}),this._refreshDensity().then(function(){this._$placeholder.tauProgressIndicator("hide")}.bind(this))},_html:function(e){return n.get().bind({},{buckets:e})},_getGridWidth:function(e){if(e&&e.length>0)var t=e.last(),i=t.position().left+t.outerWidth();return i},_renderNowMarker:function(e){var t=this._getGridWidth(e);this._nowMarker.render(this._$placeholder,t)},updateNowPosition:function(){if(this._$placeholder&&this._model.globalDateRangeIsDefined()){var e=this._$placeholder.find(".tc-item");if(0!==e.length){var t=this._getGridWidth(e);this._nowMarker.updatePosition(t)}}}})});