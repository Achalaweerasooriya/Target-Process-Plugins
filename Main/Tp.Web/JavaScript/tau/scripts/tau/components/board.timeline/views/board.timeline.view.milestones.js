define(["require","Underscore","jQuery","react","tau/core/class","jsx!tau/components/board.timeline/views/board.timeline.view.milestone.ruler","jsx!tau/components/board.timeline/views/board.timeline.view.milestone","tau/components/board.timeline/views/board.timeline.view.milestones.button.add"],function(e){var t=e("Underscore"),i=e("jQuery"),s=e("react"),n=e("tau/core/class"),o=e("jsx!tau/components/board.timeline/views/board.timeline.view.milestone.ruler"),l=e("jsx!tau/components/board.timeline/views/board.timeline.view.milestone"),r=e("tau/components/board.timeline/views/board.timeline.view.milestones.button.add");return n.extend({init:function(e,t){if(!e)throw new Error("timelineRangeModel is not defined");this._timelineRangeModel=e,this._milestonesModel=t,this._milestoneViews=[],this._addButtonView=new r(e,t),this._isRulerMode=!1,this._placeholder=null},render:function(e,s){this._placeholder=e,this._isRulerMode=s,i(".tau-timeline-milestone-placeholder",e).remove(),this._milestoneViews=[],this._placeholder.length&&(t.forEach(t.groupBy(this._milestonesModel.milestones,"date"),function(t){this._renderMilestonesGroup(t,s,e)}.bind(this)),s&&this._addButtonView.render(e))},updatePosition:function(){this._milestonesCountChanged()&&this._placeholder?this.render(this._placeholder,this._isRulerMode):(this._addButtonView.update(),this._milestoneViews=this._updateViewsState(),t.forEach(t.groupBy(this._milestoneViews,"date"),this._updateMilestonesGroup.bind(this)))},_milestonesCountChanged:function(){return this._milestoneViews.length!=t.size(this._milestonesModel.milestones)},_updateViewsState:function(){return t.compact(t.map(this._milestoneViews,function(e){var t=this._milestonesModel.milestones[e.item.id];if(t)return e.date=t.date,e.item=t,e;var n=e.view.getDOMNode();return s.unmountComponentAtNode(n),i(n).remove(),null},this))},_renderMilestonesGroup:function(e,n,o){t.forEach(e,function(t,l){var r=this._createProps(t,e,this._getMilestoneIndexAtDate(e,l)),d=i('<div class="tau-timeline-milestone-placeholder"></div>').prependTo(o),a=s.render(this._createViewBasedOnRenderMode(n,r),d[0]);
this._milestoneViews.push({view:a,item:t,date:t.date})}.bind(this))},_updateMilestonesGroup:function(e){t.forEach(e,function(t,i){var s=this._createProps(t.item,e,this._getMilestoneIndexAtDate(e,i));t.view.setProps(s)}.bind(this))},_getMilestoneIndexAtDate:function(e,t){return 1==e.length?1:e.length-t},_createViewBasedOnRenderMode:function(e,t){return e?s.createElement(o,t):s.createElement(l,t)},_createProps:function(e,t,i){return{left:100*this._timelineRangeModel.toRelativeOffset(e.date)+"%",cssClassName:this._getCssClassToHighlightActiveMilestone(i,e)+this._getCssClassByGroupIndex(i),name:e.name,id:e.id,onSetHighlightedMilestone:this._milestonesModel.setHighlightedMilestoneId.bind(this._milestonesModel),onUpdatePosition:this._milestonesModel.updateActiveMilestonePosition.bind(this._milestonesModel),onSetActiveMilestone:this._milestonesModel.setActiveMilestone.bind(this._milestonesModel),onResetActiveMilestone:this._milestonesModel.resetActiveMilestone.bind(this._milestonesModel),isHighlighted:e.id==this._milestonesModel.getHighlightedMilestoneId(),isActive:this._isActiveMilestone(e),isHidden:this._isRulerMode&&this._isInsideActiveGroup(e)}},_getActiveMilestoneFromModel:function(){return this._milestonesModel.getActiveMilestone()},_isActiveMilestone:function(e){var t=this._getActiveMilestoneFromModel();return t&&e.id==t.item.id},_isInsideActiveGroup:function(e){var t=this._getActiveMilestoneFromModel();return t&&t.item.date==e.date},_getCssClassToHighlightActiveMilestone:function(e,t){return 1==e&&this._isInsideActiveGroup(t)?"tau-timeline-milestone-active "+this._getCssClassForItem(this._getActiveMilestoneFromModel().item.cssClass):this._getCssClassForItem(t.cssClass)},_getCssClassForItem:function(e){return e.toLowerCase().replace("milestone","tau-timeline-milestone--")},_getCssClassByGroupIndex:function(e){return" tau-timeline-milestone--"+e+"-on-date"}})});