define(["Underscore","jQuery","tau/components/board.timeline/models/cell/model.cell.base","tau/utils/utils.date","tau/utils/timeline/utils.timeline.date-range","tau/components/board.timeline/models/card/model.timeline.durable-card","tau/components/board.timeline/models/card/model.timeline.fixed-card"],function(e,t,a,i,n,d,s){var r=a.extend({init:function(t,a,i,n){if(!t)throw new Error("definition is not defined");if(!a)throw new Error("dataItem is not defined");if(!i)throw new Error("timelineRangeModel is not defined");this.onYAxisUpdated=e.Callbacks(),this._yAxisModel=n||l,this._yAxisModel.onAxisUpdated.add(this._fireYAxisDataUpdated,this),this.isTimeline=!0,this.timelineRangeModel=i,this.onMovePlannedDates=e.Callbacks(),this._super(t,a)},_createCardModel:function(e){return e.fixedDatePlan?new s(e,this.timelineRangeModel):new d(e,this.timelineRangeModel)},_fireYAxisDataUpdated:function(e){this.onYAxisUpdated.fire(this.processRawCardItem(e.card.data))},getYAxisDataRange:function(){return this.processRawCardItem(this._yAxisModel.getAxisCellItem(this.dataItem.y))},_processFixedSection:function(e){e.fixedDate=o(e.plannedStartDate),this._isInTimelineRange(e.fixedDate,e.fixedDate)&&(e.fixedLeft=this.timelineRangeModel.getDateRelativeOffset(e.fixedDate),e.showFixed=!0,e.isVisible=!0)},_processActualSection:function(e){e.inProgress=e.inProgress||!e.actualEndDate,e.actualEndDate=o(e.actualEndDate,i.getServerNow(),e.inProgress),e.actualStartDate=o(e.actualStartDate,e.actualEndDate);var t=e.actualStartDateBoundToPlannedStartDate?e.actualStartDate<e.actualEndDate:!0;if(this._isInTimelineRange(e.actualStartDate,e.actualEndDate)&&t){var a=this.timelineRangeModel.getRelativeOffsetAndDuration(e.actualStartDate,e.actualEndDate);e.actualLeft=a.offset,e.actualWidth=a.duration,e.showActual=!0,e.isVisible=!0}},_processPlannedSection:function(e){if(e.plannedEndDate=o(e.plannedEndDate),e.plannedStartDate=o(e.plannedStartDate),this._isInTimelineRange(e.plannedStartDate,e.plannedEndDate)){var t=this.timelineRangeModel.getRelativeOffsetAndDuration(e.plannedStartDate,e.plannedEndDate);e.plannedLeft=t.offset,e.plannedWidth=t.duration,e.showPlanned=!0,e.isVisible=!0}},_processForecastSection:function(e){e.hasForecast=!0,e.forecastStartDate=i.getServerNow(),e.forecastEndDate=o(e.forecastEndDate,i.getServerNow());var t=e.hasActual&&e.hasPlanned&&e.plannedEndDate<e.forecastStartDate;if(t||this._isInTimelineRange(e.forecastStartDate,e.forecastEndDate)){var a=this.timelineRangeModel.getRelativeOffsetAndDuration(e.forecastStartDate,e.forecastEndDate);e.forecastLeft=a.offset,e.forecastWidth=a.duration,e.showForecast=!0,e.isVisible=!0}},processRawCardItem:function(t){return e.extend(t,{actualLeft:0/0,actualWidth:0/0,showActual:!1,plannedLeft:0/0,plannedWidth:0/0,showPlanned:!1,forecastLeft:0/0,forecastWidth:0/0,showForecast:!1,fixedLeft:0/0,showFixed:!1,isVisible:!1}),t.fixedDatePlan&&t.plannedStartDate&&this._processFixedSection(t),t.hasActual&&(t.actualStartDate||t.actualEndDate)&&this._processActualSection(t),t.hasPlanned&&t.plannedStartDate&&t.plannedEndDate&&this._processPlannedSection(t),t.forecastEndDate&&this._processForecastSection(t),t},extendUnfinishedCardsToNow:function(t){return e.chain(this.getVisibleCardModels()).filter(function(e){return e.isUnfinished()}).each(this._reprocessCardModel.bind(this)).tap(function(e){!t&&e.length&&this.onCardsUpdated.fire(e,{suspendAnimation:!0,metricsOnly:!0})}.bind(this)).value()},updateCardsPositions:function(){var t=this.getVisibleCardModels();e.each(this.getCardModels().range(),this._reprocessCardModel.bind(this));var a=this.getVisibleCardModels(),i=e.difference(a,t),n=e.difference(t,a);this.extendUnfinishedCardsToNow(!0),this.onCardsCleared.fire(e.pluck(n,"id")),this.onCardsAdded.fire(i,{suspendAnimation:!0}),this.onCardsUpdated.fire(a,{suspendAnimation:!0,metricsOnly:!0}),this.onYAxisUpdated.fire(this.getYAxisDataRange())},addCard:function(e,t){e=this.processRawCardItem(e);var a=this._createCardModel(e);this._checkIfCardCanBeAdded(a)&&(this._cardModels.insert(a),e.isVisible&&(this.extendUnfinishedCardsToNow(!0),this.onCardsAdded.fire([a],t)))},_reprocessCardModel:function(e){var t=this.processRawCardItem(e.cardData());e.update(t)},getVisibleCardModels:function(){return e.filter(this._cardModels.range(),function(e){return e._cardData.isVisible})},updateCard:function(e,t){e=this.processRawCardItem(e);var a=this._cardModels.get(e.id);a?a.update(e):this._cardModels.insert(this._createCardModel(e)),e.isVisible?(this.extendUnfinishedCardsToNow(!0),this.onCardsUpdated.fire([this._cardModels.get(e.id)],t)):this.onCardsCleared.fire([e.id])},movePlannedDates:function(t){var a=this,i={id:t.id,onError:function(){t.rollbackEdit()},onSuccess:function(){var i=e.pick(this,"plannedStartDate","plannedEndDate");a.updateCard(e.extend({},t.cardData(),i),{suspendAnimation:!0})}},n=t.plannedRange();null!==n.from&&(i.plannedStartDate=this.timelineRangeModel.serializeAsDate(n.from)),null!==n.to&&(i.plannedEndDate=this.timelineRangeModel.serializeAsDate(n.to)),this.onMovePlannedDates.fire(i)},_checkIfCardCanBeAdded:function(e){var t=e._cardData;return(this._isInTimelineRange(t.actualStartDate,t.actualEndDate)||this._isInTimelineRange(t.plannedStartDate,t.plannedEndDate))&&this._super(e)},_isInTimelineRange:function(e,t){return this.timelineRangeModel.getDateRange().intersects(new n(e,t))},getMoveParameters:function(e){return e.forEach(function(e){if(this._cardBeingEdited){var t=this._cardBeingEdited.plannedRange();e.position={plannedStartDate:this.timelineRangeModel.serializeAsDate(t.from),plannedEndDate:this.timelineRangeModel.serializeAsDate(t.to)}}}.bind(this)),e},moveCardIn:function(t){var a={isVisible:!0,showPlanned:!0,plannedLeft:0,plannedWidth:.3};return this._cardBeingEdited=this._createCardModel(e.extend(a,t)),this._cardBeingEdited},moveCardOut:function(){this._cardBeingEdited=null}}),o=function(t,a,n){return t=n?a:t||a,e.isString(t)?i._convertToServerTime(i.parse(t)):t},l={onAxisUpdated:e.Callbacks(),getAxisCellItem:function(){return{}}};return r});