define(["require","Underscore","jQuery","tau/core/class"],function(e){var t=e("Underscore"),i=e("jQuery"),r=e("tau/core/class");return r.extend({init:function(e,t,i){this._store=e,this._loggedUser=i},deleteMilestone:function(e){return this._store.remove("milestone",{id:e.id}).promise()},saveMilestone:function(e,t){var i=this._getFieldConfigurationForSave(t);return i.id=e.id,this.unassignFromProjects(e,t).then(function(){return this._store.save("milestone",i).promise()}.bind(this))},addMilestone:function(e){var t=this._getFieldConfigurationForSave(e);return t.$set.owner={id:this._loggedUser.id},this._store.save("milestone",t).promise()},unassignFromProjects:function(e,r){var o=t.filter(e.projects,function(e){return r.projects.indexOf(e.id)<0});return i.when(o.length>0?this._removeProjectsFromMilestone(e,o):!0)},_getFieldConfigurationForSave:function(e){return{$set:{name:e.name,description:e.description,cssClass:this._milestoneColorToCSSClass(e.color),date:e.date,projects:t.map(e.projects,function(e){return{id:e}})},fields:["id","name","description","cssClass","date",{projects:["id","name","abbreviation","color"]}]}},_removeProjectsFromMilestone:function(e,i){return this._store.removeFromList("milestone",{id:e.id,$set:{projects:{id:t.pluck(i,"id").join(",")}}}).promise()},_milestoneColorToCSSClass:function(e){return"milestone"+this._capitalizeFirstLetter(e)},_capitalizeFirstLetter:function(e){return e.charAt(0).toUpperCase()+e.slice(1)}})});