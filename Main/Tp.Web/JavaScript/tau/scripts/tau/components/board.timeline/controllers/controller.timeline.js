define(["Underscore","jQuery","tau/core/class","tau/components/board.timeline/views/board.timeline.view.now-marker","tau/components/board.timeline/views/ruler/board.timeline.view.ruler","tau/components/board.timeline/views/view.timeline.navigator","tau/components/board.timeline/models/model.timeline.navigator"],function(e,i,t,n,s,o,r){var l={seconds:function(e){return 1e3*e},minutes:function(e){return this.seconds(60*e)}},a={TIMELINE_SCROLLING_RENDER:l.seconds(.2),NOW_MARKER_UPDATE:l.minutes(1),FORECASTS_UPDATE:l.minutes(60)},d=t.extend({init:function(i){this._interval=i,this._timerId=null,this.onTick=e.Callbacks()},start:function(){this._timerId=setInterval(this.onTick.fire.bind(this.onTick),this._interval)},stop:function(){clearInterval(this._timerId),this._timerId=null},destroy:function(){this.onTick.removeAll(),this.stop()}}),h=t.extend({init:function(e,i,t){this._busEvents=t,this._timelineViewRegistry=i.view,this._timelineCellModelRegistry=i.cellModel,this._timelineAxesModelRegistry=i.axesModel,this._timelineModel=e,this._timelineModel.onTimelineLocalDateRangeChanged.add(this._onTimelineLocalDateRangeChanged.bind(this)),this._timelineAxesModelRegistry.onAxisCellsAdded.add(function(e,i){this._timelineViewRegistry.axisCellsAdded(e,i)},this),this._rulerNowMarker=new n(this._timelineModel.timelineRangeModel),this._rulerView=new s(this._rulerNowMarker),this._nowMarker=new n(this._timelineModel.timelineRangeModel);var l=new d(a.NOW_MARKER_UPDATE);l.onTick.add(this._updateNowPositions,this);var h=new d(a.FORECASTS_UPDATE);h.onTick.add(this._updateForecasts,this),this._timers=[l,h],this._navigatorModel=new r(this._timelineModel),this._navigatorView=new o(this._navigatorModel),this._navigatorView.onDateRangeChanged.add(this._updateLocalDateRange.bind(this))},destructor:function(){e.invoke(this._timers,"destroy"),this._timelineModel.unbindBoardSettings()},_onTimelineLocalDateRangeChanged:function(e){this._rulerView.bind(e),this._updateNowMarkers()},_updateNowMarkers:function(){this._rulerNowMarker.updatePosition(),this._nowMarker.updatePosition(),this._navigatorView.updateNowPosition()
},_updateNowPositions:function(){this._updateNowMarkers(),this._timelineCellModelRegistry.forEach(function(e){e.isTimeline&&e.extendUnfinishedCardsToNow(!1)})},_updateForecasts:function(){this._timelineModel.queryForecasts().then(function(e){this._timelineCellModelRegistry.forEach(function(i){i.isTimeline&&i.updateForecasts(e)})}.bind(this))},resize:function(i){var t=i.find(".tau-timeline-flow"),n={width:t.outerWidth(),height:t.outerHeight()};e.isEqual(this._size,n)||this.render(i)},render:function(i){this._navigatorView.renderTo(i.find("._tc-timeline-navigator"));var t=i.find(".tau-timeline-flow");this._size={width:t.outerWidth(),height:t.outerHeight()},this._rulerView.renderTo(i),this._nowMarker.render(i.find(".tau-timeline-flow")),e.invoke(this._timers,"stop"),this._updateNowMarkers(),e.invoke(this._timers,"start"),this._busEvents.rendered.fire()},_updateLocalDateRange:function(e){this._rulerView.bind(e),this._applyLocalDateToTimelineCards(e)},_applyLocalDateToTimelineCards:e.throttle(function(e){this._timelineModel.setDateRange(e),this._timelineCellModelRegistry.forEach(function(e){e.isTimeline&&e.updateCardsPositions()}),this._updateNowMarkers()},a.TIMELINE_SCROLLING_RENDER),onCellsContentLoaded:function(){this._timelineCellModelRegistry.forEach(function(e){e.isTimeline&&e.onMovePlannedDates.add(this._timelineModel.movePlannedDates.bind(this._timelineModel))}.bind(this))},onCardsMoved:function(i){this._timelineCellModelRegistry.forEach(function(t){e.each(i,function(e){t.clearCard(e.dataItem.id)})}),e.each(i,function(i){var t=e.extend(e.pick(i,"track"),t,{forceUnlock:!0}),n=this._timelineCellModelRegistry.get(i);n&&n.updateCard(i.dataItem,t)},this)},onBuildCellSkeleton:function(e,i,t,n,s){if(0===t.paging.from){var o=this._timelineCellModelRegistry.get(t);this._timelineViewRegistry.renderCell(e,i,o,n.element,s)}},onBuildAxisSkeleton:function(e,i,t,n){var s=this._timelineAxesModelRegistry.get(t);this._timelineViewRegistry.renderAxisCell(e,i,s,n.element)}});return h
});