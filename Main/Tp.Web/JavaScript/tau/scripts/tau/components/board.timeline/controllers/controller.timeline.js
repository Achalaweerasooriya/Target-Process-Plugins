define(["Underscore","jQuery","tau/core/class","tau/components/board.timeline/views/board.timeline.view.now-marker","tau/components/board.timeline/views/ruler/board.timeline.view.ruler","tau/components/board.timeline/views/view.timeline.navigator","tau/components/board.timeline/models/model.timeline.navigator"],function(e,i,t,n,s,l,o){var r=6e4,d=200,a=t.extend({init:function(i){this._interval=i,this._timerId=null,this.onTick=e.Callbacks()},start:function(){this._timerId=setInterval(this.onTick.fire.bind(this.onTick),this._interval)},stop:function(){clearInterval(this._timerId),this._timerId=null}}),h=t.extend({init:function(i,t){this.rendered=e.Callbacks(),this.error=e.Callbacks(),this.hintHide=e.Callbacks(),this.cardUnselect=e.Callbacks(),this.viewTimelineTracksCountChanged=e.Callbacks(),this._timelineViewRegistry=t.view,this._timelineCellModelRegistry=t.cellModel,this._timelineAxesModelRegistry=t.axesModel,this._timelineModel=i,this._timelineModel.onTimelineError.add(this.error.fire.bind(this.error)),this._timelineModel.onTimelineLocalDateRangeChanged.add(this._onTimelineLocalDateRangeChanged.bind(this)),this._timelineAxesModelRegistry.onAxisCellAdded.add(function(e,i){this._timelineViewRegistry.axisCellAdded(e,i)},this),this._timer=new a(r),this._timer.onTick.add(this._updateNowPositions,this);var d=this._timelineCellModelRegistry.getRelativeNowOffset.bind(this._timelineCellModelRegistry);this._rulerView=new s(d),this._nowMarker=new n(d),this._navigatorModel=new o(this._timelineModel),this._navigatorView=new l(this._navigatorModel),this._navigatorView.onDateRangeChanged.add(this._updateLocalDateRange.bind(this))},destructor:function(){this._timer.onTick.removeAll(),this._timer.stop(),this._timelineModel.unbindBoardSettings()},_onTimelineLocalDateRangeChanged:function(e){this._rulerView.bind(e),this._updateNowMarkers()},_updateNowMarkers:function(){this._rulerView.updateNowPosition(),this._nowMarker.updatePosition(),this._navigatorView.updateNowPosition()},_updateNowPositions:function(){this._updateNowMarkers(),this._timelineCellModelRegistry.extendUnfinishedCardsToNow()},resize:function(i){var t=i.find(".tau-timeline-flow"),n={width:t.outerWidth(),height:t.outerHeight()};e.isEqual(this._size,n)||this.render(i)},render:function(e){this._navigatorView.renderTo(e.find("._tc-timeline-navigator"));var i=e.find(".tau-timeline-flow");this._size={width:i.outerWidth(),height:i.outerHeight()},this._rulerView.renderTo(e),this._nowMarker.render(e.find(".tau-timeline-flow")),this._timer.stop(),this._updateNowMarkers(),this._timer.start(),this.rendered.fire()},_updateLocalDateRange:function(e){this._rulerView.bind(e),this._applyLocalDateToTimelineCards(e)},_applyLocalDateToTimelineCards:e.throttle(function(e){this._timelineModel.setDateRange(e),this._timelineCellModelRegistry.updateCardsPositions(),this._updateNowMarkers()},d),onCellsContentLoaded:function(){this._timelineCellModelRegistry.broadcastCells(function(e){e.isTimeline&&e.onMovePlannedDates.add(this._timelineModel.movePlannedDates.bind(this._timelineModel))}.bind(this))},onCardsMoved:function(e,i){this._timelineCellModelRegistry.moveCards(e,i)},onBuildCellSkeleton:function(e,t,n,s,l){0===n.paging.from&&this._timelineCellModelRegistry.whenCellRegistered(n).then(function(n){return i.when(n,this._timelineViewRegistry.renderCell(e,t,n,s.element,l))}.bind(this)).then(function(e,i){e.isTimeline&&(i.onCardMetricsEdit.add(this.hintHide.fire.bind(this.hintHide)),i.onCardMetricsEdited.add(this.cardUnselect.fire.bind(this.cardUnselect)),i.onTracksCountChanged.add(this.viewTimelineTracksCountChanged.fire.bind(this.viewTimelineTracksCountChanged)))}.bind(this))},onBuildAxisSkeleton:function(e,i,t,n){this._timelineAxesModelRegistry.whenAxisRegistered(t).then(function(t){this._timelineViewRegistry.renderAxisCell(e,i,t,n.element)}.bind(this))}});return h});