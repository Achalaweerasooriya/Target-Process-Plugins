define(["Underscore","jQuery","react","tau/core/class","tau/components/board.timeline/views/board.timeline.view.now-marker","tau/components/board.timeline/views/ruler/board.timeline.view.ruler","tau/components/board.timeline/views/view.timeline.navigator","tau/components/board.timeline/models/model.timeline.navigator","tau/components/board.timeline/views/board.timeline.view.milestones","tau/components/board.timeline/views/board.timeline.view.milestone.details"],function(e,i,t,n,s,o,l,d,a,r){var h={seconds:function(e){return 1e3*e},minutes:function(e){return this.seconds(60*e)}},_={TIMELINE_SCROLLING_RENDER:h.seconds(.2),NOW_MARKER_UPDATE:h.minutes(1),FORECASTS_UPDATE:h.minutes(60),RENDER_THROTTLE_INTERVAL:h.seconds(.4)},m=n.extend({init:function(i){this._interval=i,this._timerId=null,this.onTick=e.Callbacks()},start:function(){this._timerId=setInterval(this.onTick.fire.bind(this.onTick),this._interval)},stop:function(){clearInterval(this._timerId),this._timerId=null},destroy:function(){this.onTick.removeAll(),this.stop()}}),u=n.extend({init:function(e,i,t){this._busEvents=t,this._timelineViewRegistry=i.view,this._timelineCellModelRegistry=i.cellModel,this._timelineAxesModelRegistry=i.axesModel,this._milestonesModel=i.milestonesModel,this._timelineModel=e,this._milestonesModel.timelineRangeModel=this._timelineModel.timelineRangeModel,this._timelineModel.onSliceReady.add(function(e){this._milestonesModel.setSlice(e.slice)}.bind(this)),this._timelineModel.onAcidReady.add(function(e){this._milestonesModel.setAcid(e)}.bind(this)),this._timelineModel.onTimelineLocalDateRangeChanged.add(this._onTimelineLocalDateRangeChanged.bind(this)),this._timelineAxesModelRegistry.onAxisCellsAdded.add(function(e,i){this._timelineViewRegistry.axisCellsAdded(e,i)},this),this._rulerMilestonesView=new a(this._timelineModel.timelineRangeModel,this._milestonesModel),this._rulerView=new o(this._rulerMilestonesView),this._nowMarker=new s(this._timelineModel.timelineRangeModel),this._milestonesView=new a(this._timelineModel.timelineRangeModel,this._milestonesModel),this._milestoneDetailsView=new r(this._milestonesModel),this._milestonesModel.changed.add(this._onMilestoneModelChanged.bind(this));
var n=new m(_.NOW_MARKER_UPDATE);n.onTick.add(this._updateNowPositions,this);var h=new m(_.FORECASTS_UPDATE);h.onTick.add(this._updateForecasts,this),this._timers=[n,h],this._navigatorModel=new d(this._timelineModel),this._navigatorView=new l(this._navigatorModel),this._navigatorView.onDateRangeChanged.add(this._updateLocalDateRange.bind(this))},destructor:function(){e.invoke(this._timers,"destroy"),this._timelineModel.unbindBoardSettings(),this._milestonesModel.destroy(),this._milestoneDetailsView.destroy()},_onTimelineLocalDateRangeChanged:function(e){this._rulerView.bind(e),this._milestonesView.updatePosition(),this._updateNowMarkers()},_onMilestoneModelChanged:function(){this._milestonesView.updatePosition(),this._rulerMilestonesView.updatePosition(),this._milestoneDetailsView.render()},_updateNowMarkers:function(){this._nowMarker.updatePosition(),this._navigatorView.updateNowPosition()},_updateNowPositions:function(){this._updateNowMarkers(),this._timelineCellModelRegistry.forEach(function(e){e.isTimeline&&e.extendUnfinishedCardsToNow(!1)})},_updateForecasts:function(){this._timelineModel.queryForecasts().then(function(e){this._timelineCellModelRegistry.forEach(function(i){i.isTimeline&&i.updateForecasts(e)})}.bind(this))},resize:function(i){var t=i.find(".tau-timeline-flow"),n={width:t.outerWidth(),height:t.outerHeight()};e.isEqual(this._size,n)||this.render(i)},render:e.throttle(function(t){this._navigatorView.renderTo(t.find("._tc-timeline-navigator"));var n=t.find(".tau-timeline-flow");this._size={width:n.outerWidth(),height:n.outerHeight()},this._rulerView.renderTo(t),this._nowMarker.render(t.find(".tau-timeline-flow")),this._milestonesView.render(t.find(".tau-timeline-flow")),this._milestoneDetailsView.render(i("body")),e.invoke(this._timers,"stop"),this._updateNowMarkers(),e.invoke(this._timers,"start"),this._busEvents.rendered.fire()},_.RENDER_THROTTLE_INTERVAL),_updateLocalDateRange:function(e){this._applyLocalDateToTimelineCards(e)},_applyLocalDateToTimelineCards:e.throttle(function(e){this._timelineModel.setDateRange(e),this._timelineCellModelRegistry.forEach(function(e){e.isTimeline&&e.updateCardsPositions()
}),this._updateNowMarkers(),this._rulerView.bind(e),this._milestonesView.updatePosition(),this._milestonesModel.resetActiveMilestone()},_.TIMELINE_SCROLLING_RENDER),onCellsContentLoaded:function(){this._timelineCellModelRegistry.forEach(function(e){e.isTimeline&&e.onMovePlannedDates.add(this._timelineModel.movePlannedDates.bind(this._timelineModel))}.bind(this))},onCardsMoved:function(i){this._timelineCellModelRegistry.forEach(function(t){e.each(i,function(e){t.clearCard(e.dataItem.id)})}),e.each(i,function(i){var t=e.extend(e.pick(i,"track"),t,{forceUnlock:!0}),n=this._timelineCellModelRegistry.get(i);n&&n.updateCard(i.dataItem,t)},this)},onBuildCellSkeleton:function(e,i,t,n,s){if(0===t.paging.from){var o=this._timelineCellModelRegistry.get(t);this._timelineViewRegistry.renderCell(e,i,o,n.element,s)}},onBuildAxisSkeleton:function(e,i,t,n){var s=this._timelineAxesModelRegistry.get(t);this._timelineViewRegistry.renderAxisCell(e,i,s,n.element)}});return u});