define(["require","Underscore","jQuery","react","tau/core/class","jsx!tau/components/board.timeline/views/board.timeline.view.milestone.info","jsx!tau/components/board.timeline/views/board.timeline.view.milestone.edit","tau/utils/utils.date"],function(e){var t=e("Underscore"),i=e("jQuery"),s=e("react"),o=e("tau/core/class"),n=e("jsx!tau/components/board.timeline/views/board.timeline.view.milestone.info"),l=e("jsx!tau/components/board.timeline/views/board.timeline.view.milestone.edit"),d=e("tau/utils/utils.date");return o.extend({DETAILS_POPUP_WIDTH:240,DETAILS_POPUP_SCROLL_EXTRA_WIDTH:20,DETAILS_POPUP_HEIGHT:610,POPUP_RIGHT_CSS_CLASS:"tau-timeline-milestone-popup--right",init:function(e){this._milestonesModel=e,this._node=null,this._activeMilestoneState={},this._width=this.DETAILS_POPUP_WIDTH,this._maxAvailableHeight=null,this._attachKeyboardEvents()},render:function(e){e=this._getPlaceholderForRender(e),e&&e.find(".tau-timeline-milestone-popup").remove(),e?this._renderInternal(e):this._node=null},_getPlaceholderForRender:function(e){return e||this._placeholder?(e&&(this._placeholder=e),this._placeholder):null},_renderInternal:function(e){if(this._milestonesModel.getActiveMilestone()){var i=t.deepClone(this._milestonesModel.getActiveMilestone()),o=this._createDetailsPlaceHolder(e,i);this._createView(i.item).then(function(e){this._milestonesModel.isEditMode&&o.addClass("tau-timeline-milestone-popup--edit-mode"),this._node=o[0],s.render(e,this._node)}.bind(this))}},_createView:function(e){return this._milestonesModel.isEditMode?this._milestonesModel.getAvailableProjects().then(this._createEditView.bind(this,e)):i.when(this._createDetailsView(e))},_createEditView:function(e,t){return s.createElement(l,this._createMilestoneEditProps(e,t.projects))},_createDetailsView:function(e){return s.createElement(n,this._createMilestoneDetailsProps(e))},_createDetailsPlaceHolder:function(e,t){this._maxAvailableHeight=null;var s=i('<div class="tau-timeline-milestone-popup"></div>'),o=document.body.getBoundingClientRect().right,n=t.position.left;
o-n<this._width&&(n=n-this._width+2,s.addClass(this.POPUP_RIGHT_CSS_CLASS)),s.css("left",n+"px"),s.css("top",t.position.top),s.appendTo(e);var l=s.offset().top+20,d=i(window).height(),a=d-l-10;return a<this.DETAILS_POPUP_HEIGHT&&this._milestonesModel.isEditMode&&(this._maxAvailableHeight=a,s.hasClass(this.POPUP_RIGHT_CSS_CLASS)&&s.css("left",n-this.DETAILS_POPUP_SCROLL_EXTRA_WIDTH+"px"),s.css("width",this._width+this.DETAILS_POPUP_SCROLL_EXTRA_WIDTH+"px")),s},_createMilestoneStateProps:function(e){return{name:e.name,id:e.id,description:e.description,date:d.formatAs(d.parseTimestampToDate(e.date),"dd MMM yyyy"),projects:e.projects,color:e.cssClass.toLowerCase().replace("milestone",""),isNew:!e.id}},_createMilestoneDetailsProps:function(e){return t.extend(this._createMilestoneStateProps(e),{onSetActiveMilestone:this._milestonesModel.setActiveMilestone.bind(this._milestonesModel),onResetActiveMilestone:this._milestonesModel.resetActiveMilestone.bind(this._milestonesModel),onToggleEditMode:this._milestonesModel.toggleEditMode.bind(this._milestonesModel)})},_createMilestoneEditProps:function(e,i){var s=t.extend(this._createMilestoneStateProps(e),{availableProjects:i,onResetActiveMilestone:this._milestonesModel.resetActiveMilestone.bind(this._milestonesModel),onAddMilestone:this._milestonesModel.addMilestone.bind(this._milestonesModel),onSaveMilestone:this._milestonesModel.saveMilestone.bind(this._milestonesModel),onDeleteMilestone:this._milestonesModel.deleteActiveMilestone.bind(this._milestonesModel),onEditStateChanged:this._updateActiveMilestoneEditState.bind(this),editState:this._getEditStateProps(e),maxHeight:this._maxAvailableHeight});return this._extendPropsWithQuickAddPopupArrow(s)},_getEditStateProps:function(e){return this._activeMilestoneState&&this._activeMilestoneState.id==e.id?this._activeMilestoneState:{}},_extendPropsWithQuickAddPopupArrow:function(e){return e.isNew&&(e=t.extend(e,{arrow:{top:-14,left:206,orientation:"top"}})),e},_updateActiveMilestoneEditState:function(e){this._activeMilestoneState=e
},_attachKeyboardEvents:function(){i(document).on("mousedown.milestone",this._hideByClick.bind(this)),i(document).on("keyup.milestone",this._hideByEsc.bind(this)),i(window).on("resize.milestone",this._milestonesModel.resetActiveMilestone.bind(this._milestonesModel))},_hideByClick:function(e){var t=i(".tau-timeline-milestone-popup");!t.is(e.target)&&!t.has(e.target).length&&e.target.className.indexOf("i-role-action")<0&&this._closeMilestoneDetails()},_hideByEsc:function(e){e.keyCode==i.ui.keyCode.ESCAPE&&this._closeMilestoneDetails()},_closeMilestoneDetails:function(){this._node&&(this._milestonesModel.resetActiveMilestone(),s.unmountComponentAtNode(this._node),this._node=null,this._updateActiveMilestoneEditState({}))},destroy:function(){i(document).off(".milestone"),this._node&&(s.unmountComponentAtNode(this._node),this._node.remove())}})});