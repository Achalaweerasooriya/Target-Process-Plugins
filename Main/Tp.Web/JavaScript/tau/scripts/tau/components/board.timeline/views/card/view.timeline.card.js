define(["Underscore","jQuery","tau/components/board.timeline/views/card/view.card-base","tau/components/board.timeline/models/cell/model.cell.base","tau/ui/templates/timeline/ui.template.timeline.card-holder","tau/ui/extensions/board.plus/ui.board.plus.dom.utils","tau/components/board.timeline/views/card/view.timeline.card.actual-section","tau/components/board.timeline/views/card/view.timeline.card.forecast-section","tau/components/board.timeline/views/card/view.timeline.card.planned-section","tau/components/board.timeline/views/timeline.card-metrics-editor"],function(e,t,i,s,n,a,r,d,o){var c=i.extend({init:function(t,i,s,n){this._boardCardView=i,this._cardMetricsConverter=s,this._viewMetrics=n,this.onEditStarted=e.Callbacks(),this.onEditStopped=e.Callbacks(),this._super(t),this._updateCardHolderGeometry(),this._model.onPlannedDatesUpdating.add(this._refreshMetrics,this)},cardData:function(){return this._model.cardData()},metrics:function(){return this._viewMetrics.get()},_refreshMetrics:function(e){this._viewMetrics.update(e),this._clearCache(),this._updateCardHolderGeometry()},insertAt:function(e,t){this._$dom.insertAt(e,t)},_updateCardHolderGeometry:function(){this._sections.actual.setPosition(),this._sections.planned.setPosition(),this._sections.forecast.setPosition()},_$render:function(){var e=n.render({metrics:this.metrics()}),t=this._boardCardView.$dom();return this._sections={planned:new o(this._model,this._viewMetrics,e.find(".i-role-card-planner"),t,this._cardMetricsConverter),actual:new r(this._model,this._viewMetrics,e.find(".i-role-timeline-card-holder"),t.clone(!0)),forecast:new d(this._model,this._viewMetrics,e.find(".i-role-card-predictor"))},this._sections.planned.onEditStarted.add(this.onEditStarted.fire.bind(this.onEditStarted,this)),this._sections.planned.onEditStopped.add(this.onEditStopped.fire.bind(this.onEditStopped,this)),this._sections.planned.onEditStopped.add(this.markAsNotChanged.bind(this)),this._sections.forecast.$section().on("contextmenu mouseup mousedown dblclick click mouseenter mouseleave",function(e){a.redirectEvent(this._sections.actual.$section().find(".i-role-card"),e)
}.bind(this)),e.data("visualMetrics",this.metrics()),e},update:function(e){this._model.update(e.cardData()),this._refreshMetrics(e),this._boardCardView.update(this._model),this._sections.actual.setContent(this._boardCardView.$dom().clone(!0)),this._checkVisualMetricsChanged()},updateMetrics:function(e){this._model.update(e.cardData()),this._refreshMetrics(e),this._updateCardHolderGeometry()},remove:function(){this._$dom.remove()},$dom:function(){return this._$dom.find(".i-role-card")},clearArtifacts:function(){this.remove(),this.onCleared.fire(this)},animateUpdate:function(e){return this._changed&&(this._boardCardView.markAsChanged(),this.markAsNotChanged()),this._boardCardView.animateUpdate(e)},whenAnimated:function(e,t){return this._boardCardView.whenAnimated(e,t)},_checkVisualMetricsChanged:function(){var t=this._$dom.data("visualMetrics"),i=this.metrics();e.isEqual(t,i)||(this.markAsChanged(),this._$dom.data("visualMetrics",i))},_clearCache:function(){this._effectiveCardPosition=null}});return c});