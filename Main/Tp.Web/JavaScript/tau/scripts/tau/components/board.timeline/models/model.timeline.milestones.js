define(["require","Underscore","jQuery","tau/core/class","tau/utils/utils.specification","tau/const/entityType.names","tau/components/board.timeline/models/model.timeline.milestones.editable","tau/components/board.timeline/models/model.timeline.milestones.active","tau/utils/utils.date"],function(e){var t=e("Underscore"),i=e("jQuery"),s=e("tau/core/class"),n=e("tau/utils/utils.specification"),o=e("tau/const/entityType.names"),l=e("tau/components/board.timeline/models/model.timeline.milestones.editable"),a=e("tau/components/board.timeline/models/model.timeline.milestones.active"),d=e("tau/utils/utils.date");return s.extend({_entityTypesForMilestone:[o.EPIC,o.FEATURE,o.US,o.TASK,o.BUG,o.REQUEST,o.TEST_PLAN,o.TEST_PLAN_RUN,o.IMPEDIMENT,o.PROJECT,o.PROGRAM,o.RELEASE,o.ITERATION,o.TEAM_ITERATION,o.BUILD,o.PROJECT_MEMBER],_milestoneNewTemplate:{name:"",date:d.toTimestamp(d.getServerNow()),projects:[],cssClass:"milestoneRed"},init:function(e,s,n,o){this._appContextService=e,this.getAvailableProjects=i.noop,this._onNotification=o,this.changed=t.Callbacks(),this.milestones={},this.isEditMode=!1,this.isMilestonesEnabled=!1,this._editModel=new l(s,this,n),this._activeMilestoneModel=new a(this._notifyChanged.bind(this)),this.timelineRangeModel=null},getHighlightedMilestoneId:function(){return this._activeMilestoneModel.highlightedMilestoneId},getActiveMilestone:function(){return this._activeMilestoneModel.activeMilestone},setSlice:function(e){this._slice=e,this._retrieveMilestonesCondition()?this._retrieveResults():this._setData([])},setAcid:function(e){this.getAvailableProjects=t.memoize(this._appContextService.getApplicationContext.bind(this._appContextService,{acid:e}))},deleteActiveMilestone:function(){var e=this.getActiveMilestone();this._editModel.deleteMilestone(e.item).done(function(){delete this.milestones[e.item.id],this._activeMilestoneModel.resetActiveMilestone(),this._showSuccessNotification("The Milestone has been deleted")}.bind(this))},saveMilestone:function(e){this._editModel.saveMilestone(this.getActiveMilestone().item,e).done(function(t){this._updateModelWithResponseData(t),this.isEditMode=!1,this.timelineRangeModel&&this.timelineRangeModel.isInRange(d.parseTimestampToDate(t[0].data.date),d.parseTimestampToDate(t[0].data.date))?this._activeMilestoneModel.updateActiveMilestone(t[0].data):(delete this.milestones[e.id],this._activeMilestoneModel.resetActiveMilestone()),this._showSuccessNotification("The Milestone has been updated")
}.bind(this))},addMilestone:function(e){this._editModel.addMilestone(e).done(function(e){this._updateModelWithResponseData(e),this._showSuccessNotification("The Milestone has been added"),this.resetActiveMilestone()}.bind(this))},setHighlightedMilestoneId:function(e){this._activeMilestoneModel.setHighlightedMilestoneId(e)},resetActiveMilestone:function(){this.isEditMode=!1,this._activeMilestoneModel.resetActiveMilestone()},updateActiveMilestonePosition:function(e){this._activeMilestoneModel.updateActiveMilestonePosition(e)},setActiveMilestone:function(e,t){this._activeMilestoneModel.setActiveMilestone(this.milestones[e],t)},createNewMilestone:function(e){this.isEditMode=!0;var t=this.getActiveMilestone();!t||t&&t.item.id?this._activeMilestoneModel.setActiveMilestone(this._milestoneNewTemplate,e):this.resetActiveMilestone()},toggleEditMode:function(e){this.isEditMode=e,this._notifyChanged()},_showSuccessNotification:function(e){this._onNotification.fire({type:"success",message:e})},_updateModelWithResponseData:function(e){var t=e[0].data;this.milestones[t.id]=t},_retrieveMilestonesCondition:function(){return this.isMilestonesEnabled=n.check(n.when(this._slice.config.definition).has(this._hasEntityTypes,this._entityTypesForMilestone).and(this._enabledByBoardSettings).end).then(!0)||!1,this.isMilestonesEnabled},_hasEntityTypes:function(e){return t.intersection(e,t.pluck(this.cells.types,"type")).length>0},_enabledByBoardSettings:function(){return 1==this.user.showMilestones},_retrieveResults:function(){this._slice.milestones().done(function(e){this._setData(this._extractData(t.map(e.data,function(e){return e.dataItem})||[]))}.bind(this))},_extractData:function(e){return t.pluck(e,"data")},_setData:function(e){this.milestones=t.reduce(e,function(e,t){return e[t.id]=t,e},{}),this._notifyChanged()},_notifyChanged:function(){this.changed.fire()},destroy:function(){this.changed.empty(),this._setData=i.noop}})});