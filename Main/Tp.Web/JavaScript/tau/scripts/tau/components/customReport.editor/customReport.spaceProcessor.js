define(["require","jQuery","Underscore"],function(e){var t=e("jQuery"),l=e("Underscore");return{getSpaceTotal:function(e,l,n,s){return t.when(this._spaceAvailable(e,n),this._spaceCells(e,l,n),this._getFilters(l,s)).then(function(e,t,n){return this._processSpaces(e,t,n,l)}.bind(this))},_getFilters:function(e,t){return e.get({fields:["cells"]}).then(function(e){return t.getEntityFilters({cells:e.cells})})},_spaceAvailable:function(e,t){var l={global:{acid:t}},n=e.create({definition:l});return n.space()},_spaceCells:function(e,l,n){return l.get({fields:["cells"]}).then(function(l){var s={definition:{global:{acid:n},cells:l.cells}},r=e.create(s);return t.when(l.cells,n,r.space())}).then(function(e,t,l){return{space:l.data,currentCells:e,acid:t}})},_processSpaces:function(e,t,n,s){var r={spaceDefault:e.data,availableCells:t.space.cells||[],currentCells:t.currentCells},i={cells:{name:"cells",types:[],filters:(n.cells||{}).filters,useFilter:!0,filter:s.settings.reportSettings.dataSource.source.filter||""}},a=function(e){return e.toLowerCase()};return i.cells.types=l.map(r.spaceDefault.cells.items,function(e){var t={id:e.id,name:e.name,isAvailable:l.any(r.availableCells.items,function(t){return a(t.id)===a(e.id)}),isSelected:l.any(r.currentCells.types,function(t){return a(t)===a(e.id)})};return t.isAvailable=t.isSelected?!0:t.isAvailable,t}),i.acid=t.acid||"",i}}});