define(["require","jQuery","Underscore","tau/core/extension.base","../elements/customReport.elements","../customReport.builder","../customReport.settings.parser","libs/jquery/jquery.toggleFilter","libs/jquery/jquery.tau.resetableInput"],function(e){var t=e("jQuery"),i=e("Underscore"),n=e("tau/core/extension.base"),s=e("../elements/customReport.elements"),r=e("../customReport.builder"),o=e("../customReport.settings.parser");return e("libs/jquery/jquery.toggleFilter"),e("libs/jquery/jquery.tau.resetableInput"),n.extend({init:function(e){this._super(e),this._lastTick=null},"bus afterRender":function(e,i){var n=t(i.element);n.find(".i-role-filter-control").toggleFilter(),n.find(".i-role-filter-input").tauResetableInput({showAlways:!0})},"bus afterRender:last + configurator.ready:last + show":function(e,i,n){this._refreshForm(n,t(i.element))},"bus afterRender:last + acid.ready + space.ready + configurator.ready:last + boardSettings.ready":function(e,i,n,s,r,o){var a=t(i.element);this._rebind(a,r,o.boardSettings,n,s)},"bus afterRender:last + editableState:last + form.components.bind":function(e,i,n){var s=t(i.element);n.isEditable||(s.find("input").prop("disabled",!0),s.find("button").prop("disabled",!0))},"bus boardSettings.ready:last + destroy":function(e,t){t.boardSettings.unbind(this)},_refreshForm:function(e,t){var i=e.service("boardSettings");i.get({fields:["acid","reportSettings"]}).then(function(n){var s=new o({reportSettings:i.settings.reportSettings}),r=s.canParse();t.find(".i-role-cant-parse").toggleClass("tau-hide",r),t.find(".i-role-can-parse").toggleClass("tau-hide",!r),r&&(this._needToRebind===!0?(this._needToRebind=!1,this._rebind(t,e,i,n,null)):this._bindForm(e,i,n,null))}.bind(this))},_rebind:function(e,t,i,n,s){this._setEntities(e),this._bindForm(t,i,n,s).then(function(){this.fire("$form.ready",e)}.bind(this)),this._bindActions(e,t,i,n,s)},_bindForm:function(e,i,n,s){return this._onBoardSettingsChanged(e,i),t.when(this._entities.dataSource.set(s,e,i,n),this._entities.chartType.set(i),this._entities.dimensions.set(i)).then(function(){this.fire("form.components.bind")
}.bind(this))},_bindActions:function(e,t,i,n,s){this._entities.dataSource.bindActions(s,t,i,n),this._entities.chartType.bindActions(i),this._entities.dimensions.bindActions(i),e.find(".i-role-apply-changes").click(function(){this._save(t,i)}.bind(this))},_setEntities:function(e){this._entities=new s({$el:e})},_save:function(e,t){var n=this._entities.dimensions.get(),s=function(e){var t=i.find(n,function(t){return i.contains(t.axes,e)});return t?t.id:null},o={type:this._entities.chartType.get(),color:s("color"),size:s("size"),x:i.compact([s("x1"),s("x2")]),y:i.compact([s("y1"),s("y2")])};t.get({fields:["acid"]}).done(function(e){var i=this._getDataSource(e.acid,n);e.acid&&(i.global={acid:e.acid}),this._lastTick=(new Date).getTime(),r.createFromDefinition(t,i,o,this._lastTick)}.bind(this))},_getDataSource:function(e,t){return{source:this._entities.dataSource.get(),dimensions:i.map(t,function(e){return{id:e.id,model:e.model,filter:e.filter}}),global:{acid:e}}},_onBoardSettingsChanged:function(e,t){t.unbind({listener:this}),t.bind({listener:this,fields:["reportSettings"],callback:function(e){e.reportSettings.tick!==this._lastTick&&(this._needToRebind=!0,this.fire("refresh"))}}),t.bind({fields:["acid"],listener:this,callback:function(){this._save(e,t)}.bind(this)})}})});