define(["Underscore","tau/core/class","tau/components/period-selector/templates/template.period-selector","tau/utils/timeline/utils.timeline.date-range","tau/ui/behaviour/date/ui.behaviour.dateRangeEditor","tau/utils/utils.date/utils.date.formats"],function(e,t,i,n,a,o){var d=function(e){13===e.which&&(e.stopPropagation(),$(this).trigger("blur"))},r="i-role-timeline-period-host",s="i-role-timeline-period",u="i-role-date-range-loading",l="tau-checked";return t.extend({init:function(t,n,a){this.dateRangeChanged=e.Callbacks();var o=i.get().bind({},{});t.replaceWith(o),this.$choiceTextbox=o.find(".i-role-timeline-period-choice"),this.$choiceTextbox.keypress(d),this.$choiceTextbox.change(this._onChoiceTextChanged.bind(this)),this.$periodButton=o.find("."+s),this.$periodButton.click(this._onPeriodButtonClicked.bind(this,n)),this._bindDateRange(a)},_onChoiceTextChanged:function(e){e.preventDefault(),e.stopPropagation(),this.dateRangeChanged.fire(this._getDateRange())},_onPeriodButtonClicked:function(e,t){if(this.$periodButton.hasClass(l))return void this.$periodButton.removeClass(l);this.$periodButton.addClass(l),t.preventDefault(),t.stopPropagation();var i=this._initBubble(e);i.tauBubble("show")},_bindDateRange:function(e){this.$choiceTextbox.val(e.toString())},_getDateRange:function(){var e=this.$choiceTextbox.val();return n.tryParseWithRoundedDays(e)},_createBubbleContent:function(){return $(['<div class="tau-date-range-selector">',"<div class="+r+"></div>","<div class="+u+">Loading...</div>","</div>"].join(""))},_createBubbleTemplate:function(){return['<div class="tau-bubble">','<div class="tau-bubble__arrow" role="arrow"></div>','<div class="tau-bubble__inner tau-container" role="content"></div>',"</div>"].join("")},_initBubble:function(e){var t=this.$periodButton.tauBubble({alignTo:this.$periodButton,template:this._createBubbleTemplate(),content:this._createBubbleContent(),onShow:function(i){var n=this._getDateRange();i.find("."+u).hide();var a=i.find("."+r);a.dateRangeEditor({targetStyleName:s,showOnInit:!0,dateFormat:o.date.short,keyboardManager:e,onDateRangeUpdated:this._bindDateRange.bind(this),initialDateRange:n.isValid?n:null,onSave:function(){t.tauBubble("hide")},onCancel:function(e){null!==e&&this._bindDateRange(e)}.bind(this)})}.bind(this),onHide:function(e){this.$periodButton.removeClass(l);var t=e.find("."+r);if(t.dateRangeEditor("hideEditor"),t.dateRangeEditor("isDateRangeChanged")){var i=t.dateRangeEditor("getDateRange");this.dateRangeChanged.fire(i)}}.bind(this),zIndex:999});return t}})});