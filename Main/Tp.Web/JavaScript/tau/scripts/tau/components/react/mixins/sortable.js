define(["jQuery","Underscore"],function(t,e){var r=t.find.matchesSelector?function(e,r){for(var a=e;a;){if(1===a.nodeType&&t.find.matchesSelector(a,r))return t(a);a=a.parentNode}return t()}:function(e,r){return t(e).closest(r)},a={};return{SORTABLE_KEY_NAME:{full:"data-sortable-key","short":"sortableKey"},SORTABLE_TYPE_NAME:{full:"data-sortable-type","short":"sortableType"},getSharedSortState:function(){return a},setSharedSortState:function(t){a=t},sortableOptions:null,getDefaultSortableOptions:function(){return{sortableRootSelector:null,sortableItemSelector:"div[draggable=true]",sortableHandleSelector:null,setDragImage:null,sortItems:null,acceptedTypes:null,canAcceptItem:null,dragGhostClassAdded:!1}},componentWillMount:function(){if(this.sortableOptions=e.extend(this.getDefaultSortableOptions(),this.getSortableOptions()),e.isEmpty(this.sortableOptions.acceptedTypes)||!e.isArray(this.sortableOptions.acceptedTypes)){var t=this.constructor.displayName||"";console.error("Component %s does not specify accepted sortable item types",t)}},componentDidMount:function(){this._clearSortState()},sortableTarget:function(){var t={onDragStart:this.sortStart,onDragOver:this.sortDragOver,onDragEnter:this.sortDragEnter,onDragLeave:this.sortDragLeave,onDragEnd:this.sortEnd,onDrop:this.sortDrop};return this.sortableOptions.sortableHandleSelector&&(t.onMouseDown=this.sortMouseDown),t},_getSortableText:function(){return""},_isSortableItemAccepted:function(){var t=this.getSharedSortState();return null!==t.key&&e.contains(this.sortableOptions.acceptedTypes,t.type)?!this.sortableOptions.canAcceptItem||this.sortableOptions.canAcceptItem(t.type,t.key):!1},_findClosestSortable:function(t){return r(t,this.sortableOptions.sortableItemSelector)},_findFirstSortable:function(e){return t(e).find(this.sortableOptions.sortableItemSelector+":not(.t3-dragging):first")},_findLastSortable:function(e){return t(e).find(this.sortableOptions.sortableItemSelector+":not(.t3-dragging):last")},_findSortableRoot:function(t){return r(t[0],this.sortableOptions.sortableRootSelector)
},_removeAllDropClasses:function(e){var r=this._findSortableRoot(t(e));return this._removeDropClasses(r.find(".t3-drop-target"))},_removeDropClasses:function(t){return t.removeClass("t3-drop-target t3-drop-before t3-drop-after")},_addDropClasses:function(t){var e=this.getSharedSortState();t.addClass("t3-drop-target "+(e.placeAfter?"t3-drop-after":"t3-drop-before"))},_toggleDraggingClass:function(t){var e=this.getSharedSortState();e.$element.toggleClass("t3-dragging",t)},_toggleDragGhostClass:function(t){var e=this.getSharedSortState();e.$element.toggleClass("t3-drag-ghost",t),this.sortableOptions.dragGhostClassAdded=t},_findSortableTargetFromEvent:function(t){var e=t.target,r=this.getSharedSortState(),a=this._findClosestSortable(e);if(a.length)return r.overNonSortable=null,a;var o=document.elementFromPoint(t.clientX,t.clientY);return a=this._findClosestSortable(o),a.length?(r.overNonSortable=null,a):(r.overNonSortable=e,a=this._findLastSortable(e))},_clearSortState:function(){var e=this.getSharedSortState();e.$element&&e.$element.length&&(this._toggleDragGhostClass(!1),this._toggleDraggingClass(!1)),this.sortableMouseDownTarget=null,e={isDropFinished:!1,key:null,type:null,$element:t(),target:{$element:t()},placeAfter:null,lastDragEvent:null},this.setSharedSortState(e)},_updateSortStateSource:function(t){var e=this.getSharedSortState();e.$element=this._findClosestSortable(t),e.key=this._getSortableKey(e.$element),e.type=this._getSortableType(e.$element)},_updateSortStatePlaceAfter:function(){var t=this.getSharedSortState(),e=t.target.boundary,r=t.position-e.offset;t.placeAfter=r>e.dimension/2},_updateSortStateTarget:function(t){var e=this.getSharedSortState(),r=e.target,a=t[0];a===r.$element[0]?(this._updateSortStatePlaceAfter(),this._removeDropClasses(r.$element),this._addDropClasses(r.$element)):(r.$element=t,r.boundary=this._getBoundary(a.getBoundingClientRect()),this._updateSortStatePlaceAfter(),this._overElementChanged(r.$element))},_overElementChanged:function(t){this._removeAllDropClasses(t),this._addDropClasses(t)
},_getSortableKey:function(t){var e=t.data(this.SORTABLE_KEY_NAME.short);return"undefined"==typeof e?null:e+""},_getSortableType:function(t){var e=t.data(this.SORTABLE_TYPE_NAME.short);return"undefined"==typeof e?null:e+""},sortMouseDown:function(t){this.sortableMouseDownTarget=t.target},sortStart:function(e){var r;if(this.sortableOptions.sortableHandleSelector){var a=this.sortableMouseDownTarget&&t(this.sortableMouseDownTarget);if(r=a&&a.closest(this.sortableOptions.sortableHandleSelector),!r||!r.length)return void e.preventDefault()}if(this._clearSortState(),this._updateSortStateSource(e.target),this._toggleDragGhostClass(!0),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text",this._getSortableText()),this.sortableOptions.sortableHandleSelector&&this.sortableOptions.setDragImage&&e.dataTransfer.setDragImage){var o=this.sortableOptions.setDragImage(e,r);e.dataTransfer.setDragImage(o.element,o.x||0,o.y||0)}},sortDragOver:function(t){if(this._isSortableItemAccepted()){var e=this.getSharedSortState(),r=this._getPosition(t);if(r===e.position&&t.target===e.lastDragOverTarget)return void t.preventDefault();e.lastDragOverTarget=t.target,e.position=r;var a=this._findSortableTargetFromEvent(t);if(!a.length)return void this._removeAllDropClasses(t.target);t.preventDefault(),this._updateSortStateTarget(a)}},sortDragEnter:function(t){this.sortableOptions.dragGhostClassAdded&&(this._toggleDragGhostClass(!1),this._toggleDraggingClass(!0));var e=this.getSharedSortState();e.lastDragEvent={type:t.type,target:t.currentTarget,timeStamp:t.timeStamp}},sortDragLeave:function(t){var e=this.getSharedSortState();("dragenter"!==e.lastDragEvent.type||e.lastDragEvent.target!==t.currentTarget||t.timeStamp-e.lastDragEvent.timeStamp>100)&&this._removeAllDropClasses(t.currentTarget),e.lastDragEvent={type:t.type,target:t.currentTarget,timeStamp:t.timeStamp}},sortDrop:function(t){t.preventDefault();var e=this.getSharedSortState();e.isDropFinished=!0,this._isSortableItemAccepted()&&this._sortItems(),this._removeAllDropClasses(e.target.$element)
},sortEnd:function(){var t=this.getSharedSortState();this._removeAllDropClasses(t.$element),this._toggleDraggingClass(!1),this._clearSortState()},_sortItems:function(){var t=this.getSharedSortState(),e=this._getSortableKey(t.target.$element);t.key!==e&&this.sortableOptions.sortItems(t.key,e,t.placeAfter,t.type)}}});