define(["require","Underscore","jQuery","tau/core/class","tau/services/service.board.access","tau/utils/utils.serverErrorTranslator"],function(e){var t=e("Underscore"),s=e("jQuery"),i=e("tau/core/class"),a=e("tau/services/service.board.access"),n=e("tau/utils/utils.serverErrorTranslator"),r=i.extend({init:function(e,s,i,a,n){this._menuItemId=e,this._menuItemType=s,this._loggedUser=i,this._store=a,this._viewsMenuService=n,this._itemApiService=n.getApiForType(s),this._allTeams=[],this._allProjects=[],this._accessData=null,this._emailNotificationSettings=null,this.accessChanged=t.Callbacks(),this.errorOccurred=t.Callbacks(),this.accessSaving=t.Callbacks(),this._initSubscriptions()},initialize:function(){return this._updateItemAccessData().then(function(){return s.when(this._updateTeams(!0),this._updateProjects(!0))}.bind(this)).then(function(){this._notifyAccessChanged(),this._initSubscriptions()}.bind(this))},setPublicAccess:function(){this._setSharingFlags(!0,!1)},setPrivateAccess:function(){this._setSharingFlags(!1,!1)},setCustomAccess:function(){this._setSharingFlags(!0,!0)},setNewCustomSharingState:function(e,s){this._accessData.customSharedData.teamIds=t.clone(e),this._accessData.customSharedData.projectIds=t.clone(s),this._notifyAccessChanged()},getCanNotify:function(){var e=this.getCustomSharingOptions(),s=function(e){return t.some(e,t.property("selected"))};return s(e.projects)||s(e.teams)},applyAccessChanges:function(){this.accessSaving.fire(),this._itemApiService.updateViewMenuItem(this._menuItemId,{isShared:this._accessData.isShared,customSharedData:t.deepClone(this._accessData.customSharedData)}).fail(function(e){var t=e.response?e.response.data.responseText:e.data.responseText;this.errorOccurred.fire(n.translateServerError(t))}.bind(this))},_setSharingFlags:function(e,t){this._accessData.isShared=e,this._accessData.customSharedData.isActive=t,this._notifyAccessChanged()},getCustomSharingOptions:function(){var e=this._process(this._allTeams,this._accessData.customSharedData.teamIds),t=this._process(this._allProjects,this._accessData.customSharedData.projectIds,"Project");
return{teams:e,projects:t}},getAccessData:function(){return t.deepClone(this._accessData)},_initSubscriptions:function(){var e=t.debounce(function(){this._updateTeams()}.bind(this),300),s=t.debounce(function(){this._updateProjects()}.bind(this),300);this._store.on({eventName:"afterSave",type:"team",listener:this},e),this._store.on({eventName:"afterRemove",type:"team",listener:this},e),this._store.on({eventName:"afterSave",type:"project",listener:this},s),this._store.on({eventName:"afterRemove",type:"project",listener:this},s),this._itemApiService.unbind(this),this._itemApiService.on("service.views.api.updated",function(e,t){t.data.key===this._menuItemId&&this._shouldUpdateOnChangeNotification(t.data)&&this._updateItemAccessData().then(this._notifyAccessChanged.bind(this))},this)},_shouldUpdateOnChangeNotification:function(e){if(!this._accessData)return!1;if(null===e)return!1;var s=function(e){return t.pick(e,"isShared","customSharedData")};return!t.isEqual(s(e),s(this._accessData))},_updateItemAccessData:function(){return this._itemApiService.getViewMenuItem(this._menuItemId).then(function(e){var t=e.data;return s.when(t,this._getIsInheritedFromGroup(t))}.bind(this)).then(function(e,s){var i=this._loggedUser;return{isShared:e.isShared,isAdmin:i.isAdministrator,isOwner:a.isOwner(e,i),isEditable:!s&&a.isEditable(e,i),isView:"group"!==e.itemType,id:e.id||e.key,itemType:e.itemType,name:e.name,acid:e.acid,customSharedData:t.deepClone(e.customSharedData)||{isActive:!1,teamIds:[],projectIds:[]}}}.bind(this)).then(function(e){this._accessData=e}.bind(this))},_getIsInheritedFromGroup:function(e){var t=e.menuGroupKey;if(!t)return s.Deferred().resolve(!1);var i=s.Deferred();return this._viewsMenuService.groupsApi.getViewMenuItem(t).done(i.resolve.bind(i,!0)).fail(i.resolve.bind(i,!1)),i.promise()},_updateTeams:function(e){return this._store.getDef("team",{fields:["id","name","icon"]}).then(function(t){this._allTeams=t,e||this._notifyAccessChanged()}.bind(this))},_updateProjects:function(e){return this._store.getDef("project",{fields:["id","name","color","isActive"],$query:{isActive:"true"}}).then(function(t){this._allProjects=t,e||this._notifyAccessChanged()
}.bind(this))},_process:function(e,s,i){var a=function(e){return(-1==e.id?"0":"1")+(e.selected?"0_":"1_")+e.name.toUpperCase()},n=e;return n=t.chain(n).map(function(e){return{id:e.id,name:e.name,icon:e.icon,color:e.color,selected:t.indexOf(s,e.id)>=0,type:i}}).sortBy(a).value()},_notifyAccessChanged:function(){this._accessData&&this.accessChanged.fire()},destroy:function(){this._itemApiService.unbind(this),this._store.unbind(this)}});return r});