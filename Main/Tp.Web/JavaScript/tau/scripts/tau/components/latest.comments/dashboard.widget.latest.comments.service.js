define(["require","jQuery","Underscore","tau/core/class","tau/store/header","./dashboard.widget.latest.comments.constants","tau/utils/utils.date","tau/core/termProcessor"],function(e){var t=e("jQuery"),r=e("Underscore"),n=e("tau/core/class"),a=e("tau/store/header"),i=e("./dashboard.widget.latest.comments.constants"),o=e("tau/utils/utils.date"),s=e("tau/core/termProcessor"),m=new s;return n.extend({init:function(e){this._configurator=e},loadComments:function(e,t,n,a,i,o){return this._loadComments(e,t,n,a,i,o).then(function(e){return r.map(e,this._createCommentItem,this)}.bind(this))},_loadComments:function(e,r,n,o,s,m){var u=t.Deferred();if(r!==i.SOURCE_RELATED_TO_ME&&r!=i.SOURCE_ALL)return u.reject(),u;var c=this._configurator.getApplicationPath()+"/api/v1/comments/"+r+"?format=json&acid="+e+"&skip="+(n-1)*o+"&take="+o+"&from="+s+"&to="+m;return t.ajax({url:c,dataType:"json"}).done(function(e){var t=a.formatObject(e);u.resolve(t.data)}.bind(this)).fail(u.reject),u},_createCommentItem:function(e){var t=this._configurator.getUrlBuilder(),r=e.general.entityType.name.split("|"),n=r[0],a=r.length>1?m.getShortAbbreviation(r[1]):m.getTerms(n).iconSmall;return{id:e.id,parentId:e.parentId,date:{full:o.formatAs(o.parse(e.createDate),"d MMMM yyyy HH:mm"),userFriendly:this._getCommentDateText(o.convertToTimezone(e.createDate))},owner:{id:e.owner.id,fullName:e.owner.firstName+" "+e.owner.lastName,avatarUrl:t.getAvatarUrl(e.owner.id,32),userUrl:t.getNewViewUrl(e.owner.id,"user",!0)},general:{id:e.general.id,name:e.general.name,entityType:{name:n,abbreviation:a},url:t.getNewViewUrl(e.general.id,n,!0)},description:this._getCommentText(e.description)}},_getCommentText:function(e){var r=e.replace(/<img[^>]*>/g,"*image*").replace(/<(?:.|\n)*?>/gm,"").replace(/\s{2,}/g," ");return t("<p>"+r+"</p>").text()},_getCommentDateText:function(e){if(1===o.getDiffInDays(new Date,e)){var t=o.getAge(e,this._configurator.getCurrentDate());return"sec"===t.unit?"1 min ago":t.toString()}return o.formatAs(e,"MMMM d")
},openEntityView:function(e,t){this._configurator.getEntityViewService().showEntityView({entityId:e,entityType:t})}})});