define(["jQuery","tau/core/class","tau/components/component.page.entity","tau/configurations/enum.page.entity.mode","tau/store/factory","tau/components/view.new.list/enum.view.new.list.selector","tau/ui/templates/view.new.list/template.view.new.list.card.viewer"],function(t,e,i,r,n,a,s){var o=e.extend({CURRENT_NULL:{$trigger:t(),cardData:{},component:{destroy:t.noop}},CLASS_MAP:{iconDetailOpened:"tau-icon_name_newwindow-opened",cardDetailsTrigger:"tau-board-list-view_details-view-trigger",editableCell:"tau-elems-cell_unit-editable"},WIDGET_DATA_ID:"ui-tauCoverView",init:function(t){this._configurator=t,this._current=this.CURRENT_NULL},isShown:function(t){return this._current.cardData.id===t.id&&t.entityType===t.entityType},show:function(t,e,i){var r=e.find(a.cardDetailsTriggerIcon),n=this._$getWidget(t),s=this._createComponent(i,n);this._current===this.CURRENT_NULL&&this._doForNameCells(this._disableInlineEdit.bind(this),r),this._setCurrent(i,r,s),n.show(r)},hide:function(){this._$widget&&this._$widget.hide()},destroy:function(){this._$widget&&(this._$widget.widget().remove(),this._$widget.destroy(),this._$widget=null)},_$getWidget:function(t){if(!this._$widget){var e=t.closest(a.appPageEntity);this._$widget=this._$createWidget(e)}return this._$widget},_$createWidget:function(t){var e=s.render();return e.tauCoverView({contentHolderSelector:a.pageEntity,arrow:{$insertAfter:t,positionConfig:{my:"left center",at:"right-12 center"}},autoHide:{onEscape:!0,onOverlayAction:!0,doNotHideSelectors:[a.cardDetailsTrigger],$onScrollOf:t},hide:this._onWidgetHide.bind(this)}),e.insertAfter(t),e.data(this.WIDGET_DATA_ID)},_onWidgetHide:function(){this._doForNameCells(this._enableInlineEdit.bind(this),this._current.$trigger),this._releaseCurrent()},_createComponent:function(t,e){var s=this._configurator.createChild();s.setStoreFactory(new n);var o={context:{configurator:s},id:t.entityId,entity:t.entityType,mode:r.listEntityDetails,progressTargetSelector:a.listEntityDetails},l=i.create(o);return l.on("afterRender",function(t,i){e.setContent(i.element)},this),l.initialize(o),l},_setCurrent:function(t,e,i){this._releaseCurrent(),this._current={cardData:t,$trigger:e,component:i},this._current.originalTriggerTitle=this._current.$trigger.attr("title"),this._current.$trigger.attr("title","Click to close"),this._current.$trigger.addClass(this.CLASS_MAP.iconDetailOpened)},_releaseCurrent:function(){this._current.$trigger.attr("title",this._current.originalTriggerTitle),this._current.$trigger.removeClass(this.CLASS_MAP.iconDetailOpened),this._current.component.destroy(),this._current=this.CURRENT_NULL},_disableInlineEdit:function(t){var e=t.hasClass(this.CLASS_MAP.editableCell);e&&(t.removeClass(this.CLASS_MAP.editableCell),t.data("wasEditable",!0)),t.addClass(this.CLASS_MAP.cardDetailsTrigger)},_enableInlineEdit:function(t){var e=t.data("wasEditable");e&&(t.addClass(this.CLASS_MAP.editableCell),t.removeData("wasEditable")),t.removeClass(this.CLASS_MAP.cardDetailsTrigger)},_doForNameCells:function(e,i){var r=i.closest(".tau-board-list-view"),n=r.find(".tau-board-unit_type_entity-name").parent();n.each(function(){e(t(this))})}});return o});