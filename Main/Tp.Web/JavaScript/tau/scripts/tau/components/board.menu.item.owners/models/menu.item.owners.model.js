define(["require","Underscore","jQuery","tau/core/class","tau/services/boards/view.types"],function(e){var t=e("Underscore"),i=e("jQuery"),r=e("tau/core/class"),n=e("tau/services/boards/view.types");return r.extend({init:function(e,i,r,n,s){this._menuItemKey=e,this._menuItemType=i,this._usersService=r,this._loggedUser=n,this._viewMenuService=s,this._itemApiService=s.getApiForType(i),this.ownersChanged=t.Callbacks(),this.owners=[]},setNewOwnerList:function(e){return!e||this._ownersAreSame(e,t.pluck(this.owners,"id"))?i.Deferred().resolve():i.when(this._usersService.getUsersDetails(e),this._getUnremovableOwners()).then(function(e,i){this.owners=t.map(e,this._buildOwnerModel.bind(this,i)),this._notifyOwnersChanged()}.bind(this))},addOwner:function(e){var i=t.pluck(this.owners,"userId"),r=t.uniq(i.concat(e));this._storeOwners(r)},deleteOwner:function(e){var i=t.chain(this.owners).pluck("userId").without(e).value();this._storeOwners(i)},getIsOwnerListEditable:function(){return this._loggedUser.isAdministrator||t.some(this.owners,t.matches({id:this._loggedUser.id}))},_getUnremovableOwners:function(){var e=[this._loggedUser.id];if(!n.isKnownViewType(this._menuItemType))return i.Deferred().resolve(e);var t=i.Deferred();return this._itemApiService.getViewMenuItem(this._menuItemKey).then(function(e){var t=e.data.menuGroupKey;return t?this._viewMenuService.groupsApi.getViewMenuItem(t):i.Deferred().reject()}.bind(this)).done(function(i){t.resolve(e.concat(i.data.ownerIds))}).fail(function(){t.resolve(e)}),t.promise()},_storeOwners:function(e){return this._itemApiService.updateViewMenuItem(this._menuItemKey,{ownerIds:e}).then(function(e){this.setNewOwnerList(e.data.ownerIds)}.bind(this))},_buildOwnerModel:function(e,i){var r=this;return{id:i.id,displayName:t.trim([i.firstName,i.lastName].join(" "))||i.email,avatarUri:i.avatarUri+"32",getCanDelete:function(){return r.owners.length>1&&r.getIsOwnerListEditable()&&!t.contains(e,i.id)},userId:i.id}},_notifyOwnersChanged:function(){this.ownersChanged.fire()
},_ownersAreSame:function(e,i){return t.isEqual(t.sortBy(e,t.identity),t.sortBy(i,t.identity))}})});