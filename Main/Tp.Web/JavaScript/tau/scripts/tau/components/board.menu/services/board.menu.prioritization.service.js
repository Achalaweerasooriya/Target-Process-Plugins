define(["require","tau/core/class","Underscore","./../models/board.menu.constants"],function(i){"use strict";var r=i("tau/core/class"),e=i("Underscore"),t=i("./../models/board.menu.constants");return r.extend({init:function(i,r){this._viewsMenuService=i,this._loggedUser=r},prioritizeGroup:function(i,r,e,t){var n,o=i.findSectionContainingGroup(r),u=i.findSectionContainingGroup(e),a=i.findGroupById(r),d=i.findGroupById(e);if(!d.getIsUngroupedGroup()){this._viewsMenuService.groupsApi.prioritizeViewMenuItem(r,e,t).then(this._applyGroupPrioritizationResponse.bind(this,i));var s=this._getNewGroupPriority(r,o,e,u,t);null!==s&&(a.updateGroupData({menuNumericPriority:s}),n=!0)}o!==u&&this._changeGroupSection(a,o,u),n&&u.invalidateGroupsOrder()},_applyGroupPrioritizationResponse:function(i,r){var t=r.data.items;e.each(t,function(r){var e=i.findGroupById(r.key);e&&e.menuNumericPriority!==r.menuNumericPriority&&e.updateGroupData({menuNumericPriority:r.menuNumericPriority})},this)},_getNewGroupPriority:function(i,r,t,n,o){var u=r.findGroupIndexById(i);if(0>u)return null;var a=n.viewMenuGroups,d=n.findGroupIndexById(t);if(0>d)return null;if(o&&d++,a.length){var s=e.reject(a,function(i){return i.getIsUngroupedGroup()});return this._calculateTargetPriority(s,d)}return null},prioritizeBoard:function(i,r,e,n,o){var u=i.findBoardById(r),a=i.findGroupContainingBoard(r),d=i.findGroupById(n||t.UNGROUPED_GROUP_KEY);e&&this._viewsMenuService.boardsApi.prioritizeViewMenuItem(r,e,o).then(this._applyBoardPrioritizationResponse.bind(this,i));var s=this._getNewBoardPriority(r,a,e,d,o);null!==s&&(u.updateBoardData({menuNumericPriority:s}),d.invalidateViewsOrder()),this._updateBoardOnDrop(u,a,d)},_applyBoardPrioritizationResponse:function(i,r){var t=r.data.items;e.each(t,function(r){var e=i.findBoardById(r.key);e&&e.menuNumericPriority!==r.menuNumericPriority&&e.updateBoardData({menuNumericPriority:r.menuNumericPriority})},this)},_getNewBoardPriority:function(i,r,e,t,n){var o=r.findBoardIndexById(i);
if(0>o)return null;var u=t.boards,a=e?t.findBoardIndexById(e):0;return 0>a?null:(n&&a++,u.length?this._calculateTargetPriority(u,a):null)},_updateBoardOnDrop:function(i,r,t){var n=i.getCanChangeGroup(this._loggedUser),o=t!==r,u=r.isFavorite!==t.isFavorite,a={};n&&o?(a.isFavorite=t.isFavorite,a.menuGroupKey=t.getIsRegularGroup()?t.groupId:""):u&&(a.isFavorite=t.isFavorite);var d=e.keys(a);if(d.length){var s=e.pick(i,d);this._viewsMenuService.boardsApi.updateViewMenuItem(i.boardId,a,s)}},_calculateTargetPriority:function(i,r){var e=i[r-1]||{menuNumericPriority:i[0].menuNumericPriority-16},t=i[r]||{menuNumericPriority:i[i.length-1].menuNumericPriority+16};return(e.menuNumericPriority+t.menuNumericPriority)/2},_changeGroupSection:function(i,r,e){this._viewsMenuService.groupsApi.updateViewMenuItem(i.groupId,{isFavorite:e.getIsFavoritesSection()},{isFavorite:r.getIsFavoritesSection()})}})});