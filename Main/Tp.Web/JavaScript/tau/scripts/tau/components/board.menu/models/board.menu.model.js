define(["require","Underscore","tau/core/class","./../services/board.menu.prioritization.service","./board.menu.board.group","./board.menu.section.collection"],function(e){"use strict";var i=e("Underscore"),o=e("tau/core/class"),t=e("./../services/board.menu.prioritization.service"),r=e("./board.menu.board.group"),n=e("./board.menu.section.collection");return o.extend({viewMenuSections:null,init:function(e,i,o,r,s){this._componentBus=e,this._loggedUser=i,this._urlService=o.viewsMenuUrlService,this._boardsOperationsService=r,this._viewsMenuService=o,this._boardSettingsService=s,this._boardSettingsService.currentBoardChanged.add(this._onCurrentBoardChanged,this),this.viewMenuSections=new n,this.viewMenuSections.sectionCollectionUpdated.add(this._updateViewsMenu,this),this._prioritization=new t(this._viewsMenuService,this._loggedUser),this._subscribeToAcidChanges()},loadBoards:function(){return this._viewsMenuService.getViewsMenuForUser().then(function(e){this.viewMenuSections.setSections(e),this._subscribeToApiServiceChanges()}.bind(this))},_createBoardGroupModel:function(e){return new r(this._urlService,e)},_updateViewsMenu:function(){this._componentBus.fire("board.menu.update.all",this.viewMenuSections)},expandGroup:function(e){if(e){var i=this.viewMenuSections.findGroupById(e);i&&i.getIsRegularGroup()&&!i.isExpanded&&this._viewsMenuService.groupsApi.updateViewMenuItem(i.groupId,{isExpanded:!0})}},prioritizeGroup:function(e,i,o){this._prioritization.prioritizeGroup(this.viewMenuSections,e,i,o)},prioritizeBoard:function(e,i,o,t){this._prioritization.prioritizeBoard(this.viewMenuSections,e,i,o,t)},findBoardDataToReplaceDeleted:function(e){var o=i.chain(this.viewMenuSections.getAllViewGroups()).flatMap(i.property("boards")).map(i.property("storedBoardData")).value();return this._boardsOperationsService.getNextBoardAfterDeleted(o,e)},_subscribeToAcidChanges:function(){this._clearAcidSubscription(),this._urlService.acidUpdated.add(this._onAcidUpdated,this)},_onAcidUpdated:function(){this.viewMenuSections.applyAcidToViews()
},_subscribeToApiServiceChanges:function(){this._clearApiSubscriptions();var e=this._viewsMenuService.boardsApi;e.on("service.views.api.created.board",function(e,i){this._onBoardCreated(i)},this),e.on("service.views.api.updating.board",function(e,i){this._onBoardUpdated(i)},this),e.on("service.views.api.updated.board",function(e,i){this._onBoardUpdated(i)},this),e.on("service.views.api.removed.board",function(e,i){this._onBoardRemoved(i)},this),e.on("service.views.api.removing.board",function(e,i){this._onBoardRemoved(i)},this);var i=this._viewsMenuService.groupsApi;i.on("service.views.api.created.group",function(e,i){this._onBoardGroupCreated(i)},this),i.on("service.views.api.updating.group",function(e,i){this._onBoardGroupUpdated(i)},this),i.on("service.views.api.updated.group",function(e,i){this._onBoardGroupUpdated(i)},this),i.on("service.views.api.removed.group",function(e,i){this._onBoardGroupRemoved(i)},this)},_onBoardCreated:function(e){this.viewMenuSections.findAppropriateGroupForBoard(e).createBoardInGroup(e)},_onBoardGroupCreated:function(e){this.viewMenuSections.findGroupById(e.key)||this.viewMenuSections.createGroupInSection(this._createBoardGroupModel(e))},_onBoardUpdated:function(e){this.viewMenuSections.applyBoardUpdates(e)||this._onBoardCreated(e)},_onBoardGroupUpdated:function(e){var o=this.viewMenuSections.findGroupById(e.key);if(!o)return void this._onBoardGroupCreated(e);var t=o?o.boards:[],r=o&&o.isFavorite&&i.has(e,"isFavorite")&&!e.isFavorite;this.viewMenuSections.applyGroupUpdates(e),r&&i.each(t,function(e){e.isFavorite&&this._viewsMenuService.boardsApi.updateViewMenuItem(e.boardId,{isFavorite:!1},{isFavorite:e.isFavorite})},this)},_onBoardRemoved:function(e){this.viewMenuSections.removeView(e)},_onBoardGroupRemoved:function(e){var o=this.viewMenuSections.findGroupById(e);if(o){var t=o.boards,r=o.isFavorite,n=this.viewMenuSections.findSectionContainingGroup(e);n&&n.removeMenuGroup(e),r&&i.each(t,function(e){e.isFavorite||this._viewsMenuService.boardsApi.updateViewMenuItem(e.boardId,{isFavorite:!0},{isFavorite:e.isFavorite})
},this)}},_onCurrentBoardChanged:function(){var e=this._boardSettingsService.getCurrentSettings().id;this._componentBus.fire("board.menu.switch.board",e)},_clearApiSubscriptions:function(){var e=[this._viewsMenuService.boardsApi,this._viewsMenuService.groupsApi];i.each(e,function(e){e.removeAllListeners(this)},this)},_clearAcidSubscription:function(){this._urlService.acidUpdated.remove(this)},destroy:function(){this._clearApiSubscriptions(),this._clearAcidSubscription()}})});