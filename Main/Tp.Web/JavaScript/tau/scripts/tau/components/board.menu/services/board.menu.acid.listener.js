define(["require","Underscore","jQuery"],function(e){var r=e("Underscore"),i=e("jQuery");return{getAcidTokenStream:function(e){var n,a={},t=r.Callbacks(),c=i.Deferred(),d={callback:t,getPromise:function(){return c.promise()},getValue:function(){if(!n)throw new Error("Acid value is not available yet");return n.value}},l=function(e,r){var a={id:e,acid:r};n={value:a},"pending"==c.state()?c.resolve(a):c=i.Deferred().resolve(a),t.fire(a)};return e.get({fields:["acid"],callback:function(e){l(e.id,e.acid)}}),e.unbind({listener:a}),e.bind({listener:a,fields:["acid"],callback:function(r){l(e.settings.id,r.acid)}}),d}}});