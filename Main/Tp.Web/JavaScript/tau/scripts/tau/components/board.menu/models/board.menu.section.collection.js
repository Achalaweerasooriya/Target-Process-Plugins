define(["require","tau/core/class","Underscore","tau/utils/debug/utils.debug","./board.menu.section","./board.menu.board.group"],function(e){var t=e("tau/core/class"),r=e("Underscore"),i=e("tau/utils/debug/utils.debug"),n=e("./board.menu.section"),o=e("./board.menu.board.group"),u=t.extend({init:function(){this.sectionCollectionUpdated=r.Callbacks(),this.items=[]},setSections:function(e){this.items=e,r.each(e,function(e){e.viewsMenuSectionUpdated.add(this._onSectionUpdated,this)},this),this.sectionCollectionUpdated.fire(this)},applyBoardUpdates:function(e){var t=e.key,r=this.findBoardById(t);if(!r)return!1;var i=r.menuNumericPriority;e=r.getUpdatedBoardData(e);var n=e.menuNumericPriority,o=this.findGroupContainingView(t),u=this.findAppropriateGroupForView(e);return o&&u&&o!=u&&(r=o.moveBoardToGroup(e.key,u)),r.updateBoardData(e),u&&i!==n&&u.invalidateViewsOrder(),!0},applyGroupUpdates:function(e){var t=e.key,i=this.findGroupById(t);if(!i)return!1;var n=i.menuNumericPriority;e=i.getUpdatedGroupData(e);var o=e.menuNumericPriority,u=this.findSectionContainingGroup(t),a=this.findAppropriateSectionForGroup(e),s=u&&a&&u!=a,p=i.boards;if(s){var d=a.getUngroupedGroup(),c=r.filter(d.boards,r.matches({menuGroupKey:t}));u.moveGroupToSection(i,a),r.each(c,function(e){d.moveBoardToGroup(e.boardId,i)})}return i.updateGroupData(e),s&&r.each(p,function(e){var t=this.findAppropriateGroupForView(e);t!==i&&i.moveBoardToGroup(e.boardId,t)},this),a&&n!==o&&a.invalidateGroupsOrder(),!0},createGroupInSection:function(e){var t=this.findAppropriateSectionForGroup(e);if(t){t.addMenuGroup(e);var i=r.filter(this.getAllBoards(),r.matches({menuGroupKey:e.groupId}));r.each(i,function(t){var r=this.findAppropriateGroupForView(t);if(r===e){var i=this.findGroupContainingView(t.boardId);i.moveBoardToGroup(t.boardId,r)}},this)}},removeView:function(e){var t=this.findGroupContainingView(e);return t?t.removeBoard(e):null},findAppropriateGroupForView:function(e){var t=this.findGroupById(e.menuGroupKey);return e.isFavorite?t&&t.isFavorite?t:this._getFavoritesGroup():(t||(t=this._getUngroupedOtherGroup()),t)
},findAppropriateSectionForGroup:function(e){return e.isFavorite?this._getFavoritesSection():this.getOtherSection()},findBoardById:function(e){var t=r.flatMap(this.getAllViewGroups(),r.property("boards"));return r.findWhere(t,{boardId:e})},findFirstVisibleViewData:function(e){function t(e){return r.chain(e).flatMap(r.property("boards")).filter(function(e){return e.menuIsVisible&&i(e)}).pluck("storedViewData").first().value()}var i=e?function(t){return!r.contains(e,t.boardId)}:r.constant(!0),n=r.flatMap(this.items,r.property("viewMenuGroups"));return t(r.where(n,{menuIsVisible:!0}))||t(n)},findGroupContainingView:function(e){var t=r.matches({boardId:e});return r.find(this.getAllViewGroups(),function(e){return r.some(e.boards,t)})},findSectionContainingGroup:function(e){var t=r.matches({groupId:e});return r.find(this.items,function(e){return r.some(e.viewMenuGroups,t)})},_getFavoritesSection:function(){return r.find(this.items,function(e){return e.getIsFavoritesSection()})},getOtherSection:function(){return r.find(this.items,function(e){return e.getIsOthersSection()})},_getFavoritesGroup:function(){return this._getSingleSectionGroup(this._getFavoritesSection(),function(e){return e.getIsFavoriteUngroupedGroup()},"There should be one and only one favorites group")},_getUngroupedOtherGroup:function(){return this._getSingleSectionGroup(this.getOtherSection(),function(e){return e.getIsUngroupedGroup()},'There should be one and only one "others" group')},_getSingleSectionGroup:function(e,t,n){var o=r.filter(e.viewMenuGroups,t);return i.assertError(1===o.length,n),o[0]},findGroupById:function(e){return r.findWhere(this.getAllViewGroups(),{groupId:e})},getAllBoards:function(){return r.flatMap(this.getAllViewGroups(),r.property("boards"))},getAllViewGroups:function(){return r.flatMap(this.items,r.property("viewMenuGroups"))},hasHiddenItems:function(){var e=function(e){return!e.menuIsVisible},t=function(t){return e(t)||r.any(t.boards,e)};return r.any(this.items,function(e){return r.any(e.viewMenuGroups,t)
})},_onSectionUpdated:function(){this.sectionCollectionUpdated.fire(this)},applyAcidToViews:function(){r.each(this.items,function(e){r.each(e.viewMenuGroups,function(e){r.each(e.boards,function(e){e.applyGlobalAcidSilently()})})}),this._onSectionUpdated()}});return u.createFromMenuStructure=function(e,t){var i=r.filter(e,r.matches({itemType:"section"}));return r.map(i,function(e){var i=r.chain(e.children).filter(r.matches({itemType:"group"})).map(function(e){var i=r.chain(e.children).map(r.property("itemData")).value(),n=r.defaults({boards:i},e.itemData);return new o(t,n)},this).value();return new n(t,{sectionType:e.itemData.sectionType,groups:i})},this)},u});