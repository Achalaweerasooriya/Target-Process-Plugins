define(["require","tau/core/class","Underscore","tau/utils/utils.debug","./board.menu.section","./board.menu.board.group"],function(r){var t=r("tau/core/class"),e=r("Underscore"),o=r("tau/utils/utils.debug"),i=r("./board.menu.section"),n=r("./board.menu.board.group"),u=t.extend({init:function(){this.sectionCollectionUpdated=e.Callbacks(),this.items=[]},setSections:function(r){this.items=r,e.each(r,function(r){r.viewsMenuSectionUpdated.add(this._onSectionUpdated,this)},this),this.sectionCollectionUpdated.fire(this)},applyBoardUpdates:function(r){var t=r.key,e=this.findBoardById(t);if(!e)return!1;var o=e.menuNumericPriority;r=e.getUpdatedBoardData(r);var i=r.menuNumericPriority,n=this.findGroupContainingBoard(t),u=this.findAppropriateGroupForBoard(r);return n&&u&&n!=u&&(e=n.moveBoardToGroup(r.key,u)),e.updateBoardData(r),u&&o!==i&&u.invalidateViewsOrder(),!0},applyGroupUpdates:function(r){var t=r.key,o=this.findGroupById(t);if(!o)return!1;var i=o.menuNumericPriority;r=o.getUpdatedGroupData(r);var n=r.menuNumericPriority,u=this.findSectionContainingGroup(t),a=this.findAppropriateSectionForGroup(r),s=u&&a&&u!=a,d=o.boards;if(s){var p=a.getUngroupedGroup(),c=e.filter(p.boards,e.matches({menuGroupKey:t}));u.moveGroupToSection(o,a),e.each(c,function(r){p.moveBoardToGroup(r.boardId,o)})}return o.updateGroupData(r),s&&e.each(d,function(r){var t=this.findAppropriateGroupForBoard(r);t!==o&&o.moveBoardToGroup(r.boardId,t)},this),a&&i!==n&&a.invalidateGroupsOrder(),!0},createGroupInSection:function(r){var t=this.findAppropriateSectionForGroup(r);if(t){t.addMenuGroup(r);var o=e.filter(this.getAllBoards(),e.matches({menuGroupKey:r.groupId}));e.each(o,function(t){var e=this.findAppropriateGroupForBoard(t);if(e===r){var o=this.findGroupContainingBoard(t.boardId);o.moveBoardToGroup(t.boardId,e)}},this)}},removeView:function(r){var t=this.findGroupContainingBoard(r);return t?t.removeBoard(r):null},findAppropriateGroupForBoard:function(r){var t=this.findGroupById(r.menuGroupKey);return r.isFavorite?t&&t.isFavorite?t:this._getFavoritesGroup():(t||(t=this._getUngroupedOtherGroup()),t)
},findAppropriateSectionForGroup:function(r){return r.isFavorite?this._getFavoritesSection():this.getOtherSection()},findBoardById:function(r){var t=e.flatMap(this.getAllViewGroups(),e.property("boards"));return e.findWhere(t,{boardId:r})},findGroupContainingBoard:function(r){var t=e.matches({boardId:r});return e.find(this.getAllViewGroups(),function(r){return e.some(r.boards,t)})},findSectionContainingGroup:function(r){var t=e.matches({groupId:r});return e.find(this.items,function(r){return e.some(r.viewMenuGroups,t)})},_getFavoritesSection:function(){return e.find(this.items,function(r){return r.getIsFavoritesSection()})},getOtherSection:function(){return e.find(this.items,function(r){return r.getIsOthersSection()})},_getFavoritesGroup:function(){return this._getSingleSectionGroup(this._getFavoritesSection(),function(r){return r.getIsFavoriteUngroupedGroup()},"There should be one and only one favorites group")},_getUngroupedOtherGroup:function(){return this._getSingleSectionGroup(this.getOtherSection(),function(r){return r.getIsUngroupedGroup()},'There should be one and only one "others" group')},_getSingleSectionGroup:function(r,t,i){var n=e.filter(r.viewMenuGroups,t);return o.assertError(1===n.length,i),n[0]},findGroupById:function(r){return e.findWhere(this.getAllViewGroups(),{groupId:r})},getAllBoards:function(){return e.flatMap(this.getAllViewGroups(),e.property("boards"))},getAllViewGroups:function(){return e.flatMap(this.items,e.property("viewMenuGroups"))},hasHiddenItems:function(){var r=function(r){return!r.menuIsVisible},t=function(t){return r(t)||e.any(t.boards,r)};return e.any(this.items,function(r){return e.any(r.viewMenuGroups,t)})},_onSectionUpdated:function(){this.sectionCollectionUpdated.fire(this)},applyAcidToViews:function(){e.each(this.items,function(r){e.each(r.viewMenuGroups,function(r){e.each(r.boards,function(r){r.applyGlobalAcid()})})})}});return u.createFromMenuStructure=function(r,t){var o=e.filter(r,e.matches({itemType:"section"}));return e.map(o,function(r){var o=e.chain(r.children).filter(e.matches({itemType:"group"})).map(function(r){var o=e.chain(r.children).filter(e.matches({itemType:"board"})).map(e.property("itemData")).value(),i=e.defaults({boards:o},r.itemData);
return new n(t,i)},this).value();return new i(t,{sectionType:r.itemData.sectionType,groups:o})},this)},u});