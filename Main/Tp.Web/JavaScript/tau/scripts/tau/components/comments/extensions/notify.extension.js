define(["require","Underscore","jQuery","tau/components/extensions/component.extension.base","tau/utils/utils.convertUserName","tau/utils/utils.htmlConverter"],function(e){var t=e("Underscore"),n=e("jQuery"),i=e("tau/components/extensions/component.extension.base"),r=e("tau/utils/utils.convertUserName"),s=e("tau/utils/utils.htmlConverter");return i.extend({category:"edit","bus afterRender":function(e,t){this.firstRender||(this.$oldDescription=t.element.clone(!0),this.firstRender=!0)},"bus afterRender:last + applyUpdate":function(e,n,i){var r={config:this.config};this.globalSettings=r.config.context.applicationContext.globalSettings||{},this._getUsersNotify(i,this.config,this.$oldDescription).then(this.safeCallback(function(e){if(this.$oldDescription=n.element.clone(!0),e=t.compact(e),e.length>0)if(this.globalSettings.IsEmailNotificationsEnabled){e=t.chain(e).pluck("name").uniq().compact().value();var i=this._buildMessage(e);this._callErrorBarServiceWithMessage(i,this.config)}else this._callErrorBarServiceWithMessage("No email notification was sent as Email Notifications are disabled in System Settings.",this.config,!0)}.bind(this)))},_getFromNotificationPractices:function(e,i){var r=e["comment-practices-notification-opts"],s=i.context.entity,a={Owner:this._getOwnerName,Assigned:this._getNamesAssignmentUsers,Team:this._getProjectTeam,Requesters:this._getRequesters},o=t.reduce(r,function(e,t,n){return t&&e.push(a[n]),e},[]),c={entity:s},u=t.map(o,function(e){return e.call(this,c)},this);return n.when.all(u).then(function(e){return t.chain(e).flatten().reject(function(e){return e.id==i.context.configurator.getLoggedUser().id}).value()},function(){return[]})},_buildMessage:function(e){var n="Email notification was sent",i=" to ",r=n+i;return e.length>3?r+=e.length+" people":(r+=t.compact(e).join(", "),r==n+i&&(r=n)),r},_getOwnerName:function(e){var t=e.entity,n=t.entityType.name,i=t.id;return this.store.getDef(n,{id:i,fields:["id",{owner:["id","firstName","lastName","email"]}]}).then(function(e){return{id:e.owner.id,name:r.getFullName(e.owner)}
})},_getProjectTeam:function(){return{name:null}},_getRequesters:function(e){var n=e.entity,i=n.entityType.name,s=n.id,a={};return a.requesters=["id","firstName","lastName","avatarUri","email"],this.store.getDef(i,{id:s,fields:["id",a]}).then(function(e){return t.map(e.requesters,function(e){return{id:e.id,name:r.getFullName(e)}})})},_getUsersFromMention:function(e,i,r){var s=n("<div>"+e+"</div>").find("[data-mention]"),a=i.find('[data-id="'+r+'"]').find("[data-mention]"),o=function(e){return t.map(e,function(e){return n(e).data("mention")})},c=o(a);return t.reduce(s,function(e,i){var r=n(i);return t.contains(c,r.data("mention"))||e.push({name:r.text()}),e},[])},_getNamesAssignmentUsers:function(e){var n=e.entity,i=n.entityType.name,s=n.id,a={},o="project"==i?"projectMembers":"assignments",c="project"==i?{user:["id","firstName","lastName","avatarUri","email"]}:{generalUser:["id","firstName","lastName","avatarUri","email"]};return a[o]=[c],this.store.getDef(i,{id:s,fields:["id",a]}).then(function(e){return t.map(e.assignments||e.projectMembers,function(e){var t=e.generalUser||e.user;return{id:t.id,name:r.getFullName(t)}})})},_getUsersNotify:function(e,t,i){var r=this._getUsersFromMention(s.fromSourceToHtml(e.cmd.config.$set.description),i,e.id),a=this._getFromNotificationPractices(e.cmd,t);return n.when(r,a).then(function(e,t){return e.concat(t)})},_callErrorBarServiceWithMessage:function(e,t,n){n=n||!1;var i=n?"warning":"success",r=t.context.configurator.service("errorBar");r.fire("notification",{$node:e,delay:1e4,type:i,disableAutoClose:!1})}})});