define(["require","Underscore","tau/components/extensions/component.extension.base","tau/components/comments/templates/comments.actions.template","../comment.editor","tau/utils/utils.editors","tau/ui/behaviour/common/ui.behaviour.richeditor"],function(t){var e=t("Underscore"),o=t("tau/components/extensions/component.extension.base"),n=t("tau/components/comments/templates/comments.actions.template"),i=t("../comment.editor"),s=t("tau/utils/utils.editors");return t("tau/ui/behaviour/common/ui.behaviour.richeditor"),o.extend({category:"edit",destroy:function(){this.destroyDynamicComponents(),this._super()},lifeCycleCleanUp:function(){this.destroyDynamicComponents(),this._super()},destroyDynamicComponents:function(){this.componentList&&(this.componentList.destroy(),delete this.componentList)},"bus applyTo + permissionsReady + editorModelsReady":function(t,e,o,n){this._replyEditorModel=n.replyEditorModel,this._commentEditorModel=n.commentEditorModel,this.applyPermissions(e.config,e.data,e.element,o)},"bus applyTo":function(t,e){this.comment=e.data},_detectEditorType:function(t){var e=this.config.context,o=e.entity.entityType.name;return e.configurator.getGlobalSettingsService().getGlobalSettings().then(function(e){return s.detectEditorType(e,t,o)})},applyPermissions:function(t,o,i,s){var r=this.config=e.extend({},t,{comment:o}),c=this.element=i,d=c.children(".ui-comment-body"),m=this.config.context.configurator.getTemplateFactory().get(n.name).bind({},s);d.children(".ui-comment-heading").append(m.eq(0)),d.append(m.eq(1)),s.editable&&d.addClass("editable"),s.deletable&&d.addClass("deletable"),m.on("click",".reply",e.bind(this.onReply,this,o.owner)),m.on("click",".edit",e.bind(this.onEdit,this)),m.on("click",".delete",e.bind(this.onDelete,this));var a=c.children(".ui-comments"),l={components:[{type:"commentList"}],context:r.context};this.componentList||this.createComponents(l,e.bind(function(t){var n=t[0],i={element:a,data:{comments:o.comments||[]},config:e.extend({},n.config,{commentId:this.config.comment.id})};
this.componentList=n.component,n.component.fire("applyTo",i)},this))},showEditorForEdit:function(){var t=this.config.context.configurator;this._detectEditorType(this._commentEditorModel.getEditorText()).then(function(e){var o=new i({configurator:t,editorModel:this._commentEditorModel,editorType:e,extension:this,$editor:this.element.find("> .ui-comment-body > .ui-comment-text"),mentionConfig:{configurator:t},pluginConfig:{uploadUrl:t.getApplicationPath()+"/UploadFile.ashx"}});o.showEditor()}.bind(this))},showEditorForReply:function(t){var e=this.config.context.configurator;this._detectEditorType(this._replyEditorModel.getEditorText()).then(function(o){var n=new i({configurator:e,editorModel:this._replyEditorModel,extension:this,editorType:o,$editor:this.element.find("> .ui-comment-body > .ui-comment-reply > .ui-editor-placeholder"),mentionConfig:{configurator:e,mentionUser:t},pluginConfig:{uploadUrl:e.getApplicationPath()+"/UploadFile.ashx"}});n.showEditor()}.bind(this))},onReply:function(t,e){e.stopPropagation(),e.preventDefault(),this.showEditorForReply(t)},onEdit:function(t){t.stopPropagation(),t.preventDefault(),this.showEditorForEdit()},onDelete:function(){var t=this.element.find("> .ui-comment-body");t.confirmation({message:"Delete comment?",ok:e.bind(this.onConfirmDelete,this),cancel:e.bind(this.onCancelDelete,this)}),t.confirmation("show")},onCancelDelete:function(t){t.stopPropagation(),t.preventDefault(),this.element.find("> .ui-comment-body").confirmation("hide")},onConfirmDelete:function(t){t.stopPropagation(),t.preventDefault(),this.fire("deleteComment")}})});