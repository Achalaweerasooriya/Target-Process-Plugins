define(["Underscore","tau/core/types.targetprocess"],function(a,b){return{typeContainSimpleField:function(b,c){return a.find(b.simpleFields,function(a){return a===c})},registerRules:function(c,d){this.registeredEntityTypes={},this.rules=c,a.each(b.getDictionary(),this.registerType,this),c.register({type:"feature",changes:["initialEstimate"],fields:["timeRemain"]}),c.register({type:"iteration",changes:["startDate"],fields:["endDate"]}),c.register({type:"iteration",changes:["endDate"],fields:["startDate"]}),c.register({type:"testPlanRun",changes:["release"],fields:[{build:["id","name"]}]}),c.register({type:"testPlanRun",changes:["iteration"],fields:[{build:["id","name"]}]}),c.registerRule({name:"auto-include-before-save",type:"roleEffort",changes:["effort"],fields:[{assignable:["id","effort","effortToDo","effortCompleted","timeSpent","timeRemain"]}]}),c.registerRule({name:"auto-include-before-save",type:"task",changes:["entityState"],fields:[{userStory:["id",{entityState:["id","name","isInitial","isFinal","isPlanned","isCommentRequired"]}]}]}),c.registerRule({name:"auto-action-after-save",type:"roleEffort",changes:["effort"],action:function(b){var c=b.store,d=b.data.obj;c.get(d.type,{id:d.id,fields:[{assignable:["id"]}]}).done({success:function(b){b=b[0];var d=b.data.assignable.id,e=b.data.assignable.__type,f={task:[{userStory:["id","effort","effortToDo","effortCompleted","timeSpent","timeRemain","tasks-count","tasks-effort-sum","tasks-effortToDo-sum"]}],userStory:[{iteration:["userStories-effortToDo-sum","userStories-effortCompleted-sum"]},{release:["userStories-effortToDo-sum","userStories-effortCompleted-sum"]},{feature:["userStories-count","effort","effortToDo","effortCompleted","timeSpent","timeRemain"]}],bug:[{iteration:["bugs-effortToDo-sum","bugs-effortCompleted-sum"]},{release:["bugs-effortToDo-sum","bugs-effortCompleted-sum"]}]},g=f[e];if(g){var h=a(g).filter(function(b){var f=a.getFieldName(b);return c.isPropertyInitialized(d,e,f)});h.length&&c.refresh(e,{id:d,fields:h}).done()}}})}}),c.registerRule({name:"auto-action-after-save",type:"comment",action:function(b){var c=b.data,e=c.cmd["comment-practices-notification-opts"];if(e&&a(e).keys().length){var f=d.getNotificationService();f.notifyComment(c.id,e)}}})},registerType:function(b){var c=this.registeredEntityTypes,d=this.rules;if(!c.hasOwnProperty(b.name)){c[b.name]=!0,a.each(b.aliases,function(a){c[a]=!0});var e="endDate";b.refs.hasOwnProperty("entityState")&&this.typeContainSimpleField(b,e)&&(d.register({type:b.name,changes:["entityState"],fields:["endDate"]}),d.register({type:b.name,changes:["entityState"],fields:[{roleEfforts:["effort","effortToDo"]}]}))}}}})