define(["./api.nocache","jQuery","Underscore"],function(e,r,c){return e.extend({_cache:{},_getCacheKey:function(e,r){var t=this,a=e.url.toLowerCase(),n=r.$config.$key||r.$config.key,o=r.$config.$group||r.$config.group;if(o&&n&&(a=this._createCacheNameFromGroupAndKey(o,n)),n||"POST"!==e.type||(a=null),"POST"===e.type||"DELETE"===e.type){var h=t._cache[t.getGroupCacheKey(o)];if(h){var i=c.keys(h);c.each(i,function(e){delete t._cache[e]}),delete t._cache[t.getGroupCacheKey(o)]}}return a},_makeServiceCall:function(e,r,c){var t=this,a=this._getCacheKey(e,r);return e.type&&"GET"!==e.type||!t._cache.hasOwnProperty(a)?(a&&(t._cache[a]=r),this._super(e,r,c)):t._cache[a]},getGroupCacheKey:function(e){return("group_cache_"+e).toLowerCase()},getServiceDeferred:function(e,r){return this._super(e).done(function(c){this._trySaveCacheByGroupAndKey(c,r)||this._saveCacheByGroupOrUrl(e,r)}.bind(this)).fail(function(){var c=this._getCacheKey(e,r);c&&delete this._cache[c]}.bind(this))},_trySaveCacheByGroupAndKey:function(e,r){return e&&e.group&&e.key?(this._cache[this._createCacheNameFromGroupAndKey(e.group.name,e.key)]=r,!0):!1},_saveCacheByGroupOrUrl:function(e,r){var c=r.$config.$group||r.$config.group,t=this.getGroupCacheKey(c);this._cache.hasOwnProperty(t)||(this._cache[t]={}),this._cache[t][e.url.toLowerCase()]={}},_createCacheNameFromGroupAndKey:function(e,r){return(e+"_"+r).toLowerCase()}})});