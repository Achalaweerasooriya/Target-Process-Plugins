define(["tau/core/bus","jQuery","Underscore","./url.resolver","tau/core/event","tau/utils/utils.api"],function(e,r,t,a,n,i){var o=function(e){e=e||{};var r=["key","ownerIds","scope","id","group","data","userData","publicData"],a=t.difference(t.keys(e),r);return t.each(a,function(r){e[r]=JSON.parse(e[r])}),e.publicData&&(e.publicData=o(e.publicData)),e.userData&&(e.userData=o(e.userData)),e},s=function(e){if(!e)return null;var r=(e?JSON.parse(e):null)||{},a=[];return r.items?(t.each(r.items,function(e){a.push(o(e))}),a):o(r)},u=e.extend({config:null,init:function(e){this.config=e||{},t.defaults(this.config,{service:r.ajax})},getServiceDeferred:function(e){return this.config.service(e)},_makeServiceCall:function(e,r,a){var n=this,i=function(e){a.data=e,e&&(e.publicData||e.userData)&&(a.value=t.extend({},e.publicData,e.userData)),r.resolve(a)};return n.getServiceDeferred(e,r).done(i).fail(function(e){if(0!==e.status){try{e.responseText=JSON.parse(e.responseText)}catch(t){e.responseText={message:e.statusText}}a.data=e,r.reject(a);var i=e.responseText;n.fire("error",i)}}),r},resolve:function(e){var r=e.$config,n=a.resolve(e.$config),o={url:n,dataType:"json",$scope:r,converters:{"text json":s}},u={ajaxConfig:o,config:r};if("DELETE"===r.$actionType)o.type="POST",o.contentType="application/json; charset=utf-8",o.beforeSend=function(e){e.setRequestHeader("X-HTTP-Method-Override","DELETE")};else if(r.$value){var c=t.clone(r.$value);c.userData=i.convertJsonNode(c.userData),c.publicData=i.convertJsonNode(c.publicData),o.type="POST",o.contentType="application/json; charset=utf-8",o.data=JSON.stringify(c)}return this._makeServiceCall(o,e,u)},select:function(e,r){return r.$group=e,this.resolveDeferred(r)},remove:function(e,a){a.$group=e,a.$actionType="DELETE",this.fire("beforeRemove",a);var n=r.Deferred();return n.$config=a,n.always(t.bind(function(){this.fire("afterRemove",a)},this,a)),this.resolve(n),n},data:function(e,a,n,i){if(!e)throw new Error("group is required");t.isObject(a)&&(n=a,a=null),!n||n.hasOwnProperty("publicData")||n.hasOwnProperty("userData")||(n={userData:n}),i=t.extend({},i,{$group:e,$key:a,$value:n});var o={};o=a?{before:"beforeUpdate",after:"afterUpdate"}:{before:"beforeInsert",after:"afterInsert"},this.fire(o.before,i);var s=r.Deferred();return s.$config=i,s.always(t.bind(function(){this.fire(o.after,i)},this,i)),this.resolve(s)},createDeferredCall:function(e){var t=r.Deferred();return t.$config=e,t},resolveDeferred:function(e){return this.resolve(this.createDeferredCall(e))}});return n.implementOn(u.prototype),u});