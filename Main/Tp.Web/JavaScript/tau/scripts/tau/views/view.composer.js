define(["Underscore","jQuery","tau/core/view-base","tau/core/event-dispatcher"],function(_,$,ViewBase,EventDispatcher){var ComposerView=ViewBase.extend({init:function(config){this._loaded=!1,this._super(config)},initialize:function(){var self=this,children=self.config.children,loadDependencies=_.isArray(children)&&_.size(children)>0&&self.config.visible;if(loadDependencies){var components=self.config.children,context=self.config.context||{};this.fire("createComponents",{components:components,context:context})}else self._super.apply(self,arguments),self._fireChildrenRendered({children:[],childrenEvtArgs:[]})},"bus componentCreated":function(evtArgs){var component=evtArgs.data.component;this.fire("childComponentCreated",component)},"bus componentsCreated":function(evtArgs){this.fire("beforeComponentsInitialize",evtArgs.data),this.initializeChildrenComponents(evtArgs),this.fire("afterComponentsInitialize",evtArgs.data)},initializeChildrenComponents:function(evtArgs){var self=this,childrenComponents=_(evtArgs.data).pluck("component"),childrenConfigs=_(evtArgs.data).pluck("config");self.dispatcher=new EventDispatcher(childrenComponents),self.dispatcher.listen("afterInit",function(evt){self.fireAfterInit()}),self.dispatcher.listen("afterRender",function(evt){var childrenEvtArgs=evt.argsArr,data={children:childrenComponents,childrenEvtArgs:childrenEvtArgs};self._fireChildrenRendered(data)}),_(childrenComponents).each(function(c,index){c.fire("initialize",childrenConfigs[index])})},_fireChildrenRendered:function(childrenData){this.fire("internalChildrenRendered",childrenData)},"bus afterInit+dataBind":function(evts){},"bus afterInit+dataBind+internalChildrenRendered":function(evts){this.destroyChildComponents();var self=this,afterInitEvtData=evts.afterInit.data,dataBindEvtData=evts.dataBind.data,internalChildrenRenderedEvtData=evts.internalChildrenRendered.data;self.children=internalChildrenRenderedEvtData.children,self.config.visible&&(self._loaded=!0);if(internalChildrenRenderedEvtData.children.length===0)self.render(dataBindEvtData,afterInitEvtData);else{self.fireBeforeRender({data:dataBindEvtData});var newElement=self.bindTemplate(dataBindEvtData);newElement.find("[runas]").each(function(i,node){var $el=$(this),componentType=$el.attr("runas"),componentId=$el.attr("componentId"),detectedItem=_(internalChildrenRenderedEvtData.childrenEvtArgs).detect(function(item,i){var itemCfg=item.view.config;return itemCfg.type===componentType&&itemCfg.id.toString()===componentId});if(!detectedItem){var message='Component "'+componentId+'" type of ['+componentType+"] not found";throw message}var $ctrlElement=detectedItem.element;$el.replaceWith($ctrlElement)}),newElement=self.prepareElement(newElement),self.fire("childrenRendered",internalChildrenRenderedEvtData.children),self.updateElement(newElement,afterInitEvtData.refreshSelector),!self.config.visible&&self.hide(),self.fireAfterRender({data:dataBindEvtData})}},"bus show":function(){this._super(),this._loaded||this.fire("initialize",{})},lifeCycleCleanUp:function(){this._super()},destroyChildComponents:function(){delete this.dispatcher;var item=null;if(this.children&&this.children.length)while(item=this.children.pop())item.destroy();delete this.children},destroy:function(){this.destroyChildComponents(),this._super()}});return ComposerView})