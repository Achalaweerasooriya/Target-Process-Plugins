define(["require","Underscore","tau/core/view-base","tau/components/component.container","tau/configurations/factory.container.config","tau/components/extensions/customField/extension.customField.multipleEntities.count.label.setter","tau/configurations/enum.page.entity.mode"],function(e){var t=e("Underscore"),n=e("tau/core/view-base"),i=e("tau/components/component.container"),o=e("tau/configurations/factory.container.config"),r=e("tau/components/extensions/customField/extension.customField.multipleEntities.count.label.setter"),a=e("tau/configurations/enum.page.entity.mode");return n.extend({init:function(e){this.tausInitialLoad=taus.start("statistics_view",{"@":["--add-last-view-entity-context"],tags:["initial load"]}),this._super(e),this.config.placeholder&&this.config.placeholder.addClass("ui-entity-view")},"container afterInit":function(){this.fireAfterInit()},initialize:function(){},"container afterRender":function(e,t){this.tausInitialLoad&&this.tausInitialLoad.stop(),this.render(t.element)},"bus configurator.ready:last + loadingError.ready":function(e,t,n){t.getTitleManager().set(n.message);var i=t.getHistory().pop(),o=t.getTemplateFactory().get("page.error").bind({},{err:n,backLink:i?i.url:null});this.render(o)},render:function(e){this.fireBeforeRender(),this.element=e,this.config.placeholder&&this.config.placeholder.append(e),this.config.placeholder&&this.config.placeholder.addClass("tau-entity-loaded"),this.fireAfterRender()},initializeContainer:function(e){this.container&&this.container.initialize(e)},getStateFields:function(e){var n={};e.hasOwnProperty("stateName")&&(n[e.stateName]=e);var i=this,o=[];if(t.isArray(e.children))o=e.children;else if(t.isArray(e.tabs)){var r=t.pluck(e.tabs,"items");o=t.flatten(r)}return t.each(o,function(e){t.extend(n,i.getStateFields(e))}),n},"bus contextRetrieved":function(e){var n=this,r=this._createConfig(e.data);t.extend(r,n.config.containerConfig||o.getConfig(r));var a=r.context.entity.entityType.name.toLowerCase(),s=t.filter(r.context.getCustomFields(),function(e){return"multipleentities"==e.type.toLowerCase()&&e.entityKind.toLowerCase()==a});r=this._addTabsBySpecialFields(s,r),this.container=i.create({name:"entity container",store:this.config.store,context:n.config.context,cssClass:n.config.cssClass}),this.bus.on("afterRender",function(e,t){this.container.on("afterRenderAll",function(){this.fire("afterRenderAll",t)},this)},this),this.container.on("afterInit",this["container afterInit"],this),this.container.on("afterRender",this["container afterRender"],this);var c=function(e){n.fire("onConfigContainerCreated",e),n.fire("initializeContainer",e)};n.fire("configReadyForIntegration",r),r.integrationReadyPromise?r.integrationReadyPromise.always(function(e){c(e)}):c(r)},_createConfig:function(e){return t.extend(e,{mode:this.config.mode||a.full})},"bus onConfigContainerCreated+initializeContainer":function(e,n){var i=this,o=i.getStateFields(n),r=i.config.context.configurator;if(t.isEmpty(o))n.context.configurator=r,i.initializeContainer(n);else{var a=t.pluck(o,"stateName");n.context.componentSettings.get({fields:a,callback:function(e){t.each(o,function(t,n){e.hasOwnProperty(n)&&(o[n][n]=e[n])}),n.context.configurator=r,i.initializeContainer(n)}})}},lifeCycleCleanUp:function(){this.destroyContainer(),this._super()},destroyContainer:function(){this.container&&(this.container.destroy(),this.container=null)},destroy:function(){this.destroyContainer(),this.container=null,this._super()},_addTabsBySpecialFields:function(e,n){var i;if(n.children&&n.children.length&&n.children[0].children&&n.children[0].children.length&&n.children[0].children[0].children&&n.children[0].children[0].children.length&&(i=n.children[0].children[0].children),!i)return n;var o=t(i).find(function(e){return"tabs"===e.type});return t.forEach(e,function(e,t){o.tabs.push({label:"MultipleEntitiesCustomFieldEditor"+t,header:[{type:"label",text:e.name,extensions:[r],customField:{name:e.name,type:e.type}}],items:[{type:"container",spinnerConfigForLazy:{isShow:!0,selectorForHeight:".tau-page-entity"},children:[{type:"container",lazy:!0,name:"lazyPlaceholder container",children:[{type:"customField.multipleEntities.container",customField:{name:e.name,type:e.type,value:e.value}}]}]}]})}),n}})});