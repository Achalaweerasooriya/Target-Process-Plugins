define(["Underscore","jQuery","tau/core/view-base","tau/core/event-dispatcher","tau/models/dataprocessor/model.processor.context"],function(e,n,t,i,r){var a=function(n){var t={};return e.each(n,function(e,n){for(var i=n.split(":"),r=i.pop(),a=t,o=0,s=i.length;s>o;o++){var c=i[o];a.hasOwnProperty(c)||(a[c]={}),a=a[c]}a[r]=e}),t};return t.extend({name:"view.compositeControl",init:function(e){this._loaded=!1,this._super(e),this.timeoutDescriptor=null},initialize:function(){this._super.apply(this,arguments);var n=this.config.dependencies,t=this.config.visible&&e.isArray(n)&&e.size(n)>0;if(t){var i=this.getComponentPaths(n);require(i,this.createComponentTypesCallback(n))}else this.fireDependenciesAreReady({})},getComponentPaths:function(n){return e.map(n,function(e){return"tau/components/component."+e})},createComponentTypesCallback:function(n){var t=this;return t.dependenciesHash={},function(){var i=arguments;e(n).each(function(e,n){t.dependenciesHash[e]=i[n]}),t.fireDependenciesAreReady(t.dependenciesHash)}},fireDependenciesAreReady:function(e){this.fire("dependenciesAreReady",{controlTypes:e})},"bus afterInit+dataBind":function(){},"bus afterInit+dataBind+dependenciesAreReady":function(e){var n=this,t=e.afterInit.data,i=e.dataBind.data,r=e.dependenciesAreReady.data;n.config.visible&&(n._loaded=!0),n.fireBeforeRender({data:i}),n.doRender(i,t.refreshSelector);var a=n.instantiateChildrenComponents(n.element.find("[runas]"),r.controlTypes);n.initializeChildrenComponents(a,i)},createOnAfterRenderCallback:function(e){return function(n){n.removeListener(),e.replaceWith(n.data.element)}},onDestroyCallback:function(e){var n=e.sender;delete this.children[n.uniqueId]},instantiateChildrenComponents:function(t,i){var r=this,o=[];r.children={};var s=e.bind(r.onDestroyCallback,r);return t.each(function(){var t=n(this),c=t.attr("runas"),d=i.hasOwnProperty(c);if(!d)throw"The component type ["+c+"] not found";var u=i[c],f=a(t.data()),l=u.create({disabledExtensionCategories:r.config.disabledExtensionCategories,context:r.config.context,allData:f});l.uniqueId=l.uniqueId||e.uniqueId(),l.on("afterRender",r.createOnAfterRenderCallback(t)),l.on("destroy",s);var h={instance:l,config:f};r.children[l.uniqueId]=l,o.push(h)}),o},initializeChildrenComponents:function(n,t){var i=this,r=[];e.forEach(n,function(n,t){var i=n.config,a=n.instance;e.has(i,"label")?r[i.label]=a:r[t]=a}),this.fire("childrenBuses.ready",r);var a=50,o=10,s=function(){if(n.length){for(var e=+new Date,t=n.splice(0,o),r=0,c=t.length;c>r;r++)i.fire("createComponentContext",t[r]);var d=+new Date,u=d-e,f=u/a;if(Math.abs(1-f)>.3){var l=Math.floor((o+o/f)/2);o=l||1}i.timeoutDescriptor=setTimeout(s,1)}else i.fire("component.ready")};s(),i.fireAfterRender({data:t})},"bus createComponentContext":function(e){var n=e.data,t=n.config;t.context.entity=t.context.general,t.context.applicationContext=this.config.context.applicationContext,t.context.configurator=this.config.context.configurator,r(t.context),this.fire("componentContextCreated",n)},"bus componentContextCreated":function(e){var n=e.data;this.fire("childComponentCreated",n.instance),n.instance.fire("initialize",n.config)},"bus show":function(){this._super(),this._loaded||this.fire("initialize",{})},destroyChildren:function(){var n=this;clearTimeout(n.timeoutDescriptor),n.dispatcher=null,e(n.children||{}).chain().keys().each(function(e){n.children[e].destroy()}),n.children={}},lifeCycleCleanUp:function(){this.destroyChildren(),this._super()},destroy:function(){this.destroyChildren(),this._super()}})});