define(["Underscore","jQuery","tau/core/view-base","tau/core/event-dispatcher","tau/models/dataprocessor/model.processor.context"],function(_,$,a,b,c){var d=function(a){return _(a).map(function(a){return"tau/components/component."+a})},e=function(a){var b={},c=_(a).keys();return _(c).each(function(c){var d=c.split(":"),e=null,f=-1,g=d.length,h=b;while(++f<g-1)e=d[f],h.hasOwnProperty(e)||(h[e]={}),h=h[e];var i=d[f];h[i]=a[c]}),b},f=a.extend({name:"view.compositeControl",init:function(a){this._loaded=!1,this._super(a),this.timeoutDescriptor=null},initialize:function(){var a=this;a._super.apply(a,arguments);var b=a.config.dependencies,c=_.size(b)>0&&a.config.visible;if(c){var e=d(b);require(e,a.createComponentTypesCallback(b))}else a.fireDependenciesAreReady({})},createComponentTypesCallback:function(a){var b=this;return b.dependenciesHash={},function(){var c=arguments;_(a).each(function(a,d){b.dependenciesHash[a]=c[d]}),b.fireDependenciesAreReady(b.dependenciesHash)}},fireDependenciesAreReady:function(a){this.fire("dependenciesAreReady",{controlTypes:a})},"bus afterInit+dataBind":function(){},"bus afterInit+dataBind+dependenciesAreReady":function(a){var b=this,c=a.afterInit.data,d=a.dataBind.data,e=a.dependenciesAreReady.data;b.config.visible&&(b._loaded=!0),b.fireBeforeRender({data:d}),b.doRender(d,c.refreshSelector);var f=b.instantiateChildrenComponents(b.element.find("[runas]"),e.controlTypes);b.initializeChildrenComponents(f,d)},createOnAfterRenderCallback:function(a){return function(b){b.removeListener(),a.replaceWith(b.data.element)}},onDestroyCallback:function(a){var b=this,c=a.sender;delete b.children[c.uniqueId]},instantiateChildrenComponents:function(a,b){var c=this,d=[];c.children={};var f=_.bind(c.onDestroyCallback,c);return a.each(function(a,g){var h=$(this),i=h.attr("runas"),j=b.hasOwnProperty(i);if(!j)throw"The component type ["+i+"] not found";var k=b[i],l=k.create({disabledExtensionCategories:c.config.disabledExtensionCategories,context:c.config.context});l.uniqueId=l.uniqueId||_.uniqueId(),l.on("afterRender",c.createOnAfterRenderCallback(h)),l.on("destroy",f);var m={instance:l,config:e(h.data())};c.children[l.uniqueId]=l,d.push(m)}),d},initializeChildrenComponents:function(a,b){var c=this,d=function(){if(a.length){var b=a.shift();c.fire("createComponentContext",b),c.timeoutDescriptor=setTimeout(d,1)}else c.fire("component.ready")};d(),c.fireAfterRender({data:b})},"bus createComponentContext":function(a){var b=this,d=a.data,e=d.config,f=e.context.general;e.context.entity=f,e.context.assignable=f,e.context.applicationContext=b.config.context.applicationContext,c(e.context),b.fire("componentContextCreated",d)},"bus componentContextCreated":function(a){var b=a.data;b.instance.fire("initialize",b.config)},"bus show":function(){this._super(),this._loaded||this.fire("initialize",{})},destroyChildren:function(){var a=this;clearTimeout(a.timeoutDescriptor),a.dispatcher=null,_(a.children||[]).chain().keys().each(function(b){a.children[b].destroy()}),a.children=null},lifeCycleCleanUp:function(){this.destroyChildren(),this._super()},destroy:function(){this.destroyChildren(),this._super()}});return f})