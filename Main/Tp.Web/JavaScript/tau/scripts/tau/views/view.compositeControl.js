define(["Underscore","jQuery","tau/core/view-base","tau/core/event-dispatcher","tau/models/dataprocessor/model.processor.context"],function(a,b,c,d,e){var f=function(b){return a(b).map(function(a){return"tau/components/component."+a})},g=function(b){var c={},d=a(b).keys();return a(d).each(function(a){var d=a.split(":"),e=null,f=-1,g=d.length,h=c;while(++f<g-1)e=d[f],h.hasOwnProperty(e)||(h[e]={}),h=h[e];var i=d[f];h[i]=b[a]}),c},h=c.extend({name:"view.compositeControl",init:function(a){this._loaded=!1,this._super(a)},initialize:function(){var b=this;b._super.apply(b,arguments);var c=b.config.dependencies,d=a.size(c)>0&&b.config.visible;if(d){var e=f(c);require(e,b.createComponentTypesCallback(c))}else b.fireDependenciesAreReady({})},createComponentTypesCallback:function(b){var c=this;return c.dependenciesHash={},function(){var d=arguments;a(b).each(function(a,b){c.dependenciesHash[a]=d[b]}),c.fireDependenciesAreReady(c.dependenciesHash)}},fireDependenciesAreReady:function(a){this.fire("dependenciesAreReady",{controlTypes:a})},"bus afterInit+dataBind":function(){},"bus afterInit+dataBind+dependenciesAreReady":function(a){var b=this,c=a.afterInit.data,d=a.dataBind.data,e=a.dependenciesAreReady.data;b.config.visible&&(b._loaded=!0),b.fireBeforeRender({data:d}),b.doRender(d,c.refreshSelector);var f=b.instantiateChildrenComponents(b.element.find("[runas]"),e.controlTypes);b.initializeChildrenComponents(f,d)},createOnAfterRenderCallback:function(a){return function(b){b.removeListener(),a.replaceWith(b.data.element)}},onDestroyCallback:function(a){var b=this,c=a.sender;delete b.children[c.uniqueId]},instantiateChildrenComponents:function(c,d){var e=this,f=[];e.children={};var h=a.bind(e.onDestroyCallback,e);return c.each(function(c,i){var j=b(this),k=j.attr("runas"),l=d.hasOwnProperty(k);if(!l)throw"The component type ["+k+"] not found";var m=d[k],n=m.create({disabledExtensionCategories:e.config.disabledExtensionCategories,context:e.config.context});n.uniqueId=n.uniqueId||a.uniqueId(),n.on("afterRender",e.createOnAfterRenderCallback(j)),n.on("destroy",h);var o={instance:n,config:g(j.data())};e.children[n.uniqueId]=n,f.push(o)}),f},initializeChildrenComponents:function(b,c){var e=this;b.length?(e.dispatcher=new d(a(b).pluck("instance")),e.dispatcher.listen("afterRender",function(a){e.fireAfterRender({data:c})}),a(b).each(function(a){e.fire("createComponentContext",a)})):e.fireAfterRender({data:c})},"bus createComponentContext":function(a){var b=this,c=a.data,d=c.config,f=d.context.general;d.context.entity=f,d.context.assignable=f,d.context.applicationContext=b.config.context.applicationContext,e(d.context),b.fire("componentContextCreated",c)},"bus componentContextCreated":function(a){var b=a.data;b.instance.fire("initialize",b.config)},"bus show":function(){this._super(),this._loaded||this.fire("initialize",{})},destroyChildren:function(){var b=this;b.dispatcher=null,a(b.children).chain().keys().each(function(a){b.children[a].destroy()}),b.children=null},lifeCycleCleanUp:function(){this.destroyChildren(),this._super()},destroy:function(){this.destroyChildren(),this._super()}});return h})