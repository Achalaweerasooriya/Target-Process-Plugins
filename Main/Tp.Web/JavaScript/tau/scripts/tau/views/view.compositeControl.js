define(["Underscore","jQuery","tau/core/view-base","tau/core/event-dispatcher","tau/models/dataprocessor/model.processor.context"],function(e,t,n,i,r){var o=function(t){var n={};return e.each(t,function(e,t){for(var i=t.split(":"),r=i.pop(),o=n,a=0,s=i.length;s>a;a++){var c=i[a];o.hasOwnProperty(c)||(o[c]={}),o=o[c]}o[r]=e}),n};return n.extend({name:"view.compositeControl",init:function(e){this._loaded=!1,this._super(e),this.timeoutDescriptor=null},initialize:function(t){this._super(t);var n=this.config.dependencies,i=this.config.visible&&e.isArray(n)&&e.size(n)>0;if(i){var r=this.getComponentPaths(n);require(r,this.safeCallback(function(){this._fillDependencies(n,arguments)}))}else this.fireDependenciesAreReady({})},getComponentPaths:function(t){return e.map(t,function(e){return"tau/components/component."+e})},_fillDependencies:function(t,n){var i={};e.each(t,function(e,t){i[e]=n[t]}),this.fireDependenciesAreReady(i)},fireDependenciesAreReady:function(e){this.fire("dependenciesAreReady",{controlTypes:e})},"bus afterInit+dataBind":function(){},"bus afterInit+dataBind+dependenciesAreReady":function(e){var t=e.afterInit.data,n=e.dataBind.data,i=e.dependenciesAreReady.data;this.config.visible&&(this._loaded=!0),this.fireBeforeRender({data:n}),this.doRender(n,t.refreshSelector);var r=this.instantiateChildrenComponents(this.element.find("[runas]"),i.controlTypes);this.initializeChildrenComponents(r,n)},createOnAfterRenderCallback:function(e){return function(t){t.removeListener(),e.replaceWith(t.data.element)}},onDestroyCallback:function(e){if(this.children){var t=e.sender;delete this.children[t.uniqueId]}},instantiateChildrenComponents:function(n,i){var r=this,a=[];r.children={};var s=e.bind(r.onDestroyCallback,r);return n.each(function(){var n=t(this),c=n.attr("runas"),d=i.hasOwnProperty(c);if(!d)throw"The component type ["+c+"] not found";var h=i[c],f=o(n.data()),l=h.create({disabledExtensionCategories:r.config.disabledExtensionCategories,context:r.config.context,allData:f});
l.uniqueId=l.uniqueId||e.uniqueId(),l.on("afterRender",r.createOnAfterRenderCallback(n)),l.on("destroy",s);var u={instance:l,config:f};r.children[l.uniqueId]=l,a.push(u)}),a},initializeChildrenComponents:function(t,n){var i=this,r=[];e.forEach(t,function(t,n){var i=t.config,o=t.instance;e.has(i,"label")?r[i.label]=o:r[n]=o}),this.fire("childrenBuses.ready",r);var o=50,a=10,s=function(){if(t.length){for(var e=+new Date,n=t.splice(0,a),r=0,c=n.length;c>r;r++)i.fire("createComponentContext",n[r]);var d=+new Date,h=d-e,f=h/o;if(Math.abs(1-f)>.3){var l=Math.floor((a+a/f)/2);a=l||1}i.timeoutDescriptor=setTimeout(s,1)}else i.fire("component.ready")};s(),i.fireAfterRender({data:n})},"bus createComponentContext":function(e){var t=e.data,n=t.config;n.context.entity=n.context.general,n.context.applicationContext=this.config.context.applicationContext,n.context.configurator=this.config.context.configurator,r(n.context),this.fire("componentContextCreated",t)},"bus componentContextCreated":function(e){var t=e.data;this.fire("childComponentCreated",t.instance),t.instance.fire("initialize",t.config)},"bus show":function(){this._super(),this._loaded||this.fire("initialize",{})},destroyChildren:function(){clearTimeout(this.timeoutDescriptor),this.dispatcher=null;var t=e.keys(this.children);e.each(t,function(e){this.children[e].destroy()},this),this.children={}},lifeCycleCleanUp:function(){this.destroyChildren(),this._super()},destroy:function(){this.destroyChildren(),this._super()}})});