define(["Underscore","jQuery","tau/core/view-base","tau/core/event-dispatcher","tau/models/dataprocessor/model.processor.context"],function(_,$,ViewBase,EventDispatcher,modelProcessorContext){var getComponentPaths=function(componentTypes){return _(componentTypes).map(function(type){return"tau/components/component."+type})},processDataProperties=function(obj){var jsonResult={},keys=_(obj).keys();return _(keys).each(function(key){var tokens=key.split(":"),propName=null,i=-1,len=tokens.length,pathPointer=jsonResult;while(++i<len-1)propName=tokens[i],pathPointer.hasOwnProperty(propName)||(pathPointer[propName]={}),pathPointer=pathPointer[propName];var tagPropertyName=tokens[i];pathPointer[tagPropertyName]=obj[key]}),jsonResult};return ViewBase.extend({name:"view.compositeControl",init:function(config){this._loaded=!1,this._super(config),this.timeoutDescriptor=null},initialize:function(){var self=this;self._super.apply(self,arguments);var componentTypeNames=self.config.dependencies,loadDependencies=_.isArray(componentTypeNames)&&_.size(componentTypeNames)>0&&self.config.visible;if(loadDependencies){var componentPaths=getComponentPaths(componentTypeNames);require(componentPaths,self.createComponentTypesCallback(componentTypeNames))}else self.fireDependenciesAreReady({})},createComponentTypesCallback:function(componentTypeNames){var self=this;return self.dependenciesHash={},function(){var componentTypes=arguments;_(componentTypeNames).each(function(ctrlType,i){self.dependenciesHash[ctrlType]=componentTypes[i]}),self.fireDependenciesAreReady(self.dependenciesHash)}},fireDependenciesAreReady:function(dependenciesHash){this.fire("dependenciesAreReady",{controlTypes:dependenciesHash})},"bus afterInit+dataBind":function(){},"bus afterInit+dataBind+dependenciesAreReady":function(evts){var self=this,afterInitEvtData=evts.afterInit.data,dataBindEvtData=evts.dataBind.data,dependencies=evts.dependenciesAreReady.data;self.config.visible&&(self._loaded=!0),self.fireBeforeRender({data:dataBindEvtData}),self.doRender(dataBindEvtData,afterInitEvtData.refreshSelector);var childrenComponents=self.instantiateChildrenComponents(self.element.find("[runas]"),dependencies.controlTypes);self.initializeChildrenComponents(childrenComponents,dataBindEvtData)},createOnAfterRenderCallback:function(elementPlaceHolder){return function(e){e.removeListener(),elementPlaceHolder.replaceWith(e.data.element)}},onDestroyCallback:function(e){var self=this,componentBus=e.sender;delete self.children[componentBus.uniqueId]},instantiateChildrenComponents:function(placeholders,componentTypesRegistry){var self=this,childrenComponents=[];self.children={};var staticDestroyCallback=_.bind(self.onDestroyCallback,self);return placeholders.each(function(){var $el=$(this),componentTypeName=$el.attr("runas"),isItemDetected=componentTypesRegistry.hasOwnProperty(componentTypeName);if(!isItemDetected)throw"The component type ["+componentTypeName+"] not found";var typeFactory=componentTypesRegistry[componentTypeName],data=processDataProperties($el.data()),ctrlInstance=typeFactory.create({disabledExtensionCategories:self.config.disabledExtensionCategories,context:self.config.context,allData:data});ctrlInstance.uniqueId=ctrlInstance.uniqueId||_.uniqueId(),ctrlInstance.on("afterRender",self.createOnAfterRenderCallback($el)),ctrlInstance.on("destroy",staticDestroyCallback);var item={instance:ctrlInstance,config:data};self.children[ctrlInstance.uniqueId]=ctrlInstance,childrenComponents.push(item)}),childrenComponents},initializeChildrenComponents:function(childrenComponents,dataBindEvtData){var self=this,MAX_TIME=50,batchSize=10,createComponentContextHandler=function(){var len=childrenComponents.length;if(len){var tick0=+(new Date),batchComponents=childrenComponents.splice(0,batchSize),batchLength=batchComponents.length;for(var i=0;i<batchLength;i++){var ctrlItem=batchComponents[i];self.fire("createComponentContext",ctrlItem)}var tick1=+(new Date),delta=tick1-tick0,r=delta/MAX_TIME;if(Math.abs(1-r)>.3){var newBatchSize=Math.floor((batchSize+batchSize/r)/2);batchSize=newBatchSize||1}self.timeoutDescriptor=setTimeout(createComponentContextHandler,1)}else self.fire("component.ready")};createComponentContextHandler(),self.fireAfterRender({data:dataBindEvtData})},"bus createComponentContext":function(e){var self=this,ctrlItem=e.data,personalConfig=ctrlItem.config,entityData=personalConfig.context.general;personalConfig.context.entity=entityData,personalConfig.context.applicationContext=self.config.context.applicationContext,personalConfig.context.configurator=this.config.context.configurator,modelProcessorContext(personalConfig.context),self.fire("componentContextCreated",ctrlItem)},"bus componentContextCreated":function(e){var ctrlItem=e.data;this.fire("childComponentCreated",ctrlItem.instance),ctrlItem.instance.fire("initialize",ctrlItem.config)},"bus show":function(){this._super(),this._loaded||this.fire("initialize",{})},destroyChildren:function(){var self=this;clearTimeout(self.timeoutDescriptor),self.dispatcher=null,_(self.children||{}).chain().keys().each(function(componentKey){self.children[componentKey].destroy()}),self.children={}},lifeCycleCleanUp:function(){this.destroyChildren(),this._super()},destroy:function(){this.destroyChildren(),this._super()}})})