define(["Underscore","jQuery","./model.board.cell"],function(_,$,baseModel){return baseModel.extend({"bus start.lifecycle":function(evt){this.onGetCellContent=$.noop,this.fire("model.get.cell.basicInfo.dump",{dump:{}})},preProcessAggregatedCellItem:function(cellItem){var srcCoords=cellItem.coords,srcItem=cellItem.dataItem,requestedLength=srcCoords.to-srcCoords.from+1,actualLength=srcItem.dynamic.items.length;if(actualLength<=requestedLength)return cellItem;var cellPaging=_(srcItem.fixed.items).find(function(item){return item.type="cellpaging"});if(cellPaging)return cellItem=this.preProcessCellResponse(srcItem,srcCoords),cellItem;var isExceed25Rule=actualLength>this.generateExcessTake(requestedLength);return isExceed25Rule&&(srcItem.fixed.items.push({type:"cellpaging"}),cellItem=this.preProcessCellResponse(srcItem,srcCoords)),cellItem},processResponse:function(r,dump,dumpValues){var cells=r.data.items;for(var k=0,len=cells.length;k<len;k++){var cell=cells[k],key=this.getKey(cell);dump.hasOwnProperty(key)&&_.extend(dump[key].dataItem,cell)}var cardsData=[];for(var v=0;v<dumpValues.length;v++){var dumpValue=this.preProcessAggregatedCellItem(dumpValues[v]),filteredCards=this.fireCellBasicInfoRetrieved(dumpValue);cardsData=cardsData.concat(filteredCards)}this.fireCardsDataReady(cardsData)},getKey:function(cell){var x=cell.x||"null",y=cell.y||"null";return x+"_"+y},"bus model.cells.content.loaded+model.cards.data.ready":function(evt){var self=this;delete self.onGetCellContent},"bus model.cells.content.loaded+model.get.cell.basicInfo.dump:last+model.get.cell.basicInfo.end":function(evt){var dump=evt["model.get.cell.basicInfo.dump"].data.dump,dumpValues=_.values(dump),data=evt["model.cells.content.loaded"].data;this.processResponse(data,dump,dumpValues)},"bus slice.ready:last+model.get.cell.basicInfo.dump:last+model.get.cell.basicInfo.end":function(evt){var dump=evt["model.get.cell.basicInfo.dump"].data.dump,dumpValues=_.values(dump),self=this,x={},y={},$takeMax=0;_.each(dumpValues,function(dv){var requestedCount=dv.coords.to-dv.coords.from+1;$takeMax<requestedCount&&($takeMax=requestedCount);var v=dv.dataItem;v.x&&v.x!="null"&&(x[v.x]=1),v.y&&v.y!="null"&&(y[v.y]=1)}),x=_.keys(x),y=_.keys(y);var $query={};x.length&&($query.x={$in:x}),y.length&&($query.y={$in:y}),$query.$skip=0,$query.$take=self.generateExcessTake($takeMax),self.fire("model.execute.cell.query",{query:$query})},"bus slice.ready:last+model.execute.cell.query":function(evt,evtSlice,evtCellQuery){var slice=evtSlice.base,$query=evtCellQuery.query,self=this;slice.cell($query).done(function(r){self.fire("model.cells.content.loaded",r)}).fail(function(r){self.fire("model.cells.content.loaded",{data:{items:[]}})})},"bus model.get.cell.basicInfo.dump:last+model.get.cell.basicInfo":function(evt){var dump=evt["model.get.cell.basicInfo.dump"].data.dump,coords=evt["model.get.cell.basicInfo"].data;if(!coords.x||!coords.y)return;var content={x:coords.x.toString(),y:coords.y.toString(),dynamic:{items:[]},fixed:{items:[]}};dump[this.getKey(content)]={dataItem:content,coords:coords}}})})