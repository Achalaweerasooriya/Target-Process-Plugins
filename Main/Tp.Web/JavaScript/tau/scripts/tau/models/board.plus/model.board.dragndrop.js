define(["Underscore","tau/core/extension.base"],function(_,ExtensionBase){return ExtensionBase.extend({"bus boardSettings.ready":function(ev,bs){var self=this,boardSettings=bs.boardSettings;boardSettings.get({fields:["viewMode"],callback:function(r){self.fire("viewMode.ready",r.viewMode)}})},"bus viewMode.ready+model.cells.metaInfo.ready":function(evt,viewMode,options){options=_.clone(options);var self=this;_.defaults(options,{enable:!1,isPrioritizable:!0,isBatch:!0,simpleCommands:[],commandName:null}),viewMode!=="list"&&options.simpleCommands.push("move"),options.isPrioritizable&&options.simpleCommands.push("prioritize"),options.simpleCommands.length&&(options.commandName=_.camelize(options.simpleCommands.join(" and "))),options.simpleCommands.length&&options.isBatch&&(options.commandName+="Batch"),options.commandName&&(options.enable=!0),options.enable&&self.fire("dndOptions.ready",options||{})},"bus model.sliceInfo.retrieved":function(e,sliceInfo){var conditions={};_.forEach(["x","y"],function(dimName){conditions[dimName]=[],_.forEach(sliceInfo[dimName].data,function(item){var val=item[dimName];conditions[dimName].push(val)})}),this.fire("conditions.ready",conditions)},"bus conditions.ready:last + dndOptions.ready:last + slice.ready:last + view.card.batch.move":function(evt,conditions,options,sliceData,batch){var slice=sliceData.slice,command=this._prepareCommand(slice,batch,options,conditions);command(_.bind(function(result){this.fire("view.card.batch.move.after",result)},this))},_prepareParameters:function(batch,options,conditions){var parameters={},items=[];return _.forEach(batch,function(cardData){var source=cardData.source,target=cardData.target,item={itemId:source.entityId};_.include(options.simpleCommands,"move")&&(item=_.extend(item,{oldX:source.x,oldY:source.y,x:target.x,y:target.y})),_.include(options.simpleCommands,"prioritize")&&(item=_.extend(item,{beforeItemId:target.beforeEntityId||null,afterItemId:target.afterEntityId||null})),items.push(item)}),parameters.$set={items:items},conditions.x.length&&(parameters.x={$in:conditions.x}),conditions.y.length&&(parameters.y={$in:conditions.y}),parameters},_createSuccessMoveHandler:function(argOutput,argOptions,argCallback){return _.bind(function(output,options,callback,r){var responseItems=r.data.items;_.forEach(output,function(item,i){var cardMovements=responseItems[i].items;cardMovements.length===0&&cardMovements.push({x:"__x_not_in_slice__",y:"__y_not_in_slice__",dataItem:{id:item.sliceId,type:item.entityType,data:{id:item.entityId,type:item.entityType,name:""}}});var moves=_.map(cardMovements,function(move){var r={dataItem:move.dataItem};return _.include(options.simpleCommands,"move")&&(r.x=move.x,r.y=move.y),r});item.commands[options.commandName]={executed:!0,error:!1,result:moves}}),callback(output)},this,argOutput,argOptions,argCallback)},_createFailureMoveHandler:function(output,options,cb){return _.bind(function(output,options,cb,err){var errMessage=err?err.data.responseText.Message:"Error";_.forEach(output,function(item,i){item.commands[options.commandName]={executed:!0,error:errMessage,result:[]}}),cb(output)},this,output,options,cb)},_generateDefaultOutput:function(batch,options){var output=[];return _.forEach(batch,function(cardData,i){var uid=cardData.uid,source=cardData.source,target=cardData.target;output.push({sliceId:source.sliceId,targetX:target.x,targetY:target.y,entityType:source.entityType,entityId:source.entityId,elementId:source.elementId,uid:uid,commands:{}}),output[i].commands[options.commandName]={executed:!1,error:!1,result:[]}}),output},_prepareCommand:function(argSlice,argBatch,argOptions,argConditions){return argBatch=_.filter(argBatch,function(v){return v.source.sliceId}),_.bind(function(slice,batch,options,cb){var output=this._generateDefaultOutput(batch,options),params=this._prepareParameters(batch,options,argConditions);slice[options.commandName](params).done(this._createSuccessMoveHandler(output,options,cb)).fail(this._createFailureMoveHandler(output,options,cb))},this,argSlice,argBatch,argOptions)}})})