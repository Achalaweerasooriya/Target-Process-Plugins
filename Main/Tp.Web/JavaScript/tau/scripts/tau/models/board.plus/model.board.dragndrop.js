define(["Underscore","jQuery","tau/core/extension.base"],function(e,t,i){var r=i.extend({resetLifecycle:!0,defaultOptions:{simpleCommands:{move:!0}},_onBoardSettingsReady:function(e){var t=this.fire.bind(this,"dndOptions.refresh");e.get(["prioritization"]).then(t),e.unbind({listener:this}),e.bind({fields:["prioritization"],listener:this,callback:t})},"bus configurator.ready":function(e,t){this._onBoardSettingsReady(t.service("boardSettings"))},"bus configurator.ready:last + destroy":function(e,t){var i=t.service("boardSettings");i.unbind({listener:this})},"bus configurator.ready:last + model.cells.metaInfo.ready:last + dndOptions.refresh":function(i,r,n){var s=e.pick(n,"isPrioritizable");t.when(this._prepareOptionsOnInit(s,r)).then(e.bind(function(e){r.getGlobalBus().fire("isPrioritizable.ready",e.isPrioritizable),this.fire("dndOptions.ready",e||{})},this))},"bus model.sliceInfo.retrieved":function(t,i){var r={};e.forEach(["x","y"],function(t){r[t]=e.map(i[t].data,function(e){return e[t]})}),this.fire("conditions.ready",r)},"bus conditions.ready:last + dndOptions.ready:last + slice.ready:last + shift.isPressed + view.card.batch.move":function(i,r,n,s,a,o){t.when(this._prepareOptionsOnExecute(n,a)).then(e.bind(function(e){return this.fire("shift.isPressed",a),this._prepareCommand(s.slice,o,e,r)},this)).then(function(e){return e()}).always(this._afterCardBatchMove.bind(this,o))},"bus dndOptions.ready:last + slice.ready:last + model.sliceInfo.retrieved:last + view.card.batch.move.before":function(t,i,r,n,s){var a=this._getMoveSuggestedCells(r.slice,n,s,i);this._moveBefore={command:a},a.then(e.complexProperty("data.items"),this._failureMoveHandler.bind(this,[],i)).then(this._afterMoveBefore.bind(this,s))},"bus view.card.batch.move.before.abort":function(){this._moveBefore&&this._moveBefore.command&&this._moveBefore.command.reject({data:{status:0}})},_afterMoveBefore:function(e,t){this._moveBefore=null,this.fire("view.card.batch.move.before.completed",t)},_afterCardBatchMove:function(e,t){this.fire("view.card.batch.move.after",t)
},_prepareOptionsOnInit:function(t,i){var r=i.service("boardSettings");return r.get(["cells","prioritization"]).then(e.bind(function(i){var r=e.defaults(i.cells.ordering||{},{direction:"Desc"}),n=e.defaults(i.prioritization||{},{mode:"enabled"});return t=e.clone(t),t=e.defaults(t,e.deepClone(this.defaultOptions),{isPrioritizable:!0,simpleCommands:{},prioritizationSettings:n}),t.sortAfter=t.isPrioritizable,t.sortAfterDir=r.direction.toLowerCase(),"disabled"==t.prioritizationSettings.mode&&(t.isPrioritizable=!1),t.isPrioritizable&&(t.simpleCommands.prioritize=!0),t.enable=this._hasCommands(t),t.isPrioritizable&&"shift"===t.prioritizationSettings.mode&&(t.isPrioritizable="shift"),t},this))},_hasCommands:function(t){return e.any(t.simpleCommands)},_prepareCommandName:function(t){var i;return this._hasCommands(t)&&(i=e.keys(t.simpleCommands).sort(),i=e.camelize(i.join(" and "))+"Batch"),i},_prepareOptionsOnExecute:function(e,t){return e.isPrioritizable&&"shift"===e.prioritizationSettings.mode&&(t?e.simpleCommands.prioritize=!0:delete e.simpleCommands.prioritize),e},_prepareParameters:function(t,i,r){var n=e.map(t,function(t){var r=t.source,n=t.target,s={itemId:r.entityId};return i.simpleCommands.move&&(s=e.extend(s,{oldX:r.x,oldY:r.y,x:n.x,y:n.y,type:r.entityType})),i.simpleCommands.prioritize&&(s=e.extend(s,{beforeItemId:n.beforeEntityId||null,afterItemId:n.afterEntityId||null})),s}),s={$set:{items:n}};return r.x.length&&(s.x={$in:r.x}),r.y.length&&(s.y={$in:r.y}),s},_createResponseItems:function(t,i){var r=e.unique(t,!1,function(e){return e.sliceId}),n=e.map(i,function(t){var i=e.find(r,function(e){if(!t.items||0===t.items.length)return null;var i=t.items[0];return i.dataItem.id===e.sliceId});return{srcItem:i,responseItem:t}}),s=e.filter(n,function(e){return e.srcItem}),a=e.filter(n,function(e){return!e.srcItem&&e.responseItem.items&&0!==e.responseItem.items.length}),o=e.map(a,function(e){var t=e.responseItem.items[0],i={sliceId:t.dataItem.id,targetX:t.x,targetY:t.y,entityType:t.dataItem.type,entityId:t.dataItem.id,commands:[{moveAndPrioritizeBatch:{executed:!1,error:!1,result:[]}}]};
return{srcItem:i,responseItem:e.responseItem}});return e.union(s,o)},_successMoveHandler:function(t,i,r){var n=this._createResponseItems(t,r.data.items),s=this._prepareCommandName(i);return e.map(n,function(t){var r=t.srcItem,n=t.responseItem.items;0===n.length&&n.push({x:"__x_not_in_slice__",y:"__y_not_in_slice__",dataItem:{id:r.sliceId,type:r.entityType,data:{id:r.entityId,type:r.entityType,name:""}},notInSlice:!0});var a=e.map(n,function(e){var t={dataItem:e.dataItem,notInSlice:e.notInSlice};return i.simpleCommands.move&&(t.x=e.x,t.y=e.y),t});return r.commands[s]={executed:!0,error:!1,result:a},r})},_failureMoveHandler:function(t,i,r){var n=this._prepareCommandName(i),s=this._getError(r);return e.forEach(t,function(e){e.commands[n]={executed:!0,error:s,result:[]}}),t},_getError:function(e){return e?e.data?e.data.responseText:{message:e.response.Message}:{message:"Error"}},_generateDefaultOutput:function(t,i){var r=this._prepareCommandName(i);return e.map(t,function(e){var t=e.uid,i=e.source,n=e.target,s={sliceId:i.sliceId,targetX:n.x,targetY:n.y,entityType:i.entityType,entityId:i.entityId,elementId:i.elementId,uid:t,commands:{}};return s.commands[r]={executed:!1,error:!1,result:[]},s})},_command:function(i,r,n,s){var a=this._generateDefaultOutput(r,n),o=this._prepareParameters(r,n,s),d=this._prepareCommandName(n);return d?t.when(d,o).then(function(e,t){return i[e](t)}).then(this._successMoveHandler.bind(this,a,n),this._failureMoveHandler.bind(this,a,n)):(e.each(a,function(e){e.commands={moveAndPrioritizeBatch:{error:{isCanceled:!0}}}}),t.Deferred().resolve(a))},_prepareCommand:function(t,i,r,n){return i=e.filter(i,function(e){return e.source.sliceId}),e.bind(this._command,this,t,i,r,n)},_getMoveSuggestedCells:function(t,i,r){var n=e.pluck(i.x.data,"x"),s=e.pluck(i.y.data,"y");r=e.filter(r,function(e){return e.source.sliceId});var a={$whereX:n.length?{x:{$in:n}}:void 0,$whereY:s.length?{y:{$in:s}}:void 0,$set:{items:e.map(r,function(e){return{itemId:e.source.entityId}
})}};return t.getCellsUnavailableToMove(a)}});return r});