define(["Underscore","tau/core/event.emitter"],function(_,a){var b={},c=0;return a.extend({dataSchema:{1:{query:{userstory:[]},dataFields:{userstory:[]}},2:{query:{userstory:[]},dataFields:{userstory:[]}},3:{query:{userstory:[]},dataFields:{userstory:[]}},4:{query:{userstory:["tags"]},dataFields:{userstory:["tags"]}},5:{query:{userstory:[]},dataFields:{userstory:[]}},6:{query:{userstory:[{assignments:[{generalUser:["id","firstName","lastName"]}]},"effort",{impediments:[{entityState:["isFinal"]}]},{bugs:[{entityState:["isFinal","isInitial","isPlanned"]}]},{tasks:[{entityState:["isFinal","isInitial","isPlanned"]}]}]},dataFields:{userstory:["assignments","effort","impediments","bugs","tasks"]}}},init:function(a){this._super(a),this.config=a,this.reguestsCount=0},"bus model.data.loader.registerItems":function(a){var b=[];this.registerItems=this.registerItems||{};var c=a.data.items;for(var d=0;d<c.length;d++){var e=c[d],f=this.registerItems[e.id]=this.registerItems[e.id]||{};_.extend(f,e),b.push(f)}this.fire("model.data.loader.itemsUpdated",{items:f})},handleOperations:function(a,b,c){var d=100,e=0,f=Math.min(e+d,a.length),g=this,h=function(){var i=b,j={};for(;e<f;e++){var k=a[e],l=k.type,m=j[l]=j[l]||{$in:[],fields:[],type:l};m.$in.push(k.id),m.fields=_.union(m.fields,k.fields)}_.each(j,function(a){i=i.turboGet(l,{$query:{id:{$in:a.$in}},fields:a.fields})}),g.beforeRequest(),i.done({success:function(){g.requestComplete(),c.apply(this,arguments)},failed:function(){g.requestComplete()}}),f!=a.length&&(f=Math.min(e+d,a.length),h())};h()},beforeRequest:function(){this.reguestsCount++,this.reguestsCount==1&&this.fire("model.requestBegin")},requestComplete:function(){--this.reguestsCount==0&&this.fire("model.requestCompleted")},getDataForZoomLevel:function(a,b){var c=this.getStoreOperationsForZoomLevel(a,_.map(this.registerItems,function(a){return a}));this.executeStoreOperations(c,b)},"bus initialize:last+model.zoomLevelChanged":function(a){var b=a["model.zoomLevelChanged"].data.zoomLevel,c=a.initialize.data.context.configurator.storeFactory.getStore();this.getDataForZoomLevel(b,c)},executeStoreOperations:function(a,b){var c=_.bind(this.dataRetrieved,this);a.length>0&&(this.fire("model.data.loader.willRegisterDataRequests"),this.handleOperations(a,b,c),this.fire("model.data.loader.didRegisterDataRequests"))},"bus model.data.loader.registerItems+initialize+model.zoomLevelChanged":function(a){var b=a.initialize.data.context.configurator.storeFactory.getStore(),c=this,d=a["model.zoomLevelChanged"].data.zoomLevel+1;d<7&&(d=7,c.getDataForZoomLevel(d,b))},"bus initialize:last+model.zoomLevelChanged:last+model.data.loader.registerItems":function(a){var b=a["model.zoomLevelChanged"].data.zoomLevel,c=this.getStoreOperationsForZoomLevel(b,a["model.data.loader.registerItems"].data.items),d=this.config.context.configurator.getStore();this.executeStoreOperations(c,d)},dataRetrieved:function(a){var b=a[0].data,c=[],d=this.registerItems||{};_.each(b,function(a){_.extend(d[a.id],a),_.extend(d[a.id],this.extractCountFields(a)),_.extend(d[a.id],this.splitTags(a));var b=d[a.id];c.push(b)},this),this.fire("model.dataUpdated",{items:c})},getCollectionInfo:function(a){var b={plannedCount:_.filter(a,function(a){var b=a.entityState;return b.isPlanned||b.isInitial}).length,inProgressCount:_.filter(a,function(a){var b=a.entityState;return!b.isPlanned&&!b.isInitial&&!b.isFinal}).length};return b},addCollectionInfo:function(a,b,c){if(_.isArray(a)){var d=this.getCollectionInfo(a);if(d.plannedCount||d.inProgressCount)c[b]=d}},extractCountFields:function(a){var b={};return _.isArray(a.impediments)&&(b.openImpedimentsCount=_.filter(a.impediments,function(a){return!a.entityState.isFinal}).length),this.addCollectionInfo(a.tasks,"tasksInfo",b),this.addCollectionInfo(a.bugs,"bugsInfo",b),b},splitTags:function(a){return _.isString(a.tags)&&a.tags.length>0?{tags:a.tags.split(",")}:{}},getStoreOperationsForZoomLevel:function(a,c){var d=new Date,e=[],f=[];for(var g=0;g<c.length;g++){var h=c[g],i=_.map(h,function(a,b){return b}),j,k=this.dataSchema;for(var l=1;l<=a;l++){if(!k.hasOwnProperty(l))break;var m=k[l],n=h.type.toLowerCase(),o=m.query[n]||[],p=m.dataFields[n]||[];if(p.length>0){var q=_.intersection(i,p),r=q.length===p.length;_.chain().difference(i,q).each(function(a){h[a]==b}),r||(j=j||{type:h.type,fields:[],id:h.id},j.fields=_.union(j.fields,o))}}j&&(f.push(j.id),e.push(j)),j=null}return e}})})