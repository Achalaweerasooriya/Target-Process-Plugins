define(["Underscore","tau/core/class","tau/core/extension.base"],function(t,e,i){var s=function(e){window.appIsInDebugMode&&window.console&&(window.console.group&&window.console.table?(console.group("board comet tick"),console.log("Raw: %o",e),console.log("Reason: %o",e.data.reason),console.table(t.map(e.data.items,function(e){var i=t.pick(e,"modification","location","x","y");return i.type=e.data.type,i.id=e.data.id,i})),console.groupEnd()):console.log("board comet tick",e))},o=e.extend({init:function(){this._queue=[]},add:function(t){this._queue.push(t),this.postponeFlush()},flush:function(t){this._queue.push(t),this.executeFlush()},reset:function(){this.timeout&&clearTimeout(this.timeout),this.queue=[]},postponeFlush:function(){clearTimeout(this.timeout),this.timeout=setTimeout(this.onFlush.bind(this),100)},executeFlush:function(){clearTimeout(this.timeout),this.onFlush()},onFlush:function(){var e=this._queue;for(this._queue.length>1&&(e=t.map(e,function(e){return e.data.items=t.map(e.data.items,function(t){return"NotInSlice"!=t.modification&&(t.modification="cascade"),t}),e}),this._queue=e);e.length;)this.doTick(e.shift())},onTickCb:function(){},doTick:function(){this.onTickCb.apply(null,t.toArray(arguments))},onTick:function(t){this.onTickCb=t}});return i.extend({init:function(t,e,i){this._cometService=e.getComet(),this.hubName=i||"slice",this.status=null,this.cometState={},this.queue=new o,this._super(t),this.queue.onTick(function(t){s(t),this.fireCometTick(t)}.bind(this)),this._cometService.disconnected.add(function(){this._cometService.refreshRequired.once(this._refresh,this)},this)},_refresh:function(){this.fire("refresh")},fireCometTick:function(t){this.fire("comet.tick",t)},"bus start.lifecycle:last + comet.parameters":function(t,e,i){this.initSubscription(i)},"bus subscription.started > comet.parameters":function(t,e){e.stop()},"bus subscription.started:last + before_destroy":function(t,e){e.stop()},"bus refresh":function(){this._cometService.refreshRequired.remove(this._refresh,this)
},"bus subscription.started:last + before_refresh":function(t,e){e.stop()},destroy:function(){this._cometService.removeEventHandlers(this),this._super()},initSubscription:function(e){this.cometState={},this.queue.reset();var i=this._cometService.subscribe(this.hubName,{parameters:e,callback:this.safeCallback(this.handleData),batchCallback:this.safeCallback(this.handleBatchData),started:function(t){this.fire("comet.subscription.ready",t)}.bind(this)});t.defer(this.fire.bind(this,"subscription.started",i))},isStateDeprecated:function(t,e){var i=this.cometState[e]||0,s=!1;return i>t&&(s=!0),s},handleBatchData:function(t){this.fire("comet.batch",t)},handleData:function(e){var i=t.first(e.data.items),s=(i.data.id||"").toLowerCase(),o=e.timestamp;this.isStateDeprecated(o,s)||(this.cometState[s]=e.timestamp,this.isOperationToMerge(e)?this.queue.add(e):this.queue.flush(e))},isOperationToMerge:function(e){var i=t.first(e.data.items),s=i.modification.toLowerCase();if("updated"!==s)return!1;var o=(i.location||"").toLowerCase();if("card"!==o)return!1;var n=e.data.reason;return!t.difference(["NumericPriority"],n).length}})});