define(["Underscore","tau/core/class","tau/core/extension.base"],function(t,e,i){var s=function(e){window.appIsInDebugMode&&window.console&&(window.console.group&&window.console.table?(console.group("board comet tick"),console.log("Raw: %o",e),console.log("Reason: %o",e.data.reason),console.table(t.map(e.data.items,function(e){var i=t.pick(e,"modification","location","x","y");return i.type=e.data.type,i.id=e.data.id,i})),console.groupEnd()):console.log("board comet tick",e))},n=e.extend({init:function(){this._queue=[],this.onTickCb=$.noop()},add:function(t){this._queue.push(t),this.postponeFlush()},flush:function(t){this._queue.push(t),this.executeFlush()},reset:function(){this.timeout&&clearTimeout(this.timeout),this.queue=[]},postponeFlush:function(){clearTimeout(this.timeout),this.timeout=setTimeout(t.bind(this.onFlush,this),100)},executeFlush:function(){clearTimeout(this.timeout),this.onFlush()},onFlush:function(){var e=this._queue;for(this._queue.length>1&&(e=t.map(e,function(e){return e.data.items=t.map(e.data.items,function(t){return"NotInSlice"!=t.modification&&(t.modification="cascade"),t}),e}),this._queue=e);e.length;)this.doTick(e.shift())},doTick:function(){this.onTickCb.apply(null,t.toArray(arguments))},onTick:function(t){this.onTickCb=t}});return i.extend({STATUS_ONLINE:"online",STATUS_OFFLINE:"offline",resetLifecycle:!0,init:function(e,i,o,a,c){this.configurator=i,this.hubName=o||"slice",this.debounceInterval=t.isUndefined(a)?100:a,this.reconnectInterval=t.isUndefined(c)?1e4:c,this.templateMessageReconnect=this.configurator.getTemplateFactory().register({name:"connection.restore",markup:['<div class="tau-system-message-body-inner">',"<h3>Connection is restored.</h3>",'<div>Please, <a class="tau-target-link i-role-actionrefresh"">refresh</a> View to apply changes from server.<div>',"</div>"]}).get(),this.templateMessageOffline=this.configurator.getTemplateFactory().register({name:"connection.lost",markup:['<div class="tau-system-message-body-inner">',"<h3>Connection lost.</h3>","<div>Cannot connect to the server.<div>","</div>"]}).get(),this.status=null,this.cometState={},this.queue=new n,this._super(e),this.queue.onTick(t.bind(function(t){s(t),this.fireCometTick(t)
},this))},fireCometTick:function(t){this.fire("comet.tick",t)},"bus start.lifecycle + comet.parameters":function(t,e,i){this.status=this.STATUS_ONLINE,this.initSubscription(i)},"bus subscription.started:last > comet.parameters":function(t,e,i){clearTimeout(this.timeoutId);var s=setTimeout(function(){e.stop(),this.status=this.STATUS_ONLINE,this.initSubscription(i)}.bind(this),this.debounceInterval);this.timeoutId=s;var n=clearTimeout.bind(window,s);this.on("refresh",n),this.on("destroy",n)},"bus netStatus.changed":function(t,e){var i=this.status;i!==e&&(e===this.STATUS_ONLINE?(this.reconnectIntervalId&&clearInterval(this.reconnectIntervalId),i===this.STATUS_OFFLINE&&this.notifyReconnected()):e===this.STATUS_OFFLINE&&(this.notifyDisconnected(),this.reconnectIntervalId=setInterval(this.fire.bind(this,"reconnect"),this.reconnectInterval)),this.status=e)},"bus comet.parameters > active.subscription.ready > reconnect":function(t,e){this.initSubscription(e)},"bus subscription.started:last + before_destroy":function(t,e){e.stop()},"bus subscription.started:last + before_refresh":function(t,e){e.stop()},initSubscription:function(e){this.cometState={},this.queue.reset();var i=this.configurator.getComet().listen(this.hubName,{parameters:e});i.on({callback:this.handleData.bind(this),batchCallback:this.handleBatchData.bind(this)}).aborted(this.fire.bind(this,"subscription.aborted",i)).disconnected(this.fire.bind(this,"subscription.disconnected",i)).start(this.fire.bind(this,"subscription.ready",i)),t.defer(this.fire.bind(this,"subscription.started",i))},"bus subscription.ready + subscription.started:last":function(t,e,i){e===i&&this.fire("active.subscription.ready",e)},"bus active.subscription.ready":function(t,e){this.fire("comet.subscription.ready",e),this.fire("netStatus.changed",this.STATUS_ONLINE)},"bus active.subscription.disconnected":function(){this.fire("netStatus.changed",this.STATUS_OFFLINE)},"bus active.subscription.aborted + comet.parameters:last":function(e,i,s){t.defer(t.bind(this.initSubscription,this,s))
},"bus subscription.disconnected + subscription.started:last":function(t,e,i){e.stop(),e===i&&this.fire("active.subscription.disconnected",e)},"bus subscription.aborted + subscription.started:last":function(t,e,i){e.stop(),e===i&&this.fire("active.subscription.aborted")},isStateDeprecated:function(t,e){var i=this.cometState[e]||0,s=!1;return i>t&&(s=!0),s},handleBatchData:function(t){this.fire("comet.batch",t)},handleData:function(e){{var i=t.first(e.data.items),s=(i.data.id||"").toLowerCase(),n=e.timestamp;this.cometState[s]||0}this.isStateDeprecated(n,s)||(this.cometState[s]=e.timestamp,this.isOperationToMerge(e)?this.queue.add(e):this.queue.flush(e))},isOperationToMerge:function(e){var i=t.first(e.data.items),s=(i.location||"").toLowerCase(),n=e.data.reason,o=i.modification.toLowerCase(),a=!t.difference(["NumericPriority"],n).length,c="updated"===o&&"card"===s&&a;return c},notifyDisconnected:function(){var t=this.templateMessageOffline.bind({},{});this.fire("error",{$node:t,disableAutoClose:!0})},notifyReconnected:function(){var e=this.templateMessageReconnect.bind({},{});e.on("click",".i-role-actionrefresh",t.bind(function(){this.fire("refresh")},this)),this.fire("notification",{$node:e,disableAutoClose:!0})}})});