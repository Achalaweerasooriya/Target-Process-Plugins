define(["Underscore","./model.board.base"],function(_,BaseModel){var unSubscribe=function(e,subscription){subscription.stop()},fn=function(callback,context){var timeout=null,c=_.bind(callback,context);return{postpone:function(){clearTimeout(timeout),timeout=setTimeout(c,100)},flush:function(){clearTimeout(timeout),c()}}};return BaseModel.extend({processMessageInQueue:function(queue,location,r){var reason=r.data.reason,modification=r.data.items[0].modification.toLowerCase(),orderingReason=["ModifyDate","NumericPriority"];modification==="updated"&&location==="card"&&_.difference(orderingReason,reason).length===0?queue.add(r):queue.flush(r)},createFireCometTickHandler:function(viewMode){var self=this,cometState={},queue={_queue:[],add:function(r){this._queue.push(r),this._handler.postpone()},flush:function(r){this._handler.flush(),self.fire("comet.tick",r)}};return queue._handler=fn(function(){var q=this._queue,isSubstituteModification=q.length>1;while(q.length>0){var r=q.shift();isSubstituteModification&&_.each(r.data.items,function(i){i.modification="cascade"}),window.appIsInDebugMode===!0&&console.log("   cascade update: ",r),self.fire("comet.tick",r)}},queue),function(r){window.appIsInDebugMode===!0&&console.log("   slice comet: ",r);var item=r.data.items[0],location=(item.location||"").toLowerCase(),sliceId=(item.data.id||"").toLowerCase(),currTimestamp=r.timestamp,prevTimestamp=cometState[sliceId]||0;if(prevTimestamp>currTimestamp||viewMode==="list"&&location!=="card")return;cometState[sliceId]=r.timestamp,self.processMessageInQueue(queue,location,r)}},fireSubscriptionReady:function(r){this.fire("comet.subscription.ready",r)},"bus configurator.ready + slice.ready + viewMode.ready":function(e,configurator,sliceReady,viewMode){var self=this,slice=sliceReady.slice,subscription=configurator.getComet().listen("slice",{parameters:slice.getSliceParams()}).on({callback:self.createFireCometTickHandler(viewMode)}).start();self.fireSubscriptionReady(subscription)},"bus comet.subscription.ready:last + before_destroy":unSubscribe,"bus comet.subscription.ready:last + before_refresh":unSubscribe})})