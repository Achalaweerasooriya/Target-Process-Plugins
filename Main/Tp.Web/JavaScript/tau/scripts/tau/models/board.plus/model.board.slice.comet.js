define(["Underscore","tau/core/class","tau/core/extension.base"],function(t,e,i){var s=function(e){window.appIsInDebugMode&&window.console&&(window.console.group&&window.console.table?(console.group("board comet tick"),console.log("Raw: %o",e),console.log("Reason: %o",e.data.reason),console.table(t.map(e.data.items,function(e){var i=t.pick(e,"modification","location","x","y");return i.type=e.data.type,i.id=e.data.id,i})),console.groupEnd()):console.log("board comet tick",e))},n=e.extend({init:function(){this._queue=[],this.onTickCb=$.noop()},add:function(t){this._queue.push(t),this.postponeFlush()},flush:function(t){this._queue.push(t),this.executeFlush()},reset:function(){this.timeout&&clearTimeout(this.timeout),this.queue=[]},postponeFlush:function(){clearTimeout(this.timeout),this.timeout=setTimeout(t.bind(this.onFlush,this),100)},executeFlush:function(){clearTimeout(this.timeout),this.onFlush()},onFlush:function(){var e=this._queue;for(this._queue.length>1&&(e=t.map(e,function(e){return e.data.items=t.map(e.data.items,function(t){return"NotInSlice"!=t.modification&&(t.modification="cascade"),t}),e}),this._queue=e);e.length;)this.doTick(e.shift())},doTick:function(){this.onTickCb.apply(null,t.toArray(arguments))},onTick:function(t){this.onTickCb=t}});return i.extend({STATUS_ONLINE:"online",STATUS_OFFLINE:"offline",reconnectDuration:1e4,resetLifecycle:!0,init:function(e,i,o){this.configurator=i,this.hubName=o||"slice",this.templateMessageReconnect=this.configurator.getTemplateFactory().register({name:"connection.restore",markup:['<div class="tau-system-message-body-inner">',"<h3>Connection is restored.</h3>",'<div>Please, <a class="tau-target-link i-role-actionrefresh"">refresh</a> View to apply changes from server.<div>',"</div>"]}).get(),this.templateMessageOffline=this.configurator.getTemplateFactory().register({name:"connection.lost",markup:['<div class="tau-system-message-body-inner">',"<h3>Connection lost.</h3>","<div>Cannot connect to the server.<div>","</div>"]}).get(),this.status=null,this.cometState={},this.queue=new n,this._super(e),this.queue.onTick(t.bind(function(t){s(t),this.fireCometTick(t)},this))},fireCometTick:function(t){this.fire("comet.tick",t)},"bus start.lifecycle + slice.ready":function(t,e,i){this.status=this.STATUS_ONLINE,this.initSubscription(i.slice)},"bus comet.subscription.ready:last > slice.ready":function(t,e,i){clearTimeout(this.timeoutId);var s=setTimeout(function(){e.stop(),this.subscription=null,this.status=this.STATUS_ONLINE,this.initSubscription(i.slice)}.bind(this),100);this.timeoutId=s,this.on("refresh",function(){clearTimeout(s)}),this.on("destroy",function(){clearTimeout(s)})},"bus slice.ready:last + netStatus.changed":function(e,i,s){var n=this.status;n!==s&&(s===this.STATUS_ONLINE?(this.reconnectInterval&&clearInterval(this.reconnectInterval),n===this.STATUS_OFFLINE&&this.notifyReconnected()):s===this.STATUS_OFFLINE&&(this.notifyDisconnected(),this.reconnectInterval=setInterval(t.bind(function(){this.initSubscription(i.slice)},this),this.reconnectDuration)),this.status=s)},"bus comet.subscription.ready:last + before_destroy":function(t,e){this.subscription=null,e.stop()},"bus comet.subscription.ready:last + before_refresh":function(t,e){this.subscription=null,e.stop()},initSubscription:function(e){if(!this.subscription){this.cometState={},this.queue.reset();var i=this.configurator.getComet().listen(this.hubName,{parameters:e.getSliceParams()});return i.on({callback:this.handleData.bind(this),batchCallback:this.handleBatchData.bind(this)}).aborted(t.bind(this.handleAbort,this,i,e)).disconnected(t.bind(this.handleDisconnect,this,i)).start(t.bind(this.handleStart,this,i)),this.subscription=i,i}},handleStart:function(t){this.fire("comet.subscription.ready",t),this.fire("netStatus.changed",this.STATUS_ONLINE)},handleDisconnect:function(t){this.subscription=null,t.stop(),this.fire("netStatus.changed",this.STATUS_OFFLINE)},handleAbort:function(e,i){this.subscription=null,e.stop(),t.defer(t.bind(this.initSubscription,this,i))},isStateDeprecated:function(t,e){var i=this.cometState[e]||0,s=!1;return i>t&&(s=!0),s},handleBatchData:function(t){this.fire("comet.batch",t)},handleData:function(e){{var i=t.first(e.data.items),s=(i.data.id||"").toLowerCase(),n=e.timestamp;this.cometState[s]||0}this.isStateDeprecated(n,s)||(this.cometState[s]=e.timestamp,this.isOperationToMerge(e)?this.queue.add(e):this.queue.flush(e))},isOperationToMerge:function(e){var i=t.first(e.data.items),s=(i.location||"").toLowerCase(),n=e.data.reason,o=i.modification.toLowerCase(),a=!t.difference(["NumericPriority"],n).length,c="updated"===o&&"card"===s&&a;return c},notifyDisconnected:function(){var t=this.templateMessageOffline.bind({},{});this.fire("error",{$node:t,disableAutoClose:!0})},notifyReconnected:function(){var e=this.templateMessageReconnect.bind({},{});e.on("click",".i-role-actionrefresh",t.bind(function(){this.fire("refresh")},this)),this.fire("notification",{$node:e,disableAutoClose:!0})}})});