define(["Underscore","tau/models/dataProviders/model.provider.items.base"],function(_,BaseProvider){return BaseProvider.extend({fetch:function(fnCallback){var userId=this.config.context.entity.id,storeChain=this.config.store,self=this,impedimentFields=["id",{entityType:["id","name"]},"name","numericPriority","tags","isPrivate",{entityState:this.fields.entityStateWithComment},{owner:["id","firstName","lastName","avatarUri"]},{responsible:["id","firstName","lastName","avatarUri"]},{project:["id","abbreviation"]}],userFilter={id:userId},assignmentsCmd={fields:[{assignable:["id",{entityType:["id","name"]},"name","numericPriority","tags","effort","effortCompleted","effortToDo","timeSpent","timeRemain",{entityState:this.fields.entityStateWithComment},{roleEfforts:["id","effort","effortToDo",{role:["id","name","isPair","hasEffort"]}]},{assignments:["id",{role:["id"]},{generalUser:self.fields.generalUser}]},{project:["id","abbreviation"]}]}],$query:{assignable:{entityState:{isFinal:0},project:{isActive:1}},generalUser:userFilter}},actions=[function(next){storeChain.find("assignment",assignmentsCmd).done(function(result){var data=_.pluck(result[0].data,"assignable");_.map(data,function(item){item.__type="assignable"}),next(!1,data)})},function(next){storeChain.find("impediment",{fields:impedimentFields,$query:{entityState:{isFinal:0},responsible:userFilter}}).done(function(result){next(!1,result[0].data)})}];_.series(actions,function(err,result){var assignments=[];_.each(result,function(item){assignments=assignments.concat(item)});var result=self._convertData(assignments);fnCallback(result)})},_convertData:function(data){return data=this._super(data),this._calculateEffortToMaximum(_.filter(data,function(item){return item.__type=="assignable"})),data=this._removeDuplicates(data),this._sortByPriority(data)},_removeDuplicates:function(data){var ids={},filteredData=_.filter(data,function(item){var wasAdded=ids.hasOwnProperty(item.id);return ids[item.id]=!0,0==wasAdded});return filteredData},_convertItem:function(data){var item={id:data.id,name:data.name,numericPriority:data.numericPriority,__type:data.entityType.name,entityState:{id:data.entityState.id,name:data.entityState.name,isInitial:data.entityState.isInitial,isFinal:data.entityState.isFinal,numericPriority:data.entityState.numericPriority},tags:this._processTags(data),projectId:data.project?data.project.id:undefined,project:data.project,entitiesCount:0,url:this.config.context.configurator.getUrlBuilder().getNewViewUrl(data.id,data.entityType.name,!0)};return data.__type=="assignable"?_.extend(item,{assignments:this._processAssignments(data),effort:this._getEffortData(data)}):data.__type=="impediment"&&_.extend(item,{responsible:data.responsible,effortMock:{}}),item.visibleEntityState=item.entityState,item}})})