define(["Underscore","tau/core/class"],function(_,Class){return Class.extend({init:function(config){this.entityId=config.context.entity.id,this.store=config.store,this.relatedEntityFieldName=config.dependencyType||"master",this.relationsFieldName=this.relatedEntityFieldName+"Relations",this.entityTypeName=config.context.entity?config.context.entity.entityType.name:"general",this.config=config},fetch:function(callback){var command={id:this.entityId,fields:[this._buildRelationsField()]};this.store.get(this.entityTypeName,command).done({success:function(data){this._fetchRelatedEntitiesInfo(data[0].data[this.relationsFieldName],callback)},scope:this})},_buildRelationsField:function(){var relationsField={};relationsField[this.relationsFieldName]=[{relationType:["name"]}];var relationsRelatedEntityField={};return relationsRelatedEntityField[this.relatedEntityFieldName]=["id",{entityType:["name"]}],relationsField[this.relationsFieldName].push(relationsRelatedEntityField),relationsField},_fetchRelatedEntitiesInfo:function(relations,callback){var relationsGrouped=_.groupBy(relations,_.bind(function(relation){return relation[this.relatedEntityFieldName].entityType.name},this)),requests=this._buildRelatedEntitiesInfoRequests(relationsGrouped);_.parallel(requests,_.bind(function(error,relatedEntityInfosGrouped){relationsGrouped=this._fillRelatedEntitiesInfo(relationsGrouped,relatedEntityInfosGrouped),callback(this.transform(relationsGrouped))},this))},_buildRelatedEntitiesInfoRequests:function(relationsGrouped){return _.map(_.keys(relationsGrouped),function(relatedEntityTypeName){return _.bind(function(onSuccess){this.store.find(relatedEntityTypeName,{fields:this._getFieldsForRelatedEntityInfo(relatedEntityTypeName),$query:{id:{$in:_.map(relationsGrouped[relatedEntityTypeName],function(relation){return relation[this.relatedEntityFieldName].id},this)}}}).done({success:function(result){onSuccess(!1,result[0].data)}})},this)},this)},_fillRelatedEntitiesInfo:function(relationsGrouped,relatedEntityInfosGrouped){return relationsGrouped=_.reduce(relatedEntityInfosGrouped,function(relationsGroupedMemo,relatedEntityInfos){return relatedEntityInfos.length>0&&(relationsGroupedMemo[relatedEntityInfos[0].entityType.name]=_.reduce(relatedEntityInfos,function(relationsOfTypeMemo,relatedEntityInfo){var relationToBeFilled=_.find(relationsOfTypeMemo,_.bind(function(relation){return relation[this.relatedEntityFieldName].id==relatedEntityInfo.id},this)),relatedEntityToBeFilled=relationToBeFilled[this.relatedEntityFieldName];return _.extend(relatedEntityToBeFilled,relatedEntityInfo,{relatedEntityInfoIsFilled:!0}),relationsOfTypeMemo},relationsGroupedMemo[relatedEntityInfos[0].entityType.name],this)),relationsGroupedMemo},relationsGrouped,this),relationsGrouped},_getFieldsForRelatedEntityInfo:function(entityTypeName){var baseFieldSet=["id","name",{entityType:["name"]},{project:["abbreviation"]}];switch(entityTypeName.toLowerCase()){case"userstory":case"bug":case"feature":case"task":case"testplanrun":case"testcaserun":case"request":return baseFieldSet.concat([{entityState:["name","isFinal"]},{release:["name"]},{iteration:["name"]}]);case"iteration":return baseFieldSet.concat([{release:["name"]}]);case"build":return baseFieldSet.concat([{release:["name"]},{iteration:["name"]}]);case"impediment":return baseFieldSet.concat([{entityState:["name","isFinal"]}]);case"testcase":return baseFieldSet.concat(["lastStatus"]);default:return baseFieldSet}},transform:function(relationsGrouped){var items=[],maxEntityTypeId=0,urlBuilder=this.config.context.configurator.getUrlBuilder();return _.reduce(_.values(relationsGrouped),function(itemsMemo,relations){return _.forEach(relations,function(relation){var relatedEntity=relation[this.relatedEntityFieldName];relatedEntity.relatedEntityInfoIsFilled&&(itemsMemo.push({id:relatedEntity.id,__type:relatedEntity.__type,entityType:relatedEntity.entityType,name:relatedEntity.name,project:relatedEntity.project?relatedEntity.project.abbreviation:"",entityState:relatedEntity.entityState,hasLastStatus:relatedEntity.hasOwnProperty("lastStatus"),lastStatus:relatedEntity.lastStatus,release:relatedEntity.release?relatedEntity.release.name:"",iteration:relatedEntity.iteration?relatedEntity.iteration.name:"",url:urlBuilder.getNewViewUrl(relatedEntity.id,relatedEntity.entityType.name,!0),relation:{id:relation.id,__type:relation.__type,relationType:relation.relationType}}),relatedEntity.entityType.id>maxEntityTypeId&&(maxEntityTypeId=relatedEntity.entityType.id))},this),itemsMemo},items,this),_.sortBy(items,function(item){return item.entityState&&item.entityState.isFinal?maxEntityTypeId+item.entityType.id:item.entityType.id})}})})