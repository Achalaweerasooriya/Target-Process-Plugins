define(["Underscore","tau/models/dataProviders/model.provider.groups.base","tau/utils/utils.date"],function(e,t,i){return t.extend({fetch:function(e,t,i){var n=["userstory"];return this.config.context.isPracticeAvailable("Bug Tracking")&&n.push("bug"),"entityState.name"==e?this._fetchState(e,n,i):this._fetchIterations(e,n,i)},isAvailableForItem:function(t,i){if(i.realGroups){var n=e.find(i.realGroups,function(e){return e.entityType.name.toLowerCase()==t.__type.toLowerCase()});return n?!0:!1}return!0},_fetchIterations:function(t,n,r){var a=this.config.context,o=(a.entity.entityType.name,a.entity.id),s=this.config.store,u={id:o,nested:!0,fields:[{iterations:["id","name","startDate","endDate"]}]},c="d MMM";s=s.get("release",u),s.done({success:function(t){var n=e(t).pluck("data")[0].iterations,a=[];n=e.sortBy(n,function(e){return i.parse(e.startDate)}),e.forEach(n,function(e){var t=i.parse(e.startDate).clearTime(),n=i.parse(e.endDate).clearTime(),r=!0,s=!1;i.Date.today().between(t,n)&&(r=!1,s=!0);var u=t.toString(c)+" / "+n.toString(c);u=u+" ("+Math.floor((n.getTime()-t.getTime())/1e3/60/60/24+1)+" days)",s&&(u+=" (current)"),e.releaseId=o,a.push({key:e.id,title:e.name,subtitle:u,collapsed:r,realGroup:e})}),a.push({key:null,title:"Backlog",collapsed:!0,realGroup:{id:null,releaseId:o}}),e.forEach(a,function(e){e.items=[]}),r(a)},scope:this})},moveToGroup:function(e,t,i,n){return"entityState.name"==this.config.groupBy?this._moveToGroupByState(e,t,i,n):this._moveToGroupByIteration(e,t,i,n)},_moveToGroupByIteration:function(t,i,n,r){var a=this.config.store,o=i.realGroup;if(!o||t.iteration&&o.id==t.iteration.id)return void r.call(null);var s=[];s.push(function(e){a.save(t.__type,{id:t.id,$set:{iteration:{id:o.id},release:{id:o.releaseId}},fields:["id",{iteration:["id"]}]}).done({success:function(){e(null,arguments)}})}),s.push(function(e){a.get(t.__type,{id:t.id,fields:["id",{iteration:["id"]}]}).done({success:function(t){e(null,t[0].data)}})}),e.series(s,function(t,i){e.isFunction(r)&&r.call(null,{changed:i[1]})
})}})});