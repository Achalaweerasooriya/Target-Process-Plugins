define(["Underscore","tau/models/dataProviders/model.provider.groups.base","tau/utils/utils.date"],function(_,a,b){return a.extend({fetch:function(a,b,c){var d=["userstory"];return this.config.context.isPracticeAvailable("Bug Tracking")&&d.push("bug"),a=="entityState.name"?this._fetchState(a,d,c):this._fetchIterations(a,d,c)},isAvailableForItem:function(a,b){if(b.realGroups){var c=_.find(b.realGroups,function(b){return b.entityType.name.toLowerCase()==a.__type.toLowerCase()});return c?!0:!1}return!0},_fetchIterations:function(a,c,d){var e=this.config.context,f=e.entity.entityType.name,g=e.entity.id,h=this.config.store,i={id:g,nested:!0,fields:[{iterations:["id","name","startDate","endDate"]}]},j="d MMM";h=h.get("release",i),h.done({success:function(a){var c=_(a).pluck("data")[0].iterations,e=[];c=_.sortBy(c,function(a){return b.parse(a.startDate)}),_.forEach(c,function(a){var c=b.parse(a.startDate).clearTime(),d=b.parse(a.endDate).clearTime(),f=!0,h=!1;Date.today().between(c,d)&&(f=!1,h=!0);var i=c.toString(j)+" / "+d.toString(j);i=i+" ("+Math.floor((d.getTime()-c.getTime())/1e3/60/60/24+1)+" days)",h&&(i+=" (current)"),a.releaseId=g,e.push({key:a.id,title:a.name,subtitle:i,collapsed:f,realGroup:a})}),e.push({key:null,title:"Backlog",collapsed:!0,realGroup:{id:null,releaseId:g}}),_.forEach(e,function(a){a.items=[]}),d(e)},scope:this})},moveToGroup:function(a,b,c,d){return this.config.groupBy=="entityState.name"?this._moveToGroupByState(a,b,c,d):this._moveToGroupByIteration(a,b,c,d)},_moveToGroupByIteration:function(a,b,c,d){var e=this.config.store,f=b.realGroup;if(!f||a.iteration&&f.id==a.iteration.id){d.call(null);return}var g=[];g.push(function(b){e.save(a.__type,{id:a.id,$set:{iteration:{id:f.id},release:{id:f.releaseId}},fields:["id",{iteration:["id"]}]}).done({success:function(){b(null,arguments)}})}),g.push(function(b){e.get(a.__type,{id:a.id,fields:["id",{iteration:["id"]}]}).done({success:function(a){b(null,a[0].data)}})}),_.series(g,function(a,b){_.isFunction(d)&&d.call(null,{changed:b[1]})})}})})