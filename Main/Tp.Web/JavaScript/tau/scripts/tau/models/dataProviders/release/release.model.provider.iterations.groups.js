define(["Underscore","tau/models/dataProviders/model.provider.groups.base","tau/utils/utils.date"],function(a,b,c){return b.extend({fetch:function(a,b,c){var d=["userstory"];return this.config.context.isPracticeAvailable("Bug Tracking")&&d.push("bug"),this._fetchIterations(a,d,c)},_fetchIterations:function(b,d,e){var f=this.config.context,g=f.entity.entityType.name,h=f.entity.id,i=this.config.store,j={id:h,nested:!0,fields:[{iterations:["id","name","startDate","endDate"]}]},k="d MMM";i=i.get("release",j),i.done({success:function(b){var d=a(b).pluck("data")[0].iterations,f=[];d=a.sortBy(d,function(a){return-1*c.parse(a.startDate)}),a.forEach(d,function(a){var b=c.parse(a.startDate).clearTime(),d=c.parse(a.endDate).clearTime(),e=!0,g=!1;Date.today().between(b,d)&&(e=!1,g=!0);var i=b.toString(k)+" / "+d.toString(k);i=i+" ("+Math.floor((d.getTime()-b.getTime())/1e3/60/60/24+1)+" days)",g&&(i+=" (current)"),a.releaseId=h,f.push({key:a.id,title:a.name,subtitle:i,collapsed:e,realGroup:a})}),f.unshift({key:null,title:"Backlog",collapsed:!0,realGroup:{id:null,releaseId:h}}),a.forEach(f,function(a){a.items=[]}),e(f)},scope:this})},moveToGroup:function(a,b,c,d){return this._moveToGroupByIteration(a,b,c,d)},_moveToGroupByIteration:function(b,c,d,e){var f=this.config.store,g=c.realGroup;if(!g||b.iteration&&g.id==b.iteration.id){e.call(null);return}var h=[],i={release:{id:g.releaseId}};g.id?i.iteration={id:g.id}:i.iteration=null,h.push(function(a){f.save(b.__type,{id:b.id,$set:i,fields:["id",{iteration:["id"]}]}).done({success:function(){a(null,arguments)}})}),h.push(function(a){f.get(b.__type,{id:b.id,fields:["id",{iteration:["id"]}]}).done({success:function(b){a(null,b[0].data)}})}),a.series(h,function(b,c){a.isFunction(e)&&e.call(null,{changed:c[1]})})}})})