define(["Underscore","tau/models/dataProviders/model.provider.groups.base","tau/utils/utils.date"],function(e,t,i){return t.extend({fetch:function(e,t,i){var n=["userstory"];return this.config.context.isPracticeAvailable("Bug Tracking")&&n.push("bug"),this._fetchIterations(e,n,i)},_fetchIterations:function(t,n,r){var o=this.config.context,a=o.entity.id,s=this.config.store,u={id:a,nested:!0,fields:[{iterations:["id","name","startDate","endDate"]}]},d="d MMM",c=this.config.context.configurator.getUrlBuilder();s=s.get("release",u),s.done({success:function(t){var n=e.pluck(t,"data")[0].iterations,o=[];n=e.sortBy(n,function(e){return-1*i.parse(e.startDate)}),e.forEach(n,function(e){var t=i.parse(e.startDate);t=i.convertToTimezone(t);var n=i.parse(e.endDate);n=i.convertToTimezone(n);var r=!0,s=!1;i.Date.today().between(t,n)&&(r=!1,s=!0);var u=t.toString(d)+" / "+n.toString(d);u=u+" ("+Math.floor((n.getTime()-t.getTime())/1e3/60/60/24+1)+" days)",s&&(u+=" (current)"),e.url=c.getNewViewUrl(e.id,e.__type,!0),e.releaseId=a,o.push({key:e.id,title:e.name,subtitle:u,collapsed:r,realGroup:e})}),o.unshift({key:null,title:"Backlog",collapsed:!0,realGroup:{id:null,releaseId:a}}),e.forEach(o,function(e){e.items=[]}),r(o)},scope:this})},moveToGroup:function(e,t,i,n){return this._moveToGroupByIteration(e,t,i,n)},_moveToGroupByIteration:function(t,i,n,r){var o=this.config.store,a=i.realGroup;if(!a||t.iteration&&a.id==t.iteration.id)return void r.call(null);var s=[],u={release:{id:a.releaseId},iteration:a.id?{id:a.id}:null};s.push(function(e){o.save(t.__type,{id:t.id,$set:u,fields:["id",{iteration:["id"]}]}).done({success:function(){e(null,arguments)}})}),s.push(function(e){o.get(t.__type,{id:t.id,fields:["id",{iteration:["id"]}]}).done({success:function(t){e(null,t[0].data)}})}),e.series(s,function(t,i){e.isFunction(r)&&r.call(null,{changed:i[1]})})}})});