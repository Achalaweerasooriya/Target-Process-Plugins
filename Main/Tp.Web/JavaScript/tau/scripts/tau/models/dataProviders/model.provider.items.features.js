define(["Underscore","tau/models/dataProviders/model.provider.items.base"],function(_,a){return a.extend({fetch:function(a){this.config.store.get("entityState",{fields:["id",{entityType:["id","name"]},{role:["id","name"]},{process:["id"]}]}).get("project",{fields:["id",{process:["id"]}]}).done({scope:this,success:this.onReadyToFetch(a)})},onReadyToFetch:function(a){return function(b){this.entityStates=b[0].data,this.projects=b[1].data,this._fetch("features","feature","priority",a)}},_createDetailCommand:function(a){var b={};return b[a]=["id","name","numericPriority","tags","effort","effortCompleted","effortToDo","timeSpent","timeRemain","userStories-count",{entityState:["id","name","isInitial","isFinal","numericPriority"]},{assignments:["id",{role:["id"]},{generalUser:["id","firstName","lastName"]}]},{priority:["id","name","importance"]},{project:["id"]}],b},_convertData:function(b){return b=a.prototype._convertData.call(this,b),_.forEach(b,function(a){a.visibleEntityState=a.entityState.name}),b=this._calculateEffortToMaximum(b),this._sortByPriority(b)},_convertItem:function(a){var b=this,c=_(this.projects).detect(function(b){return b.id===a.project.id}),d=c.process.id,e=_(this.entityStates).chain().select(function(a){return a.entityType.name.toLowerCase()==="feature"&&a.process.id===d&&a.role!==null}).pluck("role").value(),f=_(e).reduce(function(a,b,c){if(0==c||!_.detect(a,function(a){return a.id===b.id}))a[a.length]=b;return a},[]);a.roleEfforts=_(f).map(function(a){return{role:a}});var g={id:a.id,name:a.name,__type:a.__type,numericPriority:a.numericPriority,entityState:{id:a.entityState.id,name:a.entityState.name,isInitial:a.entityState.isInitial,isFinal:a.entityState.isFinal,numericPriority:a.entityState.numericPriority},tags:this._processTags(a),effort:this._getEffortData(a),assignments:this._processAssignments(a),priority:{id:a.priority.id,name:a.priority.name,kind:b.importanceProcessor.getKind(a.priority.importance)},entitiesCount:a["userStories-count"]};return g}})})