define(["Underscore","tau/models/dataProviders/model.provider.items.base"],function(_,BaseProvider){return BaseProvider.extend({fetch:function(fnCallback){this.config.store.get("entityState",{fields:["id",{entityType:["id","name"]},{role:["id","name"]},{process:["id"]}]}).get("project",{fields:["id",{process:["id"]}]}).done({scope:this,success:this.onReadyToFetch(fnCallback)})},onReadyToFetch:function(callback){return function(r){this.entityStates=r[0].data,this.projects=r[1].data,this._fetch("features","feature","priority",callback)}},_createDetailCommand:function(collectionType){var detailCommand={};return detailCommand[collectionType]=["id","name","numericPriority","tags","effort","effortCompleted","effortToDo","timeSpent","timeRemain","userStories-count",{entityState:this.fields.entityState},{assignments:["id",{role:["id"]},{generalUser:this.fields.generalUser}]},{priority:["id","name","importance"]},{project:["id"]}],detailCommand},_convertData:function(data){return data=BaseProvider.prototype._convertData.call(this,data),_.forEach(data,function(item){item.visibleEntityState=item.entityState.name}),data=this._calculateEffortToMaximum(data),this._sortByPriority(data)},_convertItem:function(data){var self=this;data.project=data.project||{};var itemProject=_(this.projects).detect(function(proj){return proj.id===data.project.id}),itemProcessId=itemProject.process.id,roles=_(this.entityStates).chain().select(function(state){return state.entityType.name.toLowerCase()==="feature"&&state.process.id===itemProcessId&&state.role!==null}).pluck("role").value(),uniqRoles=_(roles).reduce(function(memo,el,i){if(0==i||!_.detect(memo,function(m){return m.id===el.id}))memo[memo.length]=el;return memo},[]);data.roleEfforts=_(uniqRoles).map(function(item){return{role:item}});var item={id:data.id,name:data.name,__type:data.__type,numericPriority:data.numericPriority,entityState:{id:data.entityState.id,name:data.entityState.name,isInitial:data.entityState.isInitial,isFinal:data.entityState.isFinal,numericPriority:data.entityState.numericPriority},tags:this._processTags(data),effort:this._getEffortData(data),assignments:this._processAssignments(data),priority:{id:data.priority.id,name:data.priority.name,kind:self.importanceProcessor.getKind(data.priority.importance)},entitiesCount:data["userStories-count"]};return item}})})