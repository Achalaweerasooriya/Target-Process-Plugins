define(["Underscore","jQuery","tau/models/dataProviders/model.provider.items.base"],function(_,$,BaseProvider){return BaseProvider.extend({sparklineLength:16,fetchStrategy:{project:{collectionName:"projectMembers",typeName:"projectMember"},team:{collectionName:"teamMembers",typeName:"teamMember"}},fetch:function(fnCallback){var entityType=(this.config.context.entity.entityType.name||"").toLowerCase(),fetchStrategy=this.fetchStrategy[entityType];if(!fetchStrategy)throw new Error("Unknown fetch strategy");this._fetch(fetchStrategy.collectionName,fetchStrategy.typeName,null,fnCallback)},_createDetailCommand:function(collectionType){var detailCommand={};return detailCommand[collectionType]=["id",{user:["id","firstName","lastName","email","avatarUri","IsAdministrator","isActive","bug-count","userStorie-count"]},{role:["id","name"]}],detailCommand},_fetch:function(collectionName,typeName,importanceTypeName,fnCallback){var self=this,entity=this.config.context.entity,entityType=entity.entityType.name,configurator=this.config.context.configurator;$.ajax({url:configurator.getApplicationPath()+"/api/v2/"+typeName+"?select={"+["id",'"'+typeName+'" as __type',"new("+["User.id","User.firstName","User.lastName","User.email","User.avatarUri","User.isActive","User.isAdministrator",'User.Assignables.Count(entityType.Name == "Bug" AND entityState.IsFinal != true AND '+entityType+".id = "+entity.id+") as bugsCount",'User.Assignables.Count(entityType.Name == "Task" AND entityState.IsFinal != true AND '+entityType+".id = "+entity.id+") as tasksCount",'User.Assignables.Count(entityType.Name == "UserStory" AND entityState.IsFinal != true AND '+entityType+".id = "+entity.id+") as userStoriesCount","User.Assignables.Where("+entityType+".id = "+entity.id+").Sparkline("+this.sparklineLength+") as allSparkline"].join(",")+") as user","new("+["Role.id","Role.name"].join(",")+") as role "].join(",")+"}&where=("+entityType+".id=="+entity.id+")&take=1000"}).done(function(data){fnCallback(self._convertData(data.items))}).fail(function(){fnCallback(self._convertData([]))})},_convertItem:function(data){data.user.name=_.trim(_.asString(data.user.firstName)+" "+_.asString(data.user.lastName))||"",data.user.url="#user/"+data.user.id;var configurator=this.config.context.configurator,r={id:data.id,__type:data.__type,user:data.user,role:data.role,appPath:configurator.getApplicationPath(),doneSparkline:data.user.doneSparkline,allSparkline:data.user.allSparkline};return configurator.getStore().register(r),r}})})