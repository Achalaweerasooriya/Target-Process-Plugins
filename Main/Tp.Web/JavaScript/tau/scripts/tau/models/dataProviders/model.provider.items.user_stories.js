define(["Underscore","tau/models/dataProviders/model.provider.items.base"],function(_,BaseProvider){return BaseProvider.extend({fetch:function(fnCallback){this._fetch("userStories","userStory","priority",fnCallback)},fetchForGroup:function(group,fnCallback){var ctx=this.config.context,entityTypeName=ctx.entity.entityType.name,entityId=ctx.entity.id,practices=ctx.applicationContext.processes[0].practices,practicesArr=_.pluck(practices,"name"),storeChain=this.config.store,collectionName="userStories",typeName="userStory",cmd=this._createDetailCommand(collectionName),command={id:entityId,nested:!0,fields:[cmd]};storeChain=storeChain.get(entityTypeName,command);var self=this,_success=function(details){var data=_(details).pluck("data")[0][collectionName];_.map(data,function(item){item.__type=typeName}),data=_.filter(data,function(item){return item.entityState.name==group.key});var result=self._convertData(data);fnCallback(result)};storeChain.done({success:_success,scope:self})},_createDetailCommand:function(collectionType){var detailCommand={};detailCommand[collectionType]=["id","name","numericPriority","tags",{priority:["id","name","importance"]},"effort","effortCompleted","effortToDo","timeSpent","timeRemain","tasks-count","tasks-effort-sum","tasks-effortToDo-sum",{feature:["id"]},{entityState:this.fields.entityStateWithComment},{roleEfforts:["id","effort","effortToDo",{role:["id","name","isPair","hasEffort"]}]},{assignments:["id",{role:["id"]},{generalUser:this.fields.generalUser}]}];var projectField={project:["id"]};return this.config.multiprojects&&projectField.project.push("abbreviation"),detailCommand[collectionType].push(projectField),this.config.additionalFields&&_.indexOf(this.config.additionalFields,"iteration")>-1&&detailCommand[collectionType].push({iteration:["id","name"]}),detailCommand},_convertData:function(data){return data=BaseProvider.prototype._convertData.call(this,data),data=this._calculateEffortToMaximum(data),this._sortByPriority(data)},_convertItem:function(data){var self=this;data.project=data.project||{};var item={id:data.id,name:data.name,__type:data.__type,numericPriority:data.numericPriority,entityState:{id:data.entityState.id,name:data.entityState.name,isInitial:data.entityState.isInitial,isFinal:data.entityState.isFinal,numericPriority:data.entityState.numericPriority},tags:this._processTags(data),priority:{id:data.priority.id,name:data.priority.name,kind:self.importanceProcessor.getKind(data.priority.importance)},effort:this._getEffortData(data),assignments:this._processAssignments(data),projectId:data.project.id,entitiesCount:data["tasks-count"],url:this.config.context.configurator.getUrlBuilder().getNewViewUrl(data.id,data.__type,!0)};return this.config.multiprojects&&(item.project={id:data.project.id,abbreviation:data.project.abbreviation}),this.config.additionalFields&&_.indexOf(this.config.additionalFields,"iteration")>-1&&(item.iteration={id:data.iteration?data.iteration.id:null,name:data.iteration?data.iteration.name:null}),item}})})