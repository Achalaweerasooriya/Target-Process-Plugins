define(["Underscore","tau/models/dataProviders/model.provider.items.base"],function(a,b){return b.extend({fetch:function(a){this._fetch("userStories","userStory","priority",a)},fetchForGroup:function(b,c){var d=this.config.context,e=d.entity.entityType.name,f=d.entity.id,g=d.applicationContext.processes[0].practices,h=a.pluck(g,"name"),i=this.config.store,j="userStories",k="userStory",l=this._createDetailCommand(j),m={id:f,nested:!0,fields:[l]};i=i.get(e,m);var n=this,o=function(d){var e=a(d).pluck("data")[0][j];a.map(e,function(a){a.__type=k}),e=a.filter(e,function(a){return a.entityState.name==b.key});var f=n._convertData(e);c(f)};i.done({success:o,scope:n})},_createDetailCommand:function(b){var c={};c[b]=["id","name","numericPriority","tags",{priority:["id","name","importance"]},"effort","effortCompleted","effortToDo","timeSpent","timeRemain","tasks-count","tasks-effort-sum","tasks-effortToDo-sum",{entityState:["id","name","isInitial","isFinal","numericPriority","isCommentRequired",{nextStates:["id"]}]},{roleEfforts:["id","effort","effortToDo",{role:["id","name","isPair","hasEffort"]}]},{assignments:["id",{role:["id"]},{generalUser:["id","firstName","lastName"]}]}];var d={project:["id"]};return this.config.multiprojects&&d.project.push("abbreviation"),c[b].push(d),this.config.additionalFields&&a.indexOf(this.config.additionalFields,"iteration")>-1&&c[b].push({iteration:["id","name"]}),c},_convertData:function(a){return a=b.prototype._convertData.call(this,a),a=this._calculateEffortToMaximum(a),this._sortByPriority(a)},_convertItem:function(b){var c=this,d={id:b.id,name:b.name,__type:b.__type,numericPriority:b.numericPriority,entityState:{id:b.entityState.id,name:b.entityState.name,isInitial:b.entityState.isInitial,isFinal:b.entityState.isFinal,numericPriority:b.entityState.numericPriority},tags:this._processTags(b),priority:{id:b.priority.id,name:b.priority.name,kind:c.importanceProcessor.getKind(b.priority.importance)},effort:this._getEffortData(b),assignments:this._processAssignments(b),projectId:b.project.id,entitiesCount:b["tasks-count"]};return this.config.multiprojects&&(d.project={id:b.project.id,abbreviation:b.project.abbreviation}),this.config.additionalFields&&a.indexOf(this.config.additionalFields,"iteration")>-1&&(d.iteration={id:b.iteration?b.iteration.id:null,name:b.iteration?b.iteration.name:null}),d}})})