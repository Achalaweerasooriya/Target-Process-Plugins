define(["Underscore","tau/models/dataProviders/model.provider.items.base"],function(e,t){return t.extend({fetch:function(t){var n=this.config.context.entity.id,i=this.config.context.entity.entityType.name.toLowerCase(),a=this.config.customField,r=this.config.store,s=this;r.get(i,{id:n,fields:["customFields"]}).done(function(n){var i=e.find(n[0].data.customFields,function(e){return e.name==a.name});if(null==i.value)return void t([]);var c=i.value.split(","),u=e.map(c,function(e){var t=e.split(" ");return{id:t[0],type:t[1]}}),o=e.uniq(e.map(u,function(e){return e.type})),d=e.uniq(e.map(u,function(e){return e.id})),f=e.map(o,function(e){return function(t){r.find(e,{fields:s._getFieldsForEntity(e),$query:{id:{$in:d}}}).done({success:function(e){t(!1,e[0].data)}})}});e.parallel(f,function(n,i){var a=[];e.reduce(i,function(e,t){return t.length>0&&e.push({type:t[0].__type,items:t}),e},a),a=e.sortBy(a,function(e){return e.items.length>0&&e.items[0].entityType.id}),t(s.transform(a))})})},_getFieldsForEntity:function(e){var t=["id","name",{entityType:["name"]},{project:["abbreviation"]}];switch(e.toLowerCase()){case"userstory":case"bug":case"feature":case"task":case"testplanrun":case"testcaserun":case"request":return t.concat([{entityState:["name","isFinal"]},{release:["name"]},{iteration:["name"]}]);case"project":case"release":case"program":return t.concat(["startDate","endDate"]);case"iteration":return t.concat(["startDate","endDate",{release:["name"]}]);case"build":return t.concat(["buildDate",{release:["name"]},{iteration:["name"]}]);case"impediment":return t.concat([{entityState:["name","isFinal"]}]);case"testcase":return t.concat(["lastStatus"]);default:return t}},transform:function(t){var n=[],i=0;e.reduce(t,function(t,n){return e.forEach(n.items,function(e){t.push(e),e.entityType.id>i&&(i=e.entityType.id)},this),t},n,this);var a=this;return n=e.map(n,function(e){return e.url=a.config.context.configurator.getUrlBuilder().getNewViewUrl(e.id,e.entityType.name,!0),e}),e.sortBy(n,function(e){return e.entityState&&e.entityState.isFinal?i+e.entityType.id:e.entityType.id
})}})});