define(["Underscore","tau/models/dataProviders/model.provider.items.base"],function(_,BaseProvider){return BaseProvider.extend({fetch:function(fnCallback){var entityId=this.config.context.entity.id,entityType=this.config.context.entity.entityType.name.toLowerCase(),targetField=this.config.customField,store=this.config.store,self=this;store.get(entityType,{id:entityId,fields:["customFields"]}).done(function(res){var field=_.find(res[0].data.customFields,function(v){return v.name==targetField.name});if(field.value==null){fnCallback([]);return}var values=field.value.split(","),entityMap=_.map(values,function(item){var parts=item.split(" ");return{id:parts[0],type:parts[1]}}),types=_.uniq(_.map(entityMap,function(item){return item.type})),ids=_.uniq(_.map(entityMap,function(item){return item.id})),requests=_.map(types,function(type){return function(next){store.find(type,{fields:self._getFieldsForEntity(type),$query:{id:{$in:ids}}}).done({success:function(r){next(!1,r[0].data)}})}});_.parallel(requests,function(err,results){var adapted=[];_.reduce(results,function(memo,r){return r.length>0&&memo.push({type:r[0].__type,items:r}),memo},adapted),adapted=_.sortBy(adapted,function(item){return item.items.length>0&&item.items[0].entityType.id}),fnCallback(self.transform(adapted))})})},_getFieldsForEntity:function(entityType){var baseFieldSet=["id","name",{entityType:["name"]},{project:["abbreviation"]}];switch(entityType.toLowerCase()){case"userstory":case"bug":case"feature":case"task":case"testplanrun":case"testcaserun":case"request":return baseFieldSet.concat([{entityState:["name","isFinal"]},{release:["name"]},{iteration:["name"]}]);case"project":case"release":case"program":return baseFieldSet.concat(["startDate","endDate"]);case"iteration":return baseFieldSet.concat(["startDate","endDate",{release:["name"]}]);case"build":return baseFieldSet.concat(["buildDate",{release:["name"]},{iteration:["name"]}]);case"impediment":return baseFieldSet.concat([{entityState:["name","isFinal"]}]);case"testcase":return baseFieldSet.concat(["lastStatus"]);default:return baseFieldSet}},transform:function(itemsGrouped){var items=[],maxEntityTypeId=0;_.reduce(itemsGrouped,function(itemsMemo,itemsGroup){return _.forEach(itemsGroup.items,function(item){itemsMemo.push(item),item.entityType.id>maxEntityTypeId&&(maxEntityTypeId=item.entityType.id)},this),itemsMemo},items,this);var self=this;return items=_.map(items,function(v){return v.url=self.config.context.configurator.getUrlBuilder().getNewViewUrl(v.id,v.entityType.name,!0),v}),_.sortBy(items,function(item){return item.entityState&&item.entityState.isFinal?maxEntityTypeId+item.entityType.id:item.entityType.id})}})})