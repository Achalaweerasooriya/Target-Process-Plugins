define(["Underscore","tau/models/dataProviders/model.provider.items.base"],function(e,t){return t.extend({sparklineLength:16,init:function(e){this._super(e);var t=e.context.configurator.getFeaturesService();this._canCustomizeTeamProject=t.isEnabled("process.sub.workflows")},fetch:function(e){this._fetch("teamProjects","teamProject",!1,e)},_fetch:function(e,t,r,o){var i=this,s=this.config.context.entity,n=this.config.context.configurator;$.ajax({url:n.getApplicationPath()+"/api/v2/TeamProject?select={"+["id","isProjectAccessed","Team.TeamMembers.Select(User.id) as teamMembers","Team.TeamMembers.Count() as teamMembersCount",'"TeamProject" as __type',"Workflows.Select({Id,Name,ParentWorkflow}) as Workflows","new("+["Project.id","Project.name","Project.color","Project.ProjectMembers.Select(User.id) as projectMembers","Project.Bugs.Count(entityState.IsFinal != true AND Team.id = "+s.id+") as openBugsCount","Project.Bugs.Count(entityState.IsFinal == true AND Team.id = "+s.id+") as closedBugsCount","Project.UserStories.Count(entityState.IsFinal != true AND Team.id = "+s.id+") as openUsCount","Project.UserStories.Count(entityState.IsFinal == true AND Team.id = "+s.id+") as closedUsCount","Project.UserStories.Where(Team.id = "+s.id+").Sparkline("+this.sparklineLength+") as userStoriesSparkline","Project.Bugs.Where(Team.id = "+s.id+").Sparkline("+this.sparklineLength+") as bugsSparkline"].join(",")+") as project"].join(",")+"}&where=(Team.id=="+s.id+")&take=1000"}).done(function(e){o(i._convertData(e.items))}).fail(function(){o(i._convertData([]))})},_convertData:function(e){return e=this._super(e),this._sortByPriority(e)},_sortByPriority:function(t){return e.sortBy(t,function(e){return-1*e.id})},_convertItem:function(t){var r=t.project.userStoriesSparkline,o=t.project.bugsSparkline,i=t.workflows&&t.workflows.length>0&&e.some(t.workflows,function(e){return e.parentWorkflow}),s={id:t.id,__type:"teamProject",teamMembers:t.teamMembers,isProjectAccessed:t.isProjectAccessed,teamMembersCount:t.teamMembers.length,teamMembersInProjectCount:e.intersection(t.teamMembers,t.project.projectMembers).length,project:t.project,uri:this.config.context.configurator.getUrlBuilder().getNewViewUrl(t.project.id,"project",!0),appPath:this.config.context.configurator.getApplicationPath(),userStoriesSparkline:r,bugsSparkline:o,canCustomizeTeamProject:this._canCustomizeTeamProject,isTeamWorkflowChanged:i};
return s}})});