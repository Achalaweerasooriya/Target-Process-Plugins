define(["Underscore","tau/models/board.context.output/model.board.context.output.data","tau/models/board.context.selector/model.board.context.selector"],function(e,t,a){return t.extend({CONVERT_MAP:{None:"null",Any:"*"},"bus beforeInit":function(e){var t=e.data.config.context.configurator;this.contextStore=t.getApplicationContextService(),this.acidStore=t.getAppStateStore(),this._super(e),this._model=new a(t.getFeaturesService())},"bus model.setFilter":function(t,a){var o=this.fire.bind(this),i=a.selectedProjectsIds,r=a.selectedTeamsIds;if(this._selectedCache&&e.isEqual(this._selectedCache.teams,r)&&e.isEqual(this._selectedCache.projects,i))return void o("currentContextSelected");var s=function(e){var t=this.CONVERT_MAP[e];return t?t:e}.bind(this),n={projectIds:e.map(i,s),teamIds:e.map(r,s)};this.contextStore.getApplicationContext(n,{success:function(e){o("context.changed",e),o("track.new.context",e)}})},"bus context.changed":function(e,t){this.contextStore.markAsDirty(),this.acidStore.set({set:{acid:t.acid,appContext:t.appContext}})},"bus teams.ready + projects.ready + context.ready":function(){},"bus teams.ready + projects.ready + programs.ready + context.ready":function(e,t,a,o,i){var r=this._model.getData(t,a,o,i);this.fire("dataBind",r),this._trackData(r)},_setupStore:function(e,t){this._super(e,t),t.unbind(this);var a=this.fire.bind(this);t.on({type:"project",eventName:"afterSave",listener:this},function(e){e.data.cmd&&"context"!=e.data.cmd.type&&t.get("project",{id:e.data.id,fields:["id","name","color",{process:["id","name"]},{program:["id","name"]}]}).done(function(e){a("project.add.success",e[0].data)})}),t.on({type:"team",eventName:"afterSave",listener:this},function(e){e.data.cmd&&"context"!=e.data.cmd.type&&t.get("team",{id:e.data.id,fields:["id","name","icon"]}).done(function(e){a("team.add.success",e[0].data)})}),t.on({type:"program",eventName:"afterRemove",listener:this},function(e){a("program.removed",{id:e.data.id})}),t.on({type:"program",eventName:"afterSave",listener:this},function(e){e.data.cmd&&"context"!=e.data.cmd.type&&a("program.save",{id:e.data.id})
})},"bus store.ready:last + program.save + context.ready:last":function(t,a,o,i){a.get("program",{id:o.id,fields:["id","name",{projects:["id","name","color","isActive",{process:["id"]}]}]}).done(function(t){var a=t[0].data;a.projects=e.where(a.projects,{isActive:!0}),this.fire("program.saved",this._model.getProgram(a,i))}.bind(this))},"bus project.add.success + context.ready:last":function(t,a,o){var i=this._model._getSelectedOnViewProjectIds(o),r=e.extend(this._model._getListItem(a),{selected:e.contains(i,a.id)});this.fire("project.saved",r)},"bus program.add.completed + context.ready:last":function(t,a,o){var i=this._model.getProgram(a,o);e.each(i.projects,function(e){e.selected=!0}),i.selected=!0,this.fire("program.saved",i)},_trackData:function(){}})});