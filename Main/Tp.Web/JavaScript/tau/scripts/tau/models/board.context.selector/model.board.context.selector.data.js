define(["Underscore","tau/models/board.context.output/model.board.context.output.data","tau/models/board.context.selector/model.board.context.selector"],function(e,t,a){return t.extend({CONVERT_MAP:{None:"null",Any:"*"},"bus beforeInit":function(e){var t=e.data.config.context.configurator;this.contextStore=t.getApplicationContextService(),this.acidStore=t.getAppStateStore(),this._hashService=t.getHashService(),this._history=t.getHistory(),this._super(e)},"bus model.setFilter":function(t,a){var o=this.fire.bind(this),r=a.selectedProjectsIds,s=a.selectedTeamsIds;if(this._selectedCache&&e.isEqual(this._selectedCache.teams,s)&&e.isEqual(this._selectedCache.projects,r))return void o("currentContextSelected");var i=function(e){var t=this.CONVERT_MAP[e];return t?t:e}.bind(this),n={projectIds:e.map(r,i),teamIds:e.map(s,i)};this.contextStore.getApplicationContext(n,{success:function(e){o("context.changed",e),o("track.new.context",e)}})},"bus context.changed":function(e,t){this.contextStore.markAsDirty(),this.acidStore.set({set:{acid:t.acid,appContext:t.appContext}}),this._history.updateCurrent({url:"#"+this._hashService.getHash()})},"bus teams.ready + projects.ready + context.ready":function(){},"bus teams.ready + projects.ready + programs.ready + context.ready":function(e,t,a,o,r){var s=this._model.getData(t,a,o,r);this.fire("dataBind",s),this._trackData(s)},_createContextSelectorModel:function(e){this._model=new a(e.getFeaturesService())},_setupStore:function(e,t){this._super(e,t),t.unbind(this);var a=this.fire.bind(this);t.on({type:"project",eventName:"afterSave",listener:this},function(e){e.data.cmd&&"context"!=e.data.cmd.type&&t.get("project",{id:e.data.id,fields:["id","name","color",{process:["id","name"]},{program:["id","name"]}]}).done(function(e){a("project.add.success",e[0].data)})}),t.on({type:"team",eventName:"afterSave",listener:this},function(e){e.data.cmd&&"context"!=e.data.cmd.type&&t.get("team",{id:e.data.id,fields:["id","name","icon"]}).done(function(e){a("team.add.success",e[0].data)
})}),t.on({type:"program",eventName:"afterRemove",listener:this},function(e){a("program.removed",{id:e.data.id})}),t.on({type:"program",eventName:"afterSave",listener:this},function(e){e.data.cmd&&"context"!=e.data.cmd.type&&a("program.save",{id:e.data.id})})},"bus store.ready:last + program.save + context.ready:last":function(t,a,o,r){a.get("program",{id:o.id,fields:["id","name",{projects:["id","name","color","isActive",{process:["id"]}]}]}).done(this.safeCallback(function(t){var a=t[0].data;a.projects=e.where(a.projects,{isActive:!0}),this.fire("program.saved",this._model.getProgram(a,r))}))},"bus project.add.success + context.ready:last":function(e,t,a){var o=this._model._getSelectedOnViewProjectIds(a),r=this._model._getProjectListItem(o,t);this.fire("project.saved",r)},"bus program.add.completed + context.ready:last":function(t,a,o){var r=this._model.getProgram(a,o);e.each(r.projects,function(e){e.selected=!0}),r.selected=!0,this.fire("program.saved",r)},_trackData:function(){}})});