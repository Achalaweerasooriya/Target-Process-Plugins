define(["tau/core/model-base","tau/utils/utils.date"],function(t,e){var i=function(){return!0};return t.extend({init:function(t,e,n){this.name="Attachment Model",this._super.apply(this,arguments),this.filter=this.config.filter||n||i},_getAttachmentFields:function(){return["id","date","name","mimeType","uri","thumbnailUri",{owner:["id","firstName","lastName"]}]},onInit:function(){var t=this.config.context.entity,e=[{attachments:this._getAttachmentFields()}];this.store.get(t.entityType.name,{id:t.id,fields:e},{scope:this,success:this.onAssignableRetrieved}).done()},"bus attachmentUploaded":function(t){var e=this,i=[{general:["id"]}].concat(this._getAttachmentFields());e.store.save("attachment",{id:t.data.data.id,$set:{},fields:i}).done({success:function(){e.bus.fire("attachmentUploadCompleted",{element:t.data.element})}})},onAssignableRetrieved:function(t){for(var e=t.data.attachments,i=this.config&&this.config.selected,n={items:[]},a=0,s=e.length;s>a;a++){var d=e[a];if(this.filter(d)){var r=this.attachmentDTOToModelAttachment(d);n.items.push(r),i&&d.id===i.id&&(r.selected=!0,n.selected=r)}}this.bus.fire("dataBind",n)},attachmentDTOToModelAttachment:function(t){var i=e.parse(e.convertToTimezone(t.date)),n=t.owner||{};return{id:t.id,name:t.name,mimeType:t.mimeType,ownerName:[n.firstName,n.lastName].join(" "),date:e.format.date.short(i),thumbnailUri:t.thumbnailUri,uri:t.uri}}})});