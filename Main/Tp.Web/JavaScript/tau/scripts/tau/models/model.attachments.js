define(["tau/core/model-base","tau/utils/utils.date","tau/utils/utils.convertUserName"],function(t,e,i){var n=function(){return!0};return t.extend({init:function(t,e,i){this.name="Attachment Model",this._super.apply(this,arguments),this.filter=this.config.filter||i||n},_getAttachmentFields:function(){return["id","date","name","description","mimeType","uri","thumbnailUri",{owner:["id","firstName","lastName"]}]},onInit:function(){var t=this.config.context.entity,e=[{attachments:this._getAttachmentFields()}];this.store.get(t.entityType.name,{id:t.id,fields:e},{scope:this,success:this.onAssignableRetrieved,failure:function(t){this.fire("load.error",t)}}).done()},"bus attachmentUploaded":function(t){var e=this,i=[{general:["id"]}].concat(this._getAttachmentFields());e.store.save("attachment",{id:t.data.data.id,$set:{},fields:i}).done({success:function(){e.bus.fire("attachmentUploadCompleted",{element:t.data.element})}})},onAssignableRetrieved:function(t){for(var e=t.data.attachments,i=this.config&&this.config.selected,n={items:[]},a=0,s=e.length;s>a;a++){var r=e[a];if(this.filter(r)){var o=this.attachmentDTOToModelAttachment(r);n.items.push(o),i&&r.id===i.id&&(o.selected=!0,n.selected=o)}}this.bus.fire("dataBind",n)},attachmentDTOToModelAttachment:function(t){var n=e.parse(e.convertToTimezone(t.date)),a=t.owner||{},s=t.name!==t.description?t.description:null;return{id:t.id,name:t.name,description:s,mimeType:t.mimeType,ownerName:i.getFullName(a),date:e.format.datetime.short(n),thumbnailUri:t.thumbnailUri,uri:t.uri}}})});