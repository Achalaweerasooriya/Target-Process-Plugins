define(["Underscore","jQuery","tau/core/extension.base","tau/models/testSteps/model.testStep.list.fetcher"],function(e,t,i,r){return i.extend({"bus beforeInit":function(e,t){var i=t.config;this.entityId=i.context.entity.id,this.store=i.store,this.entityTypeName=i.context.entity.entityType.name,this.dataFetcher=new r(i),this._fetch(),this.fire("model.changes",[])},"bus model.changes:last + model.record.update":function(t,i,r){if(r.record.id){var s=e.chain(this.model.items).filter(function(e){return e.id==r.record.id}).first().value();if(s&&(s.description!=r.record.description||s.result!=r.record.result||void 0!==r.record.runorder&&s.runorder!=r.record.runorder)){var n=i[i.length-1];i.length&&n.item.record.id==r.record.id?n.item.record=r.record:i.push({op:"edit",item:r})}}else i.push({op:"add",item:r})},"bus model.changes:last + model.remove":function(e,t,i){t=this._purgeQueueElements(t,i.record.id),t.push({op:"delete",item:i}),this.fire("sync.model")},"bus model.changes:last + sync.model":function(i,r,s){var n=r.pop();if(n){var o=t.Deferred();switch(n.op){case"delete":if(!n.item.record.id)return void this.fire("model.item.removed",n.item);this._removeItem(n.item.record,o),o.done(function(){this.model.items=e.filter(this.model.items,function(e){return e.id!=n.item.record.id}),this.fire("model.item.removed",n.item.element)}.bind(this));break;case"add":this._addItem(n.item.record,o),o.done(function(e){this.model.items.push(this._createModelItem(e[0])),this.fire("model.item.added",{element:n.item.element,id:e[0].id,runOrder:e[0].runOrder})}.bind(this));break;case"edit":this._saveItem(n.item.record,o),o.done(function(t){this.model.items[e.indexOf(this.model.items,e.find(this.model.items,function(e){return e.id==t[0].id},this))]=this._createModelItem(t[0])}.bind(this))}this._handleSynced(o,s),this._evictTestStepsCollection(n),this.fire("sync.model")}},_handleSynced:function(e,t){t&&t.syncedDeferred&&e.done(t.syncedDeferred.resolve)},"bus model.changes":function(e,t){this.changes=t
},destroy:function(){e.each(this.changes,function(e){"edit"==e.op&&this._saveItem(e.item.record,t.Deferred())}.bind(this)),this._super()},_evictTestStepsCollection:function(e){(e.item.record.runorder||"delete"==e.op)&&this.store.evictProperties(this.entityId,this.entityTypeName,["testSteps"])},_purgeQueueElements:function(t,i){if(!t.length)return t;var r=e.reject(t,function(e){return e.item.record.id==i});return r.length!=t.length?(this.fire("model.changes",r),r):t},_fetch:function(){this.dataFetcher.fetch().always(function(e){this.model=this._getTestSteps(e),this.fire("dataBind",this.model)}.bind(this))},_getTestSteps:function(e){var t=e[0]&&e[0].data&&e[0].data.testSteps?e[0].data.testSteps:[];return{items:this._createModelItems(t)}},_createModelItems:function(t){return e.map(t,function(e){return this._createModelItem(e)},this)},_createModelItem:function(e){return{id:e.id,description:this._tryGetProperty(e,"Description")||"",result:this._tryGetProperty(e,"Result")||"",runorder:this._tryGetProperty(e,"RunOrder"),__type:e.__type}},_tryGetProperty:function(e,t){return e[t]||e[this.lowerCaseFirstLetter(t)]},lowerCaseFirstLetter:function(e){return e.charAt(0).toLowerCase()+e.slice(1)},_saveItem:function(e,t){this.store.save("teststep",this._getUpdateFieldConfiguration(e),this._getStoreBehavior(t)).done()},_addItem:function(e,t){this.store.save("teststep",this._getDefaultFieldConfiguration(e),this._getStoreBehavior(t)).done()},_removeItem:function(e,t){this.store.remove("teststep",{id:e.id},this._getStoreBehavior(t)).done()},_getDefaultFieldConfiguration:function(e){return{$set:{description:e.description,result:e.result,runOrder:e.runorder,testCase:{id:this.entityId}},fields:["id","description","result","runOrder",{testCase:["id"]}]}},_getUpdateFieldConfiguration:function(e){return t.extend(this._getDefaultFieldConfiguration(e),{id:e.id})},_getStoreBehavior:function(e){return{scope:this,success:function(t){e.resolve([t.data])},failure:function(){this.fire("refresh")}}}})
});