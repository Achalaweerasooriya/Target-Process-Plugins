define(["Underscore","jQuery","tau/core/extension.base","tau/models/testSteps/model.testStep.list.fetcher","tau/utils/utils.date"],function(t,e,s,i,n){return s.extend({"bus beforeInit":function(t,e){var s=e.config;this.dataFetcher=new i(s),this.store=s.store,this.testStepRuns=[],this.entityId=s.context.entity.id,this._fetch()},"bus model.update.status":function(t,e){this._updateItem({id:e.id,passed:"passed"==e.passed?!0:!1})},"bus model.set.status":function(t,e){this._saveItem({id:e.id,passed:"passed"==e.passed?!0:!1})},_fetch:function(){this.dataFetcher.fetch().always(function(t){this.testStepRuns=this._getTestStepsRuns(t),this.fire("dataBind",this.testStepRuns)}.bind(this))},_saveItem:function(t){this.store.save("teststeprun",this._getFieldConfiguration(t),this._getStoreBehavior()).done()},_updateItem:function(t){this.store.save("teststeprun",this._getUpdateFieldConfiguration(t),this._getStoreBehavior()).done()},_getUpdateFieldConfiguration:function(t){return{$set:{id:t.id,passed:t.passed},fields:["id","passed"]}},_getFieldConfiguration:function(e){var s=this._getUpdateFieldConfiguration(e);return t.defaults(s.$set,{runned:!0}),s.fields.push("runned"),s},_getStoreBehavior:function(){return{scope:this,success:function(t){this._updateModel(t.data),this.fire("model.did.update",t.data)}}},_getTestStepsRuns:function(e){var s=e[0]&&e[0].data&&e[0].data.testStepRuns?e[0].data.testStepRuns:[];return{items:t.map(s,function(t){return{id:t.id,step:t.testStep,passed:t.Passed,runned:t.Runned}}.bind(this))}},_updateModel:function(e){var s=t.find(this.testStepRuns.items,function(t){return t.id===e.id});s&&(s.passed=e.passed,this._changeTestCaseRunStateIfNeeded(s))},_changeTestCaseRunStateIfNeeded:function(e){var s,i;e.passed?s=t.every(this.testStepRuns.items,function(t){return t.passed}):i=1==t.reduce(this.testStepRuns.items,function(t,e){return null==e.passed||e.passed?t:++t},0),(i||s)&&this.store.save("testcaserun",{$set:{id:this.entityId,passed:e.passed,runDate:n.format.datetime.full(n.getServerNow())},fields:["passed","runDate"]}).done()
}})});