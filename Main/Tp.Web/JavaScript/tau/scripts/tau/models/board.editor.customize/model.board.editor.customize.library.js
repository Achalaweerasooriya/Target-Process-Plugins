define(["Underscore","jQuery","tau/core/extension.base","tau/ui/ui.templateFactory"],function(t,e,n,i){return n.extend({"bus beforeInit":function(n,i){var r=i.config.context.configurator,a=r.getAppStateStore();this.fire("dataBind",{units:[],search:""});var s=t.bind(function(){var n=r.getUnitsRegistry(),i=r.getCustomFieldsUnitsFactory(),a=i.getAllUnits();e.when(n.units,a).then(t.bind(function(e,n){this.fire("units.ready",t.flatten([t.values(e),n]))},this))},this);s(),a.unbind({listener:this}),a.bind({fields:["acid"],listener:this,callback:function(){this.fire("acidChanged"),s()}.bind(this)})},"bus configurator.ready + destroy":function(t,e){var n=e.getAppStateStore();n.unbind({listener:this})},"bus public.searchText.changed":function(t,e){this.searchText=e},"bus configurator.ready:last + units.ready:last + layout.changed:last":function(e,n,r,a){function s(e,n){return t.any(e.types,function(t){return n.isApplicableByTypeAndSize(t,e.size)})}var u=i.getTermProcessor(),o=t.chain(a.cardLayout).flatten().map(function(t){return[t.id,!0]}).object().value(),c=t.chain(r).filter(function(t){return s(a,t)}).uniq(function(t){return t.id}).sortBy(function(t){return t.name}).sortBy(function(t){return t.priority||-99999}).map(function(e){var n=t.clone(e),i=t.intersection(a.types,t.chain(n.settings).map(function(t){return t.types}).flatten().value());return n.rank=i.length,n.settings={classes:["dnd_source","maximized"],isDesignMode:!0,metaData:{rank:i.length,id:e.id,title:e.name,header:void 0!==n.header?n.header:n.name,types:i,typesNames:t.map(i,function(t){return{"long":u.getTerm(t,"names"),"short":u.getTerm(t,"iconSmall"),typeId:t}}),showTypes:a.types.length>i.length}},{unit:n,visible:!o[n.id],unitId:n.id}}).value();this.fire("public.unit.readyForLibrary",c),this.fire("refreshData",{units:c,search:this.searchText||"",configurator:n})}})});