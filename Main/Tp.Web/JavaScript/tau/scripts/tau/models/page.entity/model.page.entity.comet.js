define(["Underscore","tau/core/extension.base"],function(_,BaseExtension){return BaseExtension.extend({"bus configurator.ready:last + entity.ready":function(e,configurator,entity){configurator.getAppStateStore().get({fields:["acid"],callback:this._subscribeComet(configurator,entity)})},_subscribeComet:function(configurator,entity){return _.bind(function(r){var acid=r.acid,resourcesToListen=[];resourcesToListen.push({acid:acid,resourceType:entity.entityType.name,filter:"? Id is "+entity.id}),resourcesToListen.push({acid:acid,resourceType:"assignment",filter:"? assignable.Id is "+entity.id}),resourcesToListen.push({acid:acid,resourceType:"roleEffort",filter:"? assignable.Id is "+entity.id}),this.subscription&&this.subscription.stop(),this.lastChanges={},this.subscription=configurator.getComet().listen("resource",_.map(resourcesToListen,function(v){return{parameters:v}})).on({callback:_.bind(function(response){window.appIsInDebugMode&&console.log("resource comet: ",response);var data=response.data,timestamp=response.timestamp,key=data.type+data.id,cometChanges=_.map(data.reason,_.toCamelCase);_.has(this.lastChanges,key)||(this.lastChanges[key]={});var changes=this.lastChanges[key],actualChanges=_.filter(cometChanges,function(changeName){var changedByTime=timestamp>(changes[changeName]||0);return changedByTime&&(changes[changeName]=timestamp),changedByTime}),modification=data.modification.toLowerCase();data.reason=actualChanges,this.handle(modification,data,configurator)},this)}).start()},this)},"bus destroy":function(){delete this.lastChanges,this.subscription&&this.subscription.stop()},handle:function(type,data,configurator){var r=data;switch(type){case"updated":var reason=r.reason;reason.push("id"),r.data.assignable&&reason.push("assignable");var data=_.pick(r.data,reason);data.__type=r.type,configurator.getStore().registerWithEvents(data);break;case"removed":var data=r.data,type=r.type;configurator.getStore().removeWithEvents(data,type);break;case"added":var reason=r.reason;reason.push("id"),r.data.assignable&&reason.push("assignable");var data=r.data;data.__type=r.type,configurator.getStore().registerWithEvents(data)}}})})