define(["Underscore","tau/core/extension.base","tau/models/page.entity/entity.context.factory","tau/services/service.customFields.cached"],function(t,e,i,n){return e.extend({name:"Entity","bus initialize":function(t,e){e&&e.context.configurator.getStore().evictData()},"bus beforeInit":function(e,i){var n=i.config,r=n.context.configurator,o=t.isObject(n.entity)?n.entity:{id:n.id,type:n.entity},c=r.getStore().getTypes().findByKeyword(o.type);if(!c){var a=new Error(t.sprintf('Entity type "%s" does not exist',o.type));return void this.fire("loadingError.ready",a)}var s=this._fillEntityData(o,c,r);this.fire("configurator.ready",r),this._createContext(s,r)},"bus entity.ready + afterRender":function(t,e){this.fire("application.entity.loaded",{id:e.id,entity:e.entityType.name})},"bus destroy":function(){this._customFieldsService&&this._customFieldsService.destroy()},_fillEntityData:function(t,e,i){var n={id:t.id,entityType:{name:e.name}},r=i.getBoardCacheService(),o=r.getData()||{};return t.id==o.id&&(o.name&&(i.getStore().registerWithEvents({id:o.id,name:o.name,__type:t.type}),r.evict()),(o.projectId||o.teamId)&&(n.projectId=o.projectId||null,n.teamId=o.teamId||null,r.evict())),n},_createContext:function(t,e){i.create(t,e).done(function(t){this._customFieldsService=new n({configurator:t.configurator,entity:t.entity,customFields:t.getCustomFields()}),e.registerService("customFieldServiceV2",this._customFieldsService),this.fire("entity.ready",t.entity),this.fire("contextRetrieved",{context:t})}.bind(this)).fail(function(t){this.fire("loadingError.ready",t)}.bind(this))}})});