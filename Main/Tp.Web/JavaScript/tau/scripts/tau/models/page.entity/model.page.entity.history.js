define(["Underscore","jQuery","tau/core/extension.base","tau/models/dataprocessor/model.processor.context","tau/core/termProcessor","tau/models/board.customize.units/const.entity.types"],function(e,t,i,n,r,s){return i.extend({FIELDS:{general:["name"],user:["firstName","lastName"]},fields:null,"bus entity.ready + configurator.ready":function(e,t,i){this.fields=this.FIELDS[t.entityType.name]||this.FIELDS.general;var n=i.getStore();n.unbind(this),n.on({eventName:"afterSave",type:t.entityType.name,id:t.id,fields:this.fields,hasChanges:[this.fields.join("|")],listener:this},this.update.bind(this,t,i)),i.getHistory().setCurrent({url:i.getUrlBuilder().getNewViewUrl(t.id,t.entityType.name,!0),id:t.id})},"bus entity.ready + configurator.ready + storeFreeze.ready":function(e,t,i){this.update(t,i)},update:function(e,i){t.when(this._getApplicationContext(e,i),this._getEntityName(e,i)).then(function(e,t){i.getHistory().updateCurrent({title:this._createTitle(t,e)})}.bind(this))},_getApplicationContext:function(e,i){var r=t.Deferred();return s.isGeneral(e.entityType.name.toLowerCase())?i.getApplicationContextService().getApplicationContext({ids:[e.id]},{success:function(e){var t=n({applicationContext:e});r.resolve(t)}.bind(this)}):r.resolve(null),r},_getEntityName:function(e,i){var n=t.Deferred();return i.getStore().get(e.entityType.name,{id:e.id,fields:["id"].concat(this.fields)}).done(function(e){n.resolve(e[0].data)}.bind(this)),n},_createTitle:function(t,i){var n=i?i.getTerms():null,s=r.getTerm(t.__type,"name",n);return e.sprintf("%s #%d %s",s,t.id,e.values(e.pick(t,this.fields)).join(" "))},"bus configurator.ready + destroy":function(e,t){t.getStore().unbind(this)}})});