define(["require","Underscore","jQuery","tau/core/extension.base","tau/core/termProcessor","tau/const/entityTypes","tau/models/page.entity/entity.context.factory"],function(e){var t=e("Underscore"),n=e("jQuery"),i=e("tau/core/extension.base"),r=e("tau/core/termProcessor"),s=e("tau/const/entityTypes"),a=e("tau/models/page.entity/entity.context.factory");return i.extend({FIELDS:{general:["name"],user:["firstName","lastName"],requester:["firstName","lastName"]},fields:null,"bus entity.ready + configurator.ready":function(e,t,n){this.fields=this.FIELDS[t.entityType.name]||this.FIELDS.general;var i=n.getStore();i.unbind(this),i.on({eventName:"afterSave",type:t.entityType.name,id:t.id,fields:this.fields,hasChanges:[this.fields.join("|")],listener:this},this.safeCallback(function(){this.update(t,n,null)})),n.getHistory().setCurrent({url:n.getUrlBuilder().getNewViewUrl(t.id,t.entityType.name,!0),id:t.id})},"bus contextRetrieved + configurator.ready + storeFreeze.ready":function(e,t,n){this.update(t.context.entity,n,t.context)},update:function(e,t,i){n.when(i||this._getContext(e,t),this._getEntityName(e,t)).then(function(e,n){t.getHistory().updateCurrent({title:this._createTitle(n,e)})}.bind(this))},_getContext:function(e,t){return s.isGeneral(e.entityType.name.toLowerCase())?a.create(e,t):null},_getEntityName:function(e,t){var i=n.Deferred();return t.getStore().get(e.entityType.name,{id:e.id,fields:["id"].concat(this.fields)}).done(function(e){i.resolve(e[0].data)}.bind(this)),i},_createTitle:function(e,n){var i=n?n.getTerms():null,s=r.getTerm(e.__type,"name",i);return t.sprintf("%s #%d %s",s,e.id,t.values(t.pick(e,this.fields)).join(" "))},"bus configurator.ready + destroy":function(e,t){t.getStore().unbind(this)}})});