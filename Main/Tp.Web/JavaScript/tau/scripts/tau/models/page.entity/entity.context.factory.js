define(["require","Underscore","libs/jquery/jquery","tau/models/dataprocessor/model.processor.context","tau/core/tau"],function(t){var e=t("Underscore"),n=t("libs/jquery/jquery"),i=t("tau/models/dataprocessor/model.processor.context"),o=t("tau/core/tau"),a=o.Error,r=function(t){var n={};t.applicationContext.globalSettings=t.globalSettings,e.extend(n,{entity:t.entity,applicationContext:t.applicationContext,componentSettings:t.componentSettings,configurator:t.configurator});var o=i(n);return t.applicationContextAdditions.hasTeams&&(o.applicationContext.edition=["hasTeams"].concat(o.applicationContext.edition)),n},s={notFound:"%s with Id %d not found or access is forbidden",invalidType:'Entity type "%s" does not exist',context:"Context error",teams:"Teams error: %s"},c=["user","testcaserun"];return{create:function(t,i){var o=n.Deferred(),u=[];return u.push(function(t){var e=i.getGlobalSettingsService();e.getGlobalSettings({success:function(e){t(!1,e)},failure:function(){t(!1,{})}})}),u.push(function(n){var o=i.getApplicationContextService(),r="";e.contains(c,t.entityType.name.toLowerCase())||(r=t.id);var u=i.getFeaturesService().isEnabled("contextPrototype"),d=!1;u&&(d=i.getPrototypeContextEntityService().tryBuildContextFromContextPrototype(t.projectId,t.teamId)),d?n(!1,d):o.getApplicationContext({id:r},{success:function(t){n(!1,t)},failure:function(i){var o;if(r){var c="general"==t.entityType.name?"Entity":e.titleize(e.underscored(t.entityType.name).replace("_"," "));o=new a(e.sprintf(s.notFound,c,r)),n(o,i)}else o=new a(e.sprintf(s.context)),n(o,i)}})}.bind(this)),u.push(function(n){"general"==t.entityType.name?i.getStore().get(t.entityType.name,{id:t.id,fields:["id",{entityType:["id","name"]}],failureGlobal:!1}).done({success:function(t){n(!1,t[0].data)},failure:function(){n(new a(e.sprintf(s.notFound,"Entity",t.id)),{})}}):"user"==t.entityType.name?i.getStore().get(t.entityType.name,{id:t.id,fields:["id"],failureGlobal:!1}).done({success:function(){n(!1,t)},failure:function(){n(new a(e.sprintf(s.notFound,"User",t.id)),{})
}}):n(!1,t)}),u.push(function(e){var n=i.getBoardSettingsFactory().createComponentSettings({id:t.entityType.name});e(!1,n)}),u.push(function(t){var n=i.getConfig("hasTeams");e.isUndefined(n)?i.getStore().get("team",{fields:["id"]}).done({success:function(e){var n=e[0].data.length>0;i.setConfig("hasTeams",n),t(!1,{hasTeams:n})},failure:function(n){t(new a(e.sprintf(s.teams,n)),{})}}):t(!1,{hasTeams:n})}),e.parallel(u,function(t,e){t?o.reject(t):o.resolve(r({globalSettings:e[0],applicationContext:e[1],entity:e[2],componentSettings:e[3],applicationContextAdditions:e[4],configurator:i}))}),o}}});