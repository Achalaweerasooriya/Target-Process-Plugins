define(["require","Underscore","libs/jquery/jquery","tau/models/dataprocessor/model.processor.context","tau/core/tau"],function(e){var t=e("Underscore"),n=e("libs/jquery/jquery"),i=e("tau/models/dataprocessor/model.processor.context"),o=e("tau/core/tau"),a=o.Error,r=function(e){var n={};e.applicationContext.globalSettings=e.globalSettings,t.extend(n,{entity:e.entity,applicationContext:e.applicationContext,componentSettings:e.componentSettings,configurator:e.configurator});var o=i(n);return e.applicationContextAdditions.hasTeams&&(o.applicationContext.edition=["hasTeams"].concat(o.applicationContext.edition)),n},s={notFound:"%s with Id %d not found or access is forbidden",invalidType:'Entity type "%s" does not exist',context:"Context error",teams:"Teams error: %s"},c=["user","requester","testcaserun"];return{create:function(e,i){var o=n.Deferred(),u=[];return u.push(function(e){var t=i.getGlobalSettingsService();t.getGlobalSettings({success:function(t){e(!1,t)},failure:function(){e(!1,{})}})}),u.push(function(n){var o=i.getApplicationContextService(),r="";t.contains(c,e.entityType.name.toLowerCase())||(r=e.id);var u=i.getFeaturesService().isEnabled("contextPrototype"),d=!1;u&&(d=i.getPrototypeContextEntityService().tryBuildContextFromContextPrototype(e.projectId,e.teamId)),d?n(!1,d):o.getApplicationContext({id:r},{success:function(e){n(!1,e)},failure:function(i){var o;if(r){var c="general"==e.entityType.name?"Entity":t.titleize(t.underscored(e.entityType.name).replace("_"," "));o=new a(t.sprintf(s.notFound,c,r)),n(o,i)}else o=new a(t.sprintf(s.context)),n(o,i)}})}.bind(this)),u.push(function(n){"general"==e.entityType.name?i.getStore().get(e.entityType.name,{id:e.id,fields:["id",{entityType:["id","name"]}],failureGlobal:!1}).done({success:function(e){n(!1,e[0].data)},failure:function(){n(new a(t.sprintf(s.notFound,"Entity",e.id)),{})}}):"user"==e.entityType.name?i.getStore().get(e.entityType.name,{id:e.id,fields:["id"],failureGlobal:!1}).done({success:function(){n(!1,e)
},failure:function(){n(new a(t.sprintf(s.notFound,"User",e.id)),{})}}):n(!1,e)}),u.push(function(t){var n=i.getBoardSettingsFactory().createComponentSettings({id:e.entityType.name});t(!1,n)}),u.push(function(e){var n=i.getConfig("hasTeams");t.isUndefined(n)?i.getStore().get("team",{fields:["id"]}).done({success:function(t){var n=t[0].data.length>0;i.setConfig("hasTeams",n),e(!1,{hasTeams:n})},failure:function(n){e(new a(t.sprintf(s.teams,n)),{})}}):e(!1,{hasTeams:n})}),t.parallel(u,function(e,t){e?o.reject(e):o.resolve(r({globalSettings:t[0],applicationContext:t[1],entity:t[2],componentSettings:t[3],applicationContextAdditions:t[4],configurator:i}))}),o}}});