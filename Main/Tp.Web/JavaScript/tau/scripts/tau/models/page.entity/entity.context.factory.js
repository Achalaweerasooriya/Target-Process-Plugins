define(["require","Underscore","libs/jquery/jquery","tau/models/dataprocessor/model.processor.context","tau/core/tau","tau/core/termProcessor"],function(e){var t=e("Underscore"),n=e("libs/jquery/jquery"),o=e("tau/models/dataprocessor/model.processor.context"),i=e("tau/core/tau"),r=(e("tau/core/termProcessor"),i.Error),a=function(e){var n={};e.applicationContext.globalSettings=e.globalSettings,t.extend(n,{entity:e.entity,applicationContext:e.applicationContext,componentSettings:e.componentSettings,configurator:e.configurator});var i=o(n);return e.applicationContextAdditions.hasTeams&&(i.applicationContext.edition=["hasTeams"].concat(i.applicationContext.edition)),n},s={notFound:"%s with Id %d not found or access is forbidden",invalidType:'Entity type "%s" does not exist',context:"Context error",teams:"Teams error: %s"},c=["user","testcaserun"];return{create:function(e,o){var i=n.Deferred(),u=[];return u.push(function(e){var t=o.getGlobalSettingsService();t.getGlobalSettings({success:function(t){e(!1,t)},failure:function(){e(!1,{})}})}),u.push(function(n){var i=o.getApplicationContextService(),a="";t.contains(c,e.entityType.name.toLowerCase())||(a=e.id);var u=o.getFeaturesService().isEnabled("contextPrototype"),d=!1;u&&(d=o.getPrototypeContextEntityService().tryBuildContextFromContextPrototype(e.projectId,e.teamId)),d?n(!1,d):i.getApplicationContext({id:a},{success:function(e){n(!1,e)},failure:function(o){var i;if(a){var c="general"==e.entityType.name?"Entity":t.titleize(t.underscored(e.entityType.name).replace("_"," "));i=new r(t.sprintf(s.notFound,c,a)),n(i,o)}else i=new r(t.sprintf(s.context)),n(i,o)}})}.bind(this)),u.push(function(n){"general"==e.entityType.name?o.getStore().get(e.entityType.name,{id:e.id,fields:["id",{entityType:["id","name"]}],failureGlobal:!1}).done({success:function(e){n(!1,e[0].data)},failure:function(){n(new r(t.sprintf(s.notFound,"Entity",e.id)),{})}}):"user"==e.entityType.name?o.getStore().get(e.entityType.name,{id:e.id,fields:["id"],failureGlobal:!1}).done({success:function(){n(!1,e)
},failure:function(){n(new r(t.sprintf(s.notFound,"User",e.id)),{})}}):n(!1,e)}),u.push(function(t){var n=o.getBoardSettingsFactory().createComponentSettings({id:e.entityType.name});t(!1,n)}),u.push(function(e){var n=o.getConfig("hasTeams");t.isUndefined(n)?o.getStore().get("team",{fields:["id"]}).done({success:function(t){var n=t[0].data.length>0;o.setConfig("hasTeams",n),e(!1,{hasTeams:n})},failure:function(n){e(new r(t.sprintf(s.teams,n)),{})}}):e(!1,{hasTeams:n})}),t.parallel(u,function(e,t){e?i.reject(e):i.resolve(a({globalSettings:t[0],applicationContext:t[1],entity:t[2],componentSettings:t[3],applicationContextAdditions:t[4],configurator:o}))}),i}}});