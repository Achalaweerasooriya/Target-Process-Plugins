define(["require","Underscore","libs/jquery/jquery","tau/models/dataprocessor/model.processor.context","tau/core/tau","tau/core/termProcessor"],function(e){var t=e("Underscore"),n=e("libs/jquery/jquery"),o=e("tau/models/dataprocessor/model.processor.context"),i=e("tau/core/tau"),r=e("tau/core/termProcessor"),a=i.Error,s=function(e){var n={};e.applicationContext.globalSettings=e.globalSettings,t.extend(n,{entity:e.entity,applicationContext:e.applicationContext,componentSettings:e.componentSettings,configurator:e.configurator});var i=o(n);return e.applicationContextAdditions.hasTeams&&(i.applicationContext.edition=["hasTeams"].concat(i.applicationContext.edition)),e.configurator.getTemplateFactory().setTermProcessor(new r(i.getTerms())),n},c={notFound:"%s with Id %d not found or access is forbidden",invalidType:'Entity type "%s" does not exist',context:"Context error",teams:"Teams error: %s"},u=["user","testcaserun"];return{create:function(e,o){var i=n.Deferred(),r=[];return r.push(function(e){var t=o.getGlobalSettingsService();t.getGlobalSettings({success:function(t){e(!1,t)},failure:function(){e(!1,{})}})}),r.push(function(n){var i=o.getApplicationContextService(),r="";t.contains(u,e.entityType.name.toLowerCase())||(r=e.id);var s=o.getFeaturesService().isEnabled("contextPrototype"),d=!1;s&&(d=o.getPrototypeContextEntityService().tryBuildContextFromContextPrototype(e.projectId,e.teamId)),d?n(!1,d):i.getApplicationContext({id:r},{success:function(e){n(!1,e)},failure:function(o){var i;if(r){var s="general"==e.entityType.name?"Entity":t.titleize(t.underscored(e.entityType.name).replace("_"," "));i=new a(t.sprintf(c.notFound,s,r)),n(i,o)}else i=new a(t.sprintf(c.context)),n(i,o)}})}.bind(this)),r.push(function(n){"general"==e.entityType.name?o.getStore().get(e.entityType.name,{id:e.id,fields:["id",{entityType:["id","name"]}],failureGlobal:!1}).done({success:function(e){n(!1,e[0].data)},failure:function(){n(new a(t.sprintf(c.notFound,"Entity",e.id)),{})}}):"user"==e.entityType.name?o.getStore().get(e.entityType.name,{id:e.id,fields:["id"],failureGlobal:!1}).done({success:function(){n(!1,e)},failure:function(){n(new a(t.sprintf(c.notFound,"User",e.id)),{})}}):n(!1,e)}),r.push(function(t){var n=o.getBoardSettingsFactory().createComponentSettings({id:e.entityType.name});t(!1,n)}),r.push(function(e){var n=o.getConfig("hasTeams");t.isUndefined(n)?o.getStore().get("team",{fields:["id"]}).done({success:function(t){var n=t[0].data.length>0;o.setConfig("hasTeams",n),e(!1,{hasTeams:n})},failure:function(n){e(new a(t.sprintf(c.teams,n)),{})}}):e(!1,{hasTeams:n})}),t.parallel(r,function(e,t){e?i.reject(e):i.resolve(s({globalSettings:t[0],applicationContext:t[1],entity:t[2],componentSettings:t[3],applicationContextAdditions:t[4],configurator:o}))}),i}}});