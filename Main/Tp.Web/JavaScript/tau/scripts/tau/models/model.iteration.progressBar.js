define(["Underscore","tau/core/model-base"],function(t,e){var o=e.extend({name:"Iteration Progress Bar",afterSaveRoleEffort:function(){this.fire("roleEffortChanged")},onDataUpdate:function(){this.fire("refresh")},floatToString:function(t){return t.toFixed(2).replace(".00","")},_getEffortPoints:function(){return this.config.context.getEffortPoint().shortName},_getDefaultFields:function(){return["bugs-effortToDo-sum","bugs-effortCompleted-sum","userStories-effortToDo-sum","userStories-effortCompleted-sum"]},onInit:function(){var e=this.config.context.entity,o=e.entityType.name,i=e.id,r=this._getDefaultFields();this.store.unbind(this),this.store.on({eventName:"afterSave",type:"roleEffort",listener:this,filter:{assignable:{id:i}}},t.bind(this.afterSaveRoleEffort,this)),this.store.on({eventName:"afterSave",type:o,listener:this,filter:{id:i},hasChanges:[r.join("|")]},t.bind(this.onDataUpdate,this));var s={id:i,fields:r};this.store.get(o,s,{success:this.safeCallback(this.onEntityRetrieved)}).done({success:this.safeCallback(this.done)})},calculatePercentCompleted:function(){var t=Math.round(100*parseFloat(this.effortToDo)+100*parseFloat(this.effortCompleted))/100,e=Math.round(1e4*(this.effortCompleted/t))/100;e=isNaN(e)?0:e,e=e>100?100:e,this.percentCompleted=e},onEntityRetrieved:function(t){var e=t.data,o=e["bugs-effortToDo-sum"]+e["userStories-effortToDo-sum"],i=e["bugs-effortCompleted-sum"]+e["userStories-effortCompleted-sum"];this.effortToDo=o,this.effortCompleted=i,this.calculatePercentCompleted()},done:function(){this.fire("dataBind",{effortToDo:this.floatToString(this.effortToDo),effortCompleted:this.floatToString(this.effortCompleted),percentCompleted:this.percentCompleted,totalEffort:this.floatToString(this.effortToDo+this.effortCompleted),point:this._getEffortPoints()})}});return o});