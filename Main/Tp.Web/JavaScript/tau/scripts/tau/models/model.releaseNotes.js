define(["Underscore","tau/core/model-base","tau/utils/utils.date"],function(_,ModelBase,dateUtils){var model=ModelBase.extend({onInit:function(){var entity=this.config.context.entity,store=this.config.store,self=this;store.unbind(this),store.on({eventName:"afterSave",type:"assignable",listener:this},function(e){var changes=["entityState","name"],types=["feature","userstory","bug"];_.include(types,e.data.cmd.type.toLowerCase())&&_.intersect(_.keys(e.data.changes),changes).length&&self.bus.fire("refresh")});var types=["feature","userstory","bug"];_.forEach(types,function(type){store.on({eventName:"afterRemove",type:type,listener:self},function(e){self.bus.fire("refresh")})}),store.get("release",{id:entity.id,fields:["id","name","startDate","endDate"]}).find("bugs",{fields:["id","name"],$query:{"Release.Id":entity.id,"EntityState.isFinal":1},$orderBy:"id"}).find("features",{fields:["id","name",{release:["id"]},{entityState:["id","isFinal"]},{userStories:["id","name",{release:["id"]},{entityState:["id","isFinal"]}]}],$query:{"Release.Id":entity.id},$orderBy:"id"}).find("userStories",{fields:["id","name",{release:["id"]},{feature:["id"]},{entityState:["id","isFinal"]}],$query:{"Release.Id":entity.id,"EntityState.isFinal":1},$orderBy:"id"}).done({success:function(res){var features=res[2].data,targetFeatures=[],allFeatureIds=_.pluck(features,"id");_.forEach(features,function(feature){var finalUs=[],openUs=[];_.forEach(feature.userStories,function(userStory){userStory.release&&userStory.release.id===feature.release.id&&(userStory.entityState.isFinal==1?finalUs.push(userStory):openUs.push(userStory))}),finalUs.length>0?(feature.userStories=finalUs,targetFeatures.push(feature)):feature.entityState.isFinal==1&&openUs.length>0&&openUs.length==feature.userStories.length&&(feature.userStories=[],targetFeatures.push(feature))});var item=res[0].data;item.endDate=dateUtils.format.date.short(item.endDate);var bugs=res[1].data,userStories=res[3].data;userStories=_.filter(userStories,function(us){return!us.feature||!us.feature.id||_.indexOf(allFeatureIds,us.feature.id)==-1}),self.bus.fire("dataBind",{item:item,features:targetFeatures,bugs:bugs,userStories:userStories})}})}});return model})