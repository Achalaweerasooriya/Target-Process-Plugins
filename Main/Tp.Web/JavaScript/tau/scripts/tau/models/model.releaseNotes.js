define(["Underscore","tau/core/model-base","tau/utils/utils.date"],function(e,t,i){var a=t.extend({onInit:function(){var t=this.config.context.entity,a=this.config.store,r=this;a.unbind(this),a.on({eventName:"afterSave",type:"assignable",listener:this},function(t){var i=["entityState","name"],a=["feature","userstory","bug"];e.include(a,t.data.cmd.type.toLowerCase())&&e.intersection(e.keys(t.data.changes),i).length&&r.bus.fire("refresh")});var n=["feature","userstory","bug"];e.forEach(n,function(e){a.on({eventName:"afterRemove",type:e,listener:r},function(){r.bus.fire("refresh")})}),a.get("release",{id:t.id,fields:["id","name","startDate","endDate"]}).find("bugs",{fields:["id","name"],$query:{"Release.Id":t.id,"EntityState.isFinal":1},$orderBy:"id"}).find("features",{fields:["id","name",{release:["id"]},{entityState:["id","isFinal"]},{userStories:["id","name",{release:["id"]},{entityState:["id","isFinal"]}]}],$query:{"Release.Id":t.id},$orderBy:"id"}).find("userStories",{fields:["id","name",{release:["id"]},{feature:["id"]},{entityState:["id","isFinal"]}],$query:{"Release.Id":t.id,"EntityState.isFinal":1},$orderBy:"id"}).done({success:function(t){var a=t[2].data,n=[],s=e.pluck(a,"id");e.forEach(a,function(t){var i=[],a=[];e.forEach(t.userStories,function(e){e.release&&e.release.id===t.release.id&&(1==e.entityState.isFinal?i.push(e):a.push(e))}),i.length>0?(t.userStories=i,n.push(t)):1==t.entityState.isFinal&&a.length>0&&a.length==t.userStories.length&&(t.userStories=[],n.push(t))});var d=t[0].data;d.endDate=i.format.date.short(d.endDate);var u=t[1].data,o=t[3].data;o=e.filter(o,function(t){return!t.feature||!t.feature.id||-1==e.indexOf(s,t.feature.id)}),r.bus.fire("dataBind",{item:d,features:n,bugs:u,userStories:o})}})}});return a});