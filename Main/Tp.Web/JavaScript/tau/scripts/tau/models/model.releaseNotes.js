define(["Underscore","tau/core/model-base","tau/utils/utils.date"],function(a,b,c){var d=b.extend({onInit:function(){var b=this.config.context.entity,d=this.config.store,e=this;d.unbind(this),d.on({eventName:"afterSave",type:"assignable",listener:this},function(b){var c=["entityState","name"],d=["feature","userstory","bug"];a.include(d,b.data.cmd.type.toLowerCase())&&a.intersect(a.keys(b.data.changes),c).length&&e.bus.fire("refresh")});var f=["feature","userstory","bug"];a.forEach(f,function(a){d.on({eventName:"afterRemove",type:a,listener:e},function(a){e.bus.fire("refresh")})}),d.get("release",{id:b.id,fields:["id","name","startDate","endDate"]}).find("bugs",{fields:["id","name"],$query:{"Release.Id":b.id,"EntityState.isFinal":1},$orderBy:"id"}).find("features",{fields:["id","name",{release:["id"]},{entityState:["id","isFinal"]},{userStories:["id","name",{release:["id"]},{entityState:["id","isFinal"]}]}],$query:{"Release.Id":b.id},$orderBy:"id"}).find("userStories",{fields:["id","name",{release:["id"]},{feature:["id"]},{entityState:["id","isFinal"]}],$query:{"Release.Id":b.id,"EntityState.isFinal":1},$orderBy:"id"}).done({success:function(b){var d=b[2].data,f=[],g=a.pluck(d,"id");a.forEach(d,function(b){var c=[],d=[];a.forEach(b.userStories,function(a){a.release&&a.release.id===b.release.id&&(a.entityState.isFinal==1?c.push(a):d.push(a))}),c.length>0?(b.userStories=c,f.push(b)):b.entityState.isFinal==1&&d.length>0&&d.length==b.userStories.length&&(b.userStories=[],f.push(b))});var h=b[0].data;h.endDate=c.format.date.short(h.endDate);var i=b[1].data,j=b[3].data;j=a.filter(j,function(b){return!b.feature||!b.feature.id||a.indexOf(g,b.feature.id)==-1}),e.bus.fire("dataBind",{item:h,features:f,bugs:i,userStories:j})}})}});return d})