define(["Underscore","tau/core/model-base","tau/utils/utils.date"],function(_,a,b){var c=a.extend({onInit:function(){var a=this.config.context.entity,c=this.config.store,d=this;c.unbind(this),c.on({eventName:"afterSave",type:"assignable",listener:this},function(a){var b=["entityState","name"],c=["feature","userstory","bug"];_.include(c,a.data.cmd.type.toLowerCase())&&_.intersect(_.keys(a.data.changes),b).length&&d.bus.fire("refresh")});var e=["feature","userstory","bug"];_.forEach(e,function(a){c.on({eventName:"afterRemove",type:a,listener:d},function(a){d.bus.fire("refresh")})}),c.get("release",{id:a.id,fields:["id","name","startDate","endDate"]}).find("bugs",{fields:["id","name"],$query:{"Release.Id":a.id,"EntityState.isFinal":1},$orderBy:"id"}).find("features",{fields:["id","name",{release:["id"]},{entityState:["id","isFinal"]},{userStories:["id","name",{release:["id"]},{entityState:["id","isFinal"]}]}],$query:{"Release.Id":a.id},$orderBy:"id"}).find("userStories",{fields:["id","name",{release:["id"]},{feature:["id"]},{entityState:["id","isFinal"]}],$query:{"Release.Id":a.id,"EntityState.isFinal":1},$orderBy:"id"}).done({success:function(a){var c=a[2].data,e=[],f=_.pluck(c,"id");_.forEach(c,function(a){var b=[],c=[];_.forEach(a.userStories,function(d){d.release&&d.release.id===a.release.id&&(d.entityState.isFinal==1?b.push(d):c.push(d))}),b.length>0?(a.userStories=b,e.push(a)):a.entityState.isFinal==1&&c.length>0&&c.length==a.userStories.length&&(a.userStories=[],e.push(a))});var g=a[0].data;g.endDate=b.format.date.short(g.endDate);var h=a[1].data,i=a[3].data;i=_.filter(i,function(a){return!a.feature||!a.feature.id||_.indexOf(f,a.feature.id)==-1}),d.bus.fire("dataBind",{item:g,features:e,bugs:h,userStories:i})}})}});return c})