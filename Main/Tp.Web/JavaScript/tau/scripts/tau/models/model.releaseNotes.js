define(["Underscore","tau/core/model-base","tau/utils/utils.date"],function(a,b,c){var d=b.extend({onInit:function(){var b=this.config.context.entity,d=this.config.store,e=this;d.unbind(this),d.on({eventName:"afterSave",type:"assignable",listener:this},function(b){var c=["entityState","name"],d=["feature","userstory","bug"];a.include(d,b.data.cmd.type.toLowerCase())&&a.intersect(a.keys(b.data.changes),c).length&&e.bus.fire("refresh")});var f=["feature","userstory","bug"];a.forEach(f,function(a){d.on({eventName:"afterRemove",type:a,listener:e},function(a){e.bus.fire("refresh")})}),d.get("release",{id:b.id,fields:["id","name","startDate","endDate"]}).find("bugs",{fields:["id","name"],$query:{"Release.Id":b.id,"EntityState.isFinal":1},$orderBy:"id"}).find("features",{fields:["id","name",{release:["id"]},{userStories:["id","name",{release:["id"]},{entityState:["id","isFinal"]}]}],$query:{"Release.Id":b.id,"EntityState.isFinal":1},$orderBy:"id"}).find("userStories",{fields:["id","name",{release:["id"]},{feature:["id"]},{entityState:["id","isFinal"]}],$query:{"Release.Id":b.id,"Feature.Id":null,"EntityState.isFinal":1},$orderBy:"id"}).done({success:function(b){var d=b[2].data,f=[];a.forEach(d,function(b){var c=[],d=[];a.forEach(b.userStories,function(a){a.entityState.isFinal==1&&a.release&&a.release.id===b.release.id&&c.push(a),!a.entityState.isFinal&&a.release&&a.release.id===b.release.id&&d.push(a)}),c.length>0?(b.userStories=c,f.push(b)):b.userStories.length&&d.length==b.userStories.length&&(b.userStories=[],f.push(b))});var g=b[0].data;g.endDate=c.format.date.short(g.endDate);var h=b[1].data,i=b[3].data;e.bus.fire("dataBind",{item:g,features:f,bugs:h,userStories:i})}})}});return d})