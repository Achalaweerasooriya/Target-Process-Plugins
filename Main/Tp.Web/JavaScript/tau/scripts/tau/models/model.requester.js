define(["Underscore","tau/core/model-base","libs/amanda/amanda"],function(_,a,b){var c=a.extend({"bus afterInit":function(){this.fire("dataBind",{}),this.validation=new b({singleError:!1});var a=this.config.store,c=function(b,c,d,e,f){if(!d||!c)return f();a.find("requester",{$query:{email:c,deleteDate:null}}).done({success:function(a){a[0].data.length==1?f("uniqueEmail"):f()}})};this.validation.validators.uniqueEmail=c,_.extend(this.validation.messages,{required:function(a,b,c){var d={firstName:"First Name",lastName:"Last Name",email:"email"};return"Please enter "+d[a]},uniqueEmail:"Requester with the same email already exists",format:"Please enter valid {{validator}}"})},"bus form.parametersBound":function(a){var b=a.data,c=this.config.store,d={type:"object",properties:{firstName:{required:!0,type:"string"},lastName:{required:!0,type:"string"},email:{required:!0,type:"string",format:"email",uniqueEmail:!0}}},e=this;this.validation.validate(b.parameters,d,function(a){a?e.fire("form.validationFailed",{errors:a}):e.fire("form.validationPassed",{data:b.parameters})})},"bus form.validationPassed":function(a){var b=a.data.data,c=this.config.store,d=this,e=this.config.context.entity;c.save("Requester",{$set:{email:b.email,login:b.email,firstName:b.firstName,lastName:b.lastName},fields:["id"]}).done({success:function(a){var b=a[0].data;c.save(e.entityType.name,{id:e.id,$set:{requesters:[{id:b.id}]},fields:["id"]}).done({success:function(a){}})}})}});return c})