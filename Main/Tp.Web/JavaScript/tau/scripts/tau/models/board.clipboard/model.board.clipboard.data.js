define(["Underscore","tau/core/extension.base","tau/utils/utils.serverErrorTranslator","tau/models/board.customize.units/board.customize.cards.builderSelector","tau/services/customize/service.customize.card.layout.factory","tau/models/board.customize.units/const.card.sizes","tau/models/board.customize.units/board.customize.units.settings.default.clipboard"],function(t,e,a,r,n,i,o){var s=e.extend({"bus configurator.ready:last + options.ready:last + afterInit":function(e,a){var r=a.getClipboardManager();r.getAll(t.bind(function(t,e){this.fire("cards.get",e)},this))},_convertDataForUnits:function(t){t=t||{};var e=t.project||{},a=t.name||"",r=a.split(" "),n=r.shift();return{entity_name_small_sizes:{name:a},team_project_name_long:{name:a},team_team:{icon:t.icon},user_avatar:{avatarUri:t.avatarUri},project_long:{project:{name:e.name,color:t.color}},project_project_icon:{color:t.color},user_name:{firstName:n,lastName:r.join(" ")}}},"bus configurator.ready:last + options.ready:last + cards.ready":function(e,a,r,n){var i=a.getClipboardManager();i.unbind(this);var o=t.bind(function(e,r){var i=!1;if(n.length===r.length){var o=t.map(n,function(t){return t.dataItem.id}),s=t.map(r,function(t){return t.id}),d=t.difference(s,o);i=d.length}else i=!0;i&&this._getLayouts(r,a).done(function(e){r=t.map(r,function(r){return t.extend(r.data,this._convertDataForUnits(r.data.cardData)),this._convertDataForTemplate(r,a,e,r._id,r.isSelected)},this),this.fire("cards.ready",r)}.bind(this)),this.fire("cards.changed")},this);r.refreshTimeout&&(o=t.debounce(o,r.refreshTimeout)),i.bind(this,o)},"bus configurator.ready:last + cards.get":function(e,a,r){var n=r.length;this._loadCardsData(a,r).always(function(e){n!=e.length&&a.getClipboardManager().set(t.map(e,function(t){return t.dataItem.data.type=t.dataItem.type.toLowerCase(),t.dataItem})),this.fire("cards.ready",e),this.fire("dataBind",{cards:e})}.bind(this))},"bus configurator.ready:last + cards.readyToClear":function(e,a,r){var n=a.getClipboardManager(),i=[];
t.forEach(r,function(t){i.push({id:t.id,data:{id:t.entityId,type:t.entityType}})}),n.remove(i,function(){})},"bus configurator.ready:last + cards.update":function(e,a,r){var n=a.getClipboardManager(),i=t.map(r,function(t){return{id:t.id,isSelected:t.isSelected,data:{cardData:t.cardData,id:t.entityId,type:t.entityType}}});n.update(i,function(){})},"bus configurator.ready:last + cards.readyToRemove":function(e,r,n){var i=r.getClipboardManager(),o=r.getStore(),s=this,d=[];t.forEach(n,function(e){d.push(t.bind(function(t,e){o.remove(t.entityType,{id:t.entityId}).done({success:function(){e(!1,{item:t,error:!1})},failure:function(r){var n=r[0].data,i=404!==n.status,o=i?a.translateServerError(n.response):!1;e(!1,{item:t,error:o})}})},s,e))}),t.parallel(d,function(e,a){var r=[],n=[],o=[];t.forEach(a,function(t){if(t.error)n.push(t.item),s.fire("error",t.error);else{var e=t.item;r.push(t.item),o.push({id:e.id,data:{id:e.entityId,type:e.entityType}})}}),i.remove(o,function(){}),s.fire("cards.readyToRemove.after",{success:r,failure:n})})},_getLayouts:function(e,a){var s=t.groupByComplex(e,function(t){return t.data.type.toLowerCase()}),d=t.reduce(s,function(t,e){var a=e.key;return t.cells.types.push(a),t.cardSettings[a]={},t.cardSettings[a][i.L]=o.get(a),t},{cells:{types:[]},cardSettings:{}}),u=new r,c=new n(a,{get:function(){return $.Deferred().resolve(d)}});return c.getCardLayoutsByTypesAndSize(d.cells.types,i.L).then(function(e){return t.reduce(e,function(t,e,a){return t.types.push({type:a,data:u.build(a,e)}),t.mapLayouts[a]=e,t},{types:[],mapLayouts:{}})})},_convertDataForTemplate:function(t,e,a,r,n){t.type=t.type||t.data.type,t._id=r,t.data.cardData=t.data.cardData||{type:t.type};var i=t.type;return{dataItem:t,isSelected:n,configurator:e,layout:a.mapLayouts[i.toLowerCase()]}},getCardsDataByType:function(e,a){var r=t.map(e,function(t){return t.data.id}),n=t.reduce(e,function(t,e){return t[e.data.id]={_id:e._id,isSelected:e.isSelected},t},{}),i={cells:{}};return this._getLayouts(e,a).then(function(e){i.cells.types=e.types;
var o={base64:!0,definition:i},s=a.getSliceFactory().create(o),d={$set:{CardsIds:r}};return s.cardDetails(d).then(function(r){return t.map(r.data.items,function(t){return this._convertDataForTemplate(t,a,e,n[t.data.cardData.id]._id,n[t.data.cardData.id].isSelected)},this)}.bind(this),function(){return[]})}.bind(this))},_loadCardsData:function(e,a){var r=t.groupByComplex(a,function(t){return t.data.type.toLowerCase()}),n=t.map(r,function(t){return this.getCardsDataByType(t.items,e)},this);return $.when.all(n).then(function(e){return t.flatten(e)},function(){return[]})}});return s});