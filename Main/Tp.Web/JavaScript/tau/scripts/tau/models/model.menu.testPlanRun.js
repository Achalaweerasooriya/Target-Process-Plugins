define(["Underscore","jQuery","tau/core/model-base"],function(t,n,e){return e.extend({"bus beforeInit":function(n){var e=n.data.config,i=e.eventNamesSpecial||{};t.defaults(i,{dataBind:"dataBind"}),this._dataBindEventName=i.dataBind;var a=e.context.entity;this._subscribeToStore(a),this._renderActions(a)},_dataBind:function(n){"dataBind"!=this._dataBindEventName&&this.config.context.configurator.isBoardEdition&&(n=t.map(n,function(t,n){return{show:t.show,label:t.label,alias:n,command:this._executeAction.bind(this,t)}},this)),this.fire(this._dataBindEventName,{additionalActions:n})},_executeAction:function(t){this.fire("url.process",t.url)},_renderActions:function(t){return this._getActionsData(t).then(this.fire.bind(this,"actionsData.ready"))},_getActionsData:function(t){var e=n.Deferred();return this.store.freeze(!0).done(function(n){this.store.get(t.entityType.name.toLowerCase(),{id:t.id,fields:["testCaseRuns-count","testRunItems-count","startDate","passedCount","failedCount","notRunCount","onHoldCount","blockedCount",{entityState:["isFinal"]}]}).done({success:function(t){var n=t[0].data;e.resolve(n)}.bind(this),failure:e.reject}),n.unfreeze()}.bind(this)),e.promise()},"bus actionsData.ready":function(t,n){var e=this._getActionMap(n);this._dataBind(e)},_getActionMap:function(t){var n=this.config.context.configurator.getApplicationPath(),e=!t.entityState.isFinal&&t["testCaseRuns-count"]>0,i=t.passedCount>0||t.failedCount>0,a=0===t.notRunCount&&0===t.onHoldCount&&0===t.blockedCount;return{run:{show:e&&!i,url:n+"/Project/QA/TestPlanRun/TestsRunner.aspx?TestPlanRunID="+t.id,label:"Run"},completeRun:{show:e&&i&&!a,url:n+"/Project/QA/TestPlanRun/TestsRunner.aspx?TestPlanRunID="+t.id+"&CompleteRun=1",label:"Complete Run"},newRun:{show:e&&i,url:n+"/Project/QA/TestPlanRun/TestsRunner.aspx?TestPlanRunID="+t.id+"&ReRun=1",label:"New Run"},changeRun:{show:e&&i&&a,url:n+"/Project/QA/TestPlanRun/TestsRunner.aspx?TestPlanRunID="+t.id+"&Edit=1",label:"Change Run"}}},_subscribeToStore:function(t){this.store.unbind(this),this.store.on({eventName:"afterSave",type:"testplanrun",listener:this,filter:{id:t.id},hasChanges:["testCaseRuns-count|passedCount|failedCount|notRunCount|onHoldCount|blockedCount|entityState"]},function(){this.fire("refresh")
}.bind(this))},"bus beforeInit:last + $el.ready":function(t,e){var i=e.config.context.entity,a=n("body").tauIFramePopup();a.on("taupopuphide",function(){this.fire("testplanrun.runCompleted",i)}.bind(this)),this.fire("$iframed.ready",a)},"bus $iframed.ready:last + url.process":function(t,n,e){n.tauIFramePopup("option","url",e+"&rmnav=1&tp3=1"),n.tauIFramePopup("show")},"bus initConfig:last + $iframed.ready:last + destroy":function(t,n,e){this.store.unbind(this),e.tauIFramePopup("destroy")}})});