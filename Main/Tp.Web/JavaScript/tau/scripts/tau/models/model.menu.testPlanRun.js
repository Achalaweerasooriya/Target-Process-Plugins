define(["Underscore","jQuery","tau/core/model-base"],function(t,e,n){return n.extend({"bus beforeInit":function(e){var n=e.data.config,i=n.eventNamesSpecial||{};t.defaults(i,{dataBind:"dataBind"});var s=i.dataBind,o=n.context.entity;this._subscribeToStore(o),this._getActions(o).then(this._dataBind.bind(this,s))},_dataBind:function(e,n){"dataBind"!=e&&this.config.context.configurator.isBoardEdition&&(n=t.map(n,function(t,e){return{show:t.show,label:t.label,alias:e,command:this._executeAction.bind(this,t)}},this)),this.fire(e,{additionalActions:n})},_executeAction:function(t){this.fire("url.process",t.url)},_getActions:function(t){return this._getActionsData(t).then(this._buildActions.bind(this))},_getActionsData:function(t){var n=e.Deferred();return this.store.freeze(!0).done(function(e){this.store.get(t.entityType.name.toLowerCase(),{id:t.id,fields:["testCaseRuns-count","testRunItems-count","passedCount","failedCount","notRunCount",{entityState:["isFinal"]}]}).done({success:function(t){var e=t[0].data;n.resolve(e)}.bind(this),failure:n.reject}),e.unfreeze()}.bind(this)),n.promise()},_buildActions:function(t){var n=e.Deferred(),i=this._getActionMap(t);return n.resolve(i).promise()},_getActionMap:function(t){var e=this.config.context.configurator.getApplicationPath(),n=!t.entityState.isFinal&&t["testCaseRuns-count"]>0,i=t.passedCount>0||t.failedCount>0,s=0===t.notRunCount;return{run:{show:n&&!i,url:e+"/Project/QA/TestPlanRun/TestsRunner.aspx?TestPlanRunID="+t.id,label:"Run"},completeRun:{show:n&&i&&!s,url:e+"/Project/QA/TestPlanRun/TestsRunner.aspx?TestPlanRunID="+t.id+"&CompleteRun=1",label:"Complete Run"},newRun:{show:n&&i,url:e+"/Project/QA/TestPlanRun/TestsRunner.aspx?TestPlanRunID="+t.id+"&ReRun=1",label:"New Run"},changeRun:{show:n&&i&&s,url:e+"/Project/QA/TestPlanRun/TestsRunner.aspx?TestPlanRunID="+t.id+"&Edit=1",label:"Change Run"}}},_subscribeToStore:function(t){this.store.unbind(this),this.store.on({eventName:"afterSave",type:"testplanrun",listener:this,filter:{id:t.id},hasChanges:["testCaseRuns-count|passedCount|failedCount|notRunCount|entityState"]},function(){this.fire("refresh")
}.bind(this))},"bus beforeInit:last + $el.ready":function(t,n){var i=n.config.context.entity,s=e("body").tauIFramePopup();s.on("taupopuphide",function(){this.fire("testplanrun.runCompleted",i)}.bind(this)),this.fire("$iframed.ready",s)},"bus $iframed.ready:last + url.process":function(t,e,n){e.tauIFramePopup("option","url",n+"&rmnav=1&tp3=1"),e.tauIFramePopup("show")},"bus initConfig:last + $iframed.ready:last + destroy":function(t,e,n){this.store.unbind(this),n.tauIFramePopup("destroy")}})});