define(["Underscore","tau/core/model-base"],function(t,n){return n.extend({"bus beforeInit":function(n,e){var a=n.data.config,s=e.config.context.configurator,o=a.eventNamesSpecial||{};t.defaults(o,{dataBind:"dataBind"});var u=o.dataBind,i=a.context.entity.id,r=s.getApplicationPath(),l={run:{show:!1,url:r+"/Project/QA/TestPlanRun/TestsRunner.aspx?TestPlanRunID="+i,label:"Run"},completeRun:{show:!1,url:r+"/Project/QA/TestPlanRun/TestsRunner.aspx?TestPlanRunID="+i+"&CompleteRun=1",label:"Complete Last Run"},newRun:{show:!1,url:r+"/Project/QA/TestPlanRun/TestsRunner.aspx?TestPlanRunID="+i+"&ReRun=1",label:"New Run"},changeLastRun:{show:!1,url:r+"/Project/QA/TestPlanRun/TestsRunner.aspx?TestPlanRunID="+i+"&Edit=1",label:"Change Last Run"}},d=this,c=a.context.entity,f=function(n){var e=n[0].data;!e.entityState.isFinal&&e["testCaseRuns-count"]>0&&(e.passedCount>0||e.failedCount>0?(l.newRun.show=!0,e.notRunCount>0?l.completeRun.show=!0:l.changeLastRun.show=!0):l.run.show=!0),"dataBind"!=u&&s.isBoardEdition&&(l=t.map(l,function(t,n){return{show:t.show,label:t.label,alias:n,command:function(){d.fire("url.process",t.url+"&rmnav=1&tp3=1")}}})),d.bus.fire(u,{additionalActions:l})};d.store.freeze(!0).done(t.bind(function(t){d.store.get("testplanrun",{id:c.id,fields:["testCaseRuns-count","passedCount","failedCount","notRunCount",{entityState:["isFinal"]}]}).done({success:f}),t.unfreeze()})),this.store.unbind(this),t.forEach(["testCaseRuns-count","passedCount","failedCount","notRunCount","entityState"],t.bind(function(t){this.store.on({eventName:"afterSave",type:"testplanrun",listener:this,filter:{id:c.id},hasChanges:[t]},function(){d.fire("refresh")})},this))},"bus beforeInit:last + $el.ready":function(n,e){var a=(e.config.context.configurator,e.config.context.entity),s=$("body").tauIFramePopup();s.on("taupopuphide",t.bind(function(){this.fire("testplanrun.runCompleted",a)},this)),this.fire("$iframed.ready",s)},"bus $iframed.ready:last + url.process":function(t,n,e){n.tauIFramePopup("option","url",e),n.tauIFramePopup("show")},"bus initConfig:last + $iframed.ready:last + destroy":function(t,n,e){n.config.context.configurator.getStore().unbind(this),e.tauIFramePopup("destroy")}})});