define(["Underscore","tau/models/model.leadCycleTime","tau/models/dataprocessor/model.processor.implementationHistory"],function(e,t,i){return t.extend({onInit:function(){var e=this.config.context,t="implementationHistory",i=this.config.context.entity.id;this.store.evictProperties(i,"implementationHistory",["statistics"]),this.store.get(t,{id:e.entity.id,fields:["id","statistics"]}).get("process",{id:e.getProcessId(),nested:!0,fields:[{entityStates:["id","name","isInitial","isFinal","isPlanned","numericPriority",{entityType:["id","name"]},{role:["id"]}]}]}).get("user",{fields:["id","firstName","lastName"]}).get("roles",{fields:["id","name"]}).get(this.config.context.entity.entityType.name,{id:i,fields:["leadTime","cycleTime"]}).done({scope:this,success:this.onDone}),this.store.unbind(this),this._bindToStoreChanges()},_bindToStoreChanges:function(){this._bindToStoreAfterSafe(),this._bindToStoreAfterRemove()},_bindToStoreAfterSafe:function(){this.store.on({eventName:"afterSave",type:this.config.context.entity.entityType.name,listener:this,filter:{id:this.config.context.entity.id},hasChanges:["entityState"]},this._getOnStoreChangesProxy()),e.each(this._getStoreObservableEntityTypes(),function(e){this.store.on({eventName:"afterSave",type:e,listener:this},this._getOnStoreChangesProxy())},this)},_bindToStoreAfterRemove:function(){e.each(this._getStoreObservableEntityTypes(),function(e){this.store.on({eventName:"afterRemove",type:e,listener:this},this._getOnStoreChangesProxy())},this)},_getStoreObservableEntityTypes:function(){if(!this._storeObservableEntityTypes){var e=["assignment","impediment"];switch(this.config.context.entity.entityType.name){case"userstory":e.push("task","bug");break;case"feature":e.push("userstory");break;case"request":e.push("feature","userstory","task","bug")}this._storeObservableEntityTypes=e}return this._storeObservableEntityTypes},_onStoreChanges:function(){this.store.evictProperties(this.config.context.entity.id,"implementationHistory",["statistics"]),this.fire("afterUpdate")},_getOnStoreChangesProxy:function(){return this._onStoreChangesProxy||(this._onStoreChangesProxy=e.bind(this._onStoreChanges,this)),this._onStoreChangesProxy},shouldShowLeadCycleTimes:function(){var e=this.config.context.entity.entityType.name;return-1!=["userstory","bug","feature"].indexOf(e.toLowerCase())},onDone:function(t){if(this.config){var s=t[4].data.cycleTime,n=this.convertDayToMinutes(s).toFixed(0),o={};this.shouldShowLeadCycleTimes()&&(o={leadTime:this.getLongTime(t[4].data.leadTime),cycleTime:n>0?this.getLongTime(s):null});var r=i.transform(e.extend({response:t,entityTypeName:this.config.context.entity.entityType.name,terms:this.config.context.getTerms()},o));this.fire("dataBind",r)}}})});