define(["Underscore","tau/models/model.leadCycleTime","tau/models/dataprocessor/model.processor.implementationHistory","tau/configurator","tau/store/types"],function(_,a,b,c,d){return a.extend({onInit:function(){var a=this.config.context,b="implementationHistory",c=this.config.context.entity.id;this.store.evictProperties(c,"implementationHistory",["statistics"]),this.store.get(b,{id:a.entity.id,fields:["id","statistics"]}).get("process",{id:a.getProcessId(),nested:!0,fields:[{entityStates:["id","name","isInitial","isFinal","isPlanned","numericPriority",{entityType:["id","name"]},{role:["id"]}]}]}).get("user",{fields:["id","firstName","lastName"]}).get("roles",{fields:["id","name"]}).get(this.config.context.entity.entityType.name,{id:c,fields:["leadTime","cycleTime"]}).done({scope:this,success:this.onDone}),this.store.unbind(this),this._bindToStoreChanges()},_bindToStoreChanges:function(){this._bindToStoreAfterSafe(),this._bindToStoreAfterRemove()},_bindToStoreAfterSafe:function(){this.store.on({eventName:"afterSave",type:this.config.context.entity.entityType.name,listener:this,filter:{id:this.config.context.entity.id},hasChanges:["entityState"]},this._getOnStoreChangesProxy()),_.each(this._getStoreObservableEntityTypes(),function(a){this.store.on({eventName:"afterSave",type:a,listener:this},this._getOnStoreChangesProxy())},this)},_bindToStoreAfterRemove:function(){_.each(this._getStoreObservableEntityTypes(),function(a){this.store.on({eventName:"afterRemove",type:a,listener:this},this._getOnStoreChangesProxy())},this)},_getStoreObservableEntityTypes:function(){if(!this._storeObservableEntityTypes){var a=["assignment","impediment"];switch(this.config.context.entity.entityType.name){case"userstory":a.push("task","bug");break;case"feature":a.push("userstory");break;case"request":a.push("feature","userstory","task","bug")}this._storeObservableEntityTypes=a}return this._storeObservableEntityTypes},_onStoreChanges:function(a){this.store.evictProperties(this.config.context.entity.id,"implementationHistory",["statistics"]),this.fire("afterUpdate")},_getOnStoreChangesProxy:function(){return this._onStoreChangesProxy||(this._onStoreChangesProxy=_.bind(this._onStoreChanges,this)),this._onStoreChangesProxy},shouldShowLeadCycleTimes:function(){var a=this.config.context.entity.entityType.name;return["userstory","bug","feature"].indexOf(a.toLowerCase())!=-1},onDone:function(a){var c=a[4].data.cycleTime,d=this.convertDayToMinutes(c).toFixed(0),e={};this.shouldShowLeadCycleTimes()&&(e={leadTime:this.getLongTime(a[4].data.leadTime),cycleTime:d>0?this.getLongTime(c):null});var f=b.transform(_.extend({response:a,entityTypeName:this.config.context.entity.entityType.name,terms:this.config.context.getTerms()},e));this.fire("dataBind",f)}})})