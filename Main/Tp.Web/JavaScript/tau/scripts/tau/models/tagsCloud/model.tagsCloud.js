define(["Underscore","tau/core/extension.base"],function(e,t){return t.extend({"bus beforeInit":function(e,t){var i=t.config.context;this.fire("entity.ready",i.entity),this.fire("configurator.ready",i.configurator)},"bus configurator.ready + entity.ready + beforeInit":function(t,i,n){var r=i.getStore(),a=["id","tags"],o=n.entityType.name;e.has(r.config.proxy.types[o].refs,"project")&&a.push({project:["id"]}),r.get(o,{id:n.id,fields:a}).done(e.bind(function(e){this.fire("entityTags.ready",e[0].data.tags),this.fire("entityProject.ready",e[0].data.project)},this)),r.unbind(this),r.on({eventName:"afterSave",type:o,listener:this,filter:{id:n.id}},e.bind(function(t){var i=t.data.cmd;i&&i.config&&i.config.$set&&e.has(i.config.$set,"tags")&&this.fire("refresh")},this)),r.on({eventName:"afterSave",type:o,listener:this,filter:{id:n.id},hasChanges:["project"]},e.bind(function(){this.fire("refresh")},this))},"bus configurator.ready + entityProject.ready + beforeInit":function(t,i,n){var r=n&&n.id?n.id:0;$.ajax({url:i.getApplicationPath()+"/PageServices/WebMethods.asmx/GetAllTags",type:"post",data:JSON.stringify({projectID:r}),contentType:"application/json; charset=utf-8"}).done(e.bind(function(t){var i=e.map(t.d,function(e,t){return{name:t,size:e}});i=this._process(i),this.fire("cloudData.ready",i)},this))},"bus cloudData.ready + entityTags.ready":function(e,t){this.fire("dataBind",{showSearch:t.length>20,tags:t})},"bus configurator.ready > destroy":function(e,t){t.getStore().unbind(this)},_process:function(t){var i=e.max(e.pluck(t,"size"))||1,n=7/i;return e.each(t,function(e){e.size=Math.round(n*e.size)}),t=e.sortBy(t,function(e){return 20-e.size+"_"+e.name.toLowerCase()}),e.each(t,function(e,t){t>=100&&(e.hidden=!0)}),t}})});