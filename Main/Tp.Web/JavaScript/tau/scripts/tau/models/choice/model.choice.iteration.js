define(["Underscore","./model.choice.base","tau/utils/utils.date"],function(e,t,i){return t.extend({name:"iteration-list",propertyType:"iteration",onInit:function(){var t=this.config.context.entity,i=this;this.store.get(t.entityType.name,{id:t.id,fields:["id",{project:["id",{iterations:["id","name","startDate","endDate","isCurrent",{release:["id","name"]}]}]}]}).done({success:function(t){t[0].data.project=t[0].data.project||{};var n=e.defaults(t[0].data.project,{iterations:[]});i.processData.call(i,n)}})},getRequiredFields:function(){return[{entityState:["id"]}]},"bus beforeSave":function(e){var t=e.data.cmd.fields=e.data.cmd.fields||[];t.push({release:["id","name"]})},convertIterationToDto:function(e){var t=i.convertToTimezone(e.startDate),n=i.convertToTimezone(e.endDate);return{id:e.id,name:e.name,description:"From "+i.format.date.short(t)+" to "+i.format.date.short(n),isCurrent:e.isCurrent}},processData:function(t){var n=this.config,a=this.getCurrentEntityId(),r=[],o=n.mode||"short",s=null,d=null,c=this.config.context.configurator.getCurrentDate(),u=function(e){e.id!==a&&r.push(e)};s="full"===o?u:function(e){var t=i.convertToTimezone(e.startDate),n=i.convertToTimezone(e.endDate);e.id!==a&&(t>=c||n>=c)&&r.push(e)},e.each(t.iterations,s),0===r.length&&(s=u,e.each(t.iterations,s));var l=[],f={};e.each(r,function(e){var t=f[e.release.id]||{id:e.release.id,name:e.release.name};t.items=t.items||[],e.isCurrent&&(d=e),t.items.push(this.convertIterationToDto(e)),f[t.id]||(l.push(t),f[t.id]=t)},this);var h=t.iterations.length,m=a&&h>0?h-1:h,p={nullableValue:this.isNullableValue(),states:l,completed:r.length-m==0};d&&(p.defaultValue=d.id),this.fire("dataBind",p)}})});