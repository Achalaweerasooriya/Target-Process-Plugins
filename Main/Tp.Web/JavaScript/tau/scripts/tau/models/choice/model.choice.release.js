define(["Underscore","./model.choice.base","tau/store/types","tau/utils/utils.date"],function(e,t,s,n){return t.extend({name:"release-list",propertyType:"release",onInit:function(){var t=this.config.context.entity,s=this;this.store.get(t.entityType.name,{id:t.id,fields:["id",{project:["id",{crossProjectReleases:["id","name","isCurrent","startDate","endDate"]}]}]}).done({success:function(t){t[0].data.project=t[0].data.project||{};var n=e.defaults(t[0].data.project,{crossProjectReleases:[]});s.processData(n)}})},"bus beforeSave":function(e){var t=e.data.cmd;t.fields=t.fields||[],this.entityContainIteration()&&t.fields.push({iteration:["id","name"]})},entityContainIteration:function(){var e=s.findByKeyword(this.config.context.entity.entityType.name);return e.refs.hasOwnProperty("iteration")},getRequiredFields:function(){return[{entityState:["id"]}]},convertReleaseToDto:function(e){return{id:e.id,name:e.name,description:"From "+n.format.date.short(e.startDate)+" to "+n.format.date.short(e.endDate),isCurrent:e.isCurrent}},isOldRelease:function(e){var t=this.config.context.configurator.getCurrentDate();return e.endDate<t},isCurrentRelease:function(e){return e.isCurrent},isCurrentOrFeatureRelease:function(e){return!this.isOldRelease(e)},selectOldReleases:function(){return e.select(this.projectReleaseList,this.isOldRelease,this)},selectCurrentAndFeatureReleases:function(){return e.select(this.projectReleaseList,this.isCurrentOrFeatureRelease,this)},getCurrentRelease:function(){return e.detect(this.projectReleaseList,this.isCurrentRelease,this)},initProjectReleaseList:function(t){var s=this.getCurrentEntityId(),i=e.select(t.crossProjectReleases,function(e){return e.id!=s});e.each(i,function(e){e.startDate=n.convertToTimezone(e.startDate),e.endDate=n.convertToTimezone(e.endDate)}),this.projectReleaseList=i},processData:function(t){this.initProjectReleaseList(t);var s=this.config,n=s.mode||"short",i=this.selectCurrentAndFeatureReleases(),r=[],a=this.selectOldReleases(),o=0===a.length;
"short"==n&&i.length>0?r=i:(r=r.concat(a,i),o=!0),r=e.map(r,this.convertReleaseToDto,this);var c=this.getCurrentRelease(),u={nullableValue:this.isNullableValue(),states:r,completed:o};c&&(u.defaultValue=c.id),this.fire("dataBind",u)},isNullableValue:function(){return this._super()&&"iteration"!==this.config.context.entity.entityType.name.toLowerCase()}})});