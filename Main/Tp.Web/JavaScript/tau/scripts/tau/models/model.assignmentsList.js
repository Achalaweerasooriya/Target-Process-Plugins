define(["Underscore","tau/store/types","tau/core/model-base","tau/models/assignmentsList/extension.model.effortRetriever","tau/models/assignmentsList/extension.model.store.operations","tau/models/assignmentsList/extension.model.effortPointsRetriever","tau/models/assignmentsList/extension.model.assignmentsRetriever","tau/models/assignmentsList/extension.model.entityRolesRetriever","tau/models/assignmentsList/extension.model.featureRolesRetriever","tau/models/assignmentsList/extension.model.assignmentToRolesMapper","tau/models/assignmentsList/extension.model.taskEffortRetriever"],function(e,t,n,s,i,r,o,a,f,d,m){var u=n.extend({"bus assignmentsReady":function(e){this.assignments=e.data},"bus assignmentsReady:last+userAvatarChanged":function(t,n,s){var i=e.find(n,function(e){return e.generalUser.id==s.id});void 0!==i&&this.fire("avatarChanged",s)},"bus roleEffortsReady":function(e){this.roleEfforts=e.data},destroyExtensions:function(){var t=this.extensions||[];if(t.length>0){{this.config.context.entity.id,this.bus}e.each(t,function(e){e.destroy("destroy")})}delete this.extensions},initExtensions:function(){this.destroyExtensions();var e=t.findByKeyword(this.config.context.entity.entityType.name),n=new("feature"!=e.name?a:f)(this.config);this.extensions=[new s(this.config),new i(this.config),new r(this.config),new o(this.config),n,new d(this.config)],"userstory"==e.name.toLowerCase()&&this.extensions.push(new m(this.config))},onInit:function(){this.clearData();var e=this;e.store.unbind(e),e.initExtensions(),e.fire("registerStoreRequest"),e.fire("commitTransaction",{success:e.done,scope:e}),this.bindStoreListeners()},done:function(){var e={};this.bus.fire("extendDataToBind",e),this.bus.fire("dataBind",e),this.destroyExtensions()},bindStoreListeners:function(){var t=this;t.store.on({eventName:"afterSave",type:"assignment",listener:t},function(){t.afterAssignmentSaved.apply(t,arguments)}),t.store.on({eventName:"afterSave",type:"user",hasChanges:["avatarUri"],listener:t},function(){t.afterUserSaved.apply(t,arguments)}),t.store.on({eventName:"beforeSave",type:"assignment",listener:t},function(){t.beforeSaveAssignment.apply(t,arguments)}),t.store.on({eventName:"beforeSave",type:"roleEffort",listener:t},function(){t.beforeSaveRoleEffort.apply(t,arguments)}),t.store.on({eventName:"afterSave",type:"roleEffort",listener:t},function(){t.afterSaveRoleEffort.apply(t,arguments)}),t.store.on({eventName:"beforeRemove",type:"assignment",listener:t},function(){t.beforeRemoveAssignment.apply(t,arguments)}),t.store.on({eventName:"afterRemove",type:"assignment",listener:t},function(){t.afterAssignmentRemoved.apply(t,arguments)});var n=this.config.context.entity.id,s=this.config.context.entity.entityType.name,i={id:n};t.store.on({eventName:"beforeRemove",type:s,listener:t,filter:i},function(){t.store.unbind(t)}),t.store.on({eventName:"beforeSave",type:s,listener:t,filter:i,hasChanges:["entityState"]},e.bind(t.beforeEntityEntityStateChanged,t)),t.store.on({eventName:"afterSave",type:s,listener:t,filter:i,hasChanges:["entityState"]},e.bind(t.afterEntityEntityStateChanged,t)),t.store.on({eventName:"afterSave",type:s,listener:t,filter:i,hasChanges:["effort|effortToDo|effortCompleted|tasks-count|tasks-effort-sum|tasks-effortToDo-sum"]},e.bind(t.onDataUpdate,t))},beforeEntityEntityStateChanged:function(){this.fire("beforeStateChanged")},afterEntityEntityStateChanged:function(){this.fire("afterStateChanged")},onDataUpdate:function(){this.fire("dataDidUpdated")},beforeSaveRoleEffort:function(t){var n=t.data.id;if(e.isNumber(n)&&this.isRoleEffortOfCurrentEntity(n)){var s=t.data.cmd;s.config.fields=s.config.fields||[],s.config.fields.push("effortToDo"),this.fire("beforeSaveRoleEffort",{roleEffortId:n})}},afterSaveRoleEffort:function(t){var n=t.data.id;e.isNumber(n)&&this.isRoleEffortOfCurrentEntity(n)&&this.fire("afterSaveRoleEffort",{roleEffortId:n})},beforeRemoveAssignment:function(e){this.fireEventIfAssignmentFromCurrentEntity(e,"beforeRemoveAssignment")},afterAssignmentRemoved:function(e){this.fireEventIfAssignmentFromCurrentEntity(e,"afterAssignmentRemoved")},beforeSaveAssignment:function(t){e.isNumber(t.data.id)?this.fireEventIfAssignmentFromCurrentEntity(t,"beforeSaveAssignment"):this.fireEventIfAssignmentFromCurrentEntity(t,"beforeAddAssignment")},afterAssignmentSaved:function(t){var n=t.data,s=n.cmd?n.cmd.config.id:n.obj?n.obj.id:null;e.isNumber(s)?this.fireEventIfAssignmentFromCurrentEntity(t,"afterAssignmentSaved"):this.fireEventIfAssignmentFromCurrentEntity(t,"afterAssignmentAdded")},afterUserSaved:function(e){this.fire("userAvatarChanged",e.data)},fireEventIfAssignmentFromCurrentEntity:function(t,n){var s=t.data.id,i=t.data.changes||t.data.obj;if(this.isAssignmentOfCurrentEntity(s)||((i||{}).assignable||{}).id===this.config.context.entity.id){var r=e.extend({assignmentId:s},i);this.fire(n,r)}},isRoleEffortOfCurrentEntity:function(t){return e.any(this.roleEfforts,function(e){return e.id===t})},isAssignmentOfCurrentEntity:function(t){return e.any(this.assignments,function(e){return e.id===t})},clearData:function(){delete this.assignments,delete this.roleEfforts},destroy:function(){this.clearData(),this._super.apply(this,arguments)}});return u});