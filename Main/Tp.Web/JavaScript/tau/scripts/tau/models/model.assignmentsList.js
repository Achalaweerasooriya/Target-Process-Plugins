define(["require","Underscore","tau/store/types","tau/core/model-base","tau/models/assignmentsList/extension.model.effortRetriever","tau/models/assignmentsList/extension.model.store.operations","tau/models/assignmentsList/extension.model.effortPointsRetriever","tau/models/assignmentsList/extension.model.assignmentsRetriever","tau/models/assignmentsList/extension.model.user","tau/models/assignmentsList/extension.model.entityRolesRetriever","tau/models/assignmentsList/extension.model.featureRolesRetriever","tau/models/assignmentsList/extension.model.assignmentToRolesMapper","tau/models/assignmentsList/extension.model.taskEffortRetriever"],function(e){var t=e("Underscore"),n=e("tau/store/types"),s=e("tau/core/model-base"),i=e("tau/models/assignmentsList/extension.model.effortRetriever"),o=e("tau/models/assignmentsList/extension.model.store.operations"),r=e("tau/models/assignmentsList/extension.model.effortPointsRetriever"),a=e("tau/models/assignmentsList/extension.model.assignmentsRetriever"),f=e("tau/models/assignmentsList/extension.model.user"),m=e("tau/models/assignmentsList/extension.model.entityRolesRetriever"),d=e("tau/models/assignmentsList/extension.model.featureRolesRetriever"),u=e("tau/models/assignmentsList/extension.model.assignmentToRolesMapper"),l=e("tau/models/assignmentsList/extension.model.taskEffortRetriever");return s.extend({"bus assignmentsReady":function(e){this.assignments=e.data},"bus assignmentsReady:last+userAvatarChanged":function(e,n,s){var i=t.find(n,function(e){return e.generalUser.id==s.id});void 0!==i&&this.fire("avatarChanged",s)},"bus roleEffortsReady":function(e){this.roleEfforts=e.data},destroyExtensions:function(){var e=this.extensions||[];e.length>0&&t.each(e,function(e){e.destroy("destroy")}),this.extensions=null},initExtensions:function(){this.destroyExtensions();var e=n.findByKeyword(this.config.context.entity.entityType.name),t=this._getRetriever(e.name);this.extensions=[new i(this.config),new o(this.config),new r(this.config),new a(this.config),new t(this.config),new u(this.config),new f(this.config)],"userstory"==e.name.toLowerCase()&&this.extensions.push(new l(this.config))
},_getRetriever:function(e){switch(e.toLowerCase()){case"feature":case"epic":return d;default:return m}},onInit:function(){this.clearData(),this.store.unbind(this),this.initExtensions(),this.fire("registerStoreRequest"),this.fire("commitTransaction",{success:this.safeCallback(this.done),scope:this}),this.bindStoreListeners()},done:function(){var e={isBoardEdition:this.config.context.configurator.isBoardEdition};this.bus.fire("extendDataToBind",e),this.bus.fire("dataBind",e),this.destroyExtensions()},bindStoreListeners:function(){var e=this;e.store.on({eventName:"afterSave",type:"assignment",listener:e},function(){e.afterAssignmentSaved.apply(e,arguments)}),e.store.on({eventName:"afterSave",type:"user",hasChanges:["avatarUri"],listener:e},function(){e.afterUserSaved.apply(e,arguments)}),e.store.on({eventName:"beforeSave",type:"assignment",listener:e},function(){e.beforeSaveAssignment.apply(e,arguments)}),e.store.on({eventName:"beforeSave",type:"roleEffort",listener:e},function(){e.beforeSaveRoleEffort.apply(e,arguments)}),e.store.on({eventName:"afterSave",type:"roleEffort",listener:e},function(){e.afterSaveRoleEffort.apply(e,arguments)}),e.store.on({eventName:"beforeRemove",type:"assignment",listener:e},function(){e.beforeRemoveAssignment.apply(e,arguments)}),e.store.on({eventName:"afterRemove",type:"assignment",listener:e},function(){e.afterAssignmentRemoved.apply(e,arguments)});var n=this.config.context.entity.id,s=this.config.context.entity.entityType.name,i={id:n};e.store.on({eventName:"beforeRemove",type:s,listener:e,filter:i},function(){e.store.unbind(e)}),e.store.on({eventName:"beforeSave",type:s,listener:e,filter:i,hasChanges:["entityState"]},t.bind(e.beforeEntityEntityStateChanged,e)),e.store.on({eventName:"afterSave",type:s,listener:e,filter:i,hasChanges:["entityState"]},t.bind(e.afterEntityEntityStateChanged,e)),e.store.on({eventName:"afterSave",type:s,listener:e,filter:i,hasChanges:["effort|effortToDo|effortCompleted|tasks-count|tasks-effort-sum|tasks-effortToDo-sum"]},t.bind(e.onDataUpdate,e))
},beforeEntityEntityStateChanged:function(){this.fire("beforeStateChanged")},afterEntityEntityStateChanged:function(){this.fire("afterStateChanged")},onDataUpdate:function(){this.fire("dataDidUpdated")},beforeSaveRoleEffort:function(e){var n=e.data.id;if(t.isNumber(n)&&this.isRoleEffortOfCurrentEntity(n)){var s=e.data.cmd;s.config.fields=s.config.fields||[],s.config.fields.push("effortToDo"),this.fire("beforeSaveRoleEffort",{roleEffortId:n})}},afterSaveRoleEffort:function(e){var n=e.data.id;t.isNumber(n)&&this.isRoleEffortOfCurrentEntity(n)&&this.fire("afterSaveRoleEffort",{roleEffortId:n})},beforeRemoveAssignment:function(e){this.fireEventIfAssignmentFromCurrentEntity(e,"beforeRemoveAssignment")},afterAssignmentRemoved:function(e){this.fireEventIfAssignmentFromCurrentEntity(e,"afterAssignmentRemoved")},beforeSaveAssignment:function(e){t.isNumber(e.data.id)?this.fireEventIfAssignmentFromCurrentEntity(e,"beforeSaveAssignment"):this.fireEventIfAssignmentFromCurrentEntity(e,"beforeAddAssignment")},afterAssignmentSaved:function(e){var n=e.data,s=n.cmd?n.cmd.config.id:n.obj?n.obj.id:null;t.isNumber(s)?this.fireEventIfAssignmentFromCurrentEntity(e,"afterAssignmentSaved"):this.fireEventIfAssignmentFromCurrentEntity(e,"afterAssignmentAdded")},afterUserSaved:function(e){this.fire("userAvatarChanged",e.data)},fireEventIfAssignmentFromCurrentEntity:function(e,n){var s=e.data.id,i=e.data.changes||e.data.obj;if(this.isAssignmentOfCurrentEntity(s)||((i||{}).assignable||{}).id===this.config.context.entity.id){var o=t.extend({assignmentId:s},i);this.fire(n,o)}},isRoleEffortOfCurrentEntity:function(e){return t.any(this.roleEfforts,function(t){return t.id===e})},isAssignmentOfCurrentEntity:function(e){return t.any(this.assignments,function(t){return t.id===e})},clearData:function(){this.assignments=null,this.roleEfforts=null}})});