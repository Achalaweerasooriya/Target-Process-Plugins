define(["Underscore","tau/configurator","tau/core/model-base","tau/models/boardSettings/factory.board.settings","tau/models/dataprocessor/model.processor.context","tau/extensions/extension.underscore.async"],function(_,a,b,c,d){return b.extend({name:"Entity",onInit:function(){var b=this.config.entity,d=this.config.context.configurator.getStore(),e=this,f=[];f.push(function(b){var c=a.getGlobalSettingsService();c.store=d,c.getGlobalSettings({success:function(a){b(!1,a)}})}),f.push(function(c){var e=a.getApplicationContextService();e.store=d,e.getApplicationContext({id:b.id},{success:function(a){c(!1,a)}})}),f.push(function(a){var c={id:b.id,entityType:{name:b.type}};a(!1,c)}),f.push(function(d){var e=c.createComponentSettings(a,{id:b.type});d(!1,e)}),_.parallel(f,function(a,b){e.prepareContext({globalSettings:b[0],applicationContext:b[1],entity:b[2],componentSettings:b[3]})})},prepareContext:function(a){var b={};a.applicationContext.globalSettings=a.globalSettings,_.extend(b,{assignable:a.entity,entity:a.entity,general:a.entity,applicationContext:a.applicationContext,componentSettings:a.componentSettings}),this.bus.fire("contextRetrieved",{context:d(b)})},"bus contextRetrieved":function(a){var b=a.data.context,c=this.store,d=this;c.unbind(d);var e=b.entity;c.on({eventName:"afterRemove",type:e.entityType.name,listener:this},function(a){var b=a.data.cmd.config.id;e.id==b&&d.fire("deleted",a.data)}),c.on({eventName:"beforeRemove",type:e.entityType.name,listener:this},function(a){var b=a.data.cmd.config.id;e.id==b&&d.fire("beforeDelete")})}})})