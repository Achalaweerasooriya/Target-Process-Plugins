define(["Underscore","tau/configurator","tau/core/model-base","tau/models/dataprocessor/model.processor.context"],function(_,a,b,c){var d=function(){this.callbacks={}};return d.prototype={register:function(a,b){this.callbacks[a]=b},fnCallback:function(a){var b=this;return function(){var c=Array.prototype.slice.apply(arguments);b._ready.data[a]=c.length===1?c[0]:c;var d=b.callbacks[a];d&&d.fn.apply(d.scope,c),delete b.callbacks[a],_(b.callbacks).keys().length===0&&b._ready.fn.call(b._ready.scope,b._ready.data)}},ready:function(a){this._ready={fn:a.fn,scope:a.scope,data:{}}}},b.extend({name:"Entity",onInit:function(){var b=this;b.store.unbind(b);var c=b.config.context.id;b.store.on({eventName:"afterRemove",type:b.config.context.entityType.name,listener:this},function(a){var d=a.data.cmd.config.id;c==d&&b.fire("deleted",a.data)}),b.store.on({eventName:"beforeRemove",type:b.config.context.entityType.name,listener:this},function(a){var d=a.data.cmd.config.id;c==d&&b.fire("beforeDelete")});var e=new d;e.register("onGlobalSettings"),e.register("onContext"),e.ready({scope:this,fn:this.fnBindData});var f=a.getGlobalSettingsService();f.getGlobalSettings({scope:e,success:e.fnCallback("onGlobalSettings")}),b.store.get("context",{id:c,fields:["id","acid","culture","edition",{loggedUser:["id","email","isAdministrator"]},{processes:["id","name","terms","practices","customFields"]},{selectedProjects:["id","name",{process:["id","name"]}]}]},{scope:e,success:e.fnCallback("onContext")}).done()},fnBindData:function(a){var b=a.onContext;b.data.globalSettings=a.onGlobalSettings,this.onContextRetrieved(b)},destroy:function(){this.onContextRetrieved=function(){},this._super.apply(this,arguments)},onContextRetrieved:function(a){var b={context:{}},d=this,e=d.config.context;_.extend(b.context,{assignable:e}),_.extend(b.context,{entity:e}),_.extend(b.context,{general:e}),_.extend(b.context,{applicationContext:a.data}),d.bus.fire("contextRetrieved",{context:c(b.context)})}})})