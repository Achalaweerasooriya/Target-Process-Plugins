define(["Underscore","tau/core/model-base","tau/utils/utils.date"],function(e,t,i){var a=i.Date,n=6e4,r=60*n,s=24*r,o=t.extend({onInit:function(){var e=this.config.context.entity;this._entity={id:e.id,type:e.entityType.name},this.store.unbind(this),this.store.on({eventName:"afterSave",type:this._entity.type,hasChanges:[["entityState","createDate","startDate","endDate"].join("|")],listener:this},function(){this.store.config.proxy.evictProperties(this._entity.id,this._entity.type,["leadTime","cycleTime"]),this._refresh()}.bind(this)),this._refresh()},_refresh:function(){this.store.get(this._entity.type,{id:this._entity.id,fields:["leadTime","cycleTime","createDate","startDate","endDate"]},{scope:this,success:this.onEntityRetrieved}).done()},getTime:function(e){return this.getTimeWithAbbreviation(e,"d","h","min")},getLongTime:function(e){return this.getTimeWithAbbreviation(e," days"," hours"," minutes")},getTimeWithAbbreviation:function(e,t,i,a){if(e*=s,r>e)return(e/n).toFixed(0)+a;if(s>e)return(e/r).toFixed(0)+i;var o=parseInt(e/s);e%=s;var l=(e/r).toFixed(0);return o+t+" "+(l>0?l+i:"")},_formatShortDate:function(e){return e&&e.toString("dd MMM yy")},onEntityRetrieved:function(t){var n=t.data,r=e.isNumber(n.cycleTime),s=e.isNumber(n.leadTime),o=this._formatShortDate(i.parse(n.createDate)),l=this._formatShortDate(i.parse(n.startDate)),h=this._formatShortDate(i.parse(n.endDate)),m=h?{label:"End Date",text:h}:{label:"Today",text:this._formatShortDate(new a)};this.fire("dataBind",{cycleTimeTooltipData:{summary:{label:"Cycle Time",text:r?this.getLongTime(n.cycleTime):""},from:{label:"Start Date",text:l},to:m},leadTimeTooltipData:{summary:{label:"Lead Time",text:s?this.getLongTime(n.leadTime):""},from:{label:"Create Date",text:o},to:m},chartData:{leftDate:s?o:l,movingDate:s?l:null,rightDate:m.text,rightDateLabel:m.label,cycleTime:r?this.getTime(n.cycleTime):"",leadTime:s?this.getTime(n.leadTime):"",cyclePercentage:r?n.cycleTime/(n.leadTime||n.cycleTime):null,leadPercentage:s?1:null}})
}});return o});