define(["Underscore","tau/core/model-base","tau/utils/utils.date"],function(_,ModelBase,UtilsDate){var Date=UtilsDate.Date,tickPerMinute=6e4,ticksPerHour=tickPerMinute*60,tickPerDay=24*ticksPerHour,modelComments=ModelBase.extend({name:"Lead Cycle Time Model",onInit:function(){var self=this,ctx=self.config.context,entityTypeName=ctx.entity.entityType.name,entityId=ctx.entity.id,cmdSettings={id:entityId,fields:["leadTime","cycleTime","createDate","startDate","endDate"]};self.store.unbind(self),self.store.on({eventName:"afterSave",type:entityTypeName,fields:["entityState"],listener:self},function(){self.fire("refresh")}),self.store.get(entityTypeName,cmdSettings,{scope:self,success:self.onEntityRetrieved}).done()},getTime:function(timeInterval){var dayLabel="d",minuteLabel="min",hourLabel="h";return this.getTimeWithAbbreviation(timeInterval,dayLabel,hourLabel,minuteLabel)},getTimeWithAbbreviation:function(timeInterval,dayLabel,hourLabel,minuteLabel){timeInterval*=tickPerDay;if(timeInterval<ticksPerHour)return(timeInterval/tickPerMinute).toFixed(0)+minuteLabel;if(timeInterval<tickPerDay)return(timeInterval/ticksPerHour).toFixed(0)+hourLabel;var day=parseInt(timeInterval/tickPerDay);timeInterval%=tickPerDay;var hours=(timeInterval/ticksPerHour).toFixed(0);return day+dayLabel+" "+(hours>0?hours+hourLabel:"")},convertDayToMinutes:function(days){return days*24*60},getLongTime:function(timeInterval){return this.getTimeWithAbbreviation(timeInterval," days"," hours"," minutes")},onEntityRetrieved:function(result){var entity=result.data,startDate=UtilsDate.parse(entity.startDate),createDate=UtilsDate.parse(entity.createDate),endDate=UtilsDate.parse(entity.endDate),dataFormatString="dd MMM yy",endDateLabel=endDate?"End Date":"Today";endDate=endDate||new Date;var leadTime=entity.leadTime,data={leadTime:this.getTime(leadTime),leadTimeTooltip:this.getLongTime(leadTime),createDate:createDate.toString(dataFormatString),endDateLabel:endDateLabel,endDate:(endDate||new Date).toString(dataFormatString),id:_.uniqueId()};if(_.isNumber(entity.cycleTime)){var cycleTime=entity.cycleTime;data.cyclePercentage=cycleTime/leadTime,data.cycleTime=this.getTime(cycleTime),data.cycleTimeTooltip=this.getLongTime(cycleTime),data.startDate=(startDate||"").toString(dataFormatString),data.startDate==data.createDate&&(data.startDate="")}else data.cycleTime="",data.cyclePercentage=null;this.fire("dataBind",data)}});return modelComments})