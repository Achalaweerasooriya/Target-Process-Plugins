define(["Underscore","tau/core/class"],function(_,a){var b=function(){},c=function(a,b){var c=new Array(a.length);return function(d){var e=d.uid,f=d.data;c[e]=f,a=_(a).without(e),a.length===0&&b(c)}};return a.extend({init:function(a,b){var c=this;c.settings=a,c.sources=b,c.callbacksMap=[],c.commonCallback=_.bind(function(a){var b=this,c=a.data,d=b.mergeChanges(c);d!==null&&b.applyCallback(d)},c)},applyCallback:function(a){var b=_(a).keys();for(var c=0;c<this.callbacksMap.length;c++){var d=this.callbacksMap[c];this.matchCommandCallback(b,d)&&d.callback.apply(d.listener,[a])}},matchCommandCallback:function(a,b){var c=_.intersection(a,b.fields);return c.length>0},each:function(a,c){if(this.sources.length)_(this.sources).each(a);else{var d=c||b;d()}},mergeChanges:function(a){var b=this,c=b.settings,d=_(a).keys(),e=null;for(var f=0;f<d.length;f++){var g=d[f];c[g]!==a[g]&&(e=e||{},e[g]=c[g]=a[g])}return e},get:function(a){var d=this;_(a).defaults({callback:b});var e=d.settings,f={},g=d.sources,h=_.range(g.length),i=a.fields,j=function(b){_(b).each(function(a){for(var b=0;b<i.length;b++){var c=i[b],d=a[c]!==null?a[c]:e[c];!_.isNaN(d)&&!_.isNull(d)&&!_.isUndefined(d)&&(f[c]=d)}}),_(e).extend(f),a.callback(e)},k=c(h,j);d.each(function(a,b){a.get({uid:b,fields:i,callback:k})},function(){j([])})},set:function(a){var d=this;_(a).defaults({callback:b});var e=d.sources,f=_.range(e.length),g=function(a){},h=c(f,g);d.each(function(b,c){b.set({uid:c,set:a.set,callback:h})},function(){g([])}),d.commonCallback({data:a.set}),a.callback(d.settings)},registerSubscription:function(a){var b=this;return b.callbacksMap.push(a),this.commonCallback},unregisterSubscription:function(a){var b=this;for(var c=b.callbacksMap.length-1;c;c--)b.callbacksMap.splice(c,1)},bind:function(a){var b=this,c=b.registerSubscription(a);b.each(function(d,e){d.bind({uid:e,fields:a.fields,listener:b,callback:c})})},unbind:function(a){var b=this;b.each(function(a){a.unbind({listener:b})}),b.unregisterSubscription(a.listener)},dispose:function(){var a=this;a.each(function(b,c){b.unbind({listener:a})}),a.callbacksMap=[]}})})