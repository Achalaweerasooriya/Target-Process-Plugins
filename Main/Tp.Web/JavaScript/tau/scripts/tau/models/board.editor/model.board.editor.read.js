define(["Underscore","tau/core/extension.base","tau/models/board.editor/board.filter.help"],function(_,BaseModel,Help){var Model=BaseModel.extend({"bus beforeInit":function(evt,initConfig){var configurator=initConfig.config.context.configurator;this.fire("configurator.ready",configurator)},"bus configurator.ready":function(evt,configurator){var self=this;configurator.getAppStateStore().get({fields:["acid"],callback:function(result){self.fire("acid.ready",result.acid)}}),configurator.getAppStateStore().unbind({listener:this}),configurator.getAppStateStore().bind({fields:["acid"],listener:this,callback:function(result){self.fire("refresh")}});var boardSettings=configurator.service("boardSettings");boardSettings.get({fields:["ownerId"],callback:function(boardData){var access={edit:!0},user=configurator.getLoggedUser();parseInt(user.id,10)!==parseInt(boardData.ownerId,10)&&!user.isAdministrator&&(access.edit=!1),self.fire("accessData.ready",access)}})},"bus configurator.ready:last + acid.ready:last + accessData.ready:last + form.readyToUpdate":function(evt,configurator,acid,accessData){var boardSettings=configurator.service("boardSettings"),self=this;this.getSpaceTotal(configurator.getSliceFactory(),boardSettings,acid,function(space){self.fire("updateData.ready",{space:space,access:accessData})})},"bus configurator.ready + acid.ready":function(evt,configurator,acid){var self=this,boardSettings=configurator.service("boardSettings");this.getSpaceTotal(configurator.getSliceFactory(),boardSettings,acid,function(space){self.fire("dataBind",{space:space})})},"bus configurator.ready + destroy":function(evt,configurator){var boardSettings=configurator.service("boardSettings");boardSettings.unbind({listener:this})},getSpaceTotal:function(sliceFactory,boardSettings,acid,cb){var self=this,funcs=[];funcs.push(function(next){self.spaceAvailable(sliceFactory,boardSettings,acid,next)}),funcs.push(function(next){self.spaceCells(sliceFactory,boardSettings,acid,next)}),funcs.push(function(next){self.spaceAxisX(sliceFactory,boardSettings,acid,next)}),funcs.push(function(next){self.spaceAxisY(sliceFactory,boardSettings,acid,next)}),funcs.push(function(next){self.getPredefinedFilters(boardSettings,next)}),_.parallel(funcs,function(err,res){var space=self.processSpaces(res);cb(space)})},spaceAvailable:function(sliceFactory,boardSettings,acid,next){var definition={global:{acid:acid}},slice=sliceFactory.create({definition:definition});slice.space().done(function(result){next(!1,{space:result.data})})},spaceCells:function(sliceFactory,boardSettings,acid,next){boardSettings.get({fields:["name","x","y","cells","zoomLevel","hierarchyMode","viewMode","acid"],callback:function(settings){var sliceConfig={definition:{global:{acid:acid},x:settings.x,y:settings.y,cells:settings.cells}},slice=sliceFactory.create(sliceConfig);slice.on("error",function(){next(!1,{space:{},settings:settings})}),slice.space().done(function(result){next(!1,{space:result.data,settings:settings})})}})},spaceAxisX:function(sliceFactory,boardSettings,acid,next){boardSettings.get({fields:["name","x","y","cells","zoomLevel"],callback:function(settings){var sliceConfig={definition:{global:{acid:acid},y:settings.y,cells:settings.cells}},slice=sliceFactory.create(sliceConfig);slice.on("error",function(){next(!1,{space:{}})}),slice.space().done(function(result){next(!1,{space:result.data})})}})},spaceAxisY:function(sliceFactory,boardSettings,acid,next){boardSettings.get({fields:["name","x","y","cells","zoomLevel"],callback:function(settings){var sliceConfig={definition:{global:{acid:acid},x:settings.x,cells:settings.cells}},slice=sliceFactory.create(sliceConfig);slice.on("error",function(){next(!1,{space:{}})}),slice.space().done(function(result){next(!1,{space:result.data})})}})},processSpaces:function(res){var data={spaceDefault:res[0].space,spaceAvailable:{cells:res[1].space.cells||[],x:res[2].space.axes||[],y:res[3].space.axes||[],hierarchyMode:"inside",viewMode:""},settingsCurrent:res[1].settings},predefinedFilters=res[4],space={x:{name:"x",types:[],filter:"",predefinedFilters:predefinedFilters.x||[],orderingName:"",orderingDirection:0},y:{name:"y",types:[],filter:"",predefinedFilters:predefinedFilters.y||[],orderingName:"",orderingDirection:0},cells:{name:"cells",types:[],filter:"",predefinedFilters:predefinedFilters.cells||[],orderingName:"",orderingDirection:0},hierarchyMode:null,viewMode:null},lc=function(s){return s.toLowerCase()};space.hierarchyMode=data.settingsCurrent.hierarchyMode,space.viewMode=data.settingsCurrent.viewMode;var calculateTypes=function(axis){space[axis].types=_.map(data.spaceDefault.axes.items,function(v){var item={id:v.id,name:v.name,isAvailable:_.any(data.spaceAvailable[axis].items,function(u){return lc(u.id)===lc(v.id)}),isSelected:data.settingsCurrent[axis]&&_.any(data.settingsCurrent[axis].types,function(u){return lc(u)===lc(v.id)})};return item.isAvailable=item.isSelected?!0:item.isAvailable,item.groupName=v.groupName,item}),space[axis].filter=data.settingsCurrent[axis]?data.settingsCurrent[axis].filter||"":"";var groupedItems=_.filter(space[axis].types,function(v){return v.isAvailable});space[axis].grouped=_.groupBy(groupedItems,function(item){return item.groupName||"default"}),space[axis].grouped=_.map(space[axis].grouped,function(v,k){return{name:k,items:v}}),space[axis].grouped=_.sortBy(space[axis].grouped,function(v){return v.name=="default"?"AAAA":v.name});var axisType=data.settingsCurrent[axis]?data.settingsCurrent[axis].types[0]||"":"",selected=_.find(data.spaceAvailable[axis].items,function(u){return lc(u.id)===lc(axisType)});selected||(selected={});var definitionFilter=data.settingsCurrent&&data.settingsCurrent[axis]?data.settingsCurrent[axis].ordering:null,selectedFilter;definitionFilter&&definitionFilter.name&&(selectedFilter=_.find(selected.orderings,function(v){return v==definitionFilter.name})),selectedFilter||(selectedFilter=selected.defaultOrdering),space[axis].orderingNames=_.map(selected.orderings||[],function(v){var item={id:v,name:v,isSelected:selectedFilter?v==selectedFilter:!1};return item}),space[axis].orderingDirection=data.settingsCurrent&&data.settingsCurrent[axis]&&data.settingsCurrent[axis].ordering?data.settingsCurrent[axis].ordering.isDescending:0};calculateTypes("x"),calculateTypes("y"),space.cells.types=_.map(data.spaceDefault.cells.items,function(v){var item={id:v.id,name:v.name,isAvailable:_.any(data.spaceAvailable.cells.items,function(u){return lc(u.id)===lc(v.id)}),isSelected:_.any(data.settingsCurrent.cells.types,function(u){return lc(u)===lc(v.id)})};return item.isAvailable=item.isSelected?!0:item.isAvailable,item}),space.cells.filter=data.settingsCurrent.cells.filter||"";var selectedOrdering=data.settingsCurrent&&data.settingsCurrent.cells.ordering&&data.settingsCurrent.cells.ordering,selectedOrderingName=selectedOrdering&&selectedOrdering.name,selectedOrderingDirection=selectedOrdering?selectedOrdering.isDescending:0;return space.cells.orderingDirection=selectedOrderingDirection,space.cells.orderingNames=_.map(res[1].space.cells.orderings.items,function(value){return{id:value,name:value,isSelected:value==selectedOrderingName}}),space.acid=res[1].settings.acid||"",space},getPredefinedFilters:function(bs,next){bs.get({fields:["x","y","cells"],callback:function(settings){(new Help).get({x:settings.x,y:settings.y,cells:settings.cells}).done(function(r){next(!1,r)})}})},getSpaceEmpty:function(){var space={x:{name:"x",types:[],filter:""},y:{name:"y",types:[],filter:""},cells:{name:"cells",types:[],filter:""},hierarchyMode:null,viewMode:null};return space}});return Model})