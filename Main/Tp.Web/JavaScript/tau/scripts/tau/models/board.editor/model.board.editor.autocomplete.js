define(["Underscore","tau/core/extension.base","tau/models/board.editor/board.filter.suggestionManager"],function(_,BaseModel,SuggestionManager){var Model=BaseModel.extend({"bus configurator.ready":function(evt,configurator){var suggestionManager=new SuggestionManager(configurator);this.fire("suggestionManager.ready",suggestionManager)},getTypes:function($input,settings){var name=$input.prop("name"),$deferred=$.Deferred();if(!name)return $deferred.reject(),$deferred;var node=name.replace("_filter","");return settings.get({fields:[node],callback:function(r){var types=[];r.hasOwnProperty(node)&&(types=r[node].types||[]),$deferred.resolve(types)}}),$deferred},"bus suggestionManager.ready:last + boardSettings.ready:last + filter.autocomplete.preload":function(evt,suggestionManager,bs,data){var $input=data.$input;this.getTypes($input,bs.boardSettings).done(function(types){if(types.length==0)return;var prefix=data.value;if(!prefix||prefix.length===0||prefix[0]!="?")return;var values=[prefix.trim()+" ",prefix.trim()+"."];_.each(values,function(value){var querySet={query:{resourceTypes:types,script:value}};suggestionManager.get(querySet)})})},"bus suggestionManager.ready:last  + boardSettings.ready:last + filter.autocomplete.resolve":function(evt,suggestionManager,bs,data){var $input=data.$input;this.getTypes($input,bs.boardSettings).done(function(types){if(types.length==0){data.next([]);return}var term=data.request.term.slice(0,$input[0].selectionStart),positive=function(res){var items=res.Suggestions?res.Suggestions.Items:[];items=_.map(items,function(item){return item.Source=res.Source,item.Position=res.Position,item}),data.next(items)},negative=function(){data.next([])},querySet={query:{resourceTypes:types,script:term}};suggestionManager.get(querySet).done(positive).fail(negative)})}});return Model})