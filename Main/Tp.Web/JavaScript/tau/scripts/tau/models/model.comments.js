define(["Underscore","tau/core/model-base","tau/models/dataprocessor/model.processor.comment","tau/utils/utils.date","tau/store/types.targetprocess"],function(_,ModelBase,CommentProcessor,dateUtils){function initialDataProcessor(model,converter){this.model=model,this.converter=converter}initialDataProcessor.prototype={getAssignableRetrievedCallback:function(){return{scope:this,success:this.onAssignableRetrieved}},onAssignableRetrieved:function(result){this.assignable=this.model.assignable=result.data;var rawData=result.data.comments,sortedComments=_(rawData).sortBy(function(item){return+dateUtils.parse(item.createDate)}),commentsTree=this.convertDTO(sortedComments).convertToTree(null);this.model.bus.fire("dataBind",{items:commentsTree})},convertDTO:function(rawComments){var self=this;return this.convertedComments=_(rawComments).map(function(rawItem){return self.converter.convertDTO(rawItem)}),this},convertToTree:function(parentCommentId){var result=[],dtoComments=this.convertedComments;for(var i=0,len=dtoComments.length;i<len;i++){var item=dtoComments[i];item.parentId==parentCommentId&&(result.push(item),item.comments=this.convertToTree(item.id))}return result}};var modelComments=ModelBase.extend({name:"Comments",onInit:function(){var assignable=this.config.context.entity;this.converter=new CommentProcessor(this.config.context);var dataProcessor=new initialDataProcessor(this,this.converter);this.store.get(assignable.entityType.name,{id:assignable.id,fields:["id",{comments:["id","description","createDate","parentId",{owner:["id","firstName","lastName","kind","avatarUri"]}],list:!0}]},dataProcessor.getAssignableRetrievedCallback()).done()},"bus createDTO":function(evt){var data=evt.data,commentDTO=this.converter.convertDTO(data);commentDTO.comments=[],this.fire("DTOCreated",commentDTO)},destroy:function(){this.converter.destroy(),this.converter=null,this._super()}});return modelComments})