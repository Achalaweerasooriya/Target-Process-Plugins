define(["Underscore","tau/core/model-base","tau/models/dataprocessor/model.processor.comment","tau/utils/utils.date","tau/store/types.targetprocess"],function(_,a,b,c){function d(a,b){this.model=a,this.converter=b}d.prototype={getAssignableRetrievedCallback:function(){return{scope:this,success:this.onAssignableRetrieved}},onAssignableRetrieved:function(a){this.assignable=this.model.assignable=a.data;var b=a.data.comments,d=_(b).sortBy(function(a){return+c.parse(a.createDate)}),e=this.convertDTO(d).convertToTree(null);this.model.bus.fire("dataBind",{items:e})},convertDTO:function(a){var b=this;return this.convertedComments=_(a).map(function(a){return b.converter.convertDTO(a)}),this},convertToTree:function(a){var b=[],c=this.convertedComments;for(var d=0,e=c.length;d<e;d++){var f=c[d];f.parentId==a&&(b.push(f),f.comments=this.convertToTree(f.id))}return b}};var e=a.extend({name:"Comments",onInit:function(){var a=this.config.context.entity;this.converter=new b(this.config.context);var c=new d(this,this.converter);this.store.get(a.entityType.name,{id:a.id,fields:["id",{comments:["id","description","createDate","parentId",{owner:["id","firstName","lastName","kind"]}],list:!0}]},c.getAssignableRetrievedCallback()).done()},"bus createDTO":function(a){var b=a.data,c=this.converter.convertDTO(b);c.comments=[],this.fire("DTOCreated",c)},destroy:function(){this.converter.destroy(),this.converter=null,this._super()}});return e})