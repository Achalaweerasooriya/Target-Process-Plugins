define(["Underscore","tau/models/extension.model.base","tau/configurator"],function(a,b,c){return b.extend({category:"model assignment to role mapper","bus registerStoreRequest":function(){var a=this.config.context.entity||{entityType:{}},b={generalUser:["id","firstName","lastName"]};this.fire("get",{type:a.entityType.name,query:{id:a.id,fields:[{assignments:["id",{role:["id","name"]},b],list:!0}]},callback:{scope:this,success:this.onAssignmentsRetrieved}})},"bus assignmentsReady+rolesReady+extendDataToBind":function(a){var b=(a.assignmentsReady||{}).data,c=(a.rolesReady||{}).data,d=(a.extendDataToBind||{}).data,e=c,f=[];for(var g=0;g<e.length;g++){var h=e[g],i={};i.role=h,i.users=this.getUsersInRole(b,h),i.allowAdd=(h.isPair?2:1)>i.users.length,this.fire("userGroupWasCreated",i),f.push(i)}d.assignments={groups:f}},_convertUserDataToViewData:function(a){var b=[c.getApplicationPath(),"/Avatar.ashx?UserId=",a.id,"&size=32"].join("");return{id:a.id,name:a.firstName+" "+a.lastName,avatar:b}},getUsersInRole:function(b,c){var d=[],b=a.sortBy(b,function(a){return a.id}),e=b.length;for(var f=0;f<e;f++){var g=b[f];if(g.role.id==c.id){var h=this._convertUserDataToViewData(g.generalUser);h.assignmentId=g.id,h.roleId=c.id,d.push(h)}}return d}})})