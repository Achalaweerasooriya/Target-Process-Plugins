define(["Underscore","tau/models/extension.model.base","tau/configurator"],function(_,a,b){return a.extend({category:"model assignment to role mapper","bus registerStoreRequest":function(){var a=this.config.context.entity||{entityType:{}},b={generalUser:["id","firstName","lastName"]};this.fire("get",{type:a.entityType.name,query:{id:a.id,fields:[{assignments:["id",{role:["id","name"]},b],list:!0}]},callback:{scope:this,success:this.onAssignmentsRetrieved}})},"bus assignmentsReady+rolesReady+extendDataToBind":function(a){var b=(a.assignmentsReady||{}).data,c=(a.rolesReady||{}).data,d=(a.extendDataToBind||{}).data,e=c,f=[];for(var g=0;g<e.length;g++){var h=e[g],i={};i.role=h,i.users=this.getUsersInRole(b,h),i.allowAdd=(h.isPair?2:1)>i.users.length,this.fire("userGroupWasCreated",i),f.push(i)}d.assignments={groups:f}},_convertUserDataToViewData:function(a){var c=[b.getApplicationPath(),"/Avatar.ashx?UserId=",a.id,"&size=32"].join("");return{id:a.id,name:a.firstName+" "+a.lastName,avatar:c}},getUsersInRole:function(a,b){var c=[],a=_.sortBy(a,function(a){return a.id}),d=a.length;for(var e=0;e<d;e++){var f=a[e];if(f.role.id==b.id){var g=this._convertUserDataToViewData(f.generalUser);g.assignmentId=f.id,g.roleId=b.id,c.push(g)}}return c}})})