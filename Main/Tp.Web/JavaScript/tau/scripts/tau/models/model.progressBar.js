define(["Underscore","tau/core/class","tau/core/model-base"],function(e,t,i){var n=t.extend({init:function(e){this.model=e},setEntity:function(e){this.entity=e.data},done:function(){if(this.model.config){var t=this.model.entity=this.entity;if(t){var i={id:t.id,entityType:{name:t.__type},entityState:{id:t.entityState.id,name:t.entityState.name,isFinal:t.entityState.isFinal},effortCompleted:t.effortCompleted,effortToDo:t.effortToDo,timeSpent:t.timeSpent,timeRemain:t.timeRemain},n=Math.round(100*parseFloat(i.effortToDo)+100*parseFloat(i.effortCompleted))/100;i.percentCompleted=Math.round(1e4*(i.effortCompleted/n))/100,i.percentCompleted=isNaN(i.percentCompleted)?0:i.percentCompleted,i.percentCompleted=i.percentCompleted>100?100:i.percentCompleted,t.entityState.isFinal&&(i.percentCompleted=100),i.disableSpentRemain=this.model.config.context.getTimeTrackingPolicies().disableSpentRemain;var a=this.model.config.maxWidthPercents;i.maxWidthPercents=e.isUndefined(a)?100:a,i.textMode=this.model.config.textMode,this.model.bus.fire("dataBind",i)}}}}),a=i.extend({name:"Progress Bar",beforeSaveRoleEffort:function(e){var t=e.data.cmd.config;t.fields=t.fields||[],t.fields.push({assignable:["id","effortCompleted","effortToDo","timeSpent","timeRemain"]})},afterSaveRoleEffort:function(){var e=this;e.fire("roleEffortChanged")},onDataUpdated:function(){var e=this;e.fire("refresh")},onInit:function(){var t=this,i=new n(this),a=this.config.context,o=a.entity.entityType.name,r=a.entity.id,s={entityState:["id","name","isFinal"]},f=["effortCompleted","effortToDo","timeSpent","timeRemain",s],d=function(e){var i=e.data.cmd.config.fields;e.data.cmd.config.fields=i.concat(f),t.fire("beforeChanges",e.data.changes)},m=function(e){e.data&&e.data.cmd&&t.isInTransaction(e)||t.fire("applyChanges",e.data.changes)};t.store.unbind(this),t.store.on({eventName:"beforeSave",type:o,filter:{id:a.entity.id},hasChanges:["entityState"],listener:this},d),t.store.on({eventName:"afterSave",type:o,filter:{id:a.entity.id},hasChanges:["entityState"],listener:this},m),t.store.on({eventName:"afterSave",type:o,filter:{id:a.entity.id},hasChanges:["effort|effortCompleted|effortToDo|timeSpent|timeRemain"],listener:t},e.bind(t.onDataUpdated,t)),t.store.on({eventName:"beforeSave",type:"roleEffort",listener:this},function(){t.beforeSaveRoleEffort.apply(t,arguments)
}),t.store.on({eventName:"afterSave",type:"roleEffort",filter:{assignable:{id:a.entity.id}},listener:this},function(i){var n=i.data.changes||{},a=0===e.keys(n).length;a||t.isInTransaction(i)||t.afterSaveRoleEffort.apply(t,arguments)}),this.store.get(o,{id:r,fields:f},{success:i.setEntity,scope:i}).done({success:i.done,scope:i})},isInTransaction:function(e){var t=this,i=e.data?e.data.cmd:{};return i===t.lastCmd?!0:(t.lastCmd=i,!1)},"bus evict":function(){var e=this.config.context.entity;this.store.evictProperties(e.id,e.entityType.name,["effortCompleted","effortToDo","timeSpent","timeRemain","entityState"])}});return a});