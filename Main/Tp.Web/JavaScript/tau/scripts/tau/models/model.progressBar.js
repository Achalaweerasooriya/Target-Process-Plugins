define(["tau/core/model-base"],function(a){var b=function(a){this.model=a};b.prototype={setEntity:function(a){this.entity=a.data},done:function(){var a=this.model.entity=this.entity;if(!a)return;var b={id:a.id,entityType:{name:a.__type},entityState:{id:a.entityState.id,name:a.entityState.name,isFinal:a.entityState.isFinal},effortCompleted:a.effortCompleted,effortToDo:a.effortToDo,timeSpent:a.timeSpent,timeRemain:a.timeRemain},c=Math.round(100*parseFloat(b.effortToDo)+100*parseFloat(b.effortCompleted))/100;b.percentCompleted=Math.round(1e4*(b.effortCompleted/c))/100,b.percentCompleted=isNaN(b.percentCompleted)?0:b.percentCompleted,b.percentCompleted=b.percentCompleted>100?100:b.percentCompleted,a.entityState.isFinal&&(b.percentCompleted=100),b.disableSpentRemain=this.model.config.context.getTimeTrackingPolicies().disableSpentRemain;var d=this.model.config.maxWidthPercents;_.isUndefined(d)===!1?b.maxWidthPercents=d:b.maxWidthPercents=100,this.model.bus.fire("dataBind",b)}};var c=a.extend({name:"Progress Bar",beforeSaveRoleEffort:function(a){var b=a.data.cmd.config;b.fields=b.fields||[],b.fields.push({assignable:["id","effortCompleted","effortToDo","timeSpent","timeRemain"]})},afterSaveEntity:function(a){var b=a.data;b.changes.hasOwnProperty("timeRemain")&&b.id===this.config.context.entity.id&&this.fire("remainTimeChanged")},afterSaveRoleEffort:function(a){var b=this;b.fire("roleEffortChanged")},onInit:function(){var a=this,c=new b(this),d=this.config.context,e=d.entity.entityType.name,f=d.entity.id,g=["effortCompleted","effortToDo","timeSpent","timeRemain",{entityState:["id","name","isFinal"]}],h=function(b){var c=b.data.cmd.config.fields;b.data.cmd.config.fields=c.concat(g),a.fire("beforeChanges",b.data.changes)},i=function(b){if(a.isInTransaction(b))return;a.fire("applyChanges",b.data.changes)};a.store.unbind(this),a.store.on({eventName:"beforeSave",type:e,filter:{id:d.assignable.id},hasChanges:["entityState"],listener:this},h),a.store.on({eventName:"afterSave",type:e,filter:{id:d.assignable.id},hasChanges:["entityState"],listener:this},i),a.store.on({eventName:"beforeSave",type:"roleEffort",listener:this},function(){a.beforeSaveRoleEffort.apply(a,arguments)}),a.store.on({eventName:"afterSave",type:"roleEffort",filter:{assignable:{id:d.assignable.id}},listener:this},function(b){if(a.isInTransaction(b))return;a.afterSaveRoleEffort.apply(a,arguments)}),a.store.on({eventName:"afterSave",type:e,listener:this},function(){a.afterSaveEntity.apply(a,arguments)}),this.store.get(e,{id:f,fields:g},{success:c.setEntity,scope:c}).done({success:c.done,scope:c})},isInTransaction:function(a){var b=this,c=a.data?a.data.cmd:{};return c===b.lastCmd?!0:(b.lastCmd=c,!1)},"bus evict":function(){var a=this.config.context.general;this.store.evictProperties(a.id,a.entityType.name,["effortCompleted","effortToDo","timeSpent","timeRemain","entityState"])}});return c})