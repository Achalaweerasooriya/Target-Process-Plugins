define(["tau/core/model-base"],function(e){var t=function(e){this.model=e};t.prototype={setEntity:function(e){this.entity=e.data},done:function(){if(this.model.config){var e=this.model.entity=this.entity;if(e){var t={id:e.id,entityType:{name:e.__type},entityState:{id:e.entityState.id,name:e.entityState.name,isFinal:e.entityState.isFinal},effortCompleted:e.effortCompleted,effortToDo:e.effortToDo,timeSpent:e.timeSpent,timeRemain:e.timeRemain},i=Math.round(100*parseFloat(t.effortToDo)+100*parseFloat(t.effortCompleted))/100;t.percentCompleted=Math.round(1e4*(t.effortCompleted/i))/100,t.percentCompleted=isNaN(t.percentCompleted)?0:t.percentCompleted,t.percentCompleted=t.percentCompleted>100?100:t.percentCompleted,e.entityState.isFinal&&(t.percentCompleted=100),t.disableSpentRemain=this.model.config.context.getTimeTrackingPolicies().disableSpentRemain;var n=this.model.config.maxWidthPercents;t.maxWidthPercents=_.isUndefined(n)===!1?n:100,t.textMode=this.model.config.textMode,this.model.bus.fire("dataBind",t)}}}};var i=e.extend({name:"Progress Bar",beforeSaveRoleEffort:function(e){var t=e.data.cmd.config;t.fields=t.fields||[],t.fields.push({assignable:["id","effortCompleted","effortToDo","timeSpent","timeRemain"]})},afterSaveEntity:function(e){var t=e.data;t.changes.hasOwnProperty("timeRemain")&&t.id===this.config.context.entity.id&&this.fire("remainTimeChanged")},afterSaveRoleEffort:function(){var e=this;e.fire("roleEffortChanged")},onDataUpdated:function(){var e=this;e.fire("refresh")},onInit:function(){var e=this,i=new t(this),n=this.config.context,a=n.entity.entityType.name,o=n.entity.id,r={entityState:["id","name","isFinal"]},f=["effortCompleted","effortToDo","timeSpent","timeRemain",r],s=function(t){var i=t.data.cmd.config.fields;t.data.cmd.config.fields=i.concat(f),e.fire("beforeChanges",t.data.changes)},d=function(t){var i=t.data?t.data.cmd:null;null!=i&&e.isInTransaction(t)||e.fire("applyChanges",t.data.changes)};e.store.unbind(this),e.store.on({eventName:"beforeSave",type:a,filter:{id:n.entity.id},hasChanges:["entityState"],listener:this},s),e.store.on({eventName:"afterSave",type:a,filter:{id:n.entity.id},hasChanges:["entityState"],listener:this},d),e.store.on({eventName:"afterSave",type:a,filter:{id:n.entity.id},hasChanges:["effort|effortCompleted|effortToDo|timeSpent|timeRemain"],listener:e},_.bind(e.onDataUpdated,e)),e.store.on({eventName:"beforeSave",type:"roleEffort",listener:this},function(){e.beforeSaveRoleEffort.apply(e,arguments)}),e.store.on({eventName:"afterSave",type:"roleEffort",filter:{assignable:{id:n.entity.id}},listener:this},function(t){var i=t.data.changes||{},n=0===_.keys(i).length;n||e.isInTransaction(t)||e.afterSaveRoleEffort.apply(e,arguments)}),this.store.get(a,{id:o,fields:f},{success:i.setEntity,scope:i}).done({success:i.done,scope:i})},isInTransaction:function(e){var t=this,i=e.data?e.data.cmd:{};return i===t.lastCmd?!0:(t.lastCmd=i,!1)},"bus evict":function(){var e=this.config.context.entity;this.store.evictProperties(e.id,e.entityType.name,["effortCompleted","effortToDo","timeSpent","timeRemain","entityState"])}});return i});