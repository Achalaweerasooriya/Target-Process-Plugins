define(["require","Underscore","./model.finder.entity.data"],function(t){var e=t("Underscore"),s=t("./model.finder.entity.data");return s.extend({_defaultFilterEntityMap:[{entityTypes:["testcase"],asDefault:"testcase"},{entityTypes:["testplan","testcase"],asDefault:"testplan"},{entityTypes:["bug"],asDefault:"bug"}],entityDslFilters:{},"bus afterInit":function(t,e){this.config=e.config},"bus item.selected":function(t,e){this.config.parentBus.fire("link.entity",{entityId:e,path:this.config.treeCardPath,lookupBus:this.bus})},processOptions:function(t,s){var i=e.defaults(t,{filter:{entityType:"user"},columnsDisabled:{release:!0,iteration:!0}});return this._super(i,s)},processInitDsl:function(t){var s=$.Deferred();this._initDslFilters(t);var i=e.find(this._defaultFilterEntityMap,function(s){return e.isEqual(s.entityTypes,t.entityType)});return this.entityDslFilters["default"]=this.entityDslFilters[i&&i.asDefault],t.filter.init_dsl=this.entityDslFilters["default"],s.resolve(t),s.promise()},doSearch:function(t,e){var s=t.getFilterParamValue("entityType.name"),i=this.entityDslFilters[s];return t.setFilterParamValue("init_dsl",i?i:this.entityDslFilters["default"]),this._super(t,e)},_initDslFilters:function(t){var s=t.entityType,i=this._getParentEntityIds(t),n=e.intersection(s,["testcase","testplan","bug"]);e.each(n,function(s){var n=[];switch(s){case"testcase":case"testplan":n.push("not(It."),n.push("testcase"==s?"TestPlans":"ParentTestPlans"),n.push(".Where(It.Id is "),n.push(t.immediateParentId),n.push("))"),e.each(i,function(t){n.push(" and It.Id is not "),n.push(t)});break;case"bug":n.push("not(It.TestCaseRuns.Where(It.Id is "),n.push(t.immediateParentId),n.push("))");break;default:return}this.entityDslFilters[s]=n.join("")}.bind(this))},_getParentEntityIds:function(t){var s=[t.entity.id];return e.each(t.allParentCards,function(t){s.push(t.getId())}),s}})});