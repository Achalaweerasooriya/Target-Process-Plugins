define(["Underscore","tau/core/extension.base","./sliceQueryBuilder","./sliceSearchResult"],function(e,t,i,r){return t.extend({"bus beforeInit":function(t,i){var r=i.config.context.configurator,n=i.config;n.acid=i.config.context.acid;var a=e.bind(this.fire,this);a("configurator.ready",r),this.createContext(r).then(e.bind(function(e){return n.acid=e.acid,this.processOptions(n,r)},this)).then(function(e){return e.allData=e.allData||{},a("options.ready",e),a("dataBind",{isAddPossible:e.allData.isAddPossible,fieldCaption:e.allData.fieldCaption,filter:e.filter,filterValues:e.filterValues,filterDisabled:e.filterDisabled,columnsDisabled:e.columnsDisabled,result:null}),a("types.ready",e.entityType),e}).then(e.bind(function(e){return this.createBuilder(e,r).done(function(e){a("builder.ready",e)}),e},this)).then(e.bind(function(e){return this.buildInitialParameters(e,r).done(function(e){a("search.parametersBound",e)})},this))},"bus builder.ready:last + search.parametersBound":function(t,i,r){e.forEach(r,function(t,r){e.isUndefined(t)||""===t?i.unsetParameter(r):i.setParameter(r,t)}),i.setPage(0),this.fire("search.readyToExecute")},"bus builder.ready:last + search.pagingBound":function(e,t){t.setPage(t._page+1),this.fire("search.readyToExecute")},"bus builder.ready:last + search.orderBound":function(e,t,i){t.setOrderBy(i.value),t.setOrderDir(i.dir),t.setPage(0),this.fire("search.readyToExecute")},"bus beforeInit:last + configurator.ready:last + builder.ready:last + search.readyToExecute":function(t,i,r,n){this.doSearch(n,r).then(e.bind(this.processResult,this)).done(e.bind(function(e){this.fire("search.completed",{result:e})},this)).fail(e.bind(function(e){this.fire("search.completed",{result:e})},this))},"bus search.completed":function(e,t){this.fire("result.ready",t.result)},createContext:function(e){var t=$.Deferred();return e.getApplicationContextService().getApplicationContext({projectIds:"*",teamIds:"*"},{success:function(e){t.resolve(e)}}),t.promise()},processOptions:function(t,i){var r=$.Deferred(),n=["feature","userstory","task","bug","testplanrun","request"],a=e.defaults(t,{filter:{entityType:["program","release","iteration","teamiteration","testcase","testplan","build","impediment","feature","userstory","task","bug","testplanrun","request"]},filterValues:{},filterDisabled:[],fields:[],parameters:["_id","name","entityType.name","entityState.name","project.id","team.id","_project.id","release.id","iteration.id","user_dsl_filter","init_dsl","dsl"],onPage:15,ordering:{name:"Creation Date",dir:"desc"},columnsDisabled:{}});
a.propertyName&&(a.entityType=a.propertyName.toLowerCase(),"assignable"==a.entityType&&(a.entityType=n)),a.entityType&&(a.entityType=e.isArray(a.entityType)?a.entityType:[a.entityType],a.filter.entityType=a.entityType),a.filter.entityType&&e.has(a.filter.entityType,"$in")?i.getStore().find("entityType",{fields:["id","name"],$query:{id:{$in:a.filter.entityType.$in}}}).done(function(t){a.entityType=e.map(e.pluck(t[0].data,"name"),function(e){return e.toLowerCase()}),r.resolve(a)}):(a.filter.entityType&&(a.entityType=a.filter.entityType),r.resolve(a));var s=r.then(function(t){t.entityType&&t.filter.entityType&&(delete t.filter.entityType,t.filterValues.entityType=t.filterValues.entityType||{},t.filterValues.entityType.name={$in:t.entityType},t.filterValues.entityState=t.filterValues.entityState||{},t.filterValues.entityState["entityType.name"]={$in:t.entityType}),e.each(["project","team","release","iteration"],function(i){e.isUndefined(t.filter[i])||(t.filter[i+".id"]=t.filter[i],delete t.filter[i])}),1==t.entityType.length&&t.filterDisabled.push("entityType.name");var r=["project","release","iteration","team","entityState","firstName","lastName","avatarUri","email"];e.each(t.entityType,function(n){var a=i.getStore().config.proxy.getProperties(n);"feature"==n&&(a=e.without(a,"iteration")),"request"==n&&(a=e.without(a,"release","iteration")),e.contains(["team","teamiteration","project","program"],n)&&(a=e.without(a,"project")),i.isBoardEdition||t.context.hasEdition&&!t.context.hasEdition("hasTeams")&&(a=e.without(a,"team")),r=e.difference(r,a)});var n={};return e.forEach(r,function(i){n[i]=!0,t.parameters=e.without(t.parameters,i,i+".id")}),t.columnsDisabled=e.extend(t.columnsDisabled,n),t}).then(e.bind(this.processInitDsl,this,a,i)).then(function(t){var r=t.context.entity;if(!r)return t;var n=$.Deferred(),a=i.getStore(),s=a.config.proxy.getProperties(r.entityType.name),o=[];return e.indexOf(s,"project")>=0&&o.push({project:["id"]}),e.indexOf(s,"team")>=0&&o.push({team:["id"]}),i.getStore().get(r.entityType.name,{id:r.id,fields:o}).done({success:function(i){var r=i[0].data;
r.project&&r.project.id&&e.contains(t.parameters,"project.id")&&(t.filter["project.id"]=r.project.id),n.resolve(t)},failure:function(){n.resolve(t)}}),n});return s.promise()},processInitDsl:function(t,i){var r=$.Deferred();if(t.propertyName){var n=t.context.entity,a=[{}];a[0][t.propertyName]=["id"],i.getStore().get(n.entityType.name,{id:n.id,fields:a}).done({success:function(i){var n=i[0].data,a=n[t.propertyName];if(a&&a.id){var s=[t.filter.init_dsl,e.sprintf("id != %d",a.id)];t.filter.init_dsl=e.compact(s).join(" and ")}r.resolve(t)},failure:function(){r.resolve(t)}})}else r.resolve(t);return r},createBuilder:function(t,r){var n=$.Deferred(),a={};e.forEach(t.entityType,function(i){var n,s={name:"name",entityState:"entityState",project:{project:["id","name","abbreviation","color"]},team:{team:["id","name","abbreviation","icon"]},release:{release:["id","name"]},iteration:{iteration:["id","name"]}};if(t.fields.length)n=["id"].concat(t.fields);else{var o=r.getStore().config.proxy.getProperties(i);n=["id","entityType"],e.each(s,function(i,r){e.contains(o,r)&&!t.columnsDisabled[r]&&n.push(i)})}a[i]=n});var s=new i;return s.registerParameters(t.parameters),s.setOnPage(t.onPage),s.setFields(a),s.setAcid(t.acid),t.ordering&&(s.setOrderBy(t.ordering.name),s.setOrderDir(t.ordering.dir)),n.resolve(s)},buildInitialParameters:function(t){var i=$.Deferred(),r=e.reduce(t.filter||{},function(t,i,r){return e.isUndefined(i)||(t[r]=i),t},{});return i.resolve(r)},doSearch:function(t,i){var n=t.create();if(!n)return $.Deferred().reject(new r({data:{dynamic:{items:[]},fixed:{items:[]}},command:{}}));var a=i.getSliceFactory().create({definition:n.request});a.on("error",e.bind(function(e){this.fire("lookup.error",e.data)},this));var s=this;return a.list(n.command).then(function(e){return new r({data:e.data.items[0],command:e.command.config})},function(){return new r({data:{dynamic:{items:[]},fixed:{items:[]}},command:{}})}).then(function(e){return s.processSearchResults(e)})},processSearchResults:function(e){return e
},processResult:function(t){return t.items=e.map(t.items,function(e){return e.data}),t}})});