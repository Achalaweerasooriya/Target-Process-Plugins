define(["require","jQuery","Underscore","tau/core/extension.base","./sliceQueryBuilder","./sliceSearchResult"],function(e){var t=e("jQuery"),i=e("Underscore"),r=e("tau/core/extension.base"),n=e("./sliceQueryBuilder"),a=e("./sliceSearchResult");return r.extend({"bus beforeInit":function(e,t){var r=t.config.context.configurator,n=t.config;n.acid=t.config.context.acid;var a=i.bind(this.fire,this);a("configurator.ready",r),this.createContext(r).then(i.bind(function(e){return n.acid=e.acid,this.processOptions(n,r)},this)).then(function(e){return e.allData=e.allData||{},a("options.ready",e),a("dataBind",{isAddPossible:e.allData.isAddPossible,fieldCaption:e.allData.fieldCaption,filter:e.filter,filterValues:e.filterValues,filterDisabled:e.filterDisabled,columnsDisabled:e.columnsDisabled,result:null}),a("types.ready",e.entityType),e}).then(i.bind(function(e){return this.createBuilder(e,r).done(function(e){a("builder.ready",e)}),e},this)).then(i.bind(function(e){return this.buildInitialParameters(e,r).done(function(e){a("search.parametersBound",e)})},this))},"bus builder.ready:last + search.parametersBound":function(e,t,r){i.forEach(r,function(e,r){i.isUndefined(e)||""===e?t.unsetParameter(r):t.setParameter(r,e)}),t.setPage(0),this.fire("search.readyToExecute")},"bus builder.ready:last + search.pagingBound":function(e,t){t.setPage(t._page+1),this.fire("search.readyToExecute")},"bus builder.ready:last + search.orderBound":function(e,t,i){t.setOrderBy(i.value),t.setOrderDir(i.dir),t.setPage(0),this.fire("search.readyToExecute")},"bus beforeInit:last + configurator.ready:last + builder.ready:last + search.readyToExecute":function(e,t,r,n){this.doSearch(n,r).then(i.bind(this.processResult,this)).done(i.bind(function(e){this.fire("search.completed",{result:e})},this)).fail(i.bind(function(e){this.fire("search.completed",{result:e})},this))},"bus search.completed":function(e,t){this.fire("result.ready",t.result)},createContext:function(e){var i=t.Deferred();return e.getApplicationContextService().getApplicationContext({projectIds:"*",teamIds:"*"},{success:function(e){i.resolve(e)
}}),i.promise()},processOptions:function(e,r){var n=t.Deferred(),a=["epic","feature","userstory","task","bug","testplanrun","request"],s=i.defaults(e,{filter:{entityType:["project","program","release","iteration","teamiteration","testcase","testplan","build","impediment","epic","feature","userstory","task","bug","testplanrun","request"]},filterValues:{},filterDisabled:[],fields:[],parameters:["_id","name","entityType.name","entityState.name","project.id","team.id","_project.id","release.id","iteration.id","user_dsl_filter","init_dsl","dsl"],onPage:15,ordering:{name:"Creation Date",dir:"desc"},columnsDisabled:{}});!s.entityType&&s.propertyName&&(s.entityType=s.propertyName.toLowerCase(),"assignable"==s.entityType&&(s.entityType=a)),s.entityType&&(s.entityType=i.isArray(s.entityType)?s.entityType:[s.entityType],s.filter.entityType=s.entityType),s.filter.entityType&&i.has(s.filter.entityType,"$in")?r.getStore().find("entityType",{fields:["id","name"],$query:{id:{$in:s.filter.entityType.$in}}}).done(function(e){s.entityType=i.map(i.pluck(e[0].data,"name"),function(e){return e.toLowerCase()}),n.resolve(s)}):(s.filter.entityType&&(s.entityType=s.filter.entityType),n.resolve(s));var o=n.then(function(e){e.entityType&&e.filter.entityType&&(delete e.filter.entityType,e.filterValues.entityType=e.filterValues.entityType||{},e.filterValues.entityType.name={$in:e.entityType},e.filterValues.entityState=e.filterValues.entityState||{},e.filterValues.entityState["entityType.name"]={$in:e.entityType}),i.each(["project","team","release","iteration"],function(t){i.isUndefined(e.filter[t])||(e.filter[t+".id"]=e.filter[t],delete e.filter[t])}),1==e.entityType.length&&e.filterDisabled.push("entityType.name");var t=["project","release","iteration","team","entityState","firstName","lastName","avatarUri","email"];i.each(e.entityType,function(n){var a=r.getStore().config.proxy.getProperties(n);"feature"==n&&(a=i.without(a,"iteration")),"request"==n&&(a=i.without(a,"release","iteration")),i.contains(["team","teamiteration","project","program"],n)&&(a=i.without(a,"project")),r.isBoardEdition||e.context.hasEdition&&!e.context.hasEdition("hasTeams")&&(a=i.without(a,"team")),t=i.difference(t,a)
});var n={};return i.forEach(t,function(t){n[t]=!0,e.parameters=i.without(e.parameters,t,t+".id")}),e.columnsDisabled=i.extend(e.columnsDisabled,n),e}).then(i.bind(this.processInitDsl,this,s,r)).then(function(e){var n=e.context.entity;if(!n)return e;var a=t.Deferred(),s=r.getStore(),o=s.config.proxy.getProperties(n.entityType.name),d=[];return i.indexOf(o,"project")>=0&&d.push({project:["id"]}),i.indexOf(o,"team")>=0&&d.push({team:["id"]}),r.getStore().get(n.entityType.name,{id:n.id,fields:d}).done({success:function(t){var r=t[0].data;r.project&&r.project.id&&i.contains(e.parameters,"project.id")&&(e.filter["project.id"]=r.project.id),a.resolve(e)},failure:function(){a.resolve(e)}}),a});return o.promise()},processInitDsl:function(e,r){var n=t.Deferred();if(e.propertyName){var a=e.context.entity,s=[{}];s[0][e.propertyName]=["id"],r.getStore().get(a.entityType.name,{id:a.id,fields:s}).done({success:function(t){var r=t[0].data,a=r[e.propertyName];if(a&&a.id){var s=[e.filter.init_dsl,i.sprintf("id != %d",a.id)];e.filter.init_dsl=i.compact(s).join(" and ")}n.resolve(e)},failure:function(){n.resolve(e)}})}else n.resolve(e);return n},createBuilder:function(e,r){var a=t.Deferred(),s={};i.forEach(e.entityType,function(t){var n,a={name:"name",entityState:"entityState",project:{project:["id","name","abbreviation","color"]},team:{team:["id","name","abbreviation","icon"]},release:{release:["id","name"]},iteration:{iteration:["id","name"]}};if(e.fields.length)n=["id"].concat(e.fields);else{var o=r.getStore().config.proxy.getProperties(t);n=["id","entityType"],i.each(a,function(t,r){i.contains(o,r)&&!e.columnsDisabled[r]&&n.push(t)})}s[t]=n});var o=new n;return o.registerParameters(e.parameters),o.setOnPage(e.onPage),o.setFields(s),o.setAcid(e.acid),e.ordering&&(o.setOrderBy(e.ordering.name),o.setOrderDir(e.ordering.dir)),a.resolve(o)},buildInitialParameters:function(e){var r=t.Deferred(),n=i.reduce(e.filter||{},function(e,t,r){return i.isUndefined(t)||(e[r]=t),e},{});return r.resolve(n)
},doSearch:function(e,r){var n=e.create();if(!n)return t.Deferred().reject(new a({data:{dynamic:{items:[]},fixed:{items:[]}},command:{}}));var s=r.getSliceFactory().create({definition:n.request});return s.on("error",i.bind(function(e){this.fire("lookup.error",e.data)},this)),s.list(n.command).then(function(e){return new a({data:e.data.items[0],command:e.command.config})},function(){return new a({data:{dynamic:{items:[]},fixed:{items:[]}},command:{}})}).then(function(e){return this.processSearchResults(e)}.bind(this))},processSearchResults:function(e){return e},processResult:function(e){return e.items=i.map(e.items,function(e){return e.data}),e}})});