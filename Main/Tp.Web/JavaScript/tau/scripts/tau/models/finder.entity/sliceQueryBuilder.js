define(["Underscore","./queryBuilder"],function(e,t){return t.extend({setAcid:function(e){this._acid=e},create:function(){var t=this._extractFields();if(0==e.values(t).length)return!1;var i=this._values,n={global:{acid:this._acid},cells:{filter:this.createFilter(i),types:e.map(t,e.bind(function(e,t){return{type:t,data:this.convertFields("",e)}},this)),ordering:{name:this._orderBy,direction:"asc"===this._orderDir?"Asc":"Desc"}},user:{cardFilter:i.user_dsl_filter}};return{collection:this.createCollection(),request:n,command:{$take:this._onPage,$skip:(this._page>0?this._page-1:0)*this._onPage}}},createFilter:function(t){var i=e.map(t,function(e,t){switch(t){case"_id":return"id == "+e;case"init_dsl":return e;case"user_dsl_filter":return null;case"firstName":case"lastName":case"email":case"name":return'"'+e+'" in '+t;case"entityState.name":return t+' is "'+e+'"';case"entityType.name":return null;case"project.id":case"_project.id":return-1==e?"project is None":"project.id == "+e;case"team.id":return-1==e?"team is None":t+" == "+e;case"release.id":return-1==e||null===e?"release is None":t+" == "+e;case"iteration.id":return-1==e||null===e?"iteration is None":t+" == "+e;default:return null}});return i=e.compact(i),i=e.map(i,function(e){return"("+e+")"}),"?"+i.join(" and ")},convertWhere:function(t,i){var n=e.map(i,e.bind(function(i,n){var r;if(!e.startsWith(i,"$"))return e.isObject(n)?this.convertWhere(t,n):n;switch(i){case"$and":return r=this.convertWhere(t,n),r.join(" AND ");case"$or":return r=this.convertWhere(t,n),r.join(" OR ")}},this));return e.compact(["?"+n.join(" AND "),t]).join(" AS ")},convertFields:function(t,i){var n=e.map(i,e.bind(function(i){if(e.isObject(i)&&!e.isArray(i)){var n=e.keys(i)[0];return this.convertFields(n,i[n])}return e.compact([t,i]).join(".")},this));return e.compact(["{"+n.join(",")+"}",t]).join(" AS ")},getFilterParamValue:function(e){return this._values[e]},setFilterParamValue:function(e,t){return this._values[e]=t},_extractFields:function(){var t=e.clone(this._fields),i=e.without(e.keys(this._values),"user_dsl_filter","init_dsl");
return this._values["entityType.name"]&&(t=e.pick(t,this._values["entityType.name"])),i.length&&(e.indexOf(i,"entityState.name")>=0&&(t.impediment&&e.keys(t).length>1&&delete t.impediment,e.forEach(t,e.bind(function(i,n){var r=e.find(i,function(e){return"entityState"==e});r||delete t[n]},this))),e.indexOf(i,"team.id")>=0&&(delete t.teamiteration,e.forEach(t,e.bind(function(i,n){var r=e.find(i,function(t){return e.isObject(t)&&"team"==e.keys(t)[0]});r||delete t[n]},this))),(e.indexOf(i,"iteration.id")>=0||e.indexOf(i,"release.id")>=0)&&(delete t.iteration,delete t.testplanrun,delete t.build,e.forEach(t,e.bind(function(i,n){var r=e.find(i,function(t){return e.isObject(t)&&("release"==e.keys(t)[0]||"iteration"==e.keys(t)[0])});r||delete t[n]},this)))),t}})});