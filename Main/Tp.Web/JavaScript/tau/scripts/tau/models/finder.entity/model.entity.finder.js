define(["Underscore","tau/core/class","tau/core/model-base"],function(_,Class,ModelBase){var QueryBuilder=Class.extend({init:function(){this._collection=null,this._parameters=[],this._values={},this._fields=[],this._page=1,this._onPage=10,this._orderBy=null,this._orderDir="asc"},setFields:function(fields){this._fields=fields},setCollection:function(value){this._collection=value},registerParameters:function(params){this._parameters=_.toArray(params)},setParameter:function(name,val){if(_.indexOf(this._parameters,name)==-1)throw new Error('No "'+name+'" parameter for query');this._values[name]=val},setOnPage:function(value){this._onPage=value},setPage:function(page){this._page=page||1},setOrderBy:function(value){this._orderBy=value},setOrderDir:function(value){this._orderDir=value},create:function(){var query={};query.collection=this.createCollection();var request={};request.fields=this._fields,request.$query=this.createWhere();var paging=this.createPaging();request.$skip=paging.skip,request.$limit=paging.limit;var orderBy=this._orderDir=="asc"?"$orderBy":"$orderByDesc";return request[orderBy]=this.createOrderBy(),query.request=request,query},createCollection:function(){return this._collection},createWhere:function(){var where={};return _.forEach(this._values,function(val,name){where[name]=val}),where},createOrderBy:function(){return this._orderBy||"id"},createPaging:function(){var paging={limit:this._onPage,skip:0};return paging.skip=(this._page-1)*this._onPage,paging}}),RequestersQueryBuilder=QueryBuilder.extend({init:function(){this._super(),this.registerParameters(["name","id","project","action","iteration","release","isCurrent","entityType"])},createCollection:function(){return this._super()},createWhere:function(){var where={};return this._values.name!==undefined&&(where.name={$contains:this._values.name}),this._values.project!==undefined&&(where.project=this._values.project),this._values.iteration!==undefined&&(where.iteration=this._values.iteration),this._values.release!==undefined&&(where.release=this._values.release),this._values.entityType!==undefined&&(where.entityType=this._values.entityType),where}}),SearchResult=Class.extend({init:function(result,dataId){this.items=_.union(dataId,result.data);var command=result.command,length=this.items.length;this.paging={start:command.config.$skip,end:command.config.$skip+length,count:length,hasNext:result.data.isNextPageAvailable()}}});return ModelBase.extend({"bus refresh":function(evt){_.extend(this.config,evt.data,!0)},"bus beforeInit":function(evt){this.config=evt.data.config;var entityType=this.config.entitytype||"generals",self=this,actions=this.config.actions||[];this.config.emptyDataMessage=this.config.emptyDataMessage||"No data found";var fields=["id","name",{entityType:["id","name"]}];entityType=="generals"&&fields.push({project:["id","name","abbreviation"]}),entityType=="releases"&&fields.push("isCurrent");var builder=new RequestersQueryBuilder;builder.setCollection(entityType),builder.setOnPage(15),builder.setFields(fields),builder.setOrderBy("id"),entityType=="releases"&&(fields.push("isCurrent"),builder.setOrderBy("startDate")),builder.setOrderDir("desc"),this.builder=builder;var parameters=_.reduce(this.config.filter||{},function(memo,value,key){return value=="-1"&&(value=null),(value||value===null)&&(memo[key]={id:value}),memo},{});self.fire("search.parametersBound",{parameters:parameters}),self.fire("dataBind",{actions:actions,result:null})},"bus search.readyToExecute":function(){var query=this.builder.create(),searchById=function(query,self){var id=query.request.$query.name&&query.request.$query.name.$contains;id=parseInt(+id);var nameIsNumber=!isNaN(id);nameIsNumber?(query.request.$query.id=id,delete query.request.$query.name,self.config.store.find(query.collection,query.request).done({success:function(result){self.fire("searchId.completed",result[0])}})):self.fire("searchId.completed",{data:[]})};searchById(query,this)},"bus searchId.completed":function(evt,dataSearchId){var query=this.builder.create(),self=this;this.config.store.find(query.collection,query.request).done({success:function(result){var searchResult=new SearchResult(result[0],dataSearchId.data);self.fire("search.completed",{result:searchResult})}})},"bus search.completed":function(evt){this.fire("result.ready",{data:{result:evt.data.result}})},"bus search.parametersBound":function(evt){var parameters=evt.data.parameters,builder=this.builder;_.forEach(parameters,function(val,name){val?builder.setParameter(name,val):builder.setParameter(name,undefined)}),builder.setPage(0),this.fire("search.readyToExecute")},"bus search.pagingBound":function(){var builder=this.builder;builder.setPage(builder._page+1),this.fire("search.readyToExecute")},"bus search.orderBound":function(evt){var builder=this.builder;builder.setOrderBy(evt.data.value),builder.setOrderDir(evt.data.dir),builder.setPage(1),this.fire("search.readyToExecute")}})})