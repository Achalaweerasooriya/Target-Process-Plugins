define(["Underscore","tau/models/finder.entity/model.finder.entity.data"],function(t,e){return e.extend({processOptions:function(e,n){var i=$.Deferred(),r=e.customField,s=t.map(t.clone(r.options),function(t){return parseInt(t,10)}),o=t.bind(this._super,this);return n.getStore().get("entityType",{fields:["id","name"]}).done({success:t.bind(function(r){var u=r[0].data,d=t.pluck(t.filter(u,function(e){return t.indexOf(s,e.id)>=0}),"name");e.entityType=d.length?t.map(d,function(t){return t.toLowerCase()}):null,o(e,n).then(function(t){i.resolve(t)})},this)}),i.promise()},processInitDsl:function(e,n){var i=e.customField,r=e.context.entity,s=$.Deferred();return n.getStore().get(r.entityType.name,{id:r.id,fields:["customFields"]}).done(t.bind(function(t){var n=this.getCustomFieldByName(t[0].data.customFields,i.name);e=this.setOptionsInitDslFromCustomFieldValue(e,n.value),s.resolve(e)},this)),s.promise()},setOptionsInitDslFromCustomFieldValue:function(t,e){var n=[];return e&&n.push(e.id),t.filter.init_dsl=this.updateInitDslWithIds(t.filter.init_dsl,n),t},getCustomFieldByName:function(e,n){return t.find(e,function(t){return t.name===n})},updateInitDslWithIds:function(e,n){var i=t.map(n,function(e){return t.sprintf("id != %d",e)});return e&&i.unshift(e),e=i.join(" and ")}})});