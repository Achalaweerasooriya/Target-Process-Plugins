define(["require","Underscore","jQuery","tau/utils/utils.htmlConverter","tau/utils/utils.editors","tau/core/extension.base.stateful"],function(e){var t=e("Underscore"),i=e("jQuery"),n=e("tau/utils/utils.htmlConverter"),a=e("tau/utils/utils.editors"),r=e("tau/core/extension.base.stateful"),o=r.extend({_getValue:function(e,t){return e.getDef(t.entityTypeName,{id:t.entityId,fields:["id",t.fieldName]}).then(function(e){return e[t.fieldName]})},onInit:function(e){var r=this,o=e.context.entity,l=this.store,s=e.fieldName,u=o.entityType.name,d=o.id;l.unbind(r);var f=function(e,t){if(t.data.id==d){var i=t.data.changes;i.hasOwnProperty(s)&&r.fire(e,i)}};l.on({eventName:"beforeSave",type:u,listener:this},t.bind(f,this,"prepareChanges")).on({eventName:"afterSave",type:u,listener:this},t.bind(f,this,"applyChanges"));var c=e.context.configurator;i.when(this._getValue(l,{entityTypeName:u,entityId:d,fieldName:s}),c.getGlobalSettingsService().getGlobalSettings()).then(function(t,i){var o=a.detectEditorType(i,t,u);r.fire("dataBind",{value:n.fromSourceToHtml(t),editorType:o,pluginConfig:{uploadUrl:c.getApplicationPath()+"/UploadFile.ashx",formData:[{name:"generalId",value:d}]},rawDescription:t,placeholder:e.placeholder})})}});return o});