define(["require","Underscore","tau/utils/utils.date","./board.customize.units.interaction"],function(t){function e(t,e){return!i.isUndefined(e)&&t&&t.length>e?t.substr(0,e)+"&hellip;":t}function n(t,n){return["<a ",t?"":'href="'+i.escape(n.href)+'" ',!t&&n.title?'title="'+i.escape(n.title)+'" ':"",!t&&n.target?'target="'+n.target+'" ':"",'class="tau-board-unit-link tau-board-unit-not-selectable ',n.className||"",'" ',n.attributes||"",">",e(i.escape(n.text),n.maxTextLength),"</a>"].join("")}var i=t("Underscore"),a=t("tau/utils/utils.date"),s=t("./board.customize.units.interaction");return function(t,r){return{_:i,dateUtils:a,trim:e,formatDate:function(t,e){return i.isString(t)&&(t=a.convertToTimezone(t)),t?a.formatAs(t,e):""},formatDayShort:function(t){return i.isString(t)&&(t=a.convertToTimezone(t)),t?t.getDate():""},precise_round:function(t,e){var n=Math.pow(10,e);return Math.round(t*n)/n},formatTime:function(t,e){return t&&i.isNumber(t)&&!i.isNaN(t)?(t=this.precise_round(t,e),t.toString().replace(".",r.decimalSeparator)):"0"},unitClass:function(e){var n=["tau-board-unit"];return i.each(e.settings&&e.settings.classes||[],function(t){n.push("tau-board-unit_"+t)}),t.sections&&n.push("tau-board-unit_format_max"),e.settings&&e.settings.metaData&&e.settings.metaData.alignment&&n.push("tau-board-unit_alignment_"+e.settings.metaData.alignment),s.isUnitEditable(t,e)&&n.push("tau-board-unit--editable"),n.join(" ")},unitData:function(e){var n=[],a=e.settings&&e.settings.metaData;return a&&(a.title&&n.push('title="'+i.escape(this.replaceTermTags(a.title))+'"'),a.id&&n.push('data-unit-id="'+i.escape(a&&a.id)+'"'),a.alignment&&n.push('data-alignment="'+i.escape(a&&a.alignment)+'"'),t.sections&&(n.push('data-sections="'+t.sections+'"'),1==t.sections&&n.push('data-is-stretchable="'+(t.isStretchable!==!1)+'"'))),n.join(" ")},generateEntityLink:function(t,e,a,s){s=s||{};var r=t.settings&&t.settings.isDesignMode,u=r?"":t.configurator.getUrlBuilder().getNewViewUrl(e.id,a,!0);return i.defaults(s,{text:e.id,title:e.name,href:u,className:"tau-board-unit__value tau-related-id",attributes:'data-entity-id="'+e.id+'" data-entity-type="'+a+'" '}),s.className="tau-id "+(s.className||""),n(r,s)
},buildLink:function(t,e,i){if(e.cf&&e.cf.value){var a=n(t.settings&&t.settings.isDesignMode,{text:e.cf.value.label,title:i?e.cf.value.label:"",href:e.cf.value.uri,target:"_blank"});return i?a:this.trim(e.cf.name,10)+": "+a}return""},getUserText:function(t){return i.escape(i.trim(t.fullName)||t.email)},getPeopleOrdered:function(t){var e=t.users||[t.user],n="responsible",a="others",s=i.groupBy(e,function(e){return this.isResponsible(t,e)?n:a},this);return i.concat([s[n],s[a]])},programProgress:function(t){return 0===t.totalStoriesCount?0:(t.totalStoriesCount-t.openStoriesCount)/t.totalStoriesCount},isResponsible:function(t,e){return!t.currentStateResponsiblePersons||t.currentStateResponsiblePersons.indexOf(e.id)>=0}}}});