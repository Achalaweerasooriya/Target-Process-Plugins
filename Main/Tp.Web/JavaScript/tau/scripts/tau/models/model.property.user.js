define(["tau/models/model.property"],function(ModelBase){var initialDataProcessor=function(model){this.model=model};initialDataProcessor.prototype={onGetEntity:function(result){this.entity=result.data},done:function(){if(!this.model.config)return;var configurator=this.model.config.context.configurator,user=this.entity[this.model.config.propertyName];if(!user)return;var username=user.email,visibleName;if(user.firstName||user.lastName)username=_.trim([user.firstName,user.lastName].join(" "));visibleName=username,this.model.config.hidename&&(username="");var data={id:user.id,avatar:user.avatarUri+"24",name:username,visibleName:visibleName};this.model.fire("dataBind",data)}};var titleModel=ModelBase.extend({onInit:function(){var self=this;this.listenOfPropertyChanged();var ctx=self.config.context,typeName=ctx.entity.entityType.name,entityId=ctx.entity.id,processor=new initialDataProcessor(self),userField={},userPropertyName=this.config.propertyName;userField[userPropertyName]=["firstName","lastName","email","avatarUri"],self.store.get(typeName,{id:entityId,fields:["id",userField]},{scope:processor,success:processor.onGetEntity}).done({scope:processor,success:processor.done}),this.bindStoreListeners()},bindStoreListeners:function(){var self=this;self.store.on({eventName:"afterSave",type:"user",hasChanges:["avatarUri"],listener:self},function(){self.afterUserSaved.apply(self,arguments)})},afterUserSaved:function(command){this.fire("userAvatarChanged",command.data)},"bus dataBind:last+userAvatarChanged":function(evt,dataBind,userData){dataBind.id===userData.id&&this.fire("avatarChanged",userData)}});return titleModel})