define(["tau/core/model-base","Underscore"],function(a,_){var b=function(a){this.model=a};b.prototype={done:function(a){var b=a[0].data.entityState;this.model.fire("dataBind",b)}};var c=a.extend({onInit:function(){var a=this,c=new b(this),d=this.config.context,e=d.entity.entityType.name,f=d.entity.id,g=[{entityState:["id","name","isFinal","isCommentRequired",{nextStates:["id"]}]}],h=function(b){var c=b.data.changes,d=b.data.cmd.config.fields;b.data.cmd.config.fields=_.union(d,g),a.fire("beforeChanges",c),a.fire("beforeChangeProperty")},i=function(b){a.fire("applyChanges",b.data.changes),a.fire("propertyChanged")};a.store.unbind(a),a.store.on({eventName:"beforeSave",type:e,hasChanges:["entityState"],listener:this},h),a.store.on({eventName:"afterSave",type:e,hasChanges:["entityState"],listener:this},i),this.store.get(e,{id:f,fields:g},{success:c.setEntity,scope:c}).done({success:c.done,scope:c})}});return c})