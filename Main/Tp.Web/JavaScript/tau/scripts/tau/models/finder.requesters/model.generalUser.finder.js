define(["Underscore","tau/core/class","tau/core/model-base"],function(_,a,b){var c=a.extend({init:function(){this._collection=null,this._parameters=[],this._values={},this._fields=[],this._page=1,this._onPage=10,this._orderBy=null,this._orderDir="asc"},setFields:function(a){this._fields=a},setCollection:function(a){this._collection=a},registerParameters:function(a){this._parameters=_.toArray(a)},setParameter:function(a,b){if(_.indexOf(this._parameters,a)==-1)throw new Error('No "'+a+'" parameter for query');this._values[a]=b},setOnPage:function(a){this._onPage=a},setPage:function(a){this._page=a||1},setOrderBy:function(a){this._orderBy=a},setOrderDir:function(a){this._orderDir=a},create:function(){var a={};a.collection=this.createCollection();var b={};b.fields=this._fields,b.$query=this.createWhere();var c=this.createPaging();b.$skip=c.skip,b.$limit=c.limit;var d=this._orderDir=="asc"?"$orderBy":"$orderByDesc";return b[d]=this.createOrderBy(),a.request=b,a},createCollection:function(){return this._collection},createWhere:function(){var a={};return _.forEach(this._values,function(b,c){a[c]=b}),a},createOrderBy:function(){return this._orderBy||"id"},createPaging:function(){var a={limit:this._onPage,skip:0};return a.skip=(this._page-1)*this._onPage,a}}),d=c.extend({init:function(){this._super(),this.registerParameters(["name","email","type","projectId","companyId","action"])},createCollection:function(){var a=this._super();if(this._values.type){var b=this._values.type;b=="User"?a="User":b=="Requester"&&(a="Requester")}return this._values.companyId&&(a="Requester"),a},createWhere:function(){var a={};return this._values.type||(a.kind={$in:["User","Requester"]}),a.isActive=1,a.deleteDate={$isNull:!0},this._values["action"]=="reset"?a:(this._values.name!==undefined&&(a.lastName={$contains:this._values.name}),this._values.email!==undefined&&(a.email={$contains:this._values.email}),this._values.companyId&&this.createCollection()=="Requester"&&(a["company.id"]=this._values.companyId),a)}}),e=a.extend({init:function(a){this.items=a.data;var b=a.command,c=a.data.length;this.paging={start:b.config.$skip,end:b.config.$skip+c,count:c,hasNext:a.data.isNextPageAvailable()}}}),f=b.extend({"bus beforeInit":function(a){this.config=a.data.config;var b=this.config.store,c=this,e=this.config.actions||[];this.config.emptyDataMessage=this.config.emptyDataMessage||"No data found",b.get("company",{fields:["id","name"]}).done({success:function(a){c.fire("dataBind",{actions:e,result:null,filter:{companies:a[0].data}})}});var f=new d;f.setCollection("generalUser"),f.setOnPage(15),f.setFields(["id","firstName","lastName","email","login"]),f.setOrderBy("id"),f.setOrderDir("desc"),this.builder=f,c.fire("search.parametersBound",{parameters:{}})},"bus search.readyToExecute":function(a){var b=this.builder.create(),c=this;this.config.store.find(b.collection,b.request).done({success:function(a){var b=new e(a[0]);c.fire("search.completed",{result:b})}})},"bus search.completed":function(a){this.fire("result.ready",{data:{result:a.data.result}})},"bus search.parametersBound":function(a){var b=a.data.parameters,c=this.builder;_.forEach(b,function(a,b){a?c.setParameter(b,a):c.setParameter(b,undefined)}),c.setPage(0),this.fire("search.readyToExecute")},"bus search.pagingBound":function(a){var b=this.builder;b.setPage(b._page+1),this.fire("search.readyToExecute")},"bus search.orderBound":function(a){var b=this.builder;b.setOrderBy(a.data.value),b.setOrderDir(a.data.dir),b.setPage(1),this.fire("search.readyToExecute")}});return f})