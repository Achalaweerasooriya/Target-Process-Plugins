define(["Underscore","tau/core/class","tau/core/model-base"],function(_,Class,ModelBase){var QueryBuilder=Class.extend({init:function(){this._collection=null,this._parameters=[],this._values={},this._fields=[],this._page=1,this._onPage=10,this._orderBy=null,this._orderDir="asc"},setFields:function(fields){this._fields=fields},setCollection:function(value){this._collection=value},registerParameters:function(params){this._parameters=_.toArray(params)},setParameter:function(name,val){if(_.indexOf(this._parameters,name)==-1)throw new Error('No "'+name+'" parameter for query');this._values[name]=val},setOnPage:function(value){this._onPage=value},setPage:function(page){this._page=page||1},setOrderBy:function(value){this._orderBy=value},setOrderDir:function(value){this._orderDir=value},create:function(){var query={};query.collection=this.createCollection();var request={};request.fields=this._fields,request.$query=this.createWhere();var paging=this.createPaging();request.$skip=paging.skip,request.$limit=paging.limit;var orderBy=this._orderDir=="asc"?"$orderBy":"$orderByDesc";return request[orderBy]=this.createOrderBy(),query.request=request,query},createCollection:function(){return this._collection},createWhere:function(){var where={};return _.forEach(this._values,function(val,name){where[name]=val}),where},createOrderBy:function(){return this._orderBy||"id"},createPaging:function(){var paging={limit:this._onPage,skip:0};return paging.skip=(this._page-1)*this._onPage,paging}}),RequestersQueryBuilder=QueryBuilder.extend({init:function(){this._super(),this.registerParameters(["name","email","type","projectId","companyId","action"])},createCollection:function(){var collection=this._super();if(this._values.type){var val=this._values.type;val=="User"?collection="User":val=="Requester"&&(collection="Requester")}return this._values.companyId&&(collection="Requester"),collection},createWhere:function(){var where={};return this._values.type||(where.kind={$in:["User","Requester"]}),where.isActive=1,where.deleteDate={$isNull:!0},this._values["action"]=="reset"?where:(this._values.name!==undefined&&(where.lastName={$contains:this._values.name}),this._values.email!==undefined&&(where.email={$contains:this._values.email}),this._values.companyId&&this.createCollection()=="Requester"&&(where["company.id"]=this._values.companyId),where)}}),SearchResult=Class.extend({init:function(result){this.items=result.data;var command=result.command,length=result.data.length;this.paging={start:command.config.$skip,end:command.config.$skip+length,count:length,hasNext:result.data.isNextPageAvailable()}}}),model=ModelBase.extend({"bus beforeInit":function(evt){this.config=evt.data.config;var store=this.config.store,self=this,actions=this.config.actions||[];this.config.emptyDataMessage=this.config.emptyDataMessage||"No data found",store.get("company",{fields:["id","name"]}).done({success:function(results){self.fire("dataBind",{actions:actions,result:null,filter:{companies:results[0].data}})}});var builder=new RequestersQueryBuilder;builder.setCollection("generalUser"),builder.setOnPage(15),builder.setFields(["id","firstName","lastName","email","login"]),builder.setOrderBy("id"),builder.setOrderDir("desc"),this.builder=builder,self.fire("search.parametersBound",{parameters:{}})},"bus search.readyToExecute":function(evt){var query=this.builder.create(),self=this;this.config.store.find(query.collection,query.request).done({success:function(result){var searchResult=new SearchResult(result[0]);self.fire("search.completed",{result:searchResult})}})},"bus search.completed":function(evt){this.fire("result.ready",{data:{result:evt.data.result}})},"bus search.parametersBound":function(evt){var parameters=evt.data.parameters,builder=this.builder;_.forEach(parameters,function(val,name){val?builder.setParameter(name,val):builder.setParameter(name,undefined)}),builder.setPage(0),this.fire("search.readyToExecute")},"bus search.pagingBound":function(evt){var builder=this.builder;builder.setPage(builder._page+1),this.fire("search.readyToExecute")},"bus search.orderBound":function(evt){var builder=this.builder;builder.setOrderBy(evt.data.value),builder.setOrderDir(evt.data.dir),builder.setPage(1),this.fire("search.readyToExecute")}});return model})