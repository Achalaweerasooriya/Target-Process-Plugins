define(["Underscore","tau/core/model-base","tau/utils/utils.jsonSchema","tau/utils/utils.date"],function(t,e,a,r){var i=e.extend({category:"edit",name:"Model date validation","bus afterInit":function(){this.schema=a.Schema.create({type:"string",optional:this.config.allowReset,empty:this.config.allowReset,pre:function(e){return this.optional&&this.empty?t.isUndefined(e)?null:null!==e&&""===e?null:e:e},post:function(t){if(0==this.wasError()){var e=r.parse(t),a=r.parse(this.schema.additionalProperties.max),i=r.parse(this.schema.additionalProperties.min);null==e?new this.Error("Date","Incorrect date format"):e<new Date(1900,0,1)?new this.Error("Date","Date must be greater than 1-Jan-1900"):a&&e>a?new this.Error("Date","Date must be less than "+r.format.date.short(a)):i&&i>e?new this.Error("Date","Date must be greater than "+r.format.date.short(a)):t=r.formatAs(e,this.schema.additionalProperties.dateFormat)}return t},additionalProperties:{dateFormat:r.getFormatData().date.short,max:null,min:null}}),"datetime"==this.config.format&&(this.schema.additionalProperties.dateFormat=r.getFormatData().datetime.short)},"bus afterRender":function(t){this.element=t.data.element},"bus validateDate":function(t){var e=this.schema.validate(t.data.value);t.data.value=e.instance},"bus validate":function(t){this._getProperty().dateEditor("resetValidationErrors");var e=t.data,a=e.cmd.$set[this.config.propertyName];e.validation&&1==e.validation.isError()||(e.validation=this.schema.validate(a),e.cmd.$set[this.config.propertyName]=e.validation.instance)},"bus resetValidationErrors":function(){this._getProperty().dateEditor("resetValidationErrors")},"bus afterValidate":function(t){var e=t.data.validation;this._getProperty().dateEditor("setValue",e.instance)},"bus validationFailed":function(t){var e=t.data.validation;this._getProperty().dateEditor("setValidationErrors",e.errors[0].description)},_getProperty:function(){return this.element.find(".property")}});return i});