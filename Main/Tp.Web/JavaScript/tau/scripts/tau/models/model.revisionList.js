define(["Underscore","tau/core/model-base","tau/utils/utils.date"],function(e,i,t){return i.extend({retrieveRevisions:function(e){for(var i=this.store,t=["id","sourceControlId","description","commitDate",{author:["firstName","lastName"]},{revisionFiles:["id","fileName","fileAction"]}],s=0;s<e.length;s++)i=i.get(e[s].type,{id:e[s].id,nested:!0,fields:["id",{revisions:t}]});i.done({success:this.onRevisionsRetrieved,scope:this})},onInit:function(){var e=this,i=e.config.context.entity,t=i.entityType.name,s=i.id,n=[{type:t,id:s}],o=this.store;"userstory"==t.toLowerCase()?o.get(t,{id:s,fields:[{tasks:["id"]}]}).done({success:this.onTasksIdRetrieved,scope:this}):this.retrieveRevisions(n)},onTasksIdRetrieved:function(i){var t=i[0].data,s=[{type:t.__type,id:t.id}];s=s.concat(e.map(t.tasks,function(e){return{id:e.id,type:e.__type}})),this.retrieveRevisions(s)},onRevisionsRetrieved:function(i){var t=e.pluck(i,"data");t=e.pluck(t,"revisions"),t=e.flatten(t),this.bindRevisions(t)},bindRevisions:function(i){var s={Add:"Added",Delete:"Deleted",Modify:"Modified"};i=e.sortBy(i,function(e){return-e.id}),this.fire("dataBind",{items:e.map(i,function(i){var n=i.author||{firstName:"unknown",lastName:""},o=e.trim([n.firstName,n.lastName].join(" ")),r={commitDate:t.format.datetime.short(t.convertToTimezone(i.commitDate)),author:o,revisionFiles:e.map(i.revisionFiles,function(i){return e.extend(e.clone(i),{fileAction:s[i.fileAction]||i.fileAction})})};return e.extend(e.clone(i),r)})})},onEntityRetrieved:function(e){var i=e.data.revisions;this.bindRevisions(i)},"bus evictTestCases":function(){var e=this.config.context.entity;this.store.evictProperties(e.id,e.entityType.name,["testCases","testCases-count"])}})});