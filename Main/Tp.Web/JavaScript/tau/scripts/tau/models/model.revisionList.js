define(["Underscore","tau/core/model-base","tau/utils/utils.urlBuilder","tau/utils/utils.date","tau/utils/utils.htmlConverter"],function(_,a,b,c,d){return a.extend({retrieveRevisions:function(a){var b=this.store,c=["id","sourceControlId","description","commitDate",{author:["firstName","lastName"]},{revisionFiles:["id","fileName","fileAction"]}];for(var d=0;d<a.length;d++)b=b.get(a[d].type,{id:a[d].id,nested:!0,fields:["id",{revisions:c}]});b.done({success:this.onRevisionsRetrieved,scope:this})},onInit:function(){var a=this,b=a.config.context.entity,c=b.entityType.name,d=b.id,e=[{type:c,id:d}],f=this.store;c.toLowerCase()=="userstory"?f.get(c,{id:d,fields:[{tasks:["id"]}]}).done({success:this.onTasksIdRetrieved,scope:this}):this.retrieveRevisions(e)},onTasksIdRetrieved:function(a){var b=a[0].data,c=[{type:b.__type,id:b.id}];c=c.concat(_.map(b.tasks,function(a){return{id:a.id,type:a.__type}})),this.retrieveRevisions(c)},onRevisionsRetrieved:function(a){var b=_.pluck(a,"data");b=_.pluck(b,"revisions"),b=_.flatten(b),this.bindRevisions(b)},onRevisionIdsRetrieved:function(a){var b=_.clone(a[0].data.revisions);if(a.length>1){var c=_.pluck(a[1].data,"revisions");_.each(c,function(a){b=b.concat(a)})}var d=_.pluck(b,"id")},bindRevisions:function(a){var b={Add:"Added",Delete:"Deleted",Modify:"Modified"};a=_.sortBy(a,function(a){return-a.id}),this.fire("dataBind",{items:_.map(a,function(a){var d=a.author||{firstName:"unknown",lastName:""},e=[d.firstName,d.lastName].join(" ").trim(),f={commitDate:c.format.datetime.short(a.commitDate),author:e,revisionFiles:_.map(a.revisionFiles,function(a){return _.extend(_.clone(a),{fileAction:b[a.fileAction]})})};return _.extend(_.clone(a),f)})})},onEntityRetrieved:function(a){var b=a.data.revisions;this.bindRevisions(b)},"bus evictTestCases":function(){var a=this.config.context.entity;this.store.evictProperties(a.id,a.entityType.name,["testCases","testCases-count"])}})})