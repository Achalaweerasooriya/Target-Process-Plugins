define(["Underscore","tau/core/model-base","tau/utils/utils.date"],function(e,i,t){return i.extend({retrieveRevisions:function(e){for(var i=this.store,t=["id","sourceControlId","description","commitDate",{author:["firstName","lastName"]},{revisionFiles:["id","fileName","fileAction"]}],n=0;n<e.length;n++)i=i.get(e[n].type,{id:e[n].id,nested:!0,fields:["id",{revisions:t}]});i.done({success:this.onRevisionsRetrieved,scope:this})},onInit:function(){var e=this,i=e.config.context.entity,t=i.entityType.name,n=i.id,s=[{type:t,id:n}],o=this.store;"userstory"==t.toLowerCase()?o.get(t,{id:n,fields:[{tasks:["id"]}]}).done({success:this.onTasksIdRetrieved,scope:this}):this.retrieveRevisions(s)},onTasksIdRetrieved:function(i){var t=i[0].data,n=[{type:t.__type,id:t.id}];n=n.concat(e.map(t.tasks,function(e){return{id:e.id,type:e.__type}})),this.retrieveRevisions(n)},onRevisionsRetrieved:function(i){var t=e.pluck(i,"data");t=e.pluck(t,"revisions"),t=e.flatten(t),this.bindRevisions(t)},onRevisionIdsRetrieved:function(i){var t=e.clone(i[0].data.revisions);if(i.length>1){var n=e.pluck(i[1].data,"revisions");e.each(n,function(e){t=t.concat(e)})}e.pluck(t,"id")},bindRevisions:function(i){var n={Add:"Added",Delete:"Deleted",Modify:"Modified"};i=e.sortBy(i,function(e){return-e.id}),this.fire("dataBind",{items:e.map(i,function(i){var s=i.author||{firstName:"unknown",lastName:""},o=e.trim([s.firstName,s.lastName].join(" ")),r={commitDate:t.format.datetime.short(t.convertToTimezone(i.commitDate)),author:o,revisionFiles:e.map(i.revisionFiles,function(i){return e.extend(e.clone(i),{fileAction:n[i.fileAction]||i.fileAction})})};return e.extend(e.clone(i),r)})})},onEntityRetrieved:function(e){var i=e.data.revisions;this.bindRevisions(i)},"bus evictTestCases":function(){var e=this.config.context.entity;this.store.evictProperties(e.id,e.entityType.name,["testCases","testCases-count"])}})});