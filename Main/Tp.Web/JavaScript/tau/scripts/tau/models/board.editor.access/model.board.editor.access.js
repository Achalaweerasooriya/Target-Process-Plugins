define(["Underscore","jQuery","tau/core/model-base","tau/services/boards/service.views.menu.api.wrapper","tau/utils/utils.serverErrorTranslator"],function(e,t,i,r,n){return i.extend({"bus beforeInit":function(e){this._configurator=e.data.config.context.configurator,this.fire("configurator.ready",this._configurator)},_getTeams:function(){var e=t.Deferred();return this._configurator.getStore().get("team",{fields:["id","name","icon"]}).done(function(t){e.resolve(t[0].data)}),e},_getProjects:function(){var i=t.Deferred();return this._configurator.getStore().get("project",{fields:["id","name","color","isActive"]}).done(function(t){var r=e.filter(t[0].data,function(e){return e.isActive});i.resolve(r)}),i},_getBoardAccess:function(){return this._viewsMenuService.getViewMenuItem(this._viewMenuId).then(function(e){return this._getAccessData(e.data)}.bind(this))},_getAccessData:function(e){var t=this._configurator.getLoggedUser(),i=this._configurator.getBoardAccessService();return{isShared:e.isShared,isAdmin:t.isAdministrator,isOwner:i.isOwner(e,t),isEditable:i.isEditable(e,t),isView:"group"!==e.itemType,id:e.id||e.key,itemType:e.itemType,name:e.name,acid:e.acid,customSharedData:e.customSharedData||{isActive:!1,teamIds:[],projectIds:[]}}},_getEmailNotificationSettings:function(){var e=t.Deferred();return this._configurator.getGlobalSettingsService().getGlobalSettings({success:function(t){e.resolve(t.IsEmailNotificationsEnabled)},failure:function(){e.resolve(!1)}}),e},_loadData:function(){t.when(this._getTeams(),this._getProjects(),this._getBoardAccess(),this._getEmailNotificationSettings()).done(function(e,t,i,r){e=this._process(e,i.customSharedData.teamIds),t=this._process(t,i.customSharedData.projectIds),this.fire("dataBind",{access:i,teams:e,projects:t,canAddTeams:!1,canAddProjects:!1,checkedAllProject:t.length==i.customSharedData.projectIds.length,checkedAllTeam:e.length==i.customSharedData.teamIds.length,showSearch:!0,submitLabel:"Share",itemType:i.itemType,boardId:i.id,boardName:i.name,isEmailNotificationsEnabled:r&&i.isView,boardAcid:i.acid})
}.bind(this))},_process:function(t,i){var r=function(e){return(-1==e.id?"0":"1")+(e.selected?"0_":"1_")+e.name.toUpperCase()},n=t;return n=e.chain(n).map(function(t){return{id:t.id,name:t.name,icon:t.icon,color:t.color,selected:e.indexOf(i,t.id)>=0}}).sortBy(r).value()},"bus configurator.ready + boardSettings.ready:last":function(t,i,n){this._boardSettings=n.boardSettings,this._viewMenuId=this.config.context.viewMenuId||this._boardSettings.settings.id;var s=r.create(i.getViewsMenuService(),function(){return this._boardSettings}.bind(this));this._viewsMenuService=s.getApiForType(this.config.context.viewMenuType||"board"),this._loadData();var a=e.debounce(function(){this.fire("componentRefresh")}.bind(this),300);this._boardSettings.unbind({listener:this}),this._boardSettings.bind({fields:["name","acid","isShared","customSharedData"],listener:this,callback:a});var o=this._configurator.getStore();o.unbind(this),o.on({eventName:"afterSave",type:"team",listener:this},a),o.on({eventName:"afterRemove",type:"team",listener:this},a),o.on({eventName:"afterSave",type:"project",listener:this},a),o.on({eventName:"afterRemove",type:"project",listener:this},a)},"bus elementInsertedToContainer:last + componentRefresh":function(){this.fire("refresh")},"bus form.submitted":function(e,t){this._viewsMenuService.updateViewMenuItem(this._viewMenuId,t,{isShared:!1}).fail(function(e){var t=e.response?e.response.data.responseText:e.data.responseText;this.fire("error",n.translateServerError(t))}.bind(this))},"bus destroy":function(){this._boardSettings.unbind({listener:this}),this._super()}})});