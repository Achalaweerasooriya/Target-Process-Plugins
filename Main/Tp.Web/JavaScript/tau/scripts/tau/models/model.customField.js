define(["Underscore","tau/core/model-base","tau/configurator","tau/utils/utils.htmlConverter","tau/utils/utils.date"],function(a,b,c,d,e){var f={url:function(a,b){var c={label:"",url:""};return a&&(c.url=a.url||"",c.label=a.label||""),c},entity:function(a,b){var c={id:"",name:"",kind:""};return a&&(c.id=a.id,c.name=a.name||"",c.__type=c.kind=a.kind||""),c},date:function(a,b){var c={text:"",date:null};return a&&(c.date=e.parse(a),c.text=e.format.date.short(a)),c},richtext:function(a,b){return d.fromSourceToHtml(a)}},g=function(a){this.model=a};g.prototype={done:function(a){var b=a[0].data;this.fireAfterInit(b.customFields)},parseValue:function(a,b){b=b.toLowerCase();var c=this.model.config.context.applicationContext,d=f[b];return d?d(a,c):a},fireAfterInit:function(b){var c=this,d=this.model.config.customField||this.model.config.data,e={name:d.name,type:d.type,required:d.required,listed:d.listed,value:""},f=a(b).find(function(a){return a.name===d.name});e.type.toLowerCase()=="dropdown"&&(e.options=a.isArray(d.value)?d.value:(new String(d.value)).split("\r\n")),f&&(e.value=c.parseValue(f.value,d.type)),this.model.fieldInfo=e,this.model.fire("dataBind",e)}};var h=b.extend({TYPE_TEXT:"Text",TYPE_RICHTEXT:"RichText",TYPE_CHECKBOX:"CheckBox",TYPE_URL:"URL",TYPE_DATE:"Date",TYPE_NUMBER:"Number",fieldInfo:{},onInit:function(){var b=new g(this),c=this.config.context,d=c.entity.entityType.name,e=c.entity.id,f=c.applicationContext.processes[0].customFields;if(f&&f.length>0){var h={id:e,fields:["id","customFields"]},i=this;this.beforeSaveHandler||(this.beforeSaveHandler=a.bind(this._beforeSave,this),this.store.on({eventName:"beforeSave",type:d,listener:this},this.beforeSaveHandler)),this.afterSaveHandler||(this.afterSaveHandler=a.bind(this._afterSave,this),this.store.on({eventName:"afterSave",type:d,listener:this},this.afterSaveHandler)),this.store.get(d,h).done({success:b.done,scope:b})}else b.fireAfterInit([])},_beforeSave:function(b){var c=this;if(!b.data.changes.customFields)return;var d=b.data.cmd.config.fields;a.mergeFields(d,["customFields"]);var e=b.data.changes.customFields[0];e.value===""&&(e.value=null),e.name==c.fieldInfo.name&&c.bus.fire("preRefreshRow",{data:b.data.changes.customFields[0]})},_afterSave:function(a){var b=this;if(a.data.cmd.config.$set.customFields&&a.data.cmd.config.$set.customFields.length){var c=a.data.cmd.config.$set.customFields[0];c.name==b.fieldInfo.name&&b.bus.fire("refreshRow",c)}},destroy:function(){this.beforeSaveHandler=null,this.afterSaveHandler=null,this._super()}});return h})