define(["Underscore","tau/core/model-base","tau/configurator","tau/core/dates","tau/utils/utils.htmlConverter","libs/date.format"],function(a,b,c,d,e){var f={url:function(a,b){var c={label:"",url:""};a&&(c.url=a.url||"",c.label=a.label||"");return c},entity:function(a,b){var d={id:"",name:"",kind:"",url:""};a&&(d.id=a.id,d.name=a.name||"",d.kind=a.kind||"",d.url=[c.getApplicationPath(),"/View.aspx?id=",d.id].join(""));return d},date:function(a,b){var c={text:"",date:null};a&&(c.date=d.fromStringToDate(a),c.text=c.date.format(b.culture.shortDateFormat));return c},richtext:function(a,b){return e.fromSourceToHtml(a)}},g=function(a){this.model=a};g.prototype={done:function(a){var b=a[0].data;this.fireAfterInit(b.customFields)},parseValue:function(a,b){b=b.toLowerCase();var c=this.model.config.context.applicationContext,d=f[b];return d?d(a,c):a},fireAfterInit:function(b){var c=this,d=this.model.config.customField||this.model.config.data,e={name:d.name,type:d.type,required:d.required,listed:d.listed,value:""},f=a(b).find(function(a){return a.name===d.name});e.type.toLowerCase()=="dropdown"&&(e.options=a.isArray(d.value)?d.value:(new String(d.value)).split("\r\n")),f&&(e.value=c.parseValue(f.value,d.type)),this.model.fieldInfo=e,this.model.fire("dataBind",e)}};var h=b.extend({TYPE_TEXT:"Text",TYPE_RICHTEXT:"RichText",TYPE_CHECKBOX:"CheckBox",TYPE_URL:"URL",TYPE_DATE:"Date",TYPE_NUMBER:"Number",fieldInfo:{},onInit:function(){var b=new g(this),c=this.config.context,d=c.entity.entityType.name,e=c.entity.id,f=c.applicationContext.processes[0].customFields;if(f&&f.length>0){var h={id:e,fields:["id","customFields"]},i=this;this.store.on({eventName:"beforeSave",type:d,listener:this},function(b){if(!!b.data.changes.customFields){var c=b.data.cmd.config.fields;a.mergeFields(c,["customFields"]);var d=b.data.changes.customFields[0];d.value===""&&(d.value=null),d.name==i.fieldInfo.name&&i.bus.fire("preRefreshRow",{data:b.data.changes.customFields[0]})}}),this.store.on({eventName:"afterSave",type:d,listener:this},function(a){if(a.data.cmd.config.$set.customFields&&a.data.cmd.config.$set.customFields.length){var b=a.data.cmd.config.$set.customFields[0];b.name==i.fieldInfo.name&&i.bus.fire("refreshRow")}}),this.store.get(d,h).done({success:b.done,scope:b})}else b.fireAfterInit([])}});return h})