define(["Underscore","tau/core/model-base","tau/configurator","tau/utils/utils.htmlConverter","tau/utils/utils.date"],function(a,b,c,d,e){var f=b.extend({_process:function(b){var c={Date:function(a){return a.value=e.format.date.short(a.value),a.output=a.value,a},DropDown:function(b){return b.options=b.options.split("\r\n"),b.value=a.toString(b.value),b.output=a.toString(b.value),b},Entity:function(b){return b.value=b.value||{},b.value=a.defaults(b.value,{id:null,name:"",kind:null}),b.value.__type=b.value.kind,b.output=b.value.name+"",b},MultipleSelectionList:function(b){return b.options=a.toString(b.options).split("\r\n"),b.value=a.toString(b.value).split(","),b.output=b.value.join(", "),b},Number:function(a){return a.value=a.value?parseInt(a.value)+"":"",a.output=a.value,a},URL:function(b){return b.value=b.value||{},a.defaults(b.value,{url:"",title:""}),b.options=null,b}};return b.type in c&&(b=c[b.type](b)),b.type!="url",b},createConfiguration:function(b,c,d,e){var f=a.find(d,function(a){return a.type.toLowerCase()==b.type.toLowerCase()&&a.name==b.name}),g=a.find(e,function(a){return a.type.toLowerCase()==b.type.toLowerCase()&&a.name==b.name}),h={};if(f&&g)h={name:g.name,type:g.type,required:f.required,listed:f.listed,value:g.value,options:f.value,output:g.value},h=this._process(h);else if(f&&!g)h={name:f.name,type:f.type,required:f.required,listed:f.listed,value:null,options:f.value,output:null},h=this._process(h);else throw new Error("No valid configuration for field "+b.name);return h},"bus configurationProvided":function(b){var c=b.data;a.isEmpty(c)==0&&this.fire("dataBind",c),this.configuration=c},"bus beforeInit":function(a){var b=a.data.config,c=b.context.entity,d=b.context.getCustomFields(),e=b.customField||b.data,f=this,g={name:e.name,type:e.type};this.store.get(c.entityType.name,{id:c.id,fields:["id","customFields"]}).done({success:function(a){var b=a[0].data.customFields,e=f.createConfiguration(g,c,d,b);f.fire("configurationProvided",e)}})}});return f})