define(["Underscore","tau/core/model-base","tau/configurator","tau/utils/utils.htmlConverter","tau/utils/utils.date","tau/extensions/extension.underscore"],function(_,a,b,c,d){var e=a.extend({_process:function(a){var b={RichText:function(a){return a.value=c.fromSourceToHtml(a.value),a},Date:function(a){return a.value=d.format.date.short(d.convertToTimezone(a.value)),a.output=a.value,a},DropDown:function(a){return a.options=a.options?_.asString(a.options).split("\r\n"):[],a.value=_.asString(a.value),a.output=_.asString(a.value),a},Entity:function(a){return a.value=a.value||{},a.value=_.defaults(a.value,{id:null,name:"",kind:null}),a.value.__type=a.value.kind,a.output=a.value.name+"",a},MultipleSelectionList:function(a){return a.options=a.options?_.asString(a.options).split("\r\n"):[],a.value?(a.value=_.asString(a.value).split(","),a.output=a.value.join(", ")):(a.value=null,a.output=""),a},Number:function(a){return a.value=a.value?parseInt(a.value)+"":"",a.output=a.value,a},URL:function(a){return a.value=a.value||{},_.defaults(a.value,{url:"",title:""}),a.options=null,a}};return a.type in b&&(a=b[a.type](a)),a.type!="url",a},createConfiguration:function(a,b,c,d){var e=_.find(c,function(b){return b.type.toLowerCase()==a.type.toLowerCase()&&b.name==a.name}),f=_.find(d,function(b){return b.type.toLowerCase()==a.type.toLowerCase()&&b.name==a.name}),g={};if(e&&f)g={name:f.name,type:f.type,required:e.required,listed:e.listed,value:f.value,options:e.value,output:f.value},g=this._process(g);else if(e&&!f)g={name:e.name,type:e.type,required:e.required,listed:e.listed,value:null,options:e.value,output:null},g=this._process(g);else throw new Error("No valid configuration for field "+a.name);return g},"bus configurationProvided":function(a){var b=a.data;_.isEmpty(b)==0&&this.fire("dataBind",b),this.configuration=b},"bus beforeInit":function(a){var b=a.data.config;this.store=b.store?b.store:this.store;var c=b.context.entity,d=b.context.getCustomFields(),e=b.customField||b.data,f=this,g={name:e.name,type:e.type};this.store.get(c.entityType.name,{id:c.id,fields:["id","customFields"]}).done({success:function(a){var b=a[0].data.customFields,e=f.createConfiguration(g,c,d,b);f.fire("configurationProvided",e)}})}});return e})