define(["Underscore","tau/core/model-base","tau/utils/utils.date","tau/utils/utils.convertUserName"],function(t,e,i,n){function s(t){return{id:t,fields:["id","name",{times:["id","date","spent","remain","description",{assignable:["id"]},{user:["id","firstName","lastName"]}]}]}}function a(t){return{id:t,fields:["id",{tasks:["id","name",{times:["id","date","spent","remain","description",{assignable:["id"]},{user:["id","firstName","lastName"]}]}]}],list:!0,nested:!0}}var r=function(t){this.times=[],this.urlBuilder=t};return r.prototype={addAssignable:function(t){this.assignable=t,this._addEntityTimes(this.assignable)},addTasks:function(e){t.each(e,function(t){t.__type="task"});for(var i=0;i<e.length;i++)this._addEntityTimes(e[i])},_parseDate:function(e){return e=t.clone(e),e.date=i.parse(e.date),e},getTimesSortedByDate:function(){var e=t.map(this.times,this._parseDate,this);return e.sort(function(t,e){return e.date-t.date||e.id-t.id}),e},getTimes:function(){return t.map(this.getTimesSortedByDate(),this.convertServerDataModelData,this)},convertServerDataModelData:function(t){return{id:t.id,date:i.format.date.short(i.convertToTimezone(t.date)),spent:t.spent,remain:t.remain,description:t.description,person:n.getFullName(t.user),workOn:{__type:t.workOn.__type,name:t.workOn.name},editUrl:this.urlBuilder.getEditUrl(t.id,"time")}},_addEntityTimes:function(e){for(var i=e.times,n=0;n<i.length;n++){var s=t.clone(i[n]);s.workOn=e,this.times.push(s)}}},e.extend({isUserStory:function(t){return"userstory"==t.toLowerCase()},onInit:function(){var e=this.config.context,i=new r(e.configurator.getUrlBuilder()),n=e.entity,o=n.entityType.name,d=s(n.id),u=this.isUserStory(o),c=this.store;if(c=c.get(o,d,{success:this.safeCallback(function(t){this.assignable=t.data,i.addAssignable(this.assignable)})}),u){var f=a(n.id);c=c.get(o,f,{success:this.safeCallback(function(t){i.addTasks(t.data.tasks)})})}c.done({success:this.safeCallback(function(){var n={edit:!0},s=i.getTimes(),a=e.configurator.getFeaturesService().isEnabled("tp3.only");
a&&(n.edit=!1,t.each(s,function(t){t.editUrl=null})),this.fire("dataBind",{access:n,items:s})})})},"bus beforeInit":function(e,i){var n=i.config.context,s=n.configurator.getStore();s.unbind(this),s.on({type:n.entity.entityType.name,eventName:"afterSave",listener:this},t.bind(this.fire,this,"refresh"))},"bus beforeInit + destroy":function(t,e){var i=e.config.context.configurator;i.getStore().unbind(this)}})});