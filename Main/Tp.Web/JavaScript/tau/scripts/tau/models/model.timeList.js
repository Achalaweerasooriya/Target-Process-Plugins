define(["Underscore","tau/core/model-base","tau/utils/utils.date","tau/utils/utils.urlBuilder"],function(_,a,b,c){function d(a){return{id:a,fields:["id","name",{times:["id","date","spent","remain","description",{assignable:["id"]},{user:["id","firstName","lastName"]}]}]}}function e(a){var b={id:a,fields:["id",{tasks:["id","name",{times:["id","date","spent","remain","description",{assignable:["id"]},{user:["id","firstName","lastName"]}]}]}],list:!0,nested:!0};return b}function f(a){this.model=a,this.times=[]}f.prototype={getAssignableRetrievedCallback:function(){return{scope:this,success:this.onAssignableRetrieved}},getTaskRetrievedCallbackInfo:function(){return{scope:this,success:this.onTasksRetrieved}},getAllTasksRetrievedCallbackInfo:function(){return{scope:this,success:this.onAllTasksRetrieved}},onAssignableRetrieved:function(a){this.assignable=this.model.assignable=a.data;var b=this.model.assignable,c=b.times;this._addTimesToTimeArray(c,this.assignable)},onTasksRetrieved:function(a){_(a.data.tasks).each(function(a){a.__type="task"});var b=a.data.tasks;for(var c=0;c<b.length;c++)this._addTimesToTimeArray(b[c].times,b[c])},onAllTasksRetrieved:function(){var a={items:this.getTimes()};this.model.bus.fire("dataBind",a)},getTimesSortedByDate:function(){var a=[],c=this.times.length;for(var d=0;d<c;d++){var e=_(this.times[d]).clone();e.date=b.parse(e.date),a.push(e)}return a.sort(function(a,b){var c=b.date-a.date;return c!=0?c:b.id-a.id}),a},getTimes:function(){var a=[],b=this.getTimesSortedByDate(),c=b.length;for(var d=0;d<c;d++)a.push(this.convertServerDataModelData(b[d]));return a},convertServerDataModelData:function(a){var d=a.user;return{id:a.id,date:b.format.date.short(b.convertToTimezone(a.date)),spent:a.spent,remain:a.remain,description:a.description,person:[d.firstName,d.lastName].join(" "),workOn:{__type:a.workOn.__type,name:a.workOn.name},editUrl:c.getEditUrl(a.id,"time")}},_addTimesToTimeArray:function(a,b){var c=[];for(var d=0;d<a.length;d++){var e=_(a[d]).clone();e.workOn=b,c.push(e)}this.times=this.times.concat(c)}};var g=a.extend({isUserStory:function(a){return a.toLowerCase()=="userstory"},onInit:function(){var a=new f(this),b=this.config.context.entity,c=b.id,g=b.entityType.name,h=d(c),i=this.isUserStory(g),j=this.store;j=j.get(g,h,a.getAssignableRetrievedCallback());if(i){var k=e(c);j=j.get(g,k,a.getTaskRetrievedCallbackInfo())}j.done(a.getAllTasksRetrievedCallbackInfo())}});return g})