define(["Underscore","tau/core/termProcessor"],function(_,a){var b=function(a,b,c){return _.each(c,function(c){c in b&&(a[c]=b[c])}),a},c=function(a){this._historyItems=a};c.enhance=function(a){return(new this(a)).enhance()},c.prototype={constructor:c,enhance:function(){var a=this._historyItems;return a=this._addDateSpan(a),a},_addDateSpan:function(a){var b=this._createItemStateGroups(a);return _.each(b,function(a){var b=_.first(a).state;b.dateSpan=a.length}),a},_createItemStateGroups:function(a){var b=[],c=null,d=null;return _.each(a,function(a){c!=a.state.name&&(c=a.state.name,d&&b.push(d),d=[]),d.push(a)}),b.push(d),b}};var d=function(a){this._historyItems=a};d.compress=function(a){return(new this(a)).compress()},d.prototype={constructor:d,compress:function(){var a=this._historyItems;return a=this._compressAssignments(a),a=this._compressStates(a),a},_compressStates:function(a){var b=_.select(a,function(b,c){var d=!0;return this._isItemStateNeedsCompression(b.state)&&this._isItemNeedsCompression(b,c,a)&&(d=!1),d},this);return b},_isItemStateNeedsCompression:function(a){return a.isInitial||a.isFinal},_isItemNeedsCompression:function(a,b,c){var d=!1,e=c[b-1],f=!e;if(!f){var g=e.state.name!=a.state.name,h=a.transitions>1,i=a.assignments,j=a.relatedEntities,k=a.spentTime>0;g||!h&&!i&&!j&&!k&&(d=!0)}return d},_compressAssignments:function(a){return this._clearDublicatedAssignmentsForState(a),this._mergeIdenticalAssignmentsForItem(a),a},_clearDublicatedAssignmentsForState:function(a){var b=_.select(a,function(b,c){var d=!1;if(b.assignments){var e=a[c-1];e&&e.state.name==b.state.name&&this._areAssignmentsTheSame(e.assignments,b.assignments)&&(d=!0)}return d},this);_.each(b,function(a){delete a.assignments})},_mergeIdenticalAssignmentsForItem:function(a){_.each(a,function(a){if(a.assignments){var b=[],c={};_.each(a.assignments,function(a){a.id in c?c[a.id].roles.push(a.role):(c[a.id]=a,a.roles=[a.role],delete a.role,b.push(a))}),a.assignments=b}})},_areAssignmentsTheSame:function(a,b){var c=_.pluck(a,"id").join(""),d=_.pluck(b,"id").join("");return c==d}};var e=function(b){this._inputData=b,this._termProcessor=new a(b.terms)};return e.transform=function(a){return(new this(a)).transform()},e.prototype={constructor:e,transform:function(){var a={entityStates:this._getEntityStateNames(),historyItems:this._getHistoryItems()};return a},_getHistoryEntries:function(){return this._inputData.response[0].data.statistics.entries},_getAllEntityStatesForProcess:function(){return this._inputData.response[1].data.entityStates},_getAllUsers:function(){return this._inputData.response[2].data},_getAllRoles:function(){return this._inputData.response[3].data},_getEntityStateNames:function(){var a=this._getEntityStates(),b=this._sortEntityStates(a),c=_.map(b,function(a){return a.name});return c},_getEntityStates:function(){var a=this._inputData.entityTypeName,b=_.select(this._getAllEntityStatesForProcess(),function(b){return a.toLowerCase()==b.entityType.name.toLowerCase()});return b},_sortEntityStates:function(a){var b=_.sortBy(a,function(a){var b=a.numericPriority;return a.isInitial?b=Number.NEGATIVE_INFINITY:a.isFinal&&(b=Number.POSITIVE_INFINITY),b}).reverse();return b},_getHistoryItems:function(){var a=[];return _.each(this._getHistoryEntries(),function(b){a.push(this._createHistoryItem(b))},this),a=this._sortHistoryItems(a),a=this._enhanceHistoryItems(a),a=this._compressHistoryItems(a),a},_createHistoryItem:function(a){var b={date:new Date(Date.parse(a.date)),spentTime:parseFloat(a.time),transitions:parseFloat(a.transitions),state:this._getHistoryEntryState(a)},c=this._getHistoryEntryRelatedEntities(a);return _.isEmpty(c)||(b.relatedEntities=c),a.assignments&&(b.assignments=this._getHistoryEntryAssignments(a)),b},_getHistoryEntryState:function(a){var c=this._getEntityStateInfo(a.stateId),d=b({},c,["name","isInitial","isFinal"]);return c.role&&(d.roleId=c.role.id),d},_getEntityStateInfo:function(a){var b=_.detect(this._getAllEntityStatesForProcess(),function(b){return a==b.id});return b},_getHistoryEntryRelatedEntities:function(a){var c=b({},a,["opened","closed"]);return this._setEntityAlias(c.opened),this._setEntityAlias(c.closed),c},_setEntityAlias:function(a){_.each(a,function(a){var b=this._getEntityAlias(a.type);b&&(a.alias=b)},this)},_getEntityAlias:function(a){var b=this._termProcessor.getTerms(a);return b?b.name:null},_getHistoryEntryAssignments:function(a){var b=[];return _.each(a.assignments,function(a){var c=this._getUserInfo(a.userId);c&&b.push({id:a.userId,firstName:c.firstName,lastName:c.lastName,role:{id:parseInt(a.roleId),name:this._roleIdToName(a.roleId)}})},this),b},_getUserInfo:function(a){var c=null,d=_.detect(this._getAllUsers(),function(b){return a==b.id});return d&&(c=b({},d,["firstName","lastName"])),c},_roleIdToName:function(a){var b=_.detect(this._getAllRoles(),function(b){return a==b.id});return b.name},_sortHistoryItems:function(a){return _.sortBy(a,function(a){return new Date(Date.parse(a.date))})},_enhanceHistoryItems:function(a){return c.enhance(a)},_compressHistoryItems:function(a){return d.compress(a)}},e})