define(["Underscore","tau/core/termProcessor","tau/utils/utils.date/utils.date.wrapper"],function(_,TermProcessor,Date){var extend=function(destination,source,propertyNameList){return _.each(propertyNameList,function(propertyName){propertyName in source&&(destination[propertyName]=source[propertyName])}),destination},HistoryItemsEnhancer=function(historyItems){this._historyItems=historyItems};HistoryItemsEnhancer.enhance=function(historyItems){return(new this(historyItems)).enhance()},HistoryItemsEnhancer.prototype={constructor:HistoryItemsEnhancer,enhance:function(){var _historyItems=this._historyItems;return _historyItems=this._addDateSpan(_historyItems),_historyItems},_addDateSpan:function(historyItems){var itemStateGroups=this._createItemStateGroups(historyItems);return _.each(itemStateGroups,function(stateGroup){var headItemState=_.first(stateGroup).state;headItemState.dateSpan=stateGroup.length}),historyItems},_createItemStateGroups:function(historyItems){var itemStateGroups=[],currentStateName=null,stateGroup=null;return _.each(historyItems,function(item){currentStateName!=item.state.name&&(currentStateName=item.state.name,stateGroup&&itemStateGroups.push(stateGroup),stateGroup=[]),stateGroup.push(item)}),itemStateGroups.push(stateGroup),itemStateGroups}};var HistoryItemsCompressor=function(historyItems){this._historyItems=historyItems};HistoryItemsCompressor.compress=function(historyItems){return(new this(historyItems)).compress()},HistoryItemsCompressor.prototype={constructor:HistoryItemsCompressor,compress:function(){var _historyItems=this._historyItems;return _historyItems=this._compressAssignments(_historyItems),_historyItems=this._compressStates(_historyItems),_historyItems},_compressStates:function(historyItems){var _historyItems=_.select(historyItems,function(item,index){var selector=!0;return this._isItemStateNeedsCompression(item.state)&&this._isItemNeedsCompression(item,index,historyItems)&&(selector=!1),selector},this);return _historyItems},_isItemStateNeedsCompression:function(itemState){return itemState.isInitial||itemState.isFinal||itemState.isPlanned},_isItemNeedsCompression:function(item,index,historyItems){var itemNeedsCompression=!1,prevItem=historyItems[index-1],isItemFirst=!prevItem;if(!isItemFirst){var isItemInNewState=prevItem.state.name!=item.state.name,isItemHasMultipleTransitions=item.transitions>1,isItemHasAssignments=item.assignments,isItemHasRelatedEntities=item.relatedEntities,isItemHasTimeReported=item.spentTime>0;isItemInNewState||!isItemHasMultipleTransitions&&!isItemHasAssignments&&!isItemHasRelatedEntities&&!isItemHasTimeReported&&(itemNeedsCompression=!0)}return itemNeedsCompression},_compressAssignments:function(historyItems){return this._clearDublicatedAssignmentsForState(historyItems),this._mergeIdenticalAssignmentsForItem(historyItems),historyItems},_clearDublicatedAssignmentsForState:function(historyItems){var historyItemsWithExtraAssignments=_.select(historyItems,function(item,index){var selector=!1;if(item.assignments){var prevItem=historyItems[index-1];prevItem&&prevItem.state.name==item.state.name&&this._areAssignmentsTheSame(prevItem.assignments,item.assignments)&&(selector=!0)}return selector},this);_.each(historyItemsWithExtraAssignments,function(item){delete item.assignments})},_mergeIdenticalAssignmentsForItem:function(historyItems){_.each(historyItems,function(item){if(item.assignments){var mergedAssignments=[],map={};_.each(item.assignments,function(assignment){assignment.id in map?map[assignment.id].roles.push(assignment.role):(map[assignment.id]=assignment,assignment.roles=[assignment.role],delete assignment.role,mergedAssignments.push(assignment))}),item.assignments=mergedAssignments}})},_areAssignmentsTheSame:function(assignmentsA,assignmentsB){var assignmentsAIds=_.pluck(assignmentsA,"id").join(""),assignmentsBIds=_.pluck(assignmentsB,"id").join("");return assignmentsAIds==assignmentsBIds}};var ImplementationHistoryDataProcessor=function(inputData){this._inputData=inputData,this._termProcessor=new TermProcessor(inputData.terms)};return ImplementationHistoryDataProcessor.transform=function(inputData){return(new this(inputData)).transform()},ImplementationHistoryDataProcessor.prototype={constructor:ImplementationHistoryDataProcessor,transform:function(){var data={entityStates:this._getEntityStateNames(),historyItems:this._getHistoryItems(),leadTime:this._getLeadTime(),cycleTime:this._getCycleTime()};return data},_getLeadTime:function(){return this._inputData.leadTime},_getCycleTime:function(){return this._inputData.cycleTime},_getHistoryEntries:function(){return this._inputData.response[0].data.statistics.entries},_getAllEntityStatesForProcess:function(){return this._inputData.response[1].data.entityStates},_getAllUsers:function(){return this._inputData.response[2].data},_getAllRoles:function(){return this._inputData.response[3].data},_getEntityStateNames:function(){var entityStates=this._getEntityStates(),sortedEntityStates=this._sortEntityStates(entityStates),entityStateNames=_.map(sortedEntityStates,function(entityState){return entityState.name});return entityStateNames},_getEntityStates:function(){var currentEntityTypeName=this._inputData.entityTypeName,entityStates=_.select(this._getAllEntityStatesForProcess(),function(entityState){return currentEntityTypeName.toLowerCase()==entityState.entityType.name.toLowerCase()});return entityStates},_sortEntityStates:function(entityStates){var sortedEntityStates=_.sortBy(entityStates,function(entityState){var sortRank=entityState.numericPriority;return entityState.isInitial?sortRank=Number.NEGATIVE_INFINITY:entityState.isFinal&&(sortRank=Number.POSITIVE_INFINITY),sortRank}).reverse();return sortedEntityStates},_getHistoryItems:function(){var historyItems=[];return _.each(this._getHistoryEntries(),function(historyEntry){historyItems.push(this._createHistoryItem(historyEntry))},this),historyItems=this._sortHistoryItems(historyItems),historyItems=this._enhanceHistoryItems(historyItems),historyItems=this._compressHistoryItems(historyItems),historyItems},_createHistoryItem:function(historyEntry){var historyItem={date:new Date(Date.parse(historyEntry.date)),spentTime:parseFloat(historyEntry.time),transitions:parseFloat(historyEntry.transitions),state:this._getHistoryEntryState(historyEntry)},relatedEntities=this._getHistoryEntryRelatedEntities(historyEntry);return _.isEmpty(relatedEntities)||(historyItem.relatedEntities=relatedEntities),historyEntry.assignments&&(historyItem.assignments=this._getHistoryEntryAssignments(historyEntry)),historyItem},_getHistoryEntryState:function(historyEntry){var stateInfo=this._getEntityStateInfo(historyEntry.stateId),state=extend({},stateInfo,["name","isInitial","isFinal","isPlanned"]);return stateInfo.role&&(state.roleId=stateInfo.role.id),state},_getEntityStateInfo:function(entityStateId){var entityStateInfo=_.detect(this._getAllEntityStatesForProcess(),function(entityState){return entityStateId==entityState.id});return entityStateInfo},_getHistoryEntryRelatedEntities:function(historyEntry){var entities=extend({},historyEntry,["opened","closed"]);return this._setEntityAlias(entities.opened),this._setEntityAlias(entities.closed),entities},_setEntityAlias:function(entities){_.each(entities,function(entity){var alias=this._getEntityAlias(entity.type);alias&&(entity.alias=alias)},this)},_getEntityAlias:function(entityType){var terms=this._termProcessor.getTerms(entityType);return terms?terms.name:null},_getHistoryEntryAssignments:function(historyEntry){var assignments=[];return _.each(historyEntry.assignments,function(assignment){var userInfo=this._getUserInfo(assignment.userId);userInfo&&assignments.push({id:assignment.userId,firstName:userInfo.firstName,lastName:userInfo.lastName,role:{id:parseInt(assignment.roleId),name:this._roleIdToName(assignment.roleId)}})},this),assignments},_getUserInfo:function(id){var userInfo=null,user=_.detect(this._getAllUsers(),function(user){return id==user.id});return user&&(userInfo=extend({},user,["firstName","lastName"])),userInfo},_roleIdToName:function(id){var role=_.detect(this._getAllRoles(),function(role){return id==role.id});return role.name},_sortHistoryItems:function(historyItems){return _.sortBy(historyItems,function(item){return new Date(Date.parse(item.date))})},_enhanceHistoryItems:function(historyItems){return HistoryItemsEnhancer.enhance(historyItems)},_compressHistoryItems:function(historyItems){return HistoryItemsCompressor.compress(historyItems)}},ImplementationHistoryDataProcessor})