define(["Underscore","tau/core/termProcessor","tau/utils/utils.date/utils.date.wrapper"],function(t,e,n){var s=function(e,n,s){return t.each(s,function(t){t in n&&(e[t]=n[t])}),e},i=function(t){this._historyItems=t};i.enhance=function(t){return new this(t).enhance()},i.prototype={constructor:i,enhance:function(){var t=this._historyItems;return t=this._addDateSpan(t)},_addDateSpan:function(e){var n=this._createItemStateGroups(e);return t.each(n,function(e){var n=t.first(e).state;n.dateSpan=e.length}),e},_createItemStateGroups:function(e){var n=[],s=null,i=null;return t.each(e,function(t){s!=t.state.name&&(s=t.state.name,i&&n.push(i),i=[]),i.push(t)}),n.push(i),n}};var r=function(t){this._historyItems=t};r.compress=function(t){return new this(t).compress()},r.prototype={constructor:r,compress:function(){var t=this._historyItems;return t=this._compressAssignments(t),t=this._compressStates(t)},_compressStates:function(e){var n=t.select(e,function(t,n){var s=!0;return this._isItemStateNeedsCompression(t.state)&&this._isItemNeedsCompression(t,n,e)&&(s=!1),s},this);return n},_isItemStateNeedsCompression:function(t){return t.isInitial||t.isFinal||t.isPlanned},_isItemNeedsCompression:function(t,e,n){var s=!1,i=n[e-1],r=!i;if(!r){var a=i.state.name!=t.state.name,o=t.transitions>1,u=t.assignments,c=t.relatedEntities,m=t.spentTime>0;a||o||u||c||m||(s=!0)}return s},_compressAssignments:function(t){return this._clearDublicatedAssignmentsForState(t),this._mergeIdenticalAssignmentsForItem(t),t},_clearDublicatedAssignmentsForState:function(e){var n=t.select(e,function(t,n){var s=!1;if(t.assignments){var i=e[n-1];i&&i.state.name==t.state.name&&this._areAssignmentsTheSame(i.assignments,t.assignments)&&(s=!0)}return s},this);t.each(n,function(t){delete t.assignments})},_mergeIdenticalAssignmentsForItem:function(e){t.each(e,function(e){if(e.assignments){var n=[],s={};t.each(e.assignments,function(t){t.id in s?s[t.id].roles.push(t.role):(s[t.id]=t,t.roles=[t.role],delete t.role,n.push(t))
}),e.assignments=n}})},_areAssignmentsTheSame:function(e,n){var s=t.pluck(e,"id").join(""),i=t.pluck(n,"id").join("");return s==i}};var a=function(t){this._inputData=t,this._termProcessor=new e(t.terms)};return a.transform=function(t){return new this(t).transform()},a.prototype={constructor:a,transform:function(){var t={entityStates:this._getEntityStateNames(),historyItems:this._getHistoryItems(),leadTime:this._getLeadTime(),cycleTime:this._getCycleTime()};return t},_getLeadTime:function(){return this._inputData.leadTime},_getCycleTime:function(){return this._inputData.cycleTime},_getHistoryEntries:function(){return this._inputData.response[0].data.statistics.entries},_getAllEntityStatesForProcess:function(){return this._inputData.response[1].data.entityStates},_getAllUsers:function(){return this._inputData.response[2].data},_getAllRoles:function(){return this._inputData.response[3].data},_getEntityStateNames:function(){var e=this._getEntityStates(),n=this._sortEntityStates(e),s=t.map(n,function(t){return t.name});return s},_getEntityStates:function(){var e=this._inputData.entityTypeName.toLowerCase(),n=t.select(this._getAllEntityStatesForProcess(),function(t){return e.toLowerCase()==t.entityType.name.toLowerCase()});return n},_sortEntityStates:function(e){var n=t.sortBy(e,function(t){var e=t.numericPriority;return t.isInitial?e=Number.NEGATIVE_INFINITY:t.isFinal&&(e=Number.POSITIVE_INFINITY),e}).reverse();return n},_getHistoryItems:function(){var e=[];return t.each(this._getHistoryEntries(),function(t){e.push(this._createHistoryItem(t))},this),e=this._sortHistoryItems(e),e=this._enhanceHistoryItems(e),e=this._compressHistoryItems(e)},_createHistoryItem:function(e){var s={date:new n(n.parse(e.date)),spentTime:parseFloat(e.time),transitions:parseFloat(e.transitions),state:this._getHistoryEntryState(e)},i=this._getHistoryEntryRelatedEntities(e);return t.isEmpty(i)||(s.relatedEntities=i),e.assignments&&(s.assignments=this._getHistoryEntryAssignments(e)),s},_getHistoryEntryState:function(t){var e=this._getEntityStateInfo(t.stateId),n=s({},e,["name","isInitial","isFinal","isPlanned"]);
return e.role&&(n.roleId=e.role.id),n},_getEntityStateInfo:function(e){var n=t.detect(this._getAllEntityStatesForProcess(),function(t){return e==t.id});return n},_getHistoryEntryRelatedEntities:function(t){var e=s({},t,["opened","closed"]);return this._setEntityAlias(e.opened),this._setEntityAlias(e.closed),e},_setEntityAlias:function(e){t.each(e,function(t){var e=this._getEntityAlias(t.type);e&&(t.alias=e)},this)},_getEntityAlias:function(t){var e=this._termProcessor.getTerms(t);return e?e.name:null},_getHistoryEntryAssignments:function(e){var n=[];return t.each(e.assignments,function(t){var e=this._getUserInfo(t.userId);e&&n.push({id:t.userId,firstName:e.firstName,lastName:e.lastName,role:{id:parseInt(t.roleId),name:this._roleIdToName(t.roleId)}})},this),n},_getUserInfo:function(e){var n=null,i=t.detect(this._getAllUsers(),function(t){return e==t.id});return i&&(n=s({},i,["firstName","lastName"])),n},_roleIdToName:function(e){var n=t.detect(this._getAllRoles(),function(t){return e==t.id});return n.name},_sortHistoryItems:function(e){return t.sortBy(e,function(t){return new n(n.parse(t.date))})},_enhanceHistoryItems:function(t){return i.enhance(t)},_compressHistoryItems:function(t){return r.compress(t)}},a});