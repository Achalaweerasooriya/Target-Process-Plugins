define(["Underscore","jQuery","tau/core/extension.base"],function(_,$,BaseModel){return BaseModel.extend({"bus beforeInit:last + dataBind:last + model.add.item":function(evt,initConfig,dataItems,addItemData){var configurator=initConfig.config.context.configurator,entity=initConfig.config.context.entity,options=initConfig.config.options,dataItem=dataItems.types[addItemData.type];entity.entityType.name=="release"&&dataItem.entityType.name.toLowerCase()=="iteration"&&addItemData.fields.push({id:"release",value:entity.id});var params=_.extend({entityType:addItemData.type,values:addItemData.fields},dataItem.coordinates);dataItem.slice[dataItem.saveAction]({$set:params}).done(_.bind(function(result){var savedEntity=result.data,optionItem=_.find(options.items,function(v){return v.entityType.toLowerCase()==savedEntity.type.toLowerCase()}),relationName=optionItem.relationName;if(relationName){var set={};set[relationName]=[{id:savedEntity.id}],configurator.getStore().save(entity.entityType.name,{id:entity.id,$set:set,fields:["id",relationName]}).done(function(){configurator.getStore().evictProperties(entity.id,entity.entityType.name,[relationName]);var str=savedEntity.type,typeCorrect=str.charAt(0).toLowerCase()+str.substring(1);configurator.getGlobalBus().fire(typeCorrect+".items.added",{entity:{id:savedEntity.id}})})}this.fire("model.data.item.did.add",{message:{dataItem:{data:savedEntity}},nameType:dataItem.entityType})},this)).fail(_.bind(function(result){return this.fire("model.data.item.did.fail.add",result.data.responseText),!1},this))}})})