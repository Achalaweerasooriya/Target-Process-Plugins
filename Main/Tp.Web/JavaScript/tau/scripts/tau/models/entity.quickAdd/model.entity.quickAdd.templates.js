define(["Underscore","jQuery","tau/core/extension.base","tau/core/termProcessor","tau/configurations/converters/converter.context"],function(_,$,BaseModel,TermProcessor,converter){return BaseModel.extend({"bus beforeInit":function(evt,initConfig){var options=initConfig.config.options||{},entity=initConfig.config.context.entity,acid=initConfig.config.context.applicationContext.acid,context=initConfig.config.context,configurator=initConfig.config.context.configurator;this.fire("viewerBus.ready",this.bus),configurator.applicationContextService.getApplicationContext({acid:acid},{success:_.bind(function(event){this.fire("culture.ready",event.culture)},this)}),options=_.defaults(options,{items:[]}),options.items=converter.convert(options.items,_.pluck(context.getPractices(),"name"),context.getEdition()),options.items.length==0?this.fire("dataBind",{isEmpty:!0,types:[],entityTypes:[]}):this.getData(configurator,entity,acid,options).done(_.bind(function(templates){var termProcessor=new TermProcessor(initConfig.config.context.getTerms()),templateData={};_.forEach(templates,function(v){v.entityType={name:v.entityType,title:termProcessor.resolve(v.entityTypeTitle)},entity.entityType.name=="release"&&v.entityType.name.toLowerCase()=="iteration"&&(v.template.items=_.reject(v.template.items,function(v){return v.id.toLowerCase()=="release"})),templateData[v.entityType.name]=v}),this.fire("model.dataItems.template.ready",{types:templateData}),this.fire("dataBind",{types:templateData,entityTypes:_.pluck(templateData,"entityType")})},this))},"bus beforeInit:last + cardDataToShow.ready":function(evt,initConfig,data){var configurator=initConfig.config.context.configurator;configurator.service("navigator").to("#"+data.entityType+"/"+data.entityId)},getData:function(configurator,entity,acid,options){var fs=[],items=options.items;fs.push(function(next){var definition={global:{acid:acid},entityType:entity.entityType.name,entityId:entity.id},slice=configurator.getSliceFactory().create({definition:definition});slice.viewActions().done(function(res){var resultItems=[];_.forEach(items,function(v){var x=_.find(res.data.data.types,function(type){return type.name.toLowerCase()==v.entityType.toLowerCase()});x&&resultItems.push(x)});var actionsData=_.map(resultItems,function(v,k){return{templateAction:"viewDataTemplate",saveAction:"viewAddData",entityType:v.name,entityTypeTitle:v.title,slice:slice}});next(!1,_.compact(actionsData))})}),fs.push(_.bind(function(actionsData,next){return this.getTemplates(actionsData).pipe(function(templates){actionsData=_.map(actionsData,function(v,k){return v.template={items:templates[k]},v}),next(!1,actionsData)})},this));var def=$.Deferred();return _.waterfall(fs,function(err,types){def.resolve(types)}),def},getTemplates:function(actionsData){var fs=[],def=$.Deferred();return _.forEach(actionsData,function(actionData){fs.push(function(next){var set={$set:{entityType:actionData.entityType}};actionData.slice[actionData.templateAction](set).done(function(result){next(!1,result.data)})})}),_.parallel(fs,function(err,templates){def.resolve(templates)}),def}})})