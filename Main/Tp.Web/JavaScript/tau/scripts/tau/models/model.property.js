define(["Underscore","tau/core/model.editable.base"],function(t,e){return e.extend({init:function(t){if(this._super(t),!t.propertyName)throw new Error("PropertyName was not configured");this.propertyName=t.propertyName,this.displayField=t.displayField||"name",this.valueField=t.valueField||"id",this.listenedEntities={}},isPropertyChanged:function(e,i){var n=i.changes,r=i.cmd&&i.cmd.config.$set||{},o=i.cmd&&i.cmd.config.id;return t.any(e,function(t){return n&&n.hasOwnProperty(t)||o&&r.hasOwnProperty(t)})},getEntityTypeName:function(){return this.config.context.entity.entityType.name},getEntityId:function(){return this.config.context.entity.id},buildRequest:function(t){return this.store.get(this.getEntityTypeName(),{id:this.getEntityId(),fields:["id",t]})},getPropertyData:function(t){this.buildRequest(t).done(this.safeCallback(this.onEntityRetrieved))},getPropertyFields:function(){return[this.displayField,this.valueField]},onInit:function(){this._super.apply(this,arguments);var t={};t[this.propertyName]=this.getPropertyFields(),this.listenOfPropertyChanged(),this.getPropertyData(t)},listenOfPropertyChanged:function(){var t=this.config.context.entity.id;this.listenedEntities[t]||(this.listenedEntities[t]=!0,this.attachToChangePropertiesOfCurrentEntity(this.propertyName))},onProcessProperty:function(t){if(!this.config)return null;var e={id:t[this.valueField],name:this.propertyName.toLowerCase(),text:t[this.displayField],isEditable:this.config.editable};return e.actionReset={enable:null!==e.id&&void 0!==e.id&&this.config.allowReset,label:this.config.editorComponentConfig&&this.config.editorComponentConfig.clearValueLabel},this.config.showUrl&&t.id&&(e.hasUrl=!0,e.__type=t.__type,e.id=t.id,e.url=this.config.context.configurator.getUrlBuilder().getNewViewUrl(t.id,t.__type,!0)),e.placeholderText=this.config.placeholderText,e.value=e.text,e},processProperty:function(t){var e=this.onProcessProperty(t);this.fire("dataBind",e)},onEntityRetrieved:function(t){this.config&&(this.property=t[0].data[this.propertyName]||{},this.processProperty(this.property))},entityBelongCurrentContext:function(t){return t.changes.hasOwnProperty(this.config.propertyName)&&t.cmd.config.id==this.config.context.entity.id},onEntityAfterSave:function(t){var e=t.data;this.entityBelongCurrentContext(e)&&this.fire("changed",e)},onEntityBeforeSave:function(t){var e=t.data;this.entityBelongCurrentContext(e)&&this.fire("beforeChanged",e)}})});