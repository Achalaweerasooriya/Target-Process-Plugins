define(["Underscore","tau/models/propertyLists/model.propertyList.base","tau/configurator","tau/core/types","tau/utils/utils.date"],function(a,b,c,d,e){return b.extend({name:"release-list",propertyType:"release",onInit:function(){var a=this,b=function(){a.store.get("project",{id:a.config.context.applicationContext.selectedProjects[0].id,nested:!0,fields:["id",{releases:["id","name","startDate","endDate"]}]}).done({success:a.onDataRetrieved.tauCreateDelegate(a)})};b()},"bus beforeSave":function(a){var b=a.data.cmd,c=b.$set,d=b.fields=b.fields||[];this.entityContainIteration()&&d.push({iteration:["id","name"]})},entityContainIteration:function(){var a=d.findByKeyword(this.config.context.entity.entityType.name);return a.refs.hasOwnProperty("iteration")},getRequiredFields:function(){return[{entityState:["id"]}]},convertReleaseToDto:function(a){var b=this.isCurrentRelease(a),c=a.name+(b?" (current)":"");return{id:a.id,name:c,description:"From "+e.format.date.short(a.startDate)+" to "+e.format.date.short(a.endDate)}},isOldRelease:function(a){var b=c.getCurrentDate();return a.endDate<b},isCurrentRelease:function(a){var b=c.getCurrentDate();return a.startDate<=b&&b<=a.endDate},isCurrentOrFeatureRelease:function(a){return!this.isOldRelease(a)},selectOldReleases:function(){return a.select(this.projectReleaseList,this.isOldRelease,this)},selectCurrentAndFeatureReleases:function(b){return a.select(this.projectReleaseList,this.isCurrentOrFeatureRelease,this)},getCurrentRelease:function(){return a.detect(this.projectReleaseList,this.isCurrentRelease,this)},initProjectReleaseList:function(b){var c=this.getCurrentEntityId(),d=a.select(b.releases,function(a){return a.id!=c});a.each(d,function(a){a.startDate=e.parse(a.startDate),a.endDate=e.parse(a.endDate)}),this.projectReleaseList=d},processData:function(b){this.initProjectReleaseList(b);var c=this.getCurrentEntityId(),d=this.config,e=d.mode||"short",f=this.selectCurrentAndFeatureReleases(),g=[],h=this.selectOldReleases(),i=h.length==0;e=="short"&&f.length>0?g=f:(e=="full",g=g.concat(h,f),i=!0),g=a.map(g,this.convertReleaseToDto,this);var j={nullableValue:c!==null&&this.config.context.entity.entityType.name.toLowerCase()!=="iteration"&&this.propertyIsNotEmpty(),states:g,completed:i},k=this.getCurrentRelease();k&&(j.defaultValue=k.id),this.fire("dataBind",j)}})})