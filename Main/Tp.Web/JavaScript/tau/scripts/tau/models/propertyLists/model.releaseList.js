define(["Underscore","tau/models/propertyLists/model.propertyList.base","tau/store/types","tau/utils/utils.date"],function(_,ModelBase,tauTypes,dateUtils){return ModelBase.extend({name:"release-list",propertyType:"release",onInit:function(){var entity=this.config.context.entity,self=this;this.store.get(entity.entityType.name,{id:entity.id,fields:["id",{project:["id",{releases:["id","name","isCurrent","startDate","endDate"]}]}]}).done({success:function(result){result[0].data.project=result[0].data.project||{};var project=_.defaults(result[0].data.project,{releases:[]});self.processData.call(self,project)}})},"bus beforeSave":function(evtArgs){var cmd=evtArgs.data.cmd,$set=cmd.$set,fields=cmd.fields=cmd.fields||[];this.entityContainIteration()&&fields.push({iteration:["id","name"]})},entityContainIteration:function(){var type=tauTypes.findByKeyword(this.config.context.entity.entityType.name);return type.refs.hasOwnProperty("iteration")},getRequiredFields:function(){return[{entityState:["id"]}]},convertReleaseToDto:function(release){var isCurrent=this.isCurrentRelease(release),itemName=release.name+(isCurrent?" (current)":"");return{id:release.id,name:itemName,description:"From "+dateUtils.format.date.short(release.startDate)+" to "+dateUtils.format.date.short(release.endDate)}},isOldRelease:function(release){var currentDate=this.config.context.configurator.getCurrentDate();return release.endDate<currentDate},isCurrentRelease:function(release){return release.isCurrent},isCurrentOrFeatureRelease:function(release){return!this.isOldRelease(release)},selectOldReleases:function(){return _.select(this.projectReleaseList,this.isOldRelease,this)},selectCurrentAndFeatureReleases:function(releaseList){return _.select(this.projectReleaseList,this.isCurrentOrFeatureRelease,this)},getCurrentRelease:function(){return _.detect(this.projectReleaseList,this.isCurrentRelease,this)},initProjectReleaseList:function(project){var currentReleaseId=this.getCurrentEntityId(),projectReleaseList=_.select(project.releases,function(release){return release.id!=currentReleaseId});_.each(projectReleaseList,function(release){release.startDate=dateUtils.parse(release.startDate),release.endDate=dateUtils.parse(release.endDate)}),this.projectReleaseList=projectReleaseList},processData:function(project){this.initProjectReleaseList(project);var currentReleaseId=this.getCurrentEntityId(),config=this.config,mode=config.mode||"short",currentAndFeatureReleaseList=this.selectCurrentAndFeatureReleases(),releases=[],oldReleases=this.selectOldReleases(),completed=oldReleases.length==0;mode=="short"&&currentAndFeatureReleaseList.length>0?releases=currentAndFeatureReleaseList:(mode=="full",releases=releases.concat(oldReleases,currentAndFeatureReleaseList),completed=!0),releases=_.map(releases,this.convertReleaseToDto,this);var data={nullableValue:currentReleaseId!==null&&this.config.context.entity.entityType.name.toLowerCase()!=="iteration"&&this.propertyIsNotEmpty(),states:releases,completed:completed},currentRelease=this.getCurrentRelease();currentRelease&&(data.defaultValue=currentRelease.id),this.fire("dataBind",data)}})})