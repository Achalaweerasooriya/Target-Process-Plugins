define(["Underscore","tau/models/propertyLists/model.propertyList.base","tau/configurator","tau/utils/utils.date"],function(_,a,b,c){return a.extend({name:"iteration-list",propertyType:"iteration",onInit:function(){var a=this.config.context.entity,b=this;this.store.get(a.entityType.name,{id:a.id,fields:["id",{project:["id",{iterations:["id","name","startDate","endDate",{release:["id","name"]}]}]}]}).done({success:function(a){var c=a[0].data.project;b.processData.call(b,c)}})},getRequiredFields:function(){return[{entityState:["id"]}]},"bus beforeSave":function(a){var b=a.data.cmd.fields=a.data.cmd.fields||[];b.push({release:["id","name"]})},processData:function(a){var d=this.config,e=this.getCurrentEntityId(),f=[],g=d.mode||"short",h=null,i=null,j=b.getCurrentDate(),k=function(a){a.id!==e&&f.push(a)};g==="full"?h=k:h=function(a){var b=c.parse(a.startDate),d=c.parse(a.endDate);a.id!==e&&(b>=j||d>=j)&&f.push(a)},_.each(a.iterations,h),f.length==0&&(d.mode=="full",h=k,_.each(a.iterations,h));var l=[],m={};_(f).each(function(a){var b=m[a.release.id]||{id:a.release.id,name:a.release.name};b.items=b.items||[];var d=c.parse(a.startDate),e=c.parse(a.endDate),f=j>=d&&j<=e,g=a.name+(f?" (current)":"");f&&(i=a),b.items.push({id:a.id,name:g,description:"From "+c.format.date.short(d)+" to "+c.format.date.short(e)}),m[b.id]||(l.push(b),m[b.id]=b)});var n=a.iterations.length,o=e?n-1:n,p={nullableValue:e!==null&&this.propertyIsNotEmpty(),states:l,completed:0===f.length-o};i&&(p.defaultValue=i.id),this.fire("dataBind",p)}})})