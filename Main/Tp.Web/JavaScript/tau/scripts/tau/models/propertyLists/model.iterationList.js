define(["Underscore","tau/models/propertyLists/model.propertyList.base","tau/utils/utils.date"],function(_,ModelProperyListBase,dateUtils){return ModelProperyListBase.extend({name:"iteration-list",propertyType:"iteration",onInit:function(){var entity=this.config.context.entity,self=this;this.store.get(entity.entityType.name,{id:entity.id,fields:["id",{project:["id",{iterations:["id","name","startDate","endDate","isCurrent",{release:["id","name"]}]}]}]}).done({success:function(result){result[0].data.project=result[0].data.project||{};var project=_.defaults(result[0].data.project,{iterations:[]});self.processData.call(self,project)}})},getRequiredFields:function(){return[{entityState:["id"]}]},"bus beforeSave":function(evtArgs){var fields=evtArgs.data.cmd.fields=evtArgs.data.cmd.fields||[];fields.push({release:["id","name"]})},processData:function(project){var config=this.config,currentStateId=this.getCurrentEntityId(),states=[],mode=config.mode||"short",fnFilter=null,currentIteration=null,currentDate=this.config.context.configurator.getCurrentDate(),fnFilterFull=function(iteration){iteration.id!==currentStateId&&states.push(iteration)};mode==="full"?fnFilter=fnFilterFull:fnFilter=function(item){var start=dateUtils.parse(item.startDate),end=dateUtils.parse(item.endDate);item.id!==currentStateId&&(start>=currentDate||end>=currentDate)&&states.push(item)},_.each(project.iterations,fnFilter),states.length==0&&(config.mode=="full",fnFilter=fnFilterFull,_.each(project.iterations,fnFilter));var groups=[],registered={};_(states).each(function(iter){var iteration=registered[iter.release.id]||{id:iter.release.id,name:iter.release.name};iteration.items=iteration.items||[];var start=dateUtils.parse(iter.startDate),end=dateUtils.parse(iter.endDate),isCurrent=iter.isCurrent,iterationName=iter.name+(isCurrent?" (current)":"");isCurrent&&(currentIteration=iter),iteration.items.push({id:iter.id,name:iterationName,description:"From "+dateUtils.format.date.short(start)+" to "+dateUtils.format.date.short(end)}),registered[iteration.id]||(groups.push(iteration),registered[iteration.id]=iteration)});var fullLength=project.iterations.length,tailLength=currentStateId?fullLength-1:fullLength,data={nullableValue:currentStateId!==null&&this.propertyIsNotEmpty(),states:groups,completed:0===states.length-tailLength};currentIteration&&(data.defaultValue=currentIteration.id),this.fire("dataBind",data)}})})