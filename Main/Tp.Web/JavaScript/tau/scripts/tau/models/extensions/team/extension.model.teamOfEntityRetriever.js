define(["Underscore","tau/core/model-base"],function(e,t){return t.extend({"bus registerStoreRequest":function(){var e=this.config.context.entity||{entityType:{}},t=this.config.context.configurator.getStore().config.proxy.types[e.entityType.name].refs,i=[{project:["id"]}];t.team&&i.push({team:["id"]}),this.fire("get",{type:e.entityType.name,query:{id:e.id,fields:i},callback:{scope:this,success:function(e){this.fire("teamOfEntityRetriever",e),this.fire("commitTransaction")}}})},"bus teamOfEntityRetriever":function(t){var i=this.config.context.entity||{entityType:{name:""}},a=i.entityType.name.toLowerCase(),r=null,n=null,s=t.data.data;s.project?r=s.project.id:"project"===a&&(r=s.id),s.team?n=s.team.id:"team"===a&&(n=s.id);var c=[],o=e.bind(this.fire,this);r&&c.push(function(e){o("get",{type:"project",query:{id:r,fields:["id",{projectMembers:[{user:["id","firstName","lastName","isActive","email"]},{role:["id","name"]}]}]},callback:{success:function(t){e(!1,t.data.projectMembers)}}})}),n&&c.push(function(e){o("get",{type:"team",query:{id:n,fields:["id",{teamMembers:[{user:["id","firstName","lastName","email","isActive"]},{role:["id","name"]}]}]},callback:{success:function(t){e(!1,t.data.teamMembers)}}})});var u=this;e.parallel(c,function(t,i){var a=e.flatten(i,!0);a=e.uniq(a,!1,function(e){return e.user.id}),e.forEach(a,function(t){t.username=t.email,(t.firstName||t.lastName)&&(t.username=e.trim([t.firstName,t.lastName].join(" ")))}),o("projectMembersReady",a);var r=u.getRoles(a);o("projectRolesReady",r)})},getRoles:function(t){var i={},a=[];return e.each(t,function(e){var t=e.role;i.hasOwnProperty(t.id)||(i[t.id]=!0,a.push(t))}),a}})});