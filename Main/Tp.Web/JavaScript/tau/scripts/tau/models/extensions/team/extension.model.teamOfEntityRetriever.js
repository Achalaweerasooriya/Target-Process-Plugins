define(["Underscore","tau/core/model-base"],function(_,EditableBase){return EditableBase.extend({"bus registerStoreRequest":function(){var entity=this.config.context.entity||{entityType:{}},refs=this.config.context.configurator.getStore().config.proxy.types[entity.entityType.name].refs,fields=[{project:["id"]}];refs.team&&fields.push({team:["id"]}),this.fire("get",{type:entity.entityType.name,query:{id:entity.id,fields:fields},callback:{scope:this,success:function(res){this.fire("teamOfEntityRetriever",res),this.fire("commitTransaction")}}})},"bus teamOfEntityRetriever":function(evtArgs){var entity=this.config.context.entity||{entityType:{name:""}},entityType=entity.entityType.name.toLowerCase(),projectId=null,teamId=null,data=evtArgs.data.data;data.project?projectId=data.project.id:entityType==="project"&&(projectId=data.id),data.team?teamId=data.team.id:entityType==="team"&&(teamId=data.id);var f=[],fire=_.bind(this.fire,this);projectId&&f.push(function(next){fire("get",{type:"project",query:{id:projectId,fields:["id",{projectMembers:[{user:["id","firstName","lastName","isActive","email"]},{role:["id","name"]}]}]},callback:{success:function(res){next(!1,res.data.projectMembers)}}})}),teamId&&f.push(function(next){fire("get",{type:"team",query:{id:teamId,fields:["id",{teamMembers:[{user:["id","firstName","lastName","email","isActive"]},{role:["id","name"]}]}]},callback:{success:function(res){next(!1,res.data.teamMembers)}}})});var self=this;_.parallel(f,function(err,res){var members=_.flatten(res,!0);members=_.uniq(members,!1,function(u){return u.user.id}),_.forEach(members,function(member){member.username=member.email;if(member.firstName||member.lastName)member.username=_.trim([member.firstName,member.lastName].join(" "))}),fire("projectMembersReady",members);var roles=self.getRoles(members);fire("projectRolesReady",roles)})},getRoles:function(projectMembers){var roleIds={},roles=[];return _.each(projectMembers,function(projectMember){var role=projectMember.role;roleIds.hasOwnProperty(role.id)||(roleIds[role.id]=!0,roles.push(role))}),roles}})})