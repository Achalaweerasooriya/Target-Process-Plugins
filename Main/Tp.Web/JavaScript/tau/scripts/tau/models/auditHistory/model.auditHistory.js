define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/store/services/service.auditHistory","tau/utils/utils.date"],function(t,e,i,n,r){return i.extend({REQUEST_SOURCE_TYPE_MAP:{0:"None",1:"Email",2:"Phone",3:"Internal",4:"External"},"bus afterInit":function(){var t=this.config.context.configurator;this.auditHistoryService=t.getAuditHistoryService(),this.urlBuilder=t.getUrlBuilder(),this.fire("dataBind")},"bus getAuditRecords":function(t,e){var i=this.config.context.entity.id;this.auditHistoryService.getAuditRecordsLimited(i,e.start,e.limit,this.config.context.entity.entityType.name).done(function(t){var e=t.d,i=this._convertRawAuditRecords(e);this.fire("auditRecords.ready",{auditRecords:i})}.bind(this)).fail(function(t){this.fire("auditRecords.ready",{}),this._handleError(t)}.bind(this))},"bus getAuditRecordsChanges":function(e,i){var n=t.map(i.records,function(t){return{historyId:t.historyId,entityTypeName:t.entityTypeName}},this),r=this.config.context.entity.id;this.auditHistoryService.getChangeGroups(r,n,this.config.context.entity.entityType.name).done(function(t){var e=t.d;this.fire("auditRecordsChanges.ready",this._convertRawChangeGroups(e))}.bind(this)).fail(function(t,e){this.fire("auditRecordsChanges.ready",this._convertKeysToNoChangeGroups(t)),this._handleError(e)}.bind(this,n))},_convertRawAuditRecords:function(e){return t.map(e,function(t){var e=r.parseTimestampToDate(t.Date);return{historyId:t.ID,entityTypeName:t.InnerEntity||t.Entity,date:{year:e.toString("yyyy"),month:e.toString("MMM"),day:e.toString("dd"),time:e.toString("h:mm tt")},description:t.Description,avatarUrl:this.urlBuilder.getAvatarUrl(t.ModifierID,32),user:t.Modifier}},this)},_convertKeysToNoChangeGroups:function(e){return t.map(e,function(t){return{historyId:t.historyId,entityTypeName:t.entityTypeName}},this)},_convertRawChangeGroups:function(e){return t.map(e,this._convertRawChangeGroup,this)},_convertRawChangeGroup:function(t){return{historyId:t.Key.HistoryId,entityTypeName:t.Key.EntityTypeName,changes:this._convertRawChanges(t.Changes)}
},_convertRawChanges:function(e){return t.map(e,function(t){return{fieldName:t.Field,oldValue:this._formatValue(t.OldValue,t.ChangeID),newValue:this._formatValue(t.NewValue,t.ChangeID)||"Empty",toBeEncoded:!("Description"==t.NativeField&&-1==t.ChangeID.indexOf("Attachment-Description")||t.ChangeID.indexOf("TestCase-Success")>0||t.ChangeID.indexOf("TestCase-Steps")>0)}},this)},_formatValue:function(t,e){return e.indexOf("Request-SourceType")>0?this.REQUEST_SOURCE_TYPE_MAP[t]||t:t},_handleError:function(t){this.fire("error",t.statusText.toString())}})});