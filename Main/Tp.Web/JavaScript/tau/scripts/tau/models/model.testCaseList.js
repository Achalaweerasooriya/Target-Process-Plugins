define(["Underscore","tau/core/model-base","tau/utils/utils.date","tau/utils/utils.htmlConverter"],function(_,ModelBase,dateUtils,htmlConverter){function dataProcessor(model){this.model=model}dataProcessor.prototype={getAssignableRetrievedCallback:function(){return{scope:this,success:this.onAssignableRetrieved}},onAssignableRetrieved:function(result){var initData={labelAdd:this.model.config.labelAdd||"Add",items:[]};this.model.assignable=result.data;var testCases=_.sortBy(result.data.testCases,function(a){return a.numericPriority}),testCasesCount=testCases.length;for(var i=0;i<testCasesCount;i++)initData.items.push(this.convertServerDataModelData(testCases[i]));this.model.bus&&this.model.bus.fire("dataBind",initData)},convertServerDataModelData:function(serverData){var lastRunDate=null;serverData.lastRunDate&&(lastRunDate=dateUtils.format.datetime.short(serverData.lastRunDate));var lastRunStatus=undefined;serverData.lastStatus!=undefined&&(lastRunStatus={isPassed:serverData.lastStatus});var urlBuilder=this.config.context.configurator.getUrlBuilder(),data={__type:"testCase",id:serverData.id,name:serverData.name,lastRunDate:lastRunDate,applicationUrl:"#testcase/"+serverData.id,externalUrl:urlBuilder.getViewUrl(serverData.id),steps:htmlConverter.fromSourceToHtml(serverData.steps),success:htmlConverter.fromSourceToHtml(serverData.success)};return lastRunStatus&&(data.lastRunStatus=lastRunStatus),data}};var testCaseListModel=ModelBase.extend({onInit:function(){var self=this,processor=new dataProcessor(self),assignable=self.config.context.entity;this.store.get(assignable.entityType.name,{id:assignable.id,fields:["id",{testCases:["id","name","lastRunDate","lastStatus","steps","success","numericPriority"]}]},processor.getAssignableRetrievedCallback()).done()},"bus evictTestCases":function(){var assignable=this.config.context.entity;this.store.evictProperties(assignable.id,assignable.entityType.name,["testCases","testCases-count"])}});return testCaseListModel})