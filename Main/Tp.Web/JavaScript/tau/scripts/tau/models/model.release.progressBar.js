define(["Underscore","tau/core/model-base"],function(_,a){var b=a.extend({name:"Iteration Progress Bar",afterSaveRoleEffort:function(a){var b=this;b.fire("roleEffortChanged")},onDataUpdate:function(a){var b=this;b.fire("refresh")},floatToString:function(a){return a.toFixed(2).replace(".00","")},_getEffortPoints:function(){return this.config.context.getEffortPoint().shortName},onInit:function(){var a=this,b=this.config.context,c=b.entity.entityType.name,d=b.entity.id,e=["bugs-effortToDo-sum","bugs-effortCompleted-sum","userStories-effortToDo-sum","userStories-effortCompleted-sum",{features:["effortToDo","effortCompleted","userStories-count"]}];a.store.unbind(a),a.store.on({eventName:"afterSave",type:"roleEffort",listener:a,filter:{assignable:{id:d}}},_.bind(a.afterSaveRoleEffort,a)),a.store.on({eventName:"afterSave",type:c,listener:a,filter:{id:d},hasChanges:[e.join("|")]},_.bind(a.onDataUpdate,a)),a.store.get(c,{id:d,fields:e},{success:a.onEntityRetrieved,scope:a}).done({success:a.done,scope:a})},onEntityRetrieved:function(a){var b=a.data,c=function(a){return a["userStories-count"]==0},d=a.data.features,e=_.filter(d,c),f=_.pluck(e,"effortToDo"),g=_.pluck(e,"effortCompleted"),h=function(a){return _.reduce(a,function(a,b){return a+b},0)},i=b["bugs-effortToDo-sum"]+b["userStories-effortToDo-sum"]+h(f),j=b["bugs-effortCompleted-sum"]+b["userStories-effortCompleted-sum"]+h(g),k=Math.round(100*parseFloat(i)+100*parseFloat(j))/100,l=Math.round(1e4*(j/k))/100;l=isNaN(l)?0:l,l=l>100?100:l,this.effortToDo=i,this.effortCompleted=j,this.percentCompleted=l},done:function(){this.fire("dataBind",{effortToDo:this.floatToString(this.effortToDo),effortCompleted:this.floatToString(this.effortCompleted),percentCompleted:this.percentCompleted,totalEffort:this.floatToString(this.effortToDo+this.effortCompleted),point:this._getEffortPoints()})}});return b})