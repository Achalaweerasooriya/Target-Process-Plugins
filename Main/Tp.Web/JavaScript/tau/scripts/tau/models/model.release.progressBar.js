define(["Underscore","tau/core/model-base"],function(a,b){var c=b.extend({name:"Iteration Progress Bar",afterSaveRoleEffort:function(a){var b=this;b.fire("roleEffortChanged")},onDataUpdate:function(a){var b=this;b.fire("refresh")},floatToString:function(a){return a.toFixed(2).replace(".00","")},_getEffortPoints:function(){return this.config.context.getEffortPoint().shortName},onInit:function(){var b=this,c=this.config.context,d=c.entity.entityType.name,e=c.entity.id,f=["bugs-effortToDo-sum","bugs-effortCompleted-sum","userStories-effortToDo-sum","userStories-effortCompleted-sum",{features:["effortToDo","effortCompleted","userStories-count"]}];b.store.unbind(b),b.store.on({eventName:"afterSave",type:"roleEffort",listener:b,filter:{assignable:{id:e}}},a.bind(b.afterSaveRoleEffort,b)),b.store.on({eventName:"afterSave",type:d,listener:b,filter:{id:e},hasChanges:[f.join("|")]},a.bind(b.onDataUpdate,b)),b.store.get(d,{id:e,fields:f},{success:b.onEntityRetrieved,scope:b}).done({success:b.done,scope:b})},onEntityRetrieved:function(b){var c=b.data,d=function(a){return a["userStories-count"]==0},e=b.data.features,f=a.filter(e,d),g=a.pluck(f,"effortToDo"),h=a.pluck(f,"effortCompleted"),i=function(b){return a.reduce(b,function(a,b){return a+b},0)},j=c["bugs-effortToDo-sum"]+c["userStories-effortToDo-sum"]+i(g),k=c["bugs-effortCompleted-sum"]+c["userStories-effortCompleted-sum"]+i(h),l=Math.round(100*parseFloat(j)+100*parseFloat(k))/100,m=Math.round(1e4*(k/l))/100;m=isNaN(m)?0:m,m=m>100?100:m,this.effortToDo=j,this.effortCompleted=k,this.percentCompleted=m},done:function(){this.fire("dataBind",{effortToDo:this.floatToString(this.effortToDo),effortCompleted:this.floatToString(this.effortCompleted),percentCompleted:this.percentCompleted,totalEffort:this.floatToString(this.effortToDo+this.effortCompleted),point:this._getEffortPoints()})}});return c})