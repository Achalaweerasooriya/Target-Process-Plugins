define(["Underscore","tau/core/extension.base"],function(_,BaseModel){return BaseModel.extend({"bus beforeInit":function(evt,initConfig){var configurator=initConfig.config.context.configurator;this.fire("configurator.ready",configurator);var options=_.defaults(initConfig.config.options||{},{boardTemplatesGroupName:"boardTemplates",boardTemplateGroupsGroupName:"boardTemplateGroups",boardsGroupName:"boards"});this.fire("options.ready",options);var def=$.Deferred();configurator.getLoggedUser().isAdministrator?configurator.getRestStorage().select(options.boardsGroupName,{$where:'(publicData.isShared == "true")',$fields:["key"]}).done(function(result){var boards=result.data||[];boards.length==0?def.resolve():def.reject()}):def.reject(),def.done(_.bind(function(){this.fire("dataBind",{})},this)).fail(function(){configurator.getRouting().redirect(configurator.getUrlBuilder().getRelativeBoardUrl("current"))})},"bus configurator.ready:last + options.ready:last + boardsSet.selected":function(evt,configurator,options,setName){var storage=configurator.getRestStorage();storage.select(options.boardTemplateGroupsGroupName,{$fields:["key","publicData.name","publicData.boardTemplateIds"]}).done(_.bind(function(r){var group=_.find(r.data,function(v){return v.name==setName});this.fire("boardTemplateIds.ready",group?group.boardTemplateIds:[])},this))},"bus configurator.ready:last + options.ready:last + boardTemplateIds.ready":function(evt,configurator,options,boardTemplateIds){var storage=configurator.getRestStorage();storage.select(options.boardTemplatesGroupName,{$fields:["key","publicData.name","publicData.definition"]}).done(_.bind(function(r){var templates=r.data;templates=_.map(boardTemplateIds,function(id){return _.find(templates,function(v){return v.key==id})}),this.fire("boardTemplates.ready",templates)},this))},"bus configurator.ready:last + options.ready:last + boardTemplates.ready":function(evt,configurator,options,boardTemplates){var storage=configurator.getRestStorage(),defs=[];_.forEach(boardTemplates,function(item,i){var definition=item.definition||{};definition.name=item.name,definition.viewMode=definition.viewMode||"board",definition.isShared=!0,definition.menuNumericPriority=-100+i,_.forEach(["cells","x","y"],function(axis){definition[axis]=definition[axis]||{types:[]},definition[axis]&&(definition[axis]=_.defaults(definition[axis],{types:[],ordering:{name:null,isDescending:!1},filter:""}))}),definition&&defs.push(function(next){storage.data(options.boardsGroupName,definition.id,{scope:"Public",publicData:definition,userData:{menuIsVisible:1}}).done(function(){next()})})}),defs.unshift(function(next){storage.remove(options.boardsGroupName,{$where:'(publicData.isShared == "true")'}).done(function(){next(!1)})}),_.series(defs,_.bind(function(){this.fire("boardsSet.applied"),defs.length==1&&configurator.setConfig("tmpBoardIsJustAdded",!0),configurator.getRouting().redirect(configurator.getUrlBuilder().getRelativeBoardUrl("current"))},this))}})})