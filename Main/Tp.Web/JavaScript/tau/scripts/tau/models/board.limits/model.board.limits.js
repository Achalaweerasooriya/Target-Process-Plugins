define(["Underscore","tau/core/model-base"],function(_,BaseModel){return BaseModel.extend({INITIAL_STATE:"b64_X0luaXRpYWw_2_",FINAL_STATE:"b64_X0ZpbmFs_",ENTITY_STATE:"entitystate","bus afterInit":function(evt){this.fire("dataBind",{});var configurator=evt.data.config.context.configurator;this.fire("configurator.ready",configurator)},getSlice:function(configurator,boardSettings){var sliceDeferred=$.Deferred();return this.getDefinition(boardSettings).done(_.bind(function(dataDefinition){configurator.getAppStateStore().get({fields:["acid"],callback:function(data){var definition={};definition.global={acid:data.acid},definition=_.extend(definition,dataDefinition);var slice=configurator.getSliceFactory().create({definition:definition});sliceDeferred.resolve(slice)}})},this)),sliceDeferred},getDefinition:function(boardSettings){var deferred=$.Deferred();return boardSettings.get({fields:["cells","x","y"],callback:function(data){deferred.resolve({cells:data.cells,x:data.x,y:data.y})}}),deferred},getLimitFields:function(configurator,boardSettings){var deferred=$.Deferred();return this.getSlice(configurator,boardSettings).done(_.bind(function(slice){var action,definition=slice.config.definition;definition.y&&definition.y.types&&definition.y.types[0]==this.ENTITY_STATE&&(action="y"),definition.x&&definition.x.types&&definition.x.types[0]==this.ENTITY_STATE&&(action="x"),action?slice[action]({$take:999}).done(function(data){deferred.resolve(data.data.items)}):deferred.reject()},this)),deferred},limitValues:function(boardSettings){var deferred=$.Deferred();return boardSettings.get({fields:["limits"],callback:_.bind(function(data){deferred.resolve(data.limits&&data.limits[this.ENTITY_STATE]||{})},this)}),deferred},getAccess:function(configurator,boardSettings){var deferred=$.Deferred(),access={edit:!0},user=configurator.getLoggedUser();return boardSettings.get({fields:["ownerId"],callback:function(boardData){return parseInt(user.id,10)!==parseInt(boardData.ownerId,10)&&!user.isAdministrator&&(access.edit=!1),deferred.resolve(access)}}),deferred},getData:function(configurator,boardSettings){return $.when(this.getLimitFields(configurator,boardSettings),this.limitValues(boardSettings),this.getAccess(configurator,boardSettings)).pipe(_.bind(function(fields,values,access){return fields=_.reduce(fields,function(memo,item){var action="y";item.x&&(action="x");if(item[action].toString()!==this.INITIAL_STATE&&item[action].toString()!==this.FINAL_STATE){var value=values[item[action]];if(!_.isNumber(value)||_.isNaN(value))value="";item.dynamic.items[0].value=value,memo.push(item.dynamic.items[0])}return memo},[],this),{fields:fields,access:access,values:values}},this))},loadData:function(configurator,boardSettings){return _.bind(function(){this.getData(configurator,boardSettings).done(_.bind(function(data){this.fire("dataLimits.ready",data)},this)).fail(_.bind(function(){this.fire("dataLimits.ready",{fields:[],access:{edit:!1}})},this))},this)},"bus configurator.ready + boardSettings.ready":function(evt,configurator,boardSettings){boardSettings=boardSettings.boardSettings;var loadData=this.loadData(configurator,boardSettings);loadData(),configurator.getAppStateStore().unbind({listener:this}),configurator.getAppStateStore().bind({fields:["acid"],listener:this,callback:loadData}),boardSettings.unbind({listener:this}),boardSettings.bind({fields:["x","y","cells"],listener:this,callback:loadData})},"bus configurator.ready + boardSettings.ready + destroy":function(evt,configurator,bs){configurator.getAppStateStore().unbind({listener:this}),bs.boardSettings.unbind({listener:this})}})})