define(["Underscore","tau/core/model-base","tau/utils/utils.jsonSchema","tau/utils/utils.date"],function(_,a,b,c){var d=a.extend({category:"edit",name:"Model date validation","bus afterInit":function(){this.schema=b.Schema.create({type:"string",optional:!0,empty:!0,pre:["trim"],post:function(a){if(this.wasError()==0){var b=c.parse(a),d=c.parse(this.schema.additionalProperties.max),e=c.parse(this.schema.additionalProperties.min);b==null?new this.Error("Date","Incorrect date format"):b<new Date("01/01/1900")?new this.Error("Date","Date must be greater then 1-Jan-1900"):d&&b>d?new this.Error("Date","Start Date should be earlier than End Date"):e&&b<e?new this.Error("Date","End Date should be later than Start Date"):a=c.format.date.short(b)}return a},additionalProperties:{dateFormat:c.getFormatData().date.short,max:null,min:null}});var a=this.config.store,d=this.config.context.entity,e=this.config.bus,f=this,g=function(a){var b=a[0].data;this.config.propertyName=="startDate"&&(this.schema.additionalProperties.max=c.parse(b.endDate)),this.config.propertyName=="endDate"&&(this.schema.additionalProperties.min=c.parse(b.startDate))};a.get("project",{id:d.id,fields:["startDate","endDate"]}).done({success:_.bind(g,this)}),this.config.propertyName=="startDate"?a.on({eventName:"afterSave",type:"project",listener:this,filter:{id:d.id},hasChanges:["endDate"]},function(a){var b=c.parse(a.data.changes.endDate);f.schema.additionalProperties.max=b}):this.config.propertyName=="endDate"&&a.on({eventName:"afterSave",type:"project",listener:this,filter:{id:d.id},hasChanges:["startDate"]},function(a){var b=c.parse(a.data.changes.startDate);f.schema.additionalProperties.min=b})},"bus afterRender":function(a){this.element=a.data.element},"bus validateDate":function(a){var b=this.schema.validate(a.data.value||"");a.data.value=b.instance},"bus validate":function(a){var b=this.element.find(".property");b.dateEditor("resetValidationErrors");var c=a.data,d=c.cmd.$set[this.config.propertyName];if(!c.validation||c.validation.isError()!=1)c.validation=this.schema.validate(d),c.cmd.$set[this.config.propertyName]=c.validation.instance||null},"bus resetValidationErrors":function(){var a=this.element.find(".property");a.dateEditor("resetValidationErrors")},"bus afterValidate":function(a){var b=a.data.validation;this.element.find(".property").dateEditor("setValue",b.instance)},"bus validationFailed":function(a){var b=this.element.find(".property");b.dateEditor("setValidationErrors",a.data.validation.errors[0].description)}});return d})