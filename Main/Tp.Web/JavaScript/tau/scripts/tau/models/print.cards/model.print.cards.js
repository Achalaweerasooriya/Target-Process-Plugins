define(["Underscore","jQuery","tau/core/extension.base","tau/models/board.customize.units/board.customize.cards.builderSelector","tau/services/customize/service.customize.card.layout.factory","tau/models/board.customize.units/const.card.sizes"],function(t,e,r,a,n,u){return r.extend({"bus boardSettings.ready:last + configurator.ready:last + currentCards":function(r,a,n,u){var s=t.chain(u).map(function(t){return t.cards}).flatten().value(),o=t.groupByComplex(s,function(t){return t.cardData.type.toLowerCase()}),i=t.map(o,function(t){return this._getCardsDataByType(t.items,n,a.boardSettings)},this);e.when.all(i).then(function(e){return t.flatten(e)},function(){return[]}).then(function(e){var r=t.reduce(e,function(t,e){return t[e.dataItem.data.cardData.id]=e,t},{}),a=t.map(u,function(e){return{name:e.name,cards:t.map(e.cards,function(t){var e=r[t.cardData.id];return e.dataItem.coords=t.dataItem.coords,e})}});this.fire("renderCards",a)}.bind(this))},_getLayouts:function(e,r,s){var o=t.groupByComplex(e,function(t){return t.cardData.type.toLowerCase()}),i=t.reduce(o,function(t,e){var r=e.key;return t.cells.types.push(r),t},{cells:{types:[]},cardSettings:{}}),c=new a,d=new n(r,s);return d.getCardLayoutsByTypesAndSize(i.cells.types,u.L).then(function(e){return t.reduce(e,function(t,e,r){return t.types.push({type:r,data:c.build(r,e)}),t.mapLayouts[r]=e,t},{types:[],mapLayouts:{}})})},_getCardsDataByType:function(e,r,a){var n=t.map(e,function(t){return t.cardData.id}),u={cells:{}};return this._getLayouts(e,r,a).then(function(e){u.cells.types=e.types;var a={base64:!0,definition:u},s=r.getSliceFactory().create(a),o={$set:{CardsIds:n}};return s.cardDetails(o).then(function(a){return t.map(a.data.items,function(t){return{dataItem:t,configurator:r,layout:e.mapLayouts[t.type.toLowerCase()]}})}.bind(this),function(){return[]})}.bind(this))},"bus beforeInit":function(){this.fire("dataBind")}})});