define(["Underscore","jQuery","tau/core/extension.base","tau/models/board.customize.units/board.customize.cards.builderSelector","tau/services/customize/service.customize.card.layout.factory","tau/models/board.customize.units/const.card.sizes"],function(t,e,n,r,a,u){return n.extend({"bus boardSettings.ready:last + configurator.ready:last + currentCards":function(n,r,a,u){var s=t.chain(u).map(function(t){return t.cards}).flatten().value(),i=t.groupByComplex(s,function(t){return t.type.toLowerCase()}),o=t.map(i,function(t){return this._getCardsDataByType(t.items,a,r.boardSettings)},this);e.when.all(o).then(function(e){return t.flatten(e)},function(){return[]}).then(function(e){var n=t.reduce(e,function(t,e){return t[e.dataItem.data.cardData.id]=e,t},{}),r=t.map(u,function(e){return{name:e.name,cards:t.map(e.cards,function(t){return n[t.id]})}});this.fire("renderCards",r)}.bind(this))},_getLayouts:function(e,n,s){var i=t.groupByComplex(e,function(t){return t.type.toLowerCase()}),o=t.reduce(i,function(t,e){var n=e.key;return t.cells.types.push(n),t},{cells:{types:[]},cardSettings:{}}),c=new r,d=new a(n,s);return d.getCardLayoutsByTypesAndSize(o.cells.types,u.L).then(function(e){return t.reduce(e,function(t,e,n){return t.types.push({type:n,data:c.build(n,e)}),t.mapLayouts[n]=e,t},{types:[],mapLayouts:{}})})},_getCardsDataByType:function(e,n,r){var a=t.map(e,function(t){return t.id}),u={cells:{}};return this._getLayouts(e,n,r).then(function(e){u.cells.types=e.types;var r={base64:!0,definition:u},s=n.getSliceFactory().create(r),i={$set:{CardsIds:a}};return s.cardDetails(i).then(function(r){return t.map(r.data.items,function(t){return{dataItem:t,configurator:n,layout:e.mapLayouts[t.type.toLowerCase()]}})}.bind(this),function(){return[]})}.bind(this))},"bus beforeInit":function(){this.fire("dataBind")}})});