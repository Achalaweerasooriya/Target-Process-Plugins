define(["Underscore","tau/core/extension.base","tau/configurations/factory.container.config"],function(_,ModelBase,configFactory){return ModelBase.extend({resetLifecycle:!0,"bus beforeInit":function(evt,initConfig){var configurator=initConfig.config.context.configurator;this.fire("configurator.ready",configurator),initConfig.config.context.entity.type=initConfig.config.context.entity.entityType.name.toLowerCase(),this.fire("entity.ready",initConfig.config.context.entity)},"bus configurator.ready + entity.ready":function(e,configurator,entity){var store=configurator.getStore(),fireRefresh=_.bind(function(res){res.data.cmd.name=="removeFromList"&&this.fire("refresh")},this);store.unbind(this),store.on({eventName:"afterSave",type:"team",listener:this},fireRefresh)},"bus configurator.ready:last + teamMembers.ready:last + activeTab.ready:last + beforeInit":function(e,configurator,teamMembers,activeTab){var self=this,store=configurator.getStore(),f=[];f.push(_.bind(this._getList,this,store,"team",["id","name","icon"],_.pluck(_.compact(_.pluck(teamMembers,"team")),"id"))),_.parallel(f,function(err,res){var teams=res[0];self.fire("dataBind",{activeTab:activeTab,projects:[],showProjects:!1,canAddProjects:!1,teams:teams,canAddTeams:!0,submitLabel:"Assign",showEmpty:!0,showSearch:teams.length>20,icons:configFactory.getConfigByType("team").prototype.icons})})},_getList:function(store,name,fields,excludeIds,next){store.get(name,{fields:fields}).done({success:function(result){var items=result[0].data;items=_.filter(items,function(v){return _.indexOf(excludeIds,v.id)==-1}),items=_.sortBy(items,function(v){return v.name.toUpperCase()}),next(!1,items)}})},"bus configurator.ready:last + entity.ready":function(evt,configurator,entity){var self=this;configurator.getStore().get(entity.type,{id:entity.id,fields:[{teamMembers:[{team:["id","name"]}]}]}).done({success:function(res){self.fire("teamMembers.ready",res[0].data.teamMembers)}})},"bus configurator.ready:last + entity.ready:last + form.submitted":function(evt,configurator,user,data){var self=this,store=configurator.getStore(),saves=[];_.forEach(data.teamIds,function(id){saves.push({id:id,type:"team",fields:["id","teamMembers"],data:{teamMembers:[{user:{id:user.id}}]}})});var f=[];_.forEach(saves,function(save){f.push(function(next){store.save(save.type,{id:save.id,fields:save.fields,$set:save.data}).done({success:function(r){next(!1,r[0].data)}})})}),_.parallel(f,function(err,res){res.length&&configurator.getGlobalBus().fire("teamsAndUsers.connected",res),self.fire("refresh")})},"bus configurator.ready:last + destroy":function(e,configurator,entity){var store=configurator.getStore();store.unbind(this)}})})