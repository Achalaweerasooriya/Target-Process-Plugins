define(["Underscore","tau/core/model.editable.base"],function(_,a){var b=a.extend({name:"Editable Comments",_signUpEventsIfRequired:function(){var a=this;if(a._signedUp)return;a._signedUp=!0;var b=function(b){b.data.cmd.guid=+(new Date),a.fire("prepareUpdate",b.data)},c=function(b){a.fire("applyUpdate",b.data)},d=function(b){b.data.cmd.guid=+(new Date),a.fire("prepareRemove",b.data)},e=function(b){var c=b.data.obj.parentId,d=a.getComment(c);d&&d.deleted&&d.comments.length===1?a.store.remove("comment",{id:c}).done():a.fire("applyRemove",b.data)};a.store.unbind(a),a.store.on({eventName:"beforeSave",type:"comment",listener:a},b).on({eventName:"afterSave",type:"comment",listener:a},c).on({eventName:"beforeRemove",type:"comment",listener:a},d).on({eventName:"afterRemove",type:"comment",listener:a},e)},"bus dataBind":function(a){var b=a.data.items;this.commentsList=this.getPlainList(b);var c=_(this.commentsList).pluck("id"),d={editable:!0,editableItems:c,deletable:!0,deletableItems:c},e=this;e._signUpEventsIfRequired(),e.fire("permissionsReady",d)},getComment:function(a){var b=a?_(this.commentsList).detect(function(b){return b.id===a}):null;return b},getPlainList:function(a){var b=[];for(var c=0,d=a.length;c<d;c++){var e=a[c];b.push(e);var f=arguments.callee.call(this,a[c].comments);b=b.concat(f)}return b}});return b})