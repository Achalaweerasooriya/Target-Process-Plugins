define(["Underscore","tau/core/model.editable.base"],function(_,ModelBase){var modelComments=ModelBase.extend({name:"Editable Comments",_signUpEventsIfRequired:function(){var self=this;if(self._signedUp)return;self._signedUp=!0;var beforeSaveCallback=function(evt){evt.data.cmd.guid=+(new Date),self.fire("prepareUpdate",evt.data)},afterSaveCallback=function(evt){self.fire("applyUpdate",evt.data)},beforeRemoveCallback=function(evt){evt.data.cmd.guid=+(new Date),self.fire("prepareRemove",evt.data)},afterRemoveCallback=function(evt){var parentCommentId=evt.data.obj.parentId,parentComment=self.getComment(parentCommentId);parentComment&&parentComment.deleted&&parentComment.comments.length===1?self.store.remove("comment",{id:parentCommentId}).done():self.fire("applyRemove",evt.data)};self.store.unbind(self),self.store.on({eventName:"beforeSave",type:"comment",listener:self},beforeSaveCallback).on({eventName:"afterSave",type:"comment",listener:self},afterSaveCallback).on({eventName:"beforeRemove",type:"comment",listener:self},beforeRemoveCallback).on({eventName:"afterRemove",type:"comment",listener:self},afterRemoveCallback)},"bus dataBind":function(evt){var commentsTree=evt.data.items;this.commentsList=this.getPlainList(commentsTree);var ids=_(this.commentsList).pluck("id"),permissions={editable:!0,editableItems:ids,deletable:!0,deletableItems:ids},self=this;self._signUpEventsIfRequired(),self.fire("permissionsReady",permissions)},getComment:function(commentId){var result=commentId?_(this.commentsList).detect(function(obj){return obj.id===commentId}):null;return result},getPlainList:function(comments){var arrComments=[];for(var i=0,len=comments.length;i<len;i++){var cmt=comments[i];arrComments.push(cmt);var innerComments=arguments.callee.call(this,comments[i].comments);arrComments=arrComments.concat(innerComments)}return arrComments}});return modelComments})