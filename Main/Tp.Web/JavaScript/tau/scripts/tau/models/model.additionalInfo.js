define(["Underscore","tau/core/model-base","tau/core/termProcessor","tau/configurator"],function(_,a,b,c){var d=function(a){this.model=a};d.prototype={getFields:function(){var a=_.map(this.model.config.entities,function(a,b){return{type:a.type,isReference:a.isReference}});return a},getCommands:function(){var a=_.map(this.model.config.entities,function(a){var b={};return a.type=="owner"?b[a.type]=["id","firstName","lastName"]:b[a.type]=["id","name"],b});return a},setEntityType:function(a){this.entityType=a},initializeTerms:function(a){this.termProcessor=new b(a)},done:function(a){var b=a[0].data,d={entities:[]},e=this.getFields();for(var f=0,g=e.length;f<g;f++){var h=e[f].type,i=b[h]||{},j={type:h,value:{id:null,name:""}};if(i.id)if(h=="owner"){var k=i;j.value={id:k.id,name:[k.firstName,k.lastName].join(" "),role:k.role,avatar:[c.getApplicationPath(),"/Avatar.ashx?UserId=",k.id,"&size=32"].join("")}}else j.value={id:i.id,name:i.name},e[f].isReference&&(j.externalUrl=[c.getApplicationPath(),"/View.aspx?noRedirect=1&id=",i.id].join(""),j.applicationUrl="#"+j.type+"/"+j.value.id);d.entities.push(j)}this.model.bus.fire("dataBind",d)}};var e=a.extend({onInit:function(){var a=this,b=new d(this),c=this.config.context,e=c.entity.entityType.name,f=c.entity.id;b.setEntityType(e),b.initializeTerms(c.applicationContext.processes[0].terms);var g={id:f,fields:["id"]},h=b.getCommands();g.fields=g.fields.concat(h);var i=function(b){var c=b.data.changes,d=b.data.cmd.config.fields,f=["id","name"];c.release&&e!=="iteration"&&a.addRequiredFields("iteration",d,f),c.iteration&&a.addRequiredFields("release",d,f),a.fire("prepareChanges",c)},j=function(b){a.fire("applyChanges",b.data.changes)};a.store.on({eventName:"beforeSave",type:e,listener:this},i).on({eventName:"afterSave",type:e,listener:this},j),this.store.get(e,g).done({success:b.done,scope:b})},addRequiredFields:function(a,b,c){var d=_.detect(b,function(b){return b.hasOwnProperty(a)});d?_.each(c,function(b){_.any(d[a],function(a){return b==a})||d[a].push(b)}):(d={},d[a]=c,b.push(d))}});return e})