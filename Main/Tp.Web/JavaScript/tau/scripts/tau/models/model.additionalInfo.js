define(["Underscore","tau/core/model-base","tau/core/termProcessor"],function(e,t,i){var n=function(e){this.model=e};n.prototype={getFields:function(){var t=e.map(this.model.config.entities,function(e){return{type:e.type,isReference:e.isReference}});return t},getCommands:function(){var t=e.map(this.model.config.entities,function(e){var t={};return t[e.type]="owner"==e.type?["id","firstName","lastName"]:["id","name"],t});return t},setEntityType:function(e){this.entityType=e},initializeTerms:function(e){this.termProcessor=new i(e)},done:function(e){for(var t=this.config.context.configurator,i=e[0].data,n={entities:[]},a=this.getFields(),r=0,s=a.length;s>r;r++){var o=a[r].type,d=i[o]||{},c={type:o,value:{id:null,name:""}};if(d.id)if("owner"==o){var f=d;c.value={id:f.id,name:[f.firstName,f.lastName].join(" "),role:f.role,avatar:[t.getApplicationPath(),"/Avatar.ashx?UserId=",f.id,"&size=32"].join("")}}else c.value={id:d.id,name:d.name},a[r].isReference&&(c.applicationUrl="#"+c.type+"/"+c.value.id);n.entities.push(c)}this.model.bus.fire("dataBind",n)}};var a=t.extend({onInit:function(){var e=this,t=new n(this),i=this.config.context,a=i.entity.entityType.name,r=i.entity.id;t.setEntityType(a),t.initializeTerms(i.applicationContext.processes[0].terms);var s={id:r,fields:["id"]},o=t.getCommands();s.fields=s.fields.concat(o);var d=function(t){var i=t.data.changes,n=t.data.cmd.config.fields,r=["id","name"];i.release&&"iteration"!==a&&e.addRequiredFields("iteration",n,r),i.iteration&&e.addRequiredFields("release",n,r),e.fire("prepareChanges",i)},c=function(t){e.fire("applyChanges",t.data.changes)};e.store.on({eventName:"beforeSave",type:a,listener:this},d).on({eventName:"afterSave",type:a,listener:this},c),this.store.get(a,s).done({success:t.done,scope:t})},addRequiredFields:function(t,i,n){var a=e.detect(i,function(e){return e.hasOwnProperty(t)});a?e.each(n,function(i){e.any(a[t],function(e){return i==e})||a[t].push(i)}):(a={},a[t]=n,i.push(a))}});return a});