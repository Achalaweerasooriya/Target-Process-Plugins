define(["Underscore","tau/core/model-base","tau/core/termProcessor"],function(_,ModelBase,termProcessorClass){var initialDataProcessor=function(model){this.model=model};initialDataProcessor.prototype={getFields:function(){var fields=_.map(this.model.config.entities,function(item,key){return{type:item.type,isReference:item.isReference}});return fields},getCommands:function(){var commands=_.map(this.model.config.entities,function(item){var c={};return item.type=="owner"?c[item.type]=["id","firstName","lastName"]:c[item.type]=["id","name"],c});return commands},setEntityType:function(entityType){this.entityType=entityType},initializeTerms:function(terms){this.termProcessor=new termProcessorClass(terms)},done:function(results){var configurator=this.config.context.configurator,data=results[0].data,evt={entities:[]},fields=this.getFields();for(var i=0,len=fields.length;i<len;i++){var type=fields[i].type,val=data[type]||{},item={type:type,value:{id:null,name:""}};if(val.id)if(type=="owner"){var user=val;item.value={id:user.id,name:[user.firstName,user.lastName].join(" "),role:user.role,avatar:[configurator.getApplicationPath(),"/Avatar.ashx?UserId=",user.id,"&size=32"].join("")}}else item.value={id:val.id,name:val.name},fields[i].isReference&&(item.externalUrl=[configurator.getApplicationPath(),"/View.aspx?noRedirect=1&id=",val.id].join(""),item.applicationUrl="#"+item.type+"/"+item.value.id);evt.entities.push(item)}this.model.bus.fire("dataBind",evt)}};var additionalInfoModel=ModelBase.extend({onInit:function(){var self=this,proc=new initialDataProcessor(this),ctx=this.config.context,entityTypeName=ctx.entity.entityType.name,entityId=ctx.entity.id;proc.setEntityType(entityTypeName),proc.initializeTerms(ctx.applicationContext.processes[0].terms);var cmdSettings={id:entityId,fields:["id"]},fields=proc.getCommands();cmdSettings.fields=cmdSettings.fields.concat(fields);var beforeSaveCallback=function(evt){var changes=evt.data.changes,requiredUpdates=evt.data.cmd.config.fields,reguiredFields=["id","name"];changes.release&&entityTypeName!=="iteration"&&self.addRequiredFields("iteration",requiredUpdates,reguiredFields),changes.iteration&&self.addRequiredFields("release",requiredUpdates,reguiredFields),self.fire("prepareChanges",changes)},afterSaveCallback=function(evt){self.fire("applyChanges",evt.data.changes)};self.store.on({eventName:"beforeSave",type:entityTypeName,listener:this},beforeSaveCallback).on({eventName:"afterSave",type:entityTypeName,listener:this},afterSaveCallback),this.store.get(entityTypeName,cmdSettings).done({success:proc.done,scope:proc})},addRequiredFields:function(propertyName,requiredUpdates,requiredFields){var requiredFieldConfig=_.detect(requiredUpdates,function(field){return field.hasOwnProperty(propertyName)});requiredFieldConfig?_.each(requiredFields,function(requiredField){_.any(requiredFieldConfig[propertyName],function(fld){return requiredField==fld})||requiredFieldConfig[propertyName].push(requiredField)}):(requiredFieldConfig={},requiredFieldConfig[propertyName]=requiredFields,requiredUpdates.push(requiredFieldConfig))}});return additionalInfoModel})