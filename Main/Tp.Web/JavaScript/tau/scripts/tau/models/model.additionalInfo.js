define(["Underscore","tau/core/model-base","tau/core/termProcessor","tau/utils/utils.convertUserName"],function(e,t,i,n){var a=function(e){this.model=e};a.prototype={getFields:function(){var t=e.map(this.model.config.entities,function(e){return{type:e.type,isReference:e.isReference}});return t},getCommands:function(){var t=e.map(this.model.config.entities,function(e){var t={};return t[e.type]="owner"==e.type?["id","firstName","lastName"]:["id","name"],t});return t},setEntityType:function(e){this.entityType=e},initializeTerms:function(e){this.termProcessor=new i(e)},done:function(e){for(var t=this.config.context.configurator,i=e[0].data,a={entities:[]},r=this.getFields(),s=0,o=r.length;o>s;s++){var d=r[s].type,c=i[d]||{},u={type:d,value:{id:null,name:""}};if(c.id)if("owner"==d){var l=c;u.value={id:l.id,name:n.getFullName(l),role:l.role,avatar:[t.getApplicationPath(),"/avatar.ashx?UserId=",l.id,"&size=32"].join("")}}else u.value={id:c.id,name:c.name},r[s].isReference&&(u.applicationUrl="#"+u.type+"/"+u.value.id);a.entities.push(u)}this.model.bus.fire("dataBind",a)}};var r=t.extend({onInit:function(){var e=this,t=new a(this),i=this.config.context,n=i.entity.entityType.name,r=i.entity.id;t.setEntityType(n),t.initializeTerms(i.applicationContext.processes[0].terms);var s={id:r,fields:["id"]},o=t.getCommands();s.fields=s.fields.concat(o);var d=function(t){var i=t.data.changes,a=t.data.cmd.config.fields,r=["id","name"];i.release&&"iteration"!==n&&e.addRequiredFields("iteration",a,r),i.iteration&&e.addRequiredFields("release",a,r),e.fire("prepareChanges",i)},c=function(t){e.fire("applyChanges",t.data.changes)};e.store.on({eventName:"beforeSave",type:n,listener:this},d).on({eventName:"afterSave",type:n,listener:this},c),this.store.get(n,s).done({success:t.done,scope:t})},addRequiredFields:function(t,i,n){var a=e.detect(i,function(e){return e.hasOwnProperty(t)});a?e.each(n,function(i){e.any(a[t],function(e){return i==e})||a[t].push(i)}):(a={},a[t]=n,i.push(a))}});return r});