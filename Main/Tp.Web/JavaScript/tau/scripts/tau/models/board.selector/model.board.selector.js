define(["Underscore","jQuery","tau/core/extension.base","tau/core/bus","tau/core/templates-factory"],function(e,i,t,r,n){var s=r.extend({init:function(e){this.id=null,this.boardSettings=null,this.bus=e,this.bus.unbind(this),this.bus.on("boardSettings.ready",function(e){var i=e.data.boardSettings,t=i.settings.id;"none"===t&&this.id||(t&&this.id&&t!=this.id?(this.id=t,this.boardSettings=i,this.fire("changed",{entity:{id:t,type:"board"},boardSettings:i})):(this.id=t,this.boardSettings=i,this.fire("ready",{entity:{id:t,type:"board"},boardSettings:i})))},this)},reset:function(){this.id=null,this.boardSettings=null},getCurrent:function(e){e({entity:{id:this.id,type:"board"},boardSettings:this.boardSettings})}}),a={init:function(){this.template=n.get("board.selector.item")},getItemData:function(e,i){var t=e.key,r={key:t,ownerIds:e.ownerIds,name:e.name||t,isShared:e.isShared===!0,acid:e.acid||"",menuIsVisible:e.menuIsVisible,priority:e.menuNumericPriority||999999,viewMode:e.viewMode||"board"};return r.isActive=i,r.menuNumericPriority=r.priority,r},renderItem:function(e){return this.template.bind({},e)}};return t.extend({resetLifecycle:!0,init:function(e){this._super(e),this.bsService=new s(e.bus),this.bsService.on("ready",function(e){this.fire("bsServiceData.ready",e)},this),this.boardItemService=a,this.boardItemService.init(),this.fire("boardItemService.ready",a)},"bus refresh":function(){this.bsService.unbind(this)},"bus bsServiceData.ready:last + beforeInit":function(i,t,r){var n=r.config.context.configurator;this.bsService.unbind(this),this.bsService.on("changed",function(e,i){this.fire("_boardSettings.ready",i.boardSettings),this.fire("currentBoard.changed",i.entity),this.fire("currentBoard.ready",i.entity)},this),this.bsService.getCurrent(e.bind(function(e){var i=e.boardSettings;this.fire("_boardSettings.ready",e.boardSettings);var t=i.getGroupName();this.fire("storageConfig.ready",{groupName:t}),this.fire("currentBoard.ready",e.entity)},this)),this.fire("configurator.ready",n)},subscribeToBoardServiceChanges:function(e){e.removeAllListeners(this),e.on("service.boards.api.board.created",function(){this.fire("refresh")}.bind(this),this),e.on("service.boards.api.board.removed",function(e,i){this.fire("board.removed",{id:i})}.bind(this),this)},"bus board.removed > currentBoard.changed":function(){this.fire("refresh")},"bus _boardSettings.ready:last + boards.ready:last":function(i,t,r){var n=e.bind(this.fire,this);t.unbind({listener:this}),t.bind({fields:["name","isShared","viewMode","acid"],listener:this,callback:function(i){var s=e.find(r,function(e){return e.key===t.settings.id});e.extend(s,i),setTimeout(function(){n("boardUpdated",s)},1e3)}})},getBoardsByUser:function(e,i){return e.getBoardsForUser(i.id).then(function(e){return e.data.items})},"bus configurator.ready + storageConfig.ready":function(e,i){var t=i.getLoggedUser(),r=i.getBoardApiService();this.getBoardsByUser(r,t).then(function(e){i.getFeaturesService().isEnabled("boardSettings.cache")&&r.setBoardsCache(e),this.fire("boards.ready",e)}.bind(this)),this.subscribeToBoardServiceChanges(r)},"bus currentBoard.ready > boards.ready":function(i,t,r){var n=e.bind(this.fire,this),s=this,a=e(r).chain().map(function(e){return s.boardItemService.getItemData(e,e.key===t.id)}).sortBy(function(e){return e.priority}).value(),o=e.groupBy(a,function(e){return e.menuIsVisible?"menu":"more"}),d=o.more||[];t=e.find(d,function(e){return e.isActive});var u=o.more||[],c={items:o.menu||[],itemsMore:u,currentItem:t};n("dataBind",c)}})});