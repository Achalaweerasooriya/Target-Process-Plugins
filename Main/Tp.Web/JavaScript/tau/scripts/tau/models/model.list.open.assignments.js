define(["Underscore","tau/core/model-base"],function(e,t){var n,i=0;return n=t.extend({name:"model.list.open.assignments",createSubscription:function(t,n){var a=this,r=(this.config.context.applicationContext.loggedUser,this.config.context.entity.id);a.store.on({eventName:"afterSave",type:t,listener:a},function(d){var s=d.data.id;d.data&&d.data.cmd&&"assignment"==d.data.cmd.type&&n(s)&&a.store.get(t,{id:s,fields:[{assignments:[{generalUser:["id"]}]}]}).done(function(t){var n=t[0].data.assignments,d=e.find(n,function(e){return e.generalUser.id===r});(0===n.length||void 0===d)&&(i--,0===i&&a.fire("refresh"),a.fire("model.assignment.did.removed",{id:s}))})}),a.store.on({eventName:"beforeSave",type:t,listener:a},function(e){var t=e.data.id;if(n(t)&&e.data.changes.entityState){var i=e.data.cmd,a=i.config.$include=i.config.$include||[];a.push({entityState:["id","isFinal"]})}}),a.store.on({eventName:"afterSave",type:t,listener:a},function(e){var t=e.data.id;if(n(t)){var r=e.data.changes.entityState;if(r)a.store.get("entityState",{id:r.id,fields:["isFinal"]}).done(function(e){var n=e[0].data;n.isFinal&&(i--,0===i&&a.fire("refresh"),a.fire("model.assignment.did.removed",{id:t}))});else{var d=e.data.changes.responsible;d&&(i--,0===i&&a.fire("refresh"),a.fire("model.assignment.did.removed",{id:t}))}}})},"bus afterItemsProvided":function(t){var n=this,a=t.data.data;if(i=a.length,a&&a.length){var r=function(t){return e(a).detect(function(e){return e.id==t})};e(a).chain().map(function(e){return e.__type}).unique().each(function(e){n.createSubscription(e,r)})}}})});