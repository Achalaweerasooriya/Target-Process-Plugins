define(["Underscore","tau/core/extension.base","tau/libs/inviter/inviter"],function(_,BaseModel,Inviter){return BaseModel.extend({"bus configurator.ready:last + team.add.ready":function(evt,configurator,teamData){var self=this,store=configurator.getStore();store.save("team",{failureGlobal:!1,$set:{name:_.trim(teamData.name),icon:_.trim(_.asString(teamData.icon))||null}},{success:function(result){self.fire("team.saved",result.data)},failure:function(result){self.fire("team.add.failure",result.data.response.Message)}}).done();var inviter=new Inviter(configurator);inviter.invite(teamData.members).done(function(members){self.fire("teamMembers.saved",members)})},"bus configurator.ready:last + team.add.ready + team.saved + teamMembers.saved":function(evt,configurator,teamData,team,members){var self=this,store=configurator.getStore(),successed=_.compact(_.pluck(members,"success")),failed=_.compact(_.pluck(members,"failure"));if(failed.length){var message="Can't assign users.";this.fire("team.add.nonFatalFailure",message)}successed=_.filter(successed,function(id){return id!=configurator.getLoggedUser().id});var set={teamMembers:_.map(successed,function(id){return{user:{id:id}}})};store.save("team",{id:team.id,$set:set,fields:["id","name","icon",{teamMembers:[{user:["id","firstName","lastName","avatarUri"]},{role:["id","name"]}]}]}).done(function(res){self.fire("teamMembers.connected",res[0].data)})},"bus team.saved + teamMembers.saved + teamMembers.connected":function(evt,teamSimple,members,teamFull){this.fire("team.add.success",teamFull)}})})