define(["Underscore","tau/core/extension.base","tau/libs/inviter/inviter"],function(_,BaseModel,Inviter){return BaseModel.extend({"bus configurator.ready:last + project.add.ready":function(evt,configurator,projectData){var self=this,store=configurator.getStore();store.save("project",{failureGlobal:!1,$set:{name:_.trim(projectData.name),color:_.trim(_.asString(projectData.color))||null,process:{id:projectData.process}}},{success:function(result){self.fire("project.saved",result.data)},failure:function(result){self.fire("project.add.failure",result.data.response.Message)}}).done();var inviter=new Inviter(configurator);inviter.invite(projectData.members).done(function(members){self.fire("projectMembers.saved",members)})},"bus configurator.ready:last + project.add.ready + project.saved + projectMembers.saved":function(evt,configurator,projectData,project,members){var self=this,store=configurator.getStore(),successed=_.compact(_.pluck(members,"success")),failed=_.compact(_.pluck(members,"failure"));if(failed.length){var message="Can't assign users.";this.fire("project.add.nonFatalFailure",message)}successed=_.filter(successed,function(id){return id!=configurator.getLoggedUser().id});var set={projectMembers:_.map(successed,function(id){return{user:{id:id}}})};store.save("project",{id:project.id,$set:set,fields:["id","name","color",{projectMembers:[{user:["id","firstName","lastName","avatarUri"]},{role:["id","name"]}]}]}).done(function(res){self.fire("projectMembers.connected",res[0].data)})},"bus project.saved + projectMembers.saved + projectMembers.connected":function(evt,projectSimple,members,projectFull){this.fire("project.add.success",projectFull)}})})