define(["Underscore","tau/core/extension.base"],function(e,t){var i={};return t.extend({ITEM_CATEGORY:{TEAM:"Team",PROJECT:"Project"},"bus beforeInit":function(e){var t=e.data.config.context.configurator;this.fire("configurator.ready",t),this.fire("acidStore.ready",t.getAppStateStore()),this.fire("store.ready",t.getStore()),this.fire("contextStore.ready",t.getApplicationContextService())},"bus configurator.ready:last + acid.ready":function(e,t,n){t.getStateManager().unbind(i);var o=this;t.getStateManager().bind({paramId:"appConfig",fieldName:"acid",listener:i,callback:function(e){var t=e.value;n!=t&&o._refreshModel()}})},"bus acidStore.ready":function(e,t){t.get({fields:["acid"],callback:function(e){this.fire("acid.ready",e.acid||"")}.bind(this)}),t.unbind({listener:this}),t.bind({fields:["acid","appContext"],listener:this,callback:function(){this._refreshModel()}.bind(this)})},"bus configurator.ready:last + store.ready":function(e,t,i){this._setupStore(t,i)},"bus contextStore.ready":function(e,t){t.removeAllListeners(this),t.on("refreshChoice.after",function(){this._refreshModel()},this)},"bus contextStore.ready:last + acid.ready + configurator.ready:last + store.ready:last":function(e,t,i,n,o){t.getApplicationContext({acid:i},{success:function(e){n.getFeaturesService().isEnabled("context.v2")&&(n.getPrototypeContextEntityService().updateContextPrototype(e),this.fire("projects.ready",e.projects),this.fire("teams.ready",e.teams)),this.fire("context.ready",e)}.bind(this),failure:function(){this.fire("context.ready",{appContext:{teamContext:{},projectContext:{}}}),n.getFeaturesService().isEnabled("context.v2")&&(this._getProjects(o),this._getTeams(o))}.bind(this)})},prepareModel:function(t,i,n){var o=n.appContext.teamContext;o.items=n.selectedTeams;var a=this._process(t,o,this.ITEM_CATEGORY.TEAM),r=n.appContext.projectContext;r.items=n.selectedProjects;var s=this._process(i,r,this.ITEM_CATEGORY.PROJECT),c=this._getModelData(n,a,s);return this._selectedCache={projects:e.pluck(s.selection,"id"),teams:e.pluck(a.selection,"id")},c},"bus teams.ready + projects.ready + context.ready":function(e,t,i,n){var o=this.prepareModel(t,i,n);this.fire("dataBind",o),this._trackData(o)},_refreshModel:function(){this.resetSubscriptions(),this.fire("refresh")},_getProjects:function(t){t.get("project",{fields:["id","name","color","isActive","abbreviation"]}).done(function(t){var i=e.filter(t[0].data,function(e){return e.isActive});this.fire("projects.ready",i)}.bind(this))},_getTeams:function(e){e.get("team",{fields:["id","name","icon","abbreviation"]}).done(function(e){var t=e[0].data;this.fire("teams.ready",t)}.bind(this))},_setupStore:function(e,t){e.getFeaturesService().isEnabled("context.v2")||(this._getProjects(t),this._getTeams(t))},_getModelData:function(e,t,i){return{acid:e.acid,selectedTeams:t.selection,selectedTeamsCount:t.selectionLength,selectedProjects:i.selection,selectedProjectsCount:i.selectionLength,teamsCount:t.list.length}},_trackData:function(e){this.fire("application.context.data",e)},_process:function(t,i,n){var o=function(e){return("None"==e.id?"0":"1")+(e.selected?"0_":"1_")+e.name.toUpperCase()},a=n.toLowerCase(),r={id:"None",name:"No "+a,abbreviation:"No "+a,icon:null,whiteIcon:null,displayableIcon:null},s={id:"Any",name:"Any "+n,abbreviation:"Any "+n,icon:null,whiteIcon:null,displayableIcon:null},c=t;c.unshift(r);var l=i.items||[];i.no&&l.unshift(r);var d=[],u=!1;if(0===l.length)d=[s],u=!0;else if(l.length==c.length&&1==c.length)d=[r];else if(l.length>=c.length)d=[s],u=!0;else{var f=e.filter(c,function(t){return e.indexOf(e.pluck(l,"id"),t.id)>=0});d=0===f.length?[r]:f}d=e.sortBy(d,o);var h=e.pluck(d,"id");c=e.chain(c).map(function(t){return{id:t.id,name:t.name,icon:t.icon,whiteIcon:null,displayableIcon:t.icon,color:t.color,selected:!u&&e.indexOf(h,t.id)>=0,isSupportView:t.id>0}}).sortBy(o).value(),e.each(d,function(e){"None"==e.id||"Any"==e.id?(e.icon=a,e.whiteIcon=a):null!=e.icon&&(e.icon=e.icon,e.whiteIcon=e.icon+"_white"),e.displayableIcon=e.whiteIcon||e.icon});var p=d.length,g=d.slice(0,2);return d.length>1&&d[0]==r&&(r.icon=null,r.displayableIcon=null),{list:c,selection:d,selectionLength:p,selectionShow:g}}})});