define(["Underscore","tau/core/extension.base","tau/models/board.context.selector/model.board.context.selector.base"],function(e,t,i){var r=["id","name","color","isActive","abbreviation","process[id,name]"];return t.extend({"bus beforeInit":function(e){var t=e.data.config.context.configurator;this._createContextSelectorModel(t),this.fire("configurator.ready",t),this.fire("acidStore.ready",t.getAppStateStore()),this.fire("store.ready",t.getStore()),this.fire("contextStore.ready",t.getApplicationContextService())},"bus configurator.ready:last + acid.ready":function(e,t,i){t.getStateManager().unbind(this),t.getStateManager().bind({paramId:"appConfig",fieldName:"acid",listener:this,callback:function(e){var t=e.value;i!=t&&this._refreshModel()}.bind(this)})},"bus acidStore.ready":function(e,t){t.get({fields:["acid"],callback:function(e){this.fire("acid.ready",e.acid||"")}.bind(this)}),t.unbind({listener:this}),t.bind({fields:["acid","appContext"],listener:this,callback:function(){this._refreshModel()}.bind(this)})},"bus acidStore.ready:last + destroy":function(e,t){t.unbind({listener:this})},"bus configurator.ready:last + store.ready":function(e,t,i){this._setupStore(t,i)},"bus contextStore.ready":function(e,t){t.removeAllListeners(this),t.on("refreshChoice.after",function(){this._refreshModel()},this)},"bus contextStore.ready:last + acid.ready + configurator.ready:last + store.ready:last":function(e,t,i,r,a){t.getApplicationContext({acid:i},{success:function(e){r.getPrototypeContextEntityService().updateContextPrototype(e),this.fire("projects.ready",e.projects),this.fire("teams.ready",e.teams),this.fire("programs.ready",e.programs),this.fire("context.ready",e),this.fire("track.new.context",e)}.bind(this),failure:function(){this.fire("context.ready",{appContext:{teamContext:{},projectContext:{}},projects:[],selectedProjects:[]}),this._getProjects(a),this._getTeams(a),this._getPrograms(a)}.bind(this)})},_createContextSelectorModel:function(e){this._model=new i(e.getFeaturesService())
},prepareModel:function(e,t,i){return this._model.getData(e,t,i)},"bus teams.ready + projects.ready + context.ready":function(e,t,i,r){var a=this.prepareModel(t,i,r);this.fire("dataBind",a),this._trackData(a)},_refreshModel:function(){this.resetSubscriptions(),this.fire("refresh")},_getProjects:function(t){t.get("project",{fields:["id","name","color","isActive","abbreviation",{process:["id","name"]},{program:["id"]}]}).done(function(t){var i=e.filter(t[0].data,function(e){return e.isActive});this.fire("projects.ready",i)}.bind(this))},_getPrograms:function(e){e.get("program",{fields:["id","name",{projects:r}]}).done(function(e){this.fire("programs.ready",e[0].data)}.bind(this))},_getTeams:function(e){e.get("team",{fields:["id","name","icon","abbreviation"]}).done(function(e){var t=e[0].data;this.fire("teams.ready",t)}.bind(this))},_setupStore:function(e,t){e.getFeaturesService().isEnabled("context.v2")||(this._getProjects(t),this._getTeams(t))},_trackData:function(e){this.fire("application.context.data",e)}})});