define(["Underscore","jQuery","tau/core/class"],function(e,n,t){var i=function(){},s=function(n,t){var i=new Array(n.length);return function(s){var a=s.uid,l=s.data;i[a]=l,n=e(n).without(a),0===n.length&&t(i)}};return t.extend({init:function(n,t){var i=this;i.settings=n,i.sources=t,i.callbacksMap=[],i.responses=[],i.fieldsRetrieved=[],i.commonCallback=e.bind(function(e,n){var t=this,i=e.data,s=t.mergeChanges(i,n);null!==s&&t.applyCallback(s)},i)},getGroupName:function(){return this.settings.groupName},applyCallback:function(n){for(var t=e(n).keys(),i=e.clone(this.callbacksMap),s=0;s<i.length;s++){var a=i[s];this.matchCommandCallback(t,a)&&!a.isDeleted&&a.callback.apply(a.listener,[n])}},matchCommandCallback:function(n,t){var i=e.intersection(n,t.fields);return i.length>0},each:function(n,t){if(this.sources.length)e(this.sources).each(n);else{var s=t||i;s()}},mergeChanges:function(n,t){for(var i=this,s=i.settings,a=e(n).keys(),l=null,c=0;c<a.length;c++){var r=a[c];i.markFieldsRetrieved(r),e.isEqual(s[r],n[r])||(l=l||{},e.isNumber(t)?((i.responses[t]=i.responses[t]||[])[r]=e.cloneDeep(n[r]),l[r]=s[r]=i.getField(r)):l[r]=s[r]=e.cloneDeep(n[r]))}return l},getField:function(n){var t;return e.each(this.responses,function(i){e.isNull(i[n])||e.isUndefined(i[n])||e.isNaN(i[n])||(t=i[n])}),t},markFieldsRetrieved:function(n){n=e.isString(n)?[n]:n,this.fieldsRetrieved=e.union(this.fieldsRetrieved,n)},selectNotRetrievedFields:function(n){return e.difference(n,this.fieldsRetrieved)},get:function(t){var a=this;e(t).defaults({callback:i});var l=a.settings,c={},r=a.sources,u=e.range(r.length),o=a.selectNotRetrievedFields(t.fields),d=function(i){a.markFieldsRetrieved(o),e(i).each(function(n,t){a.responses[t]=e.extend(a.responses[t]||{},n);for(var t=0;t<o.length;t++){var i=o[t],s=null!==n[i]?n[i]:l[i];e.isNaN(s)||e.isNull(s)||e.isUndefined(s)||(c[i]=s)}}),e(l).extend(c);var s={};n.extend(!0,s,l),t.callback(s)};if(0===o.length)d([]);else{var f=s(u,d);a.each(function(e,n){e.get({uid:n,fields:o,callback:f})},function(){d([])})}},set:function(n){var t=this;e(n).defaults({callback:i});var a=t.sources,l=e.range(a.length),c=function(){},r=s(l,c);t.each(function(e,t){e.set({uid:t,set:n.set,callback:function(e){r.call(this,e,t)}})},function(){c([])}),t.commonCallback({data:n.set}),n.callback(t.settings)},registerSubscription:function(e){var n=this;return n.callbacksMap.push(e),this.commonCallback},unregisterSubscription:function(n){var t=this;0!=t.callbacksMap.length&&(t.callbacksMap=e.reject(t.callbacksMap,function(e){var t=n===e.listener;return t&&(e.isDeleted=!0),t}))},bind:function(e){var n=this,t=n.registerSubscription(e);n.each(function(n,i){n.bind({uid:i,fields:e.fields,listener:e.listener,callback:function(e){t.call(this,e,i)}})})},unbind:function(e){var n=this;n.each(function(n){n.unbind({listener:e.listener})}),n.unregisterSubscription(e.listener)},dispose:function(){var e=this;e.each(function(n){n.unbind({listener:e})}),e.callbacksMap=[]}})});