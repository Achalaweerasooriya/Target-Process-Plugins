define(["Underscore","tau/core/model-base"],function(_,a){var b=function(a,b){},c=a.extend({onInit:function(){this.store.unbind(this);var a={text:this.config.text};this.config.cssClass&&(a.cssClass=this.config.cssClass),this.bus.fire("dataBind",a);var b=this.config.getBadgeText;typeof b=="function"&&(this.fire("beforeGetBadgeText",{prevValue:this.badgeText}),b.call(this,{callback:this.onBadgeTextRetrieved,scope:this}));var c=this.getCollectionFileds();if(_.isArray(c)&&c.length>0){var d=this.config.context.entity.id,e=this.config.context.entity.entityType.name||"general",f=c.join("|");this.config.store.on({type:e,eventName:"afterSave",hasChanges:[f],filter:{id:d},listener:this},_.bind(this.onEntityChanged,this)),this.calculateCount()}},onEntityChanged:function(){var a=this.config.context.entity.id,b=this.config.context.entity.entityType.name||"general";this.config.store.evictProperties(a,b,_.map(this.getCollectionFileds(),function(a){return a+"-count"})),this.calculateCount()},calculateCount:function(){var a=this,b=a.config.context,c=b.entity.entityType.name,d=[],e=this.config.countFieldNames;for(var f=0;f<e.length;f++)d.push(e[f]+"-count");var g={id:b.entity.id,fields:d};a.store.get(c,g,{success:this.countersRetreived,scope:this}).done()},getCollectionFileds:function(){var a=_.reject(this.config.countFieldNames,function(a){return a=="id"});return a},countersRetreived:function(a){var b=this.getCollectionFileds(),c=a.data,d=0;for(var e=0;e<b.length;e++)d+=c[b[e]+"-count"];this.fire("setBadgeText",{text:d})},onBadgeTextRetrieved:function(a){var b=a[this.config.badgeFieldName];this.badgeText=b,this.bus?this.bus.fire("setBadgeText",{text:b}):this.fire("badgeTextChanged",{text:b})}});return c})