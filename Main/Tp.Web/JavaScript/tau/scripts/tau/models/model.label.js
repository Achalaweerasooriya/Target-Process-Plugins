define(["Underscore","tau/core/model-base"],function(t,e){var i=e.extend({onInit:function(){this.store.unbind(this);var e={text:this.config.text};this.config.cssClass&&(e.cssClass=this.config.cssClass),this.bus.fire("dataBind",e);var i=this.getCollectionFields();if(t.isArray(i)&&i.length>0){var n=this.config.context.entity.id,s=this.config.context.entity.entityType.name||"general",o=i.join("|");this.config.store.on({type:s,eventName:"afterSave",hasChanges:[o],filter:{id:n},listener:this},t.bind(this.entityChanged,this)),this._updateBadge()}},entityChanged:function(){var e=this.config.context.entity.id,i=this.config.context.entity.entityType.name||"general";this.config.store.evictProperties(e,i,t.map(this.getCollectionFields(),function(t){return t+"-count"})),this._updateBadge()},_updateBadge:function(){for(var e=this.config.context,i=e.entity.entityType.name,n=[],s=this.config.countFieldNames,o=0;o<s.length;o++)n.push(s[o]+"-count");var a={id:e.entity.id,fields:n};this.store.freeze(!0).done(t.bind(function(t){this.store.get(i,a,this.safeCallback(this.badgeDataRetrieved)).done(),t.unfreeze()},this))},badgeDataRetrieved:function(t){for(var e=t.data,i=this.getCollectionFields(),n=0,s=0;s<i.length;s++)n+=e[i[s]+"-count"];this.fire("setBadgeData",n.toString())},getCollectionFields:function(){return t.reject(this.config.countFieldNames,function(t){return"id"==t})}});return i});