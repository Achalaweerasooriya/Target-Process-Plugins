define(["Underscore","tau/core/model-base"],function(t,e){var i=e.extend({onInit:function(){this.store.unbind(this);var e={text:this.config.text};this.config.cssClass&&(e.cssClass=this.config.cssClass),this.bus.fire("dataBind",e);var i=this.getCollectionFields();if(t.isArray(i)&&i.length>0){var n=this.config.context.entity.id,s=this.config.context.entity.entityType.name||"general",a=i.join("|");this.config.store.on({type:s,eventName:"afterSave",hasChanges:[a],filter:{id:n},listener:this},t.bind(this.entityChanged,this)),this._updateBadge()}},"bus entity.changed":function(){this.entityChanged()},_createCountFieldName:function(t){return t+"-count"},entityChanged:function(){var e=this.config.context.entity,i=e.entityType.name||"general";this.config.store.evictProperties(e.id,i,t.map(this.getCollectionFields(),this._createCountFieldName)),this._updateBadge()},_updateBadge:function(){var e=this.config.context.entity,i=e.entityType.name,n=t.map(this.config.countFieldNames,this._createCountFieldName),s={id:e.id,fields:n};this.store.freeze(!0).done(this.safeCallback(function(t){this.store.get(i,s,this.safeCallback(this.badgeDataRetrieved)).done(),t.unfreeze()}))},badgeDataRetrieved:function(t){for(var e=t.data,i=this.getCollectionFields(),n=0,s=0;s<i.length;s++)n+=e[this._createCountFieldName(i[s])];this.fire("setBadgeData",n.toString())},getCollectionFields:function(){return t.reject(this.config.countFieldNames,function(t){return"id"==t})}});return i});