define(["Underscore","tau/core/model-base","tau/utils/utils.htmlConverter","tau/utils/utils.date"],function(e,t,u,n){var i=t.extend({_customFieldProcessors:{RichText:function(e){return e.value=u.fromSourceToHtml(e.value),e},Date:function(e){return e.value=n.format.date.short(n.convertToTimezone(e.value)),e.output=e.value,e},DropDown:function(t){return t.options=this._getOptions(t),t.value=e.asString(t.value),t.output=e.asString(t.value),t},Entity:function(t,u){return t.value=t.value||{},t.options=this._getOptions(t),t.value=e.defaults(t.value,{id:null,name:"",kind:null}),t.value.__type=t.value.kind,t.value.url=t.value.__type?u.configurator.getUrlBuilder().getNewViewUrl(t.value.id,t.value.__type,!0):null,t.output=t.value.name+"",t},MultipleSelectionList:function(t){return t.options=this._getOptions(t),t.value?(t.value=e.asString(t.value).split(","),t.output=t.value.join(", ")):(t.value=null,t.output=""),t},Number:function(t,u){return t.value=(t.value||e.isNumber(t.value)?parseFloat(t.value)+"":"").replace(".",u.applicationContext.culture.decimalSeparator),t.output=t.value,t},URL:function(t){return t.value=t.value||{},e.defaults(t.value,{url:"",title:""}),t.options=null,t},TemplatedURL:function(t){t.value=t.value||"",t.isEmpty=""===t.value;var u=e.compact(t.value.split(/\s*,\s*/g)),n=t.options||"";return u=e.map(u,function(e){return{title:e,url:n.replace("{0}",e)}}),t.output=u,t},_getOptions:function(t){return t.options?e.asString(t.options).split("\r\n"):[]}},_process:function(e,t){return e.type in this._customFieldProcessors&&(e=this._customFieldProcessors[e.type](e,t.context)),e},createConfiguration:function(t,u,n,i,o){var a=(t.type||"").toLowerCase(),r=e.find(n,function(e){return e.type.toLowerCase()==a&&e.name==t.name}),l=e.find(i,function(e){return e.type.toLowerCase()==a&&e.name==t.name}),s={};if(r&&l)s={name:l.name,type:l.type,required:r.required,listed:r.listed,value:l.value,options:r.value,actionReset:{enable:l.value&&!r.required},output:l.value};else{if(!r||l)throw new Error('No valid configuration for field "'+t.name+'"');s={name:r.name,type:r.type,required:r.required,listed:r.listed,value:null,options:r.value,output:null}}return s=this._process(s,o)},"bus configurationProvided":function(t){var u=t.data;e.isEmpty(u)||this.fire("dataBind",u),this.configuration=u},"bus beforeInit":function(e){var t=e.data.config;this.store=t.store||this.store;var u=t.context.entity,n=t.context.getCustomFields(),i=t.customField||t.data,o=this,a={name:i.name,type:i.type};this.store.get(u.entityType.name,{id:u.id,fields:["id","customFields"]}).done({success:function(e){var i=e[0].data.customFields,r=o.createConfiguration(a,u,n,i,t);o.fire("configurationProvided",r)}})}});return i});