define(["Underscore","tau/core/model-base","tau/utils/utils.htmlConverter","tau/utils/utils.date","tau/utils/utils.customFields"],function(t,e,u,n,i){var a=function(t){t.value="n/a",t.output="n/a",t.tooltip="Calculation formula is invalid"},o=e.extend({_customFieldProcessors:{RichText:function(t){return t.value=u.fromSourceToHtml(t.value),t},Date:function(t){var e=t.value;return i.isNA(t.value)?a(t):(t.value=n.format.date.short(n.convertToTimezone(e)),t.output=t.value),t},DropDown:function(e){return e.options=this._getOptions(e),e.value=t.asString(e.value),e.output=t.asString(e.value),e},Text:function(t){return"n/a "==t.value&&a(t),t},Entity:function(e,u){return e.value=e.value||{},e.options=this._getOptions(e),e.value=t.defaults(e.value,{id:null,name:"",kind:null}),e.value.__type=e.value.kind,e.value.url=e.value.__type?u.configurator.getUrlBuilder().getNewViewUrl(e.value.id,e.value.__type,!0):null,e.output=e.value.name+"",e},MultipleSelectionList:function(e){return e.options=this._getOptions(e),e.value?(e.value=t.asString(e.value).split(","),e.output=e.value.join(", ")):(e.value=null,e.output=""),e},Number:function(e,u){return i.isNA(e.value)?a(e):(e.value=(e.value||t.isNumber(e.value)?Math.round(100*parseFloat(e.value))/100+"":"").replace(".",u.applicationContext.culture.decimalSeparator),e.output=e.value),e},Money:function(e,u){var n="";return(e.value||t.isNumber(e.value))&&(n=i.formatMoney(e.value,u.applicationContext.culture)),e.value=n,e.output=e.value,e},URL:function(e){return e.value=e.value||{},t.defaults(e.value,{url:"",title:""}),e.options=null,e},TemplatedURL:function(e){e.value=e.value||"",e.isEmpty=""===e.value;var u=t.compact(e.value.split(/\s*,\s*/g)),n=e.options||"";return u=t.map(u,function(t){return{title:t,url:n.replace("{0}",t)}}),e.output=u,e},_getOptions:function(e){return e.options?t.asString(e.options).split("\r\n"):[]}},_process:function(t,e){return t.type in this._customFieldProcessors&&(t=this._customFieldProcessors[t.type](t,e.context)),t
},createConfiguration:function(e,u,n,a,o){var l=(e.type||"").toLowerCase(),r=t.find(n,function(t){return t.type.toLowerCase()==l&&t.name==e.name&&t.entityKind.toLowerCase()==e.entityKind.toLowerCase()}),s=t.find(a,function(t){return t.type.toLowerCase()==l&&t.name==e.name}),c={};if(r&&s)c={name:s.name,type:s.type,required:r.required,listed:r.listed,value:s.value,options:r.value,actionReset:{enable:s.value&&!r.required},output:s.value,calculationModel:r.calculationModel,units:i.getUnits(r)};else{if(!r||s)throw new Error('No valid configuration for field "'+e.name+'"');c={name:r.name,type:r.type,required:r.required,listed:r.listed,value:null,calculationModel:r.calculationModel,units:i.getUnits(r),options:r.value,output:null}}return c=this._process(c,o)},"bus configurationProvided":function(e){var u=e.data;t.isEmpty(u)||(this.fire("dataBind",u),t.isEmpty(u.value)&&this.fire("noData")),this.configuration=u},"bus beforeInit":function(t){var e=t.data.config,u=e.context.entity,n=e.context.getCustomFields(),i=e.customField||e.data,a=this,o={name:i.name,type:i.type,entityKind:u.entityType.name},l=this.getCustomFieldsService(e,u);l.getCustomFields.done(function(t){var i=a.createConfiguration(o,u,n,l.adaptResult(t),e);a.fire("configurationProvided",i)}.bind(this))},getCustomFieldsService:function(t,e){return{getCustomFields:this.store.get(e.entityType.name,{id:e.id,fields:["id","customFields"]}),adaptResult:function(t){return t[0].data.customFields}}}});return o});