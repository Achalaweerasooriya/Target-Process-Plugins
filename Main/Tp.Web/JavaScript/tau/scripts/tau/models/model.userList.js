define(["Underscore","tau/core/model-base","tau/utils/utils.textsearch"],function(e,t,r){return t.extend({init:function(e){this._super(e),this.textSearch=new r},"bus setFilter":function(e){this.config.data.filter=e.data.filter,this.fire("refresh",{refreshSelector:".user-list,.footer-box"})},setShowMore:function(e){this.config.data.showMore=e},"bus showMore":function(){this.setShowMore(!0),this.fire("refresh",{refreshSelector:".user-list,.footer-box"})},onInit:function(){this.fire("registerStoreRequest"),this.fire("commitTransaction",{})},"bus projectMembersReady+excludedUserReady+projectRolesReady":function(e,t,r,i){var s=[];!this.excludedUsersContainsLoggedUser(r)&&this.loggedUserInProjectTeam(t)&&(s=[{id:"assign-to-me",title:"Assign To Me"}]);var o=[];this.filterIsNotEmpty()?o=this.getFilteredGroups(i,t,r):(o=this.getGroups(t,r,i),o.length||(this.setShowMore(!0),o=this.getGroups(t,r,i)));var n={headerActions:s,moreAvailable:!1,groups:o};this.fire("extendDataToBind",n),this.fire("dataBind",n)},getGroups:function(e,t,r){for(var i=[],s=0;s<r.length;s++){var o=r[s];if(this.usersForRoleIsVisible(o)){var n=this.getUsersForRole(o,e,t);n.length>0&&i.push({role:o,users:n})}}return i},isStringValidForFilter:function(e){return null!==this.textSearch.match(e,this.config.data.filter)},getFilteredGroups:function(e,t,r){for(var i=[],s=0;s<e.length;s++){for(var o=e[s],n=this.getUsersForRole(o,t,r),a=[],u=0;u<n.length;u++)this.isStringValidForFilter(n[u].name)&&a.push(n[u]);a.length>0&&i.push({role:o,users:a})}return i},usersForRoleIsVisible:function(e){if(this.isMoreAvailable()){var t=this.config.data||{};if(t.hasOwnProperty("roleId"))return e.id===t.roleId;if(t.role)return e.id==t.role.id}return!0},userIsNotExcluded:function(e,t){if(!e.user.isActive)return!1;var r=e.user.id;if(t.constructor!=Array)return r!=t.id;for(var i=0;i<t.length;i++)if(r==t[i].id)return!1;return!0},getUsersForRole:function(e,t,r){for(var i=[],s=0;s<t.length;s++){var o=t[s];o.role.id==e.id&&this.userIsNotExcluded(o,r)&&i.push(this.convertUser(o.user))
}return i.sort(function(e,t){var r=e.name.toLowerCase(),i=t.name.toLowerCase();return i>r?-1:r>i?1:0}),i},convertUser:function(t){var r=e.trim(t.email);(t.firstName||t.lastName)&&(r=e.trim([t.firstName,t.lastName].join(" ")));var i=this.config.context.configurator;return{id:t.id,name:r,role:t.role,avatar:[i.getApplicationPath(),"/Avatar.ashx?UserId=",t.id,"&size=32"].join("")}},getLoggedUser:function(){return this.config.context.configurator.getLoggedUser()||this.config.context.getLoggedUser()},loggedUserInProjectTeam:function(t){var r=this.getLoggedUser();return e.any(t,function(e){return e.user.id===r.id})},excludedUsersContainsLoggedUser:function(t){var r=this.getLoggedUser();return e.any(t,function(e){return e.id===r.id})},filterIsNotEmpty:function(){return this.config.data.filter&&this.config.data.filter.length},filterIsEmpty:function(){return!this.filterIsNotEmpty()},isMoreAvailable:function(){var e=this.config.data;return this.filterIsEmpty()&&e.showMore!==!0&&(e.hasOwnProperty("roleId")||e.hasOwnProperty("role"))}})});