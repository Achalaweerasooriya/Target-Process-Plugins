define(["Underscore","tau/core/model-base","tau/utils/utils.textsearch"],function(e,r,t){return r.extend({init:function(e){this._super(e),this.textSearch=new t},"bus setFilter":function(e){this.config.data.filter=e.data.filter,this.fire("refresh",{refreshSelector:".user-list,.footer-box"})},setShowMore:function(e){this.config.data.showMore=e},"bus showMore":function(){this.setShowMore(!0),this.fire("refresh",{refreshSelector:".user-list,.footer-box"})},onInit:function(){this.fire("registerStoreRequest"),this.fire("commitTransaction",{})},"bus projectMembersReady+excludedUserReady+projectRolesReady":function(e,r,t,i){var s=[];!this.excludedUsersContainsLoggedUser(t)&&this.loggedUserInProjectTeam(r)&&(s=[{id:"assign-to-me",title:"Assign To Me"}]);var o=[];this.filterIsNotEmpty()?o=this.getFilteredGroups(i,r,t):(o=this.getGroups(r,t,i),o.length||(this.setShowMore(!0),o=this.getGroups(r,t,i)));var n={headerActions:s,moreAvailable:!1,groups:o};this.fire("extendDataToBind",n),this.fire("dataBind",n)},getGroups:function(e,r,t){for(var i=[],s=0;s<t.length;s++){var o=t[s];if(this.usersForRoleIsVisible(o)){var n=this.getUsersForRole(o,e,r);n.length>0&&i.push({role:o,users:n})}}return i},isStringValidForFilter:function(e){return null!==this.textSearch.match(e,this.config.data.filter)},getFilteredGroups:function(e,r,t){for(var i=[],s=0;s<e.length;s++){for(var o=e[s],n=this.getUsersForRole(o,r,t),a=[],u=0;u<n.length;u++)this.isStringValidForFilter(n[u].name)&&a.push(n[u]);a.length>0&&i.push({role:o,users:a})}return i},usersForRoleIsVisible:function(e){if(this.isMoreAvailable()){var r=this.config.data||{};if(r.hasOwnProperty("roleId"))return e.id===r.roleId;if(r.role)return e.id==r.role.id}return!0},userIsNotExcluded:function(e,r){if(!e.user.isActive)return!1;var t=e.user.id;if(r.constructor!=Array)return t!=r.id;for(var i=0;i<r.length;i++)if(t==r[i].id)return!1;return!0},getUsersForRole:function(e,r,t){for(var i=[],s=0;s<r.length;s++){var o=r[s];o.role.id==e.id&&this.userIsNotExcluded(o,t)&&i.push(this.convertUser(o.user))
}return i.sort(function(e,r){var t=e.name.toLowerCase(),i=r.name.toLowerCase();return i>t?-1:t>i?1:0}),i},convertUser:function(r){var t=e.trim(r.email);return(r.firstName||r.lastName)&&(t=e.trim([r.firstName,r.lastName].join(" "))),{id:r.id,name:t,role:r.role,avatar:r.avatarUri+"32"}},getLoggedUser:function(){return this.config.context.configurator.getLoggedUser()||this.config.context.getLoggedUser()},loggedUserInProjectTeam:function(r){var t=this.getLoggedUser();return e.any(r,function(e){return e.user.id===t.id})},excludedUsersContainsLoggedUser:function(r){var t=this.getLoggedUser();return e.any(r,function(e){return e.id===t.id})},filterIsNotEmpty:function(){return this.config.data.filter&&this.config.data.filter.length},filterIsEmpty:function(){return!this.filterIsNotEmpty()},isMoreAvailable:function(){var e=this.config.data;return this.filterIsEmpty()&&e.showMore!==!0&&(e.hasOwnProperty("roleId")||e.hasOwnProperty("role"))}})});