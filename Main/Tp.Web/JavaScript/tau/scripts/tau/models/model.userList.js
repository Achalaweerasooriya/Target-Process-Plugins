define(["Underscore","tau/store/types","tau/core/model-base","tau/utils/utils.textsearch"],function(_,tauTypes,EditableBase,TextSearch){return EditableBase.extend({init:function(){this._super.apply(this,arguments),this.textSearch=new TextSearch},"bus setFilter":function(evtArgs){this.config.data.filter=evtArgs.data.filter,this.fire("refresh",{refreshSelector:".user-list,.footer-box"})},setShowMore:function(showMore){this.config.data.showMore=showMore},"bus showMore":function(){this.setShowMore(!0),this.fire("refresh",{refreshSelector:".user-list,.footer-box"})},onInit:function(){this.fire("registerStoreRequest"),this.fire("commitTransaction",{})},"bus projectMembersReady+excludedUserReady+projectRolesReady":function(evtArgs){var projectMembers=evtArgs.projectMembersReady.data,excludedUser=evtArgs.excludedUserReady.data,roles=evtArgs.projectRolesReady.data,groups=[],headerActions=[];!this.excludedUsersContainsLoggedUser(excludedUser)&&this.loggedUserInProjectTeam(projectMembers)&&(headerActions=[{id:"assign-to-me",title:"Assign To Me"}]),this.filterIsNotEmpty()?groups=this.getFilteredGroups(roles,projectMembers,excludedUser):(groups=this.getGroups(projectMembers,excludedUser,roles),groups.length==0&&(this.setShowMore(!0),groups=this.getGroups(projectMembers,excludedUser,roles)));var data={headerActions:headerActions,moreAvailable:!1,groups:groups};this.fire("extendDataToBind",data),this.fire("dataBind",data)},getGroups:function(projectMembers,excludedUsers,roles){var groups=[];for(var i=0;i<roles.length;i++){var role=roles[i];if(this.usersForRoleIsVisible(role)){var usersForRole=this.getUsersForRole(role,projectMembers,excludedUsers);usersForRole.length>0&&groups.push({role:role,users:usersForRole})}}return groups},isStringValidForFilter:function(value){return this.textSearch.match(value,this.config.data.filter)!==null},getFilteredGroups:function(roles,projectMembers,excludedUsers){var groups=[];for(var roleIndex=0;roleIndex<roles.length;roleIndex++){var role=roles[roleIndex],usersForRole=[];usersForRole=this.getUsersForRole(role,projectMembers,excludedUsers);var filteredUsers=[];for(var userIndex=0;userIndex<usersForRole.length;userIndex++)this.isStringValidForFilter(usersForRole[userIndex].name)&&filteredUsers.push(usersForRole[userIndex]);usersForRole=filteredUsers,usersForRole.length>0&&groups.push({role:role,users:usersForRole})}return groups},usersForRoleIsVisible:function(role){var data=this.config.data||{};if(this.isMoreAvailable()){if(data.hasOwnProperty("roleId"))return data.roleId===role.id;if(data.role)return role.id==data.role.id}return!0},userIsNotExcluded:function(currentTeam,excludedUser){if(!currentTeam.user.isActive)return!1;var userId=currentTeam.user.id;if(excludedUser.constructor!=Array)return userId!=excludedUser.id;for(var i=0;i<excludedUser.length;i++)if(userId==excludedUser[i].id)return!1;return!0},getUsersForRole:function(role,projectMembers,excludedUser){var usersInRole=[];for(var i=0;i<projectMembers.length;i++){var currentTeam=projectMembers[i];currentTeam.role.id==role.id&&this.userIsNotExcluded(currentTeam,excludedUser)&&usersInRole.push(this.convertUser(currentTeam.user))}return usersInRole.sort(function(a,b){var nameA=a.name.toLowerCase(),nameB=b.name.toLowerCase();return nameA<nameB?-1:nameA>nameB?1:0}),usersInRole},convertUser:function(user){var username=_.trim(user.email);if(user.firstName||user.lastName)username=_.trim([user.firstName,user.lastName].join(" "));var configurator=this.config.context.configurator;return{id:user.id,name:username,role:user.role,avatar:[configurator.getApplicationPath(),"/Avatar.ashx?UserId=",user.id,"&size=32"].join("")}},getLoggedUser:function(){return this.config.context.configurator.getLoggedUser()||this.config.context.getLoggedUser()},loggedUserInProjectTeam:function(projectMembers){var loggedUser=this.getLoggedUser();return _.any(projectMembers,function(projectMember){return projectMember.user.id===loggedUser.id})},excludedUsersContainsLoggedUser:function(excludedUser){var loggedUser=this.getLoggedUser();for(var i=0;i<excludedUser.length;i++)if(excludedUser[i].id===loggedUser.id)return!0;return!1},filterIsNotEmpty:function(){return this.config.data.filter&&this.config.data.filter.length},filterIsEmpty:function(){return!this.filterIsNotEmpty()},isMoreAvailable:function(){var data=this.config.data;return this.filterIsEmpty()&&data.showMore!==!0&&(data.hasOwnProperty("roleId")||data.hasOwnProperty("role"))},destroy:function(){this.project=null,this.entity=null,this._super()}})})