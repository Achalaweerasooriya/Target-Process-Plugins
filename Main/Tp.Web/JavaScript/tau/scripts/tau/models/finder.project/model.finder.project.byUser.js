define(["Underscore","tau/core/extension.base","tau/configurations/project.colors"],function(e,t,r){return t.extend({resetLifecycle:!0,"bus beforeInit":function(e,t){var r=t.config.context.configurator;this.fire("configurator.ready",r),t.config.context.entity.type=t.config.context.entity.entityType.name.toLowerCase(),this.fire("entity.ready",t.config.context.entity)},"bus configurator.ready + entity.ready":function(t,r,n){var i=r.getStore(),o=e.bind(function(e){"removeFromList"==e.data.cmd.name&&this.fire("refresh")},this);r.getGlobalBus().on("teamsAndUsers.connected",function(){i.evictProperties(n.id,n.entityType.name,["projectMembers"]),this.fire("refresh")},this),i.unbind(this),i.on({eventName:"afterSave",type:"project",listener:this},o)},"bus configurator.ready:last + projectMembers.ready:last + activeTab.ready:last + beforeInit":function(t,n,i,o){var s=this,a=n.getStore(),c=[];c.push(e.bind(this._getList,this,a,"project",["id","name","color"],e.pluck(e.compact(e.pluck(i,"project")),"id"))),e.parallel(c,function(e,t){var n=t[0];s.fire("dataBind",{activeTab:o,teams:[],showProjects:!1,canAddProjects:!1,projects:n,canAddprojects:!0,submitLabel:"Assign",showEmpty:!0,showSearch:n.length>20,colors:r})})},_getList:function(t,r,n,i,o){t.get(r,{fields:n}).done({success:function(t){var r=t[0].data;r=e.filter(r,function(t){return-1==e.indexOf(i,t.id)}),r=e.sortBy(r,function(e){return e.name.toUpperCase()}),o(!1,r)}})},"bus configurator.ready:last + entity.ready":function(e,t,r){var n=this;t.getStore().get(r.type,{id:r.id,fields:[{projectMembers:[{project:["id","name"]}]}]}).done({success:function(e){n.fire("projectMembers.ready",e[0].data.projectMembers)}})},"bus configurator.ready:last + entity.ready:last + form.submitted":function(t,r,n,i){var o=this,s=r.getStore(),a=[];e.forEach(i.projectIds,function(e){a.push({id:e,type:"project",fields:["id","projectMembers"],data:{projectMembers:[{user:{id:n.id}}]}})});var c=[];e.forEach(a,function(e){c.push(function(t){s.save(e.type,{id:e.id,fields:e.fields,$set:e.data}).done({success:function(e){t(!1,e[0].data)
}})})}),e.parallel(c,function(e,t){t.length&&r.getGlobalBus().fire("projectsAndUsers.connected",t),o.fire("refresh")})},"bus configurator.ready:last + destroy":function(e,t){t.getGlobalBus().unbind(this),t.getStore().unbind(this)}})});