define(["Underscore","tau/core/extension.base"],function(e,t){return t.extend({"bus beforeInit":function(t,i){var r=i.config.context.configurator,n=e.defaults(i.config.options||{},{groupName:"boardTemplates",sliceTagsAt:!1});this.fire("configurator.ready",r),this.fire("options.ready",n),this.fire("itemsDefault.ready",[])},"bus options.ready + configurator.ready":function(t,i,r){var n=r.getRestStorage();n.removeAllListeners(this),n.on("afterInsert",function(e){e.data.$group==i.groupName&&this.fire("refresh")},this),n.on("afterRemove",function(e){e.data.$group==i.groupName&&this.fire("item.remove.completed",e.data.id)},this),n.select(i.groupName,{$fields:["key","publicData.name","publicData.description","publicData.tags","publicData.definition","publicData.numericPriority","publicData.previewName"],$limit:{start:0,max:10}}).done(e.bind(function(e){this.fire("itemsCustom.ready",e.data)},this))},"bus itemsDefault.ready + itemsCustom.ready":function(t,i,r){var n=i.concat(r);e.each(n,function(e,t){e.id=t}),this.fire("items.ready",n)},"bus configurator.ready + options.ready + items.ready":function(t,i,r,n){var a=[{name:"All",count:99999,isSelected:!0},{name:"Scrum",count:99998},{name:"Kanban",count:99997},{name:"Custom",count:99996}],o=e.reduce(n,function(e,t){return e.concat(t.tags||[])},[]);o=e.groupBy(o,function(e){return e.toLowerCase()}),o=e.map(o,function(e){return{name:e[0],count:e.length}}),a=a.concat(o),a=e.uniq(a,!1,function(e){return e.name.toLowerCase()}),a=e.sortBy(a,function(e){return-e.count});var s=e.reduce(a,function(e,t,i){return e[i+1]=(e.length?e[i]:0)+t.name.length+5,e},[0]),u=($("body").width()-600)/10,c=e.find(s,function(e){return e>u}),d=e.indexOf(s,c),f=r.sliceTagsAt||(0>d?s.length:d),m=i.getApplicationPath(),l=i.getLoggedUser();n=e.sortBy(n,"numericPriority"),n=e.map(n,function(e,t){return{id:e.id,name:e.name,description:e.description||"",previewSrc:m+"/JavaScript/tau/css/images/board_templates/"+(e.previewName||"default.png"),access:{remove:t>0&&l.isAdministrator?!0:!1}}
});var g=a.slice(f);g=e.sortBy(g,function(e){return e.name.toLowerCase()}),this.fire("dataBind",{items:n,tags:a.slice(0,f),moreTags:g})},"bus boardSettings.ready:last + items.ready:last + item.selected":function(t,i,r,n){var a=i.boardSettings,o=r[n];if(o){var s=o.definition;s.name=o.name,s.viewMode=s.viewMode||"board",e.forEach(["cells","x","y"],function(t){s[t]=s[t]||{types:[]},s[t]&&(s[t]=e.defaults(s[t],{types:[],ordering:null,filter:""}))}),s&&a.setDef({set:s}).done(e.bind(function(){this.fire("board.template.selected",s),this.fire("item.selected.completed",n)},this))}},"bus configurator.ready:last + options.ready:last + items.ready:last + item.remove":function(t,i,r,n,a){var o=e.find(n,function(e){return e.id==a});if(o){var s=i.getRestStorage();s.remove(r.groupName,{id:o.id,$key:o.key}).done()}},"bus configurator.ready > destroy":function(e,t){var i=t.getRestStorage();i.removeAllListeners(this)}})});