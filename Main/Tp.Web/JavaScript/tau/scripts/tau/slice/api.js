define(["tau/core/class","jQuery","Underscore","tau/core/event","tau/slice/slice.interrupter","./api.cache.axes.instance","tracking/tracking.headers"],function(e,t,r,n,i,s,a){var o=e.extend({init:function(e,n){this.config=e||{},this.resolver=n,this.id=r.uniqueId("slice/"+ +new Date+"/"+r.UUID()),this._requests={},r.defaults(this.config,{definition:{},service:t.ajax,base64:!1,clientId:this.id,options:{}})},getCometParameters:function(){var e=this,t=e.config,r=e.resolver.resolve(t.definition,{method:"noop"},{base64:t.base64,clientId:t.clientId});return r.parameters},clone:function(){var e=r.deepClone(this.config),t=new o(e,this.resolver);return t.id=this.id,t},_interruptBatchAction:function(e,t){var n=r.uniq(r.map(t.$set.items,function(e){return e.type}));return this._interruptAction(e,n,t.$set.items)},_interruptSingleAction:function(e,t){var r=t.$set.type||t.$set.entityType,n=[r];return this._interruptAction(e,n,[t.$set])},_interruptAction:function(e,n,s){var a=r.chain(n).map(function(e){return i.getInterruptersByType(e)}).flatten().value();if(a.length>0){var o=r.map(a,function(e){return{callback:e,deferred:t.Deferred()}}),c=r.map(o,function(e){return e.deferred}),u=t.whenList(c).then(function(){return e()}),d=this._getItemsChanges(s);return r.each(o,function(e){e.callback(e.deferred,d)}),u}return e()},_getItemsChanges:function(e){var t=this;return r.map(e,function(e){var n={id:e.itemId,type:e.type||e.entityType,changes:[]};return e.x&&n.changes.push({name:t.config.definition.x.types[0],value:e.x}),e.y&&n.changes.push({name:t.config.definition.y.types[0],value:e.y}),e.values&&r.each(e.values,function(e){n.changes.push({name:e.id,value:e.value})}),n})},_deferredResolved:function(e,t){this.fire("after."+e.command.method,{result:t.data,command:e.command}),e.$deferred.resolve(t)},_deferredRejected:function(e,t){e.$deferred.reject(t)},abort:function(){var e=r.values(this._requests);for(this._requests={};e.length>0;){var t=e.pop();t.abort(),this.fire("abort",t.configAction)
}},getCallOptions:function(e){return e=e||{},r.defaults(e,{base64:this.config.base64}),e.sign&&(e.clientId=this.config.clientId),e},resolve:function(e,n){var i=this;e=e||{};var s=e.command||{};n=this.getCallOptions(n);var o,c=this._createApiRequestConfig(s,n),u={},d={type:"POST",url:c.serviceUrl,dataType:"json",data:JSON.stringify(c.parameters),contentType:"application/json; charset=utf-8",$scope:e,beforeSend:function(e,t){a.track(e,t),u.start=(new Date).getTime(),o=taus.start("slice",{})}},f={ajaxConfig:d,command:s},l=r.uniqueId("ajaxCall"),h=this.config.service(d);return i._requests[l]=h,i._requests[l].configAction={command:f.command},h.done(function(t,r,n){u.end=(new Date).getTime(),i._requests.hasOwnProperty(l)&&(delete i._requests[l],f.data=t,f.isResolvedFromCache=!1,i.fire("request.completed",{time:u,command:s,response:n,request:c.parameters}),o.stop({"@":"slice-request-completed",command:s,response:n,request:c.parameters}),i._deferredResolved(e,f))}).fail(function(r){if(i._requests.hasOwnProperty(l)){delete i._requests[l];try{r.responseText=t.parseJSON(r.responseText)}catch(n){}f.data=r,i._deferredRejected(e,f)}}),e.$deferred},_createApiRequestConfig:function(e,t){return this.resolver.resolve(this.config.definition,e,t)},isUndefinedAxis:function(e){return 0===this.getTypes(this.config.definition[e]).length},x:function(e,t){return this.axis("x",e,t)},y:function(e,t){return this.axis("y",e,t)},axis:function(e,t,r){var n=this.isUndefinedAxis(e)?{items:[]}:null;if(n)return this.resolveDeferred(e+"axis",t,null,{data:n});var i=this.config.definition[e],a=i&&i.itemType;return s.process({namespace:a,key:{axis:e,config:t,definition:this.config.definition},resolver:function(r){return this.resolveDeferred(e+"axis",t,null,r)}.bind(this),invalidatedCallback:r,statInfo:{axis:e,axisType:i&&i.types&&i.types[0]}})},cell:function(e){var t=0===this.getTypes(this.config.definition.cells).length?{data:{items:[]}}:null;return this.resolveDeferred("cells",e,null,t)},size:function(){var e=this.isUndefinedAxis("x")&&this.isUndefinedAxis("y")?{data:{}}:null;
return this.resolveDeferred("size",{},null,e)},dataItemTemplate:function(e){return this.resolveDeferred("dataItemTemplate",e)},dataTemplate:function(e){return this.resolveDeferred("dataTemplate",e)},dataTemplates:function(e){return this.resolveDeferred("dataTemplates",e)},axisDataTemplate:function(e){return this.resolveDeferred("axisDataTemplate",e)},axisDataTemplates:function(e){return this.resolveDeferred("axisDataTemplates",e)},listDataTemplate:function(e){return this.resolveDeferred("listDataTemplate",e)},listDataTemplates:function(e){return this.resolveDeferred("listDataTemplates",e)},notifyViewAccess:function(e){return this.resolveDeferred("notifyViewAccess",{$set:e})},addData:function(e){return this._interruptSingleAction(r.bind(function(){return this.resolveDeferred("addData",e)},this),e)},axisAddData:function(e){return this._interruptSingleAction(r.bind(function(){var t={sign:!0};return this.resolveDeferred("addAxisData",e,t)},this),e)},listAddData:function(e){return this._interruptSingleAction(r.bind(function(){return this.resolveDeferred("listAddData",e)},this),e)},viewAddData:function(e){return this._interruptSingleAction(r.bind(function(){return this.resolveDeferred("viewAddData",e)},this),e)},cellActions:function(e){return this.resolveDeferred("cellActions",e)},cellActionsV2:function(e){return this.resolveDeferred("cellActionsV2",e)},axesActions:function(e){return this.resolveDeferred("axesActions",e)},viewDataTemplates:function(e){return this.resolveDeferred("ViewDataTemplates",e)},move:function(e){return this.resolveDeferred("move",e)},listModeActionsV2:function(e){return this.resolveDeferred("listModeActionsV2",e)},globalDataTemplates:function(e){return this.resolveDeferred("globalDataTemplates",e)},cardDetails:function(e){var t=this.config.definition.cells,n=this.getTypes(t),i=r(n).filter(function(e){return e.data&&"{}"!==e.data});t.types=i;var s={disableWhereScope:!0},a=0===i.length||0===e.$set.CardsIds.length?{data:{items:[]}}:null;return this.resolveDeferred("cardsDetails",e,s,a)
},moveAndPrioritizeBatch:function(e){return this._interruptBatchAction(r.bind(function(){var t={disableWhereScope:!0};return e.$set.items.length>this.config.options.DnDTurnOffCometWhenItemsCountExceed&&(t.sign=!0),this.resolveDeferred("moveAndPrioritizeBatch",e,t)},this),e)},moveBatch:function(e){return this._interruptBatchAction(r.bind(function(){var t={disableWhereScope:!0};return e.$set.items.length>this.config.options.DnDTurnOffCometWhenItemsCountExceed&&(t.sign=!0),this.resolveDeferred("moveBatch",e,t)},this),e)},movePlannedDatesBatch:function(e){return this._interruptBatchAction(r.bind(function(){var t={disableWhereScope:!0};return e.$set.items.length>this.config.options.DnDTurnOffCometWhenItemsCountExceed&&(t.sign=!0),this.resolveDeferred("movePlannedDatesBatch",e,t)},this),e)},prioritizeBatch:function(e){return this._interruptBatchAction(r.bind(function(){var t={};return e.$set.items.length>this.config.options.DnDTurnOffCometWhenItemsCountExceed&&(t.sign=!0),this.resolveDeferred("prioritizeBatch",e,t)},this),e)},prioritize:function(e){return this.resolveDeferred("prioritize",e)},getCellsUnavailableToMove:function(e){return this.resolveDeferred("getCellsUnavailableToMove",e)},axes:function(){var e=this._createDeferredCall("axes"),r={command:e.command};return t.when(this.x(),this.y()).done(function(t,n){r.data={x:t.data.items,y:n.data.items},e.$deferred.resolve(r)}).fail(function(t){r.data=t,e.$deferred.reject(r)}),e.$deferred},space:function(){return this.resolveDeferred("space",{})},spaceV2:function(){return this.resolveDeferred("spaceV2",{})},getTypes:function(e){return e?r.isArray(e)?e:r.isString(e)?[e]:e.types?r.isArray(e.types)?e.types:r.isString(e.types)?[e.types]:[]:[]:[]},cellCounts:function(e){return this.resolveDeferred("cellCounts",e)},axesCounts:function(e){return this.resolveDeferred("axesCounts",e)},density:function(e){return this.resolveDeferred("density",e)},forecasts:function(e){return this.resolveDeferred("forecasts",e)},list:function(e){var t=0===this.getTypes(this.config.definition.cells).length?{data:{items:[]}}:null;
return this.resolveDeferred("list",e,null,t)},_createDeferredCall:function(e,r){var n=t.Deferred();return{$deferred:n,command:{config:r,method:e}}},resolveDeferred:function(e,t,r,n){var i=this._createDeferredCall(e,t);if(n)return this._deferredResolved(i,n),i.$deferred;var s=this;return s.fire("before."+e,t),this.resolve(i,r).fail(function(t){if(0!==t.data.status){var r,n="";t.data.readyState?(r=t.data.responseText,n=r.Message):r={message:n},r.cmd=t.command,s.fire("error",r);var i=n||"unknown slice issue";taus.error({"@":["slice-detailed-error"],message:i,method:e,definition:s.config.definition})}})}});return n.implementOn(o.prototype),o});