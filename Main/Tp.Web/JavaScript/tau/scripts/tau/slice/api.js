define(["tau/core/class","jQuery","Underscore","tau/core/event","tau/slice/slice.interrupter","./api.cache.axes.instance"],function(e,t,n,r,i,s){var o=e.extend({init:function(e,r){this.config=e||{},this.resolver=r,this.id=n.uniqueId("slice/"+ +new Date+"/"+n.UUID()),this._requests={},n.defaults(this.config,{definition:{},service:t.ajax,base64:!1,clientId:this.id,options:{}})},getSliceParams:function(){var e=this,t=e.config,n=e.resolver.resolve(t.definition,{method:"noop"},{base64:t.base64,clientId:t.clientId});return n.parameters},clone:function(){var e=n.deepClone(this.config),t=new o(e,this.resolver);return t.id=this.id,t},_interruptBatchAction:function(e,t){var r=n.uniq(n.map(t.$set.items,function(e){return e.type}));return this._interruptAction(e,r,t.$set.items)},_interruptSingleAction:function(e,t){var n=t.$set.type||t.$set.entityType,r=[n];return this._interruptAction(e,r,[t.$set])},_interruptAction:function(e,r,s){var o=n.chain(r).map(function(e){return i.getInterruptersByType(e)}).flatten().value();if(o.length>0){var a=n.map(o,function(e){return{callback:e,deferred:t.Deferred()}}),c=n.map(a,function(e){return e.deferred}),u=t.whenList(c).then(function(){return e()}),d=this._getItemsChanges(s);return n.each(a,function(e){e.callback(e.deferred,d)}),u}return e()},_getItemsChanges:function(e){var t=this;return n.map(e,function(e){var r={id:e.itemId,type:e.type||e.entityType,changes:[]};return e.x&&r.changes.push({name:t.config.definition.x.types[0],value:e.x}),e.y&&r.changes.push({name:t.config.definition.y.types[0],value:e.y}),e.values&&n.each(e.values,function(e){r.changes.push({name:e.id,value:e.value})}),r})},_deferredResolved:function(e,t){this.fire("after."+e.command.method,{result:t.data,command:e.command}),e.$deferred.resolve(t)},_deferredRejected:function(e,t){e.$deferred.reject(t)},abort:function(){var e=n.values(this._requests);for(this._requests={};e.length>0;){var t=e.pop();t.abort(),this.fire("abort",t.configAction)}},getCallOptions:function(e){return e=e||{},n.defaults(e,{base64:this.config.base64}),e.sign&&(e.clientId=this.config.clientId),e},resolve:function(e,r){var i=this;e=e||{};var s=e.command||{};r=this.getCallOptions(r);var o,a=this._createApiRequestConfig(s,r),c={},u={type:"POST",url:a.serviceUrl,dataType:"json",data:JSON.stringify(a.parameters),contentType:"application/json; charset=utf-8",$scope:e,beforeSend:function(){c.start=(new Date).getTime(),o=taus.start("slice",{})}},d={ajaxConfig:u,command:s},f=n.uniqueId("ajaxCall"),l=this.config.service(u);return i._requests[f]=l,i._requests[f].configAction={command:d.command},l.done(function(t,n,r){c.end=(new Date).getTime(),i._requests.hasOwnProperty(f)&&(delete i._requests[f],d.data=t,d.isResolvedFromCache=!1,i.fire("request.completed",{time:c,command:s,response:r,request:a.parameters}),o.stop({"@":"slice-request-completed",command:s,response:r,request:a.parameters}),i._deferredResolved(e,d))}).fail(function(n){if(i._requests.hasOwnProperty(f)){delete i._requests[f];try{n.responseText=t.parseJSON(n.responseText)}catch(r){}d.data=n,i._deferredRejected(e,d)}}),e.$deferred},_createApiRequestConfig:function(e,t){return this.resolver.resolve(this.config.definition,e,t)},isUndefinedAxis:function(e){return 0===this.getTypes(this.config.definition[e]).length},x:function(e,t){return this.axis("x",e,t)},y:function(e,t){return this.axis("y",e,t)},axis:function(e,t,n){var r=this.isUndefinedAxis(e)?{items:[]}:null;if(r)return this.resolveDeferred(e+"axis",t,null,{data:r});var i=this.config.definition[e],o=i&&i.types&&i.types[0];return s.process({namespace:o,key:{axis:e,config:t,definition:this.config.definition},resolver:function(n){return this.resolveDeferred(e+"axis",t,null,n)}.bind(this),invalidatedCallback:n,statInfo:{axis:e,axisType:i&&i.types&&i.types[0]}})},cell:function(e){var t=0===this.getTypes(this.config.definition.cells).length?{data:{items:[]}}:null;return this.resolveDeferred("cells",e,null,t)},size:function(){var e=this.isUndefinedAxis("x")&&this.isUndefinedAxis("y")?{data:{}}:null;return this.resolveDeferred("size",{},null,e)},dataItemTemplate:function(e){return this.resolveDeferred("dataItemTemplate",e)},dataTemplate:function(e){return this.resolveDeferred("dataTemplate",e)},viewDataTemplate:function(e){return this.resolveDeferred("viewDataTemplate",e)},axisDataTemplate:function(e){return this.resolveDeferred("axisDataTemplate",e)},listDataTemplate:function(e){return this.resolveDeferred("listDataTemplate",e)},notifyBoardAccess:function(e){return this.resolveDeferred("notifyBoardAccess",e)},addData:function(e){return this._interruptSingleAction(n.bind(function(){return this.resolveDeferred("addData",e)},this),e)},axisAddData:function(e){return this._interruptSingleAction(n.bind(function(){var t={sign:!0};return this.resolveDeferred("addAxisData",e,t)},this),e)},listAddData:function(e){return this._interruptSingleAction(n.bind(function(){return this.resolveDeferred("listAddData",e)},this),e)},viewAddData:function(e){return this._interruptSingleAction(n.bind(function(){return this.resolveDeferred("viewAddData",e)},this),e)},cellActions:function(e){return this.resolveDeferred("cellActions",e)},cellActionsV2:function(e){return this.resolveDeferred("cellActionsV2",e)},axesActions:function(e){return this.resolveDeferred("axesActions",e)},viewActions:function(e){return this.resolveDeferred("viewActions",e)},move:function(e){return this.resolveDeferred("move",e)},listModeActionsV2:function(e){return this.resolveDeferred("listModeActionsV2",e)},cardDetails:function(e){var t=this.config.definition.cells,r=this.getTypes(t),i=n(r).filter(function(e){return e.data&&"{}"!==e.data});t.types=i;var s={disableWhereScope:!0},o=0===i.length||0===e.$set.CardsIds.length?{data:{items:[]}}:null;return this.resolveDeferred("cardsDetails",e,s,o)},moveAndPrioritizeBatch:function(e){return this._interruptBatchAction(n.bind(function(){var t={disableWhereScope:!0};return e.$set.items.length>this.config.options.DnDTurnOffCometWhenItemsCountExceed&&(t.sign=!0),this.resolveDeferred("moveAndPrioritizeBatch",e,t)},this),e)},moveBatch:function(e){return this._interruptBatchAction(n.bind(function(){var t={disableWhereScope:!0};return e.$set.items.length>this.config.options.DnDTurnOffCometWhenItemsCountExceed&&(t.sign=!0),this.resolveDeferred("moveBatch",e,t)},this),e)},movePlannedDatesBatch:function(e){return this._interruptBatchAction(n.bind(function(){var t={disableWhereScope:!0};return e.$set.items.length>this.config.options.DnDTurnOffCometWhenItemsCountExceed&&(t.sign=!0),this.resolveDeferred("movePlannedDatesBatch",e,t)},this),e)},prioritizeBatch:function(e){return this._interruptBatchAction(n.bind(function(){var t={};return e.$set.items.length>this.config.options.DnDTurnOffCometWhenItemsCountExceed&&(t.sign=!0),this.resolveDeferred("prioritizeBatch",e,t)},this),e)},prioritize:function(e){return this.resolveDeferred("prioritize",e)},axes:function(){var e=this._createDeferredCall("axes"),n={command:e.command};return t.when(this.x(),this.y()).done(function(t,r){n.data={x:t.data.items,y:r.data.items},e.$deferred.resolve(n)}).fail(function(t){n.data=t,e.$deferred.reject(n)}),e.$deferred},space:function(){return this.resolveDeferred("space",{})},spaceV2:function(){return this.resolveDeferred("spaceV2",{})},getTypes:function(e){return e?n.isArray(e)?e:n.isString(e)?[e]:e.types?n.isArray(e.types)?e.types:n.isString(e.types)?[e.types]:[]:[]:[]},cellCounts:function(e){return this.resolveDeferred("cellCounts",e)},axesCounts:function(e){return this.resolveDeferred("axesCounts",e)},density:function(e){return this.resolveDeferred("density",e)},list:function(e){var t=0===this.getTypes(this.config.definition.cells).length?{data:{items:[]}}:null;return this.resolveDeferred("list",e,null,t)},_createDeferredCall:function(e,n){var r=t.Deferred();return{$deferred:r,command:{config:n,method:e}}},resolveDeferred:function(e,t,n,r){var i=this._createDeferredCall(e,t);if(r)return this._deferredResolved(i,r),i.$deferred;var s=this;return s.fire("before."+e,t),this.resolve(i,n).fail(function(t){if(0!==t.data.status){var n,r="";t.data.readyState?(n=t.data.responseText,r=n.Message):n={message:r},n.cmd=t.command,s.fire("error",n);var i=r||"unknown slice issue";taus.error({"@":["slice-detailed-error"],message:i,method:e,definition:s.config.definition}),taus.track({"@":["slice-detailed-error"],tags:["error","slice"],name:i,method:e,definition:s.config.definition})}})}});return r.implementOn(o.prototype),o});