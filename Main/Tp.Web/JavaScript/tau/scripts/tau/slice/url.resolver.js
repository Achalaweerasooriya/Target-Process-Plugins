define(["jQuery","Underscore","app.path","tau/core/query"],function($,_,appPath,query){var path=appPath.get(),applicationUrl=path+"/slice/v1/",convertCell=function(node){var def={};if(!node)return null;_.isString(node)&&(node=[node]);if(_.isArray(node))def.id=node.length?node[0]:null,def.filter=null,def.ordering=null;else if(_.isObject(node)){var type=node.type||node.types;_.isArray(type)?def.id=type.length?type[0]:null:def.id=type,_.isString(node.data)&&(def.data=node.data),def.filter=node.filter||null,def.ordering=node.ordering&&node.ordering.name?node.ordering:null}return def},convertCells=function(node){var def={};return node?(_.isArray(node)?def.items=node:_.isObject(node)&&(def.items=node.items||node.types||node.type,def.filter=node.filter||null,def.ordering=node.ordering&&node.ordering.name?node.ordering:null),_.forEach(def.items,function(v,k){def.items[k]=convertCell(v)}),def):null};return{resolve:function(definition,command,options){var url=[applicationUrl,"matrix/",command.method].join(""),config=_.clone(command.config||{});_.defaults(config,{});var parameters={base64:options.base64||!1};options.clientId&&(parameters.clientId=options.clientId),parameters.take=config.$take,config.$skip&&(parameters.skip=config.$skip);if(!options.disableWhereScope){var $where=query.render(config);$where&&(parameters.where=$where);var $whereX=query.render(config.$whereX||{});$whereX&&(parameters.whereX=$whereX);var $whereY=query.render(config.$whereY||{});$whereY&&(parameters.whereY=$whereY)}config.$set&&_.forEach(config.$set,function(value,key){parameters[key]=value});var acid=definition.global?definition.global.acid:null,def={global:{acid:acid}};if(definition.hasOwnProperty("x")){var x=convertCell(_.cloneDeep(definition.x));x&&(def.x=x)}if(definition.hasOwnProperty("user")){var user=_.cloneDeep(definition.user);user.cardFilter&&(def.user=user)}if(definition.hasOwnProperty("y")){var y=convertCell(_.cloneDeep(definition.y));y&&(def.y=y)}definition.hasOwnProperty("cells")&&(def.cells=convertCells(_.cloneDeep(definition.cells))),definition.hasOwnProperty("entityId")&&definition.hasOwnProperty("entityType")&&(def.entityId=definition.entityId,def.entityType=definition.entityType),parameters.definition=def;var paramsForUrl=_.clone(parameters);return delete paramsForUrl.clientId,{serviceUrl:url,parameters:parameters,url:url+"?"+$.param(paramsForUrl)}}}})