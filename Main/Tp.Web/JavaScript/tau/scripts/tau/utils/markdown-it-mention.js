define([],function(){function e(e,n){return'<span data-mention="'+e[n].content+'">'}function n(){return"</span>"}function t(e,n){return e[n].content}function l(e){return/^<a[>\s]/i.test(e)}function i(e){return/^<\/a\s*>/i.test(e)}return function(r){function o(e){var n,t,r,o,s,f,p,a,h,m,v,d,g,x,y,w,k,O,T=e.tokens,_=e.Token;for(k=/\B@(\S*)/,O=/\B@(\S*)/g,t=0,r=T.length;r>t;t++)if("inline"===T[t].type)for(f=T[t].children,a=0,n=f.length-1;n>=0;n--)if(s=f[n],"link_close"!==s.type){if("html_inline"===s.type&&(l(s.content)&&a>0&&a--,i(s.content)&&a++),!(a>0)&&"text"===s.type&&(x=s.content,h=x.match(O),null!==h)){for(y=[],w=s.level,o=0;o<h.length;o++)m=h[o].match(k),v=x.indexOf(h[o]),d=u(m[1]).trim(),g="mention",v>0&&(p=new _("text","",0),p.content=x.slice(0,v),p.level=w,y.push(p)),p=new _("mentionOpen","",1),p.content=d,p.level=w++,y.push(p),p=new _("mentionText","",0),p.content=d,p.level=w,y.push(p),p=new _("mentionClose","",-1),p.level=--w,y.push(p),x=x.slice(v+m[0].length);x.length>0&&(p=new _("text","",0),p.content=x,p.level=e.level,y.push(p)),f=c(f,n,y),T[t].children=f}}else for(n--;f[n].level!==s.level&&"link_open"!==f[n].type;)n--}var c=r.utils.arrayReplaceAt,u=r.utils.escapeHtml;r.core.ruler.after("inline","mention",o),r.renderer.rules.mentionOpen=e,r.renderer.rules.mentionText=t,r.renderer.rules.mentionClose=n}});