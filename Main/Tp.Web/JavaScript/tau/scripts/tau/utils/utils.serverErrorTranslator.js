define(["require","Underscore","jQuery","tau/store/services/service.linkedTestPlan"],function(e){function r(e,r,t){var s=n("<span>"+r.join(" ")+"</span>");return e.loggedUser.isAdministrator&&s.on("click","a",function(){e.getWorkflowService().editProcessWorkflow(e,n(this),[t.EntityType],t.Process.Id)}),s}var t=e("Underscore"),n=e("jQuery"),s=e("tau/store/services/service.linkedTestPlan"),i=[{name:"StateIsNotAllowedByWorkflowException",isMatch:function(e){return/BadRequestException$/i.test(e.Type)&&(t.isObject(e.Error)&&/StateIsNotAllowedByWorkflowException/i.test(e.Error.Type)||t.isObject(e.InnerException)&&/StateIsNotAllowedByWorkflowException/i.test(e.InnerException.Type))},buildError:function(e){var t=this.config.context.configurator,n=e.InnerException||e.Error,s=n.Details,i=["Possible transitions are:",s.StateName,"&rarr;",s.NextStates.join(", ")+"."];t.loggedUser.isAdministrator&&i.push("You can edit the workflow for",'<a href="#">'+s.Process.Name+"</a> process.");var o=r(t,i,s);return{message:e.Message,details:o}}},{name:"NotWellFormedLangExpressionException",isMatch:function(e){return/BadRequestException$/i.test(e.Type)&&(t.isObject(e.Error)&&/NotWellFormedLangExpressionException$/i.test(e.Error.Type)||t.isObject(e.InnerException)&&/NotWellFormedLangExpressionException$/i.test(e.InnerException.Type))},buildError:function(e){var r=e.InnerException||e.Error,t=r.Details,n=e.Message,s=t.Message;return{message:n,details:s}}},{name:"General HttpException",isMatch:function(e){return/\.HttpException$/i.test(e.Type)&&(t.isObject(e.InnerException)&&e.InnerException.Message||t.isObject(e.Error)&&e.Error.Message)},buildError:function(e){var r=e.InnerException||e.Error;return{message:e.Message,details:r.Message}}},{name:"NoStatesDefinedInProcessException",isMatch:function(e){return/BadRequestException$/i.test(e.Type)&&(t.isObject(e.InnerException)&&/NoStatesDefinedInProcessException/i.test(e.InnerException.Type)||t.isObject(e.Error)&&/NoStatesDefinedInProcessException/i.test(e.Error.Type))
},buildError:function(e){var t=this.config.context.configurator,n=e.InnerException||e.Error,s=n.Details,i=[];t.loggedUser.isAdministrator&&i.push("You can add",s.StateDescription,"manually in",'<a href="#">'+s.Process.Name+" process</a>.");var o=r(t,i,s);return{message:e.Message,details:o}}},{name:"HttpError",isMatch:function(e){return e.data?t.has(e.data,"response"):!1},buildError:function(e){return o.buildError(e.data.response)}},{name:"UserStoryTestItemMoveRequiresMigrationException",isMatch:function(e){return/BadRequestException$/i.test(e.Type)&&t.isObject(e.InnerException)&&/UserStoryTestItemMoveRequiresMigrationException/i.test(e.InnerException.Type)},buildError:function(e){var r=this.config.context.configurator,t=r.getTemplateFactory().getTermProcessor(),i=["<div>","<div>You need to create a ${test plan,lower} for the ${user story,lower} in order to link ${test plans,lower,names} and ${test cases,lower,names} to it.</div>","<p>",'<button class="tau-btn tau-primary">Create a linked ${test plan,lower}</button>',"<p>","<span>${test cases,capital,names} from this ${user story,lower} will be added to the created ${test plan,lower}. </span>",'<a href="http://guide.targetprocess.com/entity-test-plan.html">Read more.</a>',"</div>"],o=n(t.replaceTermTags(i.join("")));return o.on("click","button",function(t){var i=n('<div style="position: relative;"></div>');i.tauProgressIndicator(),i.tauProgressIndicator("show"),o.replaceWith(i),t.preventDefault(),t.stopPropagation();var a=new s(r.getApplicationPath(),r.getStore());a.migrateUserStory({id:e.InnerException.Details.UserStoryId}).then(function(){i.trigger("click")},function(e){var r=n('<span class="tau-system-message-error">Error: '+e+"</span>");i.replaceWith(r)})}.bind(this)),{message:"Action required",details:o,type:"warning"}}}],o={name:"default",buildError:function(e){if(!e)return{};var r=e.message||"Looks like application is not available. Please check your connection or server availability";r=t.isObject(e)&&t.isString(e.Message)?e.Message:r;
var n=t.isObject(e.InnerException)&&t.isString(e.InnerException.Details)?e.InnerException.Details:t.isObject(e.Error)&&t.isString(e.Error.Details)?e.Error.Details:void 0;return{message:r,details:n}}};return{translateServerError:function(e){var r=t.find(i,function(r){return r.isMatch(e)})||o;return r.buildError.call(this,e)},parseXhrError:function(e){try{return n.parseJSON(e.responseText)}catch(r){return{message:e.statusText}}},translateXhrError:function(e){var r=this.parseXhrError(e);return this.translateServerError(r)}}});