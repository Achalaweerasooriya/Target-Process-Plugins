define(["tau/configurator","Underscore"],function(r,e){return{fromSourceToHtml:function(n){var t=r.getApplicationPath()+"/",i=n||"",a=/(?:<img(?=\s)(?:[^>"']|"[^"]*"|'[^']*')*?\s)src\s*=\s*("~\/([^"]*)"|'~\/([^']*)')(?:[^>]*>)/gi;i=i.replace(a,function(r,e,n,i){var a=n||i,c=e[0];return r.replace(e,function(){return c+t+a+c})});for(var c,u=/<[^<]+?>/g,l=[];null!=(c=u.exec(i));)l.push({left:c.index,right:c.index+c[0].length});return i.replace(/\w[\xa0]+\w/g,function(r,n){return e.find(l,function(r){return r.left<=n&&r.right>=n})?r:r.replace(/[\xa0]/g," ")})},fromHtmlToSource:function(e){var n=r.getApplicationPath(),t=e||"",i='(?:<img(?=\\s)(?:[^>"\']|"[^"]*"|\'[^\']*\')*?\\s)src\\s*=\\s*("'+n+'/([^"]*)"|\''+n+"/([^']*)')(?:[^>]*>)",a=new RegExp(i,"gi");return t=t.replace(a,function(r,e,n,t){var i=n||t,a=e[0];return r.replace(e,function(){return a+"~/"+i+a})})},replacePlainTextUrlWithHTML:function(r,n){var t=$("<div/>");t.html(r),n=e.isUndefined(n)?!0:n;var i=[];t.find("a, img").each(function(r,e){var n=$(e),t="_link_"+r;i.push({origin:n,placeholderId:t}),n.replaceWith($('<div id="'+t+'" />'))});var a=t.html();a=a.replace(/\b(((http|ftp)[s]?):\/\/)([0-9a-z-?!(){}\[\]^|$,"*\.@;&:%_\/\\\\+~#=`]+)/gi,function(r){var e=r.split("?")[0],n=arguments[arguments.length-2],t=arguments[arguments.length-1],i=function(r,e){for(var n="",t="";r>1;){var i=e.substring(r-1,r);if(i.search(/\S/)>-1)if(""==t)t=i;else if(""==n){n=i;break}r-=1}return"="==t||"="==n&&'"'==t||"="==n&&"'"==t};return i(n,t)?r:e&&e.search(/\.(jpg|gif|png|jpeg)$/)>-1?"<img style='max-width: 600px' src='"+r+"'>":"<a href='"+r+"' target='_blank'>"+r+"</a>"}),t.html(a),$.each(i,function(r,e){t.find("#"+e.placeholderId).replaceWith(e.origin)});var c=t.html();return n&&(c=c.replace(/&amp;/g,"&")),c}}});