define(["tau/configurator","Underscore"],function(configurator,_){return{fromSourceToHtml:function(text){var path=configurator.getApplicationPath()+"/",processed=text||"",r=/(?:<img(?=\s)(?:[^>"']|"[^"]*"|'[^']*')*?\s)src\s*=\s*("~\/([^"]*)"|'~\/([^']*)')(?:[^>]*>)/gi;processed=processed.replace(r,function(el,src,v1,v2){var val=v1||v2,quot=src[0];return el.replace(src,function(){return quot+path+val+quot})});var regexp=/<[^<]+?>/g,tagsPositions=[],match;while((match=regexp.exec(processed))!=null)tagsPositions.push({left:match.index,right:match.index+match[0].length});return processed.replace(/\w[\xa0]+\w/g,function(str,pos){return _.find(tagsPositions,function(tagPos){return tagPos.left<=pos&&tagPos.right>=pos})?str:str.replace(/[\xa0]/g," ")})},fromHtmlToSource:function(text){var path=configurator.getApplicationPath(),processed=text||"",s='(?:<img(?=\\s)(?:[^>"\']|"[^"]*"|\'[^\']*\')*?\\s)src\\s*=\\s*("'+path+'/([^"]*)"|\''+path+"/([^']*)')(?:[^>]*>)",r=new RegExp(s,"gi");return processed=processed.replace(r,function(el,src,v1,v2){var val=v1||v2,quot=src[0];return el.replace(src,function(){return quot+"~/"+val+quot})}),processed},replacePlainTextUrlWithHTML:function(html){var $el=$("<div/>");$el.html(html);var placeholders=[];$el.find("a, img").each(function(index,item){var $origin=$(item),placeholderId="_link_"+index;placeholders.push({origin:$origin,placeholderId:placeholderId}),$origin.replaceWith($('<div id="'+placeholderId+'" />'))});var contentHtml=$el.html();return contentHtml=contentHtml.replace(/\b(((http|ftp)[s]?):\/\/)([0-9a-z-?!(){}\[\]^|$,"*\.@;&:%_\/\\\\+~#=`]+)/gi,function(url){var filename=url.split("?")[0],index=arguments[arguments.length-2],original=arguments[arguments.length-1],lookForSpecialCasesBehind=function(index,original){var char1="",char2="";while(index>1){var c=original.substring(index-1,index);if(c.search(/\S/)>-1)if(char2=="")char2=c;else if(char1==""){char1=c;break}index-=1}return char2=="="||char1=="="&&char2=='"'||char1=="="&&char2=="'"};return lookForSpecialCasesBehind(index,original)?url:filename&&filename.search(/\.(jpg|gif|png|jpeg)$/)>-1?"<img style='max-width: 600px' src='"+url+"'>":"<a href='"+url+"' target='_blank'>"+url+"</a>"}),$el.html(contentHtml),$.each(placeholders,function(index,item){$el.find("#"+item.placeholderId).replaceWith(item.origin)}),$el.html().replace(/&amp;/g,"&")}}})