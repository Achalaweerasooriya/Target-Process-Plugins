define(["require","tau/configurator","Underscore","jQuery","tau/utils/utils.constants","vendors/markdown-it/markdown-it","vendors/markdown-it-emoji/markdown-it-emoji","vendors/twemoji/twemoji.amd","vendors/highlightjs/highlight.pack","libs/caja/caja-sanitizer","tau/utils/markdown-it-mention"],function(r){var e=r("tau/configurator"),t=r("Underscore"),n=r("jQuery"),i=r("tau/utils/utils.constants").get("markdownMarker"),a=r("vendors/markdown-it/markdown-it"),o=r("vendors/markdown-it-emoji/markdown-it-emoji"),u=r("vendors/twemoji/twemoji.amd"),s=r("vendors/highlightjs/highlight.pack"),c=r("libs/caja/caja-sanitizer"),l=new a({html:!0,breaks:!0,linkify:!0,typographer:!0,quotes:"“”‘’",highlight:function(r,e){if(e&&s.getLanguage(e))try{return s.highlight(e,r).value}catch(t){}try{return s.highlightAuto(r).value}catch(t){}return r}});return l.use(o).use(r("tau/utils/markdown-it-mention")),l.renderer.rules.emoji=function(r,t){return u.parse(r[t].content,{base:e.getApplicationPath()+"/JavaScript/tau/scripts/vendors/",folder:"twemoji",ext:".svg"})},{isMarkdown:function(r){return r=r||"",!r||t.startsWith(r,i)},fromSourceToHtml:function(r){var n=r||"",a="";if(this.isMarkdown(n))n=n.replace(i,""),a=l.render(n);else{var o=e.getApplicationPath()+"/",u=/(?:<img(?=\s)(?:[^>"']|"[^"]*"|'[^']*')*?\s)src\s*=\s*("~\/([^"]*)"|'~\/([^']*)')(?:[^>]*>)/gi;n=n.replace(u,function(r,e,t,n){var i=t||n,a=e[0];return r.replace(e,function(){return a+o+i+a})});for(var s,g=/<[^<]+?>/g,h=[];null!==(s=g.exec(n));)h.push({left:s.index,right:s.index+s[0].length});a=n.replace(/\w[\xa0]+\w/g,function(r,e){return t.find(h,function(r){return r.left<=e&&r.right>=e})?r:r.replace(/[\xa0]/g," ")})}return c(a)},fromHtmlToSource:function(r){var t=e.getApplicationPath(),n=r||"",i='(?:<img(?=\\s)(?:[^>"\']|"[^"]*"|\'[^\']*\')*?\\s)src\\s*=\\s*("'+t+'/([^"]*)"|\''+t+"/([^']*)')(?:[^>]*>)",a=new RegExp(i,"gi");return n=n.replace(a,function(r,e,t,n){var i=t||n,a=e[0];return r.replace(e,function(){return a+"~/"+i+a})})},replacePlainTextUrlWithHTML:function(r,e){var i=n("<div/>");
i.html(r),e=t.isUndefined(e)?!0:e;var a=[];i.find('a, img:not(".emoji")').each(function(r,e){var t=n(e),i="_link_"+r;a.push({origin:t,placeholderId:i}),t.replaceWith(n('<div id="'+i+'" />'))});var o=i.html();o=o.replace(/\b(((http|ftp)[s]?):\/\/)([0-9a-z-?!(){}\[\]^|$,"*\.@;&:%_\/\\\\+~#=`]+)/gi,function(r){var e=r.split("?")[0],t=arguments[arguments.length-2],n=arguments[arguments.length-1],i=function(r,e){for(var t="",n="";r>1;){var i=e.substring(r-1,r);if(i.search(/\S/)>-1)if(""===n)n=i;else if(""===t){t=i;break}r-=1}return"="===n||"="===t&&'"'===n||"="===t&&"'"===n};return i(t,n)?r:e&&e.search(/\.(jpg|gif|png|jpeg)$/)>-1?'<img style="max-width: 600px" src="'+r+'">':'<a href="'+r+'" target="_blank">'+r+"</a>"}),i.html(o),n.each(a,function(r,e){i.find("#"+e.placeholderId).replaceWith(e.origin)});var u=i.html();return e&&(u=u.replace(/&amp;/g,"&")),u}}});