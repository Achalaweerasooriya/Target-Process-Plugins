define(["Underscore","tau/core/class","tau/utils/utils.fixturesLoader","tau/extensions/extension.underscore.async"],function(e,t,i){var n=t.extend({_callbacks:function(e,t,i,n){t.failure&&t.success?i?t.failure.call(e,i):t.success.call(e,n):t(i,n)},init:function(e){this.store=e.store,this.real=e.real||!1,this.commandType=e.commandType||"save";var t;t=this.real?{generateId:!1,setType:!1,setBackRefs:!0}:{generateId:!0,setType:!0,setBackRefs:!1},this.loader=e.loader||new i(t)},registerSchema:function(e){this.loader.registerSchema(e)},load:function(t,i){var n=this.store,s=null;try{s=this.loader.load(t)}catch(c){return void this._callbacks(this,i,c)}if(this.real===!1){var t=[];return e.forEach(s,function(i){t=t.concat(e.values(i))}),this.store.config.proxy.registerData(t),void this._callbacks(this,i,null,{data:s})}t=s;var a=[];switch(e.forEach(t,function(t,i){e.forEach(t,function(t,n){var s={entityType:i,$set:{},fields:["id"],commandId:[i,n].join(":"),callbacks:{success:function(e){t.id=e.data.id}},after:[]};t.id||(e.forEach(t,function(t,i){((e.isString(t)||e.isNumber(t)||e.isBoolean(t))&&"__type"!==i||e.isArray(t)&&t.length&&0==t[0].hasOwnProperty("id"))&&(s.$set[i]=t,s.fields.push(i))}),e.forEach(t,function(i,n){e.isObject(i)&&!e.isArray(i)?(s.$set[n]={id:function(e){return function(){return e[n].id}}(t)},s.after.push(n)):e.isArray(i)&&i.length&&i[0].hasOwnProperty("id")&&(s.$set[n]=[],e.forEach(i,function(e){s.$set[n].push({id:function(e){return function(){return e.id}}(e)})}),s.after.push(n))}),a.push(s))})}),this.commandType){case"bulk":this._commandBulk(a,n,function(e){i(e,{data:t})});break;case"save":this._commandSave(a,n,function(e){i(e,{data:t})})}},_commandSave:function(t,i,n){var s=[];e.forEach(t,function(t){s.push(function(n){e.forEach(t.$set,function(i,n){if(i.id&&e.isFunction(i.id)){var s=i.id();s&&(i.id=s)}else if(e.isArray(i)&&i.length&&e.isFunction(i[0].id)){e.forEach(i,function(e,t){i[t].id=e.id()});var c=e.every(i,function(e){return!e.id});c&&delete t.$set[n]
}}),i.save(t.entityType,{$set:t.$set,fields:t.fields},t.callbacks).done({success:function(){n()},failure:function(e){n(e[0])}})})}),e.series(s,function(e){n(e,{})})},_commandBulk:function(t,i,n){var s=[],c=this._groupCommandsForBulk(t),a=[];e.forEach(c,function(t){var i={entityType:t.entityType,$set:[],fields:[],items:t.items,callbacks:{}};a.push(i),i.callbacks.success=function(t){var n=t.data;e.forEach(n,function(e,t){i.items[t].callbacks.success.call(null,{data:e})})}}),e.forEach(a,function(t){s.push(function(n){e.forEach(t.items,function(i){e.forEach(i.$set,function(t,n){if(t.id&&e.isFunction(t.id)){var s=t.id();s&&(t.id=s)}else if(e.isArray(t)&&t.length&&e.isFunction(t[0].id)){e.forEach(t,function(e,i){t[i].id=e.id()});var c=e.every(t,function(e){return!e.id});c&&delete i.$set[n]}}),t.$set.push(i.$set),t.fields=i.fields}),i.save(t.entityType,{$set:t.$set,fields:t.fields,$orderBy:"id"},t.callbacks).done({success:function(){n()},failure:function(e){n(e[0])}})})}),e.series(s,function(e){n(e,{})})},_groupCommandsForBulk:function(t){var i=[],n={};return e.each(t,function(t){var s=this.loader.schemaProcessor.findByKeyword(t.entityType),c=e.some(e.keys(t.$set),function(e){return s.refs[e]&&s.refs[e].name===t.entityType});if(c)i.push({entityType:t.entityType,items:[t]});else{var a=n[t.entityType];if(a)a.push(t);else{var r={entityType:t.entityType,items:[t]};n[t.entityType]=r.items,i.push(r)}}}.bind(this)),i},clean:function(t,i){if(this.real===!1){var n=[];e.forEach(t,function(t){n=n.concat(e.values(t))});var s=this.store;return e.forEach(n,function(e){s.config.proxy.evictPersistedObject(e.id,e.__type)}),void i.success.call(this,{})}var s=this.store,n=[];e.forEach(t,function(t){n=n.concat(e.values(t))});var c=[];e.forEach(n,function(e){c.push(function(t){s.remove(e.__type,{id:e.id}).done({success:function(){t()},failure:function(){t()}})})}),e.series(c,function(e){e?i.failure.call(this,e):i.success.call(this,{data:n})})}});return n});