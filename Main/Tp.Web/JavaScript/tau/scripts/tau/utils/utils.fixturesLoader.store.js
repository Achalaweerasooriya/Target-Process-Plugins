define(["Underscore","tau/core/class","tau/utils/utils.fixturesLoader","tau/extensions/extension.underscore.async"],function(_,Class,SimpleLoader){var Loader=Class.extend({_callbacks:function(scope,callbacks,err,result){callbacks.failure&&callbacks.success?err?callbacks.failure.call(scope,err):callbacks.success.call(scope,result):callbacks(err,result)},init:function(config){this.store=config.store,this.real=config.real||!1,this.commandType=config.commandType||"save";var loaderConf;this.real?loaderConf={generateId:!1,setType:!1,setBackRefs:!0}:loaderConf={generateId:!0,setType:!0,setBackRefs:!1},this.loader=config.loader||new SimpleLoader(loaderConf)},registerSchema:function(schema){this.loader.registerSchema(schema)},load:function(data,callbacks){var store=this.store,processedData=null;try{processedData=this.loader.load(data)}catch(e){this._callbacks(this,callbacks,e);return}if(this.real===!1){var data=[];_.forEach(processedData,function(collection,name){data=data.concat(_.values(collection))}),this.store.config.proxy.registerData(data),this._callbacks(this,callbacks,null,{data:processedData});return}data=processedData;var commands=[];_.forEach(data,function(collection,type){_.forEach(collection,function(item,key){var storeCommand={entityType:type,$set:{},fields:["id"],commandId:[type,key].join(":"),callbacks:{success:function(result){item.id=result.data.id}},after:[]};if(item.id)return;_.forEach(item,function(val,property){if((_.isString(val)||_.isNumber(val)||_.isBoolean(val))&&property!=="__type"||_.isArray(val)&&val.length&&val[0].hasOwnProperty("id")==0)storeCommand.$set[property]=val,storeCommand.fields.push(property)}),_.forEach(item,function(val,property){_.isObject(val)&&!_.isArray(val)?(storeCommand.$set[property]={id:function(item){return function(){return item[property].id}}(item)},storeCommand.after.push(property)):_.isArray(val)&&val.length&&val[0].hasOwnProperty("id")&&val[0].id&&(storeCommand.$set[property]=[],_.forEach(val,function(item){storeCommand.$set[property].push({id:function(item){return function(){return item.id}}(item)})}),storeCommand.after.push(property))}),commands.push(storeCommand)})});switch(this.commandType){case"bulk":this._commandBulk(commands,store,function(err){callbacks(err,{data:data})});break;case"save":this._commandSave(commands,store,function(err){callbacks(err,{data:data})})}return},_commandSave:function(commands,store,callbacks){var funcs=[];_.forEach(commands,function(command){funcs.push(function(next){_.forEach(command.$set,function(prop){if(prop.id&&_.isFunction(prop.id)){var v=prop.id();v&&(prop.id=v)}else _.isArray(prop)&&prop.length&&_.isFunction(prop[0].id)&&_.forEach(prop,function(val,key){var v=val.id();v&&(prop[key].id=v)})}),store.save(command.entityType,{$set:command.$set,fields:command.fields},command.callbacks).done({success:function(){next()},failure:function(err){next(err[0])}})})}),_.series(funcs,function(err,result){callbacks(err,{})})},_commandBulk:function(commands,store,callbacks){var funcs=[],grouped=_.groupBy(commands,function(v){return v.entityType}),bulkCommands=[];_.forEach(grouped,function(items,key){var bulkCommand={entityType:key,$set:[],fields:[],items:items,callbacks:{}};bulkCommands.push(bulkCommand),bulkCommand.callbacks.success=function(res){var data=res.data;_.forEach(data,function(v,k){bulkCommand.items[k].callbacks.success.call(null,{data:v})})}}),_.forEach(bulkCommands,function(command){funcs.push(function(next){_.forEach(command.items,function(item){_.forEach(item.$set,function(prop){if(prop.id&&_.isFunction(prop.id)){var v=prop.id();v&&(prop.id=v)}else _.isArray(prop)&&prop.length&&_.isFunction(prop[0].id)&&_.forEach(prop,function(val,key){var v=val.id();v&&(prop[key].id=v)})}),command.$set.push(item.$set),command.fields=item.fields}),store.save(command.entityType,{$set:command.$set,fields:command.fields,$orderBy:"id"},command.callbacks).done({success:function(){next()},failure:function(err){next(err[0])}})})}),_.series(funcs,function(err,result){callbacks(err,{})})},clean:function(processedData,callbacks){if(this.real===!1){var data=[];_.forEach(processedData,function(collection,name){data=data.concat(_.values(collection))});var store=this.store;_.forEach(data,function(item){store.config.proxy.evictPersistedObject(item.id,item.__type)}),callbacks.success.call(this,{});return}var store=this.store,data=[];_.forEach(processedData,function(collection,name){data=data.concat(_.values(collection))});var funcs=[];_.forEach(data,function(item){funcs.push(function(next){store.remove(item.__type,{id:item.id}).done({success:function(){next()},failure:function(){next()}})})}),_.series(funcs,function(err,result){err?callbacks.failure.call(this,err):callbacks.success.call(this,{data:data})})}});return Loader})