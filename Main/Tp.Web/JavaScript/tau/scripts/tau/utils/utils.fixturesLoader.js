define(["Underscore","tau/core/class","tau/store/types.targetprocess"],function(_,a,b){var c=a.extend({init:function(a){this.config=_.extend({generateId:!1,setType:!1,copyAdditionalFields:!1,setBackRefs:!1},a),this.schemaProcessor=b},registerSchema:function(a){this.schemaProcessor.register(a)},load:function(a){var b={},c={},d=this.schemaProcessor.getDictionary(),e=_.bind(this._fillItem,this),f=this.config;return _.forEach(a,function(a,b){if(d.hasOwnProperty(b)==0)throw new Error('Entity type "'+b+'" does not exist');var f=d[b],g=c[f.name]={};_.forEach(a,function(a,b){var c=e(a,f);g[b]=c})}),_.forEach(c,function(a,b){_.forEach(a,function(a){a._pendingRefs&&(_.forEach(a._pendingRefs,function(b,d){if(_.isArray(b))_.forEach(b,function(b){var e=b.find.call(null,c);f.setBackRefs==1&&(e[b.backRefKey]=a),a[d].push(e)});else{var e=b,g=e.find.call(null,c);f.setBackRefs==1&&g[e.backRefKey]&&g[e.backRefKey].push(a),a[d]=g}}),delete a._pendingRefs)})}),b=c,b},_fillItem:function(a,b){var c=this,d={};a=_.isObject(a)?a:{name:a+""},_.forEach(b.simpleFields,function(b){d[b]=a.hasOwnProperty(b)?_.clone(a[b]):null}),this.config.generateId&&d.hasOwnProperty("id")&&d.id==null&&(d.id=_.uniqueId(1e4)),this.config.setType&&(d.__type=b.name);if(this.config.copyAdditionalFields){var e=_.keys(a),f=_.difference(e,b.simpleFields,b.refs);_.forEach(f,function(b){d[b]=a[b]?_.clone(a[b]):null})}if(_.size(b.refs)>0){d._pendingRefs={};var g=function(a,b,c){var d={};b=="general"||b=="assignable"?d=_.extend(d,a.feature?a.feature:{},a.task?a.task:{},a.bug?a.bug:{},a.userStory?a.userStory:{}):d=a[b];var e=d[c];return e};_.forEach(b.refs,function(b,e){var f=b.name,h=a[e]||null;b.list===!0?d[e]=[]:d[e]=null;if(!h||h.length==0)return;if(b.list===!0&&_.isObject(h[0])||b.list===!1&&_.isObject(h)){var i=f,j=function(a,b){return b.generateId&&(a.id=_.uniqueId(1e4)),b.setType&&(a.__type=i),a};_.isArray(h)?(d[e]=[],_.forEach(h,function(a){d[e].push(j(a,c.config))})):d[e]=j(item,c.config);return}var k=null;if(b.list===!0)k=[],_.forEach(h,function(a){var c={find:function(b){return g(b,f,a)},backRefKey:b.relationProperty};k.push(c)});else{var l={find:function(a){return g(a,f,h)},backRefKey:b.relationProperty};k=l}d._pendingRefs[e]=k})}return d}});return c})