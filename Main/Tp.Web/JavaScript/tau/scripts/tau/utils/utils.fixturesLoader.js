define(["Underscore","tau/core/class","tau/store/types.targetprocess"],function(e,t,n){var i=t.extend({init:function(t){this.config=e.extend({generateId:!1,setType:!1,copyAdditionalFields:!1,setBackRefs:!1},t),this.schemaProcessor=n},registerSchema:function(e){this.schemaProcessor.register(e)},load:function(t){var n={},i={},r=this.schemaProcessor.getDictionary(),s=e.bind(this._fillItem,this),a=this.config;return e.forEach(t,function(t,n){if(0==r.hasOwnProperty(n))throw new Error('Entity type "'+n+'" does not exist');var a=r[n],o=i[a.name]={};e.forEach(t,function(e,t){var n=s(e,a);o[t]=n})}),e.forEach(i,function(t){e.forEach(t,function(t){t._pendingRefs&&(e.forEach(t._pendingRefs,function(n,r){if(e.isArray(n))e.forEach(n,function(n){var s=n.find.call(null,i);1!=a.setBackRefs||e.isEmpty(n.backRefKey)||(s[n.backRefKey]=t),t[r].push(s)});else{var s=n,o=s.find.call(null,i);1==a.setBackRefs&&o[s.backRefKey]&&o[s.backRefKey].push(t),t[r]=o}}),delete t._pendingRefs)})}),n=i},_fillItem:function(t,n){var i=this,r={};if(t=e.isObject(t)?t:{name:t+""},e.forEach(n.simpleFields,function(n){r[n]=t.hasOwnProperty(n)?e.clone(t[n]):null}),this.config.generateId&&r.hasOwnProperty("id")&&null==r.id&&(r.id=parseInt(e.uniqueId(1e4),10)),this.config.setType&&(r.__type=n.name),this.config.copyAdditionalFields){var s=e.keys(t),a=e.difference(s,n.simpleFields,n.refs);e.forEach(a,function(n){r[n]=t[n]?e.clone(t[n]):null})}if(e.size(n.refs)>0){r._pendingRefs={};var o=function(t,n,i){var r={};if("general"==n||"assignable"==n?(r=e.extend(r,t.feature?t.feature:{},t.task?t.task:{},t.bug?t.bug:{},t.userStory?t.userStory:{},t.request?t.request:{},t.testPlanRun?t.testPlanRun:{}),"general"==n&&(r=e.extend(r,t.program?t.program:{},t.release?t.release:{},t.iteration?t.iteration:{},t.testCase?t.testCase:{},t.testPlan?t.testPlan:{},t.impediment?t.impediment:{},t.team?t.team:{},t.project?t.project:{}))):r=t[n],!r)throw'Collection "'+n+'" is not defined';if(0==r.hasOwnProperty(i))throw"Key "+i+" from collection "+n+" is not found";var s=r[i];return s};e.forEach(n.refs,function(n,s){var a=n.name,f=t[s]||null;if(r[s]=n.list===!0?[]:null,f&&0!=f.length){if(n.list===!0&&e.isObject(f[0])||n.list===!1&&e.isObject(f)){var c=a,l=function(t,n){return n.generateId&&(t.id=e.uniqueId(1e4)),n.setType&&(t.__type=c),t};return void(e.isArray(f)?(r[s]=[],e.forEach(f,function(e){r[s].push(l(e,i.config))})):r[s]=l(item,i.config))}var u=null;if(n.list===!0)u=[],e.forEach(f,function(e){var t={find:function(t){return o(t,a,e)},backRefKey:n.relationProperty};u.push(t)});else{var d={find:function(e){return o(e,a,f)},backRefKey:n.relationProperty};u=d}r._pendingRefs[s]=u}})}return r}});return i});