define(["Underscore","tau/core/class","tau/store/types.targetprocess"],function(_,a,b){var c=a.extend({init:function(a){this.config=_.extend({generateId:!1,setType:!1,copyAdditionalFields:!1},a),this.dictionary=b.getDictionary()},load:function(a){var b={},c={},d=this.dictionary,e=_.bind(this._fillItem,this);return _.forEach(a,function(a,b){var f=d[b],g=c[f.name]={};_.forEach(a,function(a,b){var c=e(a,f);g[b]=c})}),_.forEach(c,function(a,b){_.forEach(a,function(a){a._pendingRefs&&(_.forEach(a._pendingRefs,function(b,d){if(_.isArray(b))_.forEach(b,function(b){a[d].push(b.call(null,c))});else{var e=b;a[d]=e.call(null,c)}}),delete a._pendingRefs)})}),b=c,b},_fillItem:function(a,b){var c={};a=_.isObject(a)?a:{name:a+""},_.forEach(b.simpleFields,function(b){c[b]=a[b]?_.clone(a[b]):null}),this.config.generateId&&c.hasOwnProperty("id")&&c.id==null&&(c.id=_.uniqueId(1e4)),this.config.setType&&(c.__type=b.name);if(this.config.copyAdditionalFields){var d=_.keys(a),e=_.difference(d,b.simpleFields,b.refs);_.forEach(e,function(b){c[b]=a[b]?_.clone(a[b]):null})}if(_.size(b.refs)>0){c._pendingRefs={};var f=function(a,b,c){var d={};return b=="general"?d=_.extend(d,a.feature?a.feature:{},a.task?a.task:{},a.bug?a.bug:{},a.userStory?a.userStory:{}):d=a[b],d[c]};_.forEach(b.refs,function(b,d){var e=b.name,g=a[d]||null;b.list===!0?c[d]=[]:c[d]=null;if(!g||g.length==0)return;var h=null;if(b.list===!0)h=[],_.forEach(g,function(a){var b=function(b){return f(b,e,a)};h.push(b)});else{var i=function(a){return f(a,e,g)};h=i}c._pendingRefs[d]=h})}return c}});return c})