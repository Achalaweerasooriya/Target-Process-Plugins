define(["Underscore","tau/core/class","tau/core/types.targetprocess"],function(a,b,c){var d=b.extend({init:function(b){this.config=a.extend({generateId:!1,setType:!1,copyAdditionalFields:!1},b),this.dictionary=c.getDictionary()},load:function(b){var c={},d={},e=this.dictionary,f=a.bind(this._fillItem,this);return a.forEach(b,function(b,c){var g=e[c],h=d[g.name]={};a.forEach(b,function(a,b){var c=f(a,g);h[b]=c})}),a.forEach(d,function(b,c){a.forEach(b,function(b){b._pendingRefs&&(a.forEach(b._pendingRefs,function(c,e){if(a.isArray(c))a.forEach(c,function(a){b[e].push(a.call(null,d))});else{var f=c;b[e]=f.call(null,d)}}),delete b._pendingRefs)})}),c=d,c},_fillItem:function(b,c){var d={};b=a.isObject(b)?b:{name:b+""},a.forEach(c.simpleFields,function(c){d[c]=b[c]?a.clone(b[c]):null}),this.config.generateId&&d.hasOwnProperty("id")&&d.id==null&&(d.id=a.uniqueId(1e4)),this.config.setType&&(d.__type=c.name);if(this.config.copyAdditionalFields){var e=a.keys(b),f=a.difference(e,c.simpleFields,c.refs);a.forEach(f,function(c){d[c]=b[c]?a.clone(b[c]):null})}if(a.size(c.refs)>0){d._pendingRefs={};var g=function(a,b,c){var d=a[b];return d[c]};a.forEach(c.refs,function(c,e){var f=c.name,h=b[e]||null;c.list===!0?d[e]=[]:d[e]=null;if(!h||h.length==0)return;var i=null;if(c.list===!0)i=[],a.forEach(h,function(a){var b=function(b){return g(b,f,a)};i.push(b)});else{var j=function(a){return g(a,f,h)};i=j}d._pendingRefs[e]=i})}return d}});return d})