define(["Underscore","jQuery","tau/core/external","tau/core/class","tau/core/event","libs/parseUri"],function(_,$,a,b,c,d){var e=b.extend({init:function(b){this.config=_.defaults(b,{window:window,v2:!1,safe:!1,encodeBy:function(a){return a},decodeBy:function(a){try{a=decodeURIComponent(a)}catch(b){}return a}}),this.window=this.config.window||window,this.config.v2&&(this.config.external=new a(this.window)),this.params=[];var c=this;this.hashChangeHandler=function(a){a.stopPropagation(),a.preventDefault();var b=a.hash||a.target.location.hash;c.fire("urlChanged",{url:c.parseUrl(b)})},$(this.window).bind("hashchange",this.hashChangeHandler),this.destroyHandler=function(a){c.fire("destroyed",{})},$(this.window).bind("unload",this.destroyHandler)},_extract:function(a){var b=a;if(this.config.safe){a="?"+a;var c=d(a);this.params=c.queryKey,b=this.params[this.config.safeParameterName]||""}return b},_generateV2:function(b,c){var d="||legacystate",e=this.config.external,f=e.getHash(),g=new a({location:{hash:f}}),h=!_.isEmpty(b.states)&&c?b.states:{};return g.setHashParam(d,h),g.getHash()},_generate:function(a,b){b=!!b;var c="";if(this.config.v2)return c=this._generateV2(a,b),c;var d=a.url;return!_.isEmpty(a.states)&&b&&(d+="||"+JSON.stringify(a.states)),c=d,this.config.safe&&(this.params[this.config.safeParameterName]=d,c=$.param(this.params)),this.config.encodeBy(c)},_parseUrlV2:function(b){var c={},d=new a({location:{hash:b}});return c.source="#"+d.getHash(),c.states=d.getHashParam("||legacystate"),c.url=d.getHashParam(this.config.safeParameterName),c},parseUrl:function(a){if(this.config.v2){var b=this._parseUrlV2(a);return b}a&&a[0]=="#"&&(a=a.slice(1));var c=this._extract(a);try{c=this.config.decodeBy(c)}catch(d){}var e={url:null,states:{},source:"#"+a},f=c.split("||");e.url=f[0];if(f[1])try{e.states=JSON.parse(f[1])}catch(d){}return e},generateUrl:function(a,b){return this._generate(a,b)},setUrl:function(a){var b="#";_.isObject(a)&&a.hasOwnProperty("url")&&a.hasOwnProperty("states")?b=this._generate(a,!0):_.isString(a)&&(b=a),this.window.location.hash=b},getUrl:function(){return this.parseUrl(this.window.location.hash)}});return c.implementOn(e.prototype),e})