define(["Underscore","jQuery","tau/core/class","tau/core/event","libs/parseUri"],function(_,$,a,b,c){var d=a.extend({init:function(a){this.config=a,this.window=this.config.window||window,this.params=[];var b=this;this.hashChangeHandler=function(a){a.stopPropagation(),a.preventDefault();var c=a.hash||a.target.location.hash;b.fire("urlChanged",{url:b.parseUrl(c)})},$(this.window).bind("hashchange",this.hashChangeHandler),this.destroyHandler=function(a){b.fire("destroyed",{})},$(this.window).bind("unload",this.destroyHandler)},_extract:function(a){var b=a;if(this.config.safe==1){a="?"+a;var d=c(a);this.params=d.queryKey,b=this.params[this.config.safeParameterName]||""}return b},_generate:function(a,b){b=!!b;var c=a.url;_.isEmpty(a.states)==0&&b&&(c+="||"+JSON.stringify(a.states));var d=c;return this.config.safe==1&&(this.params[this.config.safeParameterName]=c,d=$.param(this.params)),d},parseUrl:function(a){a&&a[0]=="#"&&(a=a.slice(1));var b=this._extract(a);try{$.browser.safari===!0&&(b=decodeURIComponent(b))}catch(c){}var d={url:null,states:{},source:"#"+a},e=b.split("||");d.url=e[0];if(e[1])try{d.states=JSON.parse(e[1])}catch(c){}return d},generateUrl:function(a,b){return this._generate(a,b)},setUrl:function(a){var b="#";_.isObject(a)&&a.hasOwnProperty("url")&&a.hasOwnProperty("states")?b=this._generate(a,!0):_.isString(a)&&(b=a),this.window.location.hash=b},getUrl:function(){return this.parseUrl(this.window.location.hash)}});return b.implementOn(d.prototype),d})