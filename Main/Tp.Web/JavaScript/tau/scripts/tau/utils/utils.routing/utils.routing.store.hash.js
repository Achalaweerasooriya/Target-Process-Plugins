define(["Underscore","jQuery","tau/core/class","tau/core/event","libs/parseUri"],function(t,e,r,a,n){var i=r.extend({init:function(r){this.config=t.defaults(r,{window:window,v2:!1,safe:!1,encodeBy:function(t){return t},decodeBy:function(t){try{t=decodeURIComponent(t)}catch(e){}return t}}),this.window=this.config.window||window,this.config.v2&&(this.config.external=this.config.configurator.createExternal(this.window)),this.params=[];var a=this;this.hashChangeHandler=function(t){t.stopPropagation(),t.preventDefault();var e=t.hash||t.target.location.hash;a.fire("urlChanged",{url:a.parseUrl(e)})},e(this.window).bind("hashchange",this.hashChangeHandler),this.destroyHandler=function(){a.fire("destroyed",{})},e(this.window).bind("unload",this.destroyHandler)},_extract:function(t){var e=t;if(this.config.safe){t="?"+t;var r=n(t);this.params=r.queryKey,e=this.params[this.config.safeParameterName]||""}return e},_generateV2:function(e,r){var a="||legacystate",n=this.config.external,i=n.getHash(),s=this.config.configurator.createExternal({location:{hash:i}}),o=!t.isEmpty(e.states)&&r?e.states:{};return s.setHashParam(a,o),s.getHash()},_generate:function(r,a){a=!!a;var n="";if(this.config.v2)return n=this._generateV2(r,a);var i=r.url;return!t.isEmpty(r.states)&&a&&(i+="||"+JSON.stringify(r.states)),n=i,this.config.safe&&(this.params[this.config.safeParameterName]=i,n=e.param(this.params)),this.config.encodeBy(n)},_parseUrlV2:function(t){var e={},r=this.config.configurator.createExternal({location:{hash:t}});return e.source="#"+r.getHash(),e.states=r.getHashParam("||legacystate"),e.url=r.getHashParam(this.config.safeParameterName),e},parseUrl:function(t){if(this.config.v2){var e=this._parseUrlV2(t);return e}t&&"#"==t[0]&&(t=t.slice(1));var r=this._extract(t);try{r=this.config.decodeBy(r)}catch(a){}var n={url:null,states:{},source:"#"+t},i=r.split("||");if(n.url=i[0],i[1])try{n.states=JSON.parse(i[1])}catch(a){}return n},generateUrl:function(t,e){return this._generate(t,e)},setUrl:function(e){var r="#";t.isObject(e)&&e.hasOwnProperty("url")&&e.hasOwnProperty("states")?r=this._generate(e,!0):t.isString(e)&&(r=e),this.window.location.hash=r},getUrl:function(){return this.parseUrl(this.window.location.hash)}});return a.implementOn(i.prototype),i});