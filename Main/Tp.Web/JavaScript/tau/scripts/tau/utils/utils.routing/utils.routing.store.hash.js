define(["Underscore","jQuery","tau/core/class","tau/core/event","libs/parseUri"],function(_,$,Class,Event,parseUri){var Store=Class.extend({init:function(config){this.config=_.defaults(config,{window:window,v2:!1,safe:!1,encodeBy:function(s){return s},decodeBy:function(s){try{s=decodeURIComponent(s)}catch(e){}return s}}),this.window=this.config.window||window,this.config.v2&&(this.config.external=this.config.configurator.createExternal(this.window)),this.params=[];var self=this;this.hashChangeHandler=function(e){e.stopPropagation(),e.preventDefault();var hash=e.hash||e.target.location.hash;self.fire("urlChanged",{url:self.parseUrl(hash)})},$(this.window).bind("hashchange",this.hashChangeHandler),this.destroyHandler=function(e){self.fire("destroyed",{})},$(this.window).bind("unload",this.destroyHandler)},_extract:function(hash){var internalUrl=hash;if(this.config.safe){hash="?"+hash;var data=parseUri(hash);this.params=data.queryKey,internalUrl=this.params[this.config.safeParameterName]||""}return internalUrl},_generateV2:function(route,useStates){var stateParamName="||legacystate",ext=this.config.external,srcHash=ext.getHash(),tempExt=this.config.configurator.createExternal({location:{hash:srcHash}}),newStates=!_.isEmpty(route.states)&&useStates?route.states:{};return tempExt.setHashParam(stateParamName,newStates),tempExt.getHash()},_generate:function(route,useStates){useStates=!!useStates;var hash="";if(this.config.v2)return hash=this._generateV2(route,useStates),hash;var internalUrl=route.url;return!_.isEmpty(route.states)&&useStates&&(internalUrl+="||"+JSON.stringify(route.states)),hash=internalUrl,this.config.safe&&(this.params[this.config.safeParameterName]=internalUrl,hash=$.param(this.params)),this.config.encodeBy(hash)},_parseUrlV2:function(hash){var parsed={},tmpExternal=this.config.configurator.createExternal({location:{hash:hash}});return parsed.source="#"+tmpExternal.getHash(),parsed.states=tmpExternal.getHashParam("||legacystate"),parsed.url=tmpExternal.getHashParam(this.config.safeParameterName),parsed},parseUrl:function(hash){if(this.config.v2){var parseResult=this._parseUrlV2(hash);return parseResult}hash&&hash[0]=="#"&&(hash=hash.slice(1));var url=this._extract(hash);try{url=this.config.decodeBy(url)}catch(e){}var parsed={url:null,states:{},source:"#"+hash},items=url.split("||");parsed.url=items[0];if(items[1])try{parsed.states=JSON.parse(items[1])}catch(e){}return parsed},generateUrl:function(route,useStates){return this._generate(route,useStates)},setUrl:function(url){var hash="#";_.isObject(url)&&url.hasOwnProperty("url")&&url.hasOwnProperty("states")?hash=this._generate(url,!0):_.isString(url)&&(hash=url),this.window.location.hash=hash},getUrl:function(){return this.parseUrl(this.window.location.hash)}});return Event.implementOn(Store.prototype),Store})