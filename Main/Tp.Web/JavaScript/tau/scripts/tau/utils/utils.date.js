define(["Underscore","tau/configurator","tau/utils/utils.date/utils.date.wrapper","tau/utils/utils.date/utils.date.formats","tau/utils/utils.translation","libs/date.js/build/time.special"],function(_,configurator,Date,formatData,Translation,TimeSpecial){var util={},datePrefix="/Date",dateRegExp=/^\/Date\((-?\d+)(([+-])(\d{2})(\d{2}))\)\//,f=function(format){return function(date){var parsed=util.parse(date);return parsed?util._format(parsed,format):""}};return util={serverTimezoneOffset:-1*(new Date).getTimezoneOffset(),Date:Date,format:{date:{"short":f(formatData.date.short)},time:{"short":f(formatData.time.short)},datetime:{"short":f(formatData.datetime.short)}},_format:function(date,format){return date.toString(format)||""},formatAs:function(date,format){return date instanceof Date||(date=new Date(date)),this._format(date,format)},parse:function(dateString){if(_.isString(dateString)&&dateString.indexOf(datePrefix)==0){var res=dateString.match(dateRegExp),serverTime=parseInt(res[1]),serverOffsetMinutes=(parseInt(res[4])*60+parseInt(res[5]))*parseInt(res[3]+"1");dateString=new Date(serverTime),dateString.sourceOffset=serverOffsetMinutes,util.serverTimezoneOffset=serverOffsetMinutes}return Date.parse(dateString)},convertToTimezone:function(date,offset){date=util.parse(date);if(!date)return date;offset||(offset=date.sourceOffset||null);if(!offset)return date;var localOffset=(new Date).getTimezoneOffset(),totalOffset=offset+localOffset;return date=new Date(date.getTime()+totalOffset*60*1e3),date},getFormatData:function(){return formatData},getAge:function(from,to){to=to||configurator.getCurrentDate(),from=Date.parse(from);var result={isZero:!0,value:0,unit:"sec",direction:"ago",toString:function(){var val;return this.isZero?val="now":val=this.value+" "+this.unit+" "+this.direction,val}};result.direction=to>from?"ago":"after";var period=new TimeSpecial.TimePeriod(from,to,function(val){return val===1?1:val<1?0:Math.round(val)}),choice=[{func:"years",units:"year|years"},{func:"months",units:"month|months"},{func:"days",units:"day|days"},{func:"hours",units:"hour|hours"},{func:"minutes",units:"min"},{func:"seconds",units:"sec"}],item=_.detect(choice,function(item,i){var val=period[item.func];if(val!==0)return item.value=Math.abs(val),item.unit=Translation.pluralize(item.units,val),!0});return item&&(result.isZero=!1,result.value=item.value,result.unit=item.unit),result}},util})