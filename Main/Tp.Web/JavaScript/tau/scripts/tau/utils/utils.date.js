define(["Underscore","tau/utils/utils.date/utils.date.wrapper","tau/utils/utils.date/utils.date.formats","tau/utils/utils.translation","libs/date.js/build/time.special"],function(t,e,n,r,i){var u={},o="/Date",s=/^\/Date\((-?\d+)(([+-])(\d{2})(\d{2}))\)\//,a=function(t){return function(e){var n=u.parse(e);return n?u._format(n,t):""}};return u={Date:e,format:{date:{"short":a(n.date.short),iso:a(n.date.iso)},time:{"short":a(n.time.short),iso:a(n.time.iso)},datetime:{"short":a(n.datetime.short),iso:a(n.datetime.iso)}},_format:function(t,e){return t.toString(e)||""},formatAs:function(t,n){return t instanceof e||(t=new e(t)),this._format(t,n)},_getServerTimezonOffset:function(){var t=window.tauServerInfo||{timeZoneOffsetInMilliseconds:0};return t.timeZoneOffsetInMilliseconds},_convertToServerTime:function(t){return new e(t.getTime()-this._getServerTimezonOffset())},getServerNow:function(){return this.__now||this._convertToServerTime(new e)},lockNow:function(t){this.__now=new e(t)},unlockNow:function(){this.__now=null},parse:function(n){if(t.isString(n)&&0===n.indexOf(o)){var r=n.match(s),i=parseInt(r[1]),u=(60*parseInt(r[4])+parseInt(r[5]))*parseInt(r[3]+"1");n=new e(i),n.sourceOffset=u}return e.parse(n)},convertToTimezone:function(t,n){if(t=u.parse(t),!t)return t;if(!n){var r=t.sourceOffset;n=null!==r&&void 0!==r?r:null}if(null===n||void 0===n)return t;var i=t.getTimezoneOffset(),o=60*(n+i)*1e3;return t=new e(t.getTime()+o)},getFormatData:function(){return n},getAge:function(n,u){n=e.parse(n),u=e.parse(u);var o={isZero:!0,value:0,unit:"sec",direction:u>n?"ago":"after",toString:function(){return this.isZero?"now":this.value+" "+this.unit+" "+this.direction}},s=new i.TimePeriod(n,u,function(t){return 1===t?1:1>t?0:Math.round(t)}),a=[{func:"years",units:"year|years"},{func:"months",units:"month|months"},{func:"days",units:"day|days"},{func:"hours",units:"hour|hours"},{func:"minutes",units:"min"},{func:"seconds",units:"sec"}],f=t.detect(a,function(t){var e=s[t.func];return 0!==e?(t.value=Math.abs(e),t.unit=r.pluralize(t.units,e),!0):void 0});return f&&(o.isZero=!1,o.value=f.value,o.unit=f.unit),o},addDays:function(t,n){return new e(t.getTime()+864e5*n)},getDiff:function(t,e){return t-e-60*t.getTimezoneOffset()*1e3+60*e.getTimezoneOffset()*1e3},getDiffInDays:function(t,e){return Math.ceil(this.getDiff(t,e)/864e5)},getDiffInMinutes:function(t,e){return Math.ceil(this.getDiff(t,e)/6e4)},addMinutes:function(t,n){return new e(t.getTime()+6e4*n)},sameDay:function(t,e){return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()},parseTimestamp:function(t){var e=6,n=t.length-2,r=t.substring(e,n);return parseInt(r)},parseTimestampToDate:function(t){return new e(this.parseTimestamp(t))},toTimestamp:function(t){return"/Date("+t.valueOf()+"+0000)/"},between:function(t,n,r){var i=new e(t.getYear(),t.getMonth(),t.getDate()),u=new e(n.getYear(),n.getMonth(),n.getDate()),o=new e(r.getYear(),r.getMonth(),r.getDate()+1);return i>=u&&o>i},getNow:function(){return new e}}});