define(["Underscore","jQuery","tau/core/class","tau/core/event","tau/utils/utils.routing/utils.routing.store.hash","tau/utils/utils.storage","order!libs/crossroads.js/dist/js-signals","order!libs/crossroads.js/dist/crossroads"],function(a,b,c,d,e,f){var g=c.extend({init:function(a){this.backend=window.crossroads,this.options=a,this.window=this.options.window||window,this.store=new e(this.options),this.current={url:"",states:{},source:""},this.processed={url:"",states:{},source:""},this.referer=this.restoreReferer(),this.reset();return this},register:function(b,c,d){var e=b;arguments.length>1&&(e={pattern:b,callback:c});var f=this;this.backend.addRoute(e.pattern,function(){var b=Array.prototype.slice.call(arguments),c=this,d={};a.forEach(c._paramsIds,function(a,c){d[a]=b[c]});var g=f.processed.states;e.callback.apply(this,[d,g])});return this},register404:function(a){this.backend.bypassed.add(a);return this},_applyRouter:function(a){this.backend.parse(a)},start:function(){var b=this,c=a.bind(this._applyRouter,this),d=function(d){this.processed=d;if(this.processed.url!==this.current.url)this.setReferer(a.clone(this.current)),this.current=this.processed,c(this.current.url);else{var e=this.current.states,f=this.processed.states,g=a.union(a.keys(e),a.keys(f)),h={};a.forEach(g,function(a){e[a]!=f[a]&&(h[a]=f[a]||null)}),a.forEach(h,function(a,c){b.fire("stateChanged",{name:c,value:a})}),this.current=this.processed}};this.setChangeListener(a.bind(d,this));var e=function(){this.setReferer(a.clone(this.current))};this.setDestroyListener(a.bind(e,this));return this},redirect:function(a){this.window.open(a,"_self")},setInternalUrl:function(a){this.setUrl({url:a,states:{}})},getUrl:function(){return this.store.getUrl()},setUrl:function(a){this.store.setUrl(a)},generateUrl:function(a){typeof a=="undefined"&&(a=this.current);return this.store.generateUrl(a,!0)},setChangeListener:function(a){this.changeListener=function(b){a(b.data.url)},this.store.on("urlChanged",this.changeListener,this)},setDestroyListener:function(a){this.destroyListener=function(b){a(b.data.url)},this.store.on("destroyed",this.destroyListener,this)},reset:function(){this.backend.removeAllRoutes(),this.backend.bypassed.removeAll();return this},execute:function(a){var b=this.store.parseUrl(a);this.current=b,this._applyRouter(b.url);return this},stop:function(){this.changeListener&&(this.store.removeListener("urlChanged",this.changeListener,this),delete this.changeListener),this.destroyListener&&(this.store.removeListener("destroy",this.destroyListener,this),delete this.destroyListener)},getStateParameter:function(a){return this.current.states[a]},setStateParameter:function(a,b,c){this.current.states[a]=b,this.setUrl(this.current),c&&this.fire("stateChanged",{name:a,value:b})},getReferer:function(){return this.referer},setReferer:function(a){this.referer=a,f.set("utils.routing.referer",this.referer)},restoreReferer:function(){var a=f.get("utils.routing.referer");return a}});d.implementOn(g.prototype);return g})