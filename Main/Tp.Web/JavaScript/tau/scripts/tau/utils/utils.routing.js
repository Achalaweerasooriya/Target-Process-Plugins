define(["Underscore","jQuery","tau/core/class","tau/core/event","tau/utils/utils.routing/utils.routing.store.hash","tau/utils/utils.storage","libs/crossroads.js/dist/crossroads"],function(_,$,Class,Event,UrlStore,storage){var Routing=Class.extend({init:function(options){var crossroads=window.crossroads;return this.backend=crossroads(),this.options=options,this.window=this.options.window||window,this.store=new UrlStore(this.options),this.v2=options.v2===!0,this.current={url:"",states:{},source:""},this.processed={url:"",states:{},source:""},this.referer=this.restoreReferer(),this.reset(),this},register:function(pattern,callback,options){var opt=pattern;arguments.length>1&&(opt={pattern:pattern,callback:callback});var self=this,newRoute=this.backend.addRoute(opt.pattern,function(){var args=Array.prototype.slice.call(arguments),route=this,data={};_.forEach(route._paramsIds,function(v,i){data[v]=args[i]});var state=self.processed.states;opt.callback.apply(this,_.union([data,state],args))});return this},register404:function(callback){return this.backend.bypassed.add(callback),this},_applyRouter:function(url){this.backend.parse(url)},start:function(){var self=this,execute=_.bind(this._applyRouter,this),listener=function(route){this.processed=route;if(this.processed.url!==this.current.url){this.setReferer(_.clone(this.current)),this.current=this.processed,execute(this.current.url);return}var prevStates=this.current.states,processedStates=this.processed.states,keys=_.union(_.keys(prevStates),_.keys(processedStates)),internalStates={};_.forEach(keys,function(key){prevStates[key]!=processedStates[key]&&(internalStates[key]=processedStates[key]||null)}),_.forEach(internalStates,function(value,name){self.fire("stateChanged",{name:name,value:value})}),this.current=this.processed};this.setChangeListener(_.bind(listener,this));var listenerDestroy=function(){this.setReferer(_.clone(this.current))};return this.setDestroyListener(_.bind(listenerDestroy,this)),this},redirect:function(url,options){options=options||{},options.trigger===!1?this.skipTrigger=!0:this.skipTrigger=!1,this.window.open(url,"_self")},setInternalUrl:function(url){this.setUrl({url:url,states:{}})},getUrl:function(){return this.store.getUrl()},setUrl:function(url){this.store.setUrl(url)},generateUrl:function(route){return typeof route=="undefined"&&(route=this.current),this.store.generateUrl(route,!0)},setChangeListener:function(listener){this.changeListener=function(e){this.skipTrigger?this.skipTrigger=!1:listener(e.data.url)},this.store.on("urlChanged",this.changeListener,this)},setDestroyListener:function(listener){this.destroyListener=function(e){listener(e.data.url)},this.store.on("destroyed",this.destroyListener,this)},reset:function(){return this.backend.removeAllRoutes(),this.backend.bypassed.removeAll(),this},execute:function(hash){var parsed=this.store.parseUrl(hash);return this.current=parsed,this._applyRouter(parsed.url),this},stop:function(){this.changeListener&&(this.store.removeListener("urlChanged",this.changeListener,this),delete this.changeListener),this.destroyListener&&(this.store.removeListener("destroy",this.destroyListener,this),delete this.destroyListener)},getStateParameter:function(name){return this.current.states[name]},setStateParameter:function(name,value,isFireChanged){this.current.states[name]=value,this.setUrl(this.current),isFireChanged&&this.fire("stateChanged",{name:name,value:value})},getReferer:function(){return this.referer},setReferer:function(data){this.referer=data,storage.set("utils.routing.referer",this.referer)},restoreReferer:function(){var referer=storage.get("utils.routing.referer");return referer}});return Event.implementOn(Routing.prototype),Routing})