define(["Underscore","jQuery","tau/core/class","tau/core/event","tau/utils/utils.routing/utils.routing.store.hash","tau/utils/utils.storage","order!libs/crossroads.js/dist/js-signals","order!libs/crossroads.js/dist/crossroads"],function(_,$,a,b,c,d){var e=a.extend({init:function(a){return this.backend=window.crossroads,this.options=a,this.window=this.options.window||window,this.store=new c(this.options),this.current={url:"",states:{},source:""},this.processed={url:"",states:{},source:""},this.referer=this.restoreReferer(),this.reset(),this},register:function(a,b,c){var d=a;arguments.length>1&&(d={pattern:a,callback:b});var e=this;return this.backend.addRoute(d.pattern,function(){var a=Array.prototype.slice.call(arguments),b=this,c={};_.forEach(b._paramsIds,function(b,d){c[b]=a[d]});var f=e.processed.states;d.callback.apply(this,[c,f])}),this},register404:function(a){return this.backend.bypassed.add(a),this},_applyRouter:function(a){this.backend.parse(a)},start:function(){var a=this,b=_.bind(this._applyRouter,this),c=function(c){this.processed=c;if(this.processed.url!==this.current.url){this.setReferer(_.clone(this.current)),this.current=this.processed,b(this.current.url);return}var d=this.current.states,e=this.processed.states,f=_.union(_.keys(d),_.keys(e)),g={};_.forEach(f,function(a){d[a]!=e[a]&&(g[a]=e[a]||null)}),_.forEach(g,function(b,c){a.fire("stateChanged",{name:c,value:b})}),this.current=this.processed};this.setChangeListener(_.bind(c,this));var d=function(){this.setReferer(_.clone(this.current))};return this.setDestroyListener(_.bind(d,this)),this},redirect:function(a){this.window.open(a,"_self")},setInternalUrl:function(a){this.setUrl({url:a,states:{}})},getUrl:function(){return this.store.getUrl()},setUrl:function(a){this.store.setUrl(a)},generateUrl:function(a){return typeof a=="undefined"&&(a=this.current),this.store.generateUrl(a,!0)},setChangeListener:function(a){this.changeListener=function(b){a(b.data.url)},this.store.on("urlChanged",this.changeListener,this)},setDestroyListener:function(a){this.destroyListener=function(b){a(b.data.url)},this.store.on("destroyed",this.destroyListener,this)},reset:function(){return this.backend.removeAllRoutes(),this.backend.bypassed.removeAll(),this},execute:function(a){var b=this.store.parseUrl(a);return this.current=b,this._applyRouter(b.url),this},stop:function(){this.changeListener&&(this.store.removeListener("urlChanged",this.changeListener,this),delete this.changeListener),this.destroyListener&&(this.store.removeListener("destroy",this.destroyListener,this),delete this.destroyListener)},getStateParameter:function(a){return this.current.states[a]},setStateParameter:function(a,b,c){this.current.states[a]=b,this.setUrl(this.current),c&&this.fire("stateChanged",{name:a,value:b})},getReferer:function(){return this.referer},setReferer:function(a){this.referer=a,d.set("utils.routing.referer",this.referer)},restoreReferer:function(){var a=d.get("utils.routing.referer");return a}});return b.implementOn(e.prototype),e})