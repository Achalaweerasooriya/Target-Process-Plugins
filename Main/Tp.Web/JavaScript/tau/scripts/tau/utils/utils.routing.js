define(["Underscore","jQuery","tau/core/class","tau/core/event","tau/utils/utils.routing/utils.routing.store.hash","tau/utils/utils.storage","libs/crossroads.js/dist/crossroads"],function(t,e,r,s,i,n){var o=r.extend({init:function(t){var e=window.crossroads;return this.backend=e(),this.options=t,this.window=this.options.window||window,this.store=new i(this.options),this.v2=t.v2===!0,this.current={url:"",states:{},source:""},this.processed={url:"",states:{},source:""},this.referer=this.restoreReferer(),this.reset(),this},register:function(e,r){var s=e;arguments.length>1&&(s={pattern:e,callback:r});{var i=this;this.backend.addRoute(s.pattern,function(){var e=Array.prototype.slice.call(arguments),r=this,n={};t.forEach(r._paramsIds,function(t,r){n[t]=e[r]});var o=i.processed.states;s.callback.apply(this,t.union([n,o],e))})}return this},register404:function(t){return this.backend.bypassed.add(t),this},_applyRouter:function(t){this.backend.parse(t)},start:function(){var e=this,r=t.bind(this._applyRouter,this),s=function(s){if(this.processed=s,this.processed.url!==this.current.url)return this.setReferer(t.clone(this.current)),this.current=this.processed,void r(this.current.url);var i=this.current.states,n=this.processed.states,o=t.union(t.keys(i),t.keys(n)),h={};t.forEach(o,function(t){i[t]!=n[t]&&(h[t]=n[t]||null)}),t.forEach(h,function(t,r){e.fire("stateChanged",{name:r,value:t})}),this.current=this.processed};this.setChangeListener(t.bind(s,this));var i=function(){this.setReferer(t.clone(this.current))};return this.setDestroyListener(t.bind(i,this)),this},redirect:function(t,e){e=e||{},this.skipTrigger=e.trigger===!1?!0:!1,this.window.open(t,"_self")},setInternalUrl:function(t){this.setUrl({url:t,states:{}})},getUrl:function(){return this.store.getUrl()},setUrl:function(t){this.store.setUrl(t)},generateUrl:function(t){return"undefined"==typeof t&&(t=this.current),this.store.generateUrl(t,!0)},setChangeListener:function(t){this.changeListener=function(e){this.skipTrigger?this.skipTrigger=!1:t(e.data.url)},this.store.on("urlChanged",this.changeListener,this)},setDestroyListener:function(t){this.destroyListener=function(e){t(e.data.url)},this.store.on("destroyed",this.destroyListener,this)},reset:function(){return this.backend.removeAllRoutes(),this.backend.bypassed.removeAll(),this},execute:function(t){var e=this.store.parseUrl(t);return this.current=e,this._applyRouter(e.url),this},stop:function(){this.changeListener&&(this.store.removeListener("urlChanged",this.changeListener,this),delete this.changeListener),this.destroyListener&&(this.store.removeListener("destroy",this.destroyListener,this),delete this.destroyListener)},getStateParameter:function(t){return this.current.states[t]},setStateParameter:function(t,e,r){this.current.states[t]=e,this.setUrl(this.current),r&&this.fire("stateChanged",{name:t,value:e})},getReferer:function(){return this.referer},setReferer:function(t){this.referer=t,n.set("utils.routing.referer",this.referer)},restoreReferer:function(){var t=n.get("utils.routing.referer");return t}});return s.implementOn(o.prototype),o});