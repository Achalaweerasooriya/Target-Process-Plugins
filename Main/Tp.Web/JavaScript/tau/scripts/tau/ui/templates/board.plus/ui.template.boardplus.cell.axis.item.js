define(["Underscore","tau/core/templates-factory","tau/ui/extensions/board.plus/ui.board.plus.utils","tau/utils/utils.date","tau/utils/utils.translation","tau/ui/templates/board.plus/ui.template.boardplus.card.assignedUsers"],function(t,e,a,i,s){var n={name:"boardplus.cell.axis.item",engine:"jqote2",customFunctions:{generateCardData:a.generateElementData,generateFinishButtonOnDemand:function(e){var a="",i=["iteration","teamiteration"];return e&&e.canBeFinished&&t.contains(i,e.type.toLocaleLowerCase())&&(a=[' <span class="i-role-finish-iteration tau-label__finish tau-linkentity__inner" data-entity-id="',e.id,'" data-entity-type="',e.type,'">Finish</span>'].join("")),a},processDates:function(t,e,a,n){function r(t,e){t=i.parse(t),e=i.parse(e);var a=Math.floor((e-t)/36e5),n=Math.ceil(a/24);return n?n+" "+s.pluralize("day|days",n)+" left":a+" "+s.pluralize("hour|hours",a)+" left"}var l=i.convertToTimezone(t),o=i.convertToTimezone(e),u=a?"tau-label__date_current":"",c=a?' <span class="time-left">'+r(new Date,o)+"</span>":"",p=l.getYear()==o.getYear()?"d-MMM":i.getFormatData().date.short;return'<span class="tau-label tau-label__date '+u+'">'+i.formatAs(l,p)+" &mdash; "+i.formatAs(o,p)+c+this.generateFinishButtonOnDemand(n)+"</span>"},velocity:function(t){var e=t.units||"",a=t.effortSum||0;a=Math.round(a);var i=Math.round(t.velocity),s="tau-label__velocity_perfect",n="Perfect match!",r=i-a;if(0!==i&&0!==r){var l=100*Math.abs(r)/i;r>0&&(n="left."),0>r&&(n="overhead."),5>l?s="tau-label__velocity_warning":0>r&&(s="tau-label__velocity_overhead")}else 0!==r&&(r>0&&(n="left."),0>r&&(n="overhead."),0>r&&(s="tau-label__velocity_overhead"));var o="";return!t.id||"Iteration"!=t.type&&"TeamIteration"!=t.type||(o=this.burnDownIcon(t)),r=Math.abs(r),r=r?r+" "+e+" ":"",'<span class="tau-label tau-label__text tau-label__velocity">'+o+'<span class="tau-label_mark">'+a+'</span> of <span class="tau-label_mark">'+i+" "+e+'</span> assigned. <span class="'+s+'">'+r+n+"</span></span>"},effort:function(t){var e="",a=" done.",i="";
(!t.effortCompleted&&t.isCurrent||t.isPrevious||t.effortCompleted)&&(i='<span class="tau-label_mark">'+t.effortCompleted+"</span> of "),t.isCurrent&&(e="tau-label__effort_current"),t.isNext&&(e="tau-label__effort_next",t.effortCompleted||(a=" assigned.")),t.isPrevious&&(e="tau-label__effort_previous",t.effortCompleted==t.effortTotal&&(i=""));var s="";return"Release"==t.type&&t.id&&(s=this.burnDownIcon(t)),'<span class="tau-label tau-label__effort '+e+'">'+s+i+'<span class="tau-label_mark">'+t.effortTotal+" "+t.units+"</span>"+a+"</span>"},burnDownIcon:function(t){return'<span class="tau-icon tau-icon_type_svg tau-icon_name_burn-down tau-label__burnDown" data-entity-id="'+t.id+'" data-entity-type="'+t.type.toLowerCase()+'"></span>'},processTags:function(e){return t.compact(t.asString(e).split(","))},capacityHours:function(e){if(!t.isUndefined(e.assignedHours)){var a='<span class="tau-label_mark">'+e.assignedHours;if(a+=t.isUndefined(e.capacityHours)?"h</span>":'</span> of <span class="tau-label_mark">'+e.capacityHours+"h</span>",a+=" assigned.",!t.isUndefined(e.availableHours)){var i=e.availableHours>0?"tau-label__velocity_perfect":"tau-label__velocity_overhead",s=e.availableHours>0?"left":"overhead",n=Math.abs(e.availableHours)+"h "+s;a+=' <span class="'+i+'">'+n+".</span>"}return a}return""},capacityPoints:function(e){if(!t.isUndefined(e.assignedPoints)){var a='<span class="tau-label_mark">'+e.assignedPoints+"pt</span>";return a+=t.isUndefined(e.assignedHours)?" assigned.":" and "}return""},getTimePeriodEntitiesText:function(e){var a=t.map(e.timePeriodEntities,function(t){return t.name}).join(", ");return'<span title="'+a+'">'+a+"</span>"},getCapacityHint:function(e){if(!t.isUndefined(e.assignedHours)&&!t.isUndefined(e.availableHours)&&!t.isUndefined(e.capacityHours)){var a=e.availableHours>0?"h of work can be assigned.":"h over capacity.";return e.assignedHours+"h of unfinished work assigned. "+e.capacityHours+"h total capacity until "+this.term(e.timePeriodEntities[0].entityType.name,"name")+" ends. "+Math.abs(e.availableHours)+a
}return""}},markup:['<% var axis = this.itemData.hasOwnProperty("effort") ? "Y" : "X"; %>','<% if (this.entity.type == "user"){ %>','<div class="i-role-axis-item">','<div class="tau-axiscell__item tau-label i-role-focustrigger">',"<% if (this.isSupportView){ %>",'<span <% if (this.isSupportView){ %> class="i-role-cellaxis-viewtrigger" <% } %> <%= fn.generateCardData({ id: this.id, "entity-id": this.entity.id, "entity-type": this.entity.type}) %>>',"<% if (this.itemData.avatarUri){ %>",'<span class="tau-avatar tau-avatar_<%= this.entity.id %>" >','<img src="<%= this.itemData.avatarUri %>24" />',"</span>","<% } %>",'<span class="tau-label__text tau-name i-role-name"><%! this.name %></span>',"</span>","<% } else { %>",'<span class="i-role-name tau-name"><%! this.name %></span>',"<% } %>","</div>","<% if (this.itemData.capacity){ %>",'<span class="tau-label tau-label__user">','<span class="tau-label_mark"><%= this.itemData.roleName %></span>'," / <%= fn.getTimePeriodEntitiesText(this.itemData.capacity) %>","</span>",'<span class="tau-label tau-label__text tau-label__velocity  tau-label__user__velocity" title="<%= fn.getCapacityHint(this.itemData.capacity, axis) %>">','<span class="tau-label_mark"></span>',"<%= fn.capacityPoints(this.itemData.capacity) %>","<%= fn.capacityHours(this.itemData.capacity) %>","</span>","<% } %>","</div>",'<% } else if (axis == "Y" && (this.entity.type == "userstory" || this.entity.type == "feature") && this.itemData.id){ %>','<div class="i-role-axis-item tau-axiscell__item tau-label i-role-focustrigger">',"<% var item = this.itemData; %>",'<% if (item.hasOwnProperty("id")) { %>','<span class="<% if (this.isSupportView){ %>i-role-cellaxis-viewtrigger <% } %>tau-entity-icon tau-entity-icon--<%= this.entity.type %>" <%= fn.generateCardData({ id: this.id, "entity-id": this.entity.id, "entity-type": this.entity.type}) %>>',"<%= item.id %>","</span>","<% } %>",'<div class="tau-state"><%! item.entityState.name %></div>','<div class="<% if (this.isSupportView){ %>i-role-cellaxis-viewtrigger <% } %> tau-name  i-role-name"  <%= fn.generateCardData({ id: this.id, "entity-id": this.entity.id, "entity-type": this.entity.type}) %>><%! this.name %></div>',"<% if (item.project && item.project.abbreviation) {%>",'<div <% if (item.project.color){ %> style="background-color: <%= item.project.color %>;"<% } %> ','class="tau-project-abbr" title="<%! item.project.name %>"',">","<%! item.project.abbreviation %>","</div>","<% } %>","<% var usersCount = item.assignedUsers.length - 2;%>",'<%if (item.hasOwnProperty("assignedUsers")) {%>','<div class="tau-people">','<%= fn.sub("boardplus.card.assignedUsers",{count:usersCount,items:item.assignedUsers.slice(0,2),viewTrigger:true}) %>',"</div>","<% } %>",'<% if (item.hasOwnProperty("effort")){ %>','<div class="tau-effort">',"<%= item.effort %>",'<%= item.units || "pt" %>',"</div>","<% } %>","</div>",'<% } else if (this.entity.type === "entitystate" || this.entity.type === "priority") { %>','<div class="i-role-axis-item">','<div class="tau-axiscell__item tau-label i-role-focustrigger">',"<% if (this.isSupportView){ %>",'<span class="i-role-cellaxis-viewtrigger" <%= fn.generateCardData({ id: this.id, "entity-id": this.entity.id, "entity-type": this.entity.type}) %> >','<% if (this.entity.type == "team"){ %>',"<span>","<% if (this.itemData.icon){ %>","<i class=\"tau-icon tau-icon_type_svg tau-icon_name_<%= this.itemData.icon || '' %>\"></i>","<% } else { %>",'<i class="tau-icon tau-icon_type_svg tau-icon_name_trihead"></i>',"<% } %>","</span>",'<% } else if (this.entity.type == "project") { %>',"<% if (this.itemData.color){ %>",'<i class="tau-icon tau-icon_type_colortau-icon_type_color--axis" style="background-color: <%= this.itemData.color %>;"></i>',"<%} else {%>",'<i class="tau-icon tau-icon_type_color tau-icon_type_color--axis tau-icon_name_empty"></i>',"<%}%>","<% } else { %>",'<span class="tau-entity-icon tau-entity-icon--<%= this.entity.type %>" >',"<%= this.entity.id %>","</span>","<% } %>",'<span class="tau-label__text  i-role-name"><%! this.name %><%if(this.itemData.isCurrent){%> <span class="tau-label__text_current">(Current)</span><%}%></span></span>',"<% } else { %>",'<span class="i-role-name" <%= fn.generateCardData({ids: this.itemData.ids}) %>><%! this.name %><%if(this.itemData.isCurrent){%> <span class="tau-label__text_current">(Current)</span><%}%></span>',"<% } %>","</div>","<% } else { %>",'<div class="i-role-axis-item  tau-cell__wrap  <% if (this.entity.type == "testplan"){ %> tau-name-multiline <% } %> ">','<div class="tau-axiscell__item tau-label i-role-focustrigger  <% if (this.entity.type == "testplan"){ %> tau-name-multiline <% } %> ">',"<% if (this.isSupportView){ %>",'<span class="i-role-cellaxis-viewtrigger <% if (this.entity.type == "testplan"){ %> tau-name-multiline <% } %> " <%= fn.generateCardData({ id: this.id, "entity-id": this.entity.id, "entity-type": this.entity.type}) %> >','<% if (this.entity.type == "team"){ %>',"<span>","<% if (this.itemData.icon){ %>","<i class=\"tau-icon tau-icon_type_svg tau-icon_name_<%= this.itemData.icon || '' %>\"></i>","<% } else { %>",'<i class="tau-icon tau-icon_type_svg tau-icon_name_trihead"></i>',"<% } %>","</span>",'<% } else if (this.entity.type == "project") { %>',"<% if (this.itemData.color){ %>",'<i class="tau-icon tau-icon_type_color tau-icon_type_color--axis" style="background-color: <%= this.itemData.color %>;"></i>',"<%} else {%>",'<i class="tau-icon tau-icon_type_color tau-icon_type_color--axis tau-icon_name_empty"></i>',"<%}%>","<% } else { %>",'<span class="tau-entity-icon tau-entity-icon--<%= this.entity.type %>" >',"<%= this.entity.id %>","</span>","<% } %>",'<span class="tau-label__text  i-role-name"><%! this.name %><%if(this.itemData.isCurrent){%> <span class="tau-label__text_current">(Current)</span><%}%></span></span>',"<% } else { %>",'<span class="i-role-name"><%! this.name %><%if(this.itemData.isCurrent){%> <span class="tau-label__text_current">(Current)</span><%}%></span>',"<% } %>","</div>",'<% if (this.entity.type == "team"){ %>','<div class="tau-team-members">',"<% var users = this.itemData.users || []; _.forEach(users, function(user,index,users){ %>","<%if(index < 7){%>",'<span class="tau-avatar i-role-cellaxis-viewtrigger" <%= fn.generateCardData({ id: user.id, "entity-id": user.id, "entity-type": "user"}) %> ><img title="<%= user.name %>" src="<%= user.avatarUri %>24" /></span>',"<%}%>","<%if(index == 7){%>",'<span class="count-users">+ <%=users.length - index%></span>',"<%}%>","<% });  %>","</div>","<% } %>","<% if (this.itemData.startDate && this.itemData.endDate){ %>","<%= fn.processDates(this.itemData.startDate, this.itemData.endDate, this.itemData.isCurrent, {id:this.entity.id, type:this.entity.type, canBeFinished:this.itemData.canBeFinished})%>","<% } %>","<% if (this.itemData.velocity !== undefined){%>","<%= fn.velocity(this.itemData)%>","<%}%>","<% if (this.itemData.effortCompleted !== undefined && this.itemData.effortTotal !== undefined){%>","<%= fn.effort(this.itemData)%>","<%}%>","</div>","<% } %>"],dependencies:[]};
return e.register(n)});