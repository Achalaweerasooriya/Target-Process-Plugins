define(["jQuery","tau/core/templates-factory","tau/utils/utils.date"],function($,templates,dateUtils){var config={name:"search",engine:"jqote2",customFunctions:{generatePagingItems:function(current,total,radix){var r=[],lb=_.max([current-radix,0]),rb=_.min([current+radix,total-1]);for(var i=0;i<total;i++)i===0||i===total-1?r.push({index:i,text:i+1}):i>=lb&&i<=rb?r.push({index:i,text:i+1}):(i===lb-1||i===rb+1)&&r.push({index:i,text:"..."});return r},formatDate:function(createDate){var xAge=dateUtils.getAge(createDate),age=xAge.isZero?"Just added":xAge.toString(),fmt=dateUtils.format.date.short(dateUtils.convertToTimezone(createDate));return fmt+" ("+age+")"},highlight:function(textNode,key){function innerHighlight(node,pat){var skip=0;if(node.nodeType==Node.TEXT_NODE){var pos=node.data.toUpperCase().indexOf(pat);if(pos>=0){var spannode=document.createElement("span");spannode.className="tau-search-txt";var middlebit=node.splitText(pos),endbit=middlebit.splitText(pat.length),middleclone=middlebit.cloneNode(!0);spannode.appendChild(middleclone),middlebit.parentNode.replaceChild(spannode,middlebit),skip=1}}else if(node.nodeType==1&&node.childNodes&&!/(script|style)/i.test(node.tagName))for(var i=0;i<node.childNodes.length;++i)i+=innerHighlight(node.childNodes[i],pat);return skip}return textNode.each(function(){innerHighlight(this,key.toUpperCase())})},nodeCutOffIterator:function(htmlNode,radix){if(htmlNode){var txt=htmlNode.textContent.replace(/\s+/g," "),len=txt.length,splitChars=[" ","[","]","{","}","(",")","/","\\",",",".",":",";","?","!","&","+","-","*"];if(len>2*radix){var startIndex=_.indexOfAnyChar(txt,splitChars,radix);startIndex=startIndex===-1?radix:startIndex;var partStart=txt.substring(0,startIndex),rest=len-radix,endIndex=_.indexOfAnyChar(txt,splitChars,rest);endIndex=endIndex===-1?rest:endIndex;var partEnd=txt.substring(endIndex,len);htmlNode.textContent=partStart+" ... "+partEnd}}return htmlNode},format:function(originText,keywords,doShort){var fn=this;originText=originText||"",originText=$("<div>"+originText+"</div>").text(),originText=$.trim(originText).replace(/</g,"&lt;").replace(/>/g,"&gt;");if(originText.length===0)return"";var newTextNode=$("<div>"+originText+"</div>");$.each(keywords,function(i,val){newTextNode=fn.highlight(newTextNode,val)});var resultNode;if(!doShort)resultNode=newTextNode;else{resultNode=$("<div></div>");var textIterator=fn.nodeCutOffIterator,hiddenMatches=0,charsCounter=0;newTextNode.contents().each(function(i,val){var isTextNode=val.nodeType==Node.TEXT_NODE,node;if(!isTextNode){var text=$(val).text();charsCounter+=text.length,node=val}else node=textIterator(val,30),charsCounter+=node.textContent.length;charsCounter>315?!isTextNode&&++hiddenMatches:resultNode.append(node)}),hiddenMatches>0&&resultNode.append('... <strong class="more-matches">+ '+hiddenMatches+" more match"+(hiddenMatches>1?"es":"")+".</strong>")}return resultNode.html()}},markup:["<% if (this.error) { %>",'<div class="tau-search-results">','<div class="tau-items">','<div class="tau-search-item">','<div class="tau-search-content">','<div class="tau-body">Search is failed. Try again or contact support</div>',"</div>","</div>","</div>","</div>","<% } else { %>",'<div class="tau-search-results">','<div class="tau-items">',"<% var keywords = this.keywords; %>","<% if (this.items.length === 0) { %>",'<div class="tau-search-item">','<div class="tau-search-content">','<div class="tau-body">Nothing found</div>',"</div>","</div>","<% } %>","<% _.forEach(this.items, function(d) { %>","<% var entityType = d.entityType.name.toLowerCase(); %>",'<% var isComment = (entityType === "comment"); %>','<% var isTestCase = (entityType === "testcase"); %>','<div class="tau-search-item">','<div class="tau-search-content">','<div class="tau-header">','<span class="tau-entity tau-<%= d.entityType.name.toLowerCase() %>"><%= d.entityType.term %></span>',"<% if (isComment) { %>",'<span class="tau-entity tau-<%= d.general.entityType.name.toLowerCase() %>"><%= d.general.entityType.term %></span>','<a href="#<%= d.general.entityType.name %>/<%= d.general.id %>" class="tau-entity-id">#<%= d.general.id %></a>',"<% } else { %>",'<a href="#<%= d.entityType.name %>/<%= d.id %>" class="tau-entity-id">#<%= d.id %></a>','<span class="tau-entity-filter"><%= fn.format(d.tags.join(" "), keywords, false) %></span>',"<% } %>","</div>",'<div class="tau-body">',"<% if (isComment) { %>",'<h3><a href="#<%= d.general.entityType.name %>/<%= d.general.id %>"><%= d.general.name %></a></h3>',"<% } else { %>",'<h3><a href="#<%= d.entityType.name %>/<%= d.id %>"><%= fn.format(d.nameExt, keywords, false) %></a></h3>',"<% } %>","<% if (isTestCase) { %>","<% if (d.steps) { %><p><strong>Steps:</strong> <%= fn.format(d.steps, keywords, true) %></p><% } %>","<% if (d.success) { %><p><strong>Success:</strong> <%= fn.format(d.success, keywords, true) %></p><% } %>","<% } else { %>","<p><%= fn.format(d.descExt, keywords, true) %></p>","<% } %>","</div>","</div>",'<div class="tau-search-info">',"<% if (d.entityState) { %>",'<div class="tau-line<% if (d.entityState.isFinal) { %> tau-done-entity<% } %>">','<div class="tau-caption">State</div>','<div class="tau-txt"><%= d.entityState.name %></div>',"</div>","<% } %>",'<div class="tau-line">','<div class="tau-caption">Ð¡reated</div>','<div class="tau-txt"><%= fn.formatDate(d.createDate) %></div>',"</div>","<% if (d.project) { %>",'<div class="tau-line">','<div class="tau-caption">Project</div>','<div class="tau-txt"><%= d.project.name %></div>',"</div>","<% } %>","<% if (d.team) { %>",'<div class="tau-line">','<div class="tau-caption">Team</div>','<div class="tau-txt">','<span><%= d.team.name %></span><% if (d.team.icon) { %><i class="tau-icon tau-icon_type_svg tau-icon_name_<%! d.team.icon %>"></i><% } %>',"</div>","</div>","<% } %>","</div>","</div>","<% }); %>","</div>","<% var pagesCount = Math.ceil(this.info.total / this.info.pageSize); %>","<% if (pagesCount > 1) { %>",'<div class="tau-paging i-role-paging-container">','<div class="tau-links">','<a href="" class="tau-prev<% if (this.info.pageNo == 0) { %> tau-disabled<% } %> i-role-paging-prev">Previous <%= this.info.pageSize %></a>','<a href="" class="tau-next<% if (this.info.pageNo == (pagesCount - 1)) { %> tau-disabled<% } %> i-role-paging-next">Next <%= this.info.pageSize %></a>',"</div>",'<ul class="i-role-paging-pageno">',"<% var pagingItems = fn.generatePagingItems(this.info.pageNo, pagesCount, 5); %>","<% for (var i = 0; i < pagingItems.length; i++) { %>","<% var item = pagingItems[i]; %>","<% if (item.index == this.info.pageNo) { %>",'<li class="active"><span><%= item.text %></span></li>',"<% } else { %>",'<li><a href="" data-page="<%= item.index %>"><%= item.text %></a></li>',"<% } %>","<% } %>","</ul>","</div>","<% } %>","</div>","<% } %>"]};return templates.register(config)})