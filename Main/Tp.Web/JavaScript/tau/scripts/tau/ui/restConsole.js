define(["Underscore","jQuery","app.path","tau/store/repository","tau/store/services/service.rest","tau/store/store","tau/store/types.targetprocess","libs/jquery/jquery.console","libs/json2"],function(_,$,AppPath,repository,serviceRest,store,tauTypes){function initConsole(e){control=$("#console").console({promptLabel:"tau > ",commandValidate:function(e){return""==e?!1:!0},continuedPromptLabel:"  ",commandHandle:function(t,r){var s=e.parse(t);r(s)},autofocus:!0,animateScroll:!0,promptHistory:!0,welcomeMessage:["Welcome to <b>TargetProccess Rest v.1</b> console","---------------------------------------------------","You can execute rest commands using javascript here","<br/>"].join("<br/>")}),layout(),$(window).resize(layout)}function layout(){$("#console, #console .jquery-console-inner").css({height:$(window).height()-12+"px"})}var control=null;$(function(){var restApi=new serviceRest({appPath:AppPath.get(),path:AppPath.get()+"/api/v1"}),repInstance=new repository({service:restApi}),storeInstance=new store({proxy:repInstance}),commandProcessor={command:{},currentId:0,store:storeInstance,parse:function(e){try{this.currentId++;var t=this._parse(e)||"";if("clear"===t)return;return[{msg:JSON.stringify(this.command)+"<div class='rest-out' id='r"+this.currentId+"'>"+t+"</div>",className:"jquery-console-message-value"}]}catch(r){return[{msg:"Error:"+r.message,className:"jquery-console-message-error"}]}},_getRef:function(e,t,r){var s={};s[e]=[];var n=t[r.refs[e].name];return 1===n.fields.length&&_.each(_.keys(n.refs),function(t){if(t.indexOf("parent")<0&&t.indexOf("general")<0&&t.indexOf("assignable")<0){var r={};r[t]=[],s[e].push(r)}}),s},_appendAllFields:function(){var e=tauTypes.getDictionary(),t=e[this.command.type],r=[];"context"!==t.name&&_.each(t.simpleFields,function(e){r.push(e)}),_.extend(this.command.config,{fields:r})},_doRequest:function(){var e=this.currentId,t=new Date,r=null,s={success:function(s){var n="<div class='stats'>execution time: "+(new Date-t)/1e3+" ms</div>",o=_.isArray(s.data)?s.data.length:1;n+="<pre class='prettyprint'>"+JSON.stringify(s.data,null,"	")+"</pre>",n+="<div class='stats'>"+o+" entities(s) retrieved</div>",$("#r"+e).html(n),control.scrollToBottom(),r=n},failure:function(t){var r=t.data,s=r.responseText.length>1e3?"request failed: "+r.status+" "+r.statusText:r.responseText;$("#r"+e).html(s).addClass("jquery-console-message-error").removeClass("rest-out")}};return _.defaults(this.command,{name:"get"}),this.store[this.command.name](this.command.type,this.command.config,s).done(),r},_getHelp:function(e){var t=null,r=["types? - display the information about all types","&lt;type&gt;? - display the information about type. For example: story?","","GET command can be formed using following steps: <ul>","<li>  Provide type of entity. For example: story","<li>  Provide id of entity. For example: id:2",'<li>  Configure command fields.For example: fields:["id", "name", { entityState: [] }]','<li>  Use "done" to complete command configuration',"</ul>","resource/id - get entity with all fields for defined resource by id","For example: story/2"].join("<br/>");if(e.indexOf("types")>=0)t=_.keys(tauTypes.getDictionary());else{var s=tauTypes.findByKeyword(e.substr(0,e.length-1));s&&(t=s)}return t?"<pre><code>"+JSON.stringify(t||{},null,"	")+"</code></pre>":r},_processResourcePath:function(e){var t=e.split("\\");if(1===t.length&&(t=e.split("/")),1===t.length)return null;var r=tauTypes.findByKeyword(t[0]);if(!r)return null;var s=parseInt(t[1]);if(!_.isNumber(s))return null;if(this.command.type=r.name,_.extend(this.command.config,{id:s}),t.length>2){var n=t[2].split(","),o=[];_.each(n,function(e){if(!r.refs.hasOwnProperty(e))return void o.push(e);var t={};t[e]=[],o.push(t)}),_.extend(this.command.config,{fields:o})}else this._appendAllFields();return this._doRequest()||"executing request: '"+e+"'..."},_parse:function(arg){_.defaults(this.command,{name:"get",config:{}});var resourceParts=this._processResourcePath(arg);if(resourceParts)return resourceParts;if("?"===arg[arg.length-1])return this._getHelp(arg);if("clear"===arg.toLowerCase())return $(".jquery-console-inner>div").remove(),"clear";if("done"==arg)return this._doRequest()||"executing command...";var type=tauTypes.findByKeyword(arg);return type?void(this.command.type=type.name):"all_fields"==arg&&this.command.type?void this._appendAllFields():(eval("var setting = {"+arg+"}"),setting.hasOwnProperty("type")||setting.hasOwnProperty("name")?void _.extend(this.command,setting):void _.extend(this.command.config,setting))}};initConsole(commandProcessor)})});