define(["jQuery","Underscore","tau/core/extension.base"],function($,_,ExtensionBase){return ExtensionBase.extend({init:function(){this._super.apply(this,arguments),this.fire("view.card.selection.ref",{last:{position:-1},stack:[]})},"bus view.card.selection.ref:last + domWrapper.ready":function(e,selectionRef,domWrapper){var self=this,$selectable=domWrapper.getGrid();$selectable.tauSelectable({items:".i-role-card",ctrl:!0,forceSelection:!0,className:"tau-selected",changed:function(event,ui){var $item=ui.item,selected=ui.selected,data=$item.data();if(selected)selectionRef.last.position=$item.index(),selectionRef.stack[selectionRef.stack.length-1]!==data.id&&selectionRef.stack.push(data.id);else{var i=_.indexOf(selectionRef.stack,data.id);selectionRef.stack.splice(i,1)}self.fire("view.card.selected",{element:$item,selected:selected})}}),self.fire("$selectable.ready",$selectable)},"bus $selectable.ready + domWrapper.ready":function(e,$selectable,domWrapper){var $first=domWrapper.getCardByPositionOrLast(0);$selectable.tauSelectable("select",$first)},"bus domWrapper.ready:last + $selectable.ready:last + view.card.selection.ref:last + selection.reapply":function(ev,domWrapper,$selectable,selectionRef,operation){var $markedAsSelected=$selectable.tauSelectable("getSelected");$selectable.tauSelectable("option","fireEvents",!1),$selectable.tauSelectable("select",$markedAsSelected),$selectable.tauSelectable("option","fireEvents",!0);var liveCardIDs=[];$markedAsSelected.each(function(i){liveCardIDs.push($(this).data("id"))}),selectionRef.stack=_.intersection(selectionRef.stack,liveCardIDs);var $lastCard=null;if(selectionRef.stack.length===0)$lastCard=domWrapper.getCardByPositionOrLast(selectionRef.last.position),$lastCard.size()>0?$selectable.tauSelectable("select",$lastCard):this.fire("view.empty.cardDetails");else{var id=selectionRef.stack[selectionRef.stack.length-1];$lastCard=domWrapper.getCardBySliceId(id),selectionRef.last.position=$lastCard.index();var d=$lastCard.data()}},"bus $selectable.ready:last + view.card.selected":function(e,$selectable,selectedCard){$selectable.tauSelectable("option","fireEvents",!1),$selectable.tauSelectable(selectedCard.selected?"select":"reset",selectedCard.element),$selectable.tauSelectable("option","fireEvents",!0)}})})