define(["require","Underscore","jQuery","libs/react/react-ex","tau/core/extension.base.stateful","tau/services/data.service","jsx!tau/components/workflow.selector/views/workflowSelectorWithControls","tau/components/process.menu/models/workflow.entitytypes.order","tau/core/termProcessor","tau/components/workflow.selector/utils/workflow.utils"],function(e){"use strict";var t=e("Underscore"),o=e("jQuery"),r=e("libs/react/react-ex"),n=e("tau/core/extension.base.stateful"),s=e("tau/services/data.service"),i=e("jsx!tau/components/workflow.selector/views/workflowSelectorWithControls"),a=e("tau/components/process.menu/models/workflow.entitytypes.order"),c=e("tau/core/termProcessor"),l=e("tau/components/workflow.selector/utils/workflow.utils"),u=s.extend({getTeamProjectData:function(e){return this._getTeamProject(e).then(function(e){var r=e.project.processId,n=t.pluck(e.workflows.items,"id");return o.when(this._getTerms(r),this._getWorkflows(r)).then(function(o,s){var i=t.map(t.filter(s,function(e){return t.contains(e.process.practiceIds,e.entityType.practiceId)}),l.workflowMapper());return{processId:r,team:e.team,teamWorkflows:n,terms:o,workflows:i}})}.bind(this))},saveTeamProject:function(e,o){var r=t.map(o,function(e){return{id:e.id}});return this._store.saveDef("teamProject",{id:e,$set:{workflows:r},fields:["id",{workflows:["id","name","parentWorkflow"]}]})},_getTeamProject:function(e){return this._findOne("teamProject",{select:["Id","Team:{team.Id,team.Name}","Project:{project.Process.Id as processId}","Workflows"],where:{id:e}})},_getTerms:function(e){return this._find("term",{select:["wordKey","value","process:{process.id}"],where:{"process.id":e}})},_getWorkflows:function(e){return this._find("workflow",{select:["id","name","entityType:{entityType.id,entityType.name,entityType.Practice.id as practiceId}","process:{process.id,process.practices.Select(id) as practiceIds}","entityStates.Select({id,name}) as entityStates","parentWorkflow"],where:{"process.id":e}})}});return n.extend({"bus beforeInit":function(e,t){this._keyBoardManager=t.config.context.configurator.getKeyBoardManager()
},"bus afterRender":function(e,r){var n=this.config.context.configurator,s=new u(n.getStore(),n.getStore2(),n.service("errorBar"));r.element.on("click",".i-role-team-customize",function(e){var r=o(e.currentTarget),n=parseInt(r.parents("[role=item]:first").data("entity-id")),i=function(e){t.isEmpty(e)||(r.addClass("tau-icon-loading"),s.saveTeamProject(n,e).then(function(e){e.data&&e.data.workflows&&e.data.workflows.length>0&&this._updateSettingButton(r,e.data.workflows),r.removeClass("tau-icon-loading")}.bind(this),function(){r.removeClass("tau-icon-loading")})),r.tauBubble("hide")}.bind(this);s.getTeamProjectData(n).then(function(e){var t=this._createWorkflowSelectorView(e.team,e.teamWorkflows,e.processId,e.terms,e.workflows,i);this._createPopup(r,t)}.bind(this))}.bind(this))},_createPopup:function(e,t){var n=this._keyBoardManager;e.tauBubble({showOnCreation:!0,cleanupOnHide:!0,hideOnScroll:!1,content:t,onPositionConfig:function(e){e.collision="fit flip",e.within=o(".tau-teamsProjects-tab"),e.my="center top",e.at="right bottom"},onShow:function(){n.pushHandler({})},onHide:function(){n.popHandler(),r.unmountComponentAtNode(t[0]),this.destroy()},onResize:function(e){var t=e.find(".tau-bubble__inner"),r=t.outerHeight(!0)-t.height(),n=e.find(".tau-settings-actions").outerHeight(!0),s=o(".tau-workflow-settings-state-list-title").innerHeight(),i=r+n+s,a=Math.max(o(window).height()/3,o(window).height()-t.offset().top-i);e.find(".tau-category-items-workflow-settings").css({maxHeight:a+"px",overflowX:"hidden",overflowY:"auto"})},zIndex:9999})},_createWorkflowSelectorView:function(e,n,s,u,d,f){var w=o("<div>").addClass("tau-customize-flow tau-popup"),p=t.chain(d).filter(function(e){return t.contains(n,e.id)}).map(function(e){return[e.entityType,e]}).object().value(),m={group:e,workflows:d,entityTypes:a,terms:new c(u),selectedProcessId:s,customizedWorkflows:p,visible:!0,workflowHelpData:l.getWorkflowHelpData(this.config.context.configurator,s,"userstory"),onWorkflowChanged:o.noop,onWorkflowSaved:f};
return r.renderClass(i,m,w[0]),w},_updateSettingButton:function(e,o){var r=t.some(o,function(e){return e.parentWorkflow});e.removeClass("tau-icon-settings-small-dark").removeClass("tau-icon-settings-small-blue").addClass(r?"tau-icon-settings-small-blue":"tau-icon-settings-small-dark")}})});