define(["Underscore","jQuery","tau/components/extensions/component.extension.base"],function(e,t,i){return i.extend({category:"edit",onInit:function(){this._isSwitchedOn=!0},"bus beforeInit + afterRender":function(t,i,n){this.attach(n.element),i.config.context.configurator.getComponentBusRegistry().getByName("imagePreview").done(e.bind(function(e){this.previewBus=e,this.fire("previewBus.ready",e)},this))},attach:function(i){var n=this.config.imagePreviewContentSelector,r=i.find(n+" img");if(r.size()>0)var a=setInterval(e.bind(function(){t.contains(document.body,i[0])&&(clearInterval(a),this.fire("view.dom.ready"))},this),1e3)},"bus props.ready + afterRender:last":function(e,t,i){this.attach(i.element)},"bus afterRender + view.dom.ready + previewBus.ready":function(e,t){this._toggleFullPreviewMode(t.element)},"bus toggle.full.preview.mode + previewBus.ready:last":function(e,t){this._isSwitchedOn=t.on,this._toggleFullPreviewMode(t.element)},_toggleFullPreviewMode:function(e){var i=this.config.imagePreviewContentSelector;if(this._isSwitchedOn){var n=e.find(i+" img:not(.emoji)"),r=n.filter(function(){return parseInt(this.naturalWidth,10)>this.width||parseInt(this.naturalHeight,10)>this.height});if(r.length>0){var a=t('<div class="tau-lightbox-container" />'),o=t(['<a target="_blank" class="i-role-fullview tau-lightbox-full-size">',"View Full Size","</a>"].join(""));r.each(function(e){var i=t(this);i.data("id",e),i.wrap(a).after(o.clone().attr("href",i.attr("src")).data("id",e))})}this._bindImageHandler(e,n)}else{var s=e.find(i+" .i-role-fullview");s.length>0&&(s.unwrap(),s.remove())}},_bindImageHandler:function(e,i){e.off("click mousedown",".i-role-fullview");var n=this.previewBus;e.on("click mousedown",".i-role-fullview",function(e){e.preventDefault(),e.stopPropagation(),"click"==e.type&&n.fire("refresh",{items:i.map(function(){var e=t(this),i=e.attr("src");return{id:e.data("id"),uri:i,thumbnailUri:i}}),selectedId:t(this).data("id")})})}})});