define(["jQuery","Underscore","tau/utils/utils.boardCard","tau/core/class"],function(t,e,i,r){return r.extend({targetMarkerClass:"i-role-context-menu-bubble",init:function(r,a){this.$trigger=r,this.activationCssClass=a.settings.activationCssClass,this.propertiesToEvict=a.settings.propertiesToEvict,this.bus=a.settings.bus,this.configurator=a.settings.configurator,this.updateCardAction=e.bind(a.updateCard,a),this.cardData=r.data(),this.entity=i.convertToEntity(this.cardData),this.cardSelector='.i-role-permanent-card-is-editing.i-role-card[data-entity-id="'+this.entity.id+'"]',this.coords=r.closest(".i-role-cellholder").data(),t("."+this.targetMarkerClass).remove()},getAlignTo:function(e){var i=t(this.cardSelector),r=e.settings.viewMode;return"timeline"==r&&i.parent().is(".i-role-timeline-card-holder,.i-role-timeline-planner-card-holder")?i.parent():(0===i.length&&this.$trigger&&(i=t(this.$trigger.data("card-selector"))),i)},getTarget:function(){var e=t("."+this.targetMarkerClass);return 0===e.length&&(e=t("<div></div>").addClass(this.targetMarkerClass).appendTo("body")),e},createBubble:function(i){var r=this;if(this.$trigger.addClass("i-role-permanent-card-is-editing"),0===i.alignTo().length)return void this.$trigger.removeClass("i-role-permanent-card-is-editing");var a=this.getTarget(),n={cleanupOnHide:!0,target:a,showEvent:"",zIndex:99999},s=e.extend(n,i);r.propertiesToEvict.length>0&&r.configurator.getStore().evictProperties(r.entity.id,r.entity.entityType.name,r.propertiesToEvict),s.onShow=function(){t(r.cardSelector).addClass(r.activationCssClass),r.configurator.getStore().on({eventName:"afterSave",type:r.entity.entityType.name,listener:this,filter:{id:r.entity.id},changes:i.entitySubscriptionChanges},e.bind(function(t){var e=i.skipUpdateEntity&&i.skipUpdateEntity(t.data.cmd);if(!e){var n=r.updateCardAction(r.entity.id,r.coords,r.cardData);n.done(function(){var t=a.tauBubble("getAlignTo"),e=t.is(a)?"hide":"adjust";a.tauBubble(e)})}},this)),i.onBubbleShow&&i.onBubbleShow()},s.onHide=function(){t(r.cardSelector).removeClass(r.activationCssClass).removeClass("i-role-permanent-card-is-editing"),r.configurator.getStore().unbind(this),i.onBubbleHide&&i.onBubbleHide()},this.bus.fire("initBubble",s),a.tauBubble("show")}})});