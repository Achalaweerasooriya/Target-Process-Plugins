define(["Underscore","jQuery","tau/core/class","tau/libs/store2/store2","tau/utils/utils.constants","tau/ui/templates/inviter/ui.template.inviter.widget.members","tau/ui/extensions/user/jquery.tauUserAutocomplete"],function(t,e,i,s,n,o){var r=i.extend({init:function(e){this.options=t.defaults(t.extend({},e),{allowEmails:!1}),this.data=[]},_containsUser:function(e){return t.some(this.data,function(t){return e.id&&t.id==e.id||t.email===e.email})},add:function(t){return this._containsUser(t)?!1:(this.data.push(t),!0)},addBatch:function(e){t.map(e,this.add,this)},addByString:function(e){var i=this.split(t.trim(e)),s=[],n=[];return t.forEach(i,t.bind(function(t){if(this.options.allowEmails&&this.isEmail(t)){var e={id:null,email:t,name:t,firstName:null,lastName:null,login:t,type:"invited",state:"notconfirmed"};this.add(e)&&n.push(e)}else s.push(t)},this)),{items:n,rest:s.join(" ")}},split:function(e){return t.compact(t.trim(e).split(/[\s,]+/))},remove:function(e){this.data=t.reject(this.data,function(t){return t.id==e.id})},isEmpty:function(){return!this.data.length},getAll:function(){return this.data},isEmail:function(t){return t.match(n.get("emailRegexp"))}});return e.widget("ui.tauInviter",{options:{configurator:null,autocompleteQueryAdd:"",autocompleteFieldsQueryAdd:"",autocompletePosition:{},messagePosition:{},allowEmails:!1,allowOnlyExistingUsers:!1,minLength:2,bubblesAppendTo:null,processItems:null,canDelete:function(){return!0},reforwardingOption:["autocompleteQueryAdd","autocompleteFieldsQueryAdd","minLength","autocompleteTakeQueryAdd","showLoading"]},_setOption:function(e,i){"reforwardingOption"===e&&(i=this.options.reforwardingOption.concat(i)),t.contains(this.options.reforwardingOption,e)&&this.$inp.tauUserAutocomplete("option",e,i),this._super(e,i)},_create:function(){this.configurator=this.options.configurator,this.$el=this.element,this.openInnerBubble=!1,this.model=new r({allowEmails:this.options.allowEmails}),this._initTemplates(),this._initWidget()},_initTemplates:function(){var t=this.configurator.getTemplateFactory();
t.register({name:"board.context.filter.members-widget.selectedItem",engine:"jqote2",markup:["<li class=\"tau-user tau-user-<%! this.type || 'existing' %> i-role-member\">","<% if (this.avatarUri) { %>",'<img class="tau-user__avatar" width="20" height="20" alt="" src="<%= this.avatarUri%>32" />',"<% } %>",'<span class="tau-user__name"><%! this.name %></span>','<i class="tau-delete i-role-action-delete"></i>',"</li>"]}),t.register({name:"board.context.filter.members-widget.popupContent",engine:"jqote2",markup:["<span><%! this.main %></span>","<% if (this.sub) { %>",'<div class="tau-message <%! this.type %>"><%! this.sub %></div>',"<% } %>"]})},_initWidget:function(){this.$widget=this.configurator.getTemplateFactory().get(o.name).bind({},{}),this.$el.hide(),this.$el.after(this.$widget);var i=this.$widget,s=i.find(".i-role-input");this.$inp=s,this.$inpLi=s.closest("li"),this.$helper=i.find(".i-role-systemhelper"),this.$sizer=i.find(".i-role-sizer"),this.$placeholder=i.find(".i-role-placeholder");var n=this.$el.attr("placeholder");n&&this.$placeholder.text(n),this.initBubbled(),i.on("click",function(){s.focus()}),i.on("click",".i-role-action-delete",t.bind(function(t){var i=e(t.currentTarget).closest("li");this.removeItem(i,function(){this.$placeholder.toggle(this.model.isEmpty())}.bind(this))},this)),i.on("process",t.bind(this.processInput,this,!1)),this.initInput(),this.initAutocomplete()},initBubbled:function(){var e=t.defaults(this.options.messagePosition,{my:"left top",at:"left bottom+5",collision:"none"});this.$bubbled=this.$widget.tauBubble({template:['<div class="tau-invite-widget-tooltip">','    <div class="i-role-content" role="content"></div>',"</div>"].join(""),stackName:"members-widget",showEvent:"nothing",hideEvent:"nothing",appendTo:this.options.bubblesAppendTo,onPositionConfig:function(i){return t.extend(i,e)}})},initInput:function(){var i=(this.$helper,this.$placeholder),s=this.$inp;s.on("input",function(){i.hide()}),this.model.isEmpty()||i.hide(),s.focusin(t.bind(function(){this.model.isEmpty()||i.hide(),this.hideMessage()
},this)),s.focusout(t.bind(function(){""===s.val()&&this.model.isEmpty()&&i.show()},this)),s.on("keydown",function(t){var i="";switch(t.which){case e.ui.keyCode.ESCAPE:if(this.openInnerBubble)return this.hideMessage(),t.stopPropagation(),t.preventDefault(),!1;break;case e.ui.keyCode.ENTER:if(i="enter",""===s.val())return;t.stopPropagation(),t.preventDefault();break;case e.ui.keyCode.BACKSPACE:i="backspace";break;case e.ui.keyCode.SPACE:i="whitespace"}return i&&(s.trigger("keydown:"+i,t),"enter"==i)?!1:void 0}.bind(this)),s.on("keydown:enter",t.bind(function(){this.processInput(),this.resetSize()},this)),s.on("keydown:whitespace",t.bind(function(){this.processInput(),s.tauUserAutocomplete("close"),this.hideMessage()},this)),s.on("keydown:backspace",t.bind(function(){if(!s.val().length){var t=s.closest("li").prev();this.removeItem(t,function(){this.resetSize()}.bind(this))}this.hideMessage()},this)),s.on("keyup",t.bind(function(){this.refreshHelper(),this.syncSize()},this)),s.on("paste",t.bind(function(){setTimeout(t.bind(function(){this.processInput(),this.syncSize()},this),1)},this))},setValue:function(t){this.model.data=[],this.model.addBatch(t),this.syncFromModel()},syncFromModel:function(){this.$widget.find(".i-role-member").remove(),this.addItems(this.model.getAll()),this.$placeholder.toggle(this.model.isEmpty())},addItems:function(e){t.forEach(e,t.bind(function(t){var e=this.createItem(t);this.$inpLi.before(e)},this))},getValue:function(t){return t&&this.processInput(),this.model.data},focus:function(){this.$inp.focus()},processInput:function(t){var e=this.$inp.val();if(e.length>0){var i=this.model.addByString(e);this.addItems(i.items),this.$inp.val(i.rest),t!==!1&&this.$inp.focus(),this.emptyHelper(),this.hideMessage(),this._trigger("change")}},showMessage:function(t){var e=this.bt("board.context.filter.members-widget.popupContent",t);this.$bubbled.tauBubble("option","content",e).tauBubble("option","alignTo",this.$inp).tauBubble("show"),this.openInnerBubble=!0},hideMessage:function(){this.$bubbled.data("ui-tauBubble")&&this.$bubbled.tauBubble("hide"),this.openInnerBubble=!1
},split:function(e){return t.compact(t.trim(e).split(/[\s,]+/))},resultBubble:function(e){var i=t.last(this.split(e));if(i&&i.length>=this.options.minLength||0===e.length&&0===this.options.minLength){var s,n={main:"There's no one with this name or email.",sub:"",type:"tau-valid"};if(this.options.allowEmails){var o=this.isEmail(i);s=o?this.options.allowOnlyExistingUsers?n:{main:"The invitation will be sent to",sub:i,type:"tau-valid"}:{main:"There's no one with this name. Please, enter the email address of the person you want to invite.",sub:i+" is invalid email",type:"tau-error"}}else s=n;this.showMessage(s)}else this.hideMessage()},refreshHelper:function(e){e=e||""===e?e:this.$helper.text();var i=this.$inp.val();if(i&&t.startsWith(e.toLowerCase(),i.toLowerCase())){var s=e.slice(i.length);this.$helper.find("s").text(i),this.$helper.find("span").text(s)}else this.emptyHelper()},emptyHelper:function(){this.$helper.find("s").text(""),this.$helper.find("span").text("")},syncSize:function(){var t=this.$widget.width()-10;this.$sizer.text(this.$inp.val());var e=this.$sizer.width();if(!(e<=this.$inp.width()-8)){var i=this.$inp[0].getBoundingClientRect().left,s=t-i,n=s;t>e&&(n=s>e?s:t),this.$inp.width()!=n&&this.$inp.width(n)}},resetSize:function(){this.$inp.width("10")},bt:function(t,e){return this.configurator.getTemplateFactory().get(t).bind({},e)},createItem:function(t){return this.bt("board.context.filter.members-widget.selectedItem",t).data("id",t.id)},removeItem:function(t,e){var i=t.data();this.options.canDelete(i)&&(this.model.remove(i),this._trigger("change"),t.remove(),e())},initAutocomplete:function(){var e=t.defaults(this.options.autocompletePosition,{my:"left top",at:"left bottom",collision:"none"});if(this.$inp.tauUserAutocomplete({store2:new s(this.configurator),autocompleteQueryAdd:this.options.autocompleteQueryAdd,appendTo:this.options.bubblesAppendTo,rejectUserIdsGetter:t.bind(function(){return t.compact(t.pluck(this.model.getAll(),"id"))},this),focus:t.bind(function(t,e){return this.refreshHelper(e.item.name),!1
},this),open:function(){this.openInnerBubble=!0}.bind(this),position:e,select:t.bind(function(t,e){var i=e.item;if(i.isLoading)return!1;this.model.add(i),this._trigger("change");var s=this.createItem(i);return this.$inpLi.before(s),this.$inp.val(""),this.emptyHelper(),this.hideMessage(),!1},this),close:t.bind(function(){this.emptyHelper(),this.openInnerBubble=!1},this),found:t.bind(function(){this.hideMessage()},this),nothing:t.bind(function(t,e){this.resultBubble(e.term)},this)}),this.options.processItems){var i=this.$inp.data("ui-tauUserAutocomplete");i._processItems=t.wrap(i._processItems,this.options.processItems)}},widget:function(){return this.$widget},isEmail:function(t){return t.match(n.get("emailRegexp"))},reset:function(){this.model.data=[],this.syncFromModel()}})});