define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/ui/extensions/board.plus/layout/ui.board.plus.layout","tau/ui/extensions/board.plus/ui.board.plus.decorator.columns-resize","tau/models/board.customize.units/const.card.sizes","tau/ui/extensions/board.plus/ui.board.plus.utils"],function(e,i,t,s,r,n,o){return t.extend({init:function(i){this._triggerResizeDelayed=e.throttle(this.triggerResize.bind(this),100),this._super(i)},resetLifecycle:!0,isFixedSizeApplicable:function(e){var i=e.getCurrentZoomLevel(),t=e.getColumnsCount();return i>1&&6>i&&t>1},updateFixedColumnSize:function(i,t,s){i.get({fields:["columnSizes"],callback:function(r){e.defaults(r,{columnSizes:{}}),r.columnSizes[t.x]=t.size,s({col:t.x,size:t.size}),i.set({set:{columnSizes:r.columnSizes}})}})},getResizeDecoratorSettings:function(e,i,t){var s=this;return{resetTrigger:e,isAvailable:function(){return s.isFixedSizeApplicable(i)},resolveColumnSize:function(e){return i.resolveColumnSize(e)},decreaserEnabled:function(e){var t=i.resolveColumnSize(e);return t>1},increaserEnabled:function(){return!0},onResize:function(e){var r=this.resolveColumnSize(e.x),n=e.type;"+"===n&&++r,"-"===n&&--r,e.size=r,s.updateFixedColumnSize(t,e,function(e){var t={};t[e.col]=e.size,i.setFixedColumnSize(t)})},getLRVisibilityOptions:function(e){var i="tau-collapsed_x",t=!1,s=!1;e.hasClass(i)&&(s=!0);var r=e.index();if(0===r)t=!0;else if(r>0){var n=e.parent(),o=n.children().eq(r-1);o.hasClass(i)&&(t=!0)}return{hideL:t,hideR:s}}}},applyColumnResizeDecorator:function(e,t,s,n){var o=this,a=i.Deferred();o.on("resize.executed",a.notify);var l=r(e,o.getResizeDecoratorSettings(a,t,n));return n.bind({fields:["columnSizes"],listener:o,callback:function(){o.triggerResize({})}}),l},createBoardLayout:function(){return new s},"bus cardsFullyLoaded":function(){this.triggerResize({})},"bus start.lifecycle + boardSettings.ready + overview.board.ready + view.dom.ready":function(e,i,t,s){var r=this,n=this.boardSettings=t.boardSettings,o=s.element,a=o.css("fontSize")||16,l=parseFloat(a),u=this.px=function(e){var i=Math.round(l);return e*i},d=u(.5),c=r.createBoardLayout();n.get({fields:["focus","zoomLevel","cells","columnSizes"],callback:function(e){var i=e.focus||{},t=i.x&&i.x.length>0,s=t?{}:e.columnSizes;c.setConfig({columnSizes:s,sizes:r._getSizes(u,e.cells.types),padding:d,scrollY:!1}),c.setElement(o),c.setCurrentZoomLevel(e.zoomLevel),t||r.applyColumnResizeDecorator(o,c,e,n),r.fire("boardLayout.ready",c),r.triggerResize({refreshElement:!0})}})},triggerResize:function(e){this.fire("resize.executed",e)},"bus initialize":function(t){var s=t.data.context.configurator;this._getSizes=this._getSizesV2;var r=e.throttle(e.bind(this.triggerResize,this,{}),250);i(s.getWindow()).on("resize.board",r)},"bus configurator.ready:last + boardSettings.ready":function(e,i,t){var s=t.boardSettings,r=this;s.unbind({listener:r}),s.bind({fields:["zoomLevel"],listener:this,callback:function(e){r.triggerResize({zoomLevel:e.zoomLevel})}}),s.bind({fields:["edit"],listener:this,callback:function(){r.fire("view.edit.applied")}}),s.bind({fields:["cells"],listener:this,callback:function(){r.fire("cells.changed")}})},"bus view.edit.applied":function(){var e=this;setTimeout(function(){e.triggerResize({})},1)},"bus view.card.batch.move.completed":function(){this.triggerResize({onlyHeaders:!0})},"bus view.card.batch.move":function(){this.triggerResize({onlyHeaders:!0})},"bus view.card.order.changed":function(){},"bus view.card.group.changed":function(){this.triggerResize({onlyHeaders:!0})},"bus view.axis.collapser.executed.after":function(){this.triggerResize({refreshElement:!0})},"bus view.cell.skeleton.updated":function(){this._triggerResizeDelayed({})},"bus operation.execute.done":function(e,i){i&&i.operation&&"deleted"==i.operation.name&&this.triggerResize({refreshElement:!0})},"bus boardLayout.ready:last > resize.executed":function(i,t,s){var r=e.clone(s);t.setSizes(this._getSizes(this.px,this.boardSettings.settings.cells.types)),e.defaults(r,{onlyHeaders:!1,refreshElement:!1,zoomLevel:t.getCurrentZoomLevel()}),t.setCurrentZoomLevel(r.zoomLevel),t.config.useFixedColumnSizes=this.isFixedSizeApplicable(t),r.refreshElement&&t.refreshElement(),r.onlyHeaders?t.updateHeaders():(t.updateSize(),this.fire("board.size.updated",{element:t.$el}),this.fire("board.layout.updated",{element:t.$el})),this.fire("resize.completed",r),this.fire("overview.board.updated",t.$el)},"bus overview.board.ready:last+overview.board.retrieve":function(i){var t=e.values(i)[0].data.element;this.fire("overview.board.retrieved",t)},"bus boardSettings.ready:last+destroy":function(i){var t=e.values(i)[0].data.boardSettings;t.unbind({listener:this})},"bus initialize:last+destroy":function(t){var s=e.values(t)[0].data.context.configurator;i(s.getWindow()).off("resize.board")},_getSizesV2:function(e,i){for(var t,s={collapsed:{width:12,height:12,cardsInRowMax:5,cardsInRowMin:5},1:{width:24,height:24,cardsInRowMax:3,cardsInRowMin:3,clientColsMin:5,clientRowsMin:5}},r=i[0],a=8,l=2;6>=l;l++)t=o.getCardSize(r,n.zoomToSize(l),a),s[l]={width:t.width,height:t.height,clientColsMin:2,clientRowsMin:2};return s}})});