define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/utils/utils.convertUserName"],function(e,t,n,i){return n.extend({category:"edit","bus afterRender":function(e,t){this.firstRender||(this.$oldDescription=t.element.clone(!0),this.firstRender=!0)},"bus afterRender:last + applyUpdate":function(t,n,i){var r={config:this.config};this.globalSettings=r.config.context.applicationContext.globalSettings||{},this._getUsersNotify(i,this.config,this.$oldDescription).then(this.safeCallback(function(t){if(this.$oldDescription=n.element.clone(!0),t=e.compact(t),t.length>0)if(this.globalSettings.IsEmailNotificationsEnabled){t=e.chain(t).pluck("name").uniq().compact().value();var i=this._buildMessage(t);this._callErrorBarServiceWithMessage(i,this.config)}else this._callErrorBarServiceWithMessage("No email notification was sent as Email Notifications are disabled in System Settings.",this.config,!0)}.bind(this)))},_getFromNotificationPractices:function(n,i){var r=n["comment-practices-notification-opts"],s=i.context.entity,a={Owner:this._getOwnerName,Assigned:this._getNamesAssignmentUsers,Team:this._getProjectTeam,Requesters:this._getRequesters},o=e.reduce(r,function(e,t,n){return t&&e.push(a[n]),e},[]),c={entity:s},u=e.map(o,function(e){return e.call(this,c)},this);return t.when.all(u).then(function(t){return e.chain(t).flatten().reject(function(e){return e.id==i.context.configurator.getLoggedUser().id}).value()},function(){return[]})},_buildMessage:function(t){var n="Email notification was sent",i=" to ",r=n+i;return t.length>3?r+=t.length+" people":(r+=e.compact(t).join(", "),r==n+i&&(r=n)),r},_getOwnerName:function(e){var t=e.entity,n=t.entityType.name,r=t.id;return this.store.getDef(n,{id:r,fields:["id",{owner:["id","firstName","lastName","email"]}]}).then(function(e){return{id:e.owner.id,name:i.getFullName(e.owner)}})},_getProjectTeam:function(){return{name:null}},_getRequesters:function(t){var n=t.entity,r=n.entityType.name,s=n.id,a={};return a.requesters=["id","firstName","lastName","avatarUri","email"],this.store.getDef(r,{id:s,fields:["id",a]}).then(function(t){return e.map(t.requesters,function(e){return{id:e.id,name:i.getFullName(e)}
})})},_getUsersFromMention:function(n,i,r){var s=t(n).find("[data-mention]"),a=i.find('[data-id="'+r+'"]').find("[data-mention]"),o=function(n){return e.map(n,function(e){return t(e).data("mention")})},c=o(a);return e.reduce(s,function(n,i){var r=t(i);return e.contains(c,r.data("mention"))||n.push({name:r.text()}),n},[])},_getNamesAssignmentUsers:function(t){var n=t.entity,r=n.entityType.name,s=n.id,a={},o="project"==r?"projectMembers":"assignments",c="project"==r?{user:["id","firstName","lastName","avatarUri","email"]}:{generalUser:["id","firstName","lastName","avatarUri","email"]};return a[o]=[c],this.store.getDef(r,{id:s,fields:["id",a]}).then(function(t){return e.map(t.assignments||t.projectMembers,function(e){var t=e.generalUser||e.user;return{id:t.id,name:i.getFullName(t)}})})},_getUsersNotify:function(e,n,i){var r=this._getUsersFromMention(e.cmd.config.$set.description,i,e.id),s=this._getFromNotificationPractices(e.cmd,n);return t.when(r,s).then(function(e,t){return e.concat(t)})},_callErrorBarServiceWithMessage:function(e,t,n){n=n||!1;var i=n?"warning":"success",r=t.context.configurator.service("errorBar");r.fire("notification",{$node:e,delay:1e4,type:i,disableAutoClose:!1})}})});