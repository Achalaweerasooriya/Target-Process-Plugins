define(["Underscore","jQuery","tau/models/tags/tagsProcessor"],function(e,t,n){var a=new n;return t.widget("ui.tauTagsAutocomplete",t.ui.autocomplete,{options:{store2:null,minLength:2,position:{my:"left top",at:"left bottom",collision:"flip"},source:function(e,t){this._resolve(e,t)},focus:function(){return!1},select:function(e,n){var o=t(e.target),r=n.item.value,s=o.val(),i=o.data("acPos"),l=s.substr(0,i)+s.slice(i+o.data("acTerm").length);return l=a.asArray(l),l.push(r),l=a.asString(l),o.val(l).focus(),!1}},_renderItem:function(n,a){return t("<li class='tau-autocomplete__item'></li>").data("ui-autocomplete-item",a).append("<a class='tau-autocomplete__itemtrigger drop-down-option'>"+e.escape(a.label)+"</a>").appendTo(n)},_renderMenu:function(e,n){t(e).addClass("tau-autocomplete__menu drop-down-list tau-autocomplete__menu__tags").css({maxHeight:.4*t(window).height(),zIndex:this.element.zIndex()+1});var a=this;t.each(n,function(t,n){a._renderItem(e,n)})},_resolve:function(e,n){t.when(this._resolveTagTerm(e)).then(this._resolveTags.bind(this)).then(n)},_resolveTagTerm:function(t){var n=this.element[0].selectionEnd;if(e.isUndefined(n)&&document.selection){var a=document.selection.createRange(),o=document.selection.createRange().text.length;a.moveStart("character",-this.element.val().length),n=a.text.length-o}var r=t.term.substr(0,n),s=e.ltrim(e.strRightBack(r,","));return s.length>1&&(n-=s.length,this.element.data("acTerm",s).data("acPos",n)),s},_resolveTags:function(n){if(n.length<=1)return[];var o=["name"],r=this.options.store2.arg(n.toLowerCase()),s=t.Deferred();return this.options.store2.findAll("Tag?select={"+o.join(",")+'}&where=name.startsWith("'+r+'")').done(function(t){var n=a.asArray(e.pluck(t,"name"));n=e.sortBy(n,function(e){return e.toLowerCase()}),s.resolve(n)}),s}})});