define(["Underscore","jQuery","tau/core/class"],function(_,$,Class){var _getLocation=function(operationArgs){return(operationArgs.items[0].location||"card").toLowerCase()},_findMaxOrderingValue=function(items){var nonEmptyItem=_.find(items,function(item){return!item.dynamic.items[0].data.empty}),maxOrderingValue=0;return nonEmptyItem&&(maxOrderingValue=nonEmptyItem.dynamic.items[0].orderingValue),maxOrderingValue},OperationsStrategies={applyCompleteHandler:function(extensionInstance,configurator,domWrapper,location,operation,dataItem){var cmd=dataItem.cmd,options=cmd.options||{};if(location!=="card")if(location!=="card"&&options.force&&operation==="added"){var items=dataItem.dataItems;if(_.isArray(items)&&items[0]&&_.contains(["project","team"],items[0].type.toLowerCase())){var acidStore=configurator.getAppStateStore(),ctxService=configurator.getApplicationContextService();acidStore.get({fields:["acid"],callback:function(r){ctxService.getApplicationContext({acid:r.acid},{success:function(ctx){var prevContext={project:ctx.selectedProjectIds,team:ctx.selectedTeamIds},type=items[0].type.toLowerCase();prevContext[type]=_.union(prevContext[type],_.pluck(items,"id"));var config={projectIds:prevContext.project,teamIds:prevContext.team};ctxService.getApplicationContext(config,{success:function(r){extensionInstance.fire("operation.highlightItems",cmd.items),acidStore.set({set:{acid:r.acid}},function(r){})}})}})}})}else OperationsStrategies.refresh(extensionInstance,cmd.items)}else location!=="card"&&options.force?OperationsStrategies.refresh(extensionInstance):location!=="card"&&!options.force&&operation==="added"&&dataItem.affected$CellsArray.length>0?OperationsStrategies.generateNotificationMessage(extensionInstance,cmd.items):location!=="card"&&!options.force&&operation==="deleted"&&dataItem.affected$CellsArray.length>0?OperationsStrategies.generateNotificationMessage(extensionInstance,null):location!=="card"&&!options.force&&operation==="notinslice"&&dataItem.affected$CellsArray.length>0?OperationsStrategies.generateNotificationMessage(extensionInstance,null):location==="card"||!!options.force},refresh:function(extension,itemsToHighlight){itemsToHighlight&&extension.fire("operation.highlightItems",itemsToHighlight),extension.fire("refresh")},generateNotificationMessage:function(extension,targetItems){var me=this,$messageNode=$(["<div>","Board axes were changed, you can ",'<a href="#" class="i-role-refresh-action">refresh the board</a>',"</div>"].join(""));$messageNode.delegate(".i-role-refresh-action","click",_.bind(function(e){var ext=this;return e.preventDefault(),me.refresh(ext,targetItems),!1},extension)),extension.fire("notification",{$node:$messageNode})},triggerPagingAfterQuickAdd:function(extension,pagingSettings,operationArgs){var dimension=_getLocation(operationArgs).charAt(0).toLowerCase(),altDimension=dimension==="x"?"y":"x",oldPage={};oldPage[dimension]=pagingSettings[dimension].currentPage,oldPage[altDimension]=pagingSettings[altDimension].currentPage;var axisPageSettings=pagingSettings[dimension],maxOrderingValue=_findMaxOrderingValue(axisPageSettings.data),newOrderingValue=operationArgs.items[0].data.orderingValue,totalPages=axisPageSettings.totalPages||1,pageNo=newOrderingValue>maxOrderingValue?0:totalPages-1,newPage={};newPage[dimension]=pageNo,newPage[altDimension]=pagingSettings[altDimension].currentPage,extension.fire("operation.highlightItems",operationArgs.items),newPage[dimension]==oldPage[dimension]?extension.fire("refresh"):extension.fire("page.switched",newPage)}};return OperationsStrategies})