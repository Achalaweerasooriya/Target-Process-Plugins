define(["jQuery","Underscore","tau/core/extension.base.stateful","tau/ui/templates/quick.add/ui.template.quick.add.content","tau/ui/templates/quick.add/ui.template.quick.add.line","tau/ui/behaviour/common/ui.behaviour.editableText"],function(t,e,i,n,d){return i.extend({"bus beforeInit":function(t,e){var i=e.config;this.fire("dataBind",{label:i.label,entityType:i.entityType})},"bus afterRender":function(t,i){var n=i.element,d=n.find(".ui-quick-add-link").tauBubble({onPositionConfig:function(t){t.offset="-20 0"}});d.bind("show",e.bind(function(t,e){this.fire("displayQuickAdd",e)},this)),d.bind("close",e.bind(function(t,e){e.event&&e.event.preventDefault&&(e.event.preventDefault(),e.event.stopPropagation()),this.fire("close",e)},this))},"bus displayQuickAdd":function(e){var i=e.data;this.itemsAdded=t.Deferred();var d=i.popup.find(".tau-bubble__inner");d.find(".ui-quick-add-content").length||d.append(n.render({})),i.api.adjustPosition(),d.find(".quick-add-lines").html(""),d.find(".ui-quick-add-stats").text(""),d.find(".button-box").click(function(){i.api.hide()}),this._appendAddLine(d),this._attachKeyBoardHandling()},"bus close":function(){this.config.context.configurator.getKeyBoardManager().popHandler(),this.itemsAdded["is-async-operation-started"]&&e.defer(this.safeCallback(this._addItems))},_addItems:function(){var t=this.config.context;t["evict-data"]={entityId:this._getEntityId(),entityType:this._getEntityType(),evictProperties:this.config.evictProperties,$defer:this.itemsAdded},this.fire(this.config.entityType+".items.added",t)},_attachKeyBoardHandling:function(){var e={handleKeyDown:t.noop};this.config.context.configurator.getKeyBoardManager().pushHandler(e)},_getEntityId:function(){return this.config.context.entity.id},_getEntityType:function(){return this.config.context.entity.entityType.name},_prepareCmd:function(t,i){t=t.replace(/\s+/gi," "),t.length>255&&(t=t.substring(0,254));var n=this.config,d={name:t};n.additionalFieldsSet&&e.extend(d,n.additionalFieldsSet),d[n.property]={id:this._getEntityId()};
var a={};a[n.property]=["id"];var s={$set:d,fields:["id","name",a]};return i.data("item-id")&&(s.id=i.data("item-id")),s},_appendAddLine:function(i){var n=this,a=t(".ui-quick-add-new-item",i);if(a.length>0)return void setTimeout(function(){a.click()},1);var s=d.render({entityType:n.config.entityType});i.find(".quick-add-lines").append(s);var o=t(".quick-add-input",s);o.editableText({restoreText:!0,preventDefaultBlur:!0,onSave:function(d){if(d&&e.trim(d)&&!o.hasClass("ui-quick-add-saving")){o.removeClass("ui-quick-add-new-item").addClass("ui-quick-add-saving");var a=n.config.store,r=n._prepareCmd(d,s),c=e.partial(function(e,n){s.data("item-id",n.data.id).addClass("ui-quick-add-item-saved"),o.removeClass("ui-quick-add-saving").text(n.data.name),e.resolve();var d=t(".ui-quick-add-item-saved",i).length+" item(s) saved";t(".ui-quick-add-stats",i).text(d)},n.itemsAdded),u=function(t,e){var i=a.config.proxy.types[n.config.entityType].refs;t&&i.project&&(r.$set.project={id:t.id}),e&&i.team&&(r.$set.team={id:e.id}),n.config.onBeforeAdd&&n.config.onBeforeAdd(r),a.save(n.config.entityType,r,{success:function(t){c(t)}}).done()};t(".ui-quick-add-stats",i).text("saving...");var f=a.config.proxy.types[n._getEntityType()].refs,p=[{project:["id"]}];f.team&&p.push({team:["id"]}),n.itemsAdded["is-async-operation-started"]=!0,a.get(n._getEntityType(),{id:n._getEntityId(),fields:p},{success:function(t){u(t.data.project,t.data.team)}}).done(),n._appendAddLine(i)}}}),o.data("textEditor").onEscape=function(t){t.preventDefault(),this._cancelEdit(),this.$element.blur()},setTimeout(function(){o.click()},1)}})});