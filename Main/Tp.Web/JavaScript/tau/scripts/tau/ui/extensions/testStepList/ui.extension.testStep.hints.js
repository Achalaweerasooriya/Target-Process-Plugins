define(["require","tau/core/extension.base","tau/utils/utils.storage","jQuery","Underscore","template!tau/ui/templates/testStepList/ui.template.teststep.hints"],function(t){var e=t("tau/core/extension.base"),s=t("tau/utils/utils.storage"),i=t("jQuery"),n=t("Underscore"),a=t("template!tau/ui/templates/testStepList/ui.template.teststep.hints");return e.extend({testStepHintsPropertySettings:{masterKey:"testCase",key:"testStepHintsDisabled",group:"settings",scope:"public"},eventNamespace:"testStepHints",testStepHintsSelector:".test-case-tip",testStepHintsHideLinkSelector:".test-case-tip__link",buttonNames:{mac:{ctrlBtnName:"Cmd",delBtnName:"Backspace",delFnBtnName:"Fn"},"default":{ctrlBtnName:"Ctrl",delBtnName:"Del"}},"bus afterInit":function(t,e){var s=e.config.context.configurator;if(this.storage=s.getRestStorage(),this.loggedUser=s.getLoggedUser(),!this._isHintsDisabled()){var i=this._getHintsPropertyValue();i.done(this.safeCallback(function(t){var e=this._getPropertyValue(t);(n.isUndefined(e)||n.isNull(e))&&this._createUpdateHintsPropertyValue(!1),this.fire("hintsPropertyDataReady",{disabled:e===!0})}))}},"bus afterRender + hintsPropertyDataReady:last":function(t,e,s){var i=e.element;this._unbindHandlers(i),s.disabled||this._bindHandlers(i)},"bus afterRender > destroy":function(t,e){var s=e.element;this._unbindHandlers(s)},"bus afterRender:last + hintsPropertyDataReady:last + activeRowChanged":function(t,e,s,i){i&&!s.disabled&&this._showHints(i)},_bindHandlers:function(t){t.on("click."+this.eventNamespace+" mousedown."+this.eventNamespace,this.testStepHintsHideLinkSelector,this._onHideHintsLinkClicked.bind(this)),this.storage.on("afterUpdate",this._onStorageUpdate.bind(this,t),this)},_unbindHandlers:function(t){t.off(this.eventNamespace),this.storage.removeAllListeners(this)},_showHints:function(t){if(!this._hasHints(t)){var e=this._getHintsTemplate();t.append(e)}},_onHideHintsLinkClicked:function(t){t.preventDefault(),t.stopPropagation(),"click"==t.type&&this._createUpdateHintsPropertyValue(!0)
},_onStorageUpdate:function(t,e,s){var i=this._getPropertyValue(s.$value);i&&this._hideHints(t)},_getPropertyValue:function(t){return t&&t.userData&&t.userData[this.testStepHintsPropertySettings.key]},_hideHints:function(t){this._disableHints(),this._removeHints(t),this.fire("hintsPropertyDataReady",{disabled:!0})},_getLocalStorageKey:function(){return this.testStepHintsPropertySettings.key+"_"+this.loggedUser.id},_isHintsDisabled:function(){return s.get(this._getLocalStorageKey())===!0},_disableHints:function(){s.set(this._getLocalStorageKey(),!0)},_removeHints:function(t){t.find(this.testStepHintsSelector).remove()},_hasHints:function(t){return t.has(this.testStepHintsSelector).length},_getHintsTemplate:function(){if(!this.hintsTemplate){var t=window.session&&window.session.browser&&"Mac"==window.session.browser.os?this.buttonNames.mac:this.buttonNames.default;this.hintsTemplate=a.get().bind(null,t)}return this.hintsTemplate},_getHintsPropertyValue:function(){return this._performClientStorageOperation(this.testStepHintsPropertySettings)},_createUpdateHintsPropertyValue:function(t){return this._performClientStorageOperation(this.testStepHintsPropertySettings,t)},_performClientStorageOperation:function(t,e){var s,a=t.group,r=t.masterKey;if(!n.isUndefined(e)){var o={};o[t.key]=e,s={scope:t.scope,userData:o}}var l=i.Deferred();return this.storage.data(a,r,s).then(function(t){l.resolve(t.data)},function(){l.reject()}),l.promise()}})});