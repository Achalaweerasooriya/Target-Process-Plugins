define(["Underscore","jQuery","tau/core/extension.base","tau/ui/templates/choice.entityState/ui.template.choice.entityState.commentForm","tau/utils/utils.textConverter","tau/ui/behaviour/common/ui.behaviour.listSelectable"],function(e,t,i,a,n){return i.extend({init:function(e,t){this.configurator=t,this.template=a,this.textConverter=new n,this._super(e)},"bus afterRender:last + focus.before":function(e,t){t.element.find(".ui-entity-state-comment").remove()},"bus afterRender:last + dataBind:last + entityState.selected":function(t,i,a,n){var s=i.element,o=e.findWhere(a.states,{id:n.id}),r=o&&o.isCommentRequired;if(!r)return void this.fire("updateState",n);if(s.find(".ui-entity-state-comment").length>0)return void s.find("textarea").focus();var l=s.find(".drop-down-list");l.data("ui-listSelectable")&&(l.find(".i-role-option[data-id="+o.id+"]").addClass(l.listSelectable("option","className")),l.listSelectable("disable"));var d=this.configurator.getTemplateFactory().get(this.template.name).bind();d.appendTo(s);var c=d.find("textarea").focus(),u=d.find(".save");u.click(e.bind(this._save,this,o,s,l,d));var f=d.find(".cancel");f.click(e.bind(this._cancelPrevious,this,o,s,l,d));var m=function(){window.setTimeout(function(){var t=c.val()||"",i=0===e.trim(t).length;i?u.attr("disabled","disabled"):u.attr("disabled")&&u.removeAttr("disabled"),u.toggleClass("disable",i)},50)};m(),u.bind("focus",m),c.bind("change keyup click propertychange paste",m)},_save:function(e,t,i,a,n){n.stopPropagation();var s=this.textConverter.convert(a.find("textarea").val(),!0);this.fire("save",{$set:{entityState:{id:e.id},comments:[{description:s}]},$include:[{comments:["id","description"]}]})},_cancelPrevious:function(e,t,i,a,n){n.stopPropagation(),a.remove(),i.data("ui-listSelectable")&&(i.find(".i-role-option[data-id="+e.id+"]").toggleClass(i.listSelectable("option","className"),!1),i.listSelectable("enable"))}})});