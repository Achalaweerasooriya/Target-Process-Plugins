define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/ui/behaviour/common/ui.behaviour.richeditor"],function(_,$,ExtensionBase){var CommentsExtension=ExtensionBase.extend({category:"edit",destroy:function(){this.destroyDynamicComponents(),this._super()},lifeCycleCleanUp:function(){this.destroyDynamicComponents(),this._super()},destroyDynamicComponents:function(){var self=this;self.componentList&&(self.componentList.destroy(),delete self.componentList)},"bus applyTo+permissionsReady":function(evtArgs){var applyToData=evtArgs.applyTo.data,permissions=evtArgs.permissionsReady.data;this.applyPermissions(applyToData.config,applyToData.data,applyToData.element,permissions)},applyPermissions:function(ctrlConfig,ctrlData,ctrlElement,permissions){var self=this,config=this.config=_.extend({},ctrlConfig,{comment:ctrlData}),$element=this.element=ctrlElement,$menu=$('<li class="ui-comment-menu button-group"></li>'),$commentBody=$element.children(".ui-comment-body");if(permissions.editable){$commentBody.addClass("editable");var fnReply=$.proxy(self.onReply,self);$menu.append($('<a class="reply button small"><span class="icon"></span>reply</a>').click(fnReply));var fnEdit=$.proxy(self.onEdit,self);$menu.append($('<a class="edit button small"><span class="icon"></span>edit</a>').click(fnEdit)),$(['<div class="ui-comment-reply">','   <div class="ui-editor-placeholder" style="display: none;"></div>',"</div>"].join("")).insertAfter($commentBody.find(".ui-comment-text"))}if(permissions.deletable){var fnDelete=$.proxy(self.onDelete,self);$menu.append($('<a class="delete button danger small"><span class="icon"></span>delete</a>').click(fnDelete)),$commentBody.addClass("deletable")}$commentBody.find(".ui-comment-heading").append($menu);var $comments=$element.children(".ui-comments"),componentsConfig={components:[{type:"commentList"}],context:config.context};this.componentList||this.createComponents(componentsConfig,function(data){var item=data[0],applyConfig={element:$comments,data:{comments:ctrlData.comments||[]},config:_.extend({},item.config,{commentId:self.config.comment.id})};self.componentList=item.component,item.component.fire("applyTo",applyConfig)})},showEditorForEdit:function(){var self=this,$commentText=this.element.find("> .ui-comment-body > .ui-comment-text"),data=this.element.tmplItem().data;this.showEditor({element:$commentText,text:data.description,checkChanges:!1,saveHandler:function(text){self.fire("saveComment",{description:text})}})},showEditorForReply:function(){var self=this,$replyPlaceHolder=this.element.find("> .ui-comment-body > .ui-comment-reply > .ui-editor-placeholder"),data=this.element.tmplItem().data;self.showEditor({element:$replyPlaceHolder,text:"",hideTarget:!1,saveText:"Add Reply",saveHandler:function(text){self.fire("replyToComment",{description:text,parentId:data.id})}})},showEditor:function(argsConfig){var self=this,fnSaveHandlerWrapper=function(){self.fire("editorSave"),argsConfig.saveHandler.apply(this,arguments)},$element=argsConfig.element,$ckEditor=$element.richeditor({text:argsConfig.text,hideTarget:argsConfig.hideTarget!==!1,executionGroupName:"comments",onSaveWithClose:fnSaveHandlerWrapper,validation:{trim:!0},settings:{toolbar:[["Bold","Italic","Strike"],["NumberedList","BulletedList"],["Link","Unlink"],["Image"],["Source"]],startupFocus:!0,extraPlugins:""},saveAction:{text:argsConfig.saveText||"Save",disableIfEmpty:!0,checkChanges:argsConfig.checkChanges},cancelAction:{available:!0}}),$editorElement=$ckEditor.richeditor("showEditor");this.fire("editorCreated",{editorElement:$editorElement})},onReply:function(evt){var self=this;evt.stopPropagation(),evt.preventDefault(),self.showEditorForReply()},onEdit:function(evt){var self=this;evt.stopPropagation(),evt.preventDefault(),self.showEditorForEdit()},onDelete:function(evt){var self=this,$commentBody=self.element.find("> .ui-comment-body");$commentBody.confirmation({message:"Delete comment?",ok:$.proxy(self.onConfirmDelete,self),cancel:$.proxy(self.onCancelDelete,self)}),$commentBody.confirmation("show")},onCancelDelete:function(evt){evt.stopPropagation(),evt.preventDefault(),this.element.find("> .ui-comment-body").confirmation("hide")},onConfirmDelete:function(evt){evt.stopPropagation(),evt.preventDefault(),this.fire("deleteComment")}});return CommentsExtension})