define(["Underscore","jQuery","tau/configurator","tau/components/extensions/component.extension.base","tau/ui/behaviour/common/ui.behaviour.richeditor"],function(_,$,a,b){var c=b.extend({category:"edit",destroy:function(){this.destroyDynamicComponents(),this._super()},lifeCycleCleanUp:function(){this.destroyDynamicComponents(),this._super()},destroyDynamicComponents:function(){var a=this;a.componentList&&(a.componentList.destroy(),delete a.componentList)},"bus applyTo+permissionsReady":function(a){var b=a.applyTo.data,c=a.permissionsReady.data;this.applyPermissions(b.config,b.data,b.element,c)},applyPermissions:function(a,b,c,d){var e=this,f=this.config=_.extend({},a,{comment:b}),g=this.element=c,h=$('<li class="ui-comment-menu button-group"></li>'),i=g.children(".ui-comment-body");if(d.editable){i.addClass("editable");var j=$.proxy(e.onReply,e);h.append($('<a class="reply button small"><span class="icon"></span>reply</a>').click(j));var k=$.proxy(e.onEdit,e);h.append($('<a class="edit button small"><span class="icon"></span>edit</a>').click(k)),$(['<div class="ui-comment-reply">','   <div class="ui-editor-placeholder" style="display: none;"></div>',"</div>"].join("")).insertAfter(i.find(".ui-comment-text"))}if(d.deletable){var l=$.proxy(e.onDelete,e);h.append($('<a class="delete button danger small"><span class="icon"></span>delete</a>').click(l)),i.addClass("deletable")}i.find(".ui-comment-heading").append(h);var m=g.children(".ui-comments"),n={components:[{type:"commentList"}],context:f.context};this.componentList||this.createComponents(n,function(a){var c=a[0],d={element:m,data:{comments:b.comments||[]},config:_.extend({},c.config,{commentId:e.config.comment.id})};e.componentList=c.component,c.component.fire("applyTo",d)})},showEditorForEdit:function(){var a=this,b=this.element.find("> .ui-comment-body > .ui-comment-text"),c=this.element.tmplItem().data;this.showEditor({element:b,text:c.description,checkChanges:!1,saveHandler:function(b){a.fire("saveComment",{description:b})}})},showEditorForReply:function(){var a=this,b=this.element.find("> .ui-comment-body > .ui-comment-reply > .ui-editor-placeholder"),c=this.element.tmplItem().data;a.showEditor({element:b,text:"",hideTarget:!1,saveText:"Add Reply",saveHandler:function(b){a.fire("replyToComment",{description:b,parentId:c.id})}})},showEditor:function(a){var b=this,c=function(){b.fire("editorSave"),a.saveHandler.apply(this,arguments)},d=a.element,e=d.richeditor({text:a.text,hideTarget:a.hideTarget!==!1,executionGroupName:"comments",onSave:c,validation:{trim:!0},settings:{toolbar:[["Bold","Italic","Strike"],["NumberedList","BulletedList"],["Link","Unlink"],["Image"],["Source"]],startupFocus:!0,extraPlugins:""},saveAction:{text:a.saveText||"Save",disableIfEmpty:!0,checkChanges:a.checkChanges},cancelAction:{available:!0}}),f=e.richeditor("showEditor");this.fire("editorCreated",{editorElement:f})},onReply:function(a){var b=this;a.stopPropagation(),a.preventDefault(),b.showEditorForReply()},onEdit:function(a){var b=this;a.stopPropagation(),a.preventDefault(),b.showEditorForEdit()},onDelete:function(a){var b=this,c=b.element.find("> .ui-comment-body");c.confirmation({message:"Delete comment?",ok:$.proxy(b.onConfirmDelete,b),cancel:$.proxy(b.onCancelDelete,b)}),c.confirmation("show")},onCancelDelete:function(a){a.stopPropagation(),a.preventDefault(),this.element.find("> .ui-comment-body").confirmation("hide")},onConfirmDelete:function(a){a.stopPropagation(),a.preventDefault(),this.fire("deleteComment")}});return c})