define(["jQuery","Underscore","tau/components/extensions/component.extension.base","tau/libs/boardSettings/board.settings.to.definition.translator","tau/slice/url.resolver","tau/slice/slice.definition.transformations","tau/core/query"],function(e,t,i,r,n,o,a){return i.extend({"bus beforeInit":function(e,t){this.formSubmitter=t.config.formSubmitter||this.formSubmitterImpl,this.fire("dataBind",{})},"bus afterRender + boardSettings.ready:last + configurator.ready:last":function(i,a,s,d){var u=s.boardSettings,f=a.view.config.context.configurator.getAppStateStore(),c=a.element,l=new n({prefix:"matrix"}),m=l.resolveUrl("csv"),v=this;c.on("click",".i-role-export-to-csv",function(){var i=e(this);new r(u,f).getBoardDefinition().then(function(e){var r=o.createSliceDefinitionFromBoardSettings(e.definition),n=t.pick(r,["x","y"]),a=n.x&&n.x.filter||n.y&&n.y.filter?!0:!1,s=t.pick(d.service("currentBoard").sliceInfo,["x","y"]);r.where=v.createWhere(s,a),v.fire("ready.to.submit",{$el:i,definition:r,url:m,boardName:u.settings.name,viewMode:u.settings.viewMode})})})},"bus ready.to.submit":function(e,t){this.formSubmitter(t)},createWhere:function(e,i){var r=e||{},n=t.reduce(r,function(e,r,n){if((i||r.isFocus)&&r.data.length){var o=t.pluck(r.data,"id"),a=t.every(o,function(e){return void 0==e});if(a){var s=t.pluck(r.data,n);o=s}e[n]={$in:o}}return e},{});return a.render(n)},formSubmitterImpl:function(t){var i=e('<form id="csvForm" action="'+t.url+'" method="POST" target="_blank"></form>'),r=e('<input type="hidden" name="parameters"/>'),n=e('<input type="hidden" name="boardName"/>'),o=e('<input type="hidden" name="where"/>'),a=e('<input type="hidden" name="viewMode"/>');r.val(JSON.stringify(t.definition)),n.val(t.boardName),o.val(t.definition.where),a.val(t.viewMode),t.$el.wrap(i),t.$el.after(r),t.$el.after(n),t.$el.after(o),t.$el.after(a),t.$el.parent().submit(),r.remove(),n.remove(),o.remove(),a.remove(),t.$el.unwrap()}})});