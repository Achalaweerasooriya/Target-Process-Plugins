define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/ui/templates/auditHistory/ui.template.auditHistory.records","tau/ui/templates/auditHistory/ui.template.auditHistory.record.changes"],function(e,t,r,i,o){return r.extend({init:function(e){this._super(e),this.limit=e.limit||10},"bus afterRender":function(e,t){var r=t.element;this._bindLoadMore(r),this._bindExpandCollapse(r),this.fire("loadedAuditRecords",{count:0}),this.fire("loadAuditRecords")},"bus afterRender:last + loadedAuditRecords:last + loadAuditRecords":function(e,t,r){this._showProgress(t.element.find(".i-role-more")),this.fire("getAuditRecords",{start:r.count,limit:this.limit})},"bus afterRender:last + loadedAuditRecords:last + auditRecords.ready":function(t,r,i,o){var s=r.element,n=s.find(".i-role-more");if(this._tryHideProgress(n),o.auditRecords)if(e.isEmpty(o.auditRecords))this._switchToNoMore(n,!0);else{var d=o.auditRecords.length;d<this.limit&&this._switchToNoMore(n);var a=this._buildAuditRecordsBindModel(o.auditRecords,i.lastRecordDate),c=this._$renderRecords(a.auditRecords);c.appendTo(this._$getRecordsHolder(this._$getRecords(s))),i.count>0&&this._scrollToLoadedRecords(c),this.fire("loadedAuditRecords",{count:i.count+d,lastRecordDate:a.lastRecordDate})}},"bus afterRender:last + auditRecordsChanges.ready":function(t,r,i){var o=this._$getRecords(r.element),s=this._$getRecordsHolder(o);this._tryHideProgress(this._$getChangesProgressHolder(o,i)),e.each(i,function(e){var t=this._$getRecord(s,e.historyId,e.entityTypeName);t.removeClass("i-role-expanding"),e.changes?this._showRecordChanges(t,e.changes):this._$toggleRecordsOpened(t,!1)},this)},"bus afterRender:last + getAuditRecordsChanges":function(e,t,r){var i=this._$getChangesProgressHolder(this._$getRecords(t.element),r.records);this._showProgress(i)},_bindLoadMore:function(e){e.find(".i-role-more-trigger").on("click",function(){this.fire("loadAuditRecords")}.bind(this))},_bindExpandCollapse:function(e){var r=this._$getRecordsHolder(this._$getRecords(e));r.on("click","td:not(.tau-date)",function(e){var r=t(e.currentTarget).parent();r.has(".i-role-changes:visible").length?this._collapse(r):this._expand(r)}.bind(this)),e.find(".i-role-expandAll").on("click",function(e,t){t.preventDefault(),this._expandAll(e)}.bind(this,r)),e.find(".i-role-collapseAll").on("click",function(e,t){t.preventDefault(),this._collapseAll(e)}.bind(this,r))},_expandAll:function(e){this._expand(this._$getRecordsItems(e))},_expand:function(e){this._$toggleRecordsOpened(e,!0).find(".i-role-changes").slideDown("fast");var r=this._$filterRecordsItemsToGetChanges(e);r.addClass("i-role-expanding");var i=r.map(function(e,r){var i=t(r);return{historyId:i.data("historyId"),entityTypeName:i.data("entityTypeName")}}.bind(this)).get();i.length>0&&this.fire("getAuditRecordsChanges",{records:i})},_collapseAll:function(e){this._collapse(this._$getRecordsItems(e))},_collapse:function(e){this._$toggleRecordsOpened(e,!1).find(".i-role-changes").slideUp("fast")},_scrollToLoadedRecords:function(e){var t=e.last();t.scrollParent().scrollTo(t,1e3)},_showProgress:function(e){e.data("ui-tauProgressIndicator")||e.tauProgressIndicator();var t=e.data("progress-timeout");t||e.data("progress-timeout",setTimeout(function(e){e.tauProgressIndicator("show",{hover:!0})}.bind(this,e),200))},_tryHideProgress:function(e,t){if(e.data("ui-tauProgressIndicator")){var r=e.data("progress-timeout");r&&(clearTimeout(r),e.removeData("progress-timeout")),e.tauProgressIndicator("hide"),t&&e.tauProgressIndicator("destroy")}},_switchToNoMore:function(e,t){e.find(".i-role-more-trigger").hide(),t&&(e.find(".i-role-no-more").fadeIn(400),e.fadeOut(2e3,"linear"))},_buildAuditRecordsBindModel:function(t,r){var i,o=r,s=e.map(t,function(e){return i=e.date.month+" "+e.date.day+", "+e.date.year,o&&i==o?i=null:o=i,{historyId:e.historyId,entityTypeName:e.entityTypeName,date:i,time:e.date.time,description:e.description,avatarUrl:e.avatarUrl,user:e.user}},this);return{auditRecords:s,lastRecordDate:o}},_showRecordChanges:function(e,t){var r=this._$getRecordDescription(e),i=this._$renderRecordChanges(t);i.appendTo(r),i.slideDown("fast")},_$filterRecordsItemsToGetChanges:function(e){return e.filter(":not(.i-role-expanding):not(:has(.i-role-changes))")},_$getChangesProgressHolder:function(t,r){var i=1==r.length;if(i){var o=e.first(r);return this._$getRecordDescription(this._$getRecord(this._$getRecordsHolder(t),o.historyId,o.entityTypeName))}return t},_$getRecords:function(e){return e.find(".i-role-records")},_$getRecordsHolder:function(e){return e.find(".i-role-records-holder")},_$getRecord:function(e,t,r){return e.find('[data-history-id="'+t+'"][data-entity-type-name="'+r+'"]')},_$getRecordDescription:function(e){return e.find(".i-role-description")},_$getRecordsItems:function(e){return e.find("tr")},_$renderRecords:function(e){return i.get().bind(null,{auditRecords:e})},_$renderRecordChanges:function(e){return o.get().bind(null,{changes:e})},_$toggleRecordsOpened:function(e,t){return e.toggleClass("tau-open",t)}})});