define(["Underscore","jQuery"],function(_,$){var setPosition=function(e){var $grid=$(e.delegateTarget),$cellHolder=$(e.currentTarget),$flyButtonPanel=this,padding=2,pos=$cellHolder.position(),panelHeight=$flyButtonPanel.height(),panelWidth=$flyButtonPanel.width(),cellHolderHeight=$cellHolder.height(),cellHolderWidth=$cellHolder.width(),hldrOffset=$cellHolder.offset(),gridOffset=$grid.offset(),cellOffsetY=cellHolderHeight-panelHeight,gridDomElement=$grid[0],scrollBarHeight=gridDomElement.offsetHeight-gridDomElement.clientHeight,scrollBarWidth=gridDomElement.offsetWidth-gridDomElement.clientWidth,top=pos.top+cellOffsetY+$grid.scrollTop()-1.5*padding,gridH=gridOffset.top+$grid.height()-scrollBarHeight,cellH=hldrOffset.top+cellHolderHeight,deltaH=_.max([0,cellH-gridH]);top-=deltaH;var panelInnerOffsetY=_.max([0,panelHeight+2*padding-(cellHolderHeight-deltaH)]);top+=panelInnerOffsetY;var cellOffsetX=cellHolderWidth-panelWidth,left=pos.left+cellOffsetX+$grid.scrollLeft()-padding,gridX0=gridOffset.left+$grid.width()-scrollBarWidth,cellX0=hldrOffset.left+cellHolderWidth,deltaW=_.min([0,gridX0-cellX0]);left+=deltaW;var panelInnerOffsetX=_.max([0,panelWidth-(cellHolderWidth-deltaW)-padding]);left+=panelInnerOffsetX,$flyButtonPanel.css("top",top).css("left",left)};return function(domWrapper,settings){var isActivatedMode=!1,activatedScope,lastScopeCoordinate,sharedState=null,$buttonPanel=settings.$buttonPanel;$buttonPanel.hide();var $button=$buttonPanel.find(".tau-btn"),predicateAddAction=function(d){return _.find(settings.items,function(itemData){var matchLocation=itemData.x==d.x&&itemData.y==d.y;if(matchLocation){var hasAddAction=_.find(itemData.fixed.items,function(item){return item.type==="AddAction"});if(hasAddAction)return!0}return!1})},createEventHandler=function(eventFlag,callback){return function(e){var $cellHolder=$(e.currentTarget),d=$cellHolder.data(),action=predicateAddAction(d);return lastScopeCoordinate=eventFlag+"_"+d.x+"_"+d.y,!isActivatedMode&&action?callback(e,{actionItems:action}):{}}},onClickHandler=function(){if(sharedState&&!isActivatedMode){isActivatedMode=!0,activatedScope=lastScopeCoordinate;var o={data:sharedState,deactivate:function(){isActivatedMode=!1,activatedScope!==lastScopeCoordinate&&$buttonPanel.hide()}};settings.onActivate(o)}};$button.click(onClickHandler);var $targetGrid=domWrapper.getGrid();$targetGrid.find(".i-role-cellholder").addClass("i-role-ch-quickadd-target");var adjustButtonPanel=function(e){setPosition.call($buttonPanel,e)},showButtonPanel=_.throttle(function($cellHolder){if(!sharedState)return;$buttonPanel.css("position","absolute"),$buttonPanel.appendTo($cellHolder),$buttonPanel.show()},500),hideButtonPanel=function(){$buttonPanel.hide()},activateButtonPanel=function(e,obj){sharedState=obj,setPosition.call($buttonPanel,e);var $cellHolder=$(e.currentTarget);return showButtonPanel($cellHolder),{buttonIsVisible:!0}},deactivateButtonPanel=function(){sharedState=null,hideButtonPanel()},doubleClick=_.debounce(function(event){($(event.target).hasClass("i-role-ch-quickadd-target")||$(event.target).hasClass("i-role-cell"))&&createEventHandler("enter",activateButtonPanel)(event).buttonIsVisible&&$button.click()},300),selector=".i-role-cellholder.i-role-ch-quickadd-target";$targetGrid.on("mousemove",selector,{},createEventHandler("enter",adjustButtonPanel)),$targetGrid.on("mouseenter",selector,{},createEventHandler("enter",activateButtonPanel)),$targetGrid.on("mouseleave",selector,{},createEventHandler("leave",deactivateButtonPanel)),$targetGrid.on("dblclick",selector,doubleClick)}})