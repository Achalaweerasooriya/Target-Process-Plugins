define(["Underscore","jQuery","./widget.select","./template.widget.releaseIteration.output","./template.widget.releaseIteration.option"],function(e,t,i,n,a){return i.extend({init:function(e,t,i){this._super(e,t,i),this.setup()},setup:function(){this.options.templates.output=n,this.options.templates.option=a,this.options.onlyReleases=this.options.onlyReleases||!1,this.options.fields=["id","name",{iterations:["id","name"]},{project:["id","name","isActive"]}],this.iterationBacklog={id:-1,name:"Backlog"},this.releaseBacklog={id:-1,name:"Backlog",iterations:[]}},loadSelectedRelease:function(e){var t=this.value["release.id"];t>0?this.configurator.getStore().get("release",{id:t,fields:["id","name"]}).done(function(t){e(!1,t[0].data)}):t==this.releaseBacklog.id?e(!1,this.releaseBacklog):e(!1,null)},loadSelectedIteration:function(e){var t=this.value["iteration.id"];t>0?this.configurator.getStore().get("iteration",{id:t,fields:["id","name",{release:["id","name"]}]}).done(function(t){e(!1,t[0].data)}):t==this.iterationBacklog.id?e(!1,this.iterationBacklog):e(!1,null)},_renderOutput:function(e,t){return this.renderOutputTemplate({name:this.name,value:this.value,label:{name:e,fullName:t},editable:this.options.editable})},renderOutput:function(){var i=t.Deferred();if(!e.compact(e.values(this.value)).length){var n=this._renderOutput("","");return i.resolve(n),i.promise()}var a=[e.bind(this.loadSelectedRelease,this),e.bind(this.loadSelectedIteration,this)];return e.parallel(a,e.bind(function(t,n){var a=n[1]||n[0],o=e.map(e.compact(n),function(e){return e.name}).join(", "),r=this._renderOutput(a.name,o);i.resolve(r)},this)),i.promise()},getEditOptions:function(t){var i=e.uniq(e.pluck(t,"project"),function(e){return e.id}),n=e.map(i,e.bind(function(t){var i=e.clone(this.releaseBacklog);return i.project=t,i},this));return t=e.filter(t,function(e){return e.project.isActive}),t=e.sortBy(t,function(e){return e.project.name+" "+e.name}),t=e.map(t.concat(n),e.bind(function(t){var i={value:t.id,label:t.name,project:t.project};
return this.options.onlyReleases?i.iterations=[]:(i.iterations=e.sortBy(t.iterations,function(e){return e.name}),i.iterations=e.map(i.iterations.length?[this.iterationBacklog].concat(i.iterations):i.iterations,function(e){return{value:e.id,label:e.name,project:t.project}})),i},this)),t=e.groupBy(t,function(e){return e.project.name})},applyOption:function(e){var t,i=e.data();t="iteration"===i.type?{"iteration.id":i.value,"release.id":i.releaseId,"_project.id":i.projectId}:{"iteration.id":null,"release.id":i.value,"_project.id":i.projectId},this.applyValue(t)}})});