define(["Underscore","jQuery","tau/core/extension.base","tau/ui/templates/board.editor/ui.template.board.editor.axisTypes","tau/ui/behaviour/overlay/ui.behaviour.overlay","libs/jquery/jquery.placeholder","libs/jquery/jquery.toggleFilter","libs/jquery/jquery.tau.resetableInput"],function(e,i,t,r){var n=null;return t.extend({resetLifecycle:!0,disableSettingsChange:!1,"bus afterRender":function(e,i){var t=i.element,r=t.find(".i-role-filter-input");r.placeholder(),t.find(".i-role-filter-control").toggleFilter(),this.fire("$el.ready",t),this.fire("$form.ready",t)},"bus $el.ready:last + error":function(e,i){i.data("ui-tauOverlay")&&i.tauOverlay("hide")},"bus $form.ready + updateData.ready":function(t,r,a){var l=this;r.on("click",".i-role-sorter-toggler",function(){i(this).toggleClass("tau-checked")});var o=a.access;if(o.edit===!1)return r.find("select, input, button").not(".i-role-filter-toggle").not(".i-role-sorter-toggler").prop("disabled",!0).addClass("permission-denied"),!1;r.find(".i-role-filter-input").tauResetableInput({showAlways:!0}),r.on("click",".i-role-switch-filter",function(){var e=r.find("[name=x_types]"),t=r.find("[name=y_types]"),n=r.find("[name=x_filter]"),a=n.parents(".i-role-filter-control:first"),o=r.find("[name=y_filter]"),d=o.parents(".i-role-filter-control:first"),s=r.find("[name=x_ordering_name]"),c=r.find("[name=x_ordering_direction]"),u=c.parents(".i-role-ordering-control:first"),f=r.find("[name=y_ordering_name]"),p=r.find("[name=y_ordering_direction]"),g=p.parents(".i-role-ordering-control:first"),m=e.val(),h=n.val(),y=s.find("option").map(function(){var e=i(this);return{id:e.attr("value"),name:e.text(),isSelected:e.prop("selected")}}),_=f.find("option").map(function(){var e=i(this);return{id:e.attr("value"),name:e.text(),isSelected:e.prop("selected")}}),v=c.data("direction");n.val(o.val()),n.trigger("input");var b=t.val(),x=e.find("option").detach(),F=t.find("option").detach();e.append(F),e.val(b),l.updateOrderingState(s,_),l.updateOrderingDirectionState(c,p.data("direction"));
var S=!!u.find(".i-role-sorter-toggler.tau-checked").length,D=!!g.find(".i-role-sorter-toggler.tau-checked").length;u.find(".i-role-sorter-toggler").toggleClass("tau-checked",D),g.find(".i-role-sorter-toggler").toggleClass("tau-checked",S),o.val(h),o.trigger("input"),t.append(x),t.val(m),l.updateOrderingState(f,y),l.updateOrderingDirectionState(p,v);var k=a.find(".i-role-useFilter").prop("checked"),C=d.find(".i-role-useFilter").prop("checked");a.find(".i-role-useFilter").prop("checked",C),d.find(".i-role-useFilter").prop("checked",k),r.trigger("_submit")});var d=["[name=cells_ordering_direction]","[name=x_types]","[name=x_ordering_direction]","[name=y_types]","[name=y_ordering_direction]"].join(","),s=["[name=cells_ordering_name]","[name=x_ordering_name]","[name=y_ordering_name]"].join(",");r.on("change",s,e.bind(function(e){var t=i(e.target);this.updateOrderingDirectionState(t.next(),t.find(":selected").data("direction")),r.trigger("_submit",{$input:t,sourceEvent:e})},this)),r.on("change",d,function(e){r.trigger("_submit",{$input:i(this),sourceEvent:e})}),r.on("click",".i-role-cell-type",function(e){if(0==l.disableSettingsChange){l.disableSettingsChange=!0;var t=i(this),n=t.prev("input");t.toggleClass("tau-checked");var a=t.hasClass("tau-checked");n.prop("checked",a),a&&r.find(".tau-board-settings-cards h4").removeClass("tau-attention"),r.trigger("_submit",{$input:n,sourceEvent:e})}else e.preventDefault(),e.stopPropagation()});var c="[name=cells_filter], [name=x_filter], [name=y_filter]";r.on("_change",c,function(e){r.trigger("_submit",{$input:i(this),sourceEvent:e})}),r.on("clear",c,function(){i(this).trigger("_change")}),r.on("keydown",c,function(e){if(e.which==i.ui.keyCode.ENTER){var t=i(this);t.blur()}}),r.on("click",".i-role-direction-toggler",function(){var e=i(this);e.toggleClass("tau-sort-inc"),e.toggleClass("tau-sort-dec"),e.hasClass("tau-sort-dec")?e.data("direction","Desc"):e.data("direction","Asc"),e.trigger("change")}),r.on("_submit",function(i,t){var a=!1;
t&&t.$input&&(l.resetFilters(r,t.$input),t.$input.is("[name=x_types]")&&(a="x"),t.$input.is("[name=y_types]")&&(a="y"),t.$input.is("[name=cells_types]")&&(a="cells"));var o=l.bindForm(r,a);clearTimeout(n),n=e.delay(function(){l.fire("formData.changed",o)},250)})},"bus refresh":function(){clearTimeout(n),this._super()},"bus destroy":function(){clearTimeout(n),this._super()},"bus settings.changed":function(){this.fire("form.readyToUpdate")},"bus $form.ready":function(){this.fire("form.readyToUpdate")},"bus configurator.ready:last + $form.ready:last + updateData.ready ":function(e,i,t,r){this.updateForm(i,t,r.space,r.access)},resetFilters:function(e,i){"x_types"==i.attr("name")&&e.find("[name=x_filter]").val(""),"y_types"==i.attr("name")&&e.find("[name=y_filter]").val("")},bindForm:function(t,r){r=!1;var n={x:{types:[],filter:"",useFilter:!1,ordering:{name:"",direction:"Asc"}},y:{types:[],filter:"",useFilter:!1,ordering:{name:"",direction:"Asc"}},cells:{types:[],filter:"",useFilter:!1,ordering:{name:"",direction:"Asc"}}};n.x.types=e.compact([t.find("[name=x_types]").val()]),n.x.filter=e.trim(t.find("[name=x_filter]").val()),n.x.useFilter=!!n.x.filter&&t.find("[name=x_useFilter]").prop("checked"),"x"==r?(n.x.ordering=null,n.x.direction=null):(n.x.ordering.name=e.trim(t.find("[name=x_ordering_name]").val())||null,n.x.ordering.direction=t.find("[name=x_ordering_direction]").data("direction")||null),n.y.types=e.compact([t.find("[name=y_types]").val()]),n.y.filter=e.trim(t.find("[name=y_filter]").val()),n.y.useFilter=!!n.y.filter&&t.find("[name=y_useFilter]").prop("checked"),"y"==r?(n.y.ordering=null,n.y.direction=null):(n.y.ordering.name=e.trim(t.find("[name=y_ordering_name]").val())||null,n.y.ordering.direction=t.find("[name=y_ordering_direction]").data("direction")||null),"cells"==r?(n.cells.ordering=null,n.direction.ordering=null):(n.cells.ordering.name=e.trim(t.find("[name=cells_ordering_name]").val())||null,n.cells.ordering.direction=t.find("[name=cells_ordering_direction]").data("direction")||null);
var a=[];return t.find("[name=cells_types]:checked").each(function(){a.push(i(this).val())}),n.cells.types=e.compact(a),n.cells.filter=e.trim(t.find("[name=cells_filter]").val()),n.cells.useFilter=!!n.cells.filter&&t.find("[name=cells_useFilter]").prop("checked"),n},updateForm:function(t,r,n,a){var l=r.find(".i-role-filter-input");l.placeholder("refresh"),r.find(".i-role-filter-control").toggleFilter("refresh");var o=r.find("[name=cells_types]"),d=r.find("[name=x_types]"),s=r.find("[name=y_types]"),c=r.find("[name=cells_filter]"),u=r.find("[name=x_filter]"),f=r.find("[name=y_filter]"),p=r.find("[name=x_ordering_name]"),g=r.find("[name=y_ordering_name]"),m=r.find("[name=cells_ordering_name]"),h=r.find("[name=x_ordering_direction]"),y=r.find("[name=y_ordering_direction]"),_=r.find("[name=cells_ordering_direction]"),v=n.cells.types;e.forEach(v,function(e){var t=!e.isAvailable,r=o.filter(function(){return this.value==e.id||i(this).hasClass("permission-denied")}),n=r.next();r.prop("disabled",t).toggleClass("tau-disabled",t),n.prop("disabled",t).toggleClass("tau-disabled",t)});var b="remove",x={disable:e.bind(this.updateSelectByDisable,this),remove:e.bind(this.updateSelectByRemove,this)}[b];x(t,d,n.x),x(t,s,n.y),this.updateFilterState(d.val(),u),this.updateFilterState(s.val(),f),this.updateFilterState(o.filter(":checked").length,c),this.updateOrderingState(p,n.x.orderingNames),this.updateOrderingState(g,n.y.orderingNames),this.updateOrderingState(m,n.cells.orderingNames),this.updateOrderingDirectionState(h,n.x.orderingDirection),this.updateOrderingDirectionState(y,n.y.orderingDirection),this.updateOrderingDirectionState(_,n.cells.orderingDirection),this.toggleOrderingDisable(d.next(),p.find("option").length,a),this.toggleOrderingDisable(s.next(),g.find("option").length,a),this.toggleOrderingDisable(m.parent(),m.find("option").length,a),this.disableSettingsChange=!1},updateSelectByRemove:function(e,i,t){var n=e.getTemplateFactory().get(r.name).bind({},t);i.find("option:not(:first)").remove(),i.append(n)
},updateSelectByDisable:function(i,t){var r=i.find("option");e.forEach(t,function(e){r.filter(function(){return this.value==e.id}).prop("disabled",!e.isAvailable)})},setFilterFieldDisabled:function(e,i){e.prop("disabled",i);var t=e.closest(".i-role-filter-control");t.find(".i-role-help").prop("disabled",i),t.find(".i-role-filter-toggle").prop("disabled",i&&!t.hasClass("i-role-filter-control_on"))},updateFilterState:function(e,i){var t=!(e&&!i.hasClass("permission-denied"));this.setFilterFieldDisabled(i,t)},updateOrderingState:function(t,r){t.find("option").remove(),e.forEach(r,function(e){var r=i('<option value="'+e.id+'"'+(e.isSelected?'selected="selected"':"")+">"+e.name+"</option>");r.data("direction",e.direction),t.append(r)})},updateOrderingDirectionState:function(e,i){e.removeData("direction"),e.data("direction",i),e.toggleClass("tau-sort-dec","Desc"==i),e.toggleClass("tau-sort-inc","Asc"==i||!i)},toggleOrderingDisable:function(e,i,t){t.edit?i>0?e.find(":input").prop("disabled",!1):e.find(":input").prop("disabled",!0):i>0?e.find("select").prop("disabled",!0):e.find(":input").prop("disabled",!0)}})});