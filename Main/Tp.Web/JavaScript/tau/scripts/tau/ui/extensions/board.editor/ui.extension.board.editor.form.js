define(["Underscore","jQuery","tau/core/extension.base","tau/ui/templates/board.editor/ui.template.board.editor.axisTypes","tau/ui/behaviour/overlay/ui.behaviour.overlay","libs/jquery/jquery.placeholder","libs/jquery/jquery.toggleFilter"],function(_,$,ExtensionBase,axisTypesTemplate){return ExtensionBase.extend({resetLifecycle:!0,"bus afterRender":function(evt,renderData){var $form=renderData.element,$filters=$form.find(".i-role-filter-input");$filters.placeholder(),$form.find(".i-role-filter-control").toggleFilter(),this.fire("$el.ready",$form),this.fire("$form.ready",$form)},"bus $el.ready:last + error":function(evt,$el){$el.tauOverlay("hide")},"bus $form.ready + updateData.ready":function(evt,$form,updateData){var self=this;$form.find(".i-role-sorter-toggler").on("click",function(){$(this).toggleClass("tau-checked")});var access=updateData.access;if(access.edit===!1)return $form.find("select, input, button").not(".i-role-filter-toggle").not(".i-role-sorter-toggler").prop("disabled",!0).addClass("permission-denied"),!1;$form.find(".i-role-filter-input").tauResetableInput(),$form.delegate("[name=cells_types]","change",function(){$(this).next().toggleClass("tau-checked")}),$form.on("click",".i-role-switch-filter",function(){var $xTypes=$form.find("[name=x_types]"),$yTypes=$form.find("[name=y_types]"),$xFilter=$form.find("[name=x_filter]"),$xFilterControl=$xFilter.parents(".i-role-filter-control:first"),$yFilter=$form.find("[name=y_filter]"),$yFilterControl=$yFilter.parents(".i-role-filter-control:first"),$xOrderingName=$form.find("[name=x_ordering_name]"),$xOrderingDir=$form.find("[name=x_ordering_direction]"),$xOrderingControl=$xOrderingDir.parents(".i-role-ordering-control:first"),$yOrderingName=$form.find("[name=y_ordering_name]"),$yOrderingDir=$form.find("[name=y_ordering_direction]"),$yOrderingControl=$yOrderingDir.parents(".i-role-ordering-control:first"),xTypesTemp=$xTypes.val(),xFilterTemp=$xFilter.val(),xOrderingNameTemp=$xOrderingName.find("option").map(function(){var $o=$(this);return{id:$o.attr("value"),name:$o.text(),isSelected:$o.attr("selected")||!1}}),yOrderingNameTemp=$yOrderingName.find("option").map(function(){var $o=$(this);return{id:$o.attr("value"),name:$o.text(),isSelected:$o.attr("selected")||!1}}),xOrderingDirTemp=$xOrderingDir.is(":checked");$xFilter.val($yFilter.val());var yVal=$yTypes.val(),xVal=$xTypes.val(),$xOpts=$xTypes.find("option").detach(),$yOpts=$yTypes.find("option").detach();$xTypes.append($yOpts),$xTypes.val(yVal),self.updateOrderingState($xOrderingName,yOrderingNameTemp),self.updateOrderingDirectionState($xOrderingDir,$yOrderingDir.is(":checked"));var yControlToCheck=!!$xOrderingControl.find(".i-role-sorter-toggler.tau-checked").length,xControlToCheck=!!$yOrderingControl.find(".i-role-sorter-toggler.tau-checked").length;$xOrderingControl.find(".i-role-sorter-toggler").toggleClass("tau-checked",xControlToCheck),$yOrderingControl.find(".i-role-sorter-toggler").toggleClass("tau-checked",yControlToCheck),$yFilter.val(xFilterTemp),$yTypes.append($xOpts),$yTypes.val(xTypesTemp),self.updateOrderingState($yOrderingName,xOrderingNameTemp),self.updateOrderingDirectionState($yOrderingDir,xOrderingDirTemp);var yFilterToCheck=$xFilterControl.hasClass("tau-inline-group"),xFilterToCheck=$yFilterControl.hasClass("tau-inline-group");$xFilterControl.toggleClass("tau-inline-group",xFilterToCheck).find(".i-role-filter-toggle").toggleClass("tau-checked",xFilterToCheck),$yFilterControl.toggleClass("tau-inline-group",yFilterToCheck).find(".i-role-filter-toggle").toggleClass("tau-checked",yFilterToCheck),$form.trigger("_change")});var controlsSelectors=["[name=cells_types]","[name=cells_ordering_name]","[name=cells_ordering_direction]","[name=x_types]","[name=x_ordering_name]","[name=x_ordering_direction]","[name=y_types]","[name=y_ordering_name]","[name=y_ordering_direction]"].join(",");$form.delegate(controlsSelectors,"change",function(e){$form.trigger("_change",{$input:$(this),sourceEvent:e})});var filterSelector="[name=cells_filter], [name=x_filter], [name=y_filter]";$form.on("_change",filterSelector,function(e){$form.trigger("_change",{$input:$(this),sourceEvent:e})}),$form.delegate(filterSelector,"clear",function(){$(this).trigger("_change")}),$form.delegate(filterSelector,"keydown",function(e){if(e.which==$.ui.keyCode.ENTER){var $input=$(this);$input.blur()}}),$form.on("_change",function(e,source){var skipOrdering=!1;source&&source.$input&&(self.resetFilters($form,source.$input),source.$input.is("[name=x_types]")&&(skipOrdering="x"),source.$input.is("[name=y_types]")&&(skipOrdering="y"),source.$input.is("[name=cells_types]")&&(skipOrdering="cells"));var data=self.bindForm($form,skipOrdering);self.fire("formData.changed",data)}),$form.find(".i-role-direction-toggler").on("click",function(){var $t=$(this);$t.toggleClass("tau-sort-inc"),$t.toggleClass("tau-sort-dec"),$t.hasClass("tau-sort-dec")?$t.next(":checkbox").attr("checked","checked"):$t.next(":checkbox").removeAttr("checked"),$t.next(":checkbox").trigger("change")})},"bus settings.changed":function(evt){this.fire("form.readyToUpdate")},"bus $form.ready":function(evt){this.fire("form.readyToUpdate")},"bus configurator.ready:last + $form.ready:last + updateData.ready ":function(evt,configurator,$form,updateData){this.updateForm(configurator,$form,updateData.space,updateData.access)},resetFilters:function($form,$element){$element.attr("name")=="x_types"&&$form.find("[name=x_filter]").val(""),$element.attr("name")=="y_types"&&$form.find("[name=y_filter]").val("")},bindForm:function($form,skipOrdering){var data={x:{types:[],filter:"",ordering:{name:"",isDescending:!1}},y:{types:[],filter:"",ordering:{name:"",isDescending:!1}},cells:{types:[],filter:"",ordering:{name:"",isDescending:!1}}};data.x.types=_.compact([$form.find("[name=x_types]").val()]),data.x.filter=_.trim($form.find("[name=x_filter]").val()),skipOrdering=="x"?data.x.ordering=null:(data.x.ordering.name=_.trim($form.find("[name=x_ordering_name]").val())||null,data.x.ordering.isDescending=$form.find("[name=x_ordering_direction]").is(":checked")),data.y.types=_.compact([$form.find("[name=y_types]").val()]),data.y.filter=_.trim($form.find("[name=y_filter]").val()),skipOrdering=="y"?data.y.ordering=null:(data.y.ordering.name=_.trim($form.find("[name=y_ordering_name]").val())||null,data.y.ordering.isDescending=$form.find("[name=y_ordering_direction]").is(":checked")),skipOrdering=="cells"?data.cells.ordering=null:(data.cells.ordering.name=_.trim($form.find("[name=cells_ordering_name]").val())||null,data.cells.ordering.isDescending=$form.find("[name=cells_ordering_direction]").is(":checked"));var types=[];return $form.find("[name=cells_types]:checked").each(function(){types.push($(this).val())}),data.cells.types=_.compact(types),data.cells.filter=_.trim($form.find("[name=cells_filter]").val()),data},updateForm:function(configurator,$form,space,access){var $filter=$form.find(".i-role-filter-input");$filter.placeholder("refresh"),$form.find(".i-role-filter-control").toggleFilter("refresh");var $cells=$form.find("[name=cells_types]"),$x_type=$form.find("[name=x_types]"),$y_type=$form.find("[name=y_types]"),$cells_filter=$form.find("[name=cells_filter]"),$x_filter=$form.find("[name=x_filter]"),$y_filter=$form.find("[name=y_filter]"),$x_ordering=$form.find("[name=x_ordering_name]"),$y_ordering=$form.find("[name=y_ordering_name]"),$cells_ordering=$form.find("[name=cells_ordering_name]"),$x_ordering_direction=$form.find("[name=x_ordering_direction]"),$y_ordering_direction=$form.find("[name=y_ordering_direction]"),$cells_ordering_direction=$form.find("[name=cells_ordering_direction]"),items=space.cells.types;_.forEach(items,function(item){$cells.filter(function(){return this.value==item.id||$(this).hasClass("permission-denied")}).prop("disabled",!item.isAvailable).toggleClass("tau-disabled",!item.isAvailable).next().prop("disabled",!item.isAvailable).toggleClass("tau-disabled",!item.isAvailable)});var strategyName="remove",updateStrategy={disable:_.bind(this.updateSelectByDisable,this),remove:_.bind(this.updateSelectByRemove,this)}[strategyName];updateStrategy(configurator,$x_type,space.x),updateStrategy(configurator,$y_type,space.y),this.updateFilterState($x_type.val(),$x_filter),this.updateFilterState($y_type.val(),$y_filter),this.updateFilterState($cells.filter(":checked").length,$cells_filter),this.updateOrderingState($x_ordering,space.x.orderingNames),this.updateOrderingState($y_ordering,space.y.orderingNames),this.updateOrderingState($cells_ordering,space.cells.orderingNames),this.updateOrderingDirectionState($x_ordering_direction,space.x.orderingDirection),this.updateOrderingDirectionState($y_ordering_direction,space.y.orderingDirection),this.updateOrderingDirectionState($cells_ordering_direction,space.cells.orderingDirection),this.toggleOrderingDisable($x_type.next(),$x_ordering.find("option").length,access),this.toggleOrderingDisable($y_type.next(),$y_ordering.find("option").length,access),this.toggleOrderingDisable($cells_ordering.parent(),$cells_ordering.find("option").length,access)},updateSelectByRemove:function(configurator,$select,axis){var $opts=configurator.getTemplateFactory().get(axisTypesTemplate.name).bind({},axis);$select.find("option:not(:first)").remove(),$select.append($opts)},updateSelectByDisable:function($select,items){var $opts=$select.find("option");_.forEach(items,function(item){$opts.filter(function(){return this.value==item.id}).prop("disabled",!item.isAvailable)})},setFilterFieldDisabled:function($input,isDisabled){$input.prop("disabled",isDisabled);var closest=$input.closest(".i-role-filter-control");closest.find(".i-role-help").prop("disabled",isDisabled),closest.find(".i-role-filter-toggle").prop("disabled",isDisabled&&!closest.hasClass("i-role-filter-control_on"))},updateFilterState:function(value,$dependentField){var state=!0;value&&!$dependentField.hasClass("permission-denied")&&(state=!1),this.setFilterFieldDisabled($dependentField,state)},updateOrderingState:function($select,data){$select.find("option").remove(),_.forEach(data,function(item){var $o=$('<option value="'+item.id+'">'+item.name+"</option>");item.isSelected&&$o.attr("selected",!0),$select.append($o)})},updateOrderingDirectionState:function($input,data){var b=!!data;$input.prev(":button").toggleClass("tau-sort-dec",b),$input.prev(":button").toggleClass("tau-sort-inc",!b),data?$input.prop("checked",!0):$input.prop("checked",!1)},toggleOrderingDisable:function($el,val,access){access.edit?val>0?$el.find(":input").prop("disabled",!1):$el.find(":input").prop("disabled",!0):val>0?$el.find("select").prop("disabled",!0):$el.find(":input").prop("disabled",!0)}})})