define(["Underscore","jQuery","tau/core/extension.base","tau/models/board.customize.units/board.customize.cards.builderSelector"],function(e,t,a,r){var i=function(e){return e.data&&e.data.cardData&&e.data.cardData.id},s=a.extend({resetLifecycle:!0,init:function(e){this.cards={},this.forceRefresh=!1,this._super(e)},getZoomControl:function(){return t('.tau-board-header [role="zoomer"]')},toggleZoomControl:function(e){var t=this.getZoomControl();t.data("ui-slider")&&t.slider(e?"enable":"disable")},disableZoomControl:function(){this.toggleZoomControl(!1)},enableZoomControl:function(){this.toggleZoomControl(!0)},reset:function(){this.cards={},this.enableZoomControl()},"bus before_destroy":function(){this.reset()},"bus before_refresh":function(){this.reset()},_failCardDetails:function(e,t){this.forceRefresh&&this.fire("refresh");var a=t.command.method;"cardsDetails"==a&&this.fire("lazy.cards.ready",this.cards)},_refreshOnLazySliceAbort:function(){this.fire("refresh")},_refreshOnBaseSliceAbort:function(e,t){this.fire("refresh"),this._failCardDetails(e,t)},_refreshOnSliceAbort:function(e,t){this._failCardDetails(e,t)},handlerSliceFail:function(e){e.lazy.on("abort",this._refreshOnLazySliceAbort,this),e.base.on("abort",this._refreshOnBaseSliceAbort,this),e.slice.on("abort",this._refreshOnSliceAbort,this)},"bus afterInit":function(){this.disableZoomControl()},"bus domWrapper.ready":function(){this.enableZoomControl()},_removeCellCardsFromCache:function(t,a){var r=this.readCardsCells(a);e.each(r,function(e,t){this.removeFromCache(t)},this)},"bus slice.ready":function(e,t){this.getCards(t).done(function(e){this.isNeedLazy(t.lazy.config.definition)||this.fire("lazy.cards.ready",e)}.bind(this)),t.slice.on("after.cells",this._removeCellCardsFromCache,this),this.handlerSliceFail(t)},"bus operation.execute":function(t,a){e.each(a.items,function(e){this.removeFromCache(i(e.data))},this)},removeFromCache:function(e){delete this.cards[e]},"bus domWrapper.ready:last + lazy.cards.ready":function(e,t,a){this.updateCards(a,t,!0)
},redrawCards:function(a,r,i){var s=r.getCards();if(e.each(s,e.bind(function(e){var a=t(e),r=a.data("entityId");this.cards[r]||(this.cards[r]={id:a.data("id"),orderingValue:a.data("orderingValue"),type:a.data("entityType"),data:{cardData:a.data("cardData")}})},this)),this.forceRefresh=!1,s.length>150)return this.forceRefresh=!0,void this.fire("refresh");this.fire("startLazyLoadCard"),r.getGrid().removeClass("tau-board-lazy-animation_unit"),r.getGrid().addClass("tau-board-lazy-animation_unit"),this.updateCards(this.cards,r);var n=[];this.cards=e.reduce(this.cards,function(a,r,i){return e.each(s,function(e){t(e).data("entityId")==i&&(a[i]=r)}),a},{}),this.isNeedLazy(i.slice.config.definition)&&(n=e.keys(this.cards)),this.getCardDetails(n,i.slice,{}).done(function(t){e.mergeDeep(this.cards,t),this.fire("lazy.cards.ready",t)}.bind(this)).fail(function(){this.fire("lazy.cards.ready",this.cards)}.bind(this))},"bus lazy.cards.ready > domWrapper.ready:last > slice.ready":function(e,t,a,r){this.redrawCards(t,a,r)},updateCards:function(a,r,i){var s=this,n=e.size(a),o=0,d=function(){s.fire("cardsFullyLoaded",{isRunAdditionalAction:!!i}),r.getGrid().removeClass("tau-board-lazy-animation_unit")};e.each(a,function(a){r.renderCardAsHtml(a).done(function(i){var s=a.id,c=r.getCardBySliceId(s),l=c.length;0===c.length?(n-=1,n==o&&d()):o++,e.each(c,function(e,a){t(e).html(i.html()),n==o&&l-1==a&&d()})})})},"bus view.skeleton.built:last + startLazyLoadCard":function(e,t){this.startAnimate(t)},"bus view.skeleton.built:last + lazy.cards.ready":function(e,t){this.stopAnimate(t)},startAnimate:function(e){e.element.addClass("tau-board-lazy-animation")},stopAnimate:function(e){e.element.removeClass("tau-board-lazy-animation")},isNeedLazy:function(t){var a=new r;return e.reduce(t.cells&&t.cells.types||[],function(e,t){return e||"{}"!==a.buildSelectorWithoutCardData(t.data||"")},!1)},getCardDetails:function(a,r,s){var n={$set:{CardsIds:a}};return r.cardDetails(n).then(function(t){var a=t.data.items;
return e.reduce(a,function(t,a){var r=i(a),s=e.deepClone(t[r]&&t[r].data||{});return s=e.mergeDeep(s,a.data),t[r]=e.mergeDeep(t[r]||{},a),t[r].data=s,t},s)},function(){return t.Deferred().reject()})},readCardsCells:function(t){var a=t.result.items;return e.reduce(a,function(t,a){return e(a.dynamic.items).each(function(e){t[i(e)]=e}),t},{})},_cellLoad:function(t,a,r,i){var s=this.readCardsCells(i);this.cards=e.mergeDeep(this.cards,s),this.isNeedLazy(t.lazy.config.definition)&&(this.fire("startLazyLoadCard"),this.getCardDetails(e.keys(s),t.lazy,s).done(function(e){this.fire("lazy.cards.ready",e)}.bind(this)).fail(function(){this.fire("lazy.cards.ready",s)}.bind(this))),a.resolve(s)},getCards:function(e){var a=t.Deferred();return e.base.on(["after.cells","after.list"],this._cellLoad.bind(this,e,a),this),a},"bus slice.ready:last + destroy":function(e,t){t.base.removeAllListeners(this),t.lazy.removeAllListeners(this),t.slice.removeAllListeners(this)}});return s});