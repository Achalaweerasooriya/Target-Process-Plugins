define(["Underscore","jQuery","tau/core/extension.base","tau/models/board.customize.units/board.customize.cards.builderSelector"],function(e,t,a,i){var r=function(e){return e.data&&e.data.cardData&&e.data.cardData.id},n=a.extend({resetLifecycle:!0,init:function(e){this.cards={},this.forceRefresh=!1,this._super(e)},getZoomControl:function(){return t('.tau-board-header [role="zoomer"]')},disableZoomControl:function(){var e=this.getZoomControl();e.data("ui-slider")&&e.slider("disable")},enableZoomControl:function(){var e=this.getZoomControl();e.data("ui-slider")&&e.slider("enable")},reset:function(){this.cards={},this.enableZoomControl()},"bus before_destroy":function(){this.reset()},"bus before_refresh":function(){this.reset()},handlerSliceFail:function(e){var t=function(e,t){this.forceRefresh&&this.fire("refresh");var a=t.command.method;"cardsDetails"==a&&this.fire("lazy.cards.ready",this.cards)}.bind(this);e.lazy.on("abort",function(){this.fire("refresh")}.bind(this)),e.base.on("abort",function(e,a){this.fire("refresh"),t(e,a)}.bind(this)),e.slice.on("abort",t)},"bus afterInit":function(){this.disableZoomControl()},"bus domWrapper.ready":function(){this.enableZoomControl()},"bus slice.ready":function(t,a){this.getCards(a).done(function(e){this.isNeedLazy(a.lazy.config.definition)||this.fire("lazy.cards.ready",e)}.bind(this)),a.slice.on("after.cells",function(t,a){var i=this.readCardsCells(a);e.each(i,function(e,t){this.removeFromCache(t)},this)}.bind(this)),this.handlerSliceFail(a)},"bus operation.execute":function(t,a){e.each(a.items,function(e){this.removeFromCache(r(e.data))},this)},removeFromCache:function(e){delete this.cards[e]},"bus domWrapper.ready:last + lazy.cards.ready":function(e,t,a){this.updateCards(a,t,!0)},redrawCards:function(a,i,r){var n=i.getCards();if(e.each(n,e.bind(function(e){var a=t(e),i=a.data("entityId");this.cards[i]||(this.cards[i]={id:a.data("id"),orderingValue:a.data("orderingValue"),type:a.data("entityType"),data:{cardData:a.data("cardData")}})},this)),this.forceRefresh=!1,n.length>150)return this.forceRefresh=!0,void this.fire("refresh");this.fire("startLazyLoadCard"),i.getGrid().removeClass("tau-board-lazy-animation_unit"),i.getGrid().addClass("tau-board-lazy-animation_unit"),this.updateCards(this.cards,i);var s=[];this.cards=e.reduce(this.cards,function(a,i,r){return e.each(n,function(e){t(e).data("entityId")==r&&(a[r]=i)}),a},{}),this.isNeedLazy(r.slice.config.definition)&&(s=e.keys(this.cards)),this.getCardDetails(s,r.slice,{}).done(function(t){e.mergeDeep(this.cards,t),this.fire("lazy.cards.ready",t)}.bind(this)).fail(function(){this.fire("lazy.cards.ready",this.cards)}.bind(this))},"bus lazy.cards.ready > domWrapper.ready:last > slice.ready":function(e,t,a,i){this.redrawCards(t,a,i)},updateCards:function(a,i,r){var n=this,s=e.size(a),d=0,o=function(){n.fire("cardsFullyLoaded",{isRunAdditionalAction:!!r}),i.getGrid().removeClass("tau-board-lazy-animation_unit")};e.each(a,function(a){i.renderCardAsHtml(a).done(function(r){var n=a.id,c=i.getCardBySliceId(n),u=c.length;0===c.length?(s-=1,s==d&&o()):d++,e.each(c,function(e,a){t(e).html(r.html()),s==d&&u-1==a&&o()})})})},"bus view.skeleton.built:last + startLazyLoadCard":function(e,t){this.startAnimate(t)},"bus view.skeleton.built:last + lazy.cards.ready":function(e,t){this.stopAnimate(t)},startAnimate:function(e){e.element.addClass("tau-board-lazy-animation")},stopAnimate:function(e){e.element.removeClass("tau-board-lazy-animation")},isNeedLazy:function(t){var a=new i;return e.reduce(t.cells&&t.cells.types||[],function(e,t){return e||"{}"!==a.buildSelectorWithoutCardData(t.data||"")},!1)},getCardDetails:function(a,i,n){var s={$set:{CardsIds:a}};return i.cardDetails(s).then(function(t){var a=t.data.items;return e.reduce(a,function(t,a){var i=r(a),n=e.deepClone(t[i]&&t[i].data||{});return n=e.mergeDeep(n,a.data),t[i]=e.mergeDeep(t[i]||{},a),t[i].data=n,t},n)},function(){return t.Deferred().reject()})},readCardsCells:function(t){var a=t.result.items;return e.reduce(a,function(t,a){return e(a.dynamic.items).each(function(e){t[r(e)]=e}),t},{})},getCards:function(a){var i=t.Deferred(),r=function(t,r){var n=this.readCardsCells(r);this.cards=e.mergeDeep(this.cards,n),this.isNeedLazy(a.lazy.config.definition)&&(this.fire("startLazyLoadCard"),this.getCardDetails(e.keys(n),a.lazy,n).done(function(e){this.fire("lazy.cards.ready",e)}.bind(this)).fail(function(){this.fire("lazy.cards.ready",n)}.bind(this))),i.resolve(n)}.bind(this);return a.base.on("after.cells",r),a.base.on("after.list",r),i}});return n});