define(["Underscore","jQuery","tau/core/extension.base"],function(t,e,i){return i.extend({init:function(t,e,i,r){return this.model=r,this.configurator=e,this.entity=i,this._super(t)},"bus beforeInit":function(){e.when(this.model.load()).then(t.bind(function(t){this.fire("dataBind",{groups:t.groups,effort:t.effort,points:t.points})},this))},"bus afterRender":function(i,r){var n=r.element;n.on("keydown","input",function(t){var e=t.charCode||t.keyCode||0;return 8==e||9==e||13==e||27==e||46==e||110==e||190==e||e>=35&&40>=e||e>=48&&57>=e||e>=96&&105>=e}),n.on("focusin focusout","input",t.bind(function(t){var i=e(t.currentTarget).parents(".tau-effort__group");i.toggleClass("tau-effort__group_state_edit","focusin"===t.type)},this)),n.on("focusout",t.bind(function(t){t.relatedTarget&&!e(t.relatedTarget).is("input")&&this.fire("effort.editor.finished")},this)),n.on("change","input",t.bind(function(t){var i=e(t.currentTarget).parents(".tau-effort");this._saveRoleEfforts(i),this._updateTotalEffort(i)},this)),n.on("click",".i-role-edittrigger",t.bind(function(t){var i=e(t.currentTarget);i.parent().find(":text").focus(1)},this)),n.on("click","form",t.bind(function(t){t.stopPropagation()},this)),n.on("submit","form",t.bind(function(t){var i=e(t.currentTarget).find("input");i.blur(),this.fire("effort.editor.finished"),t.preventDefault()},this)),n.on("close.event",t.bind(function(){this.fire("effort.editor.finished")},this)),this._updateTotalEffort(n),n.find(":text").first().focus(1)},_updateTotalEffort:function(t){var e=this._getTotalEffort(t);t.find(".tau-effort__total span").text(e)},_saveRoleEfforts:function(t){var i=this._getRoleEfforts(t);this.fire("effort.editor.saving"),e.when(this.model.saveEfforts(i)).done(this.fire.bind(this,"effort.editor.saved")).fail(this.fire.bind(this,"effort.editor.saveFailed"))},_getRoleEfforts:function(i){return t.map(i.find(":text"),function(t){var i=e(t);return{id:i.attr("data-role-effort-id"),role:{id:i.attr("data-role-id")},effort:i.val()||0}},this)},_getTotalEffort:function(e){var i=this._getRoleEfforts(e);return t.reduce(i,function(t,e){return t+parseFloat(e.effort)},0)}})});