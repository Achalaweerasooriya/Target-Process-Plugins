define(["jQuery","Underscore","tau/components/extensions/component.extension.base","template!tau/ui/templates/board.editor/ui.template.board.editor.filterHelp"],function(e,t,i,r){return i.extend({"bus afterRender:last + content.ready:last + refresh.help.content":function(e,i,n,l){this._initFilterSavers(i.element,l),t.each(n,function(e){t.each(l,function(t,i){var n=e.find("[role="+i+"_help]");if(n.length){var l=r.get().bind({},t.filters);n.find(".i-role-filters-table").remove(),n.append(l.find(".i-role-filters-table")),this.fire("content.$element.ready",n.parent())}},this)},this)},"bus afterRender:last + content.$element.ready":function(e,t,i){var r=i.find(".filter-help").attr("role")+"_button",n=t.element.find("."+r);n.toggle(i.find(".i-role-complex-filter-example").length>0)},"bus afterRender":function(e){var i=this._getConfig(e.data);this._initFilterSavers(e.data.element,i);var r=e.data.element.find(".i-role-help"),n=t.map(r,this._initHelp.bind(this));this.fire("content.ready",n)},"bus content.$element.ready:last + destroy":function(e,t){t.off("click.helpfilter"),t=null},_getConfig:function(e){return e.data},_initFilterSavers:function(i,r){var n=i.find(".i-role-filter-input");t.each(n,function(t){var i=t.name.replace("_filter","");this._initFilterSaver(e(t),(r[i]||{}).filters)}.bind(this))},_initFilterSaver:function(i,r){var n=i.closest(".i-role-filter");if(n.find(".i-role-save-filter").remove(),r){var l=e('<span class="tau-icon-general tau-icon-star i-role-save-filter tau-extension-board-tooltip"></span>').hide().insertAfter(i),a=function(e){var i=r.privateFilters.concat(r.sharedFilters);return t.some(i,t.matches({value:e}))};l.on("click",function(){var e=i.val();e&&!a(e)&&this.fire("save.filter",{target:n,data:{value:e,description:"",entityTypes:r.types,isShared:!1}})}.bind(this));var o=function(){var e=i.val(),t=!!e&&"?"!==e;l.toggle(t);var r=a(e);l.toggleClass("active",r),l.data("title",r?"This filter is already saved":"Save this filter for future use")};i.on("keyup",o),o()
}},"bus afterRender:last + save.filter:last + filter.saved":function(e,t,i){var r=i.target.find(".i-role-help");r.tauBubble("show");var n=r.tauBubble("getContent"),l=n.find(".i-role-complex-filter-example").first();l.find("[contenteditable=true]").focus()},_getFilterRow:function(e){return e.closest(".i-role-complex-filter-example")},_getFilterKey:function(e){return this._getFilterRow(e).data("key")},_getFilterValue:function(e){return this._getFilterRow(e).data("value")},_initHelp:function(i){var r=e(i),n=r.next(".i-role-help-content");n.on("click.helpfilter",".i-role-output-filter",function(i){var n=l._getFilterValue(e(this)),a=r.closest(".i-role-filter").find(":text"),o=Boolean(i.ctrlKey||i.metaKey);r.tauBubble("hide"),setTimeout(function(){o&&a.val()&&(n="?("+t.ltrim(a.val(),"?")+") and ("+t.ltrim(n,"?")+")"),a.val(n),a.keyup(),a.blur()},1)});var l=this;return n.on("focus.helpfilter",".i-role-description",function(){var t=e(this);t.data("before",t.text()),l._getFilterRow(t).addClass("selected")}).on("blur.helpfilter",".i-role-description",function(){var t=e(this);t.data("before")!==t.text()&&l.fire("update.filter",{key:l._getFilterKey(t),data:{description:t.text()}}),l._getFilterRow(t).removeClass("selected")}),n.on("keypress",".i-role-description[contenteditable=true]",function(t){13===t.keyCode&&(t.preventDefault(),e(this).blur())}),n.on("click.helpfilter",".i-role-share",function(){l.fire("share.filter",l._getFilterKey(e(this)))}),n.on("click.helpfilter",".i-role-unshare",function(){l.fire("unshare.filter",l._getFilterKey(e(this)))}),n.on("click.helpfilter",".i-role-saved-filter-delete",function(){var t=e(this);t.tauConfirm("instance")||t.tauConfirm({content:"<h3>Do you really want to remove this filter?</h3>",callbacks:{success:function(){var e=l._getFilterKey(t);l._getFilterRow(t).remove(),l.fire("remove.filter",e)}.bind(this)},zIndex:1e6,onShow:function(){l._getFilterRow(t).addClass("selected")},onHide:function(){l._getFilterRow(t).removeClass("selected")}}),t.tauConfirm("show")
}),this.fire("content.$element.ready",n),this._initHelpBubble(r,n),n},_initHelpBubble:function(e,t){e.tauBubble({className:"i-role-taububble-ignore",content:t,zIndex:1e5,template:['<div class="tau-bubble-board">','<div class="tau-bubble-board__arrow" role="arrow"></div>','<div class="tau-bubble-board__inner tau-container" role="content"></div>',"</div>"].join(""),onResize:function(e,t){var i=t.height;e.find("[role=content]").css({maxHeight:i-20,overflowY:"auto"})},onShow:function(){e.toggleClass("tau-checked",!0)},onHide:function(){e.toggleClass("tau-checked",!1)}})}})});