define(["Underscore","jQuery","tau/components/extensions/component.extension.base"],function(_,$,ExtensionBase){return ExtensionBase.extend({"bus afterInit":function(evt){var self=this;self.store.get("relationTypes",{relationType:["id","name"]}).done({success:function(data){self.fire("dataBind",{relationTypes:data[0].data,relationTypeId:data[0].data[0].id}),self.relationTypeId=data[0].data[0].id}})},"bus entityFinder.entitySelected":function(evt,data){this.entityId=data.entity.id,$(".i-role-add").removeAttr("disabled").addClass("tau-success")},"bus afterRender":function(evt,data){var $element=data.element;this._entityBehavior($element.find(".cf-input"));var self=this;$element.find(".i-role-selector").click(function(e){self._selectRelationType(e)}),$element.find(".i-role-add").click(function(e){self._addEntity()})},_addEntity:function(){var self=this,entity=this.config.context.entity;this.store.save("relation",{$set:{master:{id:this.config.dependencyType==="slave"?entity.id:this.entityId},slave:{id:this.config.dependencyType==="slave"?this.entityId:entity.id},relationType:{id:this.relationTypeId}}}).done(function(){self.store.evictProperties(entity.id,entity.entityType.name,["masterRelations","slaveRelations"]),setTimeout(function(){self.bus.fire("relations.changed",self.config.context)},1)})},_selectRelationType:function(e){var $target=$(e.target);$target.siblings("button.i-role-selector").removeClass("tau-checked"),$target.addClass("tau-checked"),this.relationTypeId=$target.data("id")},_entityBehavior:function($element){var $entityField=$element.closest(".i-role-entity-selector"),$entitySelector=$entityField.find(".tau-userStorySelector"),entityUniqueName=$element.data("entityuniquename"),$entitySelectorControl=$entityField.find(".tau-userStorySelector__control"),intervalID=null,position={of:$entitySelectorControl,my:"left top",at:"left bottom",collision:"flip flip",offset:"0 2"};$entitySelector.on("click keydown focus",function(e){var keyCode=$.ui.keyCode;if(!$(this).hasClass("focus")&&e.type=="focus"||e.type=="click"||e.type=="keydown"&&(e.keyCode==keyCode.DOWN||e.keyCode==keyCode.UP)){$entitySelector.hide();var entityList=$entitySelectorControl.show(),list=entityList.find(".tau-finder__result_user-stories");list.outerWidth(entityList.outerWidth()),entityList.find(".tau-finder__table_quick-add").on("menuentityrefresh",function(){entityList.find(".tau-finder__result_user-stories").position().top<0&&entityList.is(":visible")&&(position={of:$entitySelectorControl,my:"left bottom",at:"left top",collision:"flip flip",offset:"0 0"}),entityList.find(".tau-finder__result_user-stories").position(position)}),entityList.find(".tau-finder__result_user-stories").position(position),entityList.find("input").focus()}}),$entitySelector.focusout(function(){$(this).removeClass("focus")}),$entitySelectorControl.focusout(function(){clearTimeout(intervalID),intervalID=setTimeout(function(){$entitySelectorControl.hide(),$entitySelector.show()},0)}),$entitySelectorControl.keydown(function(event){event.keyCode==$.ui.keyCode.ESCAPE&&($entitySelectorControl.hide(),$entitySelector.show().addClass("focus").focus(),event.stopImmediatePropagation())}),$entitySelectorControl.focusin(function(){clearTimeout(intervalID)}),this.on("entityFinder.entitySelected",function(evt,data){var entity=data.entity;$element.data("value",data.entity),$element.val(entity.id).change();var $entityTypeIcon=$entitySelector.find(".tau-linkentity__icon"),classes=$entityTypeIcon.attr("class").replace(/ui-type-icon-\S+/ig,"ui-type-icon-"+entity.entityType.name.toLowerCase());$entityTypeIcon.attr("class",classes),$entityTypeIcon.text(entity.id).show(),$entitySelector.find(".tau-linkentity__inner").text(entity.name).removeClass("tau-linkentity__inner_placeholder"),$entitySelectorControl.hide(),$entitySelector.show().addClass("focus").focus()})}})})