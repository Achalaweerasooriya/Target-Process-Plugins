define(["Underscore","jQuery","tau/core/class","tau/ui/extensions/board.plus/layout/size.calculator-board"],function(t,e,i,n){var s=i.extend({init:function(t){this.sizeCalculator=t||n},setConfig:function(e){this.config=e,t.defaults(this.config,{useFixedColumnSizes:!1,columnSizes:{}}),this.setSizes(e.sizes)},isColumnCollapsed:function(t){return this.cols[t].isCollapsed},setFixedColumnSize:function(e){var i=this;t.extend(this.config.columnSizes,e),t(e).chain().keys().each(function(t){var e=i.cols[t];e.extraWidth=0})},getFixedColumnSize:function(t){return!this.config.useFixedColumnSizes||this.isColumnCollapsed(t)?null:this.config.columnSizes[t]||null},resolveColumnSize:function(t){var e=this.getFixedColumnSize(t);if(!e){var i=this.cols[t],n=i.items[0].$el,s=this.getItemZoomLevelOrDefault(i.isCollapsed),r=this.getSizeInfo(s).width;e=n.width()/r}return Math.floor(e)},setSizes:function(e){t.forEach(e,function(e){t.defaults(e,{cardsInRowMin:0,cardsInRowMax:99999,clientColsMin:99999,clientRowsMin:99999})}),this.config.sizes=e},getSizeInfo:function(t){return this.config.sizes[t]},setCurrentZoomLevel:function(t){return t=t||this.currentZoom||1,t in this.config.sizes||(t=5),this.currentZoom=t,this.currentZoom},getCurrentZoomLevel:function(){return this.currentZoom||1},getColumnsCount:function(){return t.keys(this.cols).length},getItemZoomLevelOrDefault:function(t){return t?"collapsed":this.getCurrentZoomLevel()},setElement:function(t){this.$el=t,this.$grid=t.find(".i-role-grid"),this.cells=[],this.rows={},this.cols={},this.headerCells=[];var e=0;this.padding=2*this.config.padding||14,this.scrollWidth=e+this.padding,this.cellBorderWidth=0,this.initializeGridModel()},refreshElement:function(){this.setElement(this.$el)},initializeGridModel:function(){var i=this.$grid.find(".i-role-cell"),n=this;i.each(function(){var t=e(this),i=t.parent();if("none"!==i.css("display")){var s=i.hasClass("tau-collapsed_x"),r=i.hasClass("tau-collapsed_y"),o=t.data(),a={$el:t,cardsNum:t.find(".i-role-card").length,isCollapsed:s,data:o,width:null,height:null,isHidden:!1},l=n.cols[o.x];n.cols[o.x]=l?l:{x:o.x,items:[],_sizes:[],cardsNum:0,extraWidth:0,isCollapsed:s};var h=n.rows[o.y];n.rows[o.y]=h?h:{y:o.y,items:[],height:null,_sizes:[],cardsNum:0,isCollapsed:r},n.cols[o.x].cardsNum+=a.cardsNum,n.cols[o.x].items.push(a),n.rows[o.y].cardsNum+=a.cardsNum,n.rows[o.y].items.push(a),n.cells.push(a)}}),n.headerCells=n.sizeCalculator.initializeHeaderCells({$element:n.$el,model:t.pick(n,"cols","rows")})},updateSize:function(){this.calculateOptimalSize(),this.justifyWidth(),this.justifyHeight(),this.justifyHeightByHeader(),this.updateCells(),this.updateHeaders()},calculateOptimalSize:function(){var e=this,i=e.getCurrentZoomLevel(),n=this.$grid[0].clientWidth||this.$grid.width(),s=this.$grid[0].clientHeight||this.$grid.height(),r=e.getSizeInfo(i),o=r.width,a=r.height,l=this.scrollWidth,h=this.cellBorderWidth,c=t.values(this.rows).length||1,u=t.values(this.cols).length||1,d=n/Math.min(r.clientColsMin,u)-l,f=Math.floor((d-l-h)/o)||1,g=s/Math.min(r.clientRowsMin,c),m=Math.floor(g/a),C=3,v=this.cells;t.each(v,function(t){var i=e.getSizeInfo(e.getItemZoomLevelOrDefault(t.isCollapsed)),n=e.getCellResizeInfo(t,C,f,m,i);t.height=n.height,t.cardsInCol=n.cardsInCol,t.cardsInRow=n.cardsInRow}),t.each(e.rows,function(e){e.height=t.max(e.items,function(t){return t.height}).height,e.cardsInCol=t(e.items).chain().pluck("cardsInCol").max().value()}),t.each(e.cols,function(e){e.extraWidth=0,e.cardsInRow=t(e.items).chain().pluck("cardsInRow").max().value()}),t.each(v,function(t){t.cardsInRow=e.cols[t.data.x].cardsInRow,t.height=e.rows[t.data.y].height,t.cardsInCol=e.rows[t.data.y].cardsInCol})},beforeRowsHeightRecalculation:function(){},afterRowsHeightRecalculation:function(){},getCellResizeInfo:function(e,i,n,s,r){var o=e.cardsNum,a=r.width,l=r.height,h=a*l,c=o||1,u=Math.sqrt(c*h/i),d=null,f=this.getFixedColumnSize(e.data.x);f?d=f:6!==this.getCurrentZoomLevel()||this.isColumnCollapsed(e.data.x)?(d=t.min([Math.ceil(u/a),n,r.cardsInRowMax]),d=t.max([d,r.cardsInRowMin])):d=1;var g=Math.ceil(c/d);return{height:g*l,cardsInCol:g,cardsInRow:d}},getActualTableWidth:function(){var e=this;return 1+t.reduce(e.cols,t.bind(function(t,e){var i=this,n=i.calculateColumnWidth(e);return t+n+1},e),0)},getTargetColumns:function(e){var i=this,n=t.filter(e,function(t){return!i.getFixedColumnSize(t.x)}),s=t.filter(n,function(t){return!t.isCollapsed});return s.length?s:n},getZoomLevelCardWidth:function(e,i){var n=t.some(i,function(t){return!t.isCollapsed}),s=n?e:"collapsed",r=this.getSizeInfo(s);return r.width},justifyWidth:function(){var e=this,i=e.getCurrentZoomLevel();if(0!=t.values(this.rows).length){var n=this.$grid[0].clientWidth||this.$grid.width(),s=e.getActualTableWidth(),r=n-s;if(!(0>=r)){var o=e.getTargetColumns(e.cols);if(0!==o.length){var a=e.getZoomLevelCardWidth(i,o),l=Math.floor(r/a);if(l>0){var h=e.distributionByCardsCount(o),c=e.translateKoefsToAbsoluteIncrementors(o,h,l);o=e.distributeCardsIncrementation(o,c)}var u=n-e.getActualTableWidth();e.distributeExtraWidthToColumns(o,u)}}}},distributeCardsIncrementation:function(e,i){return t.each(e,function(e,n){var s=i[n];t.each(e.items,function(t){var i=t.cardsInRow+s;t.cardsInRow=i,e.cardsInRow=i})}),e},translateKoefsToAbsoluteIncrementors:function(e,i,n){var s=this,r=[],o=n;for(t(e.length).times(function(t){r[t]=0});o>0;){i=s._normalize(i);var a=o;t.each(i,function(t,e){var i=Math.min(o,Math.round(a*t));r[e]+=i,o-=i}),i.pop()}return r},distributionByCardsCount:function(e){var i=t.reduce(e,function(t,e){return t+e.cardsNum},0);i=i||1;var n=!0,s=t.map(e,function(e){var s=e.cardsNum>0?t(e.items).chain().pluck("cardsNum").max().value()/i:0;return 0!=s&&(n=!1),s});if(n){var r=1/s.length;s=t.map(s,function(){return r})}return s},distributeExtraWidthToColumns:function(e,i){var n=this;if(i>0){var s=e.length||1,r=n._distribute(i,s,Math.floor);t.each(e,function(t,e){t.extraWidth=r[e]})}return e},justifyHeight:function(){var e=this.getCurrentZoomLevel(),i=this.getSizeInfo(e),n=i.height,s=this;t.forEach(this.rows,function(t){t._sizes=[]}),t.forEach(this.cells,function(t){var e=t.cardsInCol,i=Math.ceil(t.cardsNum/t.cardsInRow)||1;if(e>=i){var r=n*i;t.cardsInCol=i,t.height=r}s.rows[t.data.y]._sizes.push(t.height)}),t.forEach(this.rows,function(t){t.height=Math.max.apply(null,t._sizes)}),t.forEach(this.cells,function(t){t.height=s.rows[t.data.y].height})},justifyHeightByHeader:function(){var e=this;t.forEach(this.rows,function(i,n){i.minHeight=null;var s=t.find(e.headerCells,function(t){return t.data.y==n});s&&!s.isCollapsed&&(i.minHeight=s.$el.children().height())}),t.forEach(this.cells,function(t){t.minHeight=e.rows[t.data.y].minHeight})},updateCells:function(){t.each(this.cells,this.iteratorUpdateCell.bind(this))},iteratorUpdateCell:function(t){var e=t.$el,i=this.calculateCellWidth(t);e.css("width",i),t.minHeight&&e.css("min-height",t.minHeight)},calculateCellWidth:function(t){return this.calculateColumnWidth(this.cols[t.data.x])},calculateColumnWidth:function(t){var e=t.cardsInRow,i=t.extraWidth,n=this.scrollWidth,s=this._getCardWidthByColumn(t);return e*s+i+n},_getCardWidthByColumn:function(t){var e=this.getItemZoomLevelOrDefault(t.isCollapsed);return this.getSizeInfo(e).width},updateHeaders:function(){var e=this,i=e.sizeCalculator,n=function(i,n){var s=null===n?"null":n;return t.find(e.headerCells,function(t){return t.data[i]==s})};this.beforeRowsHeightRecalculation(),t.each(e.rows,function(t){var e=i.calculateHeight({row:t}),s=n("y",t.y);i.applyHeight(e,{headerCell:s,row:t})}),this.afterRowsHeightRecalculation(),t.each(e.cols,function(t){var s=i.calculateWidth({col:t,ctx:{getCardWidth:e._getCardWidthByColumn.bind(e)},zoomLevel:e.getCurrentZoomLevel()}),r=n("x",t.x);i.applyWidth(s,{headerCell:r,col:t})})},_distribute:function(t,e,i){var n=[],s=t;i=i||Math.round;for(var r=i(t/e),o=0;e>o;o++)n[o]=s?r:0,s-=r;return n[n.length-1]+=s,n},_normalize:function(e){var i=1/t.reduce(e,function(t,e){return t+e},0);return t.map(e,function(t){return t*i})}});return s});