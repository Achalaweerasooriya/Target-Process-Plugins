define(["Underscore","jQuery","tau/core/class","tau/ui/extensions/board.plus/layout/size.calculator-board","tau/ui/extensions/board.plus/layout/cards.incrementation.calculator"],function(t,i,e,s,n){var l=e.extend({init:function(t){this.sizeCalculator=t||s},setConfig:function(i){this.config=i,t.defaults(this.config,{useFixedColumnSizes:!1,columnSizes:{}}),this.setSizes(i.sizes)},isColumnCollapsed:function(t){return this.cols[t].isCollapsed},setFixedColumnSize:function(i){t.extend(this.config.columnSizes,i),t.each(i,function(t,i){this.cols[i].extraWidth=0},this)},getFixedColumnSize:function(t){return!this.config.useFixedColumnSizes||this.isColumnCollapsed(t)?null:this.config.columnSizes[t]||null},resolveColumnSize:function(t){var i=this.getFixedColumnSize(t);if(!i){var e=this.cols[t],s=e.items[0].$el,n=this.getItemZoomLevelOrDefault(e.isCollapsed),l=this.getSizeInfo(n).width;i=s.width()/l}return Math.floor(i)},setSizes:function(i){t.forEach(i,function(i){t.defaults(i,{cardsInRowMin:0,cardsInRowMax:99999,clientColsMin:99999,clientRowsMin:99999})}),this.config.sizes=i},getSizeInfo:function(t){return this.config.sizes[t]},setCurrentZoomLevel:function(t){return t=t||this.currentZoom||1,t in this.config.sizes||(t=5),this.currentZoom=t,this.currentZoom},getCurrentZoomLevel:function(){return this.currentZoom||1},getColumnsCount:function(){return t.keys(this.cols).length},getItemZoomLevelOrDefault:function(t){return t?"collapsed":this.getCurrentZoomLevel()},setElement:function(t){this.$el=t,this.$grid=t.find(".i-role-grid"),this.cells=[],this.rows={},this.cols={},this.headerCells=[];var i=0;this.padding=2*this.config.padding||14,this.scrollWidth=i+this.padding,this.cellBorderWidth=0,this.initializeGridModel()},refreshElement:function(){this.setElement(this.$el)},initializeGridModel:function(){var e=this.$grid.find(".i-role-cell");t.each(e,function(t){var e=i(t),s=e.parent();if("none"!==s.css("display")){var n=s.hasClass("tau-collapsed_x"),l=s.hasClass("tau-collapsed_y"),o=e.data(),a=o.x,h=o.y,r={$el:e,cardsNum:e.find(".i-role-card").length,isCollapsed:n,data:o,width:null,height:null,isHidden:!1};
this.cols[a]=this.cols[a]||{x:a,items:[],_sizes:[],cardsNum:0,extraWidth:0,isCollapsed:n},this.rows[h]=this.rows[h]||{y:h,items:[],height:null,_sizes:[],cardsNum:0,isCollapsed:l},this.cols[a].cardsNum+=r.cardsNum,this.cols[a].items.push(r),this.rows[h].cardsNum+=r.cardsNum,this.rows[h].items.push(r),this.cells.push(r)}},this),this.headerCells=this.sizeCalculator.initializeHeaderCells({$element:this.$el,model:t.pick(this,"cols","rows")})},updateSize:function(){this.calculateOptimalSize(),this.justifyWidth(),this.justifyHeight(),this.justifyHeightByHeader(),this.updateCells(),this.updateHeaders()},calculateOptimalSize:function(){var i=this,e=i.getCurrentZoomLevel(),s=this.$grid[0].clientWidth||this.$grid.width(),n=this.$grid[0].clientHeight||this.$grid.height(),l=i.getSizeInfo(e),o=l.width,a=l.height,h=this.scrollWidth,r=this.cellBorderWidth,c=t.values(this.rows).length||1,u=t.values(this.cols).length||1,d=s/Math.min(l.clientColsMin,u)-h,f=Math.floor((d-h-r)/o)||1,g=n/Math.min(l.clientRowsMin,c),m=Math.floor(g/a),C=3;t.each(this.cells,function(t){var e=i.getSizeInfo(i.getItemZoomLevelOrDefault(t.isCollapsed)),s=i.getCellResizeInfo(t,C,f,m,e);t.height=s.height,t.cardsInCol=s.cardsInCol,t.cardsInRow=s.cardsInRow}),t.each(this.rows,function(i){i.height=t.max(i.items,function(t){return t.height}).height,i.cardsInCol=t(i.items).chain().pluck("cardsInCol").max().value()}),t.each(this.cols,function(i){i.extraWidth=0,i.cardsInRow=t(i.items).chain().pluck("cardsInRow").max().value()}),t.each(this.cells,function(t){t.cardsInRow=i.cols[t.data.x].cardsInRow,t.height=i.rows[t.data.y].height,t.cardsInCol=i.rows[t.data.y].cardsInCol})},beforeRowsHeightRecalculation:function(){},afterRowsHeightRecalculation:function(){},getCellResizeInfo:function(i,e,s,n,l){var o=i.cardsNum,a=l.width,h=l.height,r=a*h,c=o||1,u=Math.sqrt(c*r/e),d=null,f=this.getFixedColumnSize(i.data.x);f?d=f:6!==this.getCurrentZoomLevel()||this.isColumnCollapsed(i.data.x)?(d=t.min([Math.ceil(u/a),s,l.cardsInRowMax]),d=t.max([d,l.cardsInRowMin])):d=1;
var g=Math.ceil(c/d);return{height:g*h,cardsInCol:g,cardsInRow:d}},getActualTableWidth:function(){return t.reduce(this.cols,function(t,i){return t+this.calculateColumnWidth(i)+1},1,this)},getTargetColumns:function(i){var e=this,s=t.filter(i,function(t){return!e.getFixedColumnSize(t.x)}),n=t.filter(s,function(t){return!t.isCollapsed});return n.length?n:s},getZoomLevelCardWidth:function(i,e){var s=t.some(e,function(t){return!t.isCollapsed}),n=s?i:"collapsed",l=this.getSizeInfo(n);return l.width},justifyWidth:function(){if(0!==t.keys(this.rows).length){var i=this.$grid[0].clientWidth||this.$grid.width(),e=i-this.getActualTableWidth();if(!(0>=e)){var s=this.getTargetColumns(this.cols);if(0!==s.length){var l=this.getCurrentZoomLevel(),o=this.getZoomLevelCardWidth(l,s),a=Math.floor(e/o);if(a>0){var h=n.calculate(s,a);this.distributeCardsIncrementation(s,h),e=i-this.getActualTableWidth()}this.distributeExtraWidthToColumns(s,e)}}}},distributeCardsIncrementation:function(i,e){t.each(i,function(i,s){var n=e[s];t.each(i.items,function(t){var e=t.cardsInRow+n;t.cardsInRow=e,i.cardsInRow=e})})},distributeExtraWidthToColumns:function(i,e){if(e>0){var s=i.length||1,n=this._distribute(e,s,Math.floor);t.each(i,function(t,i){t.extraWidth=n[i]})}return i},justifyHeight:function(){var i=this.getCurrentZoomLevel(),e=this.getSizeInfo(i),s=e.height,n=this;t.forEach(this.rows,function(t){t._sizes=[]}),t.forEach(this.cells,function(t){var i=t.cardsInCol,e=Math.ceil(t.cardsNum/t.cardsInRow)||1;if(i>=e){var l=s*e;t.cardsInCol=e,t.height=l}n.rows[t.data.y]._sizes.push(t.height)}),t.forEach(this.rows,function(t){t.height=Math.max.apply(null,t._sizes)}),t.forEach(this.cells,function(t){t.height=n.rows[t.data.y].height})},justifyHeightByHeader:function(){t.forEach(this.rows,function(i,e){i.minHeight=null;var s=t.find(this.headerCells,function(t){return t.data.y==e});s&&!s.isCollapsed&&(i.minHeight=s.$el.children().height())},this),t.forEach(this.cells,function(t){t.minHeight=this.rows[t.data.y].minHeight
},this)},updateCells:function(){t.each(this.cells,this.iteratorUpdateCell,this)},iteratorUpdateCell:function(t){var i=t.$el,e=this.calculateCellWidth(t),s={width:e};t.minHeight&&(s["min-height"]=t.minHeight),i.css(s)},calculateCellWidth:function(t){return this.calculateColumnWidth(this.cols[t.data.x])},calculateColumnWidth:function(t){var i=t.items[0].$el;if(i.is(":hidden"))return 0;var e=this._getCardWidthByColumn(t);return e*t.cardsInRow+t.extraWidth+this.scrollWidth},_getCardWidthByColumn:function(t){var i=this.getItemZoomLevelOrDefault(t.isCollapsed);return this.getSizeInfo(i).width},updateHeaders:function(){var i=this,e=i.sizeCalculator,s=function(e,s){var n=null===s?"null":s;return t.find(i.headerCells,function(t){return t.data[e]==n})};this.beforeRowsHeightRecalculation(),t.each(i.rows,function(t){var i=e.calculateHeight({row:t}),n=s("y",t.y);e.applyHeight(i,{headerCell:n,row:t})}),this.afterRowsHeightRecalculation(),t.each(i.cols,function(t){var n=e.calculateWidth({col:t,getCardWidth:i._getCardWidthByColumn.bind(i),zoomLevel:i.getCurrentZoomLevel()}),l=s("x",t.x);e.applyWidth(n,{headerCell:l,col:t})})},_distribute:function(t,i,e){var s=[],n=t;e=e||Math.round;for(var l=e(t/i),o=0;i>o;o++)s[o]=n?l:0,n-=l;return s[s.length-1]+=n,s}});return l});