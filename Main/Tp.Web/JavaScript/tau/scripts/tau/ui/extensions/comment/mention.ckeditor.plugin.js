define(["require","tau/core/class","jQuery","Underscore","tau/utils/utils.convertUserName"],function(e){var t=e("tau/core/class"),n=e("jQuery"),o=e("Underscore"),i=e("tau/utils/utils.convertUserName"),r=t.extend({init:function(e){this.currentAutoComplete=null;var t=e.editor;this.editor=t,this.configurator=e.configurator,this._registerFeature(t),t.on("contentDom",function(){var i=t.editable();if(e.mentionUser){var r=this._createMention(e.mentionUser);t.setData(r.getOuterHtml(),function(){t.focus();var e=t.widgets.instances[0].element.$.parentNode,n=t.createRange(),o=new CKEDITOR.dom.element(e);n.moveToElementEditablePosition(o,e.textContent.length),n.select()})}n(i.$).on("keydown",function(e){this._navigate(e.which,e)}.bind(this)),t.on("change",function(){var e=this._getCurrentWord()||"";e=e.replace(/\u200b/,""),e.length>1&&0===o.trim(e).indexOf("@")?this._getPeople(o.trim(e)):""!==e&&this._destroyAutocomplete()}.bind(this))}.bind(this)),t.on("destroy",function(){this._destroyAutocomplete()}.bind(this)),t.on("key",function(e){13==e.data.keyCode&&this.autoCompleteIsVisible()&&e.cancel()}.bind(this)),t.on("blur",function(){this._destroyAutocomplete()}.bind(this))},_registerFeature:function(e){var t={span:{attributes:"data-mention"}};e.addFeature({name:"mention",allowedContent:t}),e.widgets.add("mention",{allowedContent:t,draggable:!1,inline:!0,template:'<span data-metion="">Name user</span>',upcast:function(e){return"span"==e.name&&e.attributes["data-mention"]}})},autoCompleteIsVisible:function(){return this.currentAutoComplete&&this.currentAutoComplete.tauUserAutocomplete("widget").is(":visible")},_getCurrentWord:function(){var e=this.editor.getSelection().getRanges()[0],t=e.startContainer;if(t.type==CKEDITOR.NODE_TEXT&&e.startOffset){var n=t.getText().lastIndexOf(" ",e.startOffset)+1,o=t.getText().indexOf(" ",e.startOffset);return-1==n&&(n=0),-1==o&&(o=t.getText().length),t.getText().substring(n,o)}return null},_destroyAutocomplete:function(){this.currentAutoComplete&&(this.currentAutoComplete.tauUserAutocomplete("destroy"),this.currentAutoComplete=null)
},_createMention:function(e){var t=i.getFullName(e),n=this.editor.document.createElement("span");return n.appendText(t),n.setAttribute("data-mention",e.email),n},_getPeople:function(e){var t=this,o=t.editor,i=o.getSelection().getRanges()[0],r=parseInt(i.startOffset-e.length,10)||0,a=i.startContainer.$,s=this.configurator;n(a.parentNode).tauUserAutocomplete({appendTo:n(this.editor.element.$.parentElement),minLength:0,store2:s.getStore2(),open:function(){s.getKeyBoardManager().pushHandler({})},close:function(){s.getKeyBoardManager().popHandler()},select:function(e,t){var n=this;n._destroyAutocomplete();var i=t.item;a.textContent=a.textContent.substr(0,r);var s=this._createMention(i);a.nextSibling?a.parentNode.insertBefore(s.$,a.nextSibling):a.parentNode.appendChild(s.$),o.widgets.initOn(s,"mention"),o.focus();var u=o.createRange(),l=new CKEDITOR.dom.element(s.$.parentNode);u.moveToElementEditablePosition(l,s.$.parentNode.textContent.length),u.select()}.bind(this)}),this.currentAutoComplete=n(a.parentNode),this.currentAutoComplete.tauUserAutocomplete("search",e.replace("@",""))},_navigate:function(e,t){var i=[n.ui.keyCode.ENTER,n.ui.keyCode.LEFT,n.ui.keyCode.RIGHT,n.ui.keyCode.DOWN,n.ui.keyCode.UP,n.ui.keyCode.HOME,n.ui.keyCode.END];(n.ui.keyCode.ESCAPE===e||n.ui.keyCode.DELETE===e)&&this._destroyAutocomplete(),o.contains(i,e)&&this.currentAutoComplete&&this.currentAutoComplete.tauUserAutocomplete("widget").trigger(n.Event("keydown",t))}});return{getMentionPlugin:function(e){return function(t){return new r({configurator:e.configurator,mentionUser:e.mentionUser,editor:t})}}}});