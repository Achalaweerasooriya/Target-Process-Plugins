define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/ui/behaviour/common/ui.behaviour.tauBubble","tau/utils/utils.textConverter"],function(_,$,a,b,c){return a.extend({name:"extension.list.prioritize.comment","bus afterRender":function(a){this.$root=a.data.element,this.$el=a.data.element.find("[role=comment-form]")},"bus prioritize.updateGroupsCommentRequirements":function(a){var b=a.data.groups,c=this.$root.find("[role=group]");c.data("isCommentRequired",!1),_.forEach(b,function(a,b){c.eq(b).data("isCommentRequired",a.isCommentRequired)})},"bus prioritize.checkAvailability":function(a){var b=a.data.$targetGroup,c=a.data.$prevGroup;if(!b.data("isCommentRequired")||b[0]===c[0]){this.fire("prioritize.isAvailable.comment");return}var d=a.data.$item;this.$item=d;var e=a.data.item;this.item=e;var f=this.$el;f.removeClass("updating");var g=a.data.isCollapsed,h=!1;g==0?h=d.find("[role=sortable-handler]"):h=b.find("[role=title]"),d.tauBubble({showOnCreation:!0,alignTo:h}),f.detach(),d.tauBubble("widget").find("[role=content]").append(f),f.show(),d.tauBubble("show");var i=f.find("textarea");i.val("").focus();var j=f.find(":button"),k=j.eq(0);k.bind("click",_.bind(this._save,this));var l=j.eq(1);l.bind("click",_.bind(this._cancel,this)),d.bind("externalClose",_.bind(this._cancel,this));var m=function(){window.setTimeout(function(){var a=i.val()||"",b=a.trim().length===0;b?k.attr("disabled","disabled"):k.attr("disabled")&&k.removeAttr("disabled"),b?k.addClass("disable"):k.removeClass("disable")},50)};m(),k.bind("focus",m),i.bind("change keyup click propertychange paste",m)},_save:function(a){a.stopPropagation();var b=this,d=this.$el,e=new c,f=e.convert(d.find("textarea").val(),!0),g=b.config.store,h=b.item;d.addClass("updating"),g.save("comment",{$set:{description:f,general:{id:h.id}},$include:["id","description","createDate","parentId",{owner:["id","firstName","lastName"]}]}).done({success:function(){d.removeClass("updating"),b.fire("prioritize.isAvailable.comment"),b.$item.tauBubble("destroy")},failure:function(){b.fire("prioritize.isNotAvailable")}})},_cancel:function(){var a=this;this.$el.addClass("updating");var b=function(){a.fire("prioritize.isNotAvailable",{$item:a.$item}),a.$item.tauBubble("destroy")};$.fx.off===!0?b():setTimeout(b,50)}})})