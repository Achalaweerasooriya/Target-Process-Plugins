define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/utils/utils.textConverter"],function(e,t,i,a){return i.extend({name:"extension.list.prioritize.comment","bus afterRender":function(e){this.$root=e.data.element,this.$el=e.data.element.find("[role=comment-form]")},"bus prioritize.updateGroupsCommentRequirements":function(t){var i=t.data.groups,a=this.$root.find("[role=group]");a.data("isCommentRequired",!1),e.forEach(i,function(e,t){a.eq(t).data("isCommentRequired",e.isCommentRequired)})},"bus prioritize.checkAvailability":function(t){var i=t.data.$targetGroup,a=t.data.$prevGroup;if(!i.data("isCommentRequired")||i[0]===a[0])return void this.fire("prioritize.isAvailable.comment");var n=t.data.$item;this.$item=n,this.item=t.data.item;var r=this.$el;r.removeClass("updating");var o=t.data.isCollapsed,s=!1;s=0==o?n.find("[role=sortable-handler]"):i.find("[role=title]"),n.tauBubble({showOnCreation:!0,alignTo:s}),r.detach(),n.tauBubble("widget").find("[role=content]").append(r),r.show(),n.tauBubble("show");var d=r.find("textarea");d.val("").focus();var l=r.find(":button"),u=l.eq(0);u.bind("click",e.bind(this._save,this));var c=l.eq(1);c.bind("click",e.bind(this._cancel,this)),n.bind("externalClose",e.bind(this._cancel,this));var m=function(){window.setTimeout(function(){var t=d.val()||"",i=0===e.trim(t).length;i?u.attr("disabled","disabled"):u.attr("disabled")&&u.removeAttr("disabled"),i?u.addClass("disable"):u.removeClass("disable")},50)};m(),u.bind("focus",m),d.bind("change keyup click propertychange paste",m)},_save:function(e){e.stopPropagation();var t=this,i=this.$el,n=new a,r=n.convert(i.find("textarea").val(),!0),o=t.config.store,s=t.item;i.addClass("updating"),o.save("comment",{$set:{description:r,general:{id:s.id}},$include:["id","description","createDate","parentId",{owner:["id","firstName","lastName"]}]}).done({success:function(){i.removeClass("updating"),t.fire("prioritize.isAvailable.comment"),t.$item.tauBubble("destroy")},failure:function(){t.fire("prioritize.isNotAvailable")
}})},_cancel:function(){var e=this;this.$el.addClass("updating");var i=function(){e.fire("prioritize.isNotAvailable",{$item:e.$item}),e.$item.data("ui-tauBubble")&&e.$item.tauBubble("destroy")};t.fx.off===!0?i():setTimeout(i,50)}})});