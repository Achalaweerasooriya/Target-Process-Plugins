define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/utils/utils.textConverter"],function(_,$,ExtensionBase,TextConverter){return ExtensionBase.extend({name:"extension.list.prioritize.comment","bus afterRender":function(e){this.$root=e.data.element,this.$el=e.data.element.find("[role=comment-form]")},"bus prioritize.updateGroupsCommentRequirements":function(e){var groupsData=e.data.groups,$groups=this.$root.find("[role=group]");$groups.data("isCommentRequired",!1),_.forEach(groupsData,function(item,i){$groups.eq(i).data("isCommentRequired",item.isCommentRequired)})},"bus prioritize.checkAvailability":function(evt){var $targetGroup=evt.data.$targetGroup,$prevGroup=evt.data.$prevGroup;if(!$targetGroup.data("isCommentRequired")||$targetGroup[0]===$prevGroup[0]){this.fire("prioritize.isAvailable.comment");return}var $item=evt.data.$item;this.$item=$item;var item=evt.data.item;this.item=item;var $form=this.$el;$form.removeClass("updating");var isCollapsed=evt.data.isCollapsed,$alignTo=!1;isCollapsed==0?$alignTo=$item.find("[role=sortable-handler]"):$alignTo=$targetGroup.find("[role=title]"),$item.tauBubble({showOnCreation:!0,alignTo:$alignTo}),$form.detach(),$item.tauBubble("widget").find("[role=content]").append($form),$form.show(),$item.tauBubble("show");var $input=$form.find("textarea");$input.val("").focus();var $buttons=$form.find(":button"),$save=$buttons.eq(0);$save.bind("click",_.bind(this._save,this));var $cancel=$buttons.eq(1);$cancel.bind("click",_.bind(this._cancel,this)),$item.bind("externalClose",_.bind(this._cancel,this));var inputHandler=function(){window.setTimeout(function(){var text=$input.val()||"",disableSave=_.trim(text).length===0;disableSave?$save.attr("disabled","disabled"):$save.attr("disabled")&&$save.removeAttr("disabled"),disableSave?$save.addClass("disable"):$save.removeClass("disable")},50)};inputHandler(),$save.bind("focus",inputHandler),$input.bind("change keyup click propertychange paste",inputHandler)},_save:function(evt){evt.stopPropagation();var self=this,$form=this.$el,textConverter=new TextConverter,text=textConverter.convert($form.find("textarea").val(),!0),store=self.config.store,entity=self.item;$form.addClass("updating"),store.save("comment",{$set:{description:text,general:{id:entity.id}},$include:["id","description","createDate","parentId",{owner:["id","firstName","lastName"]}]}).done({success:function(){$form.removeClass("updating"),self.fire("prioritize.isAvailable.comment"),self.$item.tauBubble("destroy")},failure:function(){self.fire("prioritize.isNotAvailable")}})},_cancel:function(){var self=this;this.$el.addClass("updating");var firePrioritizeIsNotAvailable=function(){self.fire("prioritize.isNotAvailable",{$item:self.$item}),self.$item.tauBubble("destroy")};$.fx.off===!0?firePrioritizeIsNotAvailable():setTimeout(firePrioritizeIsNotAvailable,50)}})})