define(["Underscore","tau/core/extension.base"],function(e,t){return t.extend({"bus configurator.ready + beforeInit":function(t,r,n){var a=n.config.routes;a.unshift({pattern:/error/,host:{name:"error_page",type:"page.error"},type:{type:"label",text:""}});var i=e.map(a,e.bind(function(e){return this.processRoute(e,r)},this));this.currentValue=!0,this.fire("routes.ready",i)},"bus configurator.ready + options.ready + routes.ready + afterRender":function(e,t,r,n){this.bindToRoutes(t,r,n),r.routing.executeOnStart&&t.getHashService().triggerHashChange(),this.fire("routes.bound",n)},"bus configurator.ready + destroy":function(e,t){this.currentValue=null,t.getHashService().removeAllListeners(this)},"bus application.exit":function(){this.currentValue=null},"bus routes.bound:last + configurator.ready:last+routing.forward":function(e,t,r,n){this._onHashChanged(r,t,n.url,n.args)},"bus routing.disable":function(){this.disabled=!0},"bus routing.enable":function(){this.disabled=!1},bindToRoutes:function(e,t,r){var n=t.applicationId,a=e.getHashService();a.on("changed",function(){if(!this.disabled){var t=n?a.getHashParam(n):a.getHash().split("&")[0];this._onHashChanged(e,r,t)}},this)},_onHashChanged:function(t,r,n,a){if(this.currentValue!==n){this.currentValue=n;var i=e.find(r,function(e){return e.pattern.test(n)});if(i){var s=i.pattern.exec(n).slice(1).concat(e.toArray(a));i.callback.apply(null,s),t.getRouting().setReferer(t.service("navigator").getCurrent())}else this.fire("error","URL is not found")}},processRoute:function(t,r){return{name:t.name,pattern:e.isString(t.pattern)?new RegExp(t.pattern):t.pattern,callback:this.createPatternCallback(t,r)}},createPatternCallback:function(t,r){var n=e.bind(function(n){n=n||{},r.getRouting().setCurrentRoute({route:t,args:n}),this.fire("application.navigate",{host:t.host,type:t.type,requestArgs:e.defaults(n,{handlers:{onPageLoaded:e.identity}})})},this),a=e.bind(this.fire,this);return function(){t.adapter?t.adapter.apply({fire:a,configurator:r,resolve:n},arguments):(t.host.request=e.toArray(arguments),t.type.request=e.toArray(arguments),n())
}}})});