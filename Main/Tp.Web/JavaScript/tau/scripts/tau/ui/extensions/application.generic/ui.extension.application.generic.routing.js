define(["Underscore","tau/core/extension.base"],function(e,t){return t.extend({"bus configurator.ready + beforeInit":function(t,r,n){var a=n.config.routes;a.unshift({pattern:/error/,host:{name:"error_page",type:"page.error"},type:{type:"label",text:""}});var i=e.map(a,e.bind(function(e){return this.processRoute(e,r)},this));this.currentValue=!0,this.fire("routes.ready",i)},"bus configurator.ready + options.ready + routes.ready + afterRender":function(e,t,r,n){this.bindToRoutes(t,r,n),r.routing.executeOnStart&&t.getHashService().triggerHashChange(),this.fire("routes.bound",n)},"bus configurator.ready + destroy":function(e,t){this.currentValue=null,t.getHashService().removeAllListeners(this)},"bus application.exit":function(){this.currentValue=null},"bus routes.bound:last + configurator.ready:last+routing.forward":function(e,t,r,n){this._onHashChanged(r,t,n.url,null,n.args)},"bus routing.disable":function(){this.disabled=!0},"bus routing.enable":function(){this.disabled=!1},bindToRoutes:function(e,t,r){var n=t.applicationId,a=e.getHashService();a.mine=!0,a.on("before_changed",function(t){if(!this.disabled){var i=n?a.getHashParam(n):a.getHash().split("&")[0];this._onHashChanged(e,r,i,t)}},this)},_onHashChanged:function(t,r,n,a,i){if(!this._isCurrentValueSame(n)){this.currentValue=n;var s=this._getMatchedRoute(n,r);if(s){var o=[a].concat(s.pattern.exec(n).slice(1)).concat(e.toArray(i));a&&a.suspendMain(),s.callback.apply(null,o),t.getRouting().setReferer(t.service("navigator").getCurrent())}else this.fire("error","URL is not found")}},_isCurrentValueSame:function(e){return this.currentValue===e},_getMatchedRoute:function(t,r){var n=e.find(r,function(e){return e.pattern.test(t)});return n},processRoute:function(t,r){return{name:t.name,pattern:e.isString(t.pattern)?new RegExp(t.pattern):t.pattern,callback:this.createPatternCallback(t,r)}},_resolveRoute:function(t,r,n,a){a=a||{},r.getRouting().setCurrentRoute({route:t,args:a}),this.fire("application.navigate",{host:t.host,type:t.type,requestArgs:e.defaults(a,{handlers:{onPageLoaded:e.identity}})}),n&&n.resumeMain()
},createPatternCallback:function(t,r){var n=this._resolveRoute.bind(this,t,r),a=this.fire.bind(this);return function(i){var s=e.rest(arguments);t.adapter?t.adapter.apply({fire:a,configurator:r,resolve:n.bind(null,i)},s):(t.host.request=e.toArray(s),t.type.request=e.toArray(s),n(i))}}})});