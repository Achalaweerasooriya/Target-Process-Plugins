define(["Underscore","tau/core/extension.base"],function(e,t){return t.extend({"bus configurator.ready + beforeInit":function(t,r,n){var i=n.config.routes;i.unshift({pattern:/error/,host:{name:"error_page",type:"page.error"},type:{type:"label",text:""}});var a=e.map(i,e.bind(function(e){return this.processRoute(e,r)},this));this.currentValue=!0,this.fire("routes.ready",a)},"bus configurator.ready + options.ready + routes.ready + afterRender":function(e,t,r,n){this.bindToRoutes(t,r,n),r.routing.executeOnStart&&t.getHashService().triggerChange(),this.fire("routes.bound",n)},"bus configurator.ready + destroy":function(e,t){this.currentValue=null,t.getHashService().removeAllListeners(this)},"bus application.exit":function(){this.currentValue=null},"bus routes.bound:last + configurator.ready:last+routing.forward":function(t,r,n,i){var a=i.url,s=i.args;if(this.currentValue!==a){this.currentValue=a;var u=e.find(r,function(e){return e.pattern.test(a)});if(u){var o=u.pattern.exec(a).slice(1);o=o.concat(e.toArray(s)),u.callback.apply(null,o),n.getRouting().setReferer(n.service("navigator").getCurrent())}else this.fire("error","URL is not found")}},"bus routing.disable":function(){this.disabled=!0},"bus routing.enable":function(){this.disabled=!1},bindToRoutes:function(t,r,n){var i=r.applicationId,a=t.getHashService(),s=e.bind(function(){if(!this.disabled){var r=i?a.getHashParam(i):a.getHash().split("&")[0];if(this.currentValue!==r){this.currentValue=r;var s=e.find(n,function(e){return e.pattern.test(r)});if(s){var u=s.pattern.exec(r).slice(1);s.callback.apply(null,u),t.getRouting().setReferer(t.service("navigator").getCurrent())}else this.fire("error",{message:"URL is not found"})}}},this);a.on("changed",e.bind(s,this),this)},processRoute:function(t,r){return{pattern:e.isString(t.pattern)?new RegExp(t.pattern):t.pattern,callback:this.createPatternCallback(t,r)}},createPatternCallback:function(t,r){var n=e.bind(function(r){this.fire("application.navigate",{host:t.host,type:t.type,requestArgs:e.defaults(r||{},{handlers:{onPageLoaded:e.identity}})})},this),i=e.bind(this.fire,this);return function(){t.adapter?t.adapter.apply({fire:i,configurator:r,resolve:n},arguments):(t.host.request=e.toArray(arguments),t.type.request=e.toArray(arguments),n())}}})});