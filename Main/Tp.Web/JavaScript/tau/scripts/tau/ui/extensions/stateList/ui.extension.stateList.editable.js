define(["Underscore","jQuery","tau/utils/utils.textsearch","tau/components/extensions/component.extension.base","tau/ui/behaviour/common/ui.behaviour.listSelectable"],function(_,$,a,b){var c=b.extend({"bus dataBind+afterRender":function(a){this.searchIndex=null;var b=this.config,c=this.element=a.afterRender.data.element,d=this.dataToBind=a.dataBind.data,e=0;_.forEach(d.states,function(a){a.items?e+=a.items.length:e++}),this.$list=c.find(".drop-down-list"),this.$options=this.$list.find(".drop-down-option"),this.$options.click($.proxy(this.onItemSelected,this)),b.hasOwnProperty("maxHeight")&&this.$list.css("max-height",b.maxHeight).css("overflow-y","auto");var f=$("<div class='drop-down-actions' />"),g=!1;if(d.hasOwnProperty("defaultValue")){g=!0;var h=this.config.defaultValueLabel||"default";$("<span class='action-link default'>"+h+"</span>").click($.proxy(this.defaultValue,this)).appendTo(f)}this.config.allowToReset=_.isUndefined(this.config.allowToReset)?!0:this.config.allowToReset;if(d.nullableValue&&this.config.allowToReset){g=!0;var i=this.config.clearValueLabel||"reset";$("<span class='action-link clear'>"+i+"</span>").click($.proxy(this.clearValue,this)).appendTo(f)}g&&f.insertBefore(this.$list);if(d.states.length===0&&d.completed){var j=b.emptyDataMessage||"None";this.$list.append("<span class='empty-message'>"+j+"</span>")}b.filter&&e>3&&(this.filterField=$("<input type='text' class='filter-field' />").keyup($.proxy(this._filterDelegate,this)),$("<div class='filter-field-wrapper'></div>").append(this.filterField).insertBefore(this.$list));if(b.expandable&&!d.completed){var k=b.mode||"short";if(k!=="full"){var l=$("<div class='drop-down-footer'></div>"),m=this.config.fullModeLabel||"more...";this.$mode=$("<div class='action-link more'>"+m+"</div>").click($.proxy(this._toggleMode,this)).appendTo(l),l.insertAfter(this.$list)}}this._resize(),this.bus.fire("listOptionsReady",{element:c}),this._createSelectable()},_createSelectable:function(){this.$list.listSelectable({items:".drop-down-option:visible",className:"drop-down-option_hover"}),this.$list.addClass("tau-dropdownlist_selectable_true")},_enableSelectable:function(){this.$list.hasClass("tau-dropdownlist_selectable_true")&&this.$list.listSelectable("enable")},_disableSelectable:function(){this.$list.hasClass("tau-dropdownlist_selectable_true")&&this.$list.listSelectable("disable")},"bus focus":function(a){this._enableSelectable()},"bus refresh":function(a){this._enableSelectable()},"bus blur":function(a){this._disableSelectable()},_resize:function(a){if(!this.element)return;var b=this.element,c=b.find(".drop-down-list");c.css("maxHeight",$(window).height()/2*.8),c.css("overflowY","auto"),c.css("overflowX","hidden")},"bus afterRender+popupResize":function(a){this._resize(a.popupResize.data)},"bus popupResize":function(a){this._resize(a.data)},_toggleMode:function(a){a.stopPropagation();var b=this.config.mode==="full"?"short":"full";this.fire("refresh",{mode:b})},clearValue:function(a){a.stopPropagation(),this._updateState(null)},defaultValue:function(a){a.stopPropagation(),this._updateState(this.dataToBind.defaultValue)},onItemSelected:function(a){var b=$(a.target).tmplItem().data;this._updateState(b.id)},_updateState:function(a){var b=!0;this.config.confirmation&&window.confirm&&(b=window.confirm(this.config.confirmation)),b&&this.fire("updateState",{id:a})},_resetList:function(){this.$options.show()},_noResults:function(a){var a='"'+a+'" not found';this.$noResults?this.$noResults.text(a):this.$noResults=$("<div class='not-found' />").text(a).insertBefore(this.$list),this.$noResults.show()},_clearNoResults:function(){this.$noResults&&this.$noResults.hide()},_filterDelegate:function(b){if(b.keyCode==jQuery.ui.keyCode.DOWN||b.keyCode==jQuery.ui.keyCode.UP||b.keyCode==jQuery.ui.keyCode.ENTER||b.keyCode==jQuery.ui.keyCode.ESCAPE)return;if(!this.searchIndex){var c=[];this.searchIndex=new a,this.$options.each(function(a,b){c.push({_id:a,data:$(b).text()}),$(this).data("text",$(b).text())}),this.searchIndex.load(c)}var d=this.filterField.val(),e=this.searchIndex.search(d);this.$options.hide();var f=this.$options;_.forEach(e,function(a){var b=f.eq(a._id),c=b.data("text")+"";c=c.substr(0,a.entry.from)+"<em>"+c.substr(a.entry.from,a.entry.len)+"</em>"+c.substr(a.entry.from+a.entry.len,c.length),b.html(c),b.show(),b.parent().show()}),f.filter(":hidden").parent().not(f.filter(":visible").parent()).hide(),d.length?e.length==0?this._noResults(d):this._clearNoResults():(this._clearNoResults(),this._resetList()),this.$list.listSelectable("reset")}});return c})