define(["Underscore","jQuery","tau/utils/utils.textsearch","tau/components/extensions/component.extension.base","tau/ui/behaviour/common/ui.behaviour.listSelectable"],function(_,$,TextSearch,ExtensionBase){var stateListEditable=ExtensionBase.extend({"bus dataBind+afterRender":function(evtArgs){this.searchIndex=null;var config=this.config,element=this.element=evtArgs.afterRender.data.element,dataToBind=this.dataToBind=evtArgs.dataBind.data,realStatesLength=0;_.forEach(dataToBind.states,function(state){state.items?realStatesLength+=state.items.length:realStatesLength++}),this.$list=element.find(".drop-down-list"),this.$options=this.$list.find(".i-role-option"),this.$list.on("click",".i-role-option",_.bind(this.onItemSelected,this)),config.hasOwnProperty("maxHeight")&&this.$list.css("max-height",config.maxHeight).css("overflow-y","auto");var $actions=$("<div class='drop-down-actions' role='actions' />"),hasActions=!1;if(dataToBind.hasOwnProperty("defaultValue")){hasActions=!0;var defaultValueLabel=this.config.defaultValueLabel||"default";$("<span class='action-link default'>"+defaultValueLabel+"</span>").click($.proxy(this.defaultValue,this)).appendTo($actions)}this.config.allowToReset=_.isUndefined(this.config.allowToReset)?!0:this.config.allowToReset;if(dataToBind.nullableValue&&this.config.allowToReset){hasActions=!0;var clearValueLabel=this.config.clearValueLabel||"reset";$("<span class='action-link clear' role='action-reset'>"+clearValueLabel+"</span>").click($.proxy(this.clearValue,this)).appendTo($actions)}hasActions&&$actions.insertBefore(this.$list);if(dataToBind.states.length===0&&dataToBind.completed){var emptyDataMessage=config.emptyDataMessage||"None";this.$list.append("<span class='empty-message'>"+emptyDataMessage+"</span>")}config.filter&&realStatesLength>3&&(this.filterField=$("<input type='text' class='filter-field' />").keyup($.proxy(this._filterDelegate,this)),$("<div class='filter-field-wrapper'></div>").append(this.filterField).insertBefore(this.$list));if(config.expandable&&!dataToBind.completed){var mode=config.mode||"short";if(mode!=="full"){var $footer=$("<div class='drop-down-footer'></div>"),modeText=this.config.fullModeLabel||"more...";this.$mode=$("<div class='action-link more'>"+modeText+"</div>").click($.proxy(this._toggleMode,this)).appendTo($footer),$footer.insertAfter(this.$list)}}this.bus.fire("listOptionsReady",{element:element}),this._createSelectable()},_createSelectable:function(){this.$list.listSelectable({items:".drop-down-option:visible",className:"drop-down-option_hover",keyboardManager:this.config.context.configurator.getKeyBoardManager()}),this.$list.addClass("tau-dropdownlist_selectable_true")},_enableSelectable:function(){this.$list.hasClass("tau-dropdownlist_selectable_true")&&this.$list.listSelectable("enable")},_disableSelectable:function(){this.$list.hasClass("tau-dropdownlist_selectable_true")&&this.$list.listSelectable("disable")},"bus listOptionsReady:last+focus":function(evt){this._enableSelectable()},"bus listOptionsReady:last+refresh":function(evt){this._enableSelectable()},"bus listOptionsReady:last+blur":function(evt){this._disableSelectable()},_toggleMode:function(evt){evt.stopPropagation();var newMode=this.config.mode==="full"?"short":"full";this.fire("refresh",{mode:newMode})},clearValue:function(evt){evt.stopPropagation(),this._updateState(null)},defaultValue:function(evt){evt.stopPropagation(),this._updateState(this.dataToBind.defaultValue)},onItemSelected:function(evtArgs){var data=$(evtArgs.currentTarget).data();this._updateState(data.id)},_updateState:function(value){var isConfirmed=!0;this.config.confirmation&&window.confirm&&(isConfirmed=window.confirm(this.config.confirmation)),isConfirmed&&this.fire("updateState",{id:value})},_resetList:function(){this.$options.show()},_noResults:function(text){var text='"'+text+'" not found';this.$noResults?this.$noResults.text(text):this.$noResults=$("<div class='not-found' />").text(text).insertBefore(this.$list),this.$noResults.show()},_clearNoResults:function(){this.$noResults&&this.$noResults.hide()},_filterDelegate:function(evt){if(evt.keyCode==jQuery.ui.keyCode.DOWN||evt.keyCode==jQuery.ui.keyCode.UP||evt.keyCode==jQuery.ui.keyCode.ENTER||evt.keyCode==jQuery.ui.keyCode.ESCAPE)return;if(!this.searchIndex){var data=[];this.searchIndex=new TextSearch,this.$options.each(function(key,item){data.push({_id:key,data:$(item).text()}),$(this).data("text",$(item).text())}),this.searchIndex.load(data)}var searchText=this.filterField.val(),result=this.searchIndex.search(searchText);this.$options.hide();var $options=this.$options;_.forEach(result,function(item){var $option=$options.eq(item._id),text=$option.data("text")+"";text=text.substr(0,item.entry.from)+"<em>"+text.substr(item.entry.from,item.entry.len)+"</em>"+text.substr(item.entry.from+item.entry.len,text.length);var $textOption=$option.find(".i-role-optiontext");$textOption.length?$textOption.html(text):$option.html(text),$option.show(),$option.parent().show()}),$options.filter(":hidden").parent().not($options.filter(":visible").parent()).hide(),searchText.length?result.length==0?this._noResults(searchText):this._clearNoResults():(this._clearNoResults(),this._resetList()),this.$list.listSelectable("reset")}});return stateListEditable})