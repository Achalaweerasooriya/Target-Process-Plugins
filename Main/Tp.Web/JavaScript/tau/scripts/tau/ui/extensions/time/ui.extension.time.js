define(["Underscore","jQuery","tau/core/extension.base"],function(e,t,i){return i.extend({init:function(e,t,i,n){return this.model=n,this.configurator=t,this.entity=i,this.culture=t.getSystemInfo().culture,this._super(e)},"bus beforeInit":function(){t.when(this.model.load()).then(e.bind(function(e){this.fire("dataBind",{spent:e.spent,remain:e.remain,culture:this.culture})},this))},"bus afterRender":function(i,n){var r=n.element,a=function(e){return Math.round(100*e)/100},o=r.find(":input"),u=o.filter(".i-role-spent"),s=o.filter(".i-role-remain"),f="^[0-9]*([\\"+this.culture.decimalSeparator+"][0-9]{0,2})?$";u.inputMaskEditor({mask:f}),s.inputMaskEditor({mask:f});var d=n.data.remain+n.data.spent,c="oninput"in u[0]?"input":"keyup";u.on(c,e.bind(function(){u.removeClass("tau-error");var t=e.parseFloatLocal(u.val(),this.culture)||0,i=(e.parseFloatLocal(d,this.culture)||0)-t;i=0>i?0:i,s.val(e.outFloatLocal(a(i),this.culture)||0)},this)),s.on(c,function(){d=s.val()}),r.on("keydown","input",e.bind(function(e){var i=e.charCode||e.keyCode||0;if(i==t.ui.keyCode.TAB||i==t.ui.keyCode.ENTER||i==t.ui.keyCode.ESCAPE||i==t.ui.keyCode.UP||i==t.ui.keyCode.DOWN){var n=t(e.currentTarget),r=n.parents(".tau-effort");switch(i){case t.ui.keyCode.ENTER:if(!this._validateInputValues(r))return!1;this._saveTimes(r),this.fire("time.editor.finished");break;case t.ui.keyCode.ESCAPE:this.fire("destroy");break;case t.ui.keyCode.TAB:case t.ui.keyCode.UP:case t.ui.keyCode.DOWN:return this._moveToNextInput(r,e.currentTarget),!1}}},this)),r.on("focusin focusout","input",e.bind(function(e){var i=t(e.currentTarget).parents(".tau-effort__group");i.toggleClass("tau-effort__group_state_edit","focusin"===e.type),"focusin"===e.type&&t(e.currentTarget).removeClass("tau-error")},this)),r.on("click",".i-role-edittrigger",e.bind(function(e){var i=t(e.currentTarget);i.parent().find(":text").focus(1)},this)),r.on("click","form",e.bind(function(e){e.stopPropagation()},this)),r.on("submit","form",e.bind(function(e){var i=t(e.currentTarget).find("input");
i.blur(),this.fire("time.editor.finished"),e.preventDefault()},this)),r.find(":text").first().focus(1)},_moveToNextInput:function(e,i){var n=e.find(":input"),r=t.inArray(i,n);if(-1!==r){var a=r===n.length-1?n[0]:n[r+1];a.focus()}},_getSpent:function(t){var i=t.find(":text.i-role-spent").val(),n=e.parseFloatLocal(i,this.culture);return e.isNaN(n)?0:n},_getRemain:function(t){var i=t.find(":text.i-role-remain").val(),n=e.parseFloatLocal(i,this.culture);return e.isNaN(n)?0:n},_setRemain:function(e,t){e.find(":text.i-role-remain").val(t)},_saveTimes:function(e){var i=this._getSpent(e),n=this._getRemain(e);this.fire("time.editor.saving"),t.when(this.model.saveTimes(i,n)).done(this.fire.bind(this,"time.editor.saved")).fail(this.fire.bind(this,"time.editor.saveFailed"))},_validateInputValues:function(e){return 0!==this._getSpent(e)?!0:(e.find(":text.i-role-spent").addClass("tau-error"),!1)}})});