define(["Underscore","jQuery"],function(_,$){return function(domWrapper,settings){var isActivatedMode=!1,activatedScope,lastScopeCoordinate,sharedState=null,$buttonPanel=settings.$buttonPanel;$buttonPanel.hide();var $button=$buttonPanel.find(".tau-btn"),predicateAddAction=function(d){return _.find(settings.items,function(itemData){var matchLocation=itemData.x==d.x&&itemData.y==d.y;if(matchLocation){var hasAddAction=_.find(itemData.fixed.items,function(item){return item.type==="AddAction"});if(hasAddAction)return!0}return!1})},createEventHandler=function(eventFlag,callback){return function(e){var $grid=$(e.delegateTarget),$cellHolder=$grid.find(".i-role-cellholder"),d=$cellHolder.data(),action=predicateAddAction(d);lastScopeCoordinate=eventFlag+"_"+d.x+"_"+d.y,!isActivatedMode&&action&&callback(e,{actionItems:action})}},onClickHandler=function(){if(sharedState){isActivatedMode=!0,activatedScope=lastScopeCoordinate;var o={data:sharedState,deactivate:function(){isActivatedMode=!1,activatedScope!==lastScopeCoordinate&&$buttonPanel.hide()}};settings.onActivate(o)}};$button.click(onClickHandler);var $targetGrid=domWrapper.getGrid().parent(".i-role-board-body"),showButtonPanel=function(e,obj){sharedState=obj,$buttonPanel.show()},hideButtonPanel=function(){sharedState=null,$buttonPanel.hide()},padding=2,widthCellholder=$targetGrid.find(".i-role-cellholder").width(),buttonPanelWidth=32;$buttonPanel.css("left",widthCellholder-buttonPanelWidth-padding),$buttonPanel.css("bottom",padding),$buttonPanel.css("position","absolute"),$buttonPanel.addClass("i-role-quick-add-decorator-list"),$targetGrid.append($buttonPanel);var doubleClick=_.debounce(function(event){$(event.target).hasClass("i-role-cellholder")&&$button.is(":visible")&&$button.click()},300),selector=".i-role-grid,.i-role-quick-add-decorator-list";$targetGrid.on("mouseenter",selector,createEventHandler("enter",showButtonPanel)),$targetGrid.on("mouseleave",selector,createEventHandler("leave",hideButtonPanel)),$targetGrid.on("dblclick",selector,doubleClick)}})