define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/ui/extensions/board.plus/ui.board.plus.decorator.quick-add-cells","tau/ui/extensions/board.plus/ui.board.plus.decorator.quick-add-list"],function(_,$,ExtensionBase,CellsQuickAddDecorator,ListQuickAddDecorator){return ExtensionBase.extend({resetLifecycle:!0,"bus slice.cells.quickadd.api.ready:last + domWrapper.ready:last + model.cellActions.ready":function(e,quickAddApi,domWrapper,cellsActions){var self=this,$buttonPanel=domWrapper.createQuickAddPanel();$buttonPanel.hide();var api=quickAddApi;api.on("after.addData",_.bind(self.onAfterAddData,self)),api.on("after.listAddData",_.bind(self.onAfterAddData,self));var QuickAddDecorator=domWrapper.isListMode()?ListQuickAddDecorator:CellsQuickAddDecorator;domWrapper.decorate(QuickAddDecorator,{$buttonPanel:$buttonPanel,items:cellsActions.items,onActivate:function(e){var param={target:$buttonPanel.find(".tau-btn"),actionItems:e.data.actionItems,ctrl:e};self.showQuickAddPopup(api,domWrapper,param)}})},onAfterAddData:function(e){var result=e.data.result,d=result[0];this.fire("operation.added",{options:{forceAppend:!0},items:[{data:d.dataItem,x:d.x,y:d.y}]})},cellHasCards:function(cell){var children=$(cell).children(".i-role-card");return children.size()>0},showQuickAddPopup:function(slice,domWrapper,activationData){var self=this,button=activationData.target,findCellActionItemInData=function(cellData){return _.find(cellData.fixed.items,function(item){return item.type==="AddAction"})},actionItems=activationData.actionItems,addActionItem=findCellActionItemInData(actionItems),cellHolder=domWrapper.getCellByCoordinate(actionItems),cellIsInitiallyEmpty=!this.cellHasCards(cellHolder),CONST_ADDEXPAND_CLASS="tau-quick-add_expand",viewMode=domWrapper.isListMode()?"list":"board",$gridView=domWrapper.getGrid().parents(".tau-board-grid-view,.tau-entity-list"),bubbleConfig={target:button,cleanupOnHide:!0,stackName:"quickAdd",showOnCreation:!0,zIndex:1e4,onShow:function(){$gridView.prop("disabled",!0),button.parent().addClass(CONST_ADDEXPAND_CLASS)},onHide:function(){$gridView.prop("disabled",!1),button.parent().removeClass(CONST_ADDEXPAND_CLASS),activationData.ctrl.deactivate();if(cellIsInitiallyEmpty&&self.cellHasCards(cellHolder)){var x=actionItems.x,y=actionItems.y;domWrapper.expandCell(self,x,y)}},onPositionConfig:function(){var position={of:button,collision:"fit flip",my:"left top",at:"left bottom",offset:"-30 0"};return button.tauBubble("widget").height()<button.offset().top&&(position=_.extend(position,{my:"left bottom",at:"left top"})),position},dontCloseSelectors:["#ui-datepicker-div"],componentsConfig:{components:[{type:"board.cell.quick.add",options:{slice:slice,action:actionItems,addAction:addActionItem,viewMode:viewMode}}]}};self.fire("initBubble",bubbleConfig)}})})