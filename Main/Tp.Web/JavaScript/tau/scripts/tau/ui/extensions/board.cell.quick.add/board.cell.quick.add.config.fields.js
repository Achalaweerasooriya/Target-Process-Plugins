define(["Underscore","jQuery","tau/utils/utils.date","tau/core/class","tau/components/extensions/component.extension.base","tau/models/board.cell.quick.add/model.board.general.quick.add","tau/ui/extensions/board.cell.quick.add/board.cell.quick.add.related","libs/jquery/jquery.placeholder","libs/jquery/jquery.caret","libs/jquery/jquery.inputMaskEditor","tau/ui/extensions/inviter/jquery.tauInviter"],function(e,t,i,r,a,n,s){return r.extend({init:function(e){this.config=e},hasErrors:!1,validate:function(i){var r=!1,a=this.getFormData(i);return e.each(i,function(i){var n=t(i),s=this.getElementData(n),o=s.validateData;e.any(o.rules,function(e){var t=a[s.fieldname],i=this.typesValidate[e].validate(t,s,a),o=!1;return i.result?this.typesValidate[e].hideError?this.typesValidate[e].hideError(n):this.hideError(n):(this.typesValidate[e].showError?this.typesValidate[e].showError(n,i.message):this.showError(n,i.message),r=!0,o=!0),o},this)},this),this.hasErrors=r,!r},getValue:function(e){var t=(e.data("fieldtype")+"").toLowerCase();return this.typesValue[t]?this.typesValue[t].call(this,e):this.typesValue["default"].call(this,e)},getElementData:function(e){return{$element:e,fieldname:e.data("fieldname"),validateData:e.data("validate")}},getFormData:function(i){var r={};return e.each(i,function(e){var i=t(e),a=i.data("fieldname"),n=this.getValue(i);r[a]=n},this),r},getCfValue:function(e){var i=t(e),r=i.data("fieldtype");switch(r){case"DropDown":case"TemplatedURL":case"Number":case"Date":case"DateTime":case"Text":return i.val();case"MultipleSelectionList":return i.val()&&i.val().join(",")||"";case"CheckBox":return i.prop("checked");case"Entity":var a=i.data();return{id:a.value.id,kind:a.value.entityType.name,name:a.value.name};case"URL":var n=i.parent(),s=n.find(".cf-input-url_value").val(),o=n.find(".cf-input-url_description").val();return{url:s,label:o};default:return null}},typesValidate:{required:{validate:function(t){return{result:!e.isEmpty(t),message:"This is a required field."}}},"required-team-project":{validate:function(e,t,i){var r="project"in i,a="team"in i,n=i.project&&-1!=i.project,s=i.team&&-1!=i.team,o=n||s,l=r&&a,u=!l||o;return{result:u,message:"Either Project or Team should be selected."}}},"required-ddl":{validate:function(t){return{result:!e.isEmpty(t)&&-1!=t,message:"This is a required field."}}},text:{validate:function(){return{result:!0}}},email:{validate:function(t){return""==e.trim(t)?{result:!0}:{result:/^[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$/gi.test(e.trim(t)),message:"Invalid email address."}}},number:{validate:function(t){if(""==e.trim(t))return{result:!0};t=(t+"").replace(",",".");var i,r=!0;return isNaN(t)?(r=!1,i="the value can only be a valid number, e.g. 1, 3.14 or 2010"):t>e.MAX_INT?(r=!1,i="Please, enter a reasonable number."):0>t&&(r=!1,i="Number must be greater than 0"),{result:r,message:i}}},integer:{validate:function(t){if(""==e.trim(t))return{result:!0};var i,r=!0;return isNaN(t)||!/^\d+$/.test(t)?(r=!1,i="the value can only be a integer, e.g. 1, 2, 14"):t>e.MAX_INT?(r=!1,i="Please, enter a reasonable number."):0>=t&&(r=!1,i="Number must be greater than 0"),{result:r,message:i}}},date:{validate:function(t){if(""==e.trim(t))return{result:!0};var r,a=i.parse(t),n=!0;return null===a?(r="Incorrect date format",n=!1):a<new Date(1900,0,1)&&(r="Date must be greater than 01-01-1900",n=!1),{result:n,message:r}}},entityRequired:{validate:function(t){return{result:!e.isEmpty(t)}},showError:function(e){e.closest(".tau-userStorySelector").addClass("tau-error").attr("title","This is a required field.")},hideError:function(e){e.closest(".tau-userStorySelector").removeClass("tau-error").removeAttr("title")}},checkbox:{validate:function(){return{result:!0}}},url:{validate:function(t){return""==e.trim(t)?{result:!0}:{result:/\b((?:https?|ftp|file):\/\/(?:[\-A-Z0-9.]+)(?::\d+)?(?:\/[\-A-Z0-9+&@#\/%=~_|!:,.;]*)?(?:\?[A-Z0-9+&@#\/%=~_|!:,.; ]*)?)/i.test(t),message:"Invalid url address."}}},usersinvite:{validate:function(){return{result:!0}}},teammultiselect:{validate:function(){return{result:!0}}},projectmultiselect:{validate:function(){return{result:!0}}},color:{validate:function(){return{result:!0}}},icon:{validate:function(){return{result:!0}}}},showError:function(e,t){e.addClass("tau-error").attr("title",t).nextAll(".placeholder").addClass("tau-error")},hideError:function(e){e.removeClass("tau-error").removeAttr("title").nextAll(".placeholder").removeClass("tau-error")},setBehavior:function(i){e.each(i,function(e){var i=t(e),r=(i.data("fieldtype")+"").toLowerCase();this.typesBehavior[r]&&this.typesBehavior[r].call(this,i)},this)},typesBehavior:{date:function(e){t.datepicker.parseDate=function(e,t){return i.parse(t)},t.datepicker.formatDate=function(e,t){return i.formatAs(t,e)};var r=i.getFormatData().date.short;e.datepicker({dateFormat:r})},datetime:function(e){t.datepicker.parseDate=function(e,t){return i.parse(t)},t.datepicker.formatDate=function(e,t){return i.formatAs(t,e)},t.datepicker.formatTime=function(e,t){return i.formatAs(t,e)};var r=i.getFormatData().date.short;e.datetimepicker({dateFormat:r,showButtonPanel:!1})},text:t.noop(),number:function(e){var t="^[0-9]*([\\"+this.config.culture.decimalSeparator+"][0-9]{0,2})?$";e.inputMaskEditor({mask:t})},integer:function(e){var t="^[0-9]*?$";e.inputMaskEditor({mask:t})},userstoryselector:function(e){var i=this.typesClear.entity,r=e.data("entityuniquename"),a=this._getFieldByClassFromElement(e,"project");this.entityBehavior(e),a.change(t.proxy(function(a){i(e),this.childBus[r].fire("refresh",{filter:{project:t(a.target).val()}})},this.config.self))},releaseselector:function(e){var i=this.typesClear.entity,r=e.data("entityuniquename"),a=this._getFieldByClassFromElement(e,"project");this.entityBehavior(e),a.change(t.proxy(function(a){i(e),this.childBus[r].fire("refresh",{filter:{project:t(a.target).val()}})},this.config.self))},testplanselector:function(e){var i=this.typesClear.entity,r=e.data("entityuniquename"),a=this._getFieldByClassFromElement(e,"project");this.entityBehavior(e),a.change(t.proxy(function(a){i(e),this.childBus[r].fire("refresh",{filter:{project:t(a.target).val()}})},this.config.self))},userselector:function(e){this.entityBehavior(e)},entity:function(e){this.entityBehavior(e)},usersinvite:function(e){e.parent().css({maxWidth:t(window).width()/3});var i=e.data("selected");e.tauInviter({configurator:this.config.configurator,allowEmails:!0,canDelete:function(e){return i.id!==e.id}}),i&&i.id&&e.tauInviter("setValue",[{id:i.id,type:"existing",name:i.email,avatarUri:i.avatarUri}])},teammultiselect:function(e){e.css({maxHeight:t(window).height()/3}),this.config.self.fire("adjustPosition")},projectmultiselect:function(e){e.css({maxHeight:t(window).height()/3}),this.config.self.fire("adjustPosition")},color:function(e){var t=this._initRichSelect(e,"color");t.on("change",function(e,i){t.attr("style","background-color: "+(i||"default"))}),this.config.self.fire("adjustPosition")},icon:function(e){var t=this._initRichSelect(e,"icon");t.on("change",function(e,i){var r=t.attr("data-value");t.removeClass("tau-icon_name_"+r),t.addClass("tau-icon_name_"+(i||"default"))}),this.config.self.fire("adjustPosition")}},clear:function(i){e.each(i,function(e){var i=t(e),r=(i.data("fieldtype")+"").toLowerCase();this.typesClear[r]?this.typesClear[r].call(this,i):this.typesClear["default"].call(this,i)},this)},typesClear:{"default":function(e){"Remain"!=e.data("fieldname")&&e.val("")},date:function(e){"Time"!==e.closest("form").data("type")&&e.val("")},dropdown:function(e){e.find("option").eq(0).prop("selected",!0)},entity:function(e){e.val("");var t=e.parent();t.find(".tau-linkentity__inner").text(e.attr("placeholder")).addClass("tau-linkentity__inner_placeholder"),t.find(".tau-linkentity__icon").hide()},checkbox:function(e){e.prop("checked",!1)},usersinvite:function(e){e.tauInviter("reset")},color:function(e){e.find("select[name=color]").trigger("reset")},icon:function(e){e.find("select[name=icon]").trigger("reset")},teammultiselect:function(i){var r=i.find(":checked");e.each(r,function(e){t(e).prop("disabled")||t(e).prop("checked",!1)})},projectmultiselect:function(i){var r=i.find(":checked");e.each(r,function(e){t(e).prop("disabled")||t(e).prop("checked",!1)})},userstoryselector:t.noop,testplanselector:t.noop,releaseselector:t.noop,ddl:t.noop,url:t.noop},typesValue:{"default":function(e){return e.val()},usersinvite:function(t){var i=t.data("selected"),r=t.tauInviter("getValue");return e.reject(r,function(e){return e.id&&e.id==i.id})},teammultiselect:function(i){var r=i.find(":checked").filter(function(){return!this.disabled});return JSON.stringify(e.map(r,function(e){return{team:{id:t(e).val()}}}))},projectmultiselect:function(i){var r=i.find(":checked").filter(function(){return!this.disabled});return JSON.stringify(e.map(r,function(e){return{project:{id:t(e).val()}}}))},color:function(e){return e.find("select[name=color]").val()},icon:function(e){return e.find("select[name=icon]").val()}},_getFieldByClassFromElement:function(e,t){return e.closest("form").find("."+t)},_getContextValue:function(e){return"-1"===e?"null":e},_getCurrentContext:function(e){var t=this._getFieldByClassFromElement(e,"project"),i=this._getFieldByClassFromElement(e,"team"),r=this._getContextValue(this.getValue(t)),a=this._getContextValue(this.getValue(i));return{projectIds:[r],teamIds:[a]}},_relatedAddClickHandler:function(e,t){var i=e.$target;s.isInitialized(i)&&s.destroy(i),t.stopImmediatePropagation(),s.init(e).then(function(){s.show(i)})},entityBehavior:function(e){var t=e.parent().parent().find(".i-role-related-quick-add"),i=0!==t.length;if(i){var r={namespace:".relatedQuickAdd",ctx:this.config.self,getCurrentContext:this._getCurrentContext.bind(this,e),$element:e,$target:t};t.on("click",this._relatedAddClickHandler.bind(this,r))}this.config.self.fire("applyFinder",e)},_initRichSelect:function(e,i){var r=e.find("select[name="+i+"]"),a=e.find(".i-role-currenticon");return r.on("change",function(){var e=r.val();a.trigger("change",e),a.attr("data-value",e||"default")}),e.find(".i-role-richselect .i-role-option").on("click",function(){var t=this.getAttribute("data-value");r.val(t),r.trigger("change"),e.find(":text:first").focus()}),a.parent().on("click",function(i){t(i).toggleClass("tau-active"),e.find(".i-role-richselect").css({width:e.width()}),e.find(".i-role-richselect").toggle(),this.fire("adjustPosition")}.bind(this.config.self)),e.on("reset",function(){r.val(""),r.trigger("change")}),a}})});