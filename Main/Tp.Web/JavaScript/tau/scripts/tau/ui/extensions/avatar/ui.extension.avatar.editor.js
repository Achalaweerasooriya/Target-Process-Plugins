define(["app.path","Underscore","jQuery","tau/components/extensions/component.extension.base","tau/core/tau","libs/jquery/jquery.fileupload","libs/jquery/jquery.Jcrop","tau/ui/behaviour/overlay/ui.behaviour.overlay"],function(e,i,t,r,a){return r.extend({"bus afterRender":function(e){e.data.element.find(".file-input").fileupload({url:this._getUploadUrl(),formData:this._getFormData(),add:i.bind(this._onFileAdd,this)}),this.avatarService=this.config.context.configurator.getAvatarService(),e.data.element.find(".crop-avatar").click(i.bind(this.onCropClick,this)),e.data.element.find(".remove-avatar").click(i.bind(this.onRemoveClick,this)),e.data.element.find(".tau-save-crop").click(i.bind(this.onSaveClick,this)),e.data.element.find(".tau-cancel-crop").click(i.bind(this.onCancelClick,this));var t=e.data.element.find(".tau-avatar-crop-container"),r=t.css("max-width");this.fire("view.max.width.calculated",r)},onCancelClick:function(){this.fire("view.save.cancel")},onSaveClick:function(){this.fire("view.save.crop")},onRemoveClick:function(){this.fire("view.lock"),this.fire("view.remove.avatar")},onCropClick:function(){this.fire("view.initialize.crop")},"bus model.crop.ready:last+view.initialize.crop":function(e,i){this.fire("view.lock"),this.fire("view.edit.avatar.with.url",{url:this.getOriginAvatarUrl(this._getGeneralId()),cropRect:i})},"bus view.edit.avatar.with.url:last+view.crop.selected:last+afterRender:last+view.save.crop":function(e,i,r,a){var n=a.element.find(".tau-avatar-crop-container .tau-img:visible"),o=n[0].naturalWidth/n.width(),s=n[0].naturalHeight/n.height(),d=this.getCropAvatarUrl(i.url,{x:parseInt(r.x*o,10),y:parseInt(r.y*s,10),w:parseInt(r.w*s,10),h:parseInt(r.h*s,10)});this.fire("view.image.will.crop"),this.avatarService.crop(d).done(t.proxy(function(e){this.fire("view.image.did.cropped",e),this.fire("model.crop.ready",{x:d.x,y:d.y,width:d.w,height:d.h})},this)).fail(t.proxy(function(e){this.fire("error",{message:e.Message,disableAutoClose:!0}),this.fire("view.hide.avatar.editor"),this.fire("view.unlock")
},this))},"bus afterRender:last+view.hide.avatar.editor":function(e,i,t){var r=this;i.element.find(".tau-avatar-crop-container").slideUp(function(){t&&t.close===!0&&r.fire("close",{animated:!0})}),i.element.find(".drop-down-list__inner").show()},"bus afterRender:last+view.show.avatar.editor":function(e,i){i.element.find(".tau-avatar-crop-container").slideDown(),i.element.find(".drop-down-list__inner").hide()},"bus afterRender:last+view.lock":function(e,i){i.element.tauOverlay()},"bus afterRender:last+view.unlock":function(e,i){i.element.tauOverlay("hide")},"bus afterRender:last+view.save.cancel":function(){this.fire("view.hide.avatar.editor")},"bus jcrop.api.ready+view.image.will.crop":function(e,i){i.destroy(),this.fire("view.lock")},"bus avatar.did.removed":function(e,i){this.store.registerWithEvents([{id:i.Id,__type:"user",avatarUri:i.AvatarUri}]),this.fire("view.unlock")},"bus view.image.did.cropped":function(e){var i=e.data;this.store.registerWithEvents([{id:i.Id,__type:"user",avatarUri:i.AvatarUri}]),this.fire("view.hide.avatar.editor",{close:!0}),this.fire("view.unlock")},"bus view.remove.avatar":function(){this.fire("view.lock");var e=this.getRemoveAvatarUrl(this._getGeneralId());this.avatarService.remove(e).done(t.proxy(function(e){this.fire("avatar.did.removed",e)},this)).fail(t.proxy(function(e){this.fire("error",{message:e.Message,disableAutoClose:!0}),this.fire("view.unlock")},this))},"bus view.files.selected":function(e,i){function t(e){var i=JSON.parse(e.responseText);r.fire("error",{message:i.Message,disableAutoClose:!0}),r.fire("view.unlock")}var r=this;r.fire("view.lock"),i.submit().done(function(e,i,a){try{e=JSON.parse(e)}catch(n){e=e.find("body").text(),a.responseText=e,e=JSON.parse(e)}e.Success===!0?r.fire("view.file.did.upload"):t(a)}).fail(t)},"bus afterRender:last+view.crop.selected":function(e,i){i.element.find(".tau-save-crop").attr("disabled",!1)},"bus jcrop.api.ready>before_view.file.did.upload":function(e,i){i.destroy()},"bus afterRender:last+view.crop.released":function(e,i){i.element.find(".tau-save-crop").attr("disabled",!0)
},getTempAvatarUrl:function(i){var t=e.get()+"/avatar.ashx?UserID="+i+"&source=temp&"+(new Date).getTime();return this._appendToken(t)},getRemoveAvatarUrl:function(i){var t=e.get()+"/avatar.ashx?operation=remove&UserID="+i;return this._appendToken(t)},getOriginAvatarUrl:function(i){var t=e.get()+"/avatar.ashx?UserID="+i+"&source=original&"+(new Date).getTime();return this._appendToken(t)},getCropAvatarUrl:function(e,i){var t=e+"&operation=crop&"+["x="+i.x,"y="+i.y,"width="+i.w,"height="+i.h].join("&");return this._appendToken(t)},_appendToken:function(e){var i=e;return e.indexOf("?token=")<0&&e.indexOf("&token=")<0&&(i+=a.getTokenParameterFromQueryString("&")),i},"bus afterRender:last+view.file.did.upload":function(){var e=this._getGeneralId(),i=this.getTempAvatarUrl(e);this.fire("view.hide.avatar.editor"),this.fire("view.edit.avatar.with.url",{url:i})},"bus jcrop.api.ready>before_view.edit.avatar.with.url":function(e,i){i.destroy()},"bus afterRender:last+view.max.width.calculated:last+view.edit.avatar.with.url":function(e,i,r,a){var n=this,o=i.element.find(".tau-avatar-crop-container");o.css("max-width",r);var s=i.element.find(".tau-avatar-crop-container .tau-img:first-child");s.css("width","").css("height","").prop("src",a.url);var d=a.cropRect,c=function(){if(i.element.is(":hidden"))return void n.fire("view.unlock");n.fire("view.show.avatar.editor"),i.element.find(".tau-save-crop").attr("disabled",!0);var e=s.width(),r=s.height(),a=48,c=i.element,l=c.offset(),v=t(window).height()-50-l.top;if(r>v){var u=v*e/r;o.css("max-width",u),e=s.width(),r=s.height()}var f=s.width()/s[0].naturalWidth,h=null;d&&(h=[d.x*f,d.y*f,d.width*f,d.height*f],h[2]+=h[0],h[3]+=h[1]),s.Jcrop({aspectRatio:1,minSize:[a,a],setSelect:h?h:[0,0,e,r],onSelect:function(e){n.fire("view.crop.selected",e)},onChange:function(e){n.fire("view.crop.selected",e)},onRelease:function(){n.fire("view.crop.released")}},function(){n.fire("view.unlock"),n.fire("jcrop.api.ready",this)})};s.on("load",c)},_getUploadUrl:function(){return e.get()+"/avatar.ashx?UserID="+this._getGeneralId()+a.getTokenParameterFromQueryString("&")
},_getFormData:function(){return[]},_getGeneralId:function(){return this.config.context.entity.id},_onFileAdd:function(e,i){i.files&&0!==i.files.length&&this.fire("view.files.selected",i)}})});