define(["Underscore","jQuery","tau/components/extensions/component.extension.base"],function(t,e,i){return i.extend({name:"extension.list.prioritize",category:"edit","bus afterRender":function(t){var i=t.data.element,a=this;this.$el=i,i.addClass("tau-list__sortable__true");var r=i.find("[role=group]");r.addClass("tau-list__group_sortable_true");var s={sensitivity:7,speed:12};this.config.context.configurator.getConfig("isPopup",!1)&&(s={sensitivity:20,speed:30}),r.addClass("tau-list__group_available_true"),r.sortable({scroll:!0,scrollSensitivity:s.sensitivity,scrollSpeed:s.speed,cursor:"move",connectWith:".tau-list__group_available_true[role=group]",items:".tau-list__list [role=item]",dropOnEmpty:!0,handle:"[role=sortable-handler]",forcePlaceholderSize:!0,placeholder:{element:function(){var t=e('<li class="tau-list__list__item tau-list__sortable-placeholder ui-sortable-placeholder"></li>');return t.height(50),t},update:function(){}},helper:function(t,e){var i=e;return i}});var l=function(){e(this).data("ui-sortable").refreshPositions()};i.mousedown(function(){r.bind("mousemove",l)}),i.mouseup(function(){r.unbind("mousemove",l)}),r.bind("sortstart",function(t,i){a.started=!0;var r=i.item,s=r.data("tmplItem").data||{},l=e(t.currentTarget);l.addClass("tau-list__group_sortover_true"),a.$group=l;var o=l.data("tmplItem")?l.data("tmplItem").data:{};a.fire("prioritize.start",{item:s,group:o})}),r.bind("sortstop",function(){r.addClass("tau-list__group_available_true"),r.removeClass("tau-list__group_available_false"),r.removeClass("tau-list__group_sortover_true")}),r.bind("sortupdate",function(t,i){if(a.started){a.started=!1;var r=i.item,s=r.prev("[role=item]"),l=r.next("[role=item]"),o=r.data("tmplItem").data||{},n=s.length?s.data("tmplItem").data:{},u=l.length?l.data("tmplItem").data:{},d=r.parents("[role=group]:first"),p=d.data("tmplItem")||null;p=p?p.data:null;var _=d.hasClass("tau-list__group_collapsed_true");d.addClass("i-target");var f=e(this),c=f.data("tmplItem")||null;c=c?c.data:null,a.fire("prioritize.checkAvailability",{$item:r,$prevGroup:f,$targetGroup:d,item:o,prev:n,next:u,group:p,prevGroup:c,isCollapsed:_})}}),r.bind("sortchange",function(){var t=r.find(".tau-list__sortable-placeholder").parents("[role=group]:first");1==t.length&&0==t.hasClass("tau-list__group_sortover_true")&&(r.removeClass("tau-list__group_sortover_true"),t.addClass("tau-list__group_sortover_true"))});var o=function(t,i,a,r){a?e(a[0]).find(".tau-list__list").append(this.placeholder[0]):i.item[0].parentNode.insertBefore(this.placeholder[0],"down"==this.direction?i.item[0]:i.item[0].nextSibling),this.counter=this.counter?++this.counter:1;var s=this,l=this.counter;window.setTimeout(function(){l==s.counter&&s.refreshPositions(!r)},0)};r.each(function(){var t=e(this);t.data("ui-sortable")._rearrange=o})},"bus prioritize.checkAvailability":function(){this.bus.fire("prioritize.isAvailable.default",{})},"bus prioritize.checkAvailability+prioritize.isNotAvailable":function(){this.bus.fire("refresh")},"bus prioritize.checkAvailability+prioritize.isAvailable.default+prioritize.isAvailable.comment":function(t){var e=t["prioritize.checkAvailability"].data;this.fire("positionUpdated",e)},"bus prioritize.updateGroupsAvailability":function(i){var a=i.data,r=a.groups,s=this.$el.find("[role=group]");if(s.length<=1||s.length==r.length)return s.addClass("tau-list__group_available_true").removeClass("tau-list__group_available_false"),void this.$group.sortable("refresh");var l=t.filter(s.toArray(),function(i){var a=e(i).data("tmplItem").data;return t.any(r,function(t){return a===t})}),o=e(l);s.addClass("tau-list__group_available_false").removeClass("tau-list__group_available_true"),o.removeClass("tau-list__group_available_false").addClass("tau-list__group_available_true"),this.$group.sortable("refresh")},"bus beforeUpdate":function(){this.$el.find(".i-target [role=counter]").css("backgroundColor","#ffefd5")},"bus afterUpdate":function(i){this.$el.find("[role=group]").each(function(){e(this).find("[role=counter]").text(e(this).find("[role=item]").length)}),this.$el.find(".i-target [role=counter]").animate({backgroundColor:"#ffffff"},200),this.$el.find(".i-target").removeClass("i-target");var a=i.data.changedItem,r=this.$el.find(".i-item-"+a.id),s=r.parents("[role=item]:first"),l=s.data("tmplItem").data;if(t.extend(l,a),this.$el.find("[role=group]").length>1){var o="tau-list__table__row_isfinalstate_true";l.entityState&&r.toggleClass(o,!!l.entityState.isFinal)}}})});