define(["Underscore","jQuery","tau/configurator","tau/components/extensions/component.extension.base","libs/jquery/jquery.mousewheel"],function(a,b,c,d){return d.extend({name:"extension.list.prioritize",category:"edit","bus afterRender":function(a){var d=a.data.element,e=this;this.$el=d,d.addClass("tau-list__sortable__true");var f=d.find("[role=group]");f.addClass("tau-list__group_sortable_true");var g={sensitivity:7,speed:12};c.getConfig("isPopup",!1)&&(g={sensitivity:20,speed:30}),f.addClass("tau-list__group_available_true"),f.sortable({scroll:!0,scrollSensitivity:g.sensitivity,scrollSpeed:g.speed,cursor:"move",connectWith:".tau-list__group_available_true[role=group]",items:".tau-list__list [role=item]",dropOnEmpty:!0,handle:"[role=sortable-handler]",forcePlaceholderSize:!0,placeholder:{element:function(a){var c=b('<li class="tau-list__list__item tau-list__sortable-placeholder ui-sortable-placeholder"></li>');return c.height(50),c},update:function(a,b){return}},helper:function(a,b){var c=b;return c}});var h=function(){b(this).data("sortable").refreshPositions()};d.mousedown(function(){f.bind("mousemove",h)}),d.mouseup(function(){f.unbind("mousemove",h)}),f.bind("sortstart",function(a,c){e.started=!0;var d=c.item,f=d.data("tmplItem").data||{},g=b(a.currentTarget);g.addClass("tau-list__group_sortover_true"),e.$group=g;var h=g.data("tmplItem")?g.data("tmplItem").data:{};e.fire("prioritize.start",{item:f,group:h})}),f.bind("sortstop",function(a,b){f.addClass("tau-list__group_available_true"),f.removeClass("tau-list__group_available_false"),f.removeClass("tau-list__group_sortover_true")}),f.bind("sortupdate",function(a,c){if(e.started)e.started=!1;else return;var d=c.item,f=d.prev("[role=item]"),g=d.next("[role=item]"),h=d.data("tmplItem").data||{},i=f.length?f.data("tmplItem").data:{},j=g.length?g.data("tmplItem").data:{},k=d.parents("[role=group]:first"),l=k.data("tmplItem")||null;l=l?l.data:null;var m=k.hasClass("tau-list__group_collapsed_true");k.addClass("i-target");var n=b(this),o=n.data("tmplItem")||null;o=o?o.data:null,e.fire("prioritize.checkAvailability",{$item:d,$prevGroup:n,$targetGroup:k,item:h,prev:i,next:j,group:l,prevGroup:o,isCollapsed:m})}),f.bind("sortchange",function(a,b){var c=f.find(".tau-list__sortable-placeholder").parents("[role=group]:first");c.length==1&&c.hasClass("tau-list__group_sortover_true")==0&&(f.removeClass("tau-list__group_sortover_true"),c.addClass("tau-list__group_sortover_true"))});var i=function(a,c,d,e){d?b(d[0]).find(".tau-list__list").append(this.placeholder[0]):c.item[0].parentNode.insertBefore(this.placeholder[0],this.direction=="down"?c.item[0]:c.item[0].nextSibling),this.counter=this.counter?++this.counter:1;var f=this,g=this.counter;window.setTimeout(function(){g==f.counter&&f.refreshPositions(!e)},0)};f.each(function(){var a=b(this);a.data("sortable")._rearrange=i})},"bus prioritize.checkAvailability":function(a){this.bus.fire("prioritize.isAvailable.default",{})},"bus prioritize.checkAvailability+prioritize.isNotAvailable":function(a){this.bus.fire("refresh")},"bus prioritize.checkAvailability+prioritize.isAvailable.default+prioritize.isAvailable.comment":function(a){var b=a["prioritize.checkAvailability"].data;this.fire("positionUpdated",b)},"bus prioritize.updateGroupsAvailability":function(c){var d=c.data,e=d.groups,f=this,g=this.$el.find("[role=group]");if(g.length<=1||g.length==e.length){g.addClass("tau-list__group_available_true").removeClass("tau-list__group_available_false"),this.$group.sortable("refresh");return}var h=a.filter(g.toArray(),function(c){var d=b(c).data("tmplItem").data;return a.any(e,function(a){return d===a})}),i=b(h);g.addClass("tau-list__group_available_false").removeClass("tau-list__group_available_true"),i.removeClass("tau-list__group_available_false").addClass("tau-list__group_available_true"),this.$group.sortable("refresh")},"bus beforeUpdate":function(){this.$el.find(".i-target [role=counter]").css("backgroundColor","#ffefd5")},"bus afterUpdate":function(c){this.$el.find("[role=group]").each(function(){b(this).find("[role=counter]").text(b(this).find("[role=item]").length)}),this.$el.find(".i-target [role=counter]").animate({backgroundColor:"#ffffff"},200),this.$el.find(".i-target").removeClass("i-target");var d=c.data.changedItem,e=this.$el.find(".i-item-"+d.id),f=e.parents("[role=item]:first"),g=f.data("tmplItem").data;a.extend(g,d);var h="tau-list__table__row_isfinalstate_true";g.entityState&&e.toggleClass(h,!!g.entityState.isFinal)}})})