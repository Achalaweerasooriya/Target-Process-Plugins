define(["Underscore","jQuery","tau/core/extension.base","tau/ui/behaviour/common/ui.behaviour.progressIndicator","tau/core/event-dispatcher"],function(_,$,ExtensionBase,ProgressIndicator,EventDispatcher){return ExtensionBase.extend({"bus beforeInit":function(){this.fire("controller.hostType",null),this.fire("controller.app.host.prev",null),this.fire("controller.app.page.prev",null)},"bus controller.app.host.prev > controller.app.host":function(e){var next=e["controller.app.host"].data,prev=e["controller.app.host.prev"].data;prev&&prev.destroy(),this.fire("controller.app.host.prev",next)},"bus controller.app.page.prev > controller.app.page":function(e){var next=e["controller.app.page"].data,prev=e["controller.app.page.prev"].data;prev&&prev.destroy(),this.fire("controller.app.page.prev",next)},"bus controller.hostType:last + application.navigate":function(e,currentHostData,navigateData){var args=navigateData.requestArgs||{},entity=args.entity,action=args.action,entityType=_.isObject(entity)?entity.type:_.asString(entity);if(entityType&&action||entity=="reports")navigateData.applicationClassName="tau-page-entity";var newHostData=navigateData.host,isMasterTypeChanged=!currentHostData||newHostData.name!==currentHostData.name;isMasterTypeChanged&&this.fire("controller.hostType",newHostData);var postfix=isMasterTypeChanged?"full":"partial";this.fire("controller.load."+postfix,navigateData)},"bus options.ready:last + configurator.ready:last + controller.load.full":function(e,options,configurator,d){var componentBuilder=configurator.getComponentBuilder(),initConfig=_.defaults({context:{configurator:configurator}},d.requestArgs);initConfig.turnOffLoadingIndicator=options.turnOffLoadingIndicator||!1,initConfig.comet=options.comet||{},$.when(componentBuilder.create(d.host,initConfig),componentBuilder.create(d.type,initConfig)).done(_.bind(function(hostBus,pageBus){this.fire("controller.preExecute",{}),this.fire("controller.app.host",hostBus),this.fire("controller.app.page",pageBus),this.addListeners(hostBus,"Host"),this.addListeners(pageBus,"Page");var eventDispatcher=new EventDispatcher([hostBus,pageBus]);eventDispatcher.listen("afterRender",_.bind(function(e){var $host=e.argsArr[0].element,$page=e.argsArr[1].element;this.fire("innerContentRendered",{element:$host,$host:$host,$page:$page,applicationClassName:d.applicationClassName}),pageBus.on("afterRender",_.bind(function(e,pageRenderData){this.fire("innerContentRendered",{element:this.$host,$host:this.$host,$page:pageRenderData.element,applicationClassName:d.applicationClassName})},this),this)},this)),hostBus.initialize(initConfig),pageBus.initialize(initConfig),this.fire("controller.postExecute",{})},this))},"bus options.ready:last + configurator.ready:last + controller.load.partial":function(e,options,configurator,d){var componentBuilder=configurator.getComponentBuilder(),initConfig=_.defaults({context:{configurator:configurator}},d.requestArgs);initConfig.turnOffLoadingIndicator=options.turnOffLoadingIndicator||!1,initConfig.comet=options.comet||{},$.when(componentBuilder.create(d.type,initConfig)).done(_.bind(function(pageBus){this.fire("controller.preExecute",{}),this.fire("controller.app.page",pageBus),this.addListeners(pageBus,"Page"),pageBus.on("afterRender",_.bind(function(e,pageRenderData){this.fire("innerContentRendered",{element:this.$host,$host:this.$host,$page:pageRenderData.element,applicationClassName:d.applicationClassName})},this),this),pageBus.initialize(initConfig),this.fire("controller.postExecute",{})},this))},"bus afterRender:last + innerContentRendered":function(e,renderData,controllersRenderData){var $el=renderData.element,$host=controllersRenderData.$host,$page=controllersRenderData.$page;if($host.is(this.$host)&&$page.is(this.$page))return;$host.is(this.$host)||(this._appendHost($el,$host),this.$host=$host,this._appendPage($el,$host,$page),this.$page=$page),$page.is(this.$page)||(this._appendPage($el,this.$host,$page),this.$page=$page);var $p=$el.parents(".ui-popup:first");$p.length?$p=$el.add($p):$p=$el,controllersRenderData.applicationClassName?$el.data("classname")!=controllersRenderData.applicationClassName&&($p.removeClass($p.data("classname")||""),$p.addClass(controllersRenderData.applicationClassName),$p.data("classname",controllersRenderData.applicationClassName)):($p.removeClass($p.data("classname")||""),$p.data("classname","")),this.fire("controller.appContent.rendered",$el),this.fire("contentRendered",{element:$el})},"bus controller.load.partial > controller.host.rendered":function(e,$1,$host){var $el=$host.element.find("[role=main]"),integration=this.config.integration||{};!0!==integration.disableProgressIndicator&&ProgressIndicator.get($el).show()},"bus controller.load.partial > controller.host.rendered > innerPageRendered":function(e,$1,$host){var $el=$host.element.find("[role=main]"),integration=this.config.integration||{};!0!==integration.disableProgressIndicator&&ProgressIndicator.get($el).hide()},"bus configurator.ready:last + controller.app.page":function(e,configurator,pageBus){pageBus.on("beforeDelete",_.bind(function(e){this.fire("initProgress")},this),this),pageBus.on("deleted",_.bind(function(e){configurator.service("navigator").back()},this),this),pageBus.on("error",_.bind(function(e){this.fire("application.error",e.data)},this),this)},"bus view.dom.ready:last + controller.app.host:last + innerHostRendered + controller.appContent.rendered":function(e,dom,hostBus){hostBus.fire("view.dom.ready",dom)},"bus view.dom.ready:last + controller.app.page:last + innerPageRendered + controller.appContent.rendered":function(e,dom,pageBus){pageBus.fire("view.dom.ready",dom)},"bus controller.app.host:last > destroy":function(e,hostBus){hostBus.fire("destroy")},"bus controller.app.page:last > destroy":function(e,pageBus){pageBus.fire("destroy")},"bus controller.app.page:last > application.exit":function(e,pageBus){pageBus.fire("destroy")},_appendHost:function($el,$host){$el.empty().append($host)},_appendPage:function($el,$host,$page){$host.find("[role=main]").append($page)},addListeners:function(bus,alias){return bus.on("afterRender",_.bind(function(e){this.fire("inner"+alias+"Rendered",e.data)},this),this),bus}})})