define(["require","Underscore","jQuery","tau/core/extension.base","tau/ui/behaviour/common/ui.behaviour.progressIndicator","tau/core/event-dispatcher"],function(e){var t=e("Underscore"),r=e("jQuery"),n=e("tau/core/extension.base"),a=e("tau/ui/behaviour/common/ui.behaviour.progressIndicator"),i=e("tau/core/event-dispatcher");return n.extend({"bus beforeInit":function(){this.fire("controller.hostType",null),this.fire("controller.app.host.prev",null),this.fire("controller.app.page.prev",null)},"bus controller.app.host.prev > controller.app.host":function(e,t,r){t&&t.destroy(),this.fire("controller.app.host.prev",r)},"bus controller.app.page.prev > controller.app.page":function(e,t,r){this.fire("controller.app.page.prev",r)},"bus configurator.ready:last + application.navigate":function(e,t){t.service("errorBar").fire("clearError")},"bus controller.hostType:last + application.navigate":function(e,r,n){var a=n.requestArgs,i=a||{},s=i.entity,o=t.isObject(s)?s.type:t.asString(s);!i.cssClass&&(o&&i.action||"reports"==s)&&(n.applicationClassName="tau-page-entity"),i.applicationClassName&&(n.applicationClassName=i.applicationClassName);var l=!r||n.host.name!==r.name;l?(this.fire("controller.hostType",n.host),this.fire("controller.load.full",n)):this.fire("controller.load.partial",n)},"bus options.ready:last + configurator.ready:last + controller.load.full":function(e,n,a,s){var o=a.getComponentBuilder(),l=this._getInitConfig(a,n,t.omit(s.requestArgs,"handlers"));this._destroyPrevPage(),this.pageDeferred=r.Deferred(),r.when(o.create(s.host,l),o.create(s.type,l)).done(function(e,t,r){e.resolve(t,r)}.bind(this,this.pageDeferred)),this.pageDeferred.done(function(e,r){this._savePrevPage(r),this.fire("controller.preExecute",{}),this.fire("controller.app.host",e),this.fire("controller.app.page",r),this.addListeners(e,"Host"),this.addListeners(r,"Page");var n=new i([e,r]);n.listen("afterRender",t.bind(function(n){var a=n.argsArr[0].element,i=n.argsArr[1].element;this.fire("innerContentRendered",{element:a,$host:a,$page:i,applicationClassName:s.applicationClassName}),this.fire("host.ready",e),r.on("afterRender",t.bind(function(e,t){this.fire("innerContentRendered",{element:this.$host,$host:this.$host,$page:t.element,applicationClassName:s.applicationClassName})
},this),this),r.on("afterRenderAll",this._onPageBusAfterRender.bind(this,"innerContentRenderedAll",s.applicationClassName,s.requestArgs.handlers),this)},this)),e.initialize(l),r.initialize(l),this.fire("controller.postExecute",{hostBus:e,pageBus:r})}.bind(this))},"bus options.ready:last + configurator.ready:last + host.ready:last + controller.load.partial":function(e,n,a,i,s){var o=a.getComponentBuilder(),l=this._getInitConfig(a,n,t.omit(s.requestArgs,"handlers"));this._destroyPrevPage(),this.pageDeferred=r.Deferred(),r.when(o.create(s.type,l)).done(function(e,t){e.resolve(t)}.bind(this,this.pageDeferred)),this.pageDeferred.done(function(e){this._savePrevPage(e),this.fire("controller.preExecute",{}),this.fire("controller.app.page",e),this.addListeners(e,"Page"),e.on("afterRender",this._onPageBusAfterRender.bind(this,"innerContentRendered",s.applicationClassName,s.requestArgs.handlers),this),e.initialize(l),this.fire("controller.postExecute",{hostBus:i,pageBus:e})}.bind(this))},_onPageBusAfterRender:function(e,t,r,n,a){this.fire(e,{element:this.$host,$host:this.$host,$page:a.element,applicationClassName:t}),r&&r.onPageLoaded&&r.onPageLoaded()},"bus afterRender:last + innerContentRendered":function(e,t,r){var n=t.element,a=r.$host,i=r.$page;a.is(this.$host)&&i.is(this.$page)||(a.is(this.$host)||(this._appendHost(n,a),this.$host=a,this._appendPage(n,a,i),this.$page=i),i.is(this.$page)||(this._appendPage(n,this.$host,i),this.$page=i),this.fire("applyClasses",{$el:n,controllersRenderData:r}),this.fire("controller.appContent.rendered",n),this.fire("contentRendered",{element:n}))},"bus view.dom.ready:last + applyClasses":function(e,t,r){var n=r.$el,a=r.controllersRenderData,i=n.parents(".ui-popup:first");i=i.length?n.add(i):n,a.applicationClassName?n.data("classname")!=a.applicationClassName&&(i.removeClass(i.data("classname")||""),i.addClass(a.applicationClassName),i.data("classname",a.applicationClassName)):(i.removeClass(i.data("classname")||""),i.data("classname",""))},"bus controller.load.partial > controller.host.rendered":function(e,t,r){this.toggleProgressIndicator(r.element,!0)
},"bus controller.load.partial > controller.host.rendered > innerPageRendered":function(e,t,r){this.toggleProgressIndicator(r.element,!1)},toggleProgressIndicator:function(e,t){var r=e.find("[role=main]"),n=this.config.integration||{};n.disableProgressIndicator!==!0&&a.get(r).toggle(!!t)},"bus configurator.ready:last + controller.app.page":function(e,t,r){r.on("entity.beforeDelete",function(){this.fire("initProgress")},this),r.on("entity.deleted",function(){t.service("navigator").back()},this),r.on("error",function(e){this.fire("application.error",e.data)},this)},"bus view.dom.ready:last + controller.app.host:last + innerHostRendered + controller.appContent.rendered":function(e,t,r){r.fire("view.dom.ready",t)},"bus view.dom.ready:last + controller.app.page:last + innerPageRendered + controller.appContent.rendered":function(e,t,r){r.fire("view.dom.ready",t)},"bus controller.app.host:last > destroy":function(e,t){t.fire("destroy")},"bus controller.app.page:last > destroy":function(e,t){t.fire("destroy")},"bus controller.app.page:last > application.exit":function(e,t){t.fire("destroy"),taus.track({action:"close entity",tags:["entity","close entity"]})},_getInitConfig:function(e,r,n){var a=t.defaults({context:{configurator:e}},n);return a.turnOffLoadingIndicator=r.turnOffLoadingIndicator||!1,a.comet=r.comet||{},a},_appendHost:function(e,t){e.empty().append(t)},_appendPage:function(e,t,r){t.find("[role=main]").append(r)},_savePrevPage:function(e){this.prevPage=e,this.pageDeferred=null},_destroyPrevPage:function(){this.prevPage&&(this.prevPage.destroy(),this.prevPage=null),this.pageDeferred&&(this.pageDeferred.reject(),this.pageDeferred=null)},addListeners:function(e,r){return e.on("afterRender",t.bind(function(e){this.fire("inner"+r+"Rendered",e.data)},this),this),e}})});