define(["Underscore","tau/components/extensions/component.extension.base","tau/components/component.container","tau/models/page.entity/model.page.entity.context","tau/core/component-base","tau/ui/templates/title/ui.template.title.clean"],function(_,ExtensionBase,containerComponent,modelEntity,СomponentBase,templateTitle){return ExtensionBase.extend({"bus testCase.bubble.show":function(evt){var context=this.config.context,self=this,configurator=this.config.context.configurator,store=configurator.getStore();store.save("TestCase",{fields:["id","name",{userStory:["id"]},{project:["id"]}],$set:{name:"My test case",steps:"empty",success:"empty",userStory:{id:context.entity.id}}},{success:function(r){self.fire("testCase.draft.saved",{id:r.data.id})}}).done()},showTestCaseEditor:function(data){var self=this,$addLink=$(data.originalEvent.target).tauBubble({onPositionConfig:function(c){return c.offset="-20 0",c}});$addLink.bind("show",function(e,data){var $content=data.popup.find(".tau-bubble__inner");$content.html('<div class="test-case-wait-message">Adding test case. Please wait...</div>'),setTimeout(function(){self.fire("testCase.bubble.show",{$link:$addLink,data:data})},1);var keyBoardHandler={handleKeyDown:function(){}};self.config.context.configurator.getKeyBoardManager().pushHandler(keyBoardHandler)}),$addLink.bind("close",function(e,data){self.config.context.configurator.getKeyBoardManager().popHandler(),setTimeout(function(){self.fire("testCase.bubble.close",{$link:$addLink,data:data})},1)}),$addLink.tauBubble("show")},getTestCaseConfig:function(){return{layout:"list",cssClass:"test-case-quick-add-container",children:[{type:"title",template:templateTitle},{type:"container",layout:"table",cssClass:"test-case-description",cellsCssClass:["steps","success"],children:[{type:"container",children:[{type:"label",text:"Steps"},{type:"steps",richEditorHeight:100}]},{type:"container",children:[{type:"label",text:"Success"},{type:"success",richEditorHeight:100}]}]}]}},"bus testCase.quickAdd.container.ready + testCase.bubble.close":function(evt,container){container.fire("destroy");var context=this.config.context,userStoryId=context.entity.id;this.fire("testCaseWasAdded",{assignable:{id:userStoryId}})},"bus testCase.draft.context.ready + testCase.bubble.show":function(evt,config,bubble){var self=this,container=containerComponent.create({name:"quick add test case container",context:config.context});container.on("afterRender",function(evt){var $testCaseElement=evt.data.element,$content=bubble.data.popup.find(".tau-bubble__inner");$content.html('<div class="ui-quick-add-stats">Modify content for added test case</div>'),$content.append($testCaseElement),setTimeout(function(){$(".entity-title.editableText",$content).click().html(""),self.fire("testCase.quickAdd.container.ready",container)},0)}),container.fire("initialize",this.getTestCaseConfig())},"bus testCase.draft.saved":function(evt){var self=this,c=(newСomponentBase({name:"context retriever","queue.bus":!0,entity:{id:evt.data.id,type:"testCase"},context:{configurator:this.config.context.configurator}})).attach(modelEntity),contextBus=c.bus;contextBus.on("contextRetrieved",function(e){self.fire("testCase.draft.context.ready",e.data),contextBus.fire("destroy")}),contextBus.fire("beforeInit")},"bus action.add":function(evt){this.showTestCaseEditor(evt.data)}})})