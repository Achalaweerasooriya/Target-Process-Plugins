define(["Underscore","jQuery","tau/utils/utils.textsearch","tau/components/extensions/component.extension.base","tau/ui/behaviour/common/ui.behaviour.listSelectable"],function(e,t,i,s){return s.extend({"bus dataBind+afterRender":function(i){var s=this.config.context.configurator.getTemplateFactory().getTermProcessor();this.searchIndex=null;var a=this.config,l=this.element=i.afterRender.data.element,o=this.dataToBind=i.dataBind.data,n=0;e.forEach(o.states,function(e){e.items?n+=e.items.length:n++}),this.$list=l.find(".drop-down-list"),this.$options=this.$list.find(".i-role-option"),this.$list.on("click",".i-role-option:not(:has(.tau-loader))",e.bind(this.onItemSelected,this)),a.hasOwnProperty("maxHeight")&&this.$list.css({"max-height":a.maxHeight,"overflow-y":"auto"});var r=t("<div class='drop-down-actions' role='actions' />"),d=!1;if(o.hasOwnProperty("defaultValue")&&!this.config.hideDefaultValue){d=!0;var h=this.config.defaultValueLabel||"default";t("<span class='action-link default'>"+e.escape(s.replaceTermTags(h))+"</span>").click(e.bind(this.defaultValue,this)).appendTo(r)}if(this.config.allowToReset=!!this.config.allowToReset,o.nullableValue&&this.config.allowToReset){d=!0;var c=this.config.clearValueLabel||"reset";t("<span class='action-link clear' role='action-reset'>"+e.escape(s.replaceTermTags(c))+"</span>").click(e.bind(this.clearValue,this)).appendTo(r)}if(d&&r.insertBefore(this.$list),0===o.states.length&&o.completed){var u=a.emptyDataMessage||"None";this.$list.append("<span class='empty-message'>"+e.escape(s.replaceTermTags(u))+"</span>")}if(a.filter&&n>3){this.filterField=t("<input type='text' class='filter-field' />").keyup(e.bind(this._filterDelegate,this)),a.filterPlaceholder&&"string"==typeof a.filterPlaceholder&&this.filterField.attr("placeholder",a.filterPlaceholder);var f=t("<div class='filter-field-wrapper'></div>").append(this.filterField);f.insertBefore("top"===this.config.filterPosition&&d?r:this.$list)}if(a.expandable&&!o.completed){var p=a.mode||"short";
if("full"!==p){var b=t("<div class='drop-down-footer'></div>"),g=this.config.fullModeLabel||"more...";this.$mode=t("<div class='action-link more'>"+g+"</div>").click(e.bind(this._toggleMode,this)).appendTo(b),b.insertAfter(this.$list)}}this.bus.fire("dataRendered",{element:l})},"bus $outerBubbled.ready:last+dataRendered:last":function(){this._createSelectable(),this.bus.fire("focus")},"bus $outerBubbled.show:last":function(){this.bus.fire("focus")},_createSelectable:function(){this.$list.listSelectable({items:".drop-down-option:visible",className:"drop-down-option_hover",keyboardManager:this.config.context.configurator.getKeyBoardManager()}),this.$list.addClass("tau-dropdownlist_selectable_true")},_enableSelectable:function(){this.$list.hasClass("tau-dropdownlist_selectable_true")&&this.$list.data("ui-listSelectable")&&this.$list.listSelectable("enable")},_disableSelectable:function(){this.$list.hasClass("tau-dropdownlist_selectable_true")&&this.$list.data("ui-listSelectable")&&this.$list.listSelectable("disable")},"bus dataRendered:last+focus":function(){this._enableSelectable()},"bus dataRendered:last+refresh":function(){this._enableSelectable()},"bus dataRendered:last+blur":function(){this._disableSelectable()},_toggleMode:function(e){e.stopPropagation();var t="full"===this.config.mode?"short":"full";this.fire("refresh",{mode:t})},clearValue:function(e){e.stopPropagation(),this._updateState(null)},defaultValue:function(e){e.stopPropagation(),this._updateState(this.dataToBind.defaultValue)},onItemSelected:function(e){var i=t(e.currentTarget).data();this._updateState(i.id,i)},_updateState:function(t,i){var s=!0;if(this.config.confirmation&&window.confirm&&(s=window.confirm(this.config.confirmation)),s){var a=i?e.clone(i):{};a.id=t,this.fire("updateState",a)}},_resetList:function(){this.$options.show()},_noResults:function(e){e='"'+e+'" not found',this.$noResults?this.$noResults.text(e):this.$noResults=t("<div class='not-found' />").text(e).insertBefore(this.$list),this.$noResults.show()
},_clearNoResults:function(){this.$noResults&&this.$noResults.hide()},_filterDelegate:function(s){var a=s.keyCode;if(a!=jQuery.ui.keyCode.DOWN&&a!=jQuery.ui.keyCode.UP&&a!=jQuery.ui.keyCode.ENTER&&a!=jQuery.ui.keyCode.ESCAPE){if(!this.searchIndex){var l=[];this.searchIndex=new i,this.$options.each(function(e,i){l.push({_id:e,data:t(i).text()}),t(this).data("text",t(i).text())}),this.searchIndex.load(l)}var o=this.filterField.val(),n=this.searchIndex.search(o);this.$options.hide();var r=this.$options;e.forEach(n,function(e){var t=r.eq(e._id),i=t.data("text")+"";i=i.substr(0,e.entry.from)+"<em>"+i.substr(e.entry.from,e.entry.len)+"</em>"+i.substr(e.entry.from+e.entry.len,i.length);var s=t.find(".i-role-optiontext");s.length?s.html(i):t.html(i),t.show(),t.parent().show()}),r.filter(":hidden").parent().not(r.filter(":visible").parent()).hide(),o.length?n.length?this._clearNoResults():this._noResults(o):(this._clearNoResults(),this._resetList()),this.$list.data("ui-listSelectable")&&this.$list.listSelectable("reset"),this.fire("choice.editable.filter.changed",{filter:o})}}})});