define(["Underscore","jQuery","tau/core/extension.base","tau/utils/utils.constants","tau/libs/store2/store2"],function(_,$,ExtensionBase,Constants,Store2){return ExtensionBase.extend({_initTemplates:function(configurator){var templateFactory=configurator.getTemplateFactory();templateFactory.register({name:"board.context.filter.members-wiget.autocompleteItem",engine:"jqote2",markup:["<li>",'<a class="tau-item">','<img width="20" height="20" alt="" src="<%= this.avatarUri%>20" />',"<span><%! this.name %></span>","</a>","</li>"]}),templateFactory.register({name:"board.context.filter.members-wiget.selectedItem",engine:"jqote2",markup:["<li class=\"tau-user tau-user-<%! this.type || 'existing' %> i-role-member\">","<% if (this.avatarUri){ %>",'<img width="20" height="20" alt="" src="<%= this.avatarUri%>20" />',"<% } %>","<span><%! this.name %></span>",'<i class="tau-delete i-role-action-delete"></i>',"</li>"]}),templateFactory.register({name:"board.context.filter.members-wiget.popupContent",engine:"jqote2",markup:["<span><%! this.main %></span>",'<div class="tau-message <%! this.type %>"><%! this.sub %></div>']})},_initWidget:function(configurator,$form,entityRestriction){entityRestriction=entityRestriction||"";var templateFactory=configurator.getTemplateFactory(),bt=function(name,data){return templateFactory.get(name).bind({},data)},autocompleteItem=function(item){return item.name=item.name?item.name:_.trim(item.firstName+" "+item.lastName),bt("board.context.filter.members-wiget.autocompleteItem",item)},selectedItem=function(item){return item.name=item.name?item.name:_.trim(item.firstName+" "+item.lastName),item.name||(item.name=item.email),bt("board.context.filter.members-wiget.selectedItem",item)},isEmail=function(val){return val.match(Constants.get("emailRegexp"))},position={offset:"0 15",my:"left top",at:"left bottom",collision:"none"},$widget=$form.find(".i-role-members-widget"),$inp=$widget.find(".i-role-input"),$inpLi=$inp.closest("li"),$helper=$widget.find(".i-role-systemhelper"),$sizer=$widget.find(".i-role-sizer"),$placeholder=$widget.find(".i-role-placeholder"),$bubbled=$widget.tauBubble({template:['<div class="tau-invite-widget-tooltip">','    <div class="i-role-content" role="content">',"    </div>","</div>"].join(""),stackName:"members-widget",showEvent:"nothing",hideEvent:"nothing",onPositionConfig:function(c){return _.extend(c,position)}}),showMessage=function(data){var $content=bt("board.context.filter.members-wiget.popupContent",data);$bubbled.tauBubble("option","content",$content),$bubbled.tauBubble("option","alignTo",$inp),$bubbled.tauBubble("show")},hideMessage=function(){$bubbled.tauBubble("hide")},split=function(val){return _.compact(_.trim(val).split(/[\s,]+/))},resultBubble=function(term){var t=_.last(split(term)),conf;t&&t.length>2?(isEmail(t)?conf={main:"The invitation will be sent to",sub:t,type:"tau-valid"}:conf={main:"There's no one with this name. Please, enter the email address of the person you want to invite.",sub:t+" is invalid email",type:"tau-error"},showMessage(conf)):hideMessage()},refreshHelper=function(helperVal){helperVal=helperVal||helperVal===""?helperVal:$helper.text().toLowerCase();var inpVal=$inp.val().toLowerCase();if(inpVal&&_.startsWith(helperVal.toLowerCase(),inpVal)){var addVal=helperVal.slice(inpVal.length);$helper.find("s").text(inpVal),$helper.find("span").text(addVal)}else emptyHelper()},emptyHelper=function(){$helper.find("s").text(""),$helper.find("span").text("")},removeDuplicates=function(){var d=[],$ms=$widget.find(".i-role-member");$ms.each(function(k,v){d.push(_.extend($(this).data(),{_id:k}))}),_.forEach(_.groupBy(d,"email"),function(v){_.forEach(_.rest(v),function(vv){$ms.eq(vv._id).remove()})})},getName=function(item){return _.trim(_.asString(item.firstName)+" "+_.asString(item.lastName))||_.trim(item.email)},getHash=function(item){return _.trim(_.asString(item.id)+" "+_.asString(item.email))},syncSize=function(){var maxWidth=$widget.width()-10;$sizer.text($inp.val());var textWidth=$sizer.width();if(textWidth<=$inp.width()-8)return;var left=$inp[0].getBoundingClientRect().left,maxLineWidth=maxWidth-left,w=maxLineWidth;textWidth<maxWidth&&(textWidth<maxLineWidth?w=maxLineWidth:w=maxWidth),$inp.width()!=w&&$inp.width(w)},resetSize=function(){$inp.width("10")},processInput=function(){var val=_.trim($inp.val()),vals=split(val),wrongs=[],$ms=$widget.find(".i-role-member"),d=[];$ms.each(function(k,v){d.push($(this).data("email"))}),_.forEach(vals,function(val){if(isEmail(val)){var item={id:null,email:val,firstName:null,lastName:null,login:val,type:"invited",state:"notconfirmed"};item.name=getName(item),item.hash=getHash(item);if(_.indexOf(d,item.email)==-1){var $li=selectedItem(item).data(item);$inpLi.before($li)}}else wrongs.push(val)}),$inp.val(wrongs.join(" ")),$inp.focus(),emptyHelper(),hideMessage()},getRealIds=function(){var $ms=$widget.find(".i-role-member"),d=[];return $ms.each(function(k,v){d.push($(this).data("id"))}),_.compact(d)};$widget.on("click",function(){$inp.focus()}),$widget.on("click",".i-role-action-delete",function(){$(this).closest("li").remove()}),$inp.on("input",function(){$placeholder.hide()}),$inp.focusin(function(){hideMessage()}),$inp.focusout(function(){$inp.val()==""&&$widget.find(".i-role-member").length==0&&$placeholder.show()}),$inp.on("keydown",function(e){var name="";switch(e.which){case $.ui.keyCode.ESCAPE:if($helper.text()!=="")return e.stopPropagation(),e.preventDefault(),!1;break;case $.ui.keyCode.ENTER:name="enter";if($inp.val()==="")return;e.stopPropagation(),e.preventDefault();break;case $.ui.keyCode.BACKSPACE:name="backspace";break;case $.ui.keyCode.SPACE:name="whitespace"}if(name){$inp.trigger("keydown:"+name,e);if(name=="enter")return!1}}),$inp.on("keydown:enter",function(){processInput(),resetSize()}),$inp.on("keydown:whitespace",function(){processInput(),$inp.autocomplete("close"),hideMessage()}),$inp.on("keydown:backspace",function(){$inp.val().length==0&&($inp.closest("li").prev().remove(),resetSize()),hideMessage()}),$inp.on("keyup",function(){refreshHelper(),syncSize()}),$inp.on("paste",function(){setTimeout(function(){processInput(),syncSize()},1)}),$widget.on("process",processInput);var store2=new Store2(configurator);$inp.autocomplete({minLength:2,autoFocus:!0,position:position,source:function(request,next){var term=request.term;if(_.last(term)==" ")return;term=_.last(split(term)),store2.findAll("User?select={"+["id",'"User" as __type',"firstName","lastName","email","login","avatarUri"].join(",")+"}&where=("+' (firstName.startsWith("'+store2.arg(term)+'") '+' OR lastName.startsWith("'+store2.arg(term)+'") '+' OR email.startsWith("'+store2.arg(term)+'")'+") "+entityRestriction+" AND deleteDate == NULL AND isActive == True )").done(function(items){if(items.length){$bubbled.tauBubble("hide"),items=_.map(items,function(v){return v.name=getName(v),v.hash=getHash(v),v}),items=_.sortBy(items,function(v){return(_.startsWith(v.name.toLowerCase(),term.toLowerCase())?"0":"1")+v.name});var realIds=getRealIds();items=_.reject(items,function(item){return _.contains(realIds,item.id)})}else $inp.autocomplete("close"),resultBubble(term);next(items)}).fail(function(){})},focus:function(e,ui){var item=ui.item;return refreshHelper(getName(item)),!1},select:function(event,ui){var item=ui.item,$li=selectedItem(item).data(item);return $inpLi.before($li),$inp.val(""),emptyHelper(),hideMessage(),removeDuplicates(),event.stopPropagation(),!1},close:function(){emptyHelper()}}),$inp.data("autocomplete")._renderItem=function(ul,item){return autocompleteItem(item).data("item.autocomplete",item).appendTo(ul)},$inp.data("autocomplete")._renderMenu=function(ul,items){$(ul).addClass("tau-existing-user-tooltip").css("maxHeight",$(window).height()*.5);var that=this;$.each(items,function(index,item){that._renderItem(ul,item)})},$inp.data("autocomplete").menu.element.bind("menublur",function(){emptyHelper()}),$form.on("reset",function(){setTimeout(function(){var $members=$form.find(".i-role-member");$members.remove()},1)})}})})