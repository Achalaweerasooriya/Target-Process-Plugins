define(["jQuery","Underscore","tau/components/extensions/property/extension.lightweight.richeditor.base"],function(e,t,i){var o="teststep-editor";return i.extend({category:"edit",editorRoleSelector:".i-role-editable",activeEditorRoleSelector:".i-role-editable:not(.disable)",editorRoleClassName:"i-role-editable",itemRoleSelector:".i-role-teststep",removeRoleSelector:".i-role-remove",testCaseDescriptionSelector:".test-case-description_colom",testStepListSelector:".test-case-description",editorDisableClass:"disable","bus afterRender":function(i,r){this._super(i,r);var s=r.element,n=this;this.$element=s,this.fire("activeRow",null),e(this.activeEditorRoleSelector,s).attr("contenteditable",!0),s.on("click."+o,n.editorRoleSelector,function(){var i,o=e(this),r=o.hasClass(n.editorDisableClass),s={editor:o};r&&(i=[function(t){e(t).focus()}],t.extend(s,{editorIndex:o.closest(n.testCaseDescriptionSelector).index(),insertStep:"above",focusOnNewStep:!0})),n._setFocusToEditor(s,i)}),s.on("blur."+o+" focus."+o,n.activeEditorRoleSelector,this._onFocusChange.bind(this,s)),s.on("keydown."+o,n.editorRoleSelector,function(t){if(t.keyCode!=e.ui.keyCode.TAB||t.shiftKey)if(t.keyCode==e.ui.keyCode.ENTER&&(t.ctrlKey||t.metaKey||(t.ctrlKey||t.metaKey)&&t.shiftKey)){var i=e(t.target).closest(n.itemRoleSelector).find(n.editorRoleSelector).first();n._changeFocusHandler({editor:i,focusOnNewStep:!0,insertStep:t.shiftKey?"above":"below",includeRunOrder:!0})}else t.keyCode==e.ui.keyCode.DELETE&&(t.ctrlKey||t.metaKey)&&n._removeTestStep(e(t.target));else{t.preventDefault();var o=e(n.editorRoleSelector,s),r=o.index(this),i=o.eq(r+1);n._changeFocusHandler({editor:i,insertStep:"above",focusOnNewStep:i.hasClass(n.editorDisableClass)})}}),s.on("click."+o,n.removeRoleSelector,function(t){n._removeTestStep(e(this));var i=e(t.currentTarget);i.attr("tabindex",0),i.focus()}),s.on("mousedown."+o,n.testCaseDescriptionSelector,function(t){var i=e(this).children().first(),o=t.srcElement||t.target;o==e(this).get(0)&&(t.preventDefault(),i.focus())
}),this.fire("availableForAdding")},_unbindHandlers:function(e){this._super(e),e.off(o)},_removeTestStep:function(e){var t=e.closest(this.itemRoleSelector).first();t.find(this.editorRoleSelector).addClass(this.editorDisableClass),this._removeHandler(t)},_getComponentSelector:function(){return this.editorRoleSelector},_onFocusChange:function(e,t){"focusin"==t.type?this._onFocusIn(e,t):this._onFocusOut(e,t)},_onFocusIn:function(t,i){var o=e(i.currentTarget);this._cleanSavedFocusOutEvent(),this._setFocusToEditor({editor:o},[function(){this._initializeEditor(o)}])},_cleanSavedFocusOutEvent:function(){this.fire("focus.out",null)},_onCreate:function(e){this._super(e),this._toggleFullPreviewMode(this.$element,!1);var t=this._getCkEditor(e);this._setCaretToEnd(t),this._setFocus(t,e[0])},_setCaretToEnd:function(e){var t=new CKEDITOR.dom.range(e.document);t.moveToElementEditEnd(e.editable()),t.select(),t.scrollIntoView()},_setFocus:function(e,t){e.focusManager.focus({$:t})},_onCKEditorBlur:function(e){this._toggleFullPreviewMode(this.$element,!0),this._destroyEditor(e),this.fire("ckeditor.blur",e[0])},_destroyEditor:function(e){e.data("ui-richeditor")&&e.richeditor("destroy")},_onFocusOut:function(t,i){var o=e(i.currentTarget);this.fire("model.record.update",this._createModelItem(this._getTestStepDOMElement(o))),this._hasLostFocus(t,i)&&this.fire("focus.out",o[0])},"bus ckeditor.blur + focus.out:last":function(e,t,i){t===i&&this.fire("activeRowChanged",null)},"bus test.step.order.changed":function(e,t){this.fire("model.record.update",this._createModelItem(t.teststep,!0)),this.fire("sync.model")},"bus activeRow:last + activeRowChanged":function(e,t,i){t&&this._highlightRow(t,!1),i&&this._highlightRow(i,!0),this.fire("activeRow",i),this.fire("sync.model")},"bus activeRow:last + activeEditorChanged":function(e,t,i){var o=this._getTestStepDOMElement(i);t&&this._sameDOMElements(t,o)||this.fire("activeRowChanged",o)},"bus addRow":function(t,i){var o="above"==i.insertRow?i.newRow.insertBefore(i.currentRow):i.newRow.insertAfter(i.currentRow);
o.hide(),o.addClass("highlight").find(this.removeRoleSelector).removeClass("hidden");var r=e(this.editorRoleSelector,o).removeClass(this.editorDisableClass).attr("contentEditable","true");i.currentRow.removeClass("highlight"),this.fire("model.record.update",this._createModelItem(i.newRow,i.includeRunOrder));var s=e.Deferred();this.fire("sync.model",{syncedDeferred:s}),s.done(this._addRowSucceeded.bind(this,o,i,r))},_addRowSucceeded:function(e,t,i){t.currentRow.removeClass("highlight"),e.show(),t.rowAddedDeferred.resolve(i.eq(t.editorIndex?t.editorIndex:0))},"bus try.addRow":function(e,t){var i=t.editor.closest(this.itemRoleSelector),o=this.itemRoleSelector+":last",r=this.$element.find(o).clone().find(this.editorRoleSelector).empty().end();this.fire("activeRowChanged",i),this.fire("addRow",{currentRow:i,newRow:r,rowAddedDeferred:t.rowAddedDeferred,insertRow:t.insertStep,editorIndex:t.editorIndex,includeRunOrder:t.includeRunOrder})},"bus activeRow:last + model.item.removed":function(e,t,i){t&&this._sameDOMElements(t,i)&&this.fire("activeRow",null),i.remove()},"bus model.item.added":function(e,t){t.element.attr("data-id",t.id)},_hasLostFocus:function(t,i){return 0==e(t).has(i.relatedTarget).length||!i.relatedTarget||!e(i.relatedTarget).hasClass(this.editorRoleClassName)},_sameDOMElements:function(e,t){return e.get(0)==t.get(0)},_getTestStepDOMElement:function(t){return e(t).closest(this.itemRoleSelector).first()},_createModelItem:function(t,i){var o=e(this.editorRoleSelector,t),r={element:t,record:{id:t.data("id")||void 0,description:o.eq(0).html(),result:o.eq(1).html(),__type:"testStep"}};return i&&(r.record.runorder=t.closest(this.testStepListSelector).find(this.itemRoleSelector).index(t)+1),r},_highlightRow:function(e,t){e.toggleClass("active highlight",t)},"bus availableForAdding > highlightAddNewTestStep":function(i,o,r){var s=e.Deferred();this.fire("try.addRow",t.extend({},r.config,{rowAddedDeferred:s})),s.done(r.setFocus),s.always(this.fire.bind(this,"availableForAdding"))
},_removeHandler:t.throttle(function(e){this.fire("model.remove",{element:e,record:{id:e.data("id")}})},250,{leading:!1}),_changeFocusHandler:t.throttle(function(e){e.focusOnNewStep?this.fire("highlightAddNewTestStep",{config:e,setFocus:function(e){e.focus()}.bind(this)}):e.editor.focus()},200,{trailing:!1}),_setFocusToEditor:function(e,i){var o=function(e){this.fire("activeEditorChanged",e),i&&t.isArray(i)&&t.each(i,function(i){t.isFunction(i)&&i.apply(this,e)}.bind(this))}.bind(this);e.focusOnNewStep?this.fire("highlightAddNewTestStep",{config:e,setFocus:o}):o(e.editor)}})});