define(["jQuery","Underscore","tau/components/extensions/property/extension.lightweight.richeditor.base"],function(e,t,o){var i="teststep-editor";return o.extend({category:"edit",editorRoleSelector:".i-role-editable",activeEditorRoleSelector:".i-role-editable:not(.disable)",editorRoleClassName:"i-role-editable",itemRoleSelector:".i-role-teststep",removeRoleSelector:".i-role-remove",testCaseDescriptionSelector:".test-case-description_colom","bus afterRender":function(o,r){this._super(o,r);var s=r.element,n=this;this.$element=s,this.fire("activeRow",null),e(this.activeEditorRoleSelector,s).attr("contenteditable",!0),s.on("click."+i,n.editorRoleSelector,function(){var o,i=e(this),r=i.hasClass("disable"),s={editor:i};r&&(o=[function(t){e(t).focus()}],t.extend(s,{editorIndex:i.closest(n.testCaseDescriptionSelector).index(),insertStep:"above",focusOnNewStep:!0})),n._setFocusToEditor(s,o)}),s.on("blur."+i+" focus."+i,n.activeEditorRoleSelector,this._onFocusChange.bind(this,s)),s.on("keydown."+i,n.editorRoleSelector,function(t){if(t.keyCode!=e.ui.keyCode.TAB||t.shiftKey){if(t.keyCode==e.ui.keyCode.ENTER&&(t.ctrlKey||t.metaKey||(t.ctrlKey||t.metaKey)&&t.shiftKey)){var o=e(t.target).closest(n.itemRoleSelector).find(n.editorRoleSelector).first();n._changeFocusHandler({editor:o,focusOnNewStep:!0,insertStep:t.shiftKey?"above":"below",includeRunOrder:!0})}else if(t.keyCode==e.ui.keyCode.DELETE&&(t.ctrlKey||t.metaKey)){var i=e(t.target).closest(n.itemRoleSelector).first();n._removeHandler(i)}}else{t.preventDefault();var r=e(n.editorRoleSelector,s),l=r.index(this),o=r.eq(l+1);n._changeFocusHandler({editor:o,insertStep:"above",focusOnNewStep:o.hasClass("disable")})}}),s.on("click."+i,n.removeRoleSelector,function(t){var o=e(t.currentTarget);o.attr("tabindex",0),o.focus();var i=e(this).closest(n.itemRoleSelector).first();n._removeHandler(i)}),s.on("mousedown."+i,n.testCaseDescriptionSelector,function(t){var o=e(this).children().first(),i=t.srcElement||t.target;i==e(this).get(0)&&(t.preventDefault(),o.focus())
})},_unbindHandlers:function(e){this._super(e),e.off(i)},_getComponentSelector:function(){return this.editorRoleSelector},_onFocusChange:function(e,t){"focusin"==t.type?this._onFocusIn(e,t):this._onFocusOut(e,t)},_onFocusIn:function(t,o){var i=e(o.currentTarget);this._cleanSavedFocusOutEvent(),this._setFocusToEditor({editor:i},[function(){this._initializeEditor(i)}])},_cleanSavedFocusOutEvent:function(){this.fire("focus.out",null)},_onCreate:function(e){this._super(e),this._toggleFullPreviewMode(this.$element,!1);var t=this._getCkEditor(e);this._setCaretToEnd(t),this._setFocus(t,e[0])},_setCaretToEnd:function(e){var t=new CKEDITOR.dom.range(e.document);t.moveToElementEditEnd(e.editable()),t.select(),t.scrollIntoView()},_setFocus:function(e,t){e.focusManager.focus({$:t})},_onCKEditorBlur:function(e){this._toggleFullPreviewMode(this.$element,!0),this._destroyEditor(e),this.fire("ckeditor.blur",e[0])},_destroyEditor:function(e){e.data("ui-richeditor")&&e.richeditor("destroy")},_onFocusOut:function(t,o){var i=e(o.currentTarget);this.fire("model.record.update",this._createModelItem(this._getTestStepDOMElement(i))),this._hasLostFocus(t,o)&&this.fire("focus.out",i[0])},"bus ckeditor.blur + focus.out:last":function(e,t,o){t===o&&this.fire("activeRowChanged",null)},"bus test.step.order.changed":function(e,t){this.fire("model.record.update",this._createModelItem(t.teststep,!0)),this.fire("sync.model")},"bus activeRow:last + activeRowChanged":function(e,t,o){t&&this._highlightRow(t,!1),o&&this._highlightRow(o,!0),this.fire("activeRow",o),this.fire("sync.model")},"bus activeRow:last + activeEditorChanged":function(e,t,o){var i=this._getTestStepDOMElement(o);t&&this._sameDOMElements(t,i)||this.fire("activeRowChanged",i)},"bus activeRow:last + addRow":function(t,o,i){var r="above"==i.insertRow?i.newRow.insertBefore(i.currentRow):i.newRow.insertAfter(i.currentRow);r.addClass("highlight").find(this.removeRoleSelector).removeClass("hidden");var s=e(this.editorRoleSelector,r).removeClass("disable").attr("contentEditable","true").empty();
i.currentRow.removeClass("highlight"),this.fire("model.record.update",this._createModelItem(i.newRow,i.includeRunOrder)),this.fire("sync.model"),i.callback.resolve(s.eq(i.editorIndex?i.editorIndex:0))},"bus activeRow:last + try.addRow":function(e,t,o){var i=o.editor.closest(this.itemRoleSelector),r=this.itemRoleSelector+":last",s=this.$element.find(r).clone();this.fire("activeRowChanged",i),this.fire("addRow",{currentRow:i,newRow:s,callback:o.callback,insertRow:o.insertStep,editorIndex:o.editorIndex,includeRunOrder:o.includeRunOrder})},"bus activeRow:last + model.item.removed":function(e,t,o){t&&this._sameDOMElements(t,o)&&this.fire("activeRow",null),o.remove()},"bus model.item.added":function(e,t){t.element.attr("data-id",t.id)},_hasLostFocus:function(t,o){return 0==e(t).has(o.relatedTarget).length||!o.relatedTarget||!e(o.relatedTarget).hasClass(this.editorRoleClassName)},_sameDOMElements:function(e,t){return e.get(0)==t.get(0)},_getTestStepDOMElement:function(t){return e(t).closest(this.itemRoleSelector).first()},_createModelItem:function(t,o){var i=e(this.editorRoleSelector,t),r={element:t,record:{id:t.data("id")||void 0,description:i.eq(0).html(),result:i.eq(1).html(),__type:"testStep"}};return o&&(r.record.runorder=t.index(".i-role-teststep")+1),r},_highlightRow:function(e,t){e.toggleClass("active highlight",t)},_highlightAddNewTestStep:function(o){var i=e.Deferred();return this.fire("try.addRow",t.extend(o,{callback:i})),i.promise()},_removeHandler:t.throttle(function(e){this.fire("model.remove",{element:e,record:{id:e.data("id")}})},250,{leading:!1}),_changeFocusHandler:t.throttle(function(e){e.focusOnNewStep?this._highlightAddNewTestStep(e).done(function(e){e.focus()}):e.editor.focus()},200,{leading:!1}),_setFocusToEditor:function(e,o){var i=function(e){this.fire("activeEditorChanged",e),o&&t.isArray(o)&&t.each(o,function(o){t.isFunction(o)&&o.apply(this,e)}.bind(this))}.bind(this);e.focusOnNewStep?this._highlightAddNewTestStep(e).done(i):i(e.editor)}})});