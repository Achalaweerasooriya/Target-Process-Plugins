define(["Underscore","jQuery","tau/core/extension.base","tau/ui/templates/testStepRunList/ui.template.testStepRun.switch","tau/ui/templates/testStepRunList/ui.template.testStepRun.status","tau/ui/templates/testStepRunList/ui.template.testStepRun.active"],function(t,e,i,s,n,a){return i.extend({category:"edit",testPlanRun:null,element:null,"bus afterInit":function(t,e){this.fire("stateSelectionShown",null);var i=e.config.store,s=e.config.context.entity;i.get(s.entityType.name,{id:s.id,fields:[{testplanrun:["id",{entitystate:["isFinal"]}]}]}).done({success:function(t){this.testPlanRun=t[0].data.testplanrun,this.fire("init.finished")},scope:this})},"bus init.finished + afterRender":function(t,i,s){this.element=s.element;var n=this;this.testPlanRun.entitystate.isFinal?this.element.find(".i-role-status").attr("disabled","disabled"):(this.element.on("click",".test-case-run-description_colom .i-role-status",function(){if("notrun"!=e(this).attr("data-result")){n.fire("changeStatus");var t=n._$renderSwitch("passed"==e(this).attr("data-result"));t.hide(),e(this).after(t),t.show(100),e("button",t).first().focus(),n.fire("stateSelectionShown",t)}}),this.element.on("click",".i-role-switch .i-role-switch-btn",function(){var t=e(this);t.hasClass("active")||n.fire("model.update.status",n._createModelItem(t))}),this.element.on("click",".i-role-set-status",function(){n.fire("model.set.status",n._createModelItem(e(this)))}),this.element.on("blur",".test-case-run-description_colom  .i-role-switch",function(t){t.relatedTarget&&e(t.relatedTarget).hasClass("i-role-switch-btn")||n.fire("changeStatus")}),this.fire("highlightActiveElement")),this.element.on("click mousedown","a:not(.i-role-fullview)",function(t){t.preventDefault(),t.stopPropagation(),"click"==t.type&&window.open(this.href)})},"bus stateSelectionShown:last + changeStatus":function(t,e){this._$removeSwitch(e)},"bus highlightActiveElement":function(){e(".i-role-teststep.active",this.element).removeClass("active");var t=this.element.find('[data-result="notrun"]').first();
t.closest(".i-role-teststep").addClass("active"),t.replaceWith(a.get().bind())},"bus model.did.update":function(t,e){var i=this.element.find('[data-id="'+e.id+'"] .i-role-state'),s=i.data("result"),n=e.passed?"passed":"failed";i.data("result",n),s&&i.find(".i-role-switch").trigger("blur"),this._updateElementState(i,n),this.fire("highlightActiveElement")},_createModelItem:function(t){return{id:this._getTestStepRunId(t),passed:t.data("result")}},_updateElementState:function(t,i){e(t).html(this._$renderStatus("passed"==i))},_getTestStepRunId:function(t){return t.closest(".i-role-teststep").data("id")},_$renderSwitch:function(t){return s.get().bind(null,{passed:t})},_$renderStatus:function(t){return n.get().bind(null,{passed:t,runned:!0})},_$removeSwitch:t.throttle(function(t){t&&t.hide(100,function(){t.remove()})},200,{leading:!1})})});