define(["tau/core/extension.base","tau/ui/templates/testStepRunList/ui.template.testStepRun.switch","tau/ui/templates/testStepRunList/ui.template.testStepRun.status","tau/ui/templates/testStepRunList/ui.template.testStepRun.active"],function(t,e,i,s){return t.extend({category:"edit",testPlanRun:null,element:null,activeElementMarkup:s.get().bind(null),"bus afterInit":function(t,e){this.fire("stateSelectionShown",null);var i=e.config.store,s=e.config.context.entity;i.get(s.entityType.name,{id:s.id,fields:[{testplanrun:["id",{entitystate:["isFinal"]}]}]}).done({success:function(t){this.testPlanRun=t[0].data.testplanrun,this.fire("init.finished")},scope:this})},"bus init.finished + afterRender":function(t,e,i){this.element=i.element;var s=this;this.testPlanRun.entitystate.isFinal?this.element.find(".i-role-status").attr("disabled","disabled"):(this.element.on("click",".test-case-run-description_colom .i-role-status",function(){if("skipped"!=$(this).attr("data-result")){s.fire("changeStatus");var t=s._$renderSwitch("passed"==$(this).attr("data-result"));t.hide(),$(this).after(t),t.show(100),$("button",t).first().focus(),s.fire("stateSelectionShown",t)}}),this.element.on("click",".i-role-switch .i-role-switch-btn",function(){var t=$(this);t.hasClass("active")||s.fire("model.update.status",s._createModelItem(t))}),this.element.on("click",".i-role-set-status",function(){s.fire("model.set.status",s._createModelItem($(this)))}),this.element.on("blur",".test-case-run-description_colom  .i-role-switch",function(t){t.relatedTarget&&$(t.relatedTarget).hasClass("i-role-switch-btn")||s.fire("changeStatus")}),this.fire("highlightActiveElement")),this.element.on("click mousedown","a:not(.i-role-fullview)",function(t){t.preventDefault(),t.stopPropagation(),"click"==t.type&&window.open(this.href)})},"bus stateSelectionShown:last + changeStatus":function(t,e){this._$removeSwitch(e)},"bus highlightActiveElement":function(){$(".i-role-teststep.active",this.element).removeClass("active");var t=this.element.find('[data-result="skipped"]').first();
t.closest(".i-role-teststep").addClass("active"),t.replaceWith(this.activeElementMarkup)},"bus model.did.update":function(t,e){var i=this.element.find('[data-id="'+e.id+'"] .i-role-state'),s=i.data("result"),n=e.passed?"passed":"failed";i.data("result",n),s&&i.find(".i-role-switch").trigger("blur"),this._updateElementState(i,n),this.fire("highlightActiveElement")},_createModelItem:function(t){return{id:this._getTestStepRunId(t),passed:t.data("result")}},_updateElementState:function(t,e){$(t).html(this._$renderStatus("passed"==e))},_getTestStepRunId:function(t){return t.closest(".i-role-teststep").data("id")},_$renderSwitch:function(t){return e.get().bind(null,{passed:t})},_$renderStatus:function(t){return i.get().bind(null,{passed:t,runned:!0})},_$removeSwitch:_.throttle(function(t){t&&t.hide(100,function(){t.remove()})},200,{leading:!1})})});