define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/ui/templates/comments/ui.template.comments.comment"],function(_,$,ExtensionBase,commentTemplate){var commentsExtension=ExtensionBase.extend({category:"edit",destroy:function(){var self=this;self.destroyDynamicComponents(),self._super()},destroyDynamicComponents:function(){var self=this;self.commentListComponent&&(self.commentListComponent.destroy(),delete self.commentListComponent)},"bus dataBind+afterRender":function(evtArgs){var self=this;self.destroyDynamicComponents();var commentsData={comments:evtArgs.dataBind.data.items},$element=this.element=evtArgs.afterRender.data.element,selector=".ui-all-comments",$commentListElementToApply=$element.find(selector),config={components:{type:"commentList"},context:this.config.context};self.createComponents(config,function(componentsData){self.commentListComponent=componentsData[0].component;var applyConfig={element:$commentListElementToApply,data:commentsData,config:config};self.commentListComponent.fire("applyTo",applyConfig)})},getGUIDSelector:function(guid){return"guid-comment-"+guid},getCommentIdClass:function(id){return"comment-id-"+id},"bus prepareUpdate":function(evt){var cmd=evt.data.cmd,$targetComment=null,parentId=cmd.config.$set.parentId,containerSelector=".ui-all-comments"+(parentId?" ."+this.getCommentIdClass(parentId)+" .ui-comments":""),guidClass=this.getGUIDSelector(cmd.guid);if(!cmd.config.id)$targetComment=$("<div class='ui-comment "+guidClass+"'><div class='ui-comment-body'>Adding new comment. Please wait...</div></div>").appendTo(this.element.find(containerSelector));else{var idCssClass=this.getCommentIdClass(cmd.config.id);$targetComment=this.element.find(".ui-all-comments ."+idCssClass)}this.fire("markElementToBeUpdated",{element:$targetComment})},"bus applyUpdate":function(evt){var self=this,cmd=evt.data.cmd,guid=cmd.guid,idCssClass=this.getCommentIdClass(evt.data.id);if(!cmd.config.id){var guidClass=this.getGUIDSelector(guid),$targetCommentElement=this.element.find(".ui-all-comments").find("."+guidClass);$targetCommentElement.addClass(idCssClass).removeClass(guidClass)}this.on("afterRender",function(evt){evt.removeListener();var $comments=evt.data.element,$updatedComment=$comments.find("."+idCssClass+" > .ui-comment-body");self.fire("updateElement",{element:$updatedComment})}),this.fire("refresh")},"bus prepareRemove":function(evt){var cmd=evt.data.cmd,idCssClass=this.getCommentIdClass(cmd.config.id),$comment=this.element.find(".ui-all-comments ."+idCssClass);this.fire("markElementToBeDeleted",{element:$comment})},"bus applyRemove":function(evt){var self=this,cmd=evt.data.cmd,idCssClass=this.getCommentIdClass(cmd.config.id),$comment=this.element.find(".ui-all-comments ."+idCssClass);this.fire("deleteElement",{element:$comment,callback:function(){self.fire("refresh")}})}});return commentsExtension})