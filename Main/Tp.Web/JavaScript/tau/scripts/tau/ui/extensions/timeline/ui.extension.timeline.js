define(["Underscore","tau/components/board.timeline/controllers/controller.timeline","tau/core/extension.base"],function(e,i,t){return t.extend({resetLifecycle:!0,init:function(t,n,d){this._super.apply(this,arguments),this._model=n,this._timelineAxesModelRegistry=d.axesModel,this._timelineViewRegistry=d.view,this._model.onPageChanged.add(function(i){this.fire("page.changed",e.deepClone(i.page))}.bind(this)),this._model.onZoomLevelChanged.add(this.fire.bind(this,"model.zoomLevelChanged")),this._model.onSliceInfoRetrieved.add(this.fire.bind(this,"model.sliceInfo.retrieved")),this._model.onBoardPagingSettingsRetrieved.add(this.fire.bind(this,"board.paging.settings")),this._model.onAcidReady.add(this.fire.bind(this,"acid.ready")),this._model.onBoardConfigurationReady.add(this.fire.bind(this,"board.configuration.ready")),this._model.onViewModeReady.add(this.fire.bind(this,"viewMode.ready")),this._model.onDefinitionReady.add(this.fire.bind(this,"definition.ready")),this._model.onPageReady.add(this.fire.bind(this,"page.ready")),this._model.onBoardDefinitionReady.add(this.fire.bind(this,"board.definition.ready")),this._model.onBoardDefinitionReady.add(function(e,i){taus.track({"@":["open-board-action"],boardSettings:i,definition:e})}),this._model.onSliceReady.add(this.fire.bind(this,"slice.ready")),this._model.onCardLayoutFactoryReady.add(this.fire.bind(this,"cardLayoutFactory.ready")),this._timelineViewRegistry.onOpenCardViewRequired.add(function(e){this.fire("view.load.cardDetails",e)}.bind(this)),this._timelineViewRegistry.onBeforeUpdateCell.add(function(e){this.fire("view.cell.skeleton.element.beforeUpdate",e)}.bind(this)),this._timelineViewRegistry.onAfterUpdateCell.add(function(e){this.fire("view.cell.skeleton.element.afterUpdate",e),this.fire("view.cell.skeleton.built",{element:e.cell,data:e.dataItem})}.bind(this)),this._translateViewEvents(),this._timelineController=new i(n,d),this._timelineController.rendered.add(this.fire.bind(this,"ruler.view.afterRender")),this._timelineController.error.add(this.fire.bind(this,"error")),this._timelineController.hintHide.add(this.fire.bind(this,"hint.hide")),this._timelineController.cardUnselect.add(this.fire.bind(this,"card.unselect")),this._timelineController.viewTimelineTracksCountChanged.add(this.fire.bind(this,"view.timeline.tracks.count.changed"))},_translateEvent:function(i,t){var n=i.result;n.$cell.data("istimeline")||this.fire("view.cell.skeleton.updated",{element:n.$cell}),this.fire("selection.reapply",{}),e.each(n.cards,function(e,i){var t=n.dataItems[i];this.fire("view.card.skeleton.built",{element:e,data:{id:t.id,type:t.type}})}.bind(this));var d=t();this.fire("operation.execute.done",{operation:i.operation,dataItems:e.pluck(n.dataItems,"data"),affected$CellsArray:d,cards:n.cards})},_translateViewEvents:function(){this._timelineViewRegistry.onCellUpdated.add(function(e){this._translateEvent(e,function(){return[e.result.$cell]})}.bind(this)),this._timelineViewRegistry.onAxisUpdated.add(function(i){this._translateEvent(i,function(){var t=i.result.$cell,n=t.data("y"),d=[];if("added"===i.operation.name)d.push(t);else{var r=t.closest(".i-role-board-body").find(".i-role-grid .i-role-cell").filter(function(e,i){var t=$(i);return t.data("y")===n});d=e.map(r.toArray(),$)}return d})}.bind(this))},destroy:function(){this._timelineController.destructor()},"bus $el.ready:last + view.dom.ready:last + resize.completed":function(e,i){this._timelineController.resize(i)},"bus $el.ready:last + view.dom.ready":function(e,i){this._timelineController.render(i)},"bus model.execute.cell.query":function(e,i){this._model.setQuery(i.query)},"bus board.paging.settings:last + board.paging.settings.retrieve":function(e,i){this.fire("board.paging.settings.retrieved",i)},"bus page.move.to + board.paging.settings:last + boardSettings.ready:last":function(e,i,t,n){this._model.moveToPage(t.page,i.direction,n)},"bus boardSettings.ready:last + page.switched":function(e,i,t){this._model.setPage(i.boardSettings,t)},"bus configurator.ready:last + boardSettings.ready + start.lifecycle":function(e,i,t){this._model.startLifeCycle(i,t.boardSettings)},"bus configurator.ready > slice.ready":function(e,i,t){this._model.onGetSliceInfo(t.slice,i)},"bus slice.ready:last + before_destroy":function(){this.fire("clearError"),this._model.abortCurrentSlice()},"bus slice.ready:last + before_refresh":function(){this.fire("clearError"),this._model.abortCurrentSlice()},"bus model.cells.content.loaded":function(){this._timelineController.onCellsContentLoaded()},"bus build.timeline.cell.skeleton":function(e,i){this._timelineController.onBuildCellSkeleton(i.configurator,i.boardLayout,i.buildCellCommand,i.boardSkeleton,i.timelineWidthDeferred)},"bus build.timeline.axis.skeleton":function(e,i){this._timelineController.onBuildAxisSkeleton(i.configurator,i.boardLayout,i.buildAxisCellCommand,i.boardSkeleton)},"bus timeline.card.batch.move.after":function(i,t){var n=e.chain(t.items).pluck("moves").flatten().value();this._timelineController.onCardsMoved(n,t.options)}})});