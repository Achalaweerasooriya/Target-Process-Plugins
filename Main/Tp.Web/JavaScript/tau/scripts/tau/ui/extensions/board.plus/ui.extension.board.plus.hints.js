define(["Underscore","jQuery","tau/core/extension.base","tau/models/board.customize.units/board.customize.cards.builderSelector","tau/models/board.customize.units/const.card.sizes","tau/ui/templates/board.plus/customized/ui.template.boardplus.default.card.customized"],function(t,e,i,a,n,o){return i.extend({init:function(t){this._super(t),this.builderCardHint=e.Deferred(),this.configurator=t.context.configurator},"bus boardSettings.ready":function(e,i){var a=i.boardSettings;a.get({fields:["zoomLevel"],callback:t.bind(function(t){this.fire("zoomLevel.ready",t.zoomLevel)},this)}),a.unbind({listener:this}),a.bind({fields:["zoomLevel"],listener:this,callback:t.bind(function(t){this.fire("zoomLevel.ready",t.zoomLevel)},this)})},"bus boardSettings.ready:last + destroy":function(t,e){e.boardSettings.unbind({listener:this})},buildCard:function(){},"bus configurator.ready:last + cardLayoutFactory.ready:last + definition.ready + acid.ready:last":function(e,i,s,r,d){var u=new a,l=t.cloneDeep(r);s.getCardLayoutsByTypesAndSize(l.cells.types,n.L).then(function(e){return t.reduce(e,function(t,e,i){return t.types.push({type:i,data:u.build(i,e)}),t.mapLayouts[i]=e,t},{types:[],mapLayouts:{}})}).done(function(t){l.cells.types=t.types,l.global={acid:d};var e={definition:l},a=i.getSliceFactory().create(e);this.buildCard=function(e,n){if(e.on("close",function(){a.abort()}),e.tauBubble("instance")){var s=n.data("cardData"),r=n.data("entityType"),d={dataItem:{id:n.data("id"),orderingValue:n.data("orderingValue"),type:r,data:{cardData:s}},configurator:i,layout:t.mapLayouts[r]};e.tauBubble("option",{alignTo:this.alignTo(n),className:"tau-ui-size-l",content:o.render(d)}),e.tauBubble("show");var u=e.tauBubble("widget");u.addClass("tau-board-lazy-animation"),u.toggleClass("tau-card-v2_final-state",!!s.isFinal);var l={$set:{CardsIds:[s.id]}};a.cardDetails(l).done(function(t){if(d.dataItem=t.data.items[0],d.dataItem){var i=o.render(d);e.tauBubble("option",{content:i}),u.removeClass("tau-board-lazy-animation"),this.fire("showHint",{$card:i})
}else e.tauBubble("hide")}.bind(this))}},this.builderCardHint.resolve()}.bind(this))},"bus configurator.ready:last + $grid.ready":function(t,e,i){i.tauBubble({className:"tau-cardtooltip",showEvent:"nothing",template:['<div class="tau-bubble-board">','<div class="tau-bubble-board__arrow" role="arrow"></div>','<div class="tau-bubble-board__inner tau-container" role="content"></div>',"</div>"].join(""),zIndex:100}),this.fire("$bubbled.ready",i),this.fire("hint.enable",i)},"bus $bubbled.ready:last + sort.started":function(t,e){this._disableHints(e)},"bus configurator.ready:last + $bubbled.ready:last + view.card.batch.move.after":function(e,i,a){t.delay(t.bind(this.fire,this,"hint.enable",a),100)},"bus zoomLevel.ready:last + hint.enable":function(t,e,i){this._enableHints(i,e)},"bus zoomLevel.ready + hint.enable:last":function(t,e,i){this._enableHints(i,e)},"bus hint.enable:last + hint.hide":function(t,e){this._hideHandler(e)},alignTo:function(t){return t},_getCard:function(t){return t},_showHint:function(t,e){var i=this._getCard(e);this.builderCardHint.done(function(){this.buildCard(t,i)}.bind(this))},_showHandler:function(t,i){var a=e(i.currentTarget);clearTimeout(this.timeout);var n=this.safeCallback(this._showHint.bind(this,t,a));this.timeout=setTimeout(n,750)},_hideHandler:function(t){clearTimeout(this.timeout),t.tauBubble("instance")&&t.tauBubble("hide")},_enableHints:function(e,i){this._disableHints(e);var a=this._getHolderClass(i),n=t.bind(this._hideHandler,this,e);e.on("mouseenter.cardHint",a,t.bind(this._showHandler,this,e)),e.on("mouseleave.cardHint",a,n),e.on("mousedown.cardHint",a,function(t){2===t.button&&n()}),e.on("dblclick.cardHint",a,function(){clearTimeout(this.timeout)}.bind(this))},_getHolderClass:function(t){var e=".i-role-card";return 5===t&&(e=".i-role-cellholder.tau-collapsed .i-role-card"),e},_disableHints:function(t){this._hideHandler(t),t.off(".cardHint")}})});