define(["Underscore","jQuery","tau/core/extension.base","tau/models/board.customize.units/board.customize.cards.builderSelector","tau/models/board.customize.units/const.card.sizes","tau/ui/templates/board.plus/customized/ui.template.boardplus.default.card.customized"],function(t,e,a,i,n){return a.extend({init:function(t){this._super(t),this.builderCardHint=e.Deferred(),this.configurator=t.context.configurator},"bus boardSettings.ready":function(e,a){var i=a.boardSettings;i.get({fields:["zoomLevel"],callback:t.bind(function(t){this.fire("zoomLevel.ready",t.zoomLevel)},this)}),i.unbind({listener:this}),i.bind({fields:["zoomLevel"],listener:this,callback:t.bind(function(t){this.fire("zoomLevel.ready",t.zoomLevel)},this)})},buildCard:function(){},"bus configurator.ready:last + cardLayoutFactory.ready:last + definition.ready + acid.ready:last":function(e,a,o,r,d){var s=new i,u=t.cloneDeep(r);o.getCardLayoutsByTypesAndSize(u.cells.types,n.L).then(function(e){return t.reduce(e,function(t,e,a){return t.types.push({type:a,data:s.build(a,e)}),t.mapLayouts[a]=e,t},{types:[],mapLayouts:{}})}).done(function(t){u.cells.types=t.types,u.global={acid:d};var e={definition:u},i=a.getSliceFactory().create(e),n=a.getTemplateFactory().get("board.plus.default.card.customized");this.buildCard=function(e,o){e.on("close",function(){i.abort()});var r=o.data("cardData"),d=o.data("entityType"),s={dataItem:{id:o.data("id"),orderingValue:o.data("orderingValue"),type:d,data:{cardData:r}},configurator:a,layout:t.mapLayouts[d]};if(e.data("ui-tauBubble")){e.tauBubble("option",{alignTo:this.alignTo(o),className:"tau-ui-size-l",content:n.bind({},s)}),e.tauBubble("show");var u=e.tauBubble("widget");u.addClass("tau-board-lazy-animation"),u.toggleClass("tau-card-v2_final-state",!!r.isFinal);var l={$set:{CardsIds:[r.id]}};i.cardDetails(l).done(function(t){s.dataItem=t.data.items[0];var a=n.bind({},s);e.tauBubble("option",{content:a}),u.removeClass("tau-board-lazy-animation"),this.fire("showHint",{$card:a})}.bind(this))
}},this.builderCardHint.resolve()}.bind(this))},"bus configurator.ready:last + $grid.ready":function(t,e,a){a.tauBubble({className:"tau-cardtooltip",showEvent:"nothing",template:['<div class="tau-bubble-board">','<div class="tau-bubble-board__arrow" role="arrow"></div>','<div class="tau-bubble-board__inner tau-container" role="content"></div>',"</div>"].join(""),zIndex:100}),this.fire("$bubbled.ready",a),this.fire("hint.enable",a)},"bus $bubbled.ready:last + sort.started":function(t,e){this._disableHints(e)},"bus configurator.ready:last + $bubbled.ready:last + view.card.batch.move.after":function(e,a,i){t.delay(t.bind(this.fire,this,"hint.enable",i),100)},"bus zoomLevel.ready:last + hint.enable":function(t,e,a){this._enableHints(a,e)},"bus zoomLevel.ready + hint.enable:last":function(t,e,a){this._enableHints(a,e)},"bus hint.enable:last + hint.hide":function(t,e){this._hideHandler(e)},alignTo:function(t){return t},_getCard:function(t){return t},_showHint:function(t,e){var a=this._getCard(e);this.builderCardHint.done(function(){this.buildCard(t,a)}.bind(this))},_showHandler:function(a,i){var n=e(i.currentTarget);clearTimeout(this.timeout),this.timeout=setTimeout(t.bind(this._showHint,this,a,n),750)},_hideHandler:function(t){clearTimeout(this.timeout),t.data("ui-tauBubble")&&t.tauBubble("hide")},_enableHints:function(e,a){this._disableHints(e);var i=this._getHolderClass(a),n=t.bind(this._hideHandler,this,e);e.on("mouseenter.cardHint",i,t.bind(this._showHandler,this,e)),e.on("mouseleave.cardHint",i,n),e.on("mousedown.cardHint",i,function(t){2===t.button&&n()})},_getHolderClass:function(t){var e=".i-role-card";return 5===t&&(e=".i-role-cellholder.tau-collapsed .i-role-card"),e},_disableHints:function(t){this._hideHandler(t),t.off(".cardHint")}})});