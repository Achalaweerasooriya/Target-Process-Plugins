define(["Underscore","jQuery","tau/core/extension.base"],function(_,$,ExtensionBase){return ExtensionBase.extend({"bus configurator.ready + $el.ready":function(e,configurator,$el){var $trigger=$el.find(".i-role-statesetup"),fire=_.bind(this.fire,this);$trigger.on("click",function(){var $trigger=$(this);fire("$stateTrigger.executed",$trigger)}),configurator.getTemplateFactory().register({name:"board.editor.stateSetup.chooseProcess",engine:"jqote2",markup:["<div>","<h3>Please select processes to customize:</h3>",'<div class="tau-buttons">',"<% _.forEach(this.processes, function(v){%>",'<button type="button" class="tau-btn tau-primary" data-id="<%= v.id %>"><%! v.name %></button>',"<% }); %>","</div>","</div>"].join("")})},"bus $form.ready":function(evt,$form){$form.find("[name=x_types], [name=y_types]").each(function(){$(this).parent().find(".i-role-statesetup").toggle($(this).val().toLowerCase()=="entitystate")}),$form.on("change","[name=x_types], [name=y_types]",function(){$(this).parent().find(".i-role-statesetup").toggle($(this).val().toLowerCase()=="entitystate")}),$form.on("_change",function(){$form.find("[name=x_types], [name=y_types]").each(function(){$(this).parent().find(".i-role-statesetup").toggle($(this).val().toLowerCase()=="entitystate")})})},"bus configurator.ready:last + $form.ready:last + $stateTrigger.executed":function(e,configurator,$form,$trigger){var card=$form.find(".tau-board-settings-cards :checkbox:checked").val();card||(card="userstory"),this.fire("card.ready",card),this.getProcess(configurator,$trigger).done(_.bind(function(processId){this.fire("processId.ready",processId)},this))},"bus configurator.ready:last + $stateTrigger.executed:last + card.ready + processId.ready":function(evt,configurator,$trigger,card,processId){var url=configurator.getUrlBuilder().getAdminWorkflowEdit(processId),$frame=$('<iframe class="ui-popup_frame"></iframe>');$trigger.tauPopup(),$trigger.tauPopup("widget").append($frame),$trigger.tauPopup("show"),$trigger.one("taupopuphide",function(){$frame.remove()}),$trigger.tauPopup("widget").tauProgressIndicator(),$trigger.tauPopup("widget").tauProgressIndicator("show"),$frame.css("visibility","hidden"),$frame.attr("src",url),$frame.on("load",function(){var $settings=$(($frame[0].contentDocument||$frame[0].contentWindow.document).body),$s=$settings.find("._entities"),$opt=$s.find("option").filter(function(k,v){return $(v).attr("value").toLowerCase()=="tp.businessobjects."+card.toLowerCase()});$s.val($opt.attr("value")),$s.trigger("change"),setTimeout(function(){$trigger.tauPopup("widget").tauProgressIndicator("hide"),$frame.css("visibility","visible")},100)})},getProcess:function(configurator,$trigger){var def=$.Deferred();return configurator.getAppStateStore().get({fields:["acid"],callback:_.bind(function(result){var acid=result.acid;configurator.getApplicationContextService().getApplicationContext({acid:acid},{success:_.bind(function(context){this.chooseProcess(configurator,$trigger,context.processes).done(def.resolve)},this),failure:_.bind(function(){this.chooseProcess(configurator,$trigger,[]).done(def.resolve)},this)})},this)}),def},chooseProcess:function(configurator,$trigger,processes){var def=$.Deferred(),$c;return processes.length==1?(def.resolve(processes[0].id),def):($c=configurator.getTemplateFactory().get("board.editor.stateSetup.chooseProcess").bind({},{processes:processes}),$trigger.tauBubble({template:['<div class="tau-bubble tau-warning-bubble">','<div class="tau-bubble__arrow"  role="arrow"></div>','<div class="tau-bubble__inner tau-container">','<div role="content">',"</div>","</div>","</div>"].join(""),showOnCreation:!0,content:$c}),$trigger.tauBubble("widget").on("click","button",function(){def.resolve($(this).data("id"))}),def)}})})