define(["Underscore","jQuery","tau/core/extension.base","tau/ui/extensions/inviter/jquery.tauInviter"],function(t,e,i){return i.extend({init:function(t,e,i,o,n,r){return this.model=o,this.configurator=e,this.templateForm=n,this.entity=i,this.$within=r||window,0===this.$within.length&&(this.$within=window),this._super(t)},"bus beforeInit":function(){e.when(this.model.load()).then(t.bind(function(t){this.fire("dataBind",{groups:t})},this))},"bus afterRender":function(i,o){var n=o.element;n.on("click",".i-role-formtrigger",t.bind(function(i){var o=e(i.currentTarget);e.when(this.closeFormAll(n,o)).then(t.bind(this.startEdit,this,o,n))},this)),n.on("click","form",t.bind(function(t){t.stopPropagation()},this)),1==this.model.groups.length&&this.startEdit(n.find(".i-role-formtrigger"),n)},startEdit:function(i,o){return i.hasClass("tau-assignments__group_state_edit")?void this.closeForm(i,i.find("form")):e.when(this.createForm(i,o)).then(t.bind(this.appendFormToGroup,this,i)).then(t.bind(this.handleForm,this,i)).then(this.domModified.bind(this))},domModified:function(){this.fire("dom.modified")},handleForm:function(e,i){i.on("submit",t.bind(function(t){t.preventDefault();var o=this.serializeForm(i);return this.model.processFormData(o),1==this.model.groups.length?(this.fire("complete"),!1):(this.closeForm(e,i),!1)},this))},serializeForm:function(e){var i=e.serializeArray();return i=t.object(t.pluck(i,"name"),t.pluck(i,"value")),i.users=e.find("[name=users]").tauInviter("getValue"),i},createForm:function(i,o){var n=i.data("id"),r=this.model.findGroupById(n),s=this.configurator.getTemplateFactory().get(this.templateForm.name).bind({},{data:{roleId:r.role.id,groupId:r.id,users:r.users}}),a=s.find("[name=users]");return a.tauInviter({configurator:this.configurator,allowEmails:!1,autocompletePosition:{my:"left top",at:"left bottom",collision:"flipfit flipfit",within:this.$within},messagePosition:{my:"left top",at:"left bottom+5",collision:"flipfit flipfit",within:this.$within},bubblesAppendTo:o,processItems:function(e,i,o){var n=function(t){var e=t.projectRoles&&t.projectRoles[0],i=t.teamRoles&&t.teamRoles[0];return(e||i)!==r.role.id},s=function(t,e){return e},a=function(t,i){return t.concat(e(i,o))};return t.chain(i).groupBy(n).sortBy(s).reduce(a,[]).value()}}),a.tauInviter("setValue",r.users),a.on("tauinviterchange",t.bind(function(){s.find(":text").trigger("focus"),this.fire("assignment.editor.saving"),this.model.processFormData(this.serializeForm(s)).then(this.fire.bind(this,"assignment.editor.saved")).then(this.domModified.bind(this))},this)),e.when(this.createAutocompleteQuery()).then(t.bind(function(t){a.length&&a.data("ui-tauInviter")&&a.tauInviter("option",{autocompleteQueryAdd:t.where,autocompleteFieldsQueryAdd:t.select,minLength:0,showLoading:!0,autocompleteTakeQueryAdd:"&take=1000"})},this)),{$form:s,$inviter:a}},createAutocompleteQuery:function(){var i=e.Deferred();return this.configurator.getStore().get(this.entity.entityType.name,{id:this.entity.id,fields:["id",{project:["id"]},{team:["id"]}]}).done(function(e){var o=e[0].data,n=[],r="",s=[],a="";o.project&&o.project.id&&(n.push(t.sprintf("ProjectMembers.Count(project.id==%d) > 0 ",o.project.id)),s.push(t.sprintf("ProjectMembers.Where(Project.Id==%d).Select(Role.id) as projectRoles",o.project.id))),o.team&&o.team.id&&(n.push(t.sprintf("TeamMembers.Count(team.id==%d) > 0",o.team.id)),s.push(t.sprintf("TeamMembers.Where(Team.Id==%d).Select(Role.id) as teamRoles",o.team.id))),n.length&&(r=" AND ("+n.join(" OR ")+")"),s.length&&(a=","+s.join(",")),i.resolve({where:r,select:a})}),i},appendFormToGroup:function(e,i){e.toggleClass("tau-assignments__group_state_edit",!0),e.append(i.$form);var o=i.$form.find(":text");this.domModified();var n=t.debounce(function(){o.data("ui-tauUserAutocomplete")&&o.tauUserAutocomplete("search",o.val())},100);return o.on("focus",n),o.focus(),i.$form},closeForm:function(t,e){e.remove(),t.toggleClass("tau-assignments__group_state_edit",!1),this.domModified()},closeFormAll:function(i,o){i.find(".i-role-group").not(o).each(t.bind(function(t,i){var o=e(i);this.closeForm(o,o.find("form"))},this))}})});