define(["jQuery","Underscore","tau/core/class","tau/ui/extensions/board.plus/card-context-menu/menu-action-item-base","tau/utils/utils.serverErrorTranslator","tau/ui/behaviour/common/ui.behaviour.editableText"],function(e,t,a,n){var i=a.extend({init:function(e,a){var n=this;n.$card=e,n.d=e.data(),n.c=e.closest(".i-role-cellholder").data(),n.externalSettings=a;var i=n.d.entityType,r=n.d.cardData;if(r.hasOwnProperty("name")){var d=t.extend({},r,{__type:i});a.configurator.getStore().register(d)}},fetchFormData:function(){var t=this,a=e.Deferred(),n=t.d.entityType,i=t.d.cardData;return t.externalSettings.configurator.getStore().get(n,{id:i.id,fields:["name"]},{success:a.resolve}).done(),a},saveAndUpdate:function(t){var a=this,n=a.d,i=a.c,r=(a.externalSettings.bus,a.externalSettings.configurator),d=e.Deferred();return d.done(function(){var e=a.$card.find(".i-role-name");e.text(t);var r=a.$card.data("cardData")||{};r.name=t,a.$card.data("cardData",r),a.externalSettings.updateCardAction(n.entityId,i,a.$card.data())}),r.getStore().save(n.entityType,{$set:{id:n.entityId,name:t}}).done({success:d.resolve}),d},suppressDblClick:function(e){e.on("dblclick.contextmenu",function(e){e.preventDefault(),e.stopPropagation()})},cancelSuppressDblClick:function(e){e.off("dblclick.contextmenu")}}),r=i.extend({getEditableCardStyle:function(){return["tau-card"]},getEditableCardInlineStyle:function(){return"font-size:0.813em;min-height:4em;height:4em;overflow:hidden;"},prepareEditableCard:function(){},getBubbleClassname:function(e){return["tau-cardtooltip","tau-cardtooltip_type_"+e]},create:function(){var a=this,n=a.$card,i=a.externalSettings.domWrapper;a.$destroyDefer=e.Deferred(),a.$bubbleShow=e.Deferred(),a.$dataReady=e.Deferred(),e.when(a.$bubbleShow,a.$dataReady).done(function(e,t){t.editableText("activate")});var r=a.d.entityType.toLowerCase(),d=this.getEditableCardStyle(r).join(" "),o=this.getEditableCardInlineStyle(),l=e(['<div class="'+d+'" style="padding: 0 !important;">','   <div style="display:none;"></div>','   <div style="display:none;"></div>','   <div style="padding: 8px 4px 8px 10px">','       <div class="i-role-name" style="'+o+'">Loading...</div>',"   </div>","</div>"].join(""));this.prepareEditableCard(n,l);var s="team"===r||"project"===r?"":"tau-"+r;l.addClass(s).addClass(a.externalSettings.activationCssClass);var c=a;a.fetchFormData().done(function(e){var n=l.find(".i-role-name"),i=t.bind(a.saveAndUpdate,a);n.editableText({enabled:!1,restoreText:!0,onSave:function(e){i(e).fail(t.bind(this.restoreInitialText,this))},onEditEnd:t.bind(function(){var e=this;e.$destroyDefer.resolve()},a)}),n.editableText("setValue",e.data.name),a.suppressDblClick(n),t.defer(function(){n.editableText("enable")}),a.$dataReady.resolve(n)});var u={className:this.getBubbleClassname(r).join(" "),template:['<div class="tau-bubble-board">','<div class="tau-bubble-board__inner tau-container" role="content" style="margin:0 0 0 0;"></div>',"</div>"].join(""),alignTo:n,within:i.board,showEvent:"",hideEvent:"",stackName:"context-menu-action",content:l,onPositionConfig:function(e){return e.my="left top-5",e.at="left top",e.collision="flipfit",e},onShow:a.$bubbleShow.resolve,onHide:function(e){n.css("opacity","");var t=e.find(".i-role-name");c.cancelSuppressDblClick(t),t.data("textEditor").onBlur(),t.editableText("disable")}};a.$bubbleShow.done(function(){n.css("opacity",0)});var b=e(".i-role-card-context-rename-holder");b=b.length?b:e('<div class="i-role-card-context-rename-holder"></div>').appendTo("body"),a.$destroyDefer.done(function(){b.tauBubble("hide")}),e(window).on("scroll",a.$destroyDefer.resolve),i.getGrid().on("scroll",a.$destroyDefer.resolve),b.tauBubble(u).tauBubble("show")}}),d=r.extend({getEditableCardStyle:function(e){return["tau-card-v2","tau-card-v2_type_"+e]},prepareEditableCard:function(e,t){var a=Math.max(e.height(),14),n=Math.max(e.width(),240);t.find(".i-role-name").css({height:a,"min-height":a}),t.css({width:n,"min-width":n})},getEditableCardInlineStyle:function(){return"font-size:0.813em;min-height:10em;height:10em;overflow:hidden;max-width:500px"},getBubbleClassname:function(){return["tau-ui-size-l"]}}),o=function(e,t){var a=t?"enable":"disable";e.data("uiDraggable")&&e.draggable(a)},l=i.extend({create:function(){var a,n=this;o(n.$card,!1),n.fetchFormData().done(t.bind(function(n){var i=this;i.$card.addClass(i.externalSettings.activationCssClass);var r=i.$card.find(".i-role-name");0===r.length&&(r.text(n.data.name),a=e('<div class="tau-card-title-container"><div class="tau-name i-role-name">'+n.data.name+"</div></div>"),i.$card.append(a),r=i.$card.find(".i-role-name")),r=r.eq(0),i.suppressDblClick(r);var d=this,l=t.bind(i.saveAndUpdate,i);r.editableText({enabled:!1,restoreText:!0,onSave:function(e){l(e).fail(t.bind(this.restoreInitialText,this))},onEditEnd:function(){d.cancelSuppressDblClick(r),r.editableText("disable"),r.css("background-color",r.data("color")),i.$card.removeClass(i.externalSettings.activationCssClass),a&&setTimeout(function(){a.remove()},1),o(i.$card,!0)}}),r.editableText("setValue",n.data.name),r.css("background-color",""),t.defer(function(){r.editableText("enable").editableText("activate")})},n))}}),s=["user","project","team","projectmember"];return n.extend({name:"Rename",className:"i-role-card-context-menu-rename",getDisabledEntityTypes:function(){return s},itemClickCallback:function(e){var a=this.settings,n=e.$trigger;a.updateCardAction=t.bind(this.updateCard,this);var i=n.closest(".i-role-cell").hasClass("i-role-clipboard-holder"),r=this.createRenameForm({vm:a.viewMode,zl:a.zoomLevelData.zoomLevel,isInClipboard:i,isCardCollapsed:!i&&n.closest(".i-role-cellholder").hasClass("tau-collapsed")},n,a);r.create()},createRenameForm:function(e,t,a){return e.isInClipboard?new l(t,a):"board"===e.vm&&e.isCardCollapsed?new r(t,a):"timeline"===e.vm?new d(t,a):"board"===e.vm&&e.zl<4||"list"===e.vm&&e.zl<3?new r(t,a):new l(t,a)}})});