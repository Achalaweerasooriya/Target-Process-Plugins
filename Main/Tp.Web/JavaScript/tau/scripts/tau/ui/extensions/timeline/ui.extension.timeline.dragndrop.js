define(["Underscore","jQuery","tau/ui/extensions/board.plus/ui.extension.board.plus.dragndrop.base"],function(e,t,r){var i=function(){return!t(this).parent().is(".i-role-timeline-card-holder")},n=function(e){for(var t=e.currentGroup.find(".i-role-timeline-track"),r=0,i=t.length;i>r;r++){var n=t.eq(r);if(e._within(n,e.cursorPosition))return r}return void 0},s=function(e){return function(t){return e.$card=t,e}},a=function(e){return t(e).tauSortable("instance")},o=r.extend({init:function(e,t){this._timelineViewRegistry=t,this._super(e)},_$containment:function(e){return e},_$sortable:function(e){return e.find(".tau-backlog-body .i-role-cellholder")},_getPlaceholderContentCreator:function(){return function(e,t){return this._timelineViewRegistry._getCellViewByCoords(t.data()).createPlaceholderContent(e)}.bind(this)},unpackMovementResponse:function(t,r){var n=this._super.apply(this,arguments),s=r.getCards();return e.each(n.success,function(e){e.$card=e.$card.add(s.filter('[data-id="'+e.entityId+'"]'))}),e.each(t,function(e){e.$card=e.$card.filter(i),e.moves.forEach(function(t){t.track=e.track})}),n},completeEventsProtocol:function(){this._super(this._$successCardsArray)},_expandEmptyCollapsedCells:function(e,t){return t.$affectedCells=this._$affectedCells,this._super(e,t)},_restoreErrorCardPosition:function(e){this._timelineViewRegistry.clearCardArtifacts(e.$card,e.target)},restoreErrorCardsPositions:function(t){return this._super(t).then(e.each(t,this._restoreErrorCardPosition,this))},_processSuccessCardsPositions:function(r){var i=e.toArray(arguments).slice(1);this._$affectedCells=t();var n=e.filter(i,function(t){var r={x:t.sourceX,y:t.sourceY},i={x:t.targetX,y:t.targetY};return!e.isEqual(r,i)});return n.forEach(function(e){e.$card.each(function(e,i){t(i).detach(),this._timelineViewRegistry.clearCardArtifacts(t(i),r)}.bind(this)),e.moves.forEach(function(e){this._$affectedCells=this._$affectedCells.add(this._timelineViewRegistry._getCellViewByCoords(e)._$cell)}.bind(this))
}.bind(this)),this._$successCardsArray=e.pluck(i,"$card"),n},processCardsPositions:function(r,i,n,a,o){var c=r.success,d=e.map(c,function(e){return t.when(e.$card.length?e.$card:n.renderCardAsHtml(e.moves[0].dataItem)).then(s(e))});return t.when.apply(t,d).then(this._processSuccessCardsPositions.bind(this,i)).then(function(e){var t=this._getAnimationOptions(a,c);"Rank"!=this._ordering&&(r.success=e),this.fire("timeline.card.batch.move.after",{items:r.success,options:t}),r.success=[]}.bind(this)).then(function(){return this._super(r,i,n,a,o)}.bind(this))},_get$selectable:function(e){return e.find(".i-role-selectable")},_$getSelectableByCard:function(e){return e.parents(".i-role-selectable")},"bus ordering.refresh":function(e,t){this._ordering=t.cells.ordering?t.cells.ordering.name:null},"bus sort.started:last + sort.groupchanged":function(t,r,i){var s=i[1],o=a(r[1].sender),c=n(o);e.isUndefined(c)?s.item.removeData("track"):s.item.data("track",c);var d={track:c,at:o.cursorPosition};this._timelineViewRegistry.moveCard(s.item,s.groupFrom.data(),s.groupTo.data(),d),this.fire("view.card.group.changed")},"bus sort.changed":function(e,r){var i=r[1],n=a(r[1].sender),s=t(i.item),o={index:i.index,track:t(i.item).data("track"),at:n.cursorPosition};n.currentGroup.find(".i-role-timeline-planner-card-holder:empty").append(s),this._timelineViewRegistry.moveCardToCell(s,n.currentGroup.data(),o)},"bus sort.stopped":function(e,r){var n=r[1];t(n.item).off("drag"),n.isReverted&&n.items.each(function(e,r){var i=t(r),s=i.data("boardDnd")||{};s.target=a(n.sender).currentGroup.data(),i.data("boardDnd",s)});var s=n.items.last().data("track");n.items.filter(i).each(function(e,r){t(r).data("boardDnd").target.track=s}.bind(this)),this._timelineViewRegistry.unlockAllTrackCards(),this._super(e,r)},"bus sort.started":function(e,r){var i=r[1],n=i.helper.parent().find(".tau-timeline-canvas");i.items.filter(function(){return t(this).draggable("instance")}).each(function(){var e=t(this).draggable("instance");
e.scrollParent=n,e.overflowOffset=n.offset()})}});return o});