define(["Underscore","jQuery","tau/core/templates-factory","tau/utils/utils.convertUserName"],function(e,t,i,r){var n={position:{my:"left top",at:"left bottom+5",collision:"none"},rejectUserIdsGetter:function(){return[]},itemRenderer:{_itemTemplate:null,renderItem:function(e){return this._itemTemplate||(this._itemTemplate=i.register({name:"ui.tauUsersAutocomplete.item",engine:"jqote2",markup:["<li>",'<a class="tau-item">','<img width="20" height="20" alt="" src="<%= this.avatarUri%>20" />',"<span><%! this.name %></span>","</a>","</li>"]})),this._itemTemplate.render(e)}},itemLoadingRenderer:{_itemTemplate:null,renderItem:function(e){return this._itemTemplate||(this._itemTemplate=i.register({name:"ui.tauUsersAutocomplete.item.loading",engine:"jqote2",markup:['<li  class="tau-menu-item">','<a class="tau-item tau-loader">',"</a>","</li>"]})),this._itemTemplate.render(e)}}};return t.widget("ui.tauUserAutocomplete",t.ui.autocomplete,{options:{store2:null,minLength:2,autoFocus:!0,showLoading:!1,autocompleteQueryAdd:"",autocompleteFieldsQueryAdd:"",autocompleteTakeQueryAdd:"",position:n.position,delayLoading:250,userTypes:["User"],rejectUserIdsGetter:n.rejectUserIdsGetter,itemRenderer:n.itemRenderer,itemLoadingRenderer:n.itemLoadingRenderer,focus:function(){return!1},source:function(t,i){if(" "!=e.last(t.term)){var r=e.last(e.compact(e.trim(t.term).split(/[\s,]+/)))||"",n=null;this.options.showLoading&&(n=e.delay(function(){i([{isLoading:!0}])},this.options.delayLoading)),this._trigger("found",null,{term:"",items:[]}),this._getData(r).done(e.bind(function(e){e.length?(e=this._processItems(e,r),this._trigger("found",null,{term:r,items:e})):(this.close(),this._trigger("nothing",null,{term:r})),i(e)},this)).fail(function(){i([])}).always(function(){clearTimeout(n)})}}},_create:function(){this._super()},_getData:function(i){var r="?select={"+["id",'"User" as __type',"firstName","lastName","email","login","avatarUri"].join(",")+this.options.autocompleteFieldsQueryAdd+"}&where=("+this._getUserIdsQueryFilter()+'(firstName.startsWith("'+this.options.store2.arg(i)+'")  OR lastName.startsWith("'+this.options.store2.arg(i)+'")  OR email.startsWith("'+this.options.store2.arg(i)+'")) '+this.options.autocompleteQueryAdd+" AND deleteDate == NULL AND isActive == True )"+this.options.autocompleteTakeQueryAdd,n=e.map(this.options.userTypes,function(e){return this.options.store2.findAll(e+r)
},this);return t.when.all(n).then(function(t){return e.flatten(t)})},_getUserIdsQueryFilter:function(){var e=this.options.rejectUserIdsGetter();return e&&e.length>0?"(not (id in ["+e.join(",")+"])) AND ":""},_renderMenu:function(i,r){t(i).addClass("tau-user-autocomplete").css({maxHeight:.5*t(window).height(),zIndex:this.element.zIndex()+1}),e.each(r,e.bind(function(e){this._renderItem(i,e)},this))},_renderItem:function(e,t){var i=t.isLoading?this.options.itemLoadingRenderer:this.options.itemRenderer;return i.renderItem(t).data("ui-autocomplete-item",t).appendTo(e)},_processItems:function(t,i){var n=i.toLowerCase();return e.chain(t).map(e.bind(function(e){return e.name=r.getFullName(e),e},this)).sortBy(function(t){var i=t.name.toLowerCase();return(e.startsWith(i,n)?"0":"1")+i}).value()}})});