define(["Underscore","jQuery","tau/core/event.emitter"],function(_,$,a){var b=function(a,b){var c=_(a).chain().find(function(a){return a.name===b}).value();return c},c=function(a,b){var c=_(a).chain().select(function(a){return a.name===b}).value();return c},d=function(a,c,d){var e=b(a,c),f=b(a,d);return f.tick-e.tick},e=function(a){var b=a[0],c=a[a.length-1];return c.tick-b.tick},f=function(a){var b=d(a,"initialize","view.skeleton.built"),c=d(a,"model.get.sliceInfo","model.sliceInfo.retrieved");return{client:b-c,server:c,total:b}},g=function(a,b,c,d,e){var f={};for(var g=0;g<a.length;g++){var h=a[g],i=e(h),j=_(b).find(function(a){var b=e(a);return b==i});if(!j)console.log("pair event ["+d+"] is not found for ["+c+"]"),console.log("cell group: "+i);else{var k={id:i,orig:h,pair:j};f[k.id]=k}}return f},h=function(a){var b=_(a).max(function(a){return a}),c=0;_(a).each(function(a){c+=a});var d=c/a.length;return{avg:d.toFixed(2),max:b.toFixed(2),total:c.toFixed(2)}},i=function(a){var d=b(a,"view.cellSlot.built.start"),e=c(a,"view.cellSlot.built"),f=c(a,"view.cell.skeleton.built"),i=d,j=f[f.length-1],k=j.tick-i.tick,l=c(a,"model.get.cell.basicInfo"),m=c(a,"model.cell.basicInfo.retrieved"),n=g(l,m,"model.get.cell.basicInfo","model.cell.basicInfo.retrieved",function(a){return["x",a.data.x,"y",a.data.y].join("")}),o=g(e,f,"view.cellSlot.built","view.cell.skeleton.built",function(a){return["x",a.data.data.x,"y",a.data.data.y].join("")}),p=[],q=[];return _(o).each(function(a,b){var c=a.pair.tick-a.orig.tick,d=n[b],e=0;d.orig.data.hasOwnProperty("x")&&d.orig.data.hasOwnProperty("y")&&(e=d.pair.tick-d.orig.tick,p.push(e));var f=c-e;q.push(f)}),{total:k,client:h(q),server:h(p)}},j=function(a){var b=$("<div></div>");b.width(375),b.height(225),b.empty().append("<p><b>Performance statistics:</b></p>");for(var c=0;c<arguments.length;c++){b.append("<hr />");if(_.isArray(arguments[c]))for(var d=0;d<arguments[c].length;d++)b.append("<p style='padding:1;margin:0;'>"+arguments[c][d]+"</p>");else b.append("<p style='padding:1;margin:0;'>"+arguments[c]+"</p>")}return b};return a.extend({init:function(a){this._super(a),this.expected=0,this.actual=0},"bus model.sliceInfo.retrieved":function(a){var b=a.data,c=b.marksX.length,d=b.marksY.length,e=b.marksX.length!==1||b.marksX[0].x!=="-1",f=b.marksY.length!==1||b.marksY[0].x!=="-1";this.expected=c*d,e&&f&&(this.expected+=c+d)},"bus profiler.ready:last+afterRender:last+view.cell.skeleton.built":function(a){++this.actual;var b=this.actual===this.expected;if(b){var c=a["profiler.ready"].data.profiler,d=a.afterRender.data.element;c.stop();var e=c.data(),f=e[0],g=e[e.length-1],h=g.tick-f.tick,i=["D",'<sup style="background-color:rgba(255, 25, 0, 0.5);font-size:9px;border:1px solid;color:#000;padding:0 1px 0 1px;">',h,"</sup>"].join("");this.buildDiagnostics(c,d,i)}},buildDiagnostics:function(a,b,c){var d=$("<div></div>");d.css("padding","4px").css("background","rgba(125, 125, 125, 0.7)").css("font-size","10px").css("color","#ffffff").css("width","20px").css("height","20px").css("z-index","100").css("margin-top","3px").css("margin-left","3px").css("position","absolute");var g=function(){var c=a.data(),g=b.find("[role=header]"),h=g.filter("[data-dimension=x]").find("[role=cell]").size(),k=g.filter("[data-dimension=y]").find("[role=cell]").size(),l=b.find("[role=grid]").find("[role=card]").size(),m="Slice: "+h+" x "+k+" ["+l+" cards]",n="Overall time: ["+e(c)+"] ms",o=f(c),p=["Basic skeleton: ["+o.total+"] ms","> Client: ["+o.client+"] ms","> Server: ["+o.server+"] ms"],q=i(c),r="Cells skeletons build process has taken ["+q.total+"] ms",s=["> Server: ","[","AVG:"+q.server.avg," / ","MAX: "+q.server.max,"] ms"].join(""),t=["> Client: ","[","AVG:"+q.client.avg," / ","MAX: "+q.client.max," / ","SUM: "+q.client.total,"] ms"].join(""),u=j(m,n,p,[r,s,t]);u.css("padding","4px").css("background","rgba(125, 125, 125, 0.7)").css("font-size","10px").css("color","#ffffff").css("z-index","100").css("position","absolute").css("top","29px").css("left",0).appendTo(d),d.children().eq(0).toggle(function(){u.hide()},function(){u.show()})},h=$("<div title='diagnostics'>"+c+"</div>");h.css("color","#A9D975").css("font-size","18px").css("font-family","Tahoma").css("text-align","center").css("width","100%").css("height","100%").css("line-height","100%").css("cursor","pointer").one("click",g),d.append(h),b.append(d)}})})