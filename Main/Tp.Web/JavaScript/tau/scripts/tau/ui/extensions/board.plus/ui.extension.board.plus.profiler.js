define(["Underscore","jQuery","tau/core/event.emitter"],function(_,$,EventEmitter){var findEventByName=function(stream,name){var result=_(stream).chain().find(function(evt){return evt.name===name}).value();return result},selectEventsCollectionByName=function(stream,name){var result=_(stream).chain().select(function(evt){return evt.name===name}).value();return result},diff=function(stream,evtStart,evtEnd){var e0=findEventByName(stream,evtStart),e1=findEventByName(stream,evtEnd);return e1.tick-e0.tick},overallTime=function(stream){var e0=stream[0],eL=stream[stream.length-1];return eL.tick-e0.tick},basicSkeleton=function(stream){var total=diff(stream,"initialize","view.skeleton.built"),rest=diff(stream,"model.get.sliceInfo","model.sliceInfo.retrieved");return{client:total-rest,server:rest,total:total}},groupEventTimeline=function(srcEvtLine,pairedEvtLine,startEventName,endEventName,groupIdIterator){var groupedTimeLine={};for(var i=0;i<srcEvtLine.length;i++){var item=srcEvtLine[i],groupId=groupIdIterator(item),pair=_(pairedEvtLine).find(function(evt){var id=groupIdIterator(evt);return id==groupId});if(!pair)console.log("pair event ["+endEventName+"] is not found for ["+startEventName+"]"),console.log("cell group: "+groupId);else{var timePoint={id:groupId,orig:item,pair:pair};groupedTimeLine[timePoint.id]=timePoint}}return groupedTimeLine},getAvgMaxTotal=function(timeMetrics){var maxValue=_(timeMetrics).max(function(m){return m}),totalSum=0;_(timeMetrics).each(function(m){totalSum+=m});var avgValue=totalSum/timeMetrics.length;return{avg:avgValue.toFixed(2),max:maxValue.toFixed(2),total:totalSum.toFixed(2)}},cellsSkeletons=function(stream){var viewCellSlotBuiltStart=findEventByName(stream,"view.cellSlot.built.start"),viewCellSlotBuilt=selectEventsCollectionByName(stream,"view.cellSlot.built"),viewCellSkeletonBuilt=selectEventsCollectionByName(stream,"view.cell.skeleton.built"),e0=viewCellSlotBuiltStart,eL=viewCellSkeletonBuilt[viewCellSkeletonBuilt.length-1],overallTime=eL.tick-e0.tick,modelGetCellBasicInfo=selectEventsCollectionByName(stream,"model.get.cell.basicInfo"),modelCellBasicInfoRetrieved=selectEventsCollectionByName(stream,"model.cell.basicInfo.retrieved"),serverGroups=groupEventTimeline(modelGetCellBasicInfo,modelCellBasicInfoRetrieved,"model.get.cell.basicInfo","model.cell.basicInfo.retrieved",function(item){return["x",item.data.x,"y",item.data.y].join("")}),totalGroups=groupEventTimeline(viewCellSlotBuilt,viewCellSkeletonBuilt,"view.cellSlot.built","view.cell.skeleton.built",function(item){return["x",item.data.data.x,"y",item.data.data.y].join("")}),serverMetrics=[],clientMetrics=[];return _(totalGroups).each(function(v,k){var total=v.pair.tick-v.orig.tick,rest=serverGroups[k],server=0;rest.orig.data.hasOwnProperty("x")&&rest.orig.data.hasOwnProperty("y")&&(server=rest.pair.tick-rest.orig.tick,serverMetrics.push(server));var client=total-server;clientMetrics.push(client)}),{total:overallTime,client:getAvgMaxTotal(clientMetrics),server:getAvgMaxTotal(serverMetrics)}},formatResult=function(messages){var $placeholder=$("<div></div>");$placeholder.width(375),$placeholder.height(225),$placeholder.empty().append("<p><b>Performance statistics:</b></p>");for(var i=0;i<arguments.length;i++){$placeholder.append("<hr />");if(_.isArray(arguments[i]))for(var s=0;s<arguments[i].length;s++)$placeholder.append("<p style='padding:1;margin:0;'>"+arguments[i][s]+"</p>");else $placeholder.append("<p style='padding:1;margin:0;'>"+arguments[i]+"</p>")}return $placeholder};return EventEmitter.extend({init:function(config){this._super(config),this.expected=0,this.actual=0},"bus model.sliceInfo.retrieved":function(evt){var evtSlc=evt.data,hasX=!!evtSlc.marksX,hasY=!!evtSlc.marksY,xl=hasX?evtSlc.marksX.length:1,yl=hasY?evtSlc.marksY.length:1;this.expected=xl*yl,hasX&&hasY&&(this.expected+=xl+yl)},"bus profiler.ready:last+afterRender:last+view.cell.skeleton.built":function(evt){++this.actual;var r=this.actual===this.expected;if(r){var busProfiler=evt["profiler.ready"].data.profiler,$element=evt.afterRender.data.element;busProfiler.stop();var stream=busProfiler.data(),e0=stream[0],eL=stream[stream.length-1],total=eL.tick-e0.tick,label=["D",'<sup style="background-color:rgba(255, 25, 0, 0.5);font-size:9px;border:1px solid;color:#000;padding:0 1px 0 1px;">',total,"</sup>"].join("");this.buildDiagnostics(busProfiler,$element,label)}},buildDiagnostics:function(busProfiler,$element,label){var $stat=$("<div></div>");$stat.css("padding","4px").css("background","rgba(125, 125, 125, 0.7)").css("font-size","10px").css("color","#ffffff").css("width","20px").css("height","20px").css("z-index","100").css("margin-top","3px").css("margin-left","3px").css("position","absolute").css("top","0px").css("left","0px");var collectStatistics=function(){var stream=busProfiler.data(),$headers=$element.find("[role=header]"),colsCount=$headers.filter("[data-dimension=x]").find("[role=cell]").size(),rowsCount=$headers.filter("[data-dimension=y]").find("[role=cell]").size(),cardCount=$element.find("[role=grid]").find("[role=card]").size(),generalInfoMsg="Slice: "+colsCount+" x "+rowsCount+" ["+cardCount+" cards]",overallTimeMsg="Overall time: ["+overallTime(stream)+"] ms",basic=basicSkeleton(stream),basicSkeletonMsg=["Basic skeleton: ["+basic.total+"] ms","> Client: ["+basic.client+"] ms","> Server: ["+basic.server+"] ms"],cells=cellsSkeletons(stream),cellsSkeletonsMsgTotal="Cells skeletons build process has taken ["+cells.total+"] ms",cellsSkeletonsMsgServer=["> Server: ","[","AVG:"+cells.server.avg," / ","MAX: "+cells.server.max,"] ms"].join(""),cellsSkeletonsMsgClient=["> Client: ","[","AVG:"+cells.client.avg," / ","MAX: "+cells.client.max," / ","SUM: "+cells.client.total,"] ms"].join(""),$container=formatResult(generalInfoMsg,overallTimeMsg,basicSkeletonMsg,[cellsSkeletonsMsgTotal,cellsSkeletonsMsgServer,cellsSkeletonsMsgClient]);$container.css("padding","4px").css("background","rgba(125, 125, 125, 0.7)").css("font-size","10px").css("color","#ffffff").css("z-index","100").css("position","absolute").appendTo($stat),$stat.children().eq(0).toggle(function(){$container.hide()},function(){$container.show()})},$analyze=$("<div title='diagnostics'>"+label+"</div>");$analyze.css("color","#A9D975").css("font-size","18px").css("font-family","Tahoma").css("text-align","center").css("width","100%").css("height","100%").css("line-height","100%").css("cursor","pointer").one("click",collectStatistics),$stat.append($analyze),$element.append($stat)}})})