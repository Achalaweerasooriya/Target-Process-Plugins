define(["jQuery","Underscore","tau/ui/extensions/board.plus/ui.extension.board.plus.full-counts.base","tau/models/board.plus/model.counts"],function(e,t,o,n){var s=function(e,t,o){e[t]=e[t]?e[t].concat(o):[].concat(o)},i=function(e,t){return e=e||"null",t=t||"null",e+"-"+t};return o.extend({init:function(t){this._super(t),this.countsModel=Object.create(n),this.boardModel={},this.on("refresh",function(){this.countsModel&&this.countsModel.clear(),this.boardModel={}}.bind(this)),this.domWrapper=e.Deferred(),this.on("domWrapper.ready",function(t,o){this.domWrapper=e.Deferred().resolve(o)}.bind(this)),this.countsModel.on("update",function(e,t){this.domWrapper.done(function(e){e.updateAxesMetaInfo(t.counts,t.limits),this.fire("view.axes.counters.updated")}.bind(this))}.bind(this))},postUpdateAxesMetaInfo:function(e,t){this.countsModel&&this.countsModel.update({counts:e,limits:t})},updateCount:function(e){var o=this.countsModel.get(),n=function(e){return{count:1,type:e}}.bind(this),s=function(e,s,i,d){var u=t.find(o.counts,function(t){return t[s]==e});if(u){var a=t.find(u.counts,function(e){return e.type.toLowerCase()==d.toLowerCase()});a?a.count+=i:u.counts.push(n(d))}else if("null"!==e){var r={counts:[n(d)]};r[s]=e,o.counts.push(r)}},i=function(e,o){t.each(e,function(e,n){n=n.split("-"),t.each(e,function(e){s(n[0],"x",o,e.type),s(n[1],"y",o,e.type)})})};i(e.added,1),i(e.removed,-1),this.countsModel.update(o)},updateModel:function(e,o){var n=t.reduce(o,function(e,t){return e.push(i(t.x,t.y)),e},[]),d={removed:{},added:{}};return t.each(o,function(o){var u=i(o.x,o.y),a=e[u]||{},r=o.dataItem,c=r.id,l=a[c];l||(e[u]=a,s(d.added,u,r),e[u][c]=r),t.each(e,function(e,o){e[c]&&(t.contains(n,o)||(s(d.removed,o,r),delete e[c]))})},this),d},processBatchComet:function(e){return t.reduce(e,function(e,t){return t.location&&"card"===t.location.toLowerCase()&&e.push({dataItem:t.data,x:t.x,y:t.y}),e},[])},"bus comet.batch":function(e,o){var n={removed:{},added:{}};t.each(o.items,function(e){var o=this.updateModel(this.boardModel,this.processBatchComet(e.items));
t.each(o.removed,function(e,t){s(n.removed,t,e)}),t.each(o.added,function(e,t){s(n.added,t,e)})},this),this.updateCount(n)},"bus boardSettings.limitsReady:last > model.sliceInfo.retrieved:last > slice.ready:last > domWrapper.ready:last > after.slice.cells.updated":function(e,t,o,n,s){this._updateMetaInfoDebouncedHandler(o,n.slice,t,s)},_updateModelAfterCells:function(e,o){t.each(o.result&&o.result.items||[],function(e){var o=i(e.x,e.y);this.boardModel[o]=this.boardModel[o]||{},t.each(e.dynamic.items||[],function(e){this.boardModel[o][e.id]=e},this)},this),this.fire("after.slice.cells.updated")},_updateModelAfterMove:function(e,o){t.each(o.result.items,function(e){this.updateModel(this.boardModel,e.items)},this)},"bus slice.ready":function(e,t){t.base.on("after.cells",this._updateModelAfterCells,this),t.full.on(["after.moveBatch","after.moveAndPrioritizeBatch"],this._updateModelAfterMove,this)},"bus slice.ready:last + destroy":function(e,t){t.base.removeAllListeners(this),t.full.removeAllListeners(this)}})});