define(["jQuery","Underscore","tau/core/extension.base","tp/mashups","tau/ui/templates/board.main.menu/ui.template.board.system-diagnostics","tau/ui/templates/board.main.menu/ui.template.board.system-diagnostics.full-report","app.path","tau/models/board.customize.units/board.customize.cards.builderSelector","tau/services/customize/service.customize.card.layout.factory","tau/models/board.customize.units/const.card.sizes"],function(t,e,i,s,n,r,o,a,d,c){return i.extend({init:function(t){this._super(t),this.initialized=!1},"bus afterRender:last + initialize:last + boardSettings.ready":function(t,e,i,s){this._configurator=i.context.configurator,this.diagnostics=this._configurator.getDiagnosticsService(),this._window=this._configurator.getWindow(),this._$systemInfo=e.element.find(".tau-system-info"),this._layoutFactory=new d(this._configurator,s.boardSettings),this.initialized||(this._$systemInfo.find(".i-role-diagnostic").click(this._collectDiagnosticData.bind(this)),this.initialized=!0),this._boardSettings=s.boardSettings.settings,this.fire("system.diagnostics.report.initialized")},_collectDiagnosticData:function(){var e=n.render(),i=e.find(".i-role-see-full-report"),s=function(e){i.click(function(){e.find(".i-role-report-body").show(),t(this).hide(),t(".i-role-diagnostics-description").hide()})};s(e);var o=e.find(".i-role-loader");o.show();var a=e.find(".i-role-report-body"),d=t.when(this.diagnostics.networkLatency(),this.diagnostics.networkSpeed(),this._urlContext(),this._boardDefinition(),this.diagnostics.serverUsage(),this._cardsSettings());d.then(function(t,s,n,d,c,l){var u=this._configurator.getLoggedUser(),h={id:u.id,name:u.name,email:u.email,isAdministrator:u.isAdministrator||!1,isObserver:u.isObserver||!1},p={name:this._window.location.host,edition:this._window.tauSystemInfo.edition},g={location:this._window.location.href,timestamp:t.timestamp,age:this._window.tauServerInfo.created,now:new Date},f={latency:t.latency,speed:s.speed},m="context"===n.__type?{processes:n.processes.length,projects:n.projectIdsAvailable.length,selectedProjects:n.selectedProjects.length,teams:n.teamIdsAvailable.length,selectedTeams:n.selectedTeams.length}:"Couldn't get context",b=this.diagnostics.get("board"),_={boardDefinition:d.data,cardsData:l?this._adaptCardsData(l):null,timing:b?{network:b.server,processing:b.client}:null},y={page:g,network:f,context:m,board:_,os:this._window.tauSystemInfo.os,serverUsage:c,mashups:this._listInstalledMashups(),browser:this.diagnostics.browser(),user:h,account:p,layout:this._pageTypeInfo(),errors:this._getErrors()},w=r.render(y);a.html(w);var v=e.find(".i-role-send-button");v.removeAttr("disabled").click({data:y,popup:e},this._sendReport.bind(this)),o.hide(),i.show(),this.fire("system.diagnostics.report.rendered",{element:e})}.bind(this)),this._renderReport(e)},_getErrors:function(){var t=this._window.getJavascriptErrors?this._window.getJavascriptErrors():[];return e.chain(t.reverse()).groupBy(function(t){var e=new Date(Date.parse(t.timestamp));return new Date(e.getFullYear(),e.getMonth(),e.getDate())}).map(function(t,e){return{date:new Date(e),errors:t}}).value()},_adaptCardsData:function(t){var i=new a,s=function(t){return e.map(e.keys(t),function(e){return{typeName:e,data:i.build(e,t[e])}})};return t.length?e.flatMap(t,function(t){return s(t)}):s(t)},_cardsSettings:function(){var e=[],i=function(t,i){t.length>0&&e.push(this._layoutFactory.getCardLayoutsByTypesAndSize(t,i))}.bind(this);return"newlist"===this._boardSettings.viewMode?(i(this._boardSettings.cells.types,"list"),i(this._boardSettings.x.types,"list"),i(this._boardSettings.y.types,"list")):i(this._boardSettings.cells.types,c.zoomToSize(this._boardSettings.zoomLevel)),t.when.apply(this,e)},_sendReport:function(t){var e=t.data.popup,i=e.find(".i-role-comment"),s=e.find(".i-role-send-button"),n=t.data.data;n.comment=i.val(),s.text("Sending..."),this.diagnostics.sendReport(n).done(function(){s.text("Sent").attr("disabled","disabled"),i.attr("disabled","disabled"),this.fire("notification",{$node:"<h3>Report sent successfully</h3>"}),this.fire("system.diagnostics.report.sent")}.bind(this)).fail(function(){s.text("Send report"),this.fire("error",{$node:"<h3>There was an error sending report</h3>"}),this.fire("system.diagnostics.report.failed")}.bind(this))},_renderReport:function(t){t.tauPopup({className:"ui-popup_gray",hideOnEscape:!0,popupContent:t}),t.tauPopup("show")},_listInstalledMashups:function(){var t=new s,i=t.getRegisteredMashups();return e.map(e.keys(i),function(t){var e=t.split("/");return e[e.length-2]})},_urlContext:function(){var t=this._configurator.getAppStateStore().settings.acid;return this._configurator.getApplicationContextService().getApplicationContext({acid:t})},_boardDefinition:function(){var e=/(?:=board\/(\d+))/.exec(location.hash),i=e&&e[1];return i?this._configurator.getBoardDefinitionFactory().boardService.getBoardData(i):t.Deferred().resolve({data:null})},_pageTypeInfo:function(){if("none"===this._boardSettings.id)return{pageType:"Entity"};var e=t("body").find(".i-role-board-body"),i={board:"Board",list:"Details",timeline:"Timeline",newlist:"List"};return{viewMode:this._boardSettings.viewMode,pageType:i[this._boardSettings.viewMode],cards:e.find(".i-role-card").length}}})});