define(["Underscore","jQuery","tau/ui/extensions/editable-base","tau/ui/behaviour/common/ui.behaviour.tauBubble"],function(_,$,a,b){return a.extend({category:"edit",init:function(a){this._super(a),this.containers=[]},destroy:function(){this.destroyContainers(),this._super()},onEditActivated:function(a){this.destroyContainers();var c=this,d=this.element=a.element;for(var e=0;e<c.config.popupEditorContainer.length;e++){var f=c.config.popupEditorContainer[e],g=d.find(f.targetSelector);g.find(".external-view,.ui-type-icon").click(function(a){a.stopPropagation()}),g.each(function(){var a=$(this);f.component.data=a.tmplItem().data;var e={components:_.clone(f.component),context:c.config.context,store:c.config.store};a.addClass("tau-bubble-target"),f.targetCssClass&&a.addClass(f.targetCssClass);var g=!1;f.alignmentSelector&&(f.alignmentSelectorFrom=="target"?g=a.find(f.alignmentSelector):g=d.find(f.alignmentSelector));if(!g||!g.length)g=a;g.addClass("ui-link");var h=function(a){return function(){c.initializeContainer(this.$target,this.$popup,a)}}(e);b.call(a,{alignTo:g,onShow:h})})}},initializeContainer:function(a,b,c){var d=this,e=b.find(".tau-bubble__inner");d.$popupInner=e,d.$target=a;if(a.data("bubbleLoaded")===!0){a.trigger("taububbleloadcontent");return}e.find("div.ui-loading-message").remove(),e.append("<div class='ui-loading-message'>Loading...</div>"),d.createComponents(c,function(b){var f=b[0].component;f.on("afterRender",function(b){e.find(".ui-loading-message").remove();var c=b.data.element;c.appendTo(e),a.data("bubbleLoaded",!0),a.trigger("taububbleloadcontent"),b.removeListener(),a.tauBubble("adjustPosition"),a.tauBubble("adjustPositionStart"),a.tauBubble("adjustPosition"),a.bind("close",function(){f.fire("blur",{})}),a.bind("show",function(){f.fire("focus.before",{}),f.fire("focus",{}),f.fire("popupResize",a.tauBubble("getMaxSize")),a.tauBubble("adjustPosition")}),f.fire("popupResize",a.tauBubble("getMaxSize")),a.tauBubble("adjustPosition"),a.tauBubble("adjustPosition"),setTimeout(function(){f.fire("focus",{})},500)}),d.addContainer(f),f.initialize({store:c.store,context:c.context});var g=function(){a.data("bubbleLoaded",!1),a.tauBubble("empty")},h=function(){a.tauBubble("hide")},i=function(){a.tauBubble("destroy"),f.destroy()},j=function(){a.tauBubble("hide"),a.data("bubbleLoaded",!1),f.destroy()};f.on("beforeSave",g),f.on("beforeRemove",g),f.on("reset",h),f.on("afterSave",i),f.on("afterRemove",i),f.on("close",g)})},addContainer:function(a){this.containers.push(a)},destroyContainers:function(){var a=this.containers;_.each(a,function(a){a.destroy()}),this.containers=[]}})})