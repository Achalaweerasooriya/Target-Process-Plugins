define(["Underscore","jQuery"],function(_,$){return function(boardNode,settings){_.defaults(settings,{onResize:$.noop,resetTrigger:$.Deferred});var RESIZER_ACTIVATION_TIME=150,RESIZER_HIDE_TIME=150,RESIZE_BLOCK_TIME=150,resizeInProgress=!1,gridResizer={__$decreaser:$('<button type="button" class="tau-board-grid-resize-controls__btn tau-board-grid-resize-controls__decreaser">-</button>'),__$increaser:$('<button type="button" class="tau-board-grid-resize-controls__btn tau-board-grid-resize-controls__increaser">+</button>'),__$element:$('<div class="tau-board-grid-resize-controls tau-board-grid-resize-controls_trigger-type-"/>'),__onControlClick:function(evt){this.__deactivate(),this.hide(!0),resizeInProgress=!0,this.__$decreaser.is(evt.target)?grid.decreaseColSize(this.__showConfig.colIndex):this.__$increaser.is(evt.target)&&grid.increaseColSize(this.__showConfig.colIndex),setTimeout($.proxy(function(){resizeInProgress=!1},this),RESIZE_BLOCK_TIME)},__onMouseEnter:function(){this.__$element.removeClass("tau-board-grid-resize-controls_hiding"),this.__hideTimeoutId&&(clearTimeout(this.__hideTimeoutId),this.__hideTimeoutId=null)},__onMouseLeave:function(){this.__$element.addClass("tau-board-grid-resize-controls_hiding"),this.hide()},__activate:function(){this.__isActive||(this.__isActive=!0,this.__$element.addClass("tau-active"))},__deactivate:function(){this.__isActive&&(this.__isActive=!1,this.__$element.removeClass("tau-active"))},__setControlsPosition:function(){var offset=this.__showConfig.cursorY-this.__$element[0].getBoundingClientRect().top;this.__$element.children().css("top",offset)},show:function(config){this.__showConfig=config,this.__$decreaser.attr("disabled",null).removeClass("tau-board-grid-resize-controls__btn__disabled");var columnSize=settings.resolveColumnSize(config.x);1>=columnSize&&(this.__$decreaser.attr("disabled","disabled"),this.__$decreaser.addClass("tau-board-grid-resize-controls__btn__disabled")),this.__$element.attr("class",function(index,className){return className.replace(/(tau-board-grid-resize-controls_trigger-type-)\w*/g,"$1"+config.triggerType)}),grid.showResizer(this.__$element,config.position),this.__setControlsPosition(),this.__activateTimeoutId||(this.__activateTimeoutId=setTimeout(this.__getActivateTimeoutProxy(),RESIZER_ACTIVATION_TIME))},__activateTimeout:function(){this.__activateTimeoutId=null,this.__activate()},__getActivateTimeoutProxy:function(){return this.__showTimeoutProxy||(this.__showTimeoutProxy=$.proxy(this,"__activateTimeout")),this.__showTimeoutProxy},hide:function(instantly){this.__activateTimeoutId?(clearTimeout(this.__activateTimeoutId),this.__activateTimeoutId=null,this.__hideTimeout()):instantly?this.__hideTimeout():this.__hideTimeoutId||(this.__hideTimeoutId=setTimeout(this.__getHideTimeoutProxy(),RESIZER_HIDE_TIME))},__hideTimeout:function(){this.__hideTimeoutId=null,this.__deactivate(),grid.hideResizer(this.__$element)},__getHideTimeoutProxy:function(){return this.__hideTimeoutProxy||(this.__hideTimeoutProxy=$.proxy(this,"__hideTimeout")),this.__hideTimeoutProxy},tryHide:function(testCallback){testCallback(this.__$element)&&this.hide()},init:function(){return this.__$element.append(this.__$decreaser,this.__$increaser),this.__$element.on({click:$.proxy(this,"__onControlClick"),mouseenter:$.proxy(this,"__onMouseEnter"),mouseleave:$.proxy(this,"__onMouseLeave")}),this}}.init(),gridResizeTrigger={__$element:$('<span class="tau-board-grid-resize-trigger"></span>'),__$triggerA:$('<div class="tau-board-grid-resize-trigger__a"/>'),__$triggerB:$('<div class="tau-board-grid-resize-trigger__b"/>'),__getColIndex:function(){return this.__$element.closest(".i-role-cellholder").index()},__getResizerConfig:function(evt){var config=null,trigger=evt.target,$currCellHolder=this.__$element.closest(".i-role-cellholder");if(this.__$triggerA.is(trigger)){var $prevCellHolder=$currCellHolder.prev(),prevX=$prevCellHolder.data("x");config={x:prevX,position:this.__$triggerA[0].getBoundingClientRect().left,colIndex:$prevCellHolder.index(),triggerType:"a"}}else if(this.__$triggerB.is(trigger)){var currX=$currCellHolder.data("x");config={x:currX,position:this.__$triggerB[0].getBoundingClientRect().left,colIndex:this.__getColIndex(),triggerType:"b"}}return config.cursorY=evt.clientY,config},__onMouseEnter:function(evt){resizeInProgress||gridResizer.show(this.__getResizerConfig(evt))},__onMouseLeave:function(evt){resizeInProgress||gridResizer.tryHide(function($resizer){return!($(evt.relatedTarget).closest($resizer).size()>0)})},attachTo:function(cellNode){gridResizer.hide();var $cellHolderNode=$(cellNode).closest(".i-role-cellholder"),xh=$cellHolderNode.height(),index=$cellHolderNode.index(),COLLAPSED_CLASS="tau-collapsed_x",hideL=!1,hideR=!1;$cellHolderNode.hasClass(COLLAPSED_CLASS)&&(hideR=!0);if(index===0)hideL=!0;else if(index>0){var $parent=$cellHolderNode.parent(),$leftSibling=$parent.children().eq(index-1);$leftSibling.hasClass(COLLAPSED_CLASS)&&(hideL=!0)}var $a=this.__$triggerA,$b=this.__$triggerB;hideL?$a.hide():$a.show(),hideR?$b.hide():$b.show(),$a.height(xh),$b.height(xh),this.__$element.appendTo(cellNode)},detach:function(){gridResizer.hide(),this.__$element.detach()},init:function(){return this.__$element.append(this.__$triggerA,this.__$triggerB),this.__$element.on({mouseenter:$.proxy(this,"__onMouseEnter"),mouseleave:$.proxy(this,"__onMouseLeave")}),this}}.init(),grid={__toGridCoordinates:function(position){var $grid=this.__$element.find(".i-role-grid"),coordinate=position-this.__$element[0].getBoundingClientRect().left,gridPosition=$grid.position(),leftBorder=gridPosition.left,gridWidth=$grid[0].clientWidth||$grid.width(),rightBorder=leftBorder+gridWidth-8,DELTA=20,shift=0;return Math.abs(leftBorder-coordinate)<DELTA?shift=1:Math.abs(rightBorder-coordinate)<DELTA&&(shift=-1),{coordinate:coordinate,shift:shift}},increaseColSize:function(colIndex){var $cell=this.__$element.find(".tau-cols-header, .tau-grid").find(".tau-cellholder:nth-child("+(colIndex+1)+") .tau-cell").eq(0);settings.onResize({type:"+",x:$cell.data("x")})},decreaseColSize:function(colIndex){var $cell=this.__$element.find(".tau-cols-header, .tau-grid").find(".tau-cellholder:nth-child("+(colIndex+1)+") .tau-cell").eq(0);settings.onResize({type:"-",x:$cell.data("x")})},showResizer:function($resizer,position){var c=this.__toGridCoordinates(position),gridCoordinates=c.coordinate,map={0:"",1:"tau-board-grid-resize-controls__btn__right-shift","-1":"tau-board-grid-resize-controls__btn__left-shift"};$resizer.removeClass(map[1]).removeClass(map["-1"]).addClass(map[c.shift]),$resizer.css("left",gridCoordinates).appendTo(this.__$element.find(".i-role-board-body"))},hideResizer:function($resizer){$resizer.detach()},init:function($node){return this.__$element=$node.find(".tau-board-grid-view"),this.__$element.on({mouseenter:function(){var $cellHolder=$(this);if(!settings.isAvailable())gridResizeTrigger.detach();else{var $cellNode=$cellHolder.find(".i-role-cell");gridResizeTrigger.attachTo($cellNode.get(0))}}},".i-role-grid .i-role-cellholder"),settings.resetTrigger.progress(function(){gridResizeTrigger.detach()}),this}}.init(boardNode)}})