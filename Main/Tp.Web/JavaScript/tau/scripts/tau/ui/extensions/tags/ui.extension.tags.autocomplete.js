define(["Underscore","tau/libs/store2/store2","tau/core/extension.base"],function(_,Store2,ExtensionBase){return ExtensionBase.extend({category:"edit","bus configurator.ready":function(evt,configurator){this.fire("store2.ready",new Store2(configurator))},"bus store2.ready:last + tagsProcessor.ready:last + autocomplete.resolve":function(evt,store2,tagsProcessor,autocompleteData){var pos=autocompleteData.$input[0].selectionEnd;if(_.isUndefined(pos)&&document.selection){var Sel=document.selection.createRange(),SelLength=document.selection.createRange().text.length;Sel.moveStart("character",-autocompleteData.$input.val().length),pos=Sel.text.length-SelLength}var fullTerm=autocompleteData.request.term.substr(0,pos),tagTerm=_.ltrim(_.strRightBack(fullTerm,","));tagTerm.length>1?(pos-=tagTerm.length,autocompleteData.$input.data("acTerm",tagTerm),autocompleteData.$input.data("acPos",pos),store2.findAll("Tag?select={"+["name"].join(",")+'}&where=name.startsWith("'+store2.arg(tagTerm.toLowerCase())+'")').done(function(items){var vals=tagsProcessor.asArray(_.pluck(items,"name"));vals=_.sortBy(vals,function(v){return v.toLowerCase()}),autocompleteData.next(vals)})):autocompleteData.next([])},"bus tagsProcessor.ready:last + $editor.shown":function(evt,tagsProcessor,$editor){var self=this,$input=$editor.find(":text");$input.autocomplete({minLength:2,source:function(request,next){self.fire("autocomplete.resolve",{$input:$input,request:request,next:next})},focus:function(){return!1},select:function(event,ui){var selected=ui.item.value,val=$input.val(),s=tagsProcessor.asArray(val.substr(0,$input.data("acPos"))+val.slice($input.data("acPos")+$input.data("acTerm").length));return s.push(selected),s=tagsProcessor.asString(s),$input.val(s),$input.focus(),event.preventDefault(),event.stopPropagation(),!1}}),$input.data("autocomplete")._renderItem=function(ul,item){return $("<li class='tau-autocomplete__item'></li>").data("item.autocomplete",item).append("<a class='tau-autocomplete__itemtrigger drop-down-option'>"+_.escape(item.label)+"</a>").appendTo(ul)},$input.data("autocomplete")._renderMenu=function(ul,items){$(ul).addClass("tau-autocomplete__menu drop-down-list tau-autocomplete__menu__tags").css("maxHeight",$(window).height()*.4);var that=this;$.each(items,function(index,item){that._renderItem(ul,item)})}}})})