define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/ui/templates/comments/ui.template.comments.actions","tau/ui/behaviour/common/ui.behaviour.richeditor"],function(e,t,n,i){return n.extend({category:"edit",destroy:function(){this.destroyDynamicComponents(),this._super()},lifeCycleCleanUp:function(){this.destroyDynamicComponents(),this._super()},destroyDynamicComponents:function(){var e=this;e.componentList&&(e.componentList.destroy(),delete e.componentList)},"bus applyTo + permissionsReady":function(e){var t=e.applyTo.data,n=e.permissionsReady.data;this.applyPermissions(t.config,t.data,t.element,n)},"bus applyTo":function(e,t){this.comment=t.data},applyPermissions:function(t,n,o,s){var a=this.config=e.extend({},t,{comment:n}),c=this.element=o,r=c.children(".ui-comment-body"),d=this.config.context.configurator.getTemplateFactory().get(i.name).bind({},s);r.children(".ui-comment-heading").append(d.eq(0)),r.append(d.eq(1)),s.editable&&r.addClass("editable"),s.deletable&&r.addClass("deletable"),d.on("click",".reply",e.bind(this.onReply,this)),d.on("click",".edit",e.bind(this.onEdit,this)),d.on("click",".delete",e.bind(this.onDelete,this));var m=c.children(".ui-comments"),l={components:[{type:"commentList"}],context:a.context};this.componentList||this.createComponents(l,e.bind(function(t){var i=t[0],o={element:m,data:{comments:n.comments||[]},config:e.extend({},i.config,{commentId:this.config.comment.id})};this.componentList=i.component,i.component.fire("applyTo",o)},this))},showEditorForEdit:function(){var t=this.element.find("> .ui-comment-body > .ui-comment-text"),n=this.comment;this.showEditor({element:t,text:n.description,checkChanges:!1,saveHandler:e.bind(function(e){this.fire("saveComment",{description:e})},this)})},showEditorForReply:function(){var e=this,t=this.element.find("> .ui-comment-body > .ui-comment-reply > .ui-editor-placeholder"),n=this.comment;e.showEditor({element:t,text:"",hideTarget:!1,saveText:"Add Reply",saveHandler:function(t){e.fire("replyToComment",{description:t,parentId:n.id})}})},showEditor:function(n){var i=n.element,o="richeditor",s=i.parent(),a=i;a.data("ui-richeditor")||(a=a[o]({ckPath:this.config.context.configurator.getCkPath(),text:n.text,settings:{toolbar:"Basic",removePlugins:"autogrow,magicline",allowedContent:!0,height:200},executionGroupName:"comments",onSave:e.bind(function(e){this.fire("editorSave"),a[o]("hide"),n.saveHandler.call(this,e)},this),onCancel:function(){a[o]("hide")},onCreate:e.bind(function(){var e=i.parents(".ui-popup-content:first");0==e.size()&&(e=t(window)),e.scrollTo(a.parent(),100),this.fire("$editor.ready",a),this.fire("$editorHolder.ready",s)},this),saveAction:{text:n.saveText||"Save",disableIfEmpty:!0,checkChanges:n.checkChanges},cancelAction:{available:!0}})),a[o]("show")},onReply:function(e){e.stopPropagation(),e.preventDefault(),this.showEditorForReply()},onEdit:function(e){e.stopPropagation(),e.preventDefault(),this.showEditorForEdit()},onDelete:function(){var t=this.element.find("> .ui-comment-body");t.confirmation({message:"Delete comment?",ok:e.bind(this.onConfirmDelete,this),cancel:e.bind(this.onCancelDelete,this)}),t.confirmation("show")},onCancelDelete:function(e){e.stopPropagation(),e.preventDefault(),this.element.find("> .ui-comment-body").confirmation("hide")},onConfirmDelete:function(e){e.stopPropagation(),e.preventDefault(),this.fire("deleteComment")}})});