define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/models/board.cell.quick.add/model.board.general.quick.add"],function(e,t,n,i){var o=n.extend({"bus settings.beforeReady":function(e,t){t.settings.isGeneralAdd=!1,t.settings.isRelatedAdd=!0},"bus dataBind + afterRender":function(t,n,i){var o=i.element;o.on("click.quickAdd",".i-role-cancel",e.bind(this.onCancel,this))},onCancel:function(){this.fire("close")}});return{init:function(e){this.config=this._getExtendedConfig(e);var n=t.Deferred(),i=this._getBubbleConfig(n);return this.config.ctx.fire("initBubble",i),n},show:function(t){var n=this._getShowDelay();e.delay(function(){t.tauBubble("show")},n)},isInitialized:function(e){return!!e.data("uiTauBubble")},destroy:function(e){e.tauBubble("destroy")},_getExtendedConfig:function(t){var n=t.$element,i=n.closest(".tau-bubble__inner"),o=n.closest(".tau-entity-controls"),a=e.extend({},t,{childBuses:t.ctx.childBus,entityUniqueName:n.data("entityuniquename"),$innerBubble:i,$controlsContainer:o,$field:n.closest(".tau-field"),$selector:n.siblings(".userStorySelector"),TOP_BUBBLE_MARGIN:parseInt(i.css("margin-top"),10),LEFT_CONTROLS_PADDING:parseInt(o.css("padding-left"),10),HORIZONTAL_OFFSET:15,VERTICAL_OFFSET:12,HIDE_DURATION_IF_FINDER_DISPLAYED:400});return a},_getShowDelay:function(){return this.config.$selector.is(":visible")?0:this.config.HIDE_DURATION_IF_FINDER_DISPLAYED},_getBubbleConfig:function(e){var t=this.config.$target,n=this.config.$field,i=this._getComponentsConfig(),o={target:t,alignTo:n,applyBubbleClasses:!1,cleanupOnHide:!0,stackName:"quickAddGeneral",showOnCreation:!1,ignoreOverlap:!0,zIndex:10001,onCreate:function(){e.resolve()},onBeforeShow:function(e){var t=e.find(".tau-bubble__inner"),n=this.config.$target.closest(".tau-bubble__inner"),i=n.height(),o=t.height(),a=Math.max(i,o);t.height(a)}.bind(this),onShow:function(){t.removeClass("tau-quick-add-collapse");var e=t.tauBubble("widget");this.config.ctx.fire("relatedQuickAdd.afterShow",e)}.bind(this),onHide:function(){t.addClass("tau-quick-add-collapse"),this.config.ctx.fire("relatedQuickAdd.afterHide")}.bind(this),className:"tau-quick-add-dialog-general tau-quick-add-dialog-related",onPositionConfig:function(){var e=this.config.LEFT_CONTROLS_PADDING+this.config.HORIZONTAL_OFFSET;return{my:"left+"+e+" top-"+this.config.TOP_BUBBLE_MARGIN,at:"left top",of:this.config.$controlsContainer}}.bind(this),onArrowPositionConfig:function(e,t){var i={left:{my:"left+"+this.config.HORIZONTAL_OFFSET+" center",at:"left top+"+this.config.VERTICAL_OFFSET},right:{my:"right-"+this.config.HORIZONTAL_OFFSET+" center",at:"right top+"+this.config.VERTICAL_OFFSET}},o=i[t]||{};return o.of=n,o}.bind(this),onCurrentOrientationConfig:function(e,t){return e.left>t.left?"left":"right"},dontCloseSelectors:["#ui-datepicker-div"],componentsConfig:i};return o},_getExtension:function(){var e=this.config.entityUniqueName,t=this.config.ctx,n=this.config.childBuses,i=o.extend({"bus model.data.item.did.add":function(i,o){var a=o.message.dataItem.data;t.fire("relatedQuickAdd."+e+".added",a),n[e].fire("refresh"),this.onCancel()}});return i},_getComponentsConfig:function(){var e=this.config.$element.data("fieldname").toLowerCase(),t=this._getExtension(),n=this.config.getCurrentContext(),o={components:[{name:"board plus quick add general",type:"board.cell.quick.add",extensions:[t],QuickAddModel:i.extend({getTypes:function(){return[e]},context:n}),defaultType:e}]};return o}}});