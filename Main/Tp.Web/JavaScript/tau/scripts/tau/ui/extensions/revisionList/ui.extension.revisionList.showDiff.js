define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/core/keyboard.manager","tp/plugins/pluginsRepository","tp/plugins/commandGateway","tp/plugins/vcs/viewDiff/sourcePopup","tp/plugins/vcs/viewDiff/diffPopup"],function(_,$,ExtensionBase,KeyBoardManager,pluginsRepository,CommandGateway,ViewSourcePopup,ViewDiffPopup){function loadCss(url){var link=document.createElement("link");link.type="text/css",link.rel="stylesheet",link.href=url,document.getElementsByTagName("head")[0].appendChild(link)}var supportedPlugins=["Subversion","Git","Mercurial","TFS"];return loadCss(require.toUrl("tp/codemirror/theme/default.css")),ExtensionBase.extend({plugins:[],"bus afterRender+dataBind":function(evt){var plugins=this.plugins,revisions=_.pluck(evt.dataBind.data.items,"id"),self=this;_.each(supportedPlugins,function(pluginName){var config={pluginName:pluginName},commandGateway=new CommandGateway(config),pluginConfig={extension:this,pluginName:pluginName,commandGateway:commandGateway,revisions:revisions,viewSourcePopup:ViewSourcePopup,viewDiffPopup:ViewDiffPopup,getImportedRevisions:function(revisions){this.commandGateway.execute("GetImportedRevisions",this.revisions,$.proxy(this.getImportedRevisionsSuccess,this))},getImportedRevisionsSuccess:function(importedRevisions){if(importedRevisions.length==0)return;var element=evt.afterRender.data.element,revisions={};for(var i=0;i<importedRevisions.length;i++)revisions[importedRevisions[i]]=!0;element.find(".ui-revisionList > tbody").each(function(scope){var $row=$(this),data=$row.tmplItem().data;revisions.hasOwnProperty(data.id)&&scope.attachViewDiffBehaviourForElement($row)},[this])},attachViewDiffBehaviourForElement:function(element){var data=element.tmplItem().data,$files=element.find(".files");$files.each(function(scope){var $file=$(this),fileData=$file.tmplItem().data,pathLink=$file.find(".vcsViewDisabled");fileData.fileAction!="Deleted"&&(pathLink.attr("href","#").removeAttr("disabled").addClass("vcsView"),pathLink.click(function(e){e.preventDefault(),scope.showView(data.id,data.sourceControlId,fileData.fileName)}),pathLink.removeClass("vcsViewDisabled"));if(fileData.fileAction==="Modified"){var $actions=$file.parent().find(".diff");$actions.append($('<a href="#" class="_diff button small">Diff</a>').click(function(e){e.preventDefault(),scope.showDiff(data.id,data.sourceControlId,fileData.fileName)}))}},[this])},showView:function(revisionId,thirdPartyRevisionId,path){var config=self.config;config.context.configurator.getKeyBoardManager().pushHandler({handleKeyDown:function(evt){evt.keyCode==27&&config.context.configurator.getKeyBoardManager().popHandler()}}),this.viewSourcePopup.loading();var that=this;this.commandGateway.execute("ViewSource",{TpRevisionId:revisionId,Path:path},function(data){var content=data.Content||"File is empty";that.viewSourcePopup.view(thirdPartyRevisionId,content,path)},null,this.showError)},showDiff:function(revisionId,thirdPartyRevisionId,path){var config=self.config;config.context.configurator.getKeyBoardManager().pushHandler({handleKeyDown:function(evt){evt.keyCode==27&&config.context.configurator.getKeyBoardManager().popHandler()}}),this.viewDiffPopup.loading();var that=this;this.commandGateway.execute("ViewDiff",{TpRevisionId:revisionId,Path:path},function(data){that.viewDiffPopup.view(thirdPartyRevisionId,data,path)},null,this.showError)},showError:function(responseText){$("<div />").html('<p class="p-15">'+responseText+"</p>").popup({title:"Error occured",fitToWindow:!1})}};plugins[pluginName]=pluginConfig,pluginsRepository.pluginStartedAndHasAtLeastOneProfile(pluginName,$.proxy(pluginConfig.getImportedRevisions,pluginConfig))},this)}})})