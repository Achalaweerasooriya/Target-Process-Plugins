define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tp/plugins/pluginsRepository","tp/plugins/commandGateway","tp/plugins/vcs/viewDiff/sourcePopup","tp/plugins/vcs/viewDiff/diffPopup"],function(e,i,t,n,o,a,r){function s(e){var i=document.createElement("link");i.type="text/css",i.rel="stylesheet",i.href=e,document.getElementsByTagName("head")[0].appendChild(i)}var c=["Subversion","Git","Mercurial","TFS"];return s(require.toUrl("tp/codemirror/theme/default.css")),t.extend({plugins:[],"bus afterRender+dataBind":function(t,s,f){var u=this.plugins,d=e.pluck(f.items,"id"),p=this;e.each(c,function(t){var c={pluginName:t},f=new o(c),l={extension:this,pluginName:t,commandGateway:f,revisions:d,viewSourcePopup:a,viewDiffPopup:r,getImportedRevisions:function(){this.commandGateway.execute("GetImportedRevisions",this.revisions,e.bind(this.getImportedRevisionsSuccess,this))},getImportedRevisionsSuccess:function(e){if(0!==e.length){for(var t=s.element,n={},o=0;o<e.length;o++)n[e[o]]=!0;t.find(".ui-revisionList > tbody").each(function(e){var t=i(this),o=t.tmplItem().data;n.hasOwnProperty(o.id)&&e.attachViewDiffBehaviourForElement(t)},[this])}},attachViewDiffBehaviourForElement:function(e){var t=e.tmplItem().data,n=e.find(".files");n.each(function(e){var n=i(this),o=n.tmplItem().data,a=n.find(".vcsViewDisabled");if("Deleted"!=o.fileAction&&(a.attr("href","#").removeAttr("disabled").addClass("vcsView"),a.click(function(i){i.preventDefault(),e.showView(t.id,t.sourceControlId,o.fileName)}),a.removeClass("vcsViewDisabled")),"Modified"===o.fileAction){var r=n.parent().find(".diff");r.append(i('<a href="#" class="_diff button small">Diff</a>').click(function(i){i.preventDefault(),e.showDiff(t.id,t.sourceControlId,o.fileName)}))}},[this])},showView:function(e,i,t){var n=p.config;n.context.configurator.getKeyBoardManager().pushHandler({handleKeyDown:function(e){27==e.keyCode&&n.context.configurator.getKeyBoardManager().popHandler()}}),this.viewSourcePopup.loading();
var o=this;this.commandGateway.execute("ViewSource",{TpRevisionId:e,Path:t},function(e){var n=e.Content||"File is empty";o.viewSourcePopup.view(i,n,t)},null,this.showError)},showDiff:function(e,i,t){var n=p.config;n.context.configurator.getKeyBoardManager().pushHandler({handleKeyDown:function(e){27==e.keyCode&&n.context.configurator.getKeyBoardManager().popHandler()}}),this.viewDiffPopup.loading();var o=this;this.commandGateway.execute("ViewDiff",{TpRevisionId:e,Path:t},function(e){o.viewDiffPopup.view(i,e,t)},null,this.showError)},showError:function(e){i("<div />").html('<p class="p-15">'+e+"</p>").popup({title:"Error occurred",fitToWindow:!1})}};u[t]=l,n.pluginStartedAndHasAtLeastOneProfile(t,e.bind(l.getImportedRevisions,l))},this)}})});