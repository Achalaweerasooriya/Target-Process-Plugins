define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/core/keyboard.manager","tp/plugins/pluginsRepository","tp/plugins/commandGateway","tp/plugins/vcs/viewDiff/sourcePopup","tp/plugins/vcs/viewDiff/diffPopup"],function(_,$,a,b,c,d,e,f){function h(a){var b=document.createElement("link");b.type="text/css",b.rel="stylesheet",b.href=a,document.getElementsByTagName("head")[0].appendChild(b)}var g=["Subversion","Git"];return h(require.toUrl("tp/codemirror/theme/default.css")),a.extend({plugins:[],"bus afterRender+dataBind":function(a){var b=this.plugins,h=_.pluck(a.dataBind.data.items,"id"),i=this;_.each(g,function(g){var j={pluginName:g},k=new d(j),l={extension:this,pluginName:g,commandGateway:k,revisions:h,viewSourcePopup:e,viewDiffPopup:f,getImportedRevisions:function(a){this.commandGateway.execute("GetImportedRevisions",this.revisions,$.proxy(this.getImportedRevisionsSuccess,this))},getImportedRevisionsSuccess:function(b){if(b.length==0)return;var c=a.afterRender.data.element,d={};for(var e=0;e<b.length;e++)d[b[e]]=!0;c.find(".ui-revisionList > tbody").each(function(a){var b=$(this),c=b.tmplItem().data;d.hasOwnProperty(c.id)&&a.attachViewDiffBehaviourForElement(b)},[this])},attachViewDiffBehaviourForElement:function(a){var b=a.tmplItem().data,c=a.find(".files");c.each(function(a){var c=$(this),d=c.tmplItem().data,e=c.find(".vcsViewDisabled");d.fileAction!="Deleted"&&(e.attr("href","#").removeAttr("disabled").addClass("vcsView"),e.click(function(c){c.preventDefault(),a.showView(b.id,b.sourceControlId,d.fileName)}),e.removeClass("vcsViewDisabled"));if(d.fileAction==="Modified"){var f=c.parent().find(".diff");f.append($('<a href="#" class="_diff button small">Diff</a>').click(function(c){c.preventDefault(),a.showDiff(b.id,b.sourceControlId,d.fileName)}))}},[this])},showView:function(a,b,c){var d=i.config;d.context.configurator.getKeyBoardManager().pushHandler({handleKeyDown:function(a){a.keyCode==27&&d.context.configurator.getKeyBoardManager().popHandler()}}),this.viewSourcePopup.loading();var e=this;this.commandGateway.execute("ViewSource",{TpRevisionId:a,Path:c},function(a){var d=a.Content||"File is empty";e.viewSourcePopup.view(b,d,c)},null,this.showError)},showDiff:function(a,b,c){var d=i.config;d.context.configurator.getKeyBoardManager().pushHandler({handleKeyDown:function(a){a.keyCode==27&&d.context.configurator.getKeyBoardManager().popHandler()}}),this.viewDiffPopup.loading();var e=this;this.commandGateway.execute("ViewDiff",{TpRevisionId:a,Path:c},function(a){e.viewDiffPopup.view(b,a,c)},null,this.showError)},showError:function(a){$("<div />").html('<p class="p-15">'+a+"</p>").popup({title:"Error occured",fitToWindow:!1})}};b[g]=l,c.pluginStartedAndHasAtLeastOneProfile(g,$.proxy(l.getImportedRevisions,l))},this)}})})