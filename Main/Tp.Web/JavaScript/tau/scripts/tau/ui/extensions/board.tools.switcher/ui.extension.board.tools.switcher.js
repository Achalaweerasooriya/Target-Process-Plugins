define(["Underscore","jQuery","tau/core/extension.base"],function(_,$,ExtensionBase){return ExtensionBase.extend({topPadding:150,pagerHeight:0,"bus initialize":function(evt,initConfig){var self=this,options=self._extractOptions(initConfig,{settingsName:"board_tools_visible"}),context=initConfig.context,configurator=context.configurator;self.fire("config.ready",options),self.fire("context.ready",context),self.fire("configurator.ready",configurator)},"bus afterInit":function(evt){var configurator=evt.data.config.context.configurator,self=this;configurator.getComponentBusRegistry().getByName("board_plus").done(function(bus){self.setBoardBus(bus)})},"bus config.ready:last+configurator.ready:last+afterInit":function(evt){var config=_.values(evt)[0].data,configurator=_.values(evt)[1].data,self=this,settingsManager=configurator.getSettingsManager(),settingsName=config.settingsName;settingsManager.get({fields:[settingsName],callback:function(r){var value=!!r[settingsName];self.fire("dataBind",{visibility:value})}})},"bus childComponentCreated":function(evt){var component=evt.data;component.name==="board.tools.container"&&this.setComponentBoardToolsContainer(component)},"bus afterRender":function(evt){var $element=evt.data.element,self=this,$boardMapElement=$element.find("[role=action-switchmap]");this.boadMapPopupConfig={target:$boardMapElement,alignTo:$boardMapElement,zIndex:"",onShow:function(){self.fire("visibility.switched",!1),$boardMapElement.addClass("tau-checked")},onHide:function(){$boardMapElement.removeClass("tau-checked"),self.fire("visibility.switched",!1)},onPositionConfig:function(){var offset="-12 3",position={of:$element,collision:"none none",my:"left bottom",at:"left top",offset:offset};return position},onShow:function(){$boardMapElement.addClass("tau-checked"),$boardMapElement.tauBubble("widget").addClass("tau-tools-popup tau-tools-board-map")},onHide:function(){$boardMapElement.removeClass("tau-checked")},componentsConfig:{components:[{type:"board.tools.container",settingsName:"board_tools_visible",children:[{type:"board.paging",boardName:"board_plus"},{type:"board.overview",boardElement:this.boardElement,width:$.browser.msie?206:207}]}]}},this.calculateAndUpdateHeightOfBoardMapPopup(),this.onWindowResizeHandler=_.bind(this.calculateAndUpdateHeightOfBoardMapPopup,this),$(window).bind("resize",this.onWindowResizeHandler),this.fire("initBubble",this.boadMapPopupConfig);var $legendSwitcher=$element.find("[role=action-switchlegend]"),bubbleConfig={target:$legendSwitcher,alignTo:$legendSwitcher,content:'<div class="tau-card-legend"/>',zIndex:"",onPositionConfig:function(){var position={of:$legendSwitcher,collision:"none none",my:"right bottom",at:"right top",offset:"19 0"};return position},onShow:function(){$legendSwitcher.addClass("tau-checked"),$legendSwitcher.tauBubble("widget").addClass("tau-tools-popup")},onHide:function(){$legendSwitcher.removeClass("tau-checked")}};$legendSwitcher.tauBubble(bubbleConfig)},"bus config.ready:last+configurator.ready:last+visibility.switched":function(evt){var config=_.values(evt)[0].data,configurator=_.values(evt)[1].data,visibility=_.values(evt)[2].data,self=this,settingsManager=configurator.getSettingsManager(),settingsName=config.settingsName,set={};set[settingsName]=visibility,settingsManager.set({set:set,callback:function(r){}})},setBoardBus:function(boardBus){var self=this;this.boardBus&&this.boardBus.removeAllListeners(this),this.boardBus=boardBus,boardBus&&(boardBus.on("overview.board.retrieved",function(e){this.setBoardElement(e.data),this.boadMapPopupConfig&&(this.boadMapPopupConfig.componentsConfig.components[0].children[1].boardElement=self.boardElement)},this),boardBus.on("board.paging.settings",function(evt){var verticalPageNumber=(evt.data.y||{totalPages:1}).totalPages,pagerHeight=(verticalPageNumber>1?verticalPageNumber:0)*18;pagerHeight!=this.pagerHeight&&(this.pagerHeight=pagerHeight,this.calculateAndUpdateHeightOfBoardMapPopup())},this),boardBus.on("overview.board.updated",function(e){this.boardElement==e.data?this.boardOverview&&this.boardOverview.fire("refresh"):this.setBoardElement(e.data)},this),boardBus.fire("overview.board.retrieve"))},setBoardElement:function(boardElement){this.boardElement&&this.boardElement.find(".i-role-grid").unbind("scroll.overview"),this.boardElement=boardElement,boardElement&&this.boardElement.find(".i-role-grid").bind("scroll.overview",_.bind(function(){this.boardOverview&&this.boardOverview.fire("updateVisiblerPosition")},this)),this.boardOverview&&this.boardOverview.fire("setBoardElement",boardElement)},setComponentBoardToolsContainer:function(boardToolsContainer){this.boardToolsContainer&&this.boardToolsContainer.removeAllListeners(this),this.boardToolsContainer=boardToolsContainer,boardToolsContainer&&boardToolsContainer.on("children.ready",function(evt){var overviewBus=_.find(evt.data,function(childData){return childData.config.type=="board.overview"}).bus;this.setBoardOverview(overviewBus)},this)},setBoardOverview:function(boardOverview){this.boardOverview&&this.boardOverview.removeAllListeners(this),this.boardOverview=boardOverview,boardOverview&&boardOverview.on("svg.ready",function(){this.boardToolsContainer.fire("adjustPosition")},this)},setBoardOverviewHeight:function(height){this.boadMapPopupConfig&&(this.boadMapPopupConfig.componentsConfig.components[0].children[1].height=height),this.boardOverview&&this.boardOverview.fire("setHeight",height)},calculateAndUpdateHeightOfBoardMapPopup:function(){var height=$("body").height()-(this.topPadding+this.pagerHeight);this.setBoardOverviewHeight(height)},destroy:function(){this.onWindowResizeHandler&&$(window).unbind("resize",this.onWindowResizeHandler),this.setBoardBus(null),this.setBoardOverview(null),this.setComponentBoardToolsContainer(null),this.setBoardElement(null),this._super.apply(this,arguments)}})})