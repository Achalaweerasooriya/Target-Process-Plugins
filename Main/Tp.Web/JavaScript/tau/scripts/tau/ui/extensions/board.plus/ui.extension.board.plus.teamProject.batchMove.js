define(["Underscore","jQuery","tau/core/extension.base","tau/libs/store2/store2","tau/utils/utils.serverErrorTranslator"],function(e,t,r,i,n){return r.extend({resetLifecycle:!0,init:function(e){this._super(e);var t=e.context.configurator;this.confirmTemplate=t.getTemplateFactory().register({name:"board.plus.teamProject.batchMove.confirm",engine:"jqote2",markup:['<div class="tau-system-message-body-inner">',"<h3>Please, confirm</h3>",'<p><a class="tau-target-link i-role-actionassign"">Assign</a>  all people from <%! this.teamTerm %> to <%! this.projectTerm %>?<p>',"</div>"]}),this.successTemplate=t.getTemplateFactory().register({name:"board.plus.teamProject.batchMove.success",engine:"jqote2",markup:['<div class="tau-system-message-body-inner">',"<h3>Success!</h3>","<p><%! this.count %> new <% if (this.count !== 1){%>people<%}%><% else {%>person<%}%> from <%! this.teamTerm %> assigned to <%! this.projectTerm %><p>","</div>"]})},"bus slice.ready + configurator.ready:last + domWrapper.ready:last":function(t,r,i,n){var o=r.full?r.full.config.definition:{},a=e.chain(o.cells?o.cells.types:[]).reject(function(e){return"project"!==e.type&&"team"!==e.type}).value();if(1===a.length){var s,c=e.intersection(o.x?o.x.types:[],["project","team"]);1===c.length?s="x":(c=e.intersection(o.y?o.y.types:[],["project","team"]),1===c.length&&(s="y")),s&&1===c.length&&(r.full.on("after.moveBatch",function(e,t){this._afterBatchMove(t,s,c,i,n)}.bind(this)),r.full.on("after.moveAndPrioritizeBatch",function(e,t){this._afterBatchMove(t,s,c,i,n)}.bind(this)))}},_afterBatchMove:function(t,r,i,n,o){var a=t.command.config.$set.items[0];if("x"===r&&a.oldX!=a.x||"y"===r&&a.oldY!=a.y){var s={};s[r]=a[r];var c=o.getAxisCellByCoordinate(s),m=c.find("[data-id="+s[r]+"]"),l=0===m.length;if(l)return;var d=m.data("entity-id");if(d){var u=e.map(t.result.items,function(e){return e.items[0].dataItem.data.cardData.id}),f=n.getTemplateFactory().termProcessor,p=f.getTerm("team","project"===i[0]&&u.length>1?"names":"name"),h=f.getTerm("project","team"===i[0]&&u.length>1?"names":"name"),j=this.confirmTemplate.get().bind({},{teamTerm:p,projectTerm:h});
j.on("click",".i-role-actionassign",function(e){e.preventDefault(),"project"===i[0]?this._assignAllPeopleFromTeamsToProject(n,d,u,h,p):"team"===i[0]&&this._assignAllPeopleFromTeamToProjects(n,d,u,f.getTerm("project","name"),p)}.bind(this)),this.fire("notification",{$node:j,disableAutoClose:!0})}}},_assignAllPeopleFromTeamsToProject:function(t,r,o,a,s){var c=new i(t);c.findAll("user?select={id}&where=(ProjectMembers.Count(Project.Id="+r+") = 0 and TeamMembers.Count(Team.Id in ["+o.join(",")+"]) > 0)&take=9999").done(function(i){if(i.length>0){var n=[];n.push({projectId:r,set:{projectMembers:e.map(i,function(e){return{user:{id:e.id}}})}}),this._addProjectMembers(t,n,a,s)}else{var o=this.successTemplate.get().bind({},{count:"No",projectTerm:a,teamTerm:s});this.fire("notification",{$node:o})}}.bind(this)).fail(function(e){var t=n.translateXhrError(e);this.fire("error",t)}.bind(this))},_assignAllPeopleFromTeamToProjects:function(t,r,o,a,s){var c=new i(t);c.findAll("TeamProject?select={"+["id","Team.TeamMembers.Select(User.id) as teamMembers","Team.TeamMembers.Count() as teamMembersCount","new("+["Project.id","Project.ProjectMembers.Select(User.id) as projectMembers"].join(",")+") as project"].join(",")+"}&where=(Project.id in ["+o.join(",")+"] and Team.id="+r+")&take=9999").done(function(r){var i=[];if(e.forEach(r,function(t){var r=e.difference(t.teamMembers,t.project.projectMembers);r.length>0&&i.push({projectId:t.project.id,set:{projectMembers:e.map(r,function(e){return{user:{id:e}}})}})}),i.length>0)this._addProjectMembers(t,i,a,s);else{var n=this.successTemplate.get().bind({},{count:"No",projectTerm:a,teamTerm:s});this.fire("notification",{$node:n})}}.bind(this)).fail(function(e){var t=n.translateXhrError(e);this.fire("error",t)}.bind(this))},_addProjectMembers:function(t,r,i,n){var o=t.getStore(),a=[],s=[];e.forEach(r,function(t){s.push(function(r){o.save("project",{id:t.projectId,$set:t.set,fields:["id","name","color",{projectMembers:[{user:["id","firstName","lastName","avatarUri"]},{role:["id","name"]}]}]}).done({success:function(i){a=a.concat(e.difference(e.map(t.set.projectMembers,function(e){return e.user.id
}),a)),r(!1,i[0].data)}})})}),e.parallel(s,function(e,t){if(t.length){var r=this.successTemplate.get().bind({},{projectTerm:i,teamTerm:n,count:a.length});this.fire("notification",{$node:r})}}.bind(this))}})});