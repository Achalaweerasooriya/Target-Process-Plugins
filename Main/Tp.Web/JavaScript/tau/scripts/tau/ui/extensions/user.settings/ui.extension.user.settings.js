define(["Underscore","jQuery","tau/ui/extensions/ui.extension.domOperationsBase","tau/nls/translator","libs/jquery/jquery.inputMaskEditor"],function(e,t,a,i){return a.extend({_uiSelectorsByFieldName:{login:".tau-login",email:".tau-email",weeklyAvailableHours:".tau-weekly-hours",activeDirectoryName:".tau-active-directory-name",isActive:".tau-is-active-container",isObserver:".tau-is-observer-container",isAdministrator:".tau-is-administrator-container",password:".tau-password,.tau-password-confirmation"},init:function(){this._super.apply(this,arguments),this._isSsoEnabled=this.config.context.configurator.getSystemInfo().isSsoEnabled,this._isAdmin=this.config.context.configurator.getLoggedUser().isAdministrator,this.onSaveProxy=e.bind(this.onSave,this),this.onDeleteProxy=e.bind(this.onDelete,this)},"bus afterRender":function(e,a){this.fire("view.update.state");var i=this.config.context.applicationContext.culture.decimalSeparator,s="^[0-9]*(["+i+"][0-9]{0,2})?$";a.element.find(".tau-weekly-hours").inputMaskEditor({mask:s,className:""}),a.element.on("submit",this.onSaveProxy),a.element.find(".tau-btn.tau-delete").click(this.onDeleteProxy),this._shouldDisableEmail()&&t(a.element).find(this._uiSelectorsByFieldName.email).attr("disabled",!0).attr("title","Only administrators can edit email if Single sign-on is enabled")},"bus afterRender:last+dataBind:last+view.state.updated":function(t,a,i,s){var r=!0;e.each(i,function(e,t){s.hasOwnProperty(t)&&s[t]!=e&&(r=!1)}),(s.password&&s.password.length>0||s.passwordConfirmation&&s.passwordConfirmation.length>0)&&(r=!1)},"bus refresh>afterRender:last>model.data.changed":function(e,t,a,i){for(var s in this._uiSelectorsByFieldName)void 0!==i[s]&&this.fire("updateElement",{element:a.element.find(this._uiSelectorsByFieldName[s])})},"bus afterRender:last+before_view.save.changes":function(t,a,s){s=this.getState(a.element);var r=[],o=!1,n={selector:".tau-weekly-hours",hasError:!1};r.push(n),e.isNaN(parseInt(s.weeklyAvailableHours))&&(n.hasError=o=!0,n.message=i("Please provide weekly hours"));
var l={selector:".tau-login",hasError:!1};if(r.push(l),""==s.login&&(l.hasError=o=!0,l.message=i("Please enter login")),!this._shouldDisableEmail()){var d={selector:".tau-email",hasError:!1};r.push(d),""!=s.email?this.config.context.configurator.getConstObject().get("emailRegexp").test(e.trim(s.email))||(d.hasError=o=!0,d.message=i("Invalid email address")):(d.hasError=o=!0,d.message=i("Please enter email"))}var u={selector:".tau-active-directory-name",hasError:!1};r.push(u);var c=s.activeDirectoryName,h=c&&c.length>0,m=/(^[A-Za-z0-9.-]+)\\(?! +)([^\\/"\[\]:|<>+=;,?*@]+)$/.test(c);h&&!m&&(u.hasError=o=!0,u.message=i("Invalid active directory user name"));var f={selector:".tau-password",hasError:!1},v={selector:".tau-password-confirmation",hasError:!1};r.push(f),r.push(v);var g=s.password&&s.password.length>0||s.passwordConfirmation&&s.passwordConfirmation.length>0,p=s.password===s.passwordConfirmation;g&&!p&&(v.hasError=f.hasError=o=!0,v.message=f.message=i("Your password and confirmation password don't match")),e.each(r,function(e){var t=a.element.find(e.selector);e.hasError?t.addClass("tau-error").attr("title",e.message):t.removeClass("tau-error").removeAttr("title")}),o&&t["before_view.save.changes"].cancelMain()},"bus dataBind:last+view.save.changes":function(e,t,a){var i=this.getChanges(t,a);this.fire("model.save",i)},_shouldDisableEmail:function(){return this._isSsoEnabled&&!this._isAdmin},getChanges:function(t,a){var i=["login","email","password","weeklyAvailableHours","isActive","isObserver","isAdministrator","activeDirectoryName"],s={};return e.each(i,function(e){(t[e]||"")!=a[e]&&(s[e]=a[e])}),s},onSave:function(e){return this.fire("view.save.changes",this.getState(t(e.target))),!1},onDelete:function(){confirm(i("Do you really want to delete user?"))&&this.fire("remove",{id:this.config.context.entity.id})},getState:function(e){var t=e.find(".tau-password").val(),a={login:e.find(".tau-login").val(),email:e.find(".tau-email").val(),password:t.length>0?t:void 0,passwordConfirmation:e.find(".tau-password-confirmation").val(),weeklyAvailableHours:e.find(".tau-weekly-hours").val(),activeDirectoryName:e.find(".tau-active-directory-name").val(),isAdministrator:e.find(".tau-is-admin").prop("checked"),isObserver:e.find(".tau-is-observer").prop("checked"),isActive:e.find(".tau-is-active").prop("checked")};
return this._shouldDisableEmail()&&delete a.email,a}})});