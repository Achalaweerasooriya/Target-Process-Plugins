define(["Underscore","jQuery","tau/ui/extensions/ui.extension.domOperationsBase","tau/nls/translator","libs/jquery/jquery.inputMaskEditor"],function(e,a,t,r){return t.extend({init:function(){this._super.apply(this,arguments),this.onSaveProxy=e.bind(this.onSave,this),this.onDeleteProxy=e.bind(this.onDelete,this)},"bus afterRender":function(e,a){this.fire("view.update.state");var t=this.config.context.applicationContext.culture.decimalSeparator,r="^[0-9]*(["+t+"][0-9]{0,2})?$";a.element.find(".tau-weekly-hours").inputMaskEditor({mask:r,className:""}),a.element.on("submit",this.onSaveProxy),a.element.find(".tau-btn.tau-delete").click(this.onDeleteProxy)},"bus afterRender:last+dataBind:last+view.state.updated":function(a,t,r,s){var i=!0;e.each(r,function(e,a){s.hasOwnProperty(a)&&s[a]!=e&&(i=!1)}),(s.password&&s.password.length>0||s.passwordConfirmation&&s.passwordConfirmation.length>0)&&(i=!1)},"bus refresh>afterRender:last>model.data.changed":function(e,a,t,r){var s={login:".tau-login",email:".tau-email",weeklyAvailableHours:".tau-weekly-hours",activeDirectoryName:".tau-active-directory-name",isActive:".tau-is-active-container",isObserver:".tau-is-observer-container",isAdministrator:".tau-is-administrator-container",password:".tau-password,.tau-password-confirmation"};for(var i in s)void 0!==r[i]&&this.fire("updateElement",{element:t.element.find(s[i])})},"bus afterRender:last+before_view.save.changes":function(a,t,s){s=this.getState(t.element);var i=[],o=!1,n={selector:".tau-weekly-hours",hasError:!1};i.push(n),e.isNaN(parseInt(s.weeklyAvailableHours))&&(n.hasError=o=!0,n.message=r("Please provide weekly hours"));var l={selector:".tau-login",hasError:!1};i.push(l),""==s.login&&(l.hasError=o=!0,l.message=r("Please enter login"));var u={selector:".tau-email",hasError:!1};i.push(u),""!=s.email?this.config.context.configurator.getConstObject().get("emailRegexp").test(e.trim(s.email))||(u.hasError=o=!0,u.message=r("Invalid email address")):(u.hasError=o=!0,u.message=r("Please enter email"));
var d={selector:".tau-active-directory-name",hasError:!1};i.push(d);var c=s.activeDirectoryName,h=c&&c.length>0,v=/(^[A-Za-z0-9.-]+)\\(?! +)([^\\/"\[\]:|<>+=;,?*@]+)$/.test(c);h&&!v&&(d.hasError=o=!0,d.message=r("Invalid active directory user name"));var m={selector:".tau-password",hasError:!1},f={selector:".tau-password-confirmation",hasError:!1};i.push(m),i.push(f);var p=s.password&&s.password.length>0||s.passwordConfirmation&&s.passwordConfirmation.length>0,g=s.password===s.passwordConfirmation;p&&!g&&(f.hasError=m.hasError=o=!0,f.message=m.message=r("Your password and confirmation password don't match")),e.each(i,function(e){var a=t.element.find(e.selector);e.hasError?a.addClass("tau-error").attr("title",e.message):a.removeClass("tau-error").removeAttr("title")}),o&&a["before_view.save.changes"].cancelMain()},"bus dataBind:last+view.save.changes":function(e,a,t){var r=this.getChanges(a,t);this.fire("model.save",r)},getChanges:function(a,t){var r=["login","email","password","weeklyAvailableHours","isActive","isObserver","isAdministrator","activeDirectoryName"],s={};return e.each(r,function(e){(a[e]||"")!=t[e]&&(s[e]=t[e])}),s},onSave:function(e){return this.fire("view.save.changes",this.getState(a(e.target))),!1},onDelete:function(){confirm(r("Do you really want to delete user?"))&&this.fire("remove",{id:this.config.context.entity.id})},getState:function(e){var a=e.find(".tau-password").val();return{login:e.find(".tau-login").val(),email:e.find(".tau-email").val(),password:a.length>0?a:void 0,passwordConfirmation:e.find(".tau-password-confirmation").val(),weeklyAvailableHours:e.find(".tau-weekly-hours").val(),activeDirectoryName:e.find(".tau-active-directory-name").val(),isAdministrator:e.find(".tau-is-admin").prop("checked"),isObserver:e.find(".tau-is-observer").prop("checked"),isActive:e.find(".tau-is-active").prop("checked")}}})});