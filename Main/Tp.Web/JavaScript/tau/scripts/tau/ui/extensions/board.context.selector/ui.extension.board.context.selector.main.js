define(["Underscore","jQuery","tau/core/extension.base"],function(e,t,i){return i.extend({ANY_TEAM_OR_PROJECT:"Any",NO_TEAM_OR_PROJECT:"None",init:function(e){this._super(e),this.config=e||{};var t=this.config.context.configurator.getFeaturesService();this._minProjectsCount=t.isEnabled("hide.noProject")?0:1},"bus afterRender":function(e,t){this.fire("$el.ready",t.element)},"bus configurator.ready:last + $el.ready":function(e,i,s){var r=this,o=s.find(".i-role-action-submit");this.fire("$submitButton.ready",o),o.on("click",function(){r.fire("filter.submitted")}),this.fire("$teamSection.ready",s.find(".tau-teams")),this.fire("$projectSection.ready",s.find(".tau-projects")),this.fire("$sections.ready",s.find(".tau-teams, .tau-projects")),this.fire("$assignSection.ready",s.find(".tau-teams-projects-updater")),s.on("click",".i-role-selecttrigger",function(e){var i=t(e.currentTarget).data(),s="team"==i.entityType?[i.entityId]:[r.ANY_TEAM_OR_PROJECT],o="project"==i.entityType?[i.entityId]:[r.ANY_TEAM_OR_PROJECT];r.fire("model.setFilter",{selectedTeamsIds:s,selectedProjectsIds:o})});var a=s.find(".i-role-process-setup-link");s.find(".tau-projects .i-role-list .i-role-project").length===this._minProjectsCount&&a.hide(),a.on("click",function(){this.showSetupProcess(i,s)}.bind(this))},"bus $el.ready:last + filter.submitted":function(e,t){this.fire("model.setFilter",this.getCurrentState(t))},"bus $el.ready + $submitButton.ready":function(e,t,i){t.on("change",":checkbox",function(){i.hasClass("tau-teams-projects-submit_highlighted_true")||i.animateWithCss({cssClassName:"tau-teams-projects-submit_highlighted_true"})})},"bus configurator.ready:last + $teamSection.ready:last + team.add.success":function(e,t,i,s){var r=i.find(":checkbox[value="+s.id+"]").length;r||(this._addToList(i,t.getTemplateFactory().get("board.context.selector.teams.list"),s),i.removeClass("tau-managed-category_isempty_true"),this.fire("team.add.completed"))},"bus configurator.ready:last + $projectSection.ready:last + project.saved":function(e,t,i,s){var r=t.getTemplateFactory().get("board.context.selector.projects.list"),o=i.find(":checkbox[value="+s.id+"]").closest("li");
if(0===o.length)this._addToList(i,r,s),i.removeClass("tau-managed-category_isempty_true"),this.fire("project.add.completed");else{var a=o.closest(".i-role-program",i);a.length&&this.fire("program.save",{id:a.find(".i-role-select-program :checkbox").val()}),!s.program&&a.length&&this._moveInList(i,r,s)}},"bus $el.ready+project.add.completed":function(e,t){var i=t.find(".i-role-process-setup-link");i.is(":visible")||i.show();var s=t.find(".tau-teams-projects-updater");s.hasClass("tau-teams-projects-updater_state_enabled")||s.addClass("tau-teams-projects-updater_state_enabled")},showSetupProcess:function(i,s){var r=s.find(".tau-projects .i-role-list .i-role-project :checked"),o=s.find(".tau-projects .i-role-list .i-role-project :checkbox"),a=r.length>this._minProjectsCount&&r.length===o.length,n=r.length===this._minProjectsCount&&this._minProjectsCount>0&&r[0].value===this.NO_TEAM_OR_PROJECT,c=!r.length||a||n?o:r,d=e.find(c,function(e){return e.value!==this.NO_TEAM_OR_PROJECT},this);if(d){var l=t(d).data("processId");l&&i.getWorkflowService().editProcess(i,l)}},getCurrentState:function(e){var t={},i=this,s=function(){return this.value==i.NO_TEAM_OR_PROJECT?i.NO_TEAM_OR_PROJECT:parseInt(this.value,10)},r=e.find(".tau-teams .i-role-list :checked"),o=e.find(".tau-teams .i-role-list :checkbox");return t.selectedTeamsIds=!r.length||r.length>1&&r.length==o.length?[this.ANY_TEAM_OR_PROJECT]:r.map(s).toArray(),r=e.find(".tau-projects .i-role-list .i-role-project :checked"),o=e.find(".tau-projects .i-role-list .i-role-project :checkbox"),t.selectedProjectsIds=!r.length||r.length>this._minProjectsCount&&r.length==o.length?[this.ANY_TEAM_OR_PROJECT]:r.map(s).toArray(),t},_addToList:function(t,i,s){s.selected=!0;var r=i.bind({},s),o=t.find(".i-role-list"),a=o.find(".i-role-item:first");a.length?a.after(r):o.append(r),o.parent().scrollTo(0,{duration:500}),r.addClass("tau-added"),e.delay(function(){r.removeClass("tau-added")},1500)},_moveInList:function(e,t,i){var s=t.bind({},i),r=e.find(".i-role-list");
i.selected?s.insertAt(r,1):s.appendTo(r)}})});