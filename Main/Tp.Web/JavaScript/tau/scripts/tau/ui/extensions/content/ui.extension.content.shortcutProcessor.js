define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/utils/utils.htmlConverter","tau/core/termProcessor"],function(t,e,n,r,i){return n.extend({FIELDS:["id","name",{entityType:["id","name"]}],"bus beforeInit + afterRender":function(n,r,i){var s=r.config.shortcutProcessorTarget,a=i.element.find(s);e.when(this.processShortcuts(a,r.config.context)).then(t.bind(this.fire,this,"shortcuts.completed",{}))},processShortcuts:function(n,r){var i=t.values(this._replaceEntityIds(n)),s=e.Deferred();return t.any(i)?r.configurator.getStore().find("general",{fields:this.FIELDS,$query:{id:{$in:i}}}).done({success:this.safeCallback(function(t){this._replaceShortcutsWithLink(i,t[0].data,n,r),s.resolve()})}):s.resolve(),s},_replaceEntityIds:function(t){var n=/\b(?:id):(?:\W|&nbsp;){0,5}(\d{1,9})\b/gi,i={};return t.each(function(t,s){var a=e(s),o=!1,c=a.html().replace(n,function(){o=!0;var t=arguments[1];return i[t]=t,'<span class="tau-shortcut tau-shortcut_state_loading" data-entity-id="'+t+'">id:'+t+"</span>"}),u=r.replacePlainTextUrlWithHTML(c,!1);c!=u&&(c=u,o=!0),o&&a.html(c)}),i},_replaceShortcutsWithLink:function(e,n,r,s){this.urlBuilder=s.configurator.getUrlBuilder();var a=s.getTerms?s.getTerms():[];this.processor=new i(a),t.forEach(e,function(e){var i=t.find(n,function(t){return t.id==e}),s=r.find(".tau-shortcut[data-entity-id="+e+"]");i?this._replaceShortcutWithLink(s,i):this._replaceNotFoundShortcutWithLink(s,{id:e})},this)},_replaceNotFoundShortcutWithLink:function(t,n){t.each(function(){e(this).toggleClass("tau-shortcut_state_loading",!1).toggleClass("tau-shortcut_state_failure",!0).attr("title","Entity with id "+n.id+" is not found")})},_replaceShortcutWithLink:function(t,n){var r=this.urlBuilder.getNewViewUrl(n.id,n.entityType.name,!0),i="#"+n.id+"&nbsp;"+e.jqotenc(n.name),s=this.processor.getTerm(n.entityType.name)+" #"+n.id+" "+n.name;t.each(function(){var t=e('<a class="tau-shortcut"></a>');t.replaceAll(e(this)).attr("href",r).html(i).attr("title",s).toggleClass("tau-shortcut_state_loading",!1).toggleClass("tau-shortcut_state_success",!0)
})}})});