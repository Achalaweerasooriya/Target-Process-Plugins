define(["jQuery","tau/core/extension.base"],function($,ExtensionBase){return ExtensionBase.extend({resetLifecycle:!0,"bus configurator.ready":function(ev,configurator){var self=this,clipboardManager=configurator.getClipboardManager();clipboardManager.getAll(function(err,cards){self.fire("cardsData.ready",{cards:cards,isInitial:!0})}),clipboardManager.unbind(this),clipboardManager.bind(this,function(err,cards){self.fire("cardsData.ready",{cards:cards,isInitial:!1})})},"bus configurator.ready+options.ready":function(evt,configurator,o){var self=this,clipboardManager=configurator.getClipboardManager(),process=_.bind(function(clipboardManager,operation,card){clipboardManager[operation](card)},this,clipboardManager);o.clipboard.processTimeout&&(process=_.debounce(process,o.clipboard.processTimeout)),self.fire("clipboardProcess.ready",process)},"bus $grid.ready":function(ev,$grid){var self=this;$grid.tauSelectable({items:".i-role-card",triggerSelector:":not(.tau-id)",ctrl:!0,selectOnMouseup:!0,className:"tau-selected",changed:function(event,ui){var $item=ui.item,selected=ui.selected;self.fire("view.card.selected",{element:$item,selected:selected})}}),self.fire("$selectable.ready",$grid),$grid.rselect({trigger:".i-role-cellholder, .i-role-cell",selectionClass:"tau-selected",selectable:".tau-cellholder .tau-card",show:function(){$(this).pscroller("enable")},end:function(evt,data){$(this).pscroller("disable"),$grid.tauSelectable("option","fireEvents",!1),$grid.tauSelectable("select",$(data.selection)),$grid.tauSelectable("option","fireEvents",!0),self.fire("view.card.selected",{element:$(data.selection),selected:!0}),self.fire("view.card.selected",{element:$(data.deselection),selected:!1})}})},"bus scrollManager.ready:last+$selectable.ready:last+view.card.selected":function(evt,scrollManager,$selectable,selectionData){var $layout=$selectable.closest(".tau-app-main-pane"),clipboardIsCollapsed=!$layout.hasClass("tau-layout-board_south-expanded_true"),$card=selectionData.element;clipboardIsCollapsed&&selectionData.selected&&_.delay(function(){var clipboardIsUncollapsed=$layout.hasClass("tau-layout-board_south-expanded_true");clipboardIsUncollapsed&&$card.length==1&&scrollManager.scrollToVisibility($card)},1e3)},"bus view.cell.skeleton.updated":function(evt,o){this.fire("$selectionScope.ready",o.element.parents(".i-role-grid:first"))},"bus overview.board.ready":function(evt,o){this.fire("$selectionScope.ready",o.element.find(".i-role-grid"))},"bus $selectable.ready:last+$selectionScope.ready:last+cardsData.ready:last":function(ev,$selectable,$scope,cardsData){this._applySelection($selectable,$scope,cardsData.cards,cardsData.isInitial)},"bus $selectable.ready:last+$selectionScope.ready:last+cardsData.ready:last + selection.reapply":function(ev,$selectable,$scope,cardsData){this._applySelection($selectable,$scope,cardsData.cards,cardsData.isInitial)},"bus $selectable.ready:last+clipboardProcess.ready:last+view.card.selected":function(ev,$selectable,clipboardProcess,selection){var $cards=selection.element,isSelected=selection.selected,addBatch=[],removeBatch=[],$selected=$selectable.tauSelectable("getSelected");$cards.each(function(){var $card=$(this),data=_.pick($card.data(),"id","entityId","entityType"),$alreadySelected=$selected.filter(function(){var $o=$(this),oData=$o.data();return data.id==oData.id&&data.entityType.toLowerCase()==oData.entityType.toLowerCase()&&$o.attr("id")!=$card.attr("id")}),avatarUri=$card.find(".tau-avatar img").prop("src");avatarUri=avatarUri&&avatarUri.replace(/\d+$/,"");if($alreadySelected.length==0){var card={id:data.id,data:{id:data.entityId,type:data.entityType,name:$card.find(".i-role-name").text(),icon:$card.find(".tau-icon").data("icon"),color:$card.find(".i-role-color").data("color"),avatarUri:avatarUri}};isSelected?addBatch.push(card):removeBatch.push(card)}}),clipboardProcess("add",addBatch),clipboardProcess("remove",removeBatch)},"bus $selectable.ready:last + sort.stopped":function(ev,$selectable,sortData){var ui=sortData[1],$cards=ui.items||$();$selectable.tauSelectable("option","fireEvents",!1),$selectable.tauSelectable("reset",$cards),$selectable.tauSelectable("option","fireEvents",!0)},"bus clipboardProcess.ready:last+view.card.batch.move.$successCards":function(ev,clipboardProcess,$cardsArray){var cardsData=[];_($cardsArray).each(function($card){var data=_.pick($card.data(),"id","entityId","entityType"),card={id:data.id,data:{id:data.entityId,type:data.entityType}};cardsData.push(card)}),clipboardProcess("remove",cardsData)},"bus clipboardProcess.ready:last + operation.notinslice":function(e,clipboardProcess,op){this._cometRemove(clipboardProcess,op.items)},"bus clipboardProcess.ready:last + operation.deleted":function(e,clipboardProcess,op){this._cometRemove(clipboardProcess,op.items)},_cometRemove:function(clipboardProcess,items){var cardsData=_.map(items,function(item){var data=item.data;return{id:data.id,data:{type:data.type}}});clipboardProcess("remove",cardsData)},_applySelection:function($selectable,$scopedEl,cardsData,isInitial){var HIGHLIGHT_CSS_CLASS="tau-card_selectedasdouble_true",$markedAsSelected=$selectable.tauSelectable("getSelected").filter(function(){return $(this).parents().is($scopedEl)}),$shouldBeSelected=$(),$actualCards=$scopedEl.find(".i-role-card");$actualCards.removeClass(HIGHLIGHT_CSS_CLASS),_(cardsData).each(function(item){var $cardsToHighlight=$actualCards.filter(function(){var d=$(this).data();return item.data.id==d.entityId&&item.data.type.toLowerCase()==d.entityType.toLowerCase()});$cardsToHighlight.addClass(HIGHLIGHT_CSS_CLASS);var $cardsToSelect=$cardsToHighlight.filter(function(){return $markedAsSelected.is(this)});$cardsToSelect.length&&($cardsToHighlight=$cardsToSelect),isInitial&&($cardsToHighlight=$cardsToHighlight.eq(0)),$shouldBeSelected=$shouldBeSelected.add($cardsToHighlight)});var $shouldBeReset=$markedAsSelected.not($shouldBeSelected);$selectable.tauSelectable("option","fireEvents",!1),$selectable.tauSelectable("reset",$shouldBeReset),$selectable.tauSelectable("select",$shouldBeSelected),$selectable.tauSelectable("option","fireEvents",!0)}})})