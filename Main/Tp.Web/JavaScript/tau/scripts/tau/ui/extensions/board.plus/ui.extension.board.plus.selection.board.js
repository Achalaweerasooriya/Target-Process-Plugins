define(["Underscore","jQuery","tau/core/extension.base"],function(e,t,a){return a.extend({resetLifecycle:!0,createSelectableContainers:function(e){return[{element:e[0]}]},"bus configurator.ready":function(e,t){var a=t.getClipboardManager();a.getAll(function(e,t){this.fire("cardsData.ready",{cards:t,isInitial:!0})}.bind(this)),a.unbind(this),a.bind(this,function(e,t){this.fire("cardsData.ready",{cards:t,isInitial:!1})}.bind(this))},"bus configurator.ready+options.ready":function(t,a,i){var l=e.bind(function(e,t,a){e[t](a)},this,a.getClipboardManager());i.clipboard.processTimeout&&(l=e.debounce(l,i.clipboard.processTimeout)),this.fire("clipboardProcess.ready",l)},"bus configurator.ready:last + $grid.ready":function(t,a,i){var l=this.createSelectableContainers(i);e.each(l,e.bind(this._configureSelectableItem,this,a,l))},"bus scrollManager.ready:last+$selectable.ready:last+view.card.selected":function(t,a,i,l){var r=i.closest(".tau-app-main-pane"),c=!r.hasClass("tau-layout-board_south-expanded_true"),n=l.element;c&&l.selected&&e.delay(function(){var e=r.hasClass("tau-layout-board_south-expanded_true");e&&1==n.length&&a.scrollToVisibility(n)},1e3)},"bus view.cell.skeleton.updated":function(e,t){this.fire("$selectionScope.ready",t.element.parents(".i-role-grid:first"))},"bus overview.board.ready":function(e,t){this.fire("$selectionScope.ready",t.element.find(".i-role-grid"))},"bus $selectable.ready:last+$selectionScope.ready:last+cardsData.ready:last":function(e,t,a,i){this._applySelection(t,a,i.cards,i.isInitial)},"bus $selectable.ready:last+$selectionScope.ready:last+cardsData.ready:last + selection.reapply":function(e,t,a,i){this._applySelection(t,a,i.cards,i.isInitial)},"bus configurator.ready:last + $selectable.ready:last+clipboardProcess.ready:last+view.card.selected":function(e,a,i,l,r){var c=r.element,n=r.selected,s=[],o=[],d=i.tauSelectable("getSelected").not(c);c.each(function(){var e=t(this),a=e.data(),i=d.filter(function(){var i=t(this),l=i.data();return a.id==l.id&&a.entityType.toLowerCase()==l.entityType.toLowerCase()&&i.attr("id")!=e.attr("id")});if(!i.length){var l;l={id:a.id,isSelected:!0,data:{cardData:a.cardData,id:a.entityId,type:a.entityType}},n?s.push(l):o.push(l)}}),l("add",s),l("remove",o)},"bus $selectable.ready:last + sort.stopped":function(e,a,i){var l=i[1],r=l.items||t();a.tauSelectable("option","fireEvents",!1),a.tauSelectable("reset",r),a.tauSelectable("option","fireEvents",!0)},"bus clipboardProcess.ready:last+view.card.batch.move.$successCards":function(t,a,i){var l=[];e(i).each(function(e){var t=e.data(),a={id:t.id,data:{cardData:t.cardData,id:t.entityId,type:t.entityType}};l.push(a)}),a("remove",l)},"bus clipboardProcess.ready:last + operation.notinslice":function(e,t,a){this._cometRemove(t,a.items)},"bus clipboardProcess.ready:last + operation.deleted":function(e,t,a){this._cometRemove(t,a.items)},_cometRemove:function(t,a){var i=e.map(a,function(e){var t=e.data;return{id:t.id,data:{type:t.type}}});t("remove",i)},_configureSelectableItem:function(e,a,i){var l="tau-selected",r=".tau-cellholder .tau-card-v2",c=":not(.tau-board-unit-not-selectable,[contenteditable=true])",n=".i-role-cellholder, .i-role-cell",s=t(i.element);s.tauSelectable({items:".i-role-card",triggerSelector:c,ctrl:!0,selectOnMouseup:!0,className:l,changed:function(e,t){var i=t.item,l=t.selected;this.fire("view.card.selected",{element:i,selected:l}),l&&this._clearSelectionExcept(a,s[0])}.bind(this)}),this.fire("$selectable.ready",s),s.pscroller({getScrollHeight:i.getScrollHeight,applyVerticalScrollOffset:i.applyVerticalScrollOffset}),s.rselect({getVerticalScrollPosition:i.getVerticalScrollPosition,clipHorizontal:i.clipHorizontal,clipVertical:i.clipVertical,trigger:this._concatSelectors([n,i.rectSelectTriggers]),selectionClass:l,selectable:r,show:function(e){t(e.target).pscroller("enable")},end:function(e,i){t(e.target).pscroller("disable"),s.tauSelectable("option","fireEvents",!1),s.tauSelectable("select",t(i.selection)),s.tauSelectable("option","fireEvents",!0),this.fire("view.card.selected",{element:t(i.selection),selected:!0}),this.fire("view.card.selected",{element:t(i.deselection),selected:!1}),this._clearSelectionExcept(a,s[0])}.bind(this)})},_applySelection:function(a,i,l,r){var c="tau-is-selected-duplicate",n=a.tauSelectable("getSelected").filter(function(){return t(this).parents().is(i)}),s=t(),o=i.find(".i-role-card");o.removeClass(c),e(l).each(function(e){var a=o.filter(function(){var a=t(this).data();return e.data.id==a.entityId&&e.data.type.toLowerCase()==a.entityType.toLowerCase()});a.length>1&&a.addClass(c);var i=a.filter(function(){return n.is(this)});i.length&&(a=i),r&&(a=a.eq(0)),s=s.add(a)});var d=n.not(s);a.tauSelectable("option","fireEvents",!1),a.tauSelectable("reset",d),a.tauSelectable("select",s),a.tauSelectable("option","fireEvents",!0)},_clearSelectionExcept:function(a,i){e.each(a,function(e){if(i!==e.element){var a=t(e.element);a.rselect("clearSelection"),a.tauSelectable("clearSelection")}})},_concatSelectors:function(t){return e.compact(t).join(", ")}})});