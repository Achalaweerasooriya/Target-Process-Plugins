define(["Underscore","jQuery","tau/core/extension.base"],function(e,t,a){return a.extend({resetLifecycle:!0,createSelectableContainers:function(e){return[{element:e[0]}]},"bus configurator.ready":function(e,t){var a=t.getClipboardManager();a.getAll(function(e,t){this.fire("cardsData.ready",{cards:t,isInitial:!0})}.bind(this)),a.unbind(this),a.bind(this,function(e,t){this.fire("cardsData.ready",{cards:t,isInitial:!1})}.bind(this))},"bus configurator.ready:last + destroy":function(e,t){var a=t.getClipboardManager();a.unbind(this)},"bus configurator.ready+options.ready":function(t,a,i){var r=e.bind(function(e,t,a){e[t](a)},this,a.getClipboardManager());i.clipboard.processTimeout&&(r=e.debounce(r,i.clipboard.processTimeout)),this.fire("clipboardProcess.ready",r)},"bus configurator.ready:last + $grid.ready":function(t,a,i){var r=this.createSelectableContainers(i);e.each(r,e.bind(this._configureSelectableItem,this,a,r))},"bus scrollManager.ready:last+$selectable.ready:last+view.card.selected":function(t,a,i,r){var l=i.closest(".tau-app-main-pane"),c=!l.hasClass("tau-layout-board_south-expanded_true"),n=r.element;c&&r.selected&&e.delay(function(){var e=l.hasClass("tau-layout-board_south-expanded_true");e&&1==n.length&&a.scrollToVisibility(n)},1e3)},"bus view.cell.skeleton.updated":function(e,t){this.fire("$selectionScope.ready",t.element.parents(".i-role-grid:first"))},"bus overview.board.ready":function(e,t){this.fire("$selectionScope.ready",t.element.find(".i-role-grid"))},"bus $selectable.ready:last+$selectionScope.ready:last+cardsData.ready:last":function(e,t,a,i){this._applySelection(t,a,i.cards,i.isInitial)},"bus $selectable.ready:last+$selectionScope.ready:last+cardsData.ready:last + selection.reapply":function(e,t,a,i){this._applySelection(t,a,i.cards,i.isInitial)},"bus configurator.ready:last + $selectable.ready:last+clipboardProcess.ready:last+view.card.selected":function(e,a,i,r,l){var c=l.element,n=l.selected,s=[],o=[],d=i.tauSelectable("getSelected").not(c);c.each(function(){var e=t(this),a=e.data(),i=d.filter(function(){var i=t(this),r=i.data();
return a.id==r.id&&a.entityType.toLowerCase()==r.entityType.toLowerCase()&&i.attr("id")!=e.attr("id")});if(!i.length){var r={id:a.id,isSelected:!0,data:{cardData:a.cardData,id:a.entityId,type:a.entityType}};n?s.push(r):o.push(r)}}),r("add",s),r("remove",o)},"bus $selectable.ready:last + sort.stopped":function(e,a,i){var r=i[1],l=r.items||t();a.tauSelectable("option","fireEvents",!1),a.tauSelectable("reset",l),a.tauSelectable("option","fireEvents",!0)},"bus clipboardProcess.ready:last+view.card.batch.move.$successCards":function(t,a,i){var r=e.map(i,function(e){var t=e.data();return{id:t.id,data:{cardData:t.cardData,id:t.entityId,type:t.entityType}}});a("remove",r)},"bus clipboardProcess.ready:last + operation.notinslice":function(e,t,a){this._cometRemove(t,a.items)},"bus clipboardProcess.ready:last + operation.deleted":function(e,t,a){this._cometRemove(t,a.items)},_cometRemove:function(t,a){var i=e.map(a,function(e){var t=e.data;return{id:t.id,data:{type:t.type}}});t("remove",i)},_configureSelectableItem:function(e,a,i){var r="tau-selected",l=".tau-cellholder .tau-card-v2",c=":not(.tau-board-unit-not-selectable,[contenteditable=true])",n=".i-role-cellholder, .i-role-cell",s=t(i.element);s.tauSelectable({items:".i-role-card",triggerSelector:c,ctrl:!0,selectOnMouseup:!0,className:r,changed:function(e,t){var i=t.item,r=t.selected;this.fire("view.card.selected",{element:i,selected:r}),r&&this._clearSelectionExcept(a,s[0])}.bind(this)}),this.fire("$selectable.ready",s),s.pscroller({getScrollHeight:i.getScrollHeight,applyVerticalScrollOffset:i.applyVerticalScrollOffset}),s.rselect({getVerticalScrollPosition:i.getVerticalScrollPosition,clipHorizontal:i.clipHorizontal,clipVertical:i.clipVertical,trigger:this._concatSelectors([n,i.rectSelectTriggers]),selectionClass:r,selectable:l,show:function(e){t(e.target).pscroller("enable")},end:function(e,i){t(e.target).pscroller("disable"),s.tauSelectable("option","fireEvents",!1),s.tauSelectable("select",t(i.selection)),s.tauSelectable("option","fireEvents",!0),this.fire("view.card.selected",{element:t(i.selection),selected:!0}),this.fire("view.card.selected",{element:t(i.deselection),selected:!1}),this._clearSelectionExcept(a,s[0])
}.bind(this)})},_applySelection:function(a,i,r,l){var c="tau-is-selected-duplicate",n=i[0],s=a.tauSelectable("getSelected").filter(function(){return n&&t.contains(n,this)}),o=i.find(".i-role-card");o.removeClass(c);var d=t(e.inject(r,function(e,a){var i=o.filter(function(){var e=t(this).data();return a.data.id==e.entityId&&a.data.type.toLowerCase()==e.entityType.toLowerCase()});i.length>1&&i.addClass(c);var r=i.filter(function(){return s.is(this)});return r.length&&(i=r),l&&(i=i.eq(0)),e.concat(i.toArray())},[])),u=s.not(d);a.tauSelectable("option","fireEvents",!1),a.tauSelectable("reset",u),a.tauSelectable("select",d),a.tauSelectable("option","fireEvents",!0)},_clearSelectionExcept:function(a,i){e.each(a,function(e){if(i!==e.element){var a=t(e.element);a.rselect("clearSelection"),a.tauSelectable("clearSelection")}})},_concatSelectors:function(t){return e.compact(t).join(", ")}})});