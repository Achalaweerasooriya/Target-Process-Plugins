define(["Underscore","tau/core/class"],function(t,i){return i.extend({init:function(t,i){this.store=t,this.entity=i,this.items=[],this.listenServer()},processString:function(i){var e=i.split(",");return e=t.compact(t.map(e,function(t){return t.trim()})),e=t.map(e,function(t){return{text:t}}),e=this.processUnique(e)},processUnique:function(i){return t.uniq(i,function(t){return t.text.toLowerCase()})},createString:function(i){return t.pluck(i,"text").join(", ")},load:function(){return this.store.getDef(this.entity.entityType.name,{id:this.entity.id,fields:["id","tags"]}).then(t.bind(function(t){this.items=this.processString(t.tags)},this))},addByString:function(t){var i=this.processString(t);return this.items=this.processUnique(this.items.concat(i)),this.save()},removeByString:function(i){return i=t.asString(i).trim(),this.items=t.reject(this.items,function(t){return t.text===i}),this.save()},save:function(){return this.store.saveDef(this.entity.entityType.name,{id:this.entity.id,$set:{tags:this.createString(this.items)}})},listenServer:function(){this.store.unbind(this),this.store.on({eventName:"afterSave",type:this.entity.entityType.name,filter:{id:this.entity.id},hasChanges:["tags"],listener:this},t.bind(function(t){var i=t.data.changes.tags;this.items=this.processString(i)},this))}})});