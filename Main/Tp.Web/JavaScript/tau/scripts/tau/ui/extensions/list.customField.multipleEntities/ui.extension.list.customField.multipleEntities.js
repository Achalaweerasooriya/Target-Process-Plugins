define(["Underscore","tau/core/extension.base"],function(e,t){return t.extend({"bus afterInit":function(e,t){this.store=t.config.context.configurator.getStore(),this.entity=t.config.context.entity,this._registerRefreshHandler(this.store,this.entity)},"bus afterInit + afterRender":function(e,t){this.customField=t.config.customField,this.fire("customField.ready",this.customField)},"bus afterInit:last + customField.ready + afterRender":function(e,t,i,n){var s=this;this._retrieveIdsForField(this.store,this.entity.id,this.entity.entityType.name,this.customField.name,function(e){var t=n.element.find(".i-role-remove");t.on("click",function(t){s._doDetach(t,e,s.store,s.customField,s.entity)})})},_doDetach:function(t,i,n,s,r){var o=$(t.currentTarget).attr("data-entity-id"),a=$(t.currentTarget).attr("data-entity-type").toLowerCase(),i=i;i=e.reject(i,function(e){return e==o+" "+a}).join(","),this._saveIds(n,r.id,r.entityType.name,s.name,i,function(){})},_saveIds:function(e,t,i,n,s,r){e.save(i,{id:t,$set:{customFields:[{name:n,value:s}]},fields:["id","customFields"]}).done(function(e){r&&r(e)})},_registerRefreshHandler:function(t,i){var n=this;t.unbind(this),t.on({eventName:"afterSave",type:i.entityType.name,listener:this,filter:{id:i.id},hasChanges:["customFields"]},function(t){var i=e.find(t.data.changes.customFields,function(e){return e.name==n.customField.name});i&&n.fire("refresh")})},_retrieveIdsForField:function(t,i,n,s,r){t.get(n,{id:i,fields:["customFields"]}).done(function(t){var i=e.find(t[0].data.customFields,function(e){return e.name==s}),n=null!=i.value?i.value.split(","):[];r(n)})}})});