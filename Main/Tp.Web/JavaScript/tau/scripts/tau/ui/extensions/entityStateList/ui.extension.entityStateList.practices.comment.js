define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/configurator","tau/utils/utils.textConverter"],function(_,$,a,b,c){var d=a.extend({"bus dataBind+afterRender":function(a){this.element=a.afterRender.data.element,this.dataToBind=a.dataBind.data},"bus focus.before":function(){this.element.find(".ui-entity-state-comment").remove()},"bus updateState":function(a){var b=this.entityStateId=a.data.id,c=_(this.dataToBind.states).detect(function(a){return a.id===b&&a.isCommentRequired});if(!c)return;a.cancel();var d=this.element;if(d.find(".ui-entity-state-comment").length>0){d.find(".ui-state-comment-field").focus();return}var e=d;e.find(".drop-down-list").listSelectable("disable");var f=$("<div class='ui-entity-state-comment'></div>").append($("<div class='ui-state-comment-header'>Please, provide comment</div>")).append($("<div class='ui-state-comment-field-container'></div>").append("<textarea rows='5' class='ui-state-comment-field'></textarea>")).append($("<div class='button-group'></div>").append($("<button type='button' class='save button'>Save</button>").click($.proxy(this._save,this))).append($("<button type='button' class='cancel button'>Cancel</button>").click($.proxy(this._cancel,this)))).appendTo(d),g=f.find(".ui-state-comment-field").focus(),h=f.find(".save"),i=function(){window.setTimeout(function(){var a=g.val()||"",b=a.trim().length===0;b?h.attr("disabled","disabled"):h.attr("disabled")&&h.removeAttr("disabled"),b?h.addClass("disable"):h.removeClass("disable")},50)};i(),h.bind("focus",i),g.bind("change keyup click propertychange paste",i)},_save:function(a){a.stopPropagation();var b=new c,d=this,e=this.element.find(".ui-state-comment-field").val(),f=b.convert(e,!0);d.fire("save",{$set:{entityState:{id:d.entityStateId},comments:[{description:f}]},$include:[{comments:["id","description"]}]})},_cancel:function(a){a.stopPropagation(),this.element.find(".ui-entity-state-comment").remove();var b=this.element.find(".ui-drop-down");b.find(".drop-down-list").listSelectable("enable"),b.show()}});return d})