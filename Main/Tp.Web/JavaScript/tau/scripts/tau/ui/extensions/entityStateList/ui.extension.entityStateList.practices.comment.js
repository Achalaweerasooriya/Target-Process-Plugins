define(["Underscore","jQuery","tau/components/extensions/component.extension.base","tau/utils/utils.textConverter","tau/ui/behaviour/common/ui.behaviour.listSelectable"],function(_,$,ExtensionBase,TextConverter){var stateListEditable=ExtensionBase.extend({"bus afterRender:last+focus.before":function(evt){var element=_.values(evt)[0].data.element;element.find(".ui-entity-state-comment").remove()},"bus afterRender:last+dataBind:last+entityState.selected":function(evt,ar,dataToBind,state){var entityStateId=this.entityStateId=state.id,isCommentRequired=_(dataToBind.states).detect(function(stateObj){return stateObj.id===entityStateId&&stateObj.isCommentRequired});if(!isCommentRequired){this.fire("updateState",state);return}var $element=ar.element;if($element.find(".ui-entity-state-comment").length>0){$element.find(".ui-state-comment-field").focus();return}var $dropdown=$element;$dropdown.find(".drop-down-list").listSelectable("disable");var $commentForm=$("<div class='ui-entity-state-comment'></div>").append($("<div class='ui-state-comment-header'>Please, provide comment</div>")).append($("<div class='ui-state-comment-field-container'></div>").append("<textarea rows='5' class='ui-state-comment-field'></textarea>")).append($("<div class='button-group'></div>").append($("<button type='button' class='save button'>Save</button>").click($.proxy(this._save,this))).append($("<button type='button' class='cancel button'>Cancel</button>").click($.proxy(this._cancel,this)))).appendTo($element),$inputField=$commentForm.find(".ui-state-comment-field").focus(),$saveButton=$commentForm.find(".save"),inputHandler=function(){window.setTimeout(function(){var text=$inputField.val()||"",disableSave=_.trim(text).length===0;disableSave?$saveButton.attr("disabled","disabled"):$saveButton.attr("disabled")&&$saveButton.removeAttr("disabled"),disableSave?$saveButton.addClass("disable"):$saveButton.removeClass("disable")},50)};inputHandler(),$saveButton.bind("focus",inputHandler),$inputField.bind("change keyup click propertychange paste",inputHandler)},_save:function(evt){evt.stopPropagation();var textConverter=new TextConverter,self=this,commentText=this.element.find(".ui-state-comment-field").val(),text=textConverter.convert(commentText,!0);self.fire("save",{$set:{entityState:{id:self.entityStateId},comments:[{description:text}]},$include:[{comments:["id","description"]}]})},_cancel:function(evt){evt.stopPropagation(),this.element.find(".ui-entity-state-comment").remove();var $dropdown=this.element.find(".ui-drop-down");$dropdown.find(".drop-down-list").listSelectable("enable"),$dropdown.show()}});return stateListEditable})