define(["Underscore","jQuery","tau/core/class","tau/core/event","tau/ui/extensions/board.plus/ui.board.plus.utils","tau/ui/extensions/board.plus/ui.board.plus.domWrapper.collapser","tau/ui/extensions/board.plus/ui.board.plus.dom.utils","tau/core/termProcessor"],function(e,t,r,a,i,n,o,d){var s={cardLayoutFactory:null,cardTemplateName:"board.plus.default.card.customized",init:function(e,t,r,a){this.$el=e,this.board=e,this.grid=this.board.find("#"+this.board.attr("id")+"_grid"),this.urlBuilder=a.getUrlBuilder(),this.templateFactory=a.getTemplateFactory(),this.featuresService=a.getFeaturesService(),this.configurator=a,this.termProcessor=new d,this.definition=t,this.metainfo=r},ANIMATION_CARD_UPDATED:"tau-operation_card_updated",animateWithClass:function(e,t){return o.animated(t,e)},getCellPagingMore:function(e){return e.siblings(".i-role-cell-paging-more")},executeAxisLineUpdate:function(e,t){for(var r=t.suspendAnimation?"":"tau-operation_axis_updated",a=0,i=e.length;i>a;a++){var n=e[a],o=n.$cardEx,d=n.$cardNV;o.replaceWith(d),this.animateWithClass(r,d)}},executeAxisLineRemove:function(e,r){if(e.length){var a=e.find("*");a.each(function(){var e=t(this);e.removeProp("checked"),e.prop("disabled",!0);var r=e.attr("class")||"",a=r.replace(/i-role-/gi,"i-disabled-role-");e.attr("class",a)}),this.getCellPagingMore(r).remove(),r.find(".i-role-card").remove();var i=e.add(r);i.each(function(){var e=t(this),r=e.attr("class")||"";r=r.replace(/i-role-(?!cell\b)/gi,"tau-disabled-role-"),e.attr("class",r).addClass("tau-cellaxis__removed").css("opacity",.3);var a=e.parent(".i-role-cellholder"),i=a.attr("class")||"";i=i.replace(/i-role-(?!cellholder\b)/gi,"tau-disabled-role-").replace(/tau-selected/gi,"tau-disabled-selected"),a.attr("class",i)})}},executeRemove:function(e,r){var a=this,i=t.Deferred();if(e.length){var n=r.suspendAnimation?"":"tau-operation_card_deleted";e.removeClass("i-role-card"),this.animateWithClass(n,e).done(function(){a.executeClear(e),i.resolve()})}else i.reject();
return i},executeClear:function(e){this.fire("beforeRemoveCards",e),e.remove()},executeUpdate:function(t,r){return e.map(t,e.bind(function(e){var t=e.$cardEx,a=e.$cardNV;return this.fire("beforeRemoveCards",t),t.replaceWith(a),r.suspendAnimation||t.text()===a.text()||this.animateWithClass(this.ANIMATION_CARD_UPDATED,a),a},this))},replaceCardsFastMethod:function(e,t,r){var a,i=t.first().prev();if(i.size()>0)a=function(){i.after(r)};else{var n=t.last().next();a=n.size()>0?function(){n.before(r)}:function(){e.append(r)}}t.remove(),a()},_isDescOrdering:function(){var e=this.definition.cells.ordering;if(e&&e.direction){var t=e.direction.toLowerCase()||"desc";return"desc"===t}return!0},compareOrderings:function(e,t){if(!this.metainfo.isPrioritizable)return 0;var r=parseFloat(e),a=parseFloat(t);return this._isDescOrdering()?r-a:a-r},insert$cardTo$cell:function(e,t,r){var a=e.data("orderingValue"),i=this.getCellPagingMore(t);if(i.size()>0){var n=i.data("nextOrderingValue");if(this.compareOrderings(a,n)>0)return r?(e.appendTo(i),e):null}var o=this.findPriorityPredecessor(a,t);return o.before(e),e},executeAppend:function(e,t){for(var r=t.suspendAnimation?"":"tau-operation_card_added",a=[],i=0,n=e.length;n>i;i++){var o=e[i],d=o.$card,s=this.insert$cardTo$cell(d,o.$cell,t.forceAppend);s&&a.push(s),this.animateWithClass(r,d)}return a},findPriorityPredecessor:function(r,a){var i={stub:!0,before:function(e){a.append(e)}},n=a.find(".i-role-card");return e.chain(n).map(function(e){return t(e)}).filter(e.bind(function(e){return this.compareOrderings(r,e.data("orderingValue"))<0},this)).first().value()||i},isListMode:function(){return this.isNewListMode()||"list"==this.definition.viewMode},isNewListMode:function(){return"newlist"==this.definition.viewMode},cellHasCards:function(e){var r=t(e).find(".i-role-card");return r.length>0},getCellsEmptyStatuses:function(r){var a=this,i=e.reduce(t(r),function(e,t){return e.push({$cell:t,emptyBeforeAdd:!a.cellHasCards(t)}),e},[]);return i},getCardBySliceId:function(e){return this.getCardBySliceIdInTarget(e,this.grid)
},getCardBySliceIdInTarget:function(e,t){return t.find(".i-role-card[data-id="+e+"]")},getCellHoldersBySliceCoordinatesInTarget:function(t,r){var a=e.map(t,function(e,t){return"[data-"+t+"="+e+"]"});return r.find(".i-role-cellholder"+a.join(""))},getCellHoldersAxisLineBySliceCoordinates:function(e){return this.getCellHoldersBySliceCoordinatesInTarget(e,this.board)},getCellsBySliceCoordinatesInTarget:function(t,r){var a=e.map(t,function(e,t){return"[data-"+t+"="+e+"]"});return r.find(".i-role-cell"+a.join(""))},getCellsAxisLineBySliceCoordinates:function(e){return this.getCellsBySliceCoordinatesInTarget(e,this.board)},getAxesHeaders:function(e){var t=".i-role-header";return e&&(t+="[data-dimension="+e+"]"),this.board.find(t)},getAxesCells:function(){return this.board.find(".i-role-header .i-role-cell")},updateAxisCellMetaInfo:function(e,r,a){var i=e.children(".tau-cards-count"),n=r.limit,o=r.count,d=r.title,s=r.dimension,l="";n==o&&(l="tau-axis-limit_warning_"+s),o>n&&(l="tau-axis-limit_overhead_"+s),""===n&&(l="tau-axis-limit_"+s);var c=a.closest(".i-role-cellholder");c.removeClass("tau-axis-limit_"+s+" tau-axis-limit_warning_"+s+" tau-axis-limit_overhead_"+s),c.addClass(l);var u;i.length?u=i.text():(i=t('<div class="tau-axiscell__item tau-cards-count"></div>'),e.append(i),u="");var f=""===n?"":" of "+n,h=o+f;return h!=u&&i.html("<span>"+h+"</span>"),i.attr("title",d),i},updateAxesMetaInfo:function(r,a){var i=function(t){var i=e.find(r,function(e){return e.x==t.x&&e.y==t.y}),n=e.reduce(a,function(r,a){var i=parseInt(a[t.x],10),n=parseInt(a[t.y],10);return r="",e.isNumber(i)&&!e.isNaN(i)?r=i:e.isNumber(n)&&!e.isNaN(n)&&(r=n),r},""),o={count:0,title:"",limit:n,dimension:t.x&&"x"||t.y&&"y"};return i&&(o=e.reduce(i.counts,function(e,t){e.count+=t.count;var r=e.title?" / ":"",a=t.title||this.termProcessor.getTerm(t.type,"names");return e.title+=r+a+": "+t.count,e}.bind(this),o)),o}.bind(this),n=this.getAxesCells();e.each(n,function(r){var a=t(r),n=e.pick(a.data(),"x","y"),o=i(n),d=this.getCellsAxisLineBySliceCoordinates(n),s=this.updateAxisCellMetaInfo(a,o,d);
s.toggle(o.count>0||""!==o.limit)},this)},getCardByPositionOrLast:function(e){var t=this.board.find(".i-role-card");return e<t.size()?t.eq(e):t.last()},getGrid:function(){return this.grid},getCards:function(){return this.getGrid().find(".i-role-card")},getCells:function(){return this.getGrid().find(".i-role-cell")},hasDataItemInCoordinates:function(e,t){var r=this.getCellHolderByCoordinates(t),a=this.getCardBySliceIdInTarget(e.id,r);return 0!==a.size()},applyCellPagingUpdate:function(e){for(var r=this,a=r.getAppendedCardsForCell(e.$cell),i=t(),n=a.size(),o=0;n>o;o++){var d=a.eq(o),s=d.data("id"),l=e.$cards.is(".i-role-card[data-id="+s+"]");l&&(i=i.add(d))}i.remove()},getAppendedCardsForCell:function(e){return this.getCellPagingMore(e).find(".i-role-card")},getAxisCellByCoordinate:function(e){return this.board.find("#"+i.generateId(e))},getCellByCoordinate:function(e){var t=this._prepareCoordinates(e);return this.board.find("#"+i.generateId(t))},getCellHolderByCoordinates:function(e){var t=this._prepareCoordinates(e);return this.board.find("#"+i.generateHolderId(t))},getCellHoldersForAxis:function(e,t){return this.grid.find(".i-role-cellholder[data-"+e+'="'+t+'"]')},renderCardWithLayout:function(e,t){var r=this.templateFactory.get(this.cardTemplateName);return r.bindPure({},i.getCardRenderData(e,t,this.configurator))},renderCardAsText:function(e,r){return t.when(r||this.getCardLayout(e)).then(this.renderCardWithLayout.bind(this,e))},renderCardAsHtml:function(e){return t.when(this.renderCardAsText(e)).then(t)},$createAxisMark:function(e){var t=this.templateFactory.get("boardplus.cell.axis.item"),r=i.convertCellAxisData({dynamic:{items:[e]}});return r.dynamic=!0,t.bind({},r)},applyCardsBatchAdd:function(r){var a=this;r=e.defaults(r,{options:{forceAppend:!1},items:[]});var i=r.options,n=r.items,o=e.chain(n).map(function(e){return{item:e,coordinates:{x:e.x,y:e.y}}}).filter(function(e){return!a.hasDataItemInCoordinates(e.item.data,e.coordinates)}).map(function(e){var t=e.item;
return a.renderCardAsHtml(t.data).then(function(r){return{affectedDataItem:t.data.data,cell:a.getCellByCoordinate(e.coordinates),card:r}})}).value();return t.whenList(o).then(function(){var r=e.chain(arguments),n=r.map(function(e){return e.cell}).filter(function(e){return e.length}).compact().value(),o=r.map(function(e){return e.affectedDataItem}).unique(function(e){return e.id+e.type}).value(),d=r.map(function(e){return{$card:e.card,$cell:e.cell}}).value();return t.when(a.executeAppend(d,i)).then(function(e){return{$affectedCells:n,cards:e,affectedDataItems:o}})})},applyCardsBatchRemove:function(r){for(var a=r.options,i=r.items,n={},o=[],d=i.length,s=t(),l=0;d>l;l++){var c=i[l],u=c.data.data;n[u.id+u.type]=u;var f=this.getCardBySliceId(c.data.id);s=s.add(f)}return s.each(function(e,r){var a=t(r).closest(".i-role-cell");a.length&&o.push(a)}),t.when(this.executeRemove(s,a)).then(function(){return{$affectedCells:o,affectedDataItems:e.values(n)}})},applyCardsBatchUpdate:function(r){var a="tauselectable",i=this;r=e.defaults(r,{options:{forceAppend:!1},items:[]});var n=r.options,o=r.items,d=o[0].data.id,s=this.getCardBySliceId(d),l=this.isListMode()?[o[0]]:o,c=e.filter(l,function(e){return!e.notInSlice}),u=e.any(c.slice(1),function(e){return d!==e.data.id});if(u)throw new Error("DEBUG INFO: Multiple IDs in batch update are not supported");var f=e.map(c,function(r){return t.when(i.renderCardAsHtml(r.data)).then(function(n){var o={x:r.x,y:r.y},s=i.getCellByCoordinate(o),l=i.getCellHolderByCoordinates(o),c=i.getCardBySliceIdInTarget(d,l);n.data(a,t.extend({},c.data(a)));var u=c.attr("class")&&c.attr("class").split(/\s+/),f=e.filter(u,function(e){return 0===e.indexOf("i-role-permanent-")});e.each(f,function(e){n.addClass(e)});var h=0,p=0,g=r.data.hasOwnProperty("orderingValue");g&&(h=r.data.orderingValue,p=c.data("orderingValue"));var m={cell:s,affectedDataItem:r.data.data};return c.size()>0&&0===i.compareOrderings(p,h)?(m.cardToDelete=c.eq(0),m.cardToUpdate={$cardNV:n,$cardEx:c}):m.cardToAdd={$card:n,$cell:s},m
})});return t.whenList(f).then(function(){var r=[],a=[],o=[],d=[];e.each(arguments,function(e){a.push(e.affectedDataItem),e.cell&&r.push(e.cell),e.cardToDelete&&(s=s.not(e.cardToDelete)),e.cardToUpdate&&o.push(e.cardToUpdate),e.cardToAdd&&d.push(e.cardToAdd)}),a=e.unique(a,function(e){return e.id+e.type});var l=i.executeClear(s),c=i.executeUpdate(o,n),u=i.executeAppend(d,n);return t.when(l,c,u).then(function(t,i,n){return{$affectedCells:r,cards:e.union(i,n),affectedDataItems:a}})}).then(e.bind(function(e){return this.fire("afterUpdateCards",e),e},this))},applyAxisBatchAdd:function(r){r=e.defaults(r,{options:{force:!1},items:[]});for(var a=r.items,i=[],n={},o=a.length,d=0;o>d;d++){var s=a[d],l=s.data.data;n[l.id+l.type]=l;var c=t("<div/>");c.data(s.data),i.push(c)}return{$affectedCells:i,affectedDataItems:e.values(n)}},applyAxisBatchUpdate:function(r){var a=this;r=e.defaults(r,{options:{forceAppend:!1},items:[]});for(var i,n=r.options,o=r.items,d=[],s={},l=[],c=function(e,t){if(0===t)i=e;else if(i!==e)throw new Error("DEBUG INFO: Multiply IDs in batch update are not supported")},u=a.isListMode()?0:o.length,f=[],h=0;u>h;h++){var p=o[h];c(p.data.id,h);var g=p.data.data;s[g.id+g.type]=g;var m=p.location.toLowerCase().charAt(0),v={};v[m]=p[m];var C=a.getAxisCellByCoordinate(v);f.push(C);var y=C.find(".i-role-axis-item"),x=a.$createAxisMark(p.data);d.push({$cardNV:x,$cardEx:y}),l.push(x)}return t.when(this.executeAxisLineUpdate(d,n)).then(function(){return{$affectedCells:f,cards:l,affectedDataItems:e.values(s)}})},_getAffectedCellsForItemDuringBatchRemoveAxis:function(r){var a=r.location.toLowerCase().charAt(0),i=this.getGrid(),n=this,o=function(r,a,i){var o=e.filter(n.board.find(".i-role-cell"),function(a){return e.chain(r.data.data.ids).map(function(e){return'[data-ids*="'+e+'"]'}).filter(function(e){return t(a).find(e).length}).value().length}),d=e.chain(o).map(function(e){return t(e).data(a)}).map(function(e){return i.find(".i-role-cell[data-"+a+'="'+e+'"]')}).flatten().value();
return{$axisCell:t(o),$cells:t(d)}},d=function(e,t,r){var a={};return a[t]=e.data.id,{$axisCell:this.getAxisCellByCoordinate(a),$cells:this.getCellsBySliceCoordinatesInTarget(a,r)}},s={entitystate:e.bind(o,this),priority:e.bind(o,this),"default":e.bind(d,this)},l=s[r.data.type.toLowerCase()]||s["default"];return l(r,a,i)},applyAxisBatchRemove:function(r){r=e.defaults(r,{options:{},items:[]});var a=r.items,i=this,n=e.chain(a).map(function(e){var t=e.data.data;return{itemData:t,uniqueKey:t.id+t.type,affectedCells:i._getAffectedCellsForItemDuringBatchRemoveAxis(e)}}),o=n.map(function(t){return e.flatten(t.affectedCells.$cells)}).flatten().value(),d=n.map(function(t){return e.flatten(t.affectedCells.$axisCell)}).flatten().value(),s=e.map(o,function(e){return t(e)}),l=n.map(function(e){return e.itemData}).value();return t.when(this.executeAxisLineRemove(t(d),t(o))).then(function(){return{$affectedCells:s,affectedDataItems:l}})},highlightAxesLines:function(e){for(var r=t(),a=t(),i=this,n=0,o=e.length;o>n;n++){var d=e[n],s={};s[d.location.charAt(0).toLowerCase()]=d.data.id;var l=this.getAxisCellByCoordinate(s);if(1===l.length){r=r.add(l);var c=this.getCellHoldersAxisLineBySliceCoordinates(s);a=a.add(c)}}r.length&&t.scrollTo(r.eq(0),{onAfter:function(){i.animateWithClass("tau-axis_highlighted",a)}})},applyCardsBatchMove:function(r){var a=t.Deferred(),n=this;if(!r.targetCellCoordinates)throw new Error("Target cell coordinates are not provided for move operation");r=e.defaults(r,{options:{forceAppend:!1},items:[]});var o=r.targetCellCoordinates,d=r.options,s=[],l=[];e.each(r.items,function(e){1===e.length&&e[0].x==o.x&&e[0].y==o.y?s.push(e[0]):l.push(e)});var c=e.sortBy(s,function(e){return e.data.orderingValue||0}),u=[],f=[],h=[],p="",g=t(),m={},v="tauselectable";return t.whenList(e.map(c,function(e){return n.renderCardAsText(e.data).then(function(r){var a=e.data.data.cardData.id,o=i.getLatestCardId(a);f.push(o),e.domId=o;var d=n.getCardBySliceId(e.data.id);return d.size()&&(g=g.add(d),m[o]=t.extend({},d.data(v))),r
})})).done(function(){if(e.each(arguments,function(e){p+=e}),c.length){var o=e.pick(c[0],"x","y"),s=n.getCellByCoordinate(o);s.size()&&(u=[s],n.replaceCardsFastMethod(s,g,p))}t.whenList(e.map(f,function(r){var a=i.getDomNodeByIdFast(u[0],r),o=t.Deferred();if(a)o.resolve(t(a));else{var d=e.find(c,function(e){return e.domId===r});o=n.renderCardAsHtml(d.data)}return o.done(function(e){e.data(v,m[r]),h.push(e)}),o})).done(function(){var i=e.map(l,function(){return t.Deferred()});t.whenList(i).then(function(){var t=e.toArray(arguments),r=u,i=h;e.each(t,function(e){r=r.concat(e.$affectedCells),i=i.concat(e.cards)}),d.suspendAnimation||e.each(i,e.bind(n.animateWithClass,n,n.ANIMATION_CARD_UPDATED)),a.resolve({$affectedCells:r,cards:i})}),e.each(l,function(e,t){n.applyCardsBatchUpdate({items:e,layout:r.layout}).then(i[t].resolve)})})}),a},getUnsortedCardsHolder:function(e){return e.next(".i-role-cell-paging-more")},createUnsortedCardsHolder:function(){return t(['<div class="i-role-cell-paging-more tau-cell-paging-more">','<div class="i-role-cell-paging-more-link tau-cell-paging-more-link">show more&hellip;</div>',"</div>"].join(""))},getCardLayout:function(e){return this.isNewListMode()&&console.warn("Getting card layout via DomWrapper.getListLayout is not supported anymore"),this.cardLayoutFactory.getCardLayoutByType(e.type.toLowerCase())},findCellById:function(e){return this.$el.find(".i-role-cell#"+e)},_prepareCoordinates:function(t){var r=this.isListMode(),a=r?{x:"null",y:"null"}:e.clone(t);return a.x=a.x||"null",a.y=a.y||"null",a}};return e.extend(s,n),a.extend(r.extend(s))});