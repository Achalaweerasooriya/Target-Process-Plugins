define(["Underscore","jQuery","tau/core/class","tau/core/event","tau/ui/extensions/board.plus/ui.board.plus.utils","tau/ui/extensions/board.plus/ui.board.plus.domWrapper.collapser","tau/ui/extensions/board.plus/ui.board.plus.dom.utils","tau/core/termProcessor","tau/ui/templates/board.plus/customized/ui.template.boardplus.default.card.customized","tau/ui/templates/board.plus/ui.template.boardplus.cell.axis.item"],function(e,t,r,a,n,i,o,d,s,l){var c={cardLayoutFactory:null,cardTemplate:s,init:function(e,t,r,a){this.$el=e,this.board=e,this.grid=this.board.find("#"+this.board.attr("id")+"_grid"),this.urlBuilder=a.getUrlBuilder(),this.featuresService=a.getFeaturesService(),this.configurator=a,this.termProcessor=new d,this.definition=t,this.metainfo=r},ANIMATION_CARD_UPDATED:"tau-operation_card_updated",getCellPagingMore:function(e){return e.siblings(".i-role-cell-paging-more")},executeAxisLineUpdate:function(e,t){for(var r=t.suspendAnimation?"":"tau-operation_axis_updated",a=0,n=e.length;n>a;a++){var i=e[a],d=i.$cardEx,s=i.$cardNV;d.replaceWith(s),o.animateWithClass(r,s)}},executeAxisLineRemove:function(e,r){if(e.length){var a=e.find("*");a.each(function(){var e=t(this);e.removeProp("checked"),e.prop("disabled",!0);var r=e.attr("class")||"",a=r.replace(/i-role-/gi,"i-disabled-role-");e.attr("class",a)}),this.getCellPagingMore(r).remove(),r.find(".i-role-card").remove();var n=e.add(r);n.each(function(){var e=t(this),r=e.attr("class")||"";r=r.replace(/i-role-(?!cell\b)/gi,"tau-disabled-role-"),e.attr("class",r).addClass("tau-cellaxis__removed").css("opacity",.3);var a=e.parent(".i-role-cellholder"),n=a.attr("class")||"";n=n.replace(/i-role-(?!cellholder\b)/gi,"tau-disabled-role-").replace(/tau-selected/gi,"tau-disabled-selected"),a.attr("class",n)})}},executeRemove:function(e,r){var a=this,n=t.Deferred();if(e.length){var i=r.suspendAnimation?"":"tau-operation_card_deleted";e.removeClass("i-role-card"),o.animateWithClass(i,e).done(function(){a.executeClear(e),n.resolve()})}else n.reject();
return n},executeClear:function(e){this.fire("beforeRemoveCards",e),e.remove()},executeUpdate:function(t,r){return e.map(t,e.bind(function(e){var t=e.$cardEx,a=e.$cardNV;return this.fire("beforeRemoveCards",t),t.replaceWith(a),r.suspendAnimation||t.text()===a.text()||o.animateWithClass(this.ANIMATION_CARD_UPDATED,a),a},this))},replaceCardsFastMethod:function(e,t,r){var a,n=t.filter(function(){return/^clipboardcard_.*/.test(this.id)}),i=n.length?n:t,o=i.first().prev(),d=i.last().next();a=o.length?function(){o.after(r)}:d.length?function(){d.before(r)}:function(){e.append(r)},this._replaceCards(t,a)},_replaceCards:function(e,t){e.remove(),t()},_isDescOrdering:function(){var e=this.definition.cells.ordering;if(e&&e.direction){var t=e.direction.toLowerCase()||"desc";return"desc"===t}return!0},compareOrderings:function(e,t){if(!this.metainfo.isPrioritizable)return 0;var r=parseFloat(e),a=parseFloat(t);return this._isDescOrdering()?r-a:a-r},insert$cardTo$cell:function(e,t,r){var a=e.data("orderingValue"),n=this.getCellPagingMore(t);if(n.size()>0){var i=n.data("nextOrderingValue");if(this.compareOrderings(a,i)>0)return r?(e.appendTo(n),e):null}var o=this.findPriorityPredecessor(a,t);return o.before(e),e},executeAppend:function(e,t){for(var r=t.suspendAnimation?"":"tau-operation_card_added",a=[],n=0,i=e.length;i>n;n++){var d=e[n],s=d.$card,l=this.insert$cardTo$cell(s,d.$cell,t.forceAppend);l&&a.push(l),o.animateWithClass(r,s)}return a},findPriorityPredecessor:function(r,a){var n={stub:!0,before:function(e){a.append(e)}},i=a.find(".i-role-card");return e.chain(i).map(function(e){return t(e)}).filter(e.bind(function(e){return this.compareOrderings(r,e.data("orderingValue"))<0},this)).first().value()||n},isListMode:function(){return this.isNewListMode()||"list"==this.definition.viewMode},isNewListMode:function(){return"newlist"==this.definition.viewMode},cellHasCards:function(e){var r=t(e).find(".i-role-card");return r.length>0},getCellsEmptyStatuses:function(r){var a=this,n=e.reduce(t(r),function(e,t){return e.push({$cell:t,emptyBeforeAdd:!a.cellHasCards(t)}),e
},[]);return n},getCardBySliceId:function(e){return this.getCardBySliceIdInTarget(e,this.grid)},getCardBySliceIdInTarget:function(e,t){return t.find(".i-role-card[data-id="+e+"]")},getCellHoldersBySliceCoordinatesInTarget:function(t,r){var a=e.map(t,function(e,t){return"[data-"+t+"="+e+"]"});return r.find(".i-role-cellholder"+a.join(""))},getCellHoldersAxisLineBySliceCoordinates:function(e){return this.getCellHoldersBySliceCoordinatesInTarget(e,this.board)},getCellsBySliceCoordinatesInTarget:function(t,r){var a=e.map(t,function(e,t){return"[data-"+t+"="+e+"]"});return r.find(".i-role-cell"+a.join(""))},getCellsAxisLineBySliceCoordinates:function(e){return this.getCellsBySliceCoordinatesInTarget(e,this.board)},getAxesHeaders:function(e){var t=".i-role-header";return e&&(t+="[data-dimension="+e+"]"),this.board.find(t)},getAxesCells:function(){return this.board.find(".i-role-header .i-role-cell")},updateAxisCellMetaInfo:function(e,r,a){var n=e.children(".tau-cards-count"),i=r.limit,o=r.count,d=r.title,s=r.dimension,l="";i==o&&(l="tau-axis-limit_warning_"+s),o>i&&(l="tau-axis-limit_overhead_"+s),""===i&&(l="tau-axis-limit_"+s);var c=a.closest(".i-role-cellholder");c.removeClass("tau-axis-limit_"+s+" tau-axis-limit_warning_"+s+" tau-axis-limit_overhead_"+s),c.addClass(l);var u;n.length?u=n.text():(n=t('<div class="tau-axiscell__item tau-cards-count"></div>'),e.append(n),u="");var f=""===i?"":" of "+i,h=o+f;return h!=u&&n.html("<span>"+h+"</span>"),n.attr("title",d),n},updateAxesMetaInfo:function(r,a){var n=function(t){var n=e.find(r,function(e){return e.x==t.x&&e.y==t.y}),i=e.reduce(a,function(r,a){var n=parseInt(a[t.x],10),i=parseInt(a[t.y],10);return r="",e.isNumber(n)&&!e.isNaN(n)?r=n:e.isNumber(i)&&!e.isNaN(i)&&(r=i),r},""),o={count:0,title:"",limit:i,dimension:t.x&&"x"||t.y&&"y"};return n&&(o=e.reduce(n.counts,function(e,t){e.count+=t.count;var r=e.title?" / ":"",a=t.title||this.termProcessor.getTerm(t.type,"names");return e.title+=r+a+": "+t.count,e}.bind(this),o)),o
}.bind(this),i=this.getAxesCells();e.each(i,function(r){var a=t(r),i=e.pick(a.data(),"x","y"),o=n(i),d=this.getCellsAxisLineBySliceCoordinates(i),s=this.updateAxisCellMetaInfo(a,o,d);s.toggle(o.count>0||""!==o.limit)},this)},getCardByPositionOrLast:function(e){var t=this.board.find(".i-role-card");return e<t.size()?t.eq(e):t.last()},getGrid:function(){return this.grid},getCards:function(){return this.getGrid().find(".i-role-card")},getCells:function(){return this.getGrid().find(".i-role-cell")},hasDataItemInCoordinates:function(e,t){var r=this.getCellHolderByCoordinates(t),a=this.getCardBySliceIdInTarget(e.id,r);return 0!==a.size()},applyCellPagingUpdate:function(e){for(var r=this,a=r.getAppendedCardsForCell(e.$cell),n=t(),i=a.size(),o=0;i>o;o++){var d=a.eq(o),s=d.data("id"),l=e.$cards.is(".i-role-card[data-id="+s+"]");l&&(n=n.add(d))}n.remove()},getAppendedCardsForCell:function(e){return this.getCellPagingMore(e).find(".i-role-card")},getAxisCellByCoordinate:function(e){return this.board.find("#"+n.generateId(e))},getCellByCoordinate:function(e){var t=this._prepareCoordinates(e);return this.board.find("#"+n.generateId(t))},getCellHolderByCoordinates:function(e){var t=this._prepareCoordinates(e);return this.board.find("#"+n.generateHolderId(t))},getCellHoldersForAxis:function(e,t){return this.grid.find(".i-role-cellholder[data-"+e+'="'+t+'"]')},renderCardWithLayout:function(e,t){var r=this.cardTemplate.get();return r.bindPure({},n.getCardRenderData(e,t,this.configurator))},renderCardAsText:function(e,r){return t.when(r||this.getCardLayout(e)).then(this.renderCardWithLayout.bind(this,e))},renderCardAsHtml:function(e){return t.when(this.renderCardAsText(e)).then(t)},$createAxisMark:function(e){var t=n.convertCellAxisData({dynamic:{items:[e]}});return t.dynamic=!0,l.render(t)},applyCardsBatchAdd:function(r){var a=this;r=e.defaults(r,{options:{forceAppend:!1},items:[]});var n=r.options,i=r.items,o=e.chain(i).map(function(e){return{item:e,coordinates:{x:e.x,y:e.y}}}).filter(function(e){return!a.hasDataItemInCoordinates(e.item.data,e.coordinates)
}).map(function(e){var t=e.item;return a.renderCardAsHtml(t.data).then(function(r){return{affectedDataItem:t.data.data,cell:a.getCellByCoordinate(e.coordinates),card:r}})}).value();return t.whenList(o).then(function(){var r=e.chain(arguments),i=r.map(function(e){return e.cell}).filter(function(e){return e.length}).compact().value(),o=r.map(function(e){return e.affectedDataItem}).unique(function(e){return e.id+e.type}).value(),d=r.map(function(e){return{$card:e.card,$cell:e.cell}}).value();return t.when(a.executeAppend(d,n)).then(function(e){return{$affectedCells:i,cards:e,affectedDataItems:o}})})},applyCardsBatchRemove:function(r){for(var a=r.options,n=r.items,i={},o=[],d=n.length,s=t(),l=0;d>l;l++){var c=n[l],u=c.data.data;i[u.id+u.type]=u;var f=this.getCardBySliceId(c.data.id);s=s.add(f)}return s.each(function(e,r){var a=t(r).closest(".i-role-cell");a.length&&o.push(a)}),t.when(this.executeRemove(s,a)).then(function(){return{$affectedCells:o,affectedDataItems:e.values(i)}})},applyCardsBatchUpdate:function(r){var a="tauselectable",n=this;r=e.defaults(r,{options:{forceAppend:!1},items:[]});var i=r.options,o=r.items,d=o[0].data.id,s=this.getCardBySliceId(d),l=this.isListMode()?[o[0]]:o,c=e.filter(l,function(e){return!e.notInSlice}),u=e.any(c.slice(1),function(e){return d!==e.data.id});if(u)throw new Error("DEBUG INFO: Multiple IDs in batch update are not supported");var f=e.map(c,function(r){return t.when(n.renderCardAsHtml(r.data)).then(function(i){var o={x:r.x,y:r.y},s=n.getCellByCoordinate(o),l=n.getCellHolderByCoordinates(o),c=n.getCardBySliceIdInTarget(d,l);i.data(a,t.extend({},c.data(a)));var u=c.attr("class")&&c.attr("class").split(/\s+/),f=e.filter(u,function(e){return 0===e.indexOf("i-role-permanent-")});e.each(f,function(e){i.addClass(e)});var h=0,p=0,g=r.data.hasOwnProperty("orderingValue");g&&(h=r.data.orderingValue,p=c.data("orderingValue"));var C={cell:s,affectedDataItem:r.data.data};return c.size()>0&&0===n.compareOrderings(p,h)?(C.cardToDelete=c.eq(0),C.cardToUpdate={$cardNV:i,$cardEx:c}):C.cardToAdd={$card:i,$cell:s},C
})});return t.whenList(f).then(function(){var r=[],a=[],o=[],d=[];e.each(arguments,function(e){a.push(e.affectedDataItem),e.cell&&r.push(e.cell),e.cardToDelete&&(s=s.not(e.cardToDelete)),e.cardToUpdate&&o.push(e.cardToUpdate),e.cardToAdd&&d.push(e.cardToAdd)}),a=e.unique(a,function(e){return e.id+e.type});var l=n.executeClear(s),c=n.executeUpdate(o,i),u=n.executeAppend(d,i);return t.when(l,c,u).then(function(t,n,i){return{$affectedCells:r,cards:e.union(n,i),affectedDataItems:a}})}).then(e.bind(function(e){return this.fire("afterUpdateCards",e),e},this))},applyAxisBatchAdd:function(r){r=e.defaults(r,{options:{force:!1},items:[]});for(var a=r.items,n=[],i={},o=a.length,d=0;o>d;d++){var s=a[d],l=s.data.data;i[l.id+l.type]=l;var c=t("<div/>");c.data(s.data),n.push(c)}return{$affectedCells:n,affectedDataItems:e.values(i)}},applyAxisBatchUpdate:function(r){var a=this;r=e.defaults(r,{options:{forceAppend:!1},items:[]});for(var n,i=r.options,o=r.items,d=[],s={},l=[],c=function(e,t){if(0===t)n=e;else if(n!==e)throw new Error("DEBUG INFO: Multiply IDs in batch update are not supported")},u=a.isListMode()?0:o.length,f=[],h=0;u>h;h++){var p=o[h];c(p.data.id,h);var g=p.data.data;s[g.id+g.type]=g;var C=p.location.toLowerCase().charAt(0),m={};m[C]=p[C];var v=a.getAxisCellByCoordinate(m);f.push(v);var y=v.find(".i-role-axis-item"),x=a.$createAxisMark(p.data);d.push({$cardNV:x,$cardEx:y}),l.push(x)}return t.when(this.executeAxisLineUpdate(d,i)).then(function(){return{$affectedCells:f,cards:l,affectedDataItems:e.values(s)}})},_getAffectedCellsForStateOrPriority:function(r,a){var n=this.getGrid(),i=e.map(r.data.data.ids,function(e){return'[data-ids*="'+e+'"]'}),o=e.filter(this.board.find(".i-role-cell"),function(r){return e.any(i,function(e){return t(r).find(e).length})}),d=e.chain(o).map(function(e){return t(e).data(a)}).map(function(e){return n.find(".i-role-cell[data-"+a+'="'+e+'"]')}).flatten().value();return{$axisCell:t(o),$cells:t(d)}},_getAffectedCellsDefault:function(e,t){var r=this.getGrid(),a={};
return a[t]=e.data.id,{$axisCell:this.getAxisCellByCoordinate(a),$cells:this.getCellsBySliceCoordinatesInTarget(a,r)}},_getAffectedCellsForItemDuringBatchRemoveAxis:function(e){var t=e.data.type.toLowerCase(),r=e.location.toLowerCase().charAt(0);switch(t){case"entitystate":case"priority":return this._getAffectedCellsForStateOrPriority(e,r);default:return this._getAffectedCellsDefault(e,r)}},applyAxisBatchRemove:function(r){r=e.defaults(r,{options:{},items:[]});var a=r.items,n=this,i=e.chain(a).map(function(e){var t=e.data.data;return{itemData:t,uniqueKey:t.id+t.type,affectedCells:n._getAffectedCellsForItemDuringBatchRemoveAxis(e)}}),o=i.map(function(t){return e.flatten(t.affectedCells.$cells)}).flatten().value(),d=i.map(function(t){return e.flatten(t.affectedCells.$axisCell)}).flatten().value(),s=e.map(o,function(e){return t(e)}),l=i.map(function(e){return e.itemData}).value();return t.when(this.executeAxisLineRemove(t(d),t(o))).then(function(){return{$affectedCells:s,affectedDataItems:l}})},highlightAxesLines:function(e){for(var r=t(),a=t(),n=0,i=e.length;i>n;n++){var d=e[n],s={};s[d.location.charAt(0).toLowerCase()]=d.data.id;var l=this.getAxisCellByCoordinate(s);if(1===l.length){r=r.add(l);var c=this.getCellHoldersAxisLineBySliceCoordinates(s);a=a.add(c)}}r.length&&t.scrollTo(r.eq(0),{onAfter:function(){o.animateWithClass("tau-axis_highlighted",a)}})},applyCardsBatchMove:function(r){var a=t.Deferred(),i=this;if(!r.targetCellCoordinates)throw new Error("Target cell coordinates are not provided for move operation");r=e.defaults(r,{options:{forceAppend:!1},items:[]});var d=r.targetCellCoordinates,s=r.options,l=[],c=[];e.each(r.items,function(e){1===e.length&&e[0].x==d.x&&e[0].y==d.y?l.push(e[0]):c.push(e)});var u=e.sortBy(l,function(e){return e.data.orderingValue||0}),f=[],h=[],p=[],g="",C=t(),m={},v="tauselectable";return t.when.all(e.map(u,function(e){return i.renderCardAsText(e.data).then(function(r){var a=e.data.data.cardData.id,o=n.getLatestCardId(a);h.push(o),e.domId=o;
var d=i.getCardBySliceId(e.data.id);return d.length&&(C=C.add(d),m[o]=t.extend({},d.data(v))),r})})).then(function(r){if(g=r.join(""),u.length){var a=e.pick(u[0],"x","y"),o=i.getCellByCoordinate(a);o.length&&(f=[o],i.replaceCardsFastMethod(o,C,g))}return t.whenList(e.map(h,function(r){var a=n.getDomNodeByIdFast(f[0],r),o=t.Deferred();if(a)o.resolve(t(a));else{var d=e.find(u,function(e){return e.domId===r});o=i.renderCardAsHtml(d.data)}return o.done(function(e){e.data(v,m[r]),p.push(e)}),o}))}).then(function(){var a=e.map(c,function(e){return i.applyCardsBatchUpdate({items:e,layout:r.layout})});return t.when.all(a)}).then(function(t){var r=f,n=p;e.each(t,function(e){r=r.concat(e.$affectedCells),n=n.concat(e.cards)}),s.suspendAnimation||e.each(n,e.bind(o.animateWithClass,o,i.ANIMATION_CARD_UPDATED)),a.resolve({$affectedCells:r,cards:n})}),a},getUnsortedCardsHolder:function(e){return e.next(".i-role-cell-paging-more")},createUnsortedCardsHolder:function(){return t(['<div class="i-role-cell-paging-more tau-cell-paging-more">','<div class="i-role-cell-paging-more-link tau-cell-paging-more-link">show more&hellip;</div>',"</div>"].join(""))},getCardLayout:function(e){return this.isNewListMode()&&console.warn("Getting card layout via DomWrapper.getListLayout is not supported anymore"),this.cardLayoutFactory.getCardLayoutByType(e.type.toLowerCase())},findCellById:function(e){return this.$el.find(".i-role-cell#"+e)},_prepareCoordinates:function(t){var r=this.isListMode(),a=r?{x:"null",y:"null"}:e.clone(t);return a.x=a.x||"null",a.y=a.y||"null",a}};return e.extend(c,i),a.extend(r.extend(c))});