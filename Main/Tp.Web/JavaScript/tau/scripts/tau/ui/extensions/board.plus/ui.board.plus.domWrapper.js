define(["Underscore","jQuery","tau/core/class","tau/core/event","tau/ui/extensions/board.plus/ui.board.plus.utils","tau/ui/extensions/board.plus/ui.board.plus.domWrapper.collapser","tau/ui/extensions/board.plus/ui.board.plus.dom.utils","tau/core/termProcessor"],function(e,t,a,r,n,i,o,d){var s={cardLayoutFactory:null,cardTemplateName:"board.plus.default.card.customized",init:function(e,t,a,r){this.$el=e,this.board=e,this.urlBuilder=r.getUrlBuilder(),this.templateFactory=r.getTemplateFactory(),this.featuresService=r.getFeaturesService(),this.configurator=r,this.termProcessor=new d,this.definition=t,this.metainfo=a},ANIMATION_CARD_UPDATED:"tau-operation_card_updated",animateWithClass:function(e,t){return o.animated(t,e)},getCellPagingMore:function(e){return e.siblings(".i-role-cell-paging-more")},executeAxisLineUpdate:function(e,t){for(var a=t.suspendAnimation?"":"tau-operation_axis_updated",r=0,n=e.length;n>r;r++){var i=e[r],o=i.$cardEx,d=i.$cardNV;o.replaceWith(d),this.animateWithClass(a,d)}},executeAxisLineRemove:function(e,a){if(e.length){var r=e.find("*");r.each(function(){var e=t(this);e.removeProp("checked"),e.prop("disabled",!0);var a=e.attr("class")||"",r=a.replace(/i-role-/gi,"i-disabled-role-");e.attr("class",r)}),this.getCellPagingMore(a).remove(),a.find(".i-role-card").remove();var n=e.add(a);n.each(function(){var e=t(this),a=e.attr("class")||"";a=a.replace(/i-role-(?!cell\b)/gi,"tau-disabled-role-"),e.attr("class",a).addClass("tau-cellaxis__removed").css("opacity",.3);var r=e.parent(".i-role-cellholder"),n=r.attr("class")||"";n=n.replace(/i-role-(?!cellholder\b)/gi,"tau-disabled-role-").replace(/tau-selected/gi,"tau-disabled-selected"),r.attr("class",n)})}},executeRemove:function(e,a){var r=this,n=t.Deferred();if(e.length){var i=a.suspendAnimation?"":"tau-operation_card_deleted";e.removeClass("i-role-card"),this.animateWithClass(i,e).done(function(){r.executeClear(e),n.resolve()})}else n.reject();return n},executeClear:function(e){this.fire("beforeRemoveCards",e),e.remove()},executeUpdate:function(t,a){return e.map(t,e.bind(function(e){var t=e.$cardEx,r=e.$cardNV;return this.fire("beforeRemoveCards",t),t.replaceWith(r),a.suspendAnimation||t.text()===r.text()||this.animateWithClass(this.ANIMATION_CARD_UPDATED,r),r},this))},replaceCardsFastMethod:function(e,t,a){var r,n=t.first().prev();if(n.size()>0)r=function(){n.after(a)};else{var i=t.last().next();r=i.size()>0?function(){i.before(a)}:function(){e.append(a)}}t.remove(),r()},compareOrderings:function(e,t){if(!this.metainfo.isPrioritizable)return 0;var a=parseFloat(e),r=parseFloat(t),n=this.definition.cells.ordering,i=n&&n.direction&&n.direction.toLowerCase()||"desc";return"desc"===i?a-r:r-a},insert$cardTo$cell:function(e,t,a){var r=e.data("orderingValue"),n=this.getCellPagingMore(t);if(n.size()>0){var i=n.data("nextOrderingValue");if(this.compareOrderings(r,i)>0)return a?(e.appendTo(n),e):null}var o=this.findPriorityPredecessor(r,t);return o.before(e),e},executeAppend:function(e,t){for(var a=t.suspendAnimation?"":"tau-operation_card_added",r=[],n=0,i=e.length;i>n;n++){var o=e[n],d=o.$card,s=this.insert$cardTo$cell(d,o.$cell,t.forceAppend);s&&r.push(s),this.animateWithClass(a,d)}return r},findPriorityPredecessor:function(a,r){var n={stub:!0,before:function(e){r.append(e)}},i=r.find(".i-role-card");return e.chain(i).map(function(e){return t(e)}).filter(e.bind(function(e){return this.compareOrderings(a,e.data("orderingValue"))<0},this)).first().value()||n},isListMode:function(){return this.isNewListMode()||"list"==this.definition.viewMode},isNewListMode:function(){return"newlist"==this.definition.viewMode},cellHasCards:function(e){var a=t(e).find(".i-role-card");return a.length>0},getCellsEmptyStatuses:function(a){var r=this,n=e.reduce(t(a),function(e,t){return e.push({$cell:t,emptyBeforeAdd:!r.cellHasCards(t)}),e},[]);return n},getCardBySliceId:function(e){return this.getCardBySliceIdInTarget(e,this.board)},getCardBySliceIdInTarget:function(e,t){return t.find(".i-role-card[data-id="+e+"]")},getCellHoldersBySliceCoordinatesInTarget:function(t,a){var r=e.map(t,function(e,t){return"[data-"+t+"="+e+"]"});return a.find(".i-role-cellholder"+r.join(""))},getCellHoldersAxisLineBySliceCoordinates:function(e){return this.getCellHoldersBySliceCoordinatesInTarget(e,this.board)},getCellsBySliceCoordinatesInTarget:function(t,a){var r=e.map(t,function(e,t){return"[data-"+t+"="+e+"]"});return a.find(".i-role-cell"+r.join(""))},getCellsAxisLineBySliceCoordinates:function(e){return this.getCellsBySliceCoordinatesInTarget(e,this.board)},getAxesHeaders:function(e){var t=".i-role-header";return e&&(t+="[data-dimension="+e+"]"),this.board.find(t)},getAxesCells:function(){return this.board.find(".i-role-header .i-role-cell")},updateAxisCellMetaInfo:function(e,a,r){var n=e.children(".tau-cards-count"),i=a.limit,o=a.count,d=a.title,s=a.dimension,l="";i==o&&(l="tau-axis-limit_warning_"+s),o>i&&(l="tau-axis-limit_overhead_"+s),""===i&&(l="tau-axis-limit_"+s);var c=r.closest(".i-role-cellholder");c.removeClass("tau-axis-limit_"+s+" tau-axis-limit_warning_"+s+" tau-axis-limit_overhead_"+s),c.addClass(l);var u;n.length?u=n.text():(n=t('<div class="tau-axiscell__item tau-cards-count"></div>'),e.append(n),u="");var f=""===i?"":" of "+i,h=o+f;return h!=u&&n.html("<span>"+h+"</span>"),n.attr("title",d),n},updateAxesMetaInfo:function(a,r){var n=function(t){var n=e.find(a,function(e){return e.x==t.x&&e.y==t.y}),i=e.reduce(r,function(a,r){var n=parseInt(r[t.x],10),i=parseInt(r[t.y],10);return a="",e.isNumber(n)&&!e.isNaN(n)?a=n:e.isNumber(i)&&!e.isNaN(i)&&(a=i),a},""),o={count:0,title:"",limit:i,dimension:t.x&&"x"||t.y&&"y"};return n&&(o=e.reduce(n.counts,function(e,t){e.count+=t.count;var a=e.title?" / ":"";return e.title+=a+this.termProcessor.getTerm(t.type,"names")+": "+t.count,e}.bind(this),o)),o}.bind(this),i=this.getAxesCells();e.each(i,function(a){var r=t(a),i=e.pick(r.data(),"x","y"),o=n(i),d=this.getCellsAxisLineBySliceCoordinates(i),s=this.updateAxisCellMetaInfo(r,o,d);s.toggle(o.count>0||""!==o.limit)},this)},getCardByPositionOrLast:function(e){var t=this.board.find(".i-role-card");return e<t.size()?t.eq(e):t.last()},getGrid:function(){return this.board.find(".i-role-grid")},getCards:function(){return this.getGrid().find(".i-role-card")},hasDataItemInCoordinates:function(e,t){var a=this.getCellHolderByCoordinates(t),r=this.getCardBySliceIdInTarget(e.id,a);return 0!==r.size()},applyCellPagingUpdate:function(e){for(var a=this,r=a.getAppendedCardsForCell(e.$cell),n=t(),i=r.size(),o=0;i>o;o++){var d=r.eq(o),s=d.data("id"),l=e.$cards.is(".i-role-card[data-id="+s+"]");l&&(n=n.add(d))}n.remove()},getAppendedCardsForCell:function(e){return this.getCellPagingMore(e).find(".i-role-card")},getAxisCellByCoordinate:function(e){return this.board.find("#"+n.generateId(e))},getCellByCoordinate:function(t){var a=this.isListMode(),r=a?{x:"null",y:"null"}:e.clone(t);return r.x=r.x||"null",r.y=r.y||"null",this.board.find("#"+n.generateId(r))},getCellHolderByCoordinates:function(e){return this.getCellByCoordinate(e).parent()},renderCardWithLayout:function(e,t){var a=this.templateFactory.get(this.cardTemplateName);return a.bindPure({},n.getCardRenderData(e,t,this.configurator))},renderCardAsText:function(e,a){return t.when(a||this.getCardLayout(e)).then(this.renderCardWithLayout.bind(this,e))},renderCardAsHtml:function(e){return t.when(this.renderCardAsText(e)).then(t)},$createAxisMark:function(e){var t=this.templateFactory.get("boardplus.cell.axis.item"),a=n.convertCellAxisData({dynamic:{items:[e]}});return a.dynamic=!0,t.bind({},a)},applyCardsBatchAdd:function(a){var r=this;a=e.defaults(a,{options:{forceAppend:!1},items:[]});var n=a.options,i=a.items,o=e.chain(i).map(function(e){return{item:e,coordinates:{x:e.x,y:e.y}}}).filter(function(e){return!r.hasDataItemInCoordinates(e.item.data,e.coordinates)}).map(function(e){var t=e.item;return r.renderCardAsHtml(t.data).then(function(a){return{affectedDataItem:t.data.data,cell:r.getCellByCoordinate(e.coordinates),card:a}})}).value();return t.whenList(o).then(function(){var a=e.chain(arguments),i=a.map(function(e){return e.cell}).filter(function(e){return e.length}).compact().value(),o=a.map(function(e){return e.affectedDataItem}).unique(function(e){return e.id+e.type}).value(),d=a.map(function(e){return{$card:e.card,$cell:e.cell}}).value();return t.when(r.executeAppend(d,n)).then(function(e){return{$affectedCells:i,cards:e,affectedDataItems:o}})})},applyCardsBatchRemove:function(a){for(var r=a.options,n=a.items,i={},o=[],d=n.length,s=t(),l=0;d>l;l++){var c=n[l],u=c.data.data;i[u.id+u.type]=u;var f=this.getCardBySliceId(c.data.id);s=s.add(f)}return s.each(function(e,a){var r=t(a).closest(".i-role-cell");r.length&&o.push(r)}),t.when(this.executeRemove(s,r)).then(function(){return{$affectedCells:o,affectedDataItems:e.values(i)}})},applyCardsBatchUpdate:function(a){var r="tauselectable",n=this;a=e.defaults(a,{options:{forceAppend:!1},items:[]});var i=a.options,o=a.items,d=o[0].data.id,s=this.getCardBySliceId(d),l=this.isListMode()?[o[0]]:o,c=e.filter(l,function(e){return!e.notInSlice}),u=e.any(c.slice(1),function(e){return d!==e.data.id});if(u)throw new Error("DEBUG INFO: Multiple IDs in batch update are not supported");var f=e.map(c,function(a){return t.when(n.renderCardAsHtml(a.data)).then(function(i){var o={x:a.x,y:a.y},s=n.getCellByCoordinate(o),l=n.getCellHolderByCoordinates(o),c=n.getCardBySliceIdInTarget(d,l);i.data(r,t.extend({},c.data(r)));var u=c.attr("class")&&c.attr("class").split(/\s+/),f=e.filter(u,function(e){return 0===e.indexOf("i-role-permanent-")});e.each(f,function(e){i.addClass(e)});var h=0,p=0,m=a.data.hasOwnProperty("orderingValue");m&&(h=a.data.orderingValue,p=c.data("orderingValue"));var g={cell:s,affectedDataItem:a.data.data};return c.size()>0&&0===n.compareOrderings(p,h)?(g.cardToDelete=c.eq(0),g.cardToUpdate={$cardNV:i,$cardEx:c}):g.cardToAdd={$card:i,$cell:s},g})});return t.whenList(f).then(function(){var a=[],r=[],o=[],d=[];e.each(arguments,function(e){r.push(e.affectedDataItem),e.cell&&a.push(e.cell),e.cardToDelete&&(s=s.not(e.cardToDelete)),e.cardToUpdate&&o.push(e.cardToUpdate),e.cardToAdd&&d.push(e.cardToAdd)}),r=e.unique(r,function(e){return e.id+e.type});var l=n.executeClear(s),c=n.executeUpdate(o,i),u=n.executeAppend(d,i);return t.when(l,c,u).then(function(t,n,i){return{$affectedCells:a,cards:e.union(n,i),affectedDataItems:r}})}).then(e.bind(function(e){return this.fire("afterUpdateCards",e),e},this))},applyAxisBatchAdd:function(a){a=e.defaults(a,{options:{force:!1},items:[]});for(var r=a.items,n=[],i={},o=r.length,d=0;o>d;d++){var s=r[d],l=s.data.data;i[l.id+l.type]=l;var c=t("<div/>");c.data(s.data),n.push(c)}return{$affectedCells:n,affectedDataItems:e.values(i)}},applyAxisBatchUpdate:function(a){var r=this;a=e.defaults(a,{options:{forceAppend:!1},items:[]});for(var n,i=a.options,o=a.items,d=[],s={},l=[],c=function(e,t){if(0===t)n=e;else if(n!==e)throw new Error("DEBUG INFO: Multiply IDs in batch update are not supported")},u=r.isListMode()?0:o.length,f=[],h=0;u>h;h++){var p=o[h];c(p.data.id,h);var m=p.data.data;s[m.id+m.type]=m;var g=p.location.toLowerCase().charAt(0),v={};v[g]=p[g];var C=r.getAxisCellByCoordinate(v);f.push(C);var y=C.find(".i-role-axis-item"),x=r.$createAxisMark(p.data);d.push({$cardNV:x,$cardEx:y}),l.push(x)}return t.when(this.executeAxisLineUpdate(d,i)).then(function(){return{$affectedCells:f,cards:l,affectedDataItems:e.values(s)}})},_getAffectedCellsForItemDuringBatchRemoveAxis:function(a){var r=a.location.toLowerCase().charAt(0),n=this.getGrid(),i=this,o=function(a,r,n){var o=e.filter(i.board.find(".i-role-cell"),function(r){return e.chain(a.data.data.ids).map(function(e){return'[data-ids*="'+e+'"]'}).filter(function(e){return t(r).find(e).length}).value().length}),d=e.chain(o).map(function(e){return t(e).data(r)}).map(function(e){return n.find('[role="i-role-cell",data-'+r+'="'+e+'"]')}).flatten().value();return{$axisCell:t(o),$cells:t(d)}},d=function(e,t,a){var r={};return r[t]=e.data.id,{$axisCell:this.getAxisCellByCoordinate(r),$cells:this.getCellsBySliceCoordinatesInTarget(r,a)}},s={entitystate:e.bind(o,this),priority:e.bind(o,this),"default":e.bind(d,this)},l=s[a.data.type.toLowerCase()]||s["default"];return l(a,r,n)},applyAxisBatchRemove:function(a){a=e.defaults(a,{options:{},items:[]});var r=a.items,n=this,i=e.chain(r).map(function(e){var t=e.data.data;return{itemData:t,uniqueKey:t.id+t.type,affectedCells:n._getAffectedCellsForItemDuringBatchRemoveAxis(e)}}),o=i.map(function(t){return e.flatten(t.affectedCells.$cells)}).flatten().value(),d=i.map(function(t){return e.flatten(t.affectedCells.$axisCell)}).flatten().value(),s=e.map(o,function(e){return t(e)}),l=i.map(function(e){return e.itemData}).value();return t.when(this.executeAxisLineRemove(t(d),t(o))).then(function(){return{$affectedCells:s,affectedDataItems:l}})},highlightAxesLines:function(e){for(var a=t(),r=t(),n=this,i=0,o=e.length;o>i;i++){var d=e[i],s={};s[d.location.charAt(0).toLowerCase()]=d.data.id;var l=this.getAxisCellByCoordinate(s);if(1===l.length){a=a.add(l);var c=this.getCellHoldersAxisLineBySliceCoordinates(s);r=r.add(c)}}a.length&&t.scrollTo(a.eq(0),{onAfter:function(){n.animateWithClass("tau-axis_highlighted",r)}})},applyCardsBatchMove:function(a){var r=t.Deferred(),i=this;if(!a.targetCellCoordinates)throw new Error("Target cell coordinates are not provided for move operation");a=e.defaults(a,{options:{forceAppend:!1},items:[]});var o=a.targetCellCoordinates,d=a.options,s=[],l=[];e.each(a.items,function(e){1===e.length&&e[0].x==o.x&&e[0].y==o.y?s.push(e[0]):l.push(e)});var c=e.sortBy(s,function(e){return e.data.orderingValue||0}),u=[],f=[],h=[],p="",m=t(),g={},v="tauselectable";return t.whenList(e.map(c,function(e){return i.renderCardAsText(e.data).then(function(a){var r=e.data.data.cardData.id,o=n.getLatestCardId(r);f.push(o),e.domId=o;var d=i.getCardBySliceId(e.data.id);return d.size()&&(m=m.add(d),g[o]=t.extend({},d.data(v))),a})})).done(function(){if(e.each(arguments,function(e){p+=e}),c.length){var o=e.pick(c[0],"x","y"),s=i.getCellByCoordinate(o);s.size()&&(u=[s],i.replaceCardsFastMethod(s,m,p))}t.whenList(e.map(f,function(a){var r=n.getDomNodeByIdFast(u[0],a),o=t.Deferred();if(r)o.resolve(t(r));else{var d=e.find(c,function(e){return e.domId===a});o=i.renderCardAsHtml(d.data)}return o.done(function(e){e.data(v,g[a]),h.push(e)}),o})).done(function(){var n=e.map(l,function(){return t.Deferred()});t.whenList(n).then(function(){var t=e.toArray(arguments),a=u,n=h;e.each(t,function(e){a=a.concat(e.$affectedCells),n=n.concat(e.cards)}),d.suspendAnimation||e.each(n,e.bind(i.animateWithClass,i,i.ANIMATION_CARD_UPDATED)),r.resolve({$affectedCells:a,cards:n})}),e.each(l,function(e,t){i.applyCardsBatchUpdate({items:e,layout:a.layout}).then(n[t].resolve)})})}),r},getUnsortedCardsHolder:function(e){return e.next(".i-role-cell-paging-more")},createUnsortedCardsHolder:function(){return t(['<div class="i-role-cell-paging-more tau-cell-paging-more">','<div class="i-role-cell-paging-more-link tau-cell-paging-more-link">show more&hellip;</div>',"</div>"].join(""))},getCardLayout:function(e){return this.isNewListMode()&&console.warn("Getting card layout via DomWrapper.getListLayout is not supported anymore"),this.cardLayoutFactory.getCardLayoutByType(e.type.toLowerCase())},findCellById:function(e){return this.$el.find(".i-role-cell#"+e)}};return e.extend(s,i),r.extend(a.extend(s))});