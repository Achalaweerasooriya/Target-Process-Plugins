define(["jQuery","Underscore","tau/components/component.finder.entity","tau/utils/utils.boardCard","tau/models/page.entity/entity.context.factory","tau/core/termProcessor","tau/ui/extensions/board.plus/card-context-menu/menu-action-item-base","tau/utils/utils.serverErrorTranslator","template!tau/ui/templates/ui.template.board.cell.convert.success"],function(e,t,n,o,i,r,a,u,c){var s=!1,d="entityTypesToConvertInto",l="i-role-card-context-menu-convert",f={entityTypes:["request","feature","bug","userstory","task"],allowedFor:function(e){return t.contains(this.entityTypes,e)}},b=function(e){return"Do you really want to convert "+e.srcEntityType.term+" to "+e.dstEntityType.term+"?"},m=function(t){return t.keyCode===e.ui.keyCode.ESCAPE},v=function(e,n){if(null!==n){var o=t.findWhere(e,{name:n});if(o){var i=e.indexOf(o);e.splice(i,1)}}},y={setup:function(n,o,i,r,a,u){var c=e("<div/>").append(o.element),s=e.Deferred(),d=c.append(['<div class="i-role-confirmation-content" style="display: none">',"<h3>"+b(u)+"</h3>",'<div class="tau-buttons">','<button type="button" class="tau-btn tau-primary i-role-actionok">Yes, I\'m sure</button>','<button type="button" class="tau-btn i-role-actioncancel">No</button>',"</div>","</div>"].join("")),l="hideSubmenu",f=r.tauBubble({alignTo:r,template:['<div class="tau-bubble">','<div class="tau-bubble__arrow" role="arrow"></div>','<div class="tau-bubble__inner tau-container" role="content"></div>',"</div>"].join(""),content:d,onPositionConfig:function(e){return e.my="center top",e.at="center bottom",e.collision="fit flip",e},onArrowPositionConfig:function(e,t){return"bottom"===t?(e.my="center bottom",e.at="center top"):(e.my="center top",e.at="center bottom"),e},onHide:function(){u.configurator.getKeyBoardManager().popHandler(),v(n,l)},onShow:function(){e.contextMenu.op.registerKeyHandlerFilter(m),u.configurator.getKeyBoardManager().pushHandler({});var t=f.tauBubble("widget");t.find(".tau-lookup-block").show(),t.find(".i-role-confirmation-content").hide(),t.removeClass("tau-warning-bubble"),t.find(".filter-field").focus(),t.unbind("click"),r.tauBubble("adjustPosition"),t.one("click",".i-role-actioncancel",function(){f.tauBubble("hide"),s.reject()
}),t.one("click",".i-role-actionok",function(){f.tauBubble("hide");var e=a.data();s.resolve(e.entityId)})},zIndex:99999});return f.tauBubble("show"),i.fire("$outerBubbled.shown",f),n.push({hide:t.bind(f.tauBubble,f,"hide"),name:l}),s},run:function(t,o,i,r,a,u,c,s){var l=n.create({entityType:"userstory"}),f=this,b=e.Deferred();l.on("afterRender",function(n,m){var v=f.setup(t,m,l,i,o,a);e.when(b,v).done(function(e,t){a.configurator.getActionsService().convertGeneralToTask(t,e).done(function(e){r.$menu.trigger("contextmenu:hide"),c.notifyAboutSuccess(a.srcEntityType,a.dstEntityType,e.d);var t=o.data();delete t[d],u(t)}).fail(s)})}),l.on("entitySelected",function(e,t){var n=i.tauBubble("widget");n.find(".tau-lookup-block").hide(),n.find(".i-role-confirmation-content").show(),n.addClass("tau-warning-bubble"),i.tauBubble("adjustPosition"),b.resolve(t.entity.id)}),l.on("result.ready",function(){i.tauBubble("adjustPosition")}),l.initialize({context:a.appContext})}};return{createMenuItem:function(n){var m=new a(n),p=function(){var o=n.configurator,i=n.bus,r=e.Deferred();return n.configurator.getComponentBusRegistry().getByName("entityViewer").done(r.resolve),{createNodeMessage:function(e,t,n){var i={srcType:e.term,dstType:t.term,name:n.Name,url:o.getUrlBuilder().getNewViewUrl(n.ID,t.name,!0)};return c.render(i)},notifyAboutSuccess:function(e,n,o){var a=this.createNodeMessage(e,n,o);r.then(function(e){a.on("click",".i-role-card-view",t.bind(function(t){t.preventDefault(),e.fire("cardDataToShow.ready",{entityId:o.ID,entityType:n.name.toLowerCase()}),this.fire("close")},i)),i.fire("notification",{$node:a})})}}}(),g=function(e){m.deleteCard(e,n.bus)},h=function(e){var t=JSON.parse(e.responseText)||{Message:"Server is not available"},o=u.translateServerError.call(this,t);n.bus.fire("error",o)},T=function(e,o,i,r){var a=i.$trigger.data(),u=a.entityId,c=r.$node,s="confirm";c.tauConfirm({showEvent:null,content:["<h3>"+b(o)+"</h3>"].join(""),className:"context-menu-do-not-hide i-role-taububble-ignore",callbacks:{success:t.bind(function(e){e.$menu.trigger("contextmenu:hide");
var t=o.dstEntityType.id;o.configurator.getActionsService().convertGeneralToType(u,t).done(function(e){p.notifyAboutSuccess(o.srcEntityType,o.dstEntityType,e.d),delete a[d],g(a)}).fail(h)},n.bus,i)},onHide:function(){v(e,s)}}),t.defer(t.bind(c.tauConfirm,c),"show"),e.push({hide:t.bind(c.tauConfirm,c,"hide"),name:s})},w=function(e,t,n,o){y.run(e,n.$trigger,o.$node,n,t,g,p,h)},C=function(t){var o=t.data();return o.hasOwnProperty(d)?e.Deferred().resolve(o[d]):s?e.Deferred().resolve([]):n.configurator.getActionsService().getEntityTypesToConvert(o.entityId).done(function(e){t.data(d,e)}).fail(h)},k=[],B=function(){t.each(k,function(e){e.hide()}),k=[]},E=function(e){return"task"===e.name.toLowerCase()},x=function(a,u){var c=e("<div>Loading&hellip;</div>"),s="submenu",d={template:['<div class="tau-bubble-board">','<div class="tau-bubble-board__inner tau-container convert-menu-items" role="content" ></div>',"</div>"].join(""),showEvent:"",hideEvent:"",stackName:"context-menu-convert-action",content:c,onPositionConfig:function(e){return e.my="left center",e.at="right center",e.collision="flipfit",e},onHide:function(){v(k,s)}},l=u.$node.tauBubble(d);l.tauBubble("show"),k.push({hide:t.bind(l.tauBubble,l,"hide"),name:s});var f=a.$trigger,b=o.convertToEntity(f.data()),m=i.create(b,n.configurator),y=C(f);e.when(m,y).then(function(o,i){var u=f.data("entityType"),s=new r(o.getTerms()),d={name:u,term:s.getTerm(u)},l=e("<div></div>").on({mouseenter:function(t){e(t.target).addClass("hover")},mouseleave:function(t){e(t.target).removeClass("hover")}},".i-role-convert-to");t.chain(i).sortBy(function(e){return E(e)?1:0}).each(function(t){var i=E(t)?t.term+"...":t.term,r=s.getTerms(t.name),u=e('<div class="custom-context-menu-item i-role-convert-to" data='+t.term.toLowerCase()+'><span><i class="tau-entity-icon tau-entity-icon--'+t.name.toLowerCase()+'">'+r.iconSmall+"</i>"+i+"</span></div>");u.click(function(i){var r=E(t)?w:T,u={srcEntityType:d,dstEntityType:t,appContext:o,configurator:n.configurator};
r(k,u,a,{$node:e(this)}),i.stopPropagation()}).appendTo(l)}),c.empty().append(l)})};return{name:"Convert to&hellip;",className:l,isDisabled:s,onHide:function(){B()},disabled:function(){var e=this,t=e.data("entityType");return!f.allowedFor(t)},itemClickCallback:function(e,t){return x(e,t),!1}}}}});