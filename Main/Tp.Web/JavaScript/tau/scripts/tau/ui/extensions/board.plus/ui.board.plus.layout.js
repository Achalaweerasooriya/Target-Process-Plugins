define(["Underscore","jQuery","tau/core/class"],function(_,$,Class){var Board=Class.extend({setConfig:function(config){this.config=config,_.defaults(this.config,{useFixedColumnSizes:!1,columnSizes:{}}),this.setSizes(config.sizes)},setFixedColumnSize:function(d){var self=this;_.extend(this.config.columnSizes,d),_(d).chain().keys().each(function(k){var c=self.cols[k];c.extraWidth=0})},getFixedColumnSize:function(columnId){var self=this;if(!self.config.useFixedColumnSizes)return null;var c=self.cols[columnId],r=c.isCollapsed?null:this.config.columnSizes[columnId];return r=r||null,r},resolveColumnSize:function(columnId){var resolvedSize=this.getFixedColumnSize(columnId);if(!resolvedSize){var column=this.cols[columnId],$columnCell=column.items[0].$el,columnZoomLevel=this.getItemZoomLevelOrDefault(column.isCollapsed),zoomLevelCardWidth=this.getSizeInfo(columnZoomLevel).width;resolvedSize=$columnCell.width()/zoomLevelCardWidth}return Math.floor(resolvedSize)},setSizes:function(sizes){_.forEach(sizes,function(size){_.defaults(size,{cardsInRowMin:0,cardsInRowMax:99999,clientColsMin:99999,clientRowsMin:99999})}),this.config.sizes=sizes},getSizeInfo:function(zoomLevel){return this.config.sizes[zoomLevel]},setCurrentZoomLevel:function(zoomLevel){return zoomLevel=zoomLevel||this.currentZoom||1,zoomLevel in this.config.sizes||(zoomLevel=5),this.currentZoom=zoomLevel,this.currentZoom},getCurrentZoomLevel:function(){return this.currentZoom||1},getColumnsCount:function(){return _.keys(this.cols).length},getItemZoomLevelOrDefault:function(isCollapsed){return isCollapsed?"collapsed":this.getCurrentZoomLevel()},setElement:function($el){this.$el=$el,this.$grid=$el.find(".i-role-grid"),this.$headers=$el.find(".i-role-header"),this.cells=[],this.rows={},this.cols={},this.headerCells=[];var gridWidth=this.$grid.width(),scrollWidth=this.config.scrollY===!1?0:gridWidth-(this.$grid[0].clientWidth||gridWidth);this.padding=this.config.padding*2||14,this.scrollWidth=scrollWidth+this.padding,this.cellBorderWidth=0,this.initializeGridModel()},refreshElement:function(){this.setElement(this.$el)},initializeGridModel:function(){var $cells=this.$grid.find(".i-role-cell"),self=this;$cells.each(function(){var $cell=$(this),$cellHolder=$cell.parent();if($cellHolder.css("display")=="none")return;var isCollapsedByX=$cellHolder.hasClass("tau-collapsed_x"),isCollapsedByY=$cellHolder.hasClass("tau-collapsed_y"),data=$cell.data(),cellItem={$el:$cell,cardsNum:$cell.find(".i-role-card").length,isCollapsed:isCollapsedByX,data:data,width:null,height:null,isHidden:!1},cellColumn=self.cols[data.x];self.cols[data.x]=cellColumn?cellColumn:{x:data.x,items:[],_sizes:[],cardsNum:0,extraWidth:0,isCollapsed:isCollapsedByX};var cellRow=self.rows[data.y];self.rows[data.y]=cellRow?cellRow:{y:data.y,items:[],height:null,_sizes:[],cardsNum:0,isCollapsed:isCollapsedByY},self.cols[data.x].cardsNum+=cellItem.cardsNum,self.cols[data.x].items.push(cellItem),self.rows[data.y].cardsNum+=cellItem.cardsNum,self.rows[data.y].items.push(cellItem),self.cells.push(cellItem)});var createHeaderCellsIterator=function(axisName){var modelName=axisName==="x"?"cols":"rows",syncSize=axisName==="x"?"width":"height";return function(){var $cell=$(this);if($cell.parent().attr("data-is-hidden"))return;var data=$cell.data(),cell={$el:$cell,data:data,syncItem:self[modelName][data[axisName]],syncSize:syncSize};self.headerCells.push(cell)}};this.$headers.filter("[data-dimension=x]").find(".i-role-cell").each(createHeaderCellsIterator("x")),this.$headers.filter("[data-dimension=y]").find(".i-role-cell").each(createHeaderCellsIterator("y"))},updateSize:function(){this.calculateOptimalSize(),this.justifyWidth(),this.justifyHeight(),this.justifyHeightByHeader(),this.updateCells(),this.updateHeaders()},calculateOptimalSize:function(){var self=this,zoomLevel=self.getCurrentZoomLevel(),clientWidth=this.$grid[0].clientWidth||this.$grid.width(),clientHeight=this.$grid[0].clientHeight||this.$grid.height(),cardSizeInfo=self.getSizeInfo(zoomLevel),cardWidth=cardSizeInfo.width,cardHeight=cardSizeInfo.height,scrollWidth=this.scrollWidth,borderWidth=this.cellBorderWidth,currentRowsLength=_.values(this.rows).length||1,currentColsLength=_.values(this.cols).length||1,colMinWidth=clientWidth/Math.min(cardSizeInfo.clientColsMin,currentColsLength)-scrollWidth,cardsInRowMax=Math.floor((colMinWidth-scrollWidth-borderWidth)/cardWidth)||1,rowMinWidth=clientHeight/Math.min(cardSizeInfo.clientRowsMin,currentRowsLength),cardsInColMax=Math.floor(rowMinWidth/cardHeight),ratio=3,cells=this.cells;_.each(cells,function(cell){var cardSizeInfo=self.getSizeInfo(self.getItemZoomLevelOrDefault(cell.isCollapsed)),r=self.getCellResizeInfo(cell,ratio,cardsInRowMax,cardsInColMax,cardSizeInfo);cell.height=r.height,cell.cardsInCol=r.cardsInCol,cell.cardsInRow=r.cardsInRow}),_.each(self.rows,function(row){row.height=_.max(row.items,function(r){return r.height}).height,row.cardsInCol=_(row.items).chain().pluck("cardsInCol").max().value()}),_.each(self.cols,function(col){col.extraWidth=0,col.cardsInRow=_(col.items).chain().pluck("cardsInRow").max().value()}),_.each(cells,function(cell){cell.cardsInRow=self.cols[cell.data.x].cardsInRow,cell.height=self.rows[cell.data.y].height,cell.cardsInCol=self.rows[cell.data.y].cardsInCol})},getCellResizeInfo:function(cell,ratio,cardsInRowMax,cardsInColMax,cardSizeInfo){var self=this,cellCardsNum=cell.cardsNum,cardWidth=cardSizeInfo.width,cardHeight=cardSizeInfo.height,cardSpace=cardWidth*cardHeight,cardsInCell=cellCardsNum||1,cellWidth=Math.sqrt(cardsInCell*cardSpace/ratio),cardsInRow=null,fixedCardsSize=self.getFixedColumnSize(cell.data.x);fixedCardsSize!=null?cardsInRow=fixedCardsSize:(cardsInRow=_.min([Math.ceil(cellWidth/cardWidth),cardsInRowMax,cardSizeInfo.cardsInRowMax]),cardsInRow=_.max([cardsInRow,cardSizeInfo.cardsInRowMin]));var cardsInCol=Math.ceil(cardsInCell/cardsInRow);return self.config.scrollY!==!1&&(cardsInCol=Math.min(cardsInCol,cardsInColMax)),{height:cardsInCol*cardHeight,cardsInCol:cardsInCol,cardsInRow:cardsInRow}},getActualTableWidth:function(){var self=this;return 1+_.reduce(self.cols,function(memo,c){var colWidth=self.calculateColumnWidth(c);return memo+colWidth+1},1)},getTargetColumns:function(columns){var self=this,freeWidthColumns=_.filter(columns,function(c){var s=self.getFixedColumnSize(c.x);return s==null}),expandedColumns=_.filter(freeWidthColumns,function(col){return!col.isCollapsed}),r=expandedColumns.length!==0?expandedColumns:freeWidthColumns;return r},getZoomLevelCardWidth:function(zoomLevel,columns){var hasExpandedColumns=_.some(columns,function(c){return!c.isCollapsed}),selector=hasExpandedColumns?zoomLevel:"collapsed",cardSize=this.getSizeInfo(selector);return cardSize.width},justifyWidth:function(){var self=this,zoomLevel=self.getCurrentZoomLevel();if(_.values(this.rows).length==0)return;var clientWidth=this.$grid[0].clientWidth||this.$grid.width(),tableWidth=self.getActualTableWidth(),availableWidth=clientWidth-tableWidth;if(availableWidth<=0)return;var colsToResize=self.getTargetColumns(self.cols);if(colsToResize.length===0)return;var zoomLevelCardWidth=self.getZoomLevelCardWidth(zoomLevel,colsToResize),availableCards=Math.floor(availableWidth/zoomLevelCardWidth);if(availableCards>0){var koefs=self.distributionByCardsCount(colsToResize),incrementationByColumns=self.translateKoefsToAbsoluteIncrementors(colsToResize,koefs,availableCards);colsToResize=self.distributeCardsIncrementation(colsToResize,incrementationByColumns)}if(self.config.scrollY===!1){var extraWidth=clientWidth-self.getActualTableWidth();self.distributeExtraWidthToColumns(colsToResize,extraWidth)}},distributeCardsIncrementation:function(columns,incrementationByColumns){return _.each(columns,function(clmn,k){var cardsIncrementor=incrementationByColumns[k];_.each(clmn.items,function(cell){var cardsInRow=cell.cardsInRow+cardsIncrementor;cell.cardsInRow=cardsInRow,clmn.cardsInRow=cardsInRow})}),columns},translateKoefsToAbsoluteIncrementors:function(colsToResize,koefs,availableCards){var self=this,absoluteCardsIncrementation=[],lessCards=availableCards;_(colsToResize.length).times(function(k){absoluteCardsIncrementation[k]=0});while(lessCards>0){koefs=self._normalize(koefs);var freeCards=lessCards;_.each(koefs,function(koef,k){var cards=Math.min(lessCards,Math.round(freeCards*koef));absoluteCardsIncrementation[k]+=cards,lessCards-=cards}),koefs.pop()}return absoluteCardsIncrementation},distributionByCardsCount:function(columns){var totalCards=_.reduce(columns,function(memo,col){return memo+col.cardsNum},0);totalCards=totalCards||1;var allZeroKoefs=!0,koefs=_.map(columns,function(col){var k=col.cardsNum>0?_(col.items).chain().pluck("cardsNum").max().value()/totalCards:0;return k!=0&&(allZeroKoefs=!1),k});if(allZeroKoefs){var normalKoef=1/koefs.length;koefs=_.map(koefs,function(){return normalKoef})}return koefs},distributeExtraWidthToColumns:function(columns,totalExtraWidth){var self=this;if(totalExtraWidth>0){var columnsLength=columns.length||1,distribution=self._distribute(totalExtraWidth,columnsLength,Math.floor);_.each(columns,function(clmn,k){clmn.extraWidth=distribution[k]})}return columns},justifyHeight:function(){var zoomLevel=this.getCurrentZoomLevel(),cardSize=this.getSizeInfo(zoomLevel),cardHeight=cardSize.height,self=this;_.forEach(this.rows,function(row){row._sizes=[]}),_.forEach(this.cells,function(cell){var cardsInCol=cell.cardsInCol,realCardsInCol=Math.ceil(cell.cardsNum/cell.cardsInRow)||1;if(realCardsInCol<=cardsInCol){var cellHeight=cardHeight*realCardsInCol;cell.cardsInCol=realCardsInCol,cell.height=cellHeight}self.rows[cell.data.y]._sizes.push(cell.height)}),_.forEach(this.rows,function(row){row.height=Math.max.apply(null,row._sizes)}),_.forEach(this.cells,function(cell){cell.height=self.rows[cell.data.y].height})},justifyHeightByHeader:function(){var self=this;_.forEach(this.rows,function(row,y){row.minHeight=null;var header=_.find(self.headerCells,function(v){return v.data.y==y});header&&!header.isCollapsed&&(row.minHeight=header.$el.children().height())}),_.forEach(this.cells,function(cell){cell.minHeight=self.rows[cell.data.y].minHeight})},updateCells:function(){var self=this;_.each(self.cells,function(cell){var $cell=cell.$el;$cell.width(self.calculateCellWidth(cell)),cell.minHeight&&$cell.css("min-height",cell.minHeight)})},calculateCellWidth:function(cell){var self=this,clmn=self.cols[cell.data.x];return self.calculateColumnWidth(clmn)},calculateColumnWidth:function(clmn){var self=this,cardsInRow=clmn.cardsInRow,extraWidth=clmn.extraWidth,scrollWidth=self.scrollWidth,columnZoomLevel=self.getItemZoomLevelOrDefault(clmn.isCollapsed),cardWidth=self.getSizeInfo(columnZoomLevel).width;return cardsInRow*cardWidth+extraWidth+scrollWidth},updateHeaders:function(){var self=this,j=0;_.each(self.headerCells,function(cell,i){var $cell=cell.$el;if(cell.syncSize=="height"&&self.config.scrollY===!1){var data=cell.data,$tds=self.rows[data.y].items[0].$el.parent().parent().children(),hs=[];$tds.each(function(){var h=parseFloat(getComputedStyle(this).height,10);$.browser.msie&&i==self.headerCells.length-1&&(h=$(this).height()),hs.push(h)});var h=Math.max.apply(null,hs);$.browser.webkit&&(h=Math.round(h),h-=1),$cell.height(h),j++}else{var cellWidth=self.calculateCellWidth(cell);$cell.width(cellWidth)}})},_distribute:function(value,num,funcToDivide){var dist=[],less=value;funcToDivide=funcToDivide||Math.round;var part=funcToDivide(value/num);for(var i=0;i<num;i++)dist[i]=less?part:0,less-=part;return dist[dist.length-1]=dist[dist.length-1]+less,dist},_normalize:function(koefs){var norm=1/_.reduce(koefs,function(memo,num){return memo+num},0),normKoefs=_.map(koefs,function(num){return num*norm});return normKoefs}});return Board})