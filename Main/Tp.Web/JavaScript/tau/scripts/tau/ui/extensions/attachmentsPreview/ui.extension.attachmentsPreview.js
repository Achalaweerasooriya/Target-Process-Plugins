define(["Underscore","jQuery","tau/components/extensions/component.extension.base"],function(_,$,ExtensionBase){return ExtensionBase.extend({"bus afterRender":function(evt){var self=this;self.element=evt.data.element,self.element.find(".thumbnail-nav").click(_.bind(self._onAttachmentThumbnailsContainerClick,self)),self.element.find(".toolbar .prev, .toolbar .next").click($.proxy(self,"_onAttachmentsNavigationClick")),self.element.click($.proxy(self,"_onClose")),this.config.context.configurator.getKeyBoardManager().pushHandler({handleKeyDown:function(){self._onKeyDown.apply(self,arguments)}})},"bus destroy":function(){this.destroy()},"bus changeSelected":function(evtArgs){var attachment=evtArgs.data.attachment;this._changeSelectedAttachment(attachment)},_getSelectedAttachmentSelector:function(){return".thumbnail-nav > li > img.selected"},_getAttachmentsCount:function(){return this.element.find(".thumbnail-nav > li").length},_getCurrentSelectedAttachment:function(){return this.element.find(this._getSelectedAttachmentSelector()).parent().data().tmplItem.data},_getAttachmentData:function(index){return this.element.find(".thumbnail-nav > li").eq(index).data().tmplItem.data},_getCurrentSelectedAttachmentIndex:function(){return this.element.find(this._getSelectedAttachmentSelector()).parent().index()},_changeSelectedAttachment:function(attachment){if(this._getCurrentSelectedAttachment().id==attachment.id)return;var element=this.element;element.find(".thumbnail-nav > li > img.selected").removeClass("selected");var $thumbnails=element.find(".thumbnail-nav > li > img"),self=this;$thumbnails.each(function(){if($(this).parent("li").data().tmplItem.data.id==attachment.id){$(this).addClass("selected");var $img=element.find(".ui-attachment-view-image");return self.bus.fire("beforeChangeImage",attachment.uri)&&($img.attr("src",attachment.uri),self.bus.fire("afterChangeImage")),!1}})},_onKeyDown:function(evt){evt.keyCode==$.ui.keyCode.ESCAPE&&this._close()},_close:function(){this.element.remove(),this.bus.fire("closed"),this.fire("destroy")},_next:function(){var index=this._getCurrentSelectedAttachmentIndex()+1;index>=this._getAttachmentsCount()&&(index=0),this._setSelectedAttachmentIndex(index)},_prev:function(){var index=this._getCurrentSelectedAttachmentIndex()-1;index<0&&(index=this._getAttachmentsCount()-1),this._setSelectedAttachmentIndex(index)},_setSelectedAttachmentIndex:function(index){this._changeSelectedAttachment(this._getAttachmentData(index))},_closeButtonClick:function(evtArgs){evtArgs.stopPropagation(),this._close()},_onAttachmentsNavigationClick:function(evt){evt.stopPropagation();var $element=$(evt.target);$element.hasClass("prev")?this._prev():$element.hasClass("next")&&this._next()},_onAttachmentThumbnailsContainerClick:function(event){event.stopPropagation();var $target=$(event.target);if($target.is(".ui-attach-thumbnail")){var data=$target.parent("li").data(),attachment=data.tmplItem.data;this._changeSelectedAttachment(attachment)}},_onClose:function(evt){/^img$/i.test(evt.target.tagName)||this._close()},destroy:function(){this.config.context.configurator.getKeyBoardManager().popHandler(),this.element.find(".ui-attachments-control > .display-table").unbind("click")}})})