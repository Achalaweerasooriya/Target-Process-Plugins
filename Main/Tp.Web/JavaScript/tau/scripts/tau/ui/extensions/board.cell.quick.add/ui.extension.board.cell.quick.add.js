define(["Underscore","jQuery","tau/core/extension.base","tau/ui/extensions/board.cell.quick.add/quick.add.error.handler","tau/ui/extensions/board.cell.quick.add/board.cell.quick.add.config.fields","libs/jquery/jquery.placeholder","libs/jquery/jquery.caret"],function(e,t,i,a,s){return i.extend({init:function(e){this._super(e),this._configurator=e.context.configurator,this._configurator.getTemplateFactory().register({name:"board.cell.quick.add.success",engine:"jqote2",markup:["<h3>Success!</h3>","<p>","<%! this.type %> ","<% if (this.name && this.url) { %>",'<a class="ui-quick-add-notification-link i-role-card-view tau-entity-name" href="<%= this.url %>"><%! this.name %></a>',"<% } %>"," was added.","</p>"]})},"bus beforeInit:last + dataBind + afterRender":function(i,a,s,d){var r=this.$element=d.element,o=r.find(".tau-required-field-editor,.tau-add-item");r.find("form").on("submit.quickAdd",e.bind(this.onSubmit,this)),r.on("click.quickAdd",".i-role-add-open",e.bind(this.onAddOpen,this)),r.on("click.quickAdd",".i-role-entity-selector",e.bind(this.onTypeSelectorClick,this)),window.setTimeout(function(){r.parent().addClass("tau-bubble__inner_without_scroll"),r.find(".tau-entity-controls .tau-active input, .tau-entity-controls .tau-active select").eq(0).focus()},0);var n=this;r.find("form").each(function(){var e=t(this),i=e.find("[data-fieldname=Spent], [data-fieldname=Remain], [data-fieldname=Role]");3==i.length&&n._processTimeWidget(e,i,s)}),this._initializeProcessRelatedFields(r,o),this.fire("view.indicator.ready",r.tauProgressIndicator()),this.fire("view.editors.ready",o),this.fire("quick.add.popup.rendered",o)},_initializeProcessRelatedFields:function(e,t){this._initializeProcessRelatedSelects(e,t),this._initializeProcessRelatedMultiCheckboxes(e,t)},_initializeProcessRelatedSelects:function(i,a){var s=a.filter(".project"),d=a.filter(".team"),r=a.filter(".process"),o=r.add(s).add(d);0===o.length&&i.find(".cf-wrap").addClass("show").removeClass("hide");var n=e.bind(function(e,i){i=t(i?i:e.target);
var a,s=i.find(":selected").data("option");i.hasClass("process")?a=s.id:i.hasClass("project")?a=s.processId:i.hasClass("team")&&0===i.closest("form").find(".project").length&&(a=s.processId),a&&this.toggleCustomFields(i,a)},this);o.change(n),o.each(n)},_initializeProcessRelatedMultiCheckboxes:function(i,a){var s=a.filter(".projects"),d=s.find("input"),r=e.bind(function(e,i){i=t(i?i:e.target);var a=i.closest(".projects"),s=a.data("checkedProjects")||[],d=a.data("appliedProcessId")||null,r=i.is(":checked"),o=i.val(),n=i.data("processId");if(r)s.push({projectId:o,processId:n});else for(var l=0;l<s.length;l++){var c=s[l];c.projectId==o&&s.splice(l,1)}a.data("checkedProjects",s);var u=s[0];u?u.processId!=d&&(d=u.processId):d=null,a.data("appliedProcessId",d),this.toggleCustomFields(i,d)},this);d.change(r),d.each(r)},toggleCustomFields:function(e,t){var i=e.closest("form").find(".cf-wrap").addClass("hide").removeClass("show");i.find(".cf-input").addClass("hide").removeClass("show"),i.filter(".cf-process_"+t).addClass("show").removeClass("hide").find(".cf-input").addClass("show").removeClass("hide"),this.fire("adjustPosition")},setHtmlForMessage:function(e,t){var i=e.find(".tau-message-pool");i.children().remove(),i.width("").width(i.width()),i.append(t)},"bus afterRender:last + model.data.item.did.add":function(e,t){var i=t.element.find(".tau-control-set.tau-active .tau-required-field-editor");this.prepareFields.clear(i),i.filter(".tau-in-text").placeholder("refresh"),window.setTimeout(function(){i.filter(":visible").eq(0).focus()},100)},_openView:function(e){this._configurator.getEntityViewService().showEntityView({entityId:e.id,entityType:e.type}),this.fire("close")},"bus beforeInit:last + afterRender:last + model.data.item.did.add":function(i,a,s,d){var r=d.message.dataItem,o=r.data.cardData||r.data,n={id:o.id,name:o.name,type:r.type.toLowerCase(),nameType:d.nameType.title};if(d.openAfter)this._openView(n);else{var l;"time"!=n.type&&(l=a.config.context.configurator.getUrlBuilder().getNewViewUrl(n.id,n.type,!0));
var c=a.config.context.configurator.getTemplateFactory().get("board.cell.quick.add.success").bind({},{type:n.nameType,name:n.name,url:l});"x"===d.message.location||"y"===d.message.location||d.openAfter||d.skipNotification||this.fire("notification",{$node:c}),c.on("click",".i-role-card-view",e.bind(function(e){e.preventDefault(),this._openView(n)},this))}var u=t('<div class="tau-quick-add-success-message i-role-quick-add-success-message" />');u.data("id",n.id),this.setHtmlForMessage(s.element,u),this.fire("adjustPosition")},"bus afterRender:last+beforeInit:last+model.add.item:last+model.data.item.did.fail.add":function(e,t,i,s,d){var r=this;a.handle(d,s,{setText:function(e){r.setHtmlForMessage(t.element,e),r.fire("adjustPosition")}},i.config.context.configurator)},"bus afterRender:last+view.submit":function(i,a,s){var d=s.type,r=a.element.find(".tau-control-set."+d+" .tau-required-field-editor").filter(":not(.placeholder)").filter(":not(.hide)"),o=r.filter(".cf-input"),n=this.prepareFields;if(n.validate(r)){var l=e.reduce(r,function(e,i){var a=t(i),s=a.data("fieldname"),d=a.data("fieldtype"),r=n.getValue(a);return a.data("iscf")||e.push({id:s,value:r,type:d}),e},[]);if(o.length){var c=e.reduce(o,function(e,i){var a=t(i),s=a.data(),d={name:s.fieldname,type:s.fieldtype,value:n.getCfValue(i)};return d.value&&e.push(d),e},[]);l.push({id:"CustomFields",value:JSON.stringify(c)})}this.fire("model.add.item",{fields:l,type:d,openAfter:s.openAfter}),r.off(".validator")}else r.off(".validator").on("input.validator change.validator",function(){n.validate(r)})},"bus beforeInit:last + view.editors.ready + culture.ready":function(e,t,i,a){i.filter(".tau-in-text").placeholder(),this.prepareFields=new s({culture:a,self:this,configurator:t.config.context.configurator}),this.prepareFields.setBehavior(i),this.culture=a},"bus childComponentCreated":function(e,t){this.childBus[t.name]=t},childBus:{},"bus view.editors.ready:last+view.indicator.ready:last+before_model.add.item":function(e,t,i){t.filter(":not(.disabled)").prop("disabled",!0),i.tauProgressIndicator("show"),this.fire("adjustPosition")
},afterDataItemAdding:function(e,t){e.filter(":not(.disabled)").prop("disabled",!1),t.data("ui-tauProgressIndicator")&&t.tauProgressIndicator("hide"),this.fire("adjustPosition")},"bus view.editors.ready:last+view.indicator.ready:last+model.data.item.did.add":function(e,t,i){this.afterDataItemAdding(t,i)},"bus view.editors.ready:last+view.indicator.ready:last+model.data.item.did.fail.add":function(e,t,i){this.afterDataItemAdding(t,i)},"bus afterRender:last+view.select.entity.editor":function(e,i,a){var s=i.element,d=s.find(".tau-control-set.tau-active .tau-required-field-editor").not(".placeholder");s.find(".tau-active").removeClass("tau-active").prop("disabled",!1),s.find(".tau-message-pool").children().remove(),s.find(".i-role-entity-selector.tau-"+a.type.toLowerCase()).addClass("tau-active").prop("disabled",!0);var r=".tau-entity-controls .tau-control-set."+a.type;s.find(r).addClass("tau-active"),window.setTimeout(function(){s.find(".tau-entity-controls .tau-active :text, .tau-entity-controls .tau-active textarea").eq(0).focus().caretToEnd()},0),d.each(function(){var e=t(this),i=e.data();if(!i.iscf){var a=".tau-control-set.tau-active .tau-required-field-editor."+t.escapeSelector(i.fieldname),d=s.find(a),r=e.val();switch(i.fieldtype){case"Text":d.filter(":not(.placeholder)").val(r),r&&d.show().filter(".placeholder").remove();break;case"DDL":d.val()!=r&&(e.hasClass("disabled")||d.find('[value="'+r+'"]').prop("selected",!0).length&&d.change());break;case"TeamMultiSelect":case"ProjectMultiSelect":var o=e.closest(".tau-new-entity-form__row--customizable.tau-customize-flow");o.removeClass("tau-customize-flow");break;default:d.val(r)}}}),this.fire("adjustPosition")},onTypeSelectorClick:function(e){e.preventDefault();var i=t(e.target);if(!i.hasClass("tau-active")){var a=i.data().type;this.fire("view.select.entity.editor",{type:a})}},onSubmit:function(e){return this.fire("view.submit",{type:t(e.target).data().type}),!1},onAddOpen:function(e){return this.fire("view.submit",{type:t(e.target).closest("form").data().type,openAfter:!0}),!1
},_processTimeWidget:function(i,a,s){var d=function(e){return Math.round(100*e)/100},r=a.filter("[data-fieldname=Spent]"),o=a.filter("[data-fieldname=Remain]");r.attr("autocomplete","off"),o.attr("autocomplete","off");var n=t(['<div class="tau-field tau-field__time">',"<label><span></span></label>","<label><span></span></label>","</div>"].join(""));n.insertBefore(r.parent()),r.parent().detach(),n.find("label span").eq(0).text(r.attr("placeholder")),r.attr("placeholder",""),r.appendTo(n.find("label").eq(0)),o.parent().detach(),n.find("label span").eq(1).text(o.attr("placeholder")),o.attr("placeholder",""),o.appendTo(n.find("label").eq(1));var l=a.filter("[data-fieldname=Role]"),c=s.types.Time.template,u=e.find(c.items,function(e){return"Remain"==e.id}),f={};e.forEach(u.options.defaultValues,function(e){f[e.key]=e.value}),o.val(f[l.val()]);var p=f[l.val()];l.on("change",e.bind(function(){p=f[l.val()],o.val(e.outFloatLocal(f[l.val()],this.culture)||0),r.trigger("input")},this));var h="oninput"in r[0]?"input":"keyup";r.on(h,e.bind(function(){var t=e.parseFloatLocal(r.val(),this.culture)||0,i=(e.parseFloatLocal(p,this.culture)||0)-t;i=0>i?0:i,o.val(e.outFloatLocal(d(i),this.culture)||0)},this)),o.on(h,function(){p=o.val()}),this.bus.on("model.data.item.did.add",function(){f[l.val()]=o.val(),p=f[l.val()]},this)},"bus relatedQuickAdd.afterShow":function(){this.$element.addClass("bg-overlay")},"bus relatedQuickAdd.afterHide":function(){this.$element.removeClass("bg-overlay")}})});