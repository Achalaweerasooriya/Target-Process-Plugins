define(["Underscore","jQuery","tau/core/extension.base","tau/ui/extensions/board.cell.quick.add/quick.add.error.handler","tau/ui/extensions/board.cell.quick.add/board.cell.quick.add.config.fields","libs/jquery/jquery.placeholder","libs/jquery/jquery.caret"],function(e,t,i,a,d){return i.extend({init:function(e){this._super(e);var t=e.context.configurator;t.getTemplateFactory().register({name:"board.cell.quick.add.success",engine:"jqote2",markup:["<h3>Success!</h3>","<p>","<%! this.type %> ","<% if (this.name && this.url) { %>",'<a class="ui-quick-add-notification-link i-role-card-view tau-entity-name" href="<%= this.url %>"><%! this.name %></a>',"<% } %>"," was added.","</p>"]})},"bus beforeInit:last + dataBind + afterRender + culture.ready":function(i,a,d,s,r){var n=this.$element=s.element,o=n.find(".tau-required-field-editor,.tau-add-item");n.find("form").on("submit.quickAdd",e.bind(this.onSubmit,this)),n.on("click.quickAdd",".i-role-add-open",e.bind(this.onAddOpen,this)),n.on("click.quickAdd",".i-role-entity-selector",e.bind(this.onTypeSelectorClick,this)),window.setTimeout(function(){n.parent().addClass("tau-bubble__inner_without_scroll"),n.find(".tau-entity-controls .tau-active input, .tau-entity-controls .tau-active select").eq(0).focus()},0);var l=this;n.find("form").each(function(){var e=t(this),i=e.find("[data-fieldname=Spent], [data-fieldname=Remain], [data-fieldname=Role]");3==i.length&&l._processTimeWidget(e,i,d,r)}),this._initializeProcessRelatedFields(n,o),this.fire("view.indicator.ready",n.tauProgressIndicator()),this.fire("view.editors.ready",o),this.fire("quick.add.popup.rendered",o)},_initializeProcessRelatedFields:function(e,t){this._initializeProcessRelatedSelects(e,t),this._initializeProcessRelatedMultiCheckboxes(e,t)},_initializeProcessRelatedSelects:function(i,a){var d=a.filter(".project"),s=a.filter(".team"),r=a.filter(".process"),n=r.add(d).add(s);0===n.length&&i.find(".cf-wrap").addClass("show").removeClass("hide");var o=e.bind(function(e,i){i=t(i?i:e.target);
var a,d=i.find(":selected").data("option");i.hasClass("process")?a=d.id:i.hasClass("project")?a=d.processId:i.hasClass("team")&&0===i.closest("form").find(".project").length&&(a=d.processId),a&&this.toggleCustomFields(i,a)},this);n.change(o),n.each(o)},_initializeProcessRelatedMultiCheckboxes:function(i,a){var d=a.filter(".projects"),s=d.find("input"),r=e.bind(function(e,i){i=t(i?i:e.target);var a=i.closest(".projects"),d=a.data("checkedProjects")||[],s=a.data("appliedProcessId")||null,r=i.is(":checked"),n=i.val(),o=i.data("processId");if(r)d.push({projectId:n,processId:o});else for(var l=0;l<d.length;l++){var c=d[l];c.projectId==n&&d.splice(l,1)}a.data("checkedProjects",d);var u=d[0];u?u.processId!=s&&(s=u.processId):s=null,a.data("appliedProcessId",s),this.toggleCustomFields(i,s)},this);s.change(r),s.each(r)},toggleCustomFields:function(e,t){var i=e.closest("form").find(".cf-wrap").addClass("hide").removeClass("show");i.find(".cf-input").addClass("hide").removeClass("show"),i.filter(".cf-process_"+t).addClass("show").removeClass("hide").find(".cf-input").addClass("show").removeClass("hide"),this.fire("adjustPosition")},setHtmlForMessage:function(e,t){var i=e.find(".tau-message-pool");i.children().remove(),i.width("").width(i.width()),i.append(t)},"bus afterRender:last + model.data.item.did.add":function(e,t){var i=t.element.find(".tau-control-set.tau-active .tau-required-field-editor");this.prepareFields.clear(i),window.setTimeout(function(){i.filter(":visible").eq(0).focus()},100)},"bus beforeInit:last + afterRender:last + model.data.item.did.add":function(e,i,a,d){var s=i.config.context.configurator,r=d.message.dataItem,n=r.data.cardData||r.data,o={id:n.id,name:n.name,type:r.type.toLowerCase(),nameType:d.nameType.title};if(d.openAfter)s.getEntityViewService().showEntityView({entityId:o.id,entityType:o.type}),this.fire("close");else{var l;"time"!=o.type&&(l=s.getUrlBuilder().getNewViewUrl(o.id,o.type,!0));var c=s.getTemplateFactory().get("board.cell.quick.add.success").bind({},{type:o.nameType,name:o.name,url:l}),u=d.message.location;
"x"===u||"y"===u||d.skipNotification||this.fire("notification",{$node:c}),c.on("click",".i-role-card-view",function(e){e.preventDefault(),s.getEntityViewService().showEntityView({entityId:o.id,entityType:o.type})})}var f=t('<div class="tau-quick-add-success-message i-role-quick-add-success-message" />');f.data("id",o.id),this.setHtmlForMessage(a.element,f),this.fire("adjustPosition")},"bus afterRender:last+beforeInit:last+model.add.item:last+model.data.item.did.fail.add":function(e,t,i,d,s){var r=this;a.handle(s,d,{setText:function(e){r.setHtmlForMessage(t.element,e),r.fire("adjustPosition")}},i.config.context.configurator)},"bus afterRender:last+view.submit":function(i,a,d){var s=d.type,r=a.element.find(".tau-control-set."+s+" .tau-required-field-editor").filter(":not(.placeholder)").filter(":not(.hide)"),n=r.filter(".cf-input"),o=this.prepareFields;if(o.validate(r)){var l=e.reduce(r,function(e,i){var a=t(i),d=a.data("fieldname"),s=a.data("fieldtype"),r=o.getValue(a);return a.data("iscf")||e.push({id:d,value:r,type:s}),e},[]);if(n.length){var c=e.reduce(n,function(e,i){var a=t(i),d=a.data(),s={name:d.fieldname,type:d.fieldtype,value:o.getCfValue(i)};return s.value&&e.push(s),e},[]);l.push({id:"CustomFields",value:JSON.stringify(c)})}this.fire("model.add.item",{fields:l,type:s,openAfter:d.openAfter}),r.off(".validator")}else r.off(".validator").on("input.validator change.validator",function(){o.validate(r)})},"bus beforeInit:last + view.editors.ready + culture.ready":function(e,t,i,a){this.prepareFields=new d({culture:a,self:this,configurator:t.config.context.configurator}),this.prepareFields.setBehavior(i),this.culture=a},"bus childComponentCreated":function(e,t){this.childBus[t.name]=t},childBus:{},"bus view.editors.ready:last+view.indicator.ready:last+before_model.add.item":function(e,t,i){t.filter(":not(.disabled)").prop("disabled",!0),i.tauProgressIndicator("show"),this.fire("adjustPosition")},afterDataItemAdding:function(e,t){e.filter(":not(.disabled)").prop("disabled",!1),t.data("ui-tauProgressIndicator")&&t.tauProgressIndicator("hide"),this.fire("adjustPosition")
},"bus view.editors.ready:last+view.indicator.ready:last+model.data.item.did.add":function(e,t,i){this.afterDataItemAdding(t,i)},"bus view.editors.ready:last+view.indicator.ready:last+model.data.item.did.fail.add":function(e,t,i){this.afterDataItemAdding(t,i)},"bus afterRender:last+view.select.entity.editor":function(e,i,a){var d=i.element,s=d.find(".tau-control-set.tau-active .tau-required-field-editor").not(".placeholder");d.find(".tau-active").removeClass("tau-active").prop("disabled",!1),d.find(".tau-message-pool").children().remove(),d.find(".i-role-entity-selector.tau-"+a.type.toLowerCase()).addClass("tau-active").prop("disabled",!0);var r=".tau-entity-controls .tau-control-set."+a.type;d.find(r).addClass("tau-active"),window.setTimeout(function(){d.find(".tau-entity-controls .tau-active :text, .tau-entity-controls .tau-active textarea").eq(0).focus().caretToEnd()},0),s.each(function(){var e=t(this),i=e.data();if(!i.iscf){var a=".tau-control-set.tau-active .tau-required-field-editor."+t.escapeSelector(i.fieldname),s=d.find(a),r=e.val();switch(i.fieldtype){case"Text":s.filter(":not(.placeholder)").val(r),r&&s.show().filter(".placeholder").remove();break;case"DDL":s.val()!=r&&(e.hasClass("disabled")||s.find('[value="'+r+'"]').prop("selected",!0).length&&s.change());break;case"TeamMultiSelect":case"ProjectMultiSelect":var n=e.closest(".tau-new-entity-form__row--customizable.tau-customize-flow");n.removeClass("tau-customize-flow");break;default:s.val(r)}}}),this.fire("adjustPosition")},onTypeSelectorClick:function(e){e.preventDefault();var i=t(e.target);if(!i.hasClass("tau-active")){var a=i.data().type;this.fire("view.select.entity.editor",{type:a})}},onSubmit:function(e){return this.fire("view.submit",{type:t(e.target).data().type}),!1},onAddOpen:function(e){return this.fire("view.submit",{type:t(e.target).closest("form").data().type,openAfter:!0}),!1},_processTimeWidget:function(i,a,d,s){var r=function(e){return Math.round(100*e)/100},n=a.filter("[data-fieldname=Spent]"),o=a.filter("[data-fieldname=Remain]");
n.attr("autocomplete","off"),o.attr("autocomplete","off");var l=t(['<div class="tau-field tau-field__time">',"<label><span></span></label>","<label><span></span></label>","</div>"].join(""));l.insertBefore(n.parent()),n.parent().detach(),l.find("label span").eq(0).text(n.attr("placeholder")),n.attr("placeholder",""),n.appendTo(l.find("label").eq(0)),o.parent().detach(),l.find("label span").eq(1).text(o.attr("placeholder")),o.attr("placeholder",""),o.appendTo(l.find("label").eq(1));var c=a.filter("[data-fieldname=Role]"),u=d.types.Time.template,f=e.find(u.items,function(e){return"Remain"==e.id}),p={};e.forEach(f.options.defaultValues,function(e){p[e.key]=e.value});var h=p[c.val()];o.val(e.outFloatLocal(h,s)),c.on("change",e.bind(function(){h=p[c.val()],o.val(e.outFloatLocal(p[c.val()],this.culture)||0),n.trigger("input")},this));var v="oninput"in n[0]?"input":"keyup";n.on(v,e.bind(function(){var t=e.parseFloatLocal(n.val(),this.culture)||0,i=(e.parseFloatLocal(h,this.culture)||0)-t;i=0>i?0:i,o.val(e.outFloatLocal(r(i),this.culture)||0)},this)),o.on(v,function(){h=o.val()}),this.bus.on("model.data.item.did.add",function(){p[c.val()]=o.val(),h=p[c.val()]},this)},"bus relatedQuickAdd.afterShow":function(){this.$element.addClass("bg-overlay")},"bus relatedQuickAdd.afterHide":function(){this.$element.removeClass("bg-overlay")}})});