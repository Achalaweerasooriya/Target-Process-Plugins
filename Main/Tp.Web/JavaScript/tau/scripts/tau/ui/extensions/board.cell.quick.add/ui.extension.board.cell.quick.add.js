define(["Underscore","jQuery","tau/core/extension.base","tau/ui/extensions/board.cell.quick.add/quick.add.error.handler","tau/ui/extensions/board.cell.quick.add/board.cell.quick.add.config.fields","libs/jquery/jquery.placeholder","libs/jquery/jquery.caret"],function(e,t,a,i,r){return a.extend({init:function(t){this._super(t);var a=t.context.configurator,i=e.bind(this.fire,this,"viewerBus.ready");a.getComponentBusRegistry().getByName("entityViewer").done(i),a.getTemplateFactory().register({name:"board.cell.quick.add.success",engine:"jqote2",markup:["<h3>Success!</h3>","<p>","<%! this.type %> ","<% if (this.name && this.url) { %>",'<a class="ui-quick-add-notification-link i-role-card-view tau-entity-name" href="<%= this.url %>"><%! this.name %></a>',"<% } %>"," was added.","</p>"]})},"bus beforeInit:last + dataBind + afterRender":function(a,i,r,d){var n=this.$element=d.element,s=n.find(".tau-required-field-editor,.tau-add-item");n.find("form").on("submit.quickAdd",e.bind(this.onSubmit,this)),n.on("click.quickAdd",".i-role-add-open",e.bind(this.onAddOpen,this)),n.on("click.quickAdd",".i-role-entity-selector",e.bind(this.onTypeSelectorClick,this)),window.setTimeout(function(){n.parent().addClass("tau-bubble__inner_without_scroll"),n.find(".tau-entity-controls .tau-active input, .tau-entity-controls .tau-active select").eq(0).focus()},0);var o=this;n.find("form").each(function(){var e=t(this),a=e.find("[data-fieldname=Spent], [data-fieldname=Remain], [data-fieldname=Role]");3==a.length&&o._processTimeWidget(e,a,r)});var l=s.filter(".project"),u=s.filter(".team"),c=s.filter(".process"),f=c.add(l).add(u);0===f.length&&n.find(".cf-wrap").addClass("show").removeClass("hide");var p=e.bind(function(e,a){a=t(a?a:e.target);var i,r=a.find(":selected").data("option");a.hasClass("process")?i=r.id:a.hasClass("project")?i=r.processId:a.hasClass("team")&&0===a.closest("form").find(".project").length&&(i=r.processId),i&&this.toggleCustomFields(a,i)},this);f.change(p),f.each(p),this.fire("view.indicator.ready",n.tauProgressIndicator()),this.fire("view.editors.ready",s),this.fire("quick.add.popup.rendered",s)},toggleCustomFields:function(e,t){var a=e.closest("form").find(".cf-wrap").addClass("hide").removeClass("show");a.find(".cf-input").addClass("hide").removeClass("show"),a.filter(".cf-process_"+t).addClass("show").removeClass("hide").find(".cf-input").addClass("show").removeClass("hide"),this.fire("adjustPosition")},setHtmlForMessage:function(e,t){var a=e.find(".tau-message-pool");a.children().remove(),a.width("").width(a.width()),a.append(t)},"bus afterRender:last + model.data.item.did.add":function(e,t){var a=t.element.find(".tau-control-set.tau-active .tau-required-field-editor");this.prepareFields.clear(a),a.filter(".tau-in-text").placeholder("refresh"),window.setTimeout(function(){a.filter(":visible").eq(0).focus()},100)},_openView:function(e,t){e.fire("cardDataToShow.ready",{entityId:t.id,entityType:t.type.toLowerCase()}),this.fire("close")},"bus beforeInit:last + viewerBus.ready:last + afterRender:last + model.data.item.did.add":function(a,i,r,d,n){var s=n.message.dataItem.data,o=s.cardData||s;if(n.openAfter)r&&this._openView(r,o);else{var l;"time"!=o.type.toLowerCase()&&(l=i.config.context.configurator.getUrlBuilder().getNewViewUrl(o.id,o.type,!0));var u=i.config.context.configurator.getTemplateFactory().get("board.cell.quick.add.success").bind({},{type:n.nameType.title,name:o.name,url:l});"x"===n.message.location||"y"===n.message.location||n.openAfter||n.skipNotification||this.fire("notification",{$node:u}),r&&u.on("click",".i-role-card-view",e.bind(function(e){e.preventDefault(),this._openView(r,o)},this))}var c=t('<div class="tau-quick-add-success-message i-role-quick-add-success-message" />');c.data(o),this.setHtmlForMessage(d.element,c),this.fire("adjustPosition")},"bus afterRender:last+beforeInit:last+model.add.item:last+model.data.item.did.fail.add":function(e,t,a,r,d){var n=this;i.handle(d,r,{setText:function(e){n.setHtmlForMessage(t.element,e),n.fire("adjustPosition")}},a.config.context.configurator)},"bus afterRender:last+view.submit":function(a,i,r){var d=r.type,n=i.element.find(".tau-control-set."+d+" .tau-required-field-editor").filter(":not(.placeholder)").filter(":not(.hide)"),s=n.filter(".cf-input"),o=this.prepareFields;if(o.validate(n)){var l=e.reduce(n,function(e,a){var i=t(a),r=i.data("fieldname"),d=i.data("fieldtype"),n=o.getValue(i);return i.data("iscf")||e.push({id:r,value:n,type:d}),e},[]);if(s.length){var u=e.reduce(s,function(e,a){var i=t(a),r=i.data(),d={name:r.fieldname,type:r.fieldtype,value:o.getCfValue(a)};return d.value&&e.push(d),e},[]);l.push({id:"CustomFields",value:JSON.stringify(u)})}this.fire("model.add.item",{fields:l,type:d,openAfter:r.openAfter}),n.off(".validator")}else n.off(".validator").on("input.validator change.validator",function(){o.validate(n)})},"bus beforeInit:last + view.editors.ready + culture.ready":function(e,t,a,i){a.filter(".tau-in-text").placeholder(),this.prepareFields=new r({culture:i,self:this,configurator:t.config.context.configurator}),this.prepareFields.setBehavior(a),this.culture=i},"bus childComponentCreated":function(e,t){this.childBus[t.name]=t},childBus:{},"bus view.editors.ready:last+view.indicator.ready:last+before_model.add.item":function(e,t,a){t.filter(":not(.disabled)").prop("disabled",!0),a.tauProgressIndicator("show"),this.fire("adjustPosition")},afterDataItemAdding:function(e,t){e.filter(":not(.disabled)").prop("disabled",!1),t.data("ui-tauProgressIndicator")&&t.tauProgressIndicator("hide"),this.fire("adjustPosition")},"bus view.editors.ready:last+view.indicator.ready:last+model.data.item.did.add":function(e,t,a){this.afterDataItemAdding(t,a)},"bus view.editors.ready:last+view.indicator.ready:last+model.data.item.did.fail.add":function(e,t,a){this.afterDataItemAdding(t,a)},"bus afterRender:last+view.select.entity.editor":function(e,a,i){var r=a.element,d=r.find(".tau-control-set.tau-active .tau-required-field-editor").not(".placeholder");r.find(".tau-active").removeClass("tau-active").prop("disabled",!1),r.find(".tau-message-pool").children().remove(),r.find(".i-role-entity-selector.tau-"+i.type.toLowerCase()).addClass("tau-active").prop("disabled",!0);var n=".tau-entity-controls .tau-control-set."+i.type;r.find(n).addClass("tau-active"),window.setTimeout(function(){r.find(".tau-entity-controls .tau-active :text, .tau-entity-controls .tau-active textarea").eq(0).focus().caretToEnd()},0),d.each(function(){var e=t(this),a=e.data();if(!a.iscf){var i=".tau-control-set.tau-active .tau-required-field-editor."+t.escapeSelector(a.fieldname),d=r.find(i),n=e.val();switch(a.fieldtype){case"Text":d.filter(":not(.placeholder)").val(n),n&&d.show().filter(".placeholder").remove();break;case"DDL":d.val()!=n&&(e.hasClass("disabled")||d.find('[value="'+n+'"]').prop("selected",!0).length&&d.change());break;default:d.val(n)}}}),this.fire("adjustPosition")},onTypeSelectorClick:function(e){e.preventDefault();var a=t(e.target);if(!a.hasClass("tau-active")){var i=a.data().type;this.fire("view.select.entity.editor",{type:i})}},onSubmit:function(e){return this.fire("view.submit",{type:t(e.target).data().type}),!1},onAddOpen:function(e){return this.fire("view.submit",{type:t(e.target).closest("form").data().type,openAfter:!0}),!1},_processTimeWidget:function(a,i,r){var d=function(e){return Math.round(100*e)/100},n=e.bind(function(t){return parseFloat(e.asString(t).replace(this.culture.decimalSeparator,"."))},this),s=e.bind(function(t){return e.asString(t).replace(".",this.culture.decimalSeparator)},this),o=i.filter("[data-fieldname=Spent]"),l=i.filter("[data-fieldname=Remain]");o.attr("autocomplete","off"),l.attr("autocomplete","off");var u=t(['<div class="tau-field tau-field__time">',"<label><span></span></label>","<label><span></span></label>","</div>"].join(""));u.insertBefore(o.parent()),o.parent().detach(),u.find("label span").eq(0).text(o.attr("placeholder")),o.attr("placeholder",""),o.appendTo(u.find("label").eq(0)),l.parent().detach(),u.find("label span").eq(1).text(l.attr("placeholder")),l.attr("placeholder",""),l.appendTo(u.find("label").eq(1));var c=i.filter("[data-fieldname=Role]"),f=r.types.Time.template,p=e.find(f.items,function(e){return"Remain"==e.id}),h={};e.forEach(p.options.defaultValues,function(e){h[e.key]=e.value}),l.val(h[c.val()]);var m=h[c.val()];c.on("change",function(){m=h[c.val()],l.val(s(h[c.val()])||0),o.trigger("input")});var v="oninput"in o[0]?"input":"keyup";o.on(v,function(){var e=n(o.val())||0,t=(n(m)||0)-e;t=0>t?0:t,l.val(s(d(t))||0)}),l.on(v,function(){m=l.val()}),this.bus.on("model.data.item.did.add",function(){h[c.val()]=l.val(),m=h[c.val()]},this)},"bus relatedQuickAdd.afterShow":function(){this.$element.addClass("bg-overlay")},"bus relatedQuickAdd.afterHide":function(){this.$element.removeClass("bg-overlay")}})});