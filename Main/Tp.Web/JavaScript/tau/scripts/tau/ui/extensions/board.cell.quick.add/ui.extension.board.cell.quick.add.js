define(["Underscore","jQuery","tau/core/extension.base","tau/ui/extensions/board.cell.quick.add/quick.add.error.handler","tau/ui/extensions/board.cell.quick.add/board.cell.quick.add.config.fields","libs/jquery/jquery.placeholder","libs/jquery/jquery.caret"],function(e,t,a,i,d){return a.extend({init:function(t){this._super(t);var a=t.context.configurator,i=e.bind(this.fire,this,"viewerBus.ready");a.getComponentBusRegistry().getByName("entityViewer").done(i),a.getTemplateFactory().register({name:"board.cell.quick.add.success",engine:"jqote2",markup:["<h3>Success!</h3>","<p>","<%! this.type %> ","<% if (this.name && this.url) { %>",'<a class="ui-quick-add-notification-link i-role-card-view tau-entity-name" href="<%= this.url %>"><%! this.name %></a>',"<% } %>"," was added.","</p>"]})},"bus beforeInit:last + dataBind + afterRender":function(a,i,d,r){var n=this.$element=r.element,s=n.find(".tau-required-field-editor,.tau-add-item");n.find("form").on("submit.quickAdd",e.bind(this.onSubmit,this)),n.on("click.quickAdd",".i-role-add-open",e.bind(this.onAddOpen,this)),n.on("click.quickAdd",".i-role-entity-selector",e.bind(this.onTypeSelectorClick,this)),window.setTimeout(function(){n.parent().addClass("tau-bubble__inner_without_scroll"),n.find(".tau-entity-controls .tau-active input, .tau-entity-controls .tau-active select").eq(0).focus()},0);var o=this;n.find("form").each(function(){var e=t(this),a=e.find("[data-fieldname=Spent], [data-fieldname=Remain], [data-fieldname=Role]");3==a.length&&o._processTimeWidget(e,a,d)});var l=s.filter(".project"),u=s.filter(".team"),c=s.filter(".process"),f=c.add(l).add(u);0===f.length&&n.find(".cf-wrap").addClass("show").removeClass("hide");var p=e.bind(function(e,a){a=t(a?a:e.target);var i,d=a.find(":selected").data("option");a.hasClass("process")?i=d.id:a.hasClass("project")?i=d.processId:a.hasClass("team")&&0===a.closest("form").find(".project").length&&(i=d.processId),i&&this.toggleCustomFields(a,i)},this);f.change(p),f.each(p),this.fire("view.indicator.ready",n.tauProgressIndicator()),this.fire("view.editors.ready",s),this.fire("quick.add.popup.rendered",s)
},toggleCustomFields:function(e,t){var a=e.closest("form").find(".cf-wrap").addClass("hide").removeClass("show");a.find(".cf-input").addClass("hide").removeClass("show"),a.filter(".cf-process_"+t).addClass("show").removeClass("hide").find(".cf-input").addClass("show").removeClass("hide"),this.fire("adjustPosition")},setHtmlForMessage:function(e,t){var a=e.find(".tau-message-pool");a.children().remove(),a.width("").width(a.width()),a.append(t)},"bus afterRender:last + model.data.item.did.add":function(e,t){var a=t.element.find(".tau-control-set.tau-active .tau-required-field-editor");this.prepareFields.clear(a),a.filter(".tau-in-text").placeholder("refresh"),window.setTimeout(function(){a.filter(":visible").eq(0).focus()},100)},_openView:function(e,t){e.fire("cardDataToShow.ready",{entityId:t.id,entityType:t.type}),this.fire("close")},"bus beforeInit:last + viewerBus.ready:last + afterRender:last + model.data.item.did.add":function(a,i,d,r,n){var s=n.message.dataItem,o=s.data.cardData||s.data,l={id:o.id,name:o.name,type:s.type.toLowerCase(),nameType:n.nameType.title};if(n.openAfter)d&&this._openView(d,l);else{var u;"time"!=l.type&&(u=i.config.context.configurator.getUrlBuilder().getNewViewUrl(l.id,l.type,!0));var c=i.config.context.configurator.getTemplateFactory().get("board.cell.quick.add.success").bind({},{type:l.nameType,name:l.name,url:u});"x"===n.message.location||"y"===n.message.location||n.openAfter||n.skipNotification||this.fire("notification",{$node:c}),d&&c.on("click",".i-role-card-view",e.bind(function(e){e.preventDefault(),this._openView(d,l)},this))}var f=t('<div class="tau-quick-add-success-message i-role-quick-add-success-message" />');f.data("id",l.id),this.setHtmlForMessage(r.element,f),this.fire("adjustPosition")},"bus afterRender:last+beforeInit:last+model.add.item:last+model.data.item.did.fail.add":function(e,t,a,d,r){var n=this;i.handle(r,d,{setText:function(e){n.setHtmlForMessage(t.element,e),n.fire("adjustPosition")}},a.config.context.configurator)
},"bus afterRender:last+view.submit":function(a,i,d){var r=d.type,n=i.element.find(".tau-control-set."+r+" .tau-required-field-editor").filter(":not(.placeholder)").filter(":not(.hide)"),s=n.filter(".cf-input"),o=this.prepareFields;if(o.validate(n)){var l=e.reduce(n,function(e,a){var i=t(a),d=i.data("fieldname"),r=i.data("fieldtype"),n=o.getValue(i);return i.data("iscf")||e.push({id:d,value:n,type:r}),e},[]);if(s.length){var u=e.reduce(s,function(e,a){var i=t(a),d=i.data(),r={name:d.fieldname,type:d.fieldtype,value:o.getCfValue(a)};return r.value&&e.push(r),e},[]);l.push({id:"CustomFields",value:JSON.stringify(u)})}this.fire("model.add.item",{fields:l,type:r,openAfter:d.openAfter}),n.off(".validator")}else n.off(".validator").on("input.validator change.validator",function(){o.validate(n)})},"bus beforeInit:last + view.editors.ready + culture.ready":function(e,t,a,i){a.filter(".tau-in-text").placeholder(),this.prepareFields=new d({culture:i,self:this,configurator:t.config.context.configurator}),this.prepareFields.setBehavior(a),this.culture=i},"bus childComponentCreated":function(e,t){this.childBus[t.name]=t},childBus:{},"bus view.editors.ready:last+view.indicator.ready:last+before_model.add.item":function(e,t,a){t.filter(":not(.disabled)").prop("disabled",!0),a.tauProgressIndicator("show"),this.fire("adjustPosition")},afterDataItemAdding:function(e,t){e.filter(":not(.disabled)").prop("disabled",!1),t.data("ui-tauProgressIndicator")&&t.tauProgressIndicator("hide"),this.fire("adjustPosition")},"bus view.editors.ready:last+view.indicator.ready:last+model.data.item.did.add":function(e,t,a){this.afterDataItemAdding(t,a)},"bus view.editors.ready:last+view.indicator.ready:last+model.data.item.did.fail.add":function(e,t,a){this.afterDataItemAdding(t,a)},"bus afterRender:last+view.select.entity.editor":function(e,a,i){var d=a.element,r=d.find(".tau-control-set.tau-active .tau-required-field-editor").not(".placeholder");d.find(".tau-active").removeClass("tau-active").prop("disabled",!1),d.find(".tau-message-pool").children().remove(),d.find(".i-role-entity-selector.tau-"+i.type.toLowerCase()).addClass("tau-active").prop("disabled",!0);
var n=".tau-entity-controls .tau-control-set."+i.type;d.find(n).addClass("tau-active"),window.setTimeout(function(){d.find(".tau-entity-controls .tau-active :text, .tau-entity-controls .tau-active textarea").eq(0).focus().caretToEnd()},0),r.each(function(){var e=t(this),a=e.data();if(!a.iscf){var i=".tau-control-set.tau-active .tau-required-field-editor."+t.escapeSelector(a.fieldname),r=d.find(i),n=e.val();switch(a.fieldtype){case"Text":r.filter(":not(.placeholder)").val(n),n&&r.show().filter(".placeholder").remove();break;case"DDL":r.val()!=n&&(e.hasClass("disabled")||r.find('[value="'+n+'"]').prop("selected",!0).length&&r.change());break;default:r.val(n)}}}),this.fire("adjustPosition")},onTypeSelectorClick:function(e){e.preventDefault();var a=t(e.target);if(!a.hasClass("tau-active")){var i=a.data().type;this.fire("view.select.entity.editor",{type:i})}},onSubmit:function(e){return this.fire("view.submit",{type:t(e.target).data().type}),!1},onAddOpen:function(e){return this.fire("view.submit",{type:t(e.target).closest("form").data().type,openAfter:!0}),!1},_processTimeWidget:function(a,i,d){var r=function(e){return Math.round(100*e)/100},n=i.filter("[data-fieldname=Spent]"),s=i.filter("[data-fieldname=Remain]");n.attr("autocomplete","off"),s.attr("autocomplete","off");var o=t(['<div class="tau-field tau-field__time">',"<label><span></span></label>","<label><span></span></label>","</div>"].join(""));o.insertBefore(n.parent()),n.parent().detach(),o.find("label span").eq(0).text(n.attr("placeholder")),n.attr("placeholder",""),n.appendTo(o.find("label").eq(0)),s.parent().detach(),o.find("label span").eq(1).text(s.attr("placeholder")),s.attr("placeholder",""),s.appendTo(o.find("label").eq(1));var l=i.filter("[data-fieldname=Role]"),u=d.types.Time.template,c=e.find(u.items,function(e){return"Remain"==e.id}),f={};e.forEach(c.options.defaultValues,function(e){f[e.key]=e.value}),s.val(f[l.val()]);var p=f[l.val()];l.on("change",e.bind(function(){p=f[l.val()],s.val(e.outFloatLocal(f[l.val()],this.culture)||0),n.trigger("input")
},this));var h="oninput"in n[0]?"input":"keyup";n.on(h,e.bind(function(){var t=e.parseFloatLocal(n.val(),this.culture)||0,a=(e.parseFloatLocal(p,this.culture)||0)-t;a=0>a?0:a,s.val(e.outFloatLocal(r(a),this.culture)||0)},this)),s.on(h,function(){p=s.val()}),this.bus.on("model.data.item.did.add",function(){f[l.val()]=s.val(),p=f[l.val()]},this)},"bus relatedQuickAdd.afterShow":function(){this.$element.addClass("bg-overlay")},"bus relatedQuickAdd.afterHide":function(){this.$element.removeClass("bg-overlay")}})});