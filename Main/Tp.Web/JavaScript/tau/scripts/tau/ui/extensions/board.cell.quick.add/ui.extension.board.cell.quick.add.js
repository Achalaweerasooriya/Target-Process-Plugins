define(["Underscore","jQuery","tau/core/extension.base","tau/utils/utils.date","libs/jquery/jquery.placeholder","libs/jquery/jquery.inputMaskEditor","libs/jquery/jquery.caret"],function(_,$,ExtensionBase,dateUtils){return ExtensionBase.extend({init:function(data){this._super.apply(this,arguments),this.onSubmitProxy=_.bind(this.onSubmit,this),this.onTypeSelectorClickProxy=_.bind(this.onTypeSelectorClick,this);var callback=_.bind(function(viewerBus){this.fire("viewerBus.ready",viewerBus)},this);data.context.configurator.getComponentBusRegistry().getByName("board.entityViewer").done(callback),data.context.configurator.getTemplateFactory().register({name:"board.cell.quick.add.success",engine:"jqote2",markup:["<span>","Success! <%! this.type %> ",'<a class="ui-quick-add-notification-link i-role-card-view" href="<%= this.url %>">',"<%! this.name %>","</a> has been added. ",'<a class="ui-quick-add-notification-link i-role-card-view" href="<%= this.url %>">View.</a>',"</span>"]})},"bus afterRender":function(evt,afterRender){var $element=afterRender.element,$editors=$element.find(".tau-required-field-editor,.tau-add-item");$element.find("form").on("submit.quickAdd",this.onSubmitProxy),$element.on("click.quickAdd",".i-role-entity-selector",this.onTypeSelectorClickProxy),$element.find(".i-role-show_more").on("click",function(){$(this).addClass("quick-add__entity-items-more_hide"),$element.find(".i-role-entity-additional").addClass("quick-add__entity-items-additional_show")}),window.setTimeout(function(){$element.parent().addClass("tau-bubble__inner_without_scroll"),$element.find(".tau-entity-controls .tau-active input").eq(0).focus()},0);var project=$editors.filter(".project"),process=$editors.filter(".process").add(project);process.length==0&&$element.find(".cf-wrap").addClass("show").removeClass("hide");var toggleCf=_.bind(function(e,$element){$element?$element=$($element):$element=$(e.target);var data=$element.find(":selected").data("option"),processId=data.processId||data.id,cf=$element.closest("form").find(".cf-wrap").addClass("hide").removeClass("show");cf.find(".cf-input").addClass("hide").removeClass("show"),cf.filter(".cf-process_"+processId).addClass("show").removeClass("hide").find(".cf-input").addClass("show").removeClass("hide"),this.fire("adjustPosition")},this);process.change(toggleCf),process.each(toggleCf),this.fire("view.indicator.ready",$element.tauProgressIndicator()),this.fire("view.editors.ready",$editors),this.fire("quick.add.popup.rendered",$editors)},setHtmlForMessage:function(elementComponent,$html){var $pool=elementComponent.find(".tau-message-pool");$pool.children().remove(),$pool.width("").width($pool.width()),$pool.append($html)},"bus afterRender:last + model.data.item.did.add":function(evt,afterRender){var $inputs=afterRender.element.find(".tau-control-set.tau-active .tau-required-field-editor");this.prepareFields.clear($inputs),$inputs.filter(".tau-in-text").placeholder("refresh"),window.setTimeout(function(){$inputs.filter(":visible").eq(0).focus()},100)},"bus beforeInit:last + viewerBus.ready:last + afterRender:last + model.data.item.did.add":function(ev,initConfig,viewerBus,afterRender,dataCard){var savedEntity=dataCard.message.dataItem.data,url=initConfig.config.context.configurator.getUrlBuilder().getNewViewUrl(savedEntity.id,savedEntity.type,!0),$nodeMessage=initConfig.config.context.configurator.getTemplateFactory().get("board.cell.quick.add.success").bind({},{type:dataCard.nameType.title,name:dataCard.message.dataItem.data.name,url:url});dataCard.message.location!=="x"&&dataCard.message.location!=="y"&&this.fire("notification",{$node:$nodeMessage}),viewerBus&&$nodeMessage.on("click",".i-role-card-view",_.bind(function(e){e.preventDefault(),viewerBus.fire("cardDataToShow.ready",{entityId:savedEntity.id,entityType:savedEntity.type.toLowerCase()}),this.fire("close")},this));var messageSuccess=$('<div class="tau-message tau-success" />');this.setHtmlForMessage(afterRender.element,messageSuccess.append($nodeMessage.clone(!0))),this.fire("adjustPosition")},"bus afterRender:last+model.data.item.did.fail.add":function(evt,afterRender,errorData){var message="Error: "+errorData.Message,$html=$('<div class="tau-message tau-danger">'+message+"</div>");this.setHtmlForMessage(afterRender.element,$html),this.fire("adjustPosition")},"bus afterRender:last+view.submit":function(evt,afterRender,addData){var selectedType=addData.type,$editors=afterRender.element.find(".tau-control-set."+selectedType+" .tau-required-field-editor").filter(":not(.placeholder)").filter(":not(.hide)"),$editorsCustom=$editors.filter(".cf-input"),prepareFields=this.prepareFields;if(prepareFields.validate($editors)){var fields=_.reduce($editors,function(memo,item){var value=$(item).val(),name=$(item).data("fieldname");return $(item).data("iscf")||memo.push({id:name,value:value}),memo},[]);if($editorsCustom.length){var cfData=_.reduce($editorsCustom,function(memo,item){var value={},data=$(item).data(),type=data.fieldtype;value.name=data.fieldname,value.type=type;switch(type){case"DropDown":case"TemplatedURL":case"Number":case"Date":case"Text":value.value=$(item).val();break;case"MultipleSelectionList":value.value=$(item).val()&&$(item).val().join(",")||"";break;case"CheckBox":value.value=$(item).prop("checked");break;case"Entity":value.value={id:data.value.id,kind:data.value.entityType.name,name:data.value.name};break;case"URL":var wrap=$(item).parent(),url=wrap.find(".cf-input-url_value").val(),description=wrap.find(".cf-input-url_description").val();value.value={url:url,label:description};break;default:value=null}return value&&memo.push(value),memo},[]);fields.push({id:"CustomFields",value:JSON.stringify(cfData)})}this.fire("model.add.item",{fields:fields,type:selectedType}),$editors.off(".validator")}else $editors.off(".validator").on("input.validator change.validator",function(){prepareFields.validate($editors)})},prepareFields:{config:{},hasErrors:!1,validate:function(data){var hasError=!1;return _.each(data,function(item){var $element=$(item),validateData=$element.data("validate");_.any(validateData.rules,function(rule){var validateResult=this.typesValidate[rule].validate($element.val()),result=!1;return validateResult.result?this.typesValidate[rule].hideError?this.typesValidate[rule].hideError($element):this.hideError($element):(this.typesValidate[rule].showError?this.typesValidate[rule].showError($element,validateResult.message):this.showError($element,validateResult.message),hasError=!0,result=!0),result},this)},this),this.hasErrors=hasError,!hasError},typesValidate:{required:{validate:function(value){return{result:!_.isEmpty(value),message:"This is a required field."}}},text:{validate:function(value){return{result:_.trim(value)!="",message:"This is a required field."}}},email:{validate:function(value){return{result:/^[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$/gi.test(_.trim(value)),message:"Invalid email address."}}},number:{validate:function(value){value=(value+"").replace(",",".");var result=!0,message;return isNaN(value)?(result=!1,message="the value can only be a valid number, e.g. 1, 3.14 or 2010"):value>_.MAX_INT?(result=!1,message="Please, enter a reasonable number."):value<0&&(result=!1,message="Number must be greater than 0"),{result:result,message:message}}},integer:{validate:function(value){var result=!0,message;return isNaN(value)?(result=!1,message="the value can only be a integer, e.g. 1, 2, 14"):/^\d+$/.test(value)?value>_.MAX_INT?(result=!1,message="Please, enter a reasonable number."):value<=0&&(result=!1,message="Number must be greater than 0"):(result=!1,message="the value can only be a integer, e.g. 1, 2, 14"),{result:result,message:message}}},date:{validate:function(value){var date=dateUtils.parse(value),result=!0,message;return date==null?(message="Incorrect date format",result=!1):date<new Date("01/01/1900")&&(message="Date must be greater then 01-01-1900",result=!1),{result:result,message:message}}},userStorySelector:{validate:function(value){return{result:value!=""}},showError:function($element){$element.closest(".tau-userStorySelector").addClass("tau-error").attr("title","This is a required field.")},hideError:function($element){$element.closest(".tau-userStorySelector").removeClass("tau-error").removeAttr("title")}},checkbox:{validate:function(){return{result:!0}}},url:{validate:function(value){return{result:/\b((?:https?|ftp|file):\/\/(?:[\-A-Z0-9.]+)(?::\d+)?(?:\/[\-A-Z0-9+&@#\/%=~_|!:,.;]*)?(?:\?[A-Z0-9+&@#\/%=~_|!:,.; ]*)?)/i.test(value),message:"Invalid url address."}}}},showError:function($element,message){$element.addClass("tau-error").attr("title",message).nextAll(".placeholder").addClass("tau-error")},hideError:function($element){$element.removeClass("tau-error").removeAttr("title").nextAll(".placeholder").removeClass("tau-error")},setBehavior:function($elements){_.each($elements,function(item){var $element=$(item),type=($element.data("fieldtype")+"").toLowerCase();this.typesBehavior[type]&&this.typesBehavior[type].call(this,$element)},this)},typesBehavior:{date:function($element){$.datepicker.parseDate=function(format,value){return dateUtils.parse(value)},$.datepicker.formatDate=function(format,date){return dateUtils.formatAs(date,format)};var dateFormat=dateUtils.getFormatData().date.short;$element.datepicker({dateFormat:dateFormat})},text:$.noop(),number:function($element){var digitMask="^[0-9]*(["+this.config.culture.decimalSeparator+"][0-9]{0,2})?$";$element.inputMaskEditor({mask:digitMask})},integer:function($element){var digitMask="^[0-9]*?$";$element.inputMaskEditor({mask:digitMask})},userstoryselector:function($element){var clearField=this.typesClear.entity,entityUniqueName=$element.data("entityuniquename"),project=$element.closest("form").find(".project");this.entityBehavior($element),project.change($.proxy(function(e){clearField($element),this.childBus[entityUniqueName].fire("refresh",{filter:{project:$(e.target).val()}})},this.config.self))},releaseselector:function($element){var clearField=this.typesClear.entity,entityUniqueName=$element.data("entityuniquename"),project=$element.closest("form").find(".project");this.entityBehavior($element),project.change($.proxy(function(e){clearField($element),this.childBus[entityUniqueName].fire("refresh",{filter:{project:$(e.target).val()}})},this.config.self))},entity:function($element){this.entityBehavior($element)}},clear:function($elements){_.each($elements,function(item){var $element=$(item),type=($element.data("fieldtype")+"").toLowerCase();this.typesClear[type]?this.typesClear[type].call(this,$element):this.typesClear["default"].call(this,$element)},this)},typesClear:{"default":function($element){$element.val("")},dropdown:function($element){$element.find("option").eq(0).prop("selected",!0)},entity:function($element){$element.val("");var $entitySelector=$element.parent();$entitySelector.find(".tau-linkentity__inner").text($element.attr("placeholder")).addClass("tau-linkentity__inner_placeholder"),$entitySelector.find(".tau-linkentity__icon").hide()},checkbox:function($element){$element.prop("checked",!1)},userstoryselector:$.noop,releaseselector:$.noop,ddl:$.noop,url:$.noop},entityBehavior:function($element){var $entityField=$element.closest(".tau-field"),$entitySelector=$entityField.find(".tau-userStorySelector"),entityUniqueName=$element.data("entityuniquename"),$entitySelectorControl=$entityField.find(".tau-userStorySelector__control"),intervalID=null,self=this.config.self,position={of:$entitySelectorControl,my:"left top",at:"left bottom",collision:"flip flip",offset:"0 2"};$entitySelector.on("click keydown focus",function(e){var keyCode=$.ui.keyCode;if(!$(this).hasClass("focus")&&e.type=="focus"||e.type=="click"||e.type=="keydown"&&(e.keyCode==keyCode.DOWN||e.keyCode==keyCode.UP)){$entitySelector.hide();var userStoryList=$entitySelectorControl.show(),list=userStoryList.find(".tau-finder__result_user-stories");list.outerWidth(userStoryList.outerWidth()),userStoryList.find(".tau-finder__table_quick-add").on("menuentityrefresh",function(){userStoryList.find(".tau-finder__result_user-stories").position().top<0&&userStoryList.is(":visible")&&(position={of:$entitySelectorControl,my:"left bottom",at:"left top",collision:"flip flip",offset:"0 0"}),userStoryList.find(".tau-finder__result_user-stories").position(position)}),userStoryList.find(".tau-finder__result_user-stories").position(position),userStoryList.find("input").focus()}}),$entitySelector.focusout(function(){$(this).removeClass("focus")}),$entitySelectorControl.focusout(function(){clearTimeout(intervalID),intervalID=setTimeout(function(){$entitySelectorControl.hide(),$entitySelector.show()},0)}),$entitySelectorControl.keydown(function(event){event.keyCode==$.ui.keyCode.ESCAPE&&($entitySelectorControl.hide(),$entitySelector.show().addClass("focus").focus(),event.stopImmediatePropagation())}),$entitySelectorControl.focusin(function(){clearTimeout(intervalID)}),self.on(entityUniqueName+".entitySelected",function(evt,data){var entity=data.entity;$element.data("value",data.entity),$element.val(entity.id).change();var $entityTypeIcon=$entitySelector.find(".tau-linkentity__icon"),classes=$entityTypeIcon.attr("class").replace(/ui-type-icon-\S+/ig,"ui-type-icon-"+entity.entityType.name.toLowerCase());$entityTypeIcon.attr("class",classes),$entityTypeIcon.text(entity.id).show(),$entitySelector.find(".tau-linkentity__inner").text(entity.name).removeClass("tau-linkentity__inner_placeholder"),$entitySelectorControl.hide(),$entitySelector.show().addClass("focus").focus()})}},"bus view.editors.ready + culture.ready":function(evt,editors,culture){editors.filter(".tau-in-text").placeholder(),this.prepareFields.config={culture:culture,self:this},this.prepareFields.setBehavior(editors)},"bus childComponentCreated":function(evt,child){this.childBus[child.name]=child},childBus:{},"bus view.editors.ready:last+view.indicator.ready:last+before_model.add.item":function(evt,editorElements,indicator){editorElements.filter(":not(.disabled)").prop("disabled",!0),indicator.tauProgressIndicator("show"),this.fire("adjustPosition")},"bus view.editors.ready:last+view.indicator.ready:last+model.data.item.did.add":function(evt,editorElements,indicator){editorElements.filter(":not(.disabled)").prop("disabled",!1),indicator.tauProgressIndicator("hide"),this.fire("adjustPosition")},"bus view.editors.ready:last+view.indicator.ready:last+model.data.item.did.fail.add":function(evt,editorElements,indicator){editorElements.filter(":not(.disabled)").prop("disabled",!1),indicator.tauProgressIndicator("hide"),this.fire("adjustPosition")},"bus afterRender:last+view.select.entity.editor":function(evt,afterRender,editorData){var $previousFieldEditors=afterRender.element.find(".tau-control-set.tau-active .tau-required-field-editor").not(".placeholder");afterRender.element.find(".tau-active").removeClass("tau-active tau-checked"),afterRender.element.find(".i-role-entity-selector.tau-"+editorData.type.toLowerCase()).addClass("tau-checked").addClass("tau-active");var elementForActivateSelector=".tau-entity-controls .tau-control-set."+editorData.type;afterRender.element.find(elementForActivateSelector).addClass("tau-active"),window.setTimeout(function(){afterRender.element.find(".tau-entity-controls .tau-active input").eq(0).focus().caretToEnd()},0),$previousFieldEditors.each(function(){var data=$(this).data();if(data.iscf)return;var typeName=data.fieldname,editorSelector=".tau-control-set.tau-active .tau-required-field-editor."+typeName,input=afterRender.element.find(editorSelector);switch(data.fieldtype){case"Text":input.filter(":not(.placeholder)").val($(this).val()),$(this).val()&&input.show().filter(".placeholder").remove();break;case"DDL":input.val()!=$(this).val()&&($(this).hasClass("disabled")||input.find('[value="'+$(this).val()+'"]').prop("selected",!0).length&&input.change());break;default:input.val($(this).val())}}),this.fire("adjustPosition")},onTypeSelectorClick:function(evt){evt.preventDefault();if($(evt.target).hasClass("tau-active"))return;var type=$(evt.target).data().type;this.fire("view.select.entity.editor",{type:type})},onSubmit:function(evt){return this.fire("view.submit",{type:$(evt.target).data().type}),!1}})})