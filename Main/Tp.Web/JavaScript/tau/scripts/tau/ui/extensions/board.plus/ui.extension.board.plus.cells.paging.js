define(["Underscore","jQuery","tau/core/event.emitter","tau/ui/behaviour/common/ui.behaviour.progressIndicator","tau/nls/translator"],function(_,$,EventEmitter,ProgressIndicator,T){var PAGE_SIZE_MAP={0:[100,100,100],1:[100,50,25],2:[50,25,25]},GET_PAGE_SIZE=function(amountOfAxes,zoomLevel){var index=0;return zoomLevel>1&&zoomLevel<5?index=1:zoomLevel>=5&&(index=2),PAGE_SIZE_MAP[amountOfAxes][index]},GET_MAX_PAGE_SIZE=function(){return PAGE_SIZE_MAP[0][0]},CellPagingManager=function($cell){var $cellHolder=$cell.parent(),$moreEx=$cellHolder.children(".i-role-cell-paging-more"),alreadyBuiltIn=$moreEx.size()>0;return{isEnabled:function(){return alreadyBuiltIn},disable:function(){alreadyBuiltIn&&$moreEx.css("visibility","hidden"),$cellHolder.find(".i-role-cell-paging-stack").css("visibility","hidden")},enable:function(data){var $more=alreadyBuiltIn?$moreEx:$('<div class="i-role-cell-paging-more tau-cell-paging-more"><div class="i-role-cell-paging-more-link tau-cell-paging-more-link">'+T("show more&hellip;")+"</div></div>");$more.data(data),!alreadyBuiltIn&&$more.appendTo($cellHolder);var $stack=$cellHolder.find(".i-role-cell-paging-stack");if($stack.size()===0){var $moreStack=$('<div class="i-role-tau-always-last i-role-cell-paging-stack tau-cell-paging-stack"><div class="tau-stack-text">'+T("show more&hellip;")+"</div></div>");$moreStack.appendTo($(".i-role-cell",$cellHolder))}else $stack.css("visibility","visible");$more.css("visibility","visible")},remove:function(){alreadyBuiltIn&&$moreEx.remove(),$cellHolder.find(".i-role-cell-paging-stack").remove()}}},isAxisExist=function(r,axisName){var a=r[axisName];return a&&a.types&&a.types.length>0};return EventEmitter.extend({lifeCycleCleanUp:function(e){this.resetSubscriptions()},fireModelGetCellBasicInfo:function(coords){var self=this,args={from:coords.from,to:coords.to};coords.hasOwnProperty("x")&&(args.x=coords.x===null?"null":coords.x),coords.hasOwnProperty("y")&&(args.y=coords.y===null?"null":coords.y),self.fire("model.get.cell.basicInfo",args)},"bus boardSettings.ready":function(e){var self=this,bs=e.data.boardSettings;bs.get({fields:["x","y","zoomLevel","viewMode","collapse"],callback:function(r){var amountOfAxes=0;r.viewMode!=="list"&&(isAxisExist(r,"x")&&++amountOfAxes,isAxisExist(r,"y")&&++amountOfAxes);var zoomLevel=r.zoomLevel,collapse=r.collapse||{x:[],y:[]},size=GET_PAGE_SIZE(amountOfAxes,zoomLevel);self.fire("cell.paging.settings",{amountOfAxes:amountOfAxes,zoomLevel:zoomLevel,pageSize:size,maxPageSize:GET_MAX_PAGE_SIZE(),collapse:collapse,getPageSize:function(coords){var result=this.pageSize;if(-1!==_(this.collapse.x).indexOf(coords.x)||-1!==_(this.collapse.y).indexOf(coords.y))result=this.maxPageSize;return result}})}})},"bus overview.cells.skeletons.ready:last > view.cell.skeleton.updated":function(evt,dataCells,sceleton){this._moveAlwaysVisibleToEnd(sceleton.element)},"bus view.card.batch.move.$successCards":function(evt,data){if(data.length>0)var cell=data[0].parent()},"bus overview.board.ready + cell.paging.settings":function(e,$0,settings){settings.pageSize=GET_MAX_PAGE_SIZE(),this.fire("cell.paging.settings",settings)},"bus overview.cells.skeletons.ready:last+cell.paging.settings:last+cell.paging.byFilter":function(e,overview,paging,pagingFilter){var self=this;self.triggerPagingOnCells(pagingFilter.filter,overview.cells,paging)},triggerPagingOnCells:function(filterDelegate,overviewCells,pagingSettings){var self=this,$gridCells=_(overviewCells).filter(function(c){var $cell=c.element,cd=$cell.data();return cd.hasOwnProperty("x")&&cd.hasOwnProperty("y")&&filterDelegate(cd)});_($gridCells).each(function(c){var $cell=c.element,cd=$cell.data(),newPageSize=pagingSettings.getPageSize({x:cd.x,y:cd.y}),cardsCount=$cell.find(".i-role-card").size(),cellPM=CellPagingManager($cell),hasMore=cellPM.isEnabled();if(hasMore&&cardsCount<newPageSize){var coords={x:cd.x,y:cd.y,from:cardsCount,to:newPageSize};cellPM.disable(),self.fireModelGetCellBasicInfo(coords)}})},"bus cell.paging.settings:last+view.cellSlot.built":function(e,settings,cellCoordinates){var coords=cellCoordinates.data;coords.from=0,coords.to=settings.getPageSize(coords)-1,this.fireModelGetCellBasicInfo(coords)},"bus view.cell.skeleton.built":function(evt){var evtData=evt.data,dataItem=evtData.data,$cell=evtData.element,fixedPlugins=_(dataItem.fixed.items).find(function(item){var itemType=item.type||"";return itemType.toLowerCase()==="cellpaging"}),cellPM=CellPagingManager($cell);fixedPlugins?cellPM.enable(fixedPlugins.data):cellPM.remove()},"bus cell.paging.settings:last + view.skeleton.built":function(evt,settings,skeleton){var self=this,$el=skeleton.element,processPagingInCell=function($cell){self.fire("paging.cell.show.more",{});var cdata=$cell.data(),actualCardsCount=$cell.children(".i-role-card").size();CellPagingManager($cell).disable(),ProgressIndicator.get($cell).show(),$cell.parent().css("opacity",.5),self.fireModelGetCellBasicInfo({x:cdata.x,y:cdata.y,from:actualCardsCount,to:actualCardsCount+(settings.getPageSize(cdata)-1)})},processShowMoreClick=function(e){var $morePanel=$(this).parent(".i-role-cell-paging-more"),$cell=$morePanel.siblings(".i-role-cell");processPagingInCell($cell)},processStackClick=function(e){var $cell=$(this).parent(".i-role-cell");processPagingInCell($cell)};$el.delegate(".i-role-cell-paging-more-link","click",processShowMoreClick),$el.delegate(".i-role-cell-paging-stack","click",processStackClick)},"bus overview.board.ready:last > view.cell.skeleton.built":function(evt,overview,cell){ProgressIndicator.get(cell.element).hide(),cell.element.parent().css("opacity",1),this.fire("view.cell.skeleton.updated",cell)},"bus overview.board.ready:last > view.cell.skeleton.element.beforeUpdate":function(e,$0,update){update.content.css("opacity",.15)},"bus scrollManager.ready:last > overview.board.ready:last > view.cell.skeleton.element.afterUpdate":function(e,scrollManager,overview,update){var $cellContent=update.content;$cellContent.size()>0&&scrollManager.scrollToVisibility($cellContent.last(),{axis:"y",duration:1e3,easing:"easeInSine",offset:{top:20},onAfter:function(){$cellContent.animate({opacity:1},"slow","easeOutBounce")}})},_moveAlwaysVisibleToEnd:function(cell){var stack=$(".i-role-tau-always-last",cell).detach();cell.append(stack)}})})