define(["Underscore","jQuery","tau/core/class","tau/core/extension.base","tau/ui/behaviour/common/ui.behaviour.progressIndicator","tau/nls/translator","tau/ui/templates/board.plus/ui.template.boardplus.show-more","tau/ui/extensions/board.plus/cells.paging.size.config"],function(e,i,t,l,n,a,s,r){var o=function(e,i){var t=0;return i>1&&5>i?t=1:i>=5&&(t=2),r[e][t]},c=function(){return r[0][0]},g=function(e,t){var l=e.clone().attr("id",!1),n=i('<div style="visibility: hidden; display: block; position: absolute;" class="tau-ui-size-'+t+'"/>');l.appendTo(n),i("body").append(n);var a=l.outerHeight(),s=l.outerWidth();return n.remove(),{height:a,width:s}},u=t.extend({init:function(e){this.template=s,this.$cellHolder=e.parent(),this.alreadyBuiltIn=this.getTrack().length>0,this.showPagingTriggerInTrack=!0},getTrack:function(){return this.$cellHolder.children(".i-role-cell-paging-more")},getTrigger:function(){return this.$cellHolder.find(".i-role-cell-paging-stack")},isEnabled:function(){return this.alreadyBuiltIn},disable:function(){this.getTrack().css("visibility","hidden"),this.getTrigger().css("visibility","hidden")},remove:function(){this.getTrack().remove(),this.getTrigger().remove()},enable:function(e){var t=this.$cellHolder,l=this.getTrack();if(0===l.length){var n=this.showPagingTriggerInTrack?'<div class="i-role-cell-paging-more-link tau-cell-paging-more-link">'+a("show more&hellip;")+"</div>":"";l=i(['<div class="i-role-cell-paging-more tau-cell-paging-more">',n,"</div>"].join("")).data(e).appendTo(t)}var s=this.getTrigger();0===s.length&&(s=this.template.get().bind({},{}).appendTo(i(".i-role-cell",t))),s.css("visibility","visible"),l.css("visibility","visible")}}),d=u.extend({init:function(e){this._super(e),this.template=s,this.showPagingTriggerInTrack=!1},setShowMoreTriggerDimensions:function(e){var i=e.closest(".i-role-board-body-holder");if(i.hasClass("i-role-board-body-holder")){var t=i.hasClass("tau-ui-size-min"),l=!t&&i.hasClass("tau-ui-size-xl");if(!t&&!l){var n=i.data("zoomSize"),a=e.parent().find(".i-role-card").last();
a.length&&e.css(g(a,n))}}},enable:function(e){this._super(e),this.setShowMoreTriggerDimensions(this.getTrigger())}}),f=d,h=function(e,i){var t=e[i];return t&&t.types&&t.types.length>0};return l.extend({lifeCycleCleanUp:function(){this.resetSubscriptions()},fireModelGetCellBasicInfo:function(i){var t=e.deepClone(i);e.has(t,"x")&&(t.x=null===t.x?"null":t.x),e.has(t,"y")&&(t.y=null===t.y?"null":t.y),this.fire("model.get.cell.basicInfo",t)},"bus boardSettings.ready":function(i){var t=this,l=i.data.boardSettings;l.get({fields:["x","y","zoomLevel","viewMode","collapse"],callback:function(i){var l=0;"list"!==i.viewMode&&(h(i,"x")&&++l,h(i,"y")&&++l);var n=i.zoomLevel,a=i.collapse||{x:[],y:[]},s=o(l,n);t.fire("cell.paging.settings",{amountOfAxes:l,zoomLevel:n,pageSize:s,maxPageSize:c(),collapse:a,getPageSize:function(i){var t=this.pageSize;return(-1!==e(this.collapse.x).indexOf(i.x)||-1!==e(this.collapse.y).indexOf(i.y))&&(t=this.maxPageSize),t}})}})},"bus overview.cells.skeletons.ready:last > view.cell.skeleton.updated":function(e,i,t){this._moveAlwaysVisibleToEnd(t.element)},"bus view.card.batch.move.$successCards":function(e,i){if(i.length>0){i[0].parent()}},"bus overview.board.ready + cell.paging.settings":function(e,i,t){t.pageSize=c(),this.fire("cell.paging.settings",t)},"bus overview.cells.skeletons.ready:last+cell.paging.settings:last+cell.paging.byFilter":function(e,i,t,l){var n=this;n.triggerPagingOnCells(l.filter,i.cells,t)},triggerPagingOnCells:function(i,t,l){var n=this,a=e(t).filter(function(e){var t=e.element,l=t.data();return l.hasOwnProperty("x")&&l.hasOwnProperty("y")&&i(l)});e(a).each(function(e){var i=e.element,t=i.data(),a=l.getPageSize({x:t.x,y:t.y}),s=i.find(".i-role-card").size(),r=new f(i),o=r.isEnabled();if(o&&a>s){var c={x:t.x,y:t.y,from:s,to:a};r.disable(),n.fireModelGetCellBasicInfo(c)}})},"bus cell.paging.settings:last+view.cellSlot.built":function(e,i,t){var l=t.data;l.from=0,l.to=i.getPageSize(l)-1,this.fireModelGetCellBasicInfo(l)},"bus view.cell.skeleton.built":function(i){var t=i.data,l=t.data,n=t.element,a=e(l.fixed.items).find(function(e){var i=e.type||"";
return"cellpaging"===i.toLowerCase()}),s=new f(n);a?s.enable(a.data):s.remove()},"bus view.skeleton.built:last + cardsFullyLoaded":function(e,t){var l=t.element.find(".i-role-cell");l.each(function(){var e=i(this),t=new f(e);t.setShowMoreTriggerDimensions(t.getTrigger())})},"bus cell.paging.settings:last + view.skeleton.built":function(e,t,l){var a=this,s=l.element,r=function(e){a.fire("paging.cell.show.more",{});var i=e.data(),l=e.children(".i-role-card").size();new f(e).disable(),n.get(e).show(),e.parent().css("opacity",.5),a.fireModelGetCellBasicInfo({x:i.x,y:i.y,from:l,to:l+(t.getPageSize(i)-1)})},o=function(){var e=i(this).parent(".i-role-cell-paging-more").siblings(".i-role-cell");r(e)},c=function(){var e=i(this).parent(".i-role-cell");r(e)};s.delegate(".i-role-cell-paging-more-link","click",o),s.delegate(".i-role-cell-paging-stack","click",c)},"bus overview.board.ready:last > view.cell.skeleton.built":function(e,i,t){n.get(t.element).hide(),t.element.parent().css("opacity",1),this.fire("view.cell.skeleton.updated",t)},"bus overview.board.ready:last > view.cell.skeleton.element.beforeUpdate":function(e,i,t){t.content.css("opacity",.15)},"bus scrollManager.ready:last > overview.board.ready:last > view.cell.skeleton.element.afterUpdate":function(i,t,l,n){var a=n.content;a.size()>0&&e.defer(function(){t.scrollToVisibility(a.last(),{axis:"y",duration:1e3,easing:"easeInSine",offset:{top:20},onAfter:function(){a.animate({opacity:1},"slow","easeOutBounce")}})})},_moveAlwaysVisibleToEnd:function(e){var t=i(".i-role-tau-always-last",e).detach();e.append(t)}})});