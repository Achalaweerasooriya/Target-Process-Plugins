define(["Underscore","jQuery","tau/core/extension.base"],function(t,e,i){return i.extend({"bus beforeInit + view.dom.ready":function(){var t=e('<div style="overflow:scroll;width:30px;">s g s e l e m e n t s f s e </div>');e("body").append(t),this.scrollWidth=t.width()-t[0].clientWidth,t.remove();var i=this;Array.prototype.map?require(["libs/d3/d3"],function(t){i.fire("draw.ready",t)}):i.fire("draw.ready",!1)},"bus $boardGrid.ready":function(e,i){i.unbind("scroll.overview"),i.bind("scroll.overview",t.bind(function(){this.fire("visiblerPosition.update")},this))},"bus $el.ready:last + $boardGrid.ready:last + svg.ready:last + visiblerPosition.update":function(t,e,i){var r={x:i.scrollLeft(),y:i.scrollTop()},o=Math.max(0,Math.min(this.maxVisiblerOrigin.x,r.x/this.verticalProportion)),h=Math.max(0,Math.min(this.maxVisiblerOrigin.y,r.y/this.horizontalProportion));e.find(".tau-boardoverview__visibler").attr("x",o).attr("y",h).data([{x:o,y:h}])},"bus afterRender":function(t,e){this.fire("$el.ready",e.element)},"bus options.ready:last + draw.ready:last + $el.ready:last + $boardEl.ready":function(e,i,r,o,h){if(r){var a={width:i.width,height:i.height,$boardElement:h},n=o.find("[role=holder]");this.drawOverview(n,a).done(t.bind(function(t){this.fire("svg.ready",t)},this))}},drawOverview:function(i,r){var o=e.Deferred(),h=i.find("svg");i.toggleClass("tau-boardoverview__holder_state_redraw",!0);var a=t.defaults(r,{width:e.browser.msie?206:207,height:400}),n=this.draw(i,a)[0];return i.toggleClass("tau-boardoverview__holder_state_redraw",!1),h.remove(),o.resolve(n)},getGridMetrics:function(t){var i=e(t).find("table"),r=i[0],o={w:i.width(),h:i.height()},h={contentSize:{width:o.w,height:o.h},clientSize:{width:Math.min(t.clientWidth,r.clientWidth),height:Math.min(t.clientHeight,r.clientHeight)}};return h},getViewMetrics:function(t,e){var i={w:t.width,h:t.height},r=i.w,o=this.getGridMetrics(e),h=this.verticalProportion=this.horizontalProportion=o.contentSize.width/r,a=Math.ceil(o.contentSize.height/h),n={clientSize:{width:t.width,height:Math.min(t.height,a)},contentSize:{width:Math.ceil(o.contentSize.width/h),height:a},selectorSize:{width:Math.ceil(o.clientSize.width/h),height:Math.ceil(o.clientSize.height/h)}};return{width:r,verticalProportion:h,horizontalProportion:h,overviewMetrics:n}},getFitsViewMetrics:function(e,i){var r=this.getGridMetrics(i);this.horizontalProportion=r.contentSize.width/e.width,this.veticalProportion=r.contentSize.height/e.height;var o={clientSize:t.clone(e),contentSize:t.clone(e),selectorSize:{width:Math.ceil(r.clientSize.width/this.horizontalProportion),height:Math.ceil(r.clientSize.height/this.veticalProportion)}};return{width:e.width,verticalProportion:this.veticalProportion,horizontalProportion:this.horizontalProportion,overviewMetrics:o}},draw:function(i,r){{var o=r.$boardElement,h=o.find(".i-role-grid"),a=h[0],n=h.find("table");n[0]}if(n=n.length?n:h.children().eq(0),!n.length)return!1;r=t.clone(r);var s=this.scrollWidth,d=this.getViewMetrics(r,a),l=d.overviewMetrics.clientSize.height,c=l>=d.overviewMetrics.contentSize.height;0==c?(r.width-=s+(s>0?1:0),d=this.getViewMetrics(r,a),l>d.overviewMetrics.clientSize.height&&(r.width+=s,d=this.getFitsViewMetrics(r,a),s=0)):s=0,l=d.overviewMetrics.clientSize.height;var w=this.getData(o),v=(d.width,d.verticalProportion),f=d.horizontalProportion,g=d.overviewMetrics,u=g.selectorSize;i.parent().width(r.width+s+(e.browser.msie?1:0)),i.width(g.clientSize.width),i.parent().height(l+2);var p=function(e){return t.isNaN(e)?0:e},y=d3.select(i[0]).append("svg").attr("class","tau-boardoverview__chart").attr("width",p(g.clientSize.width)).attr("height",p(g.contentSize.height)),b=0,m=0,z=0,M=this.maxVisiblerOrigin={x:g.contentSize.width-u.width,y:g.contentSize.height-u.height};t.forEach(w.rows,function(e){var i=e.height/v;b=0,t.forEach(e.cells,function(e){var r=e.width/f;y.append("rect").attr("class","tau-boardoverview__cell").attr("width",p(r)).attr("height",p(i)).attr("x",p(b)).attr("y",p(m)),t.forEach(e.cards,function(t){{var e="tau-boardoverview__card-"+t.type.toLowerCase(),i=t.width/f,r=t.height/v;y.append("rect").attr("class","tau-boardoverview__card "+e).attr("width",p(i)).attr("height",p(r)).attr("x",p(t.offsetLeft/f)).attr("y",p(t.offsetTop/v))}}),b+=r}),z+=e.height,m=z/v});var x={x:a.scrollLeft/f,y:a.scrollTop/v},S=y.append("rect").data([{x:x.x,y:x.y}]).attr("class","tau-boardoverview__visibler").attr("width",p(g.selectorSize.width)).attr("height",p(g.selectorSize.height)).attr("x",function(t){return p(t.x)}).attr("y",function(t){return p(t.y)}),P=function(){var t=d3.mouse(y[0][0]),e=Math.max(0,Math.min(M.x,t[0]-u.width/2)),i=Math.max(0,Math.min(M.y,t[1]-u.height/2));S.attr("x",p(e)).attr("y",p(i)).data([{x:e,y:i}]);var r=e*f,o=i*v;a.scrollLeft=r,a.scrollTop=o};y.on("click",P);var _=function(t){var e=Math.max(0,Math.min(M.x,d3.event.x)),i=Math.max(0,Math.min(M.y,d3.event.y));S.attr("x",t.x=p(e)).attr("y",t.y=p(i))},L=function(){var t=S.attr("x"),e=S.attr("y"),i=t*f,r=e*v;a.scrollLeft=i,a.scrollTop=r},N=d3.behavior.drag().origin(Object).on("drag",_).on("dragend",L);return S.call(N),y},getData:function(i){var r=function(e,i){var r=getComputedStyle(e)[i];return t.isNaN(r)?0:parseInt(getComputedStyle(e)[i],10)},o={rows:[],colNum:0,rowNum:0},h=i.find(".i-role-grid"),a=h.find("tr");return a=a.length?a:h.find(".i-role-cellholder"),a.each(function(){var t={height:this.clientHeight||e(this).height(),cells:[]};o.rows.push(t);var i=e(".i-role-cellholder",this);i=i.length?i:e(this),i.each(function(){if(!this.getAttribute("data-is-hidden")){var i=r(this,"width");if("none"!=e(this).css("display")){var o={width:i,cards:[]};t.cells.push(o),e(".i-role-card",this).each(function(){o.cards.push({id:this.id,type:this.getAttribute("data-entity-type").toLowerCase(),offsetLeft:this.offsetLeft+(this.offsetParent?this.offsetParent.offsetLeft:0),offsetTop:this.offsetTop+(this.offsetParent?this.offsetParent.offsetTop:0),width:r(this,"width"),height:r(this,"height")})})}}})}),o.rows.length&&(o.colNum=i.find(".i-role-header[data-dimension=x] .i-role-cellholder:not([data-is-hidden=1])").length,o.rowNum=i.find(".i-role-header[data-dimension=y] .i-role-cellholder:not([data-is-hidden=1])").length),o}})});