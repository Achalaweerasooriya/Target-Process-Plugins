define(["Underscore","jQuery","tau/core/extension.base"],function(_,$,EventEmitter){return EventEmitter.extend({"bus beforeInit + view.dom.ready":function(){var $element=$('<div style="overflow:scroll;width:30px;">s g s e l e m e n t s f s e </div>');$("body").append($element),this.scrollWidth=$element.width()-$element[0].clientWidth,$element.remove();var self=this;Array.prototype.map?require(["libs/d3/d3"],function(draw){self.fire("draw.ready",draw)}):self.fire("draw.ready",!1)},"bus $boardGrid.ready":function(evt,$boardGrid){$boardGrid.unbind("scroll.overview"),$boardGrid.bind("scroll.overview",_.bind(function(){this.fire("visiblerPosition.update")},this))},"bus $el.ready:last + $boardGrid.ready:last + svg.ready:last + visiblerPosition.update":function(evt,$el,$grid){var offset={x:$grid.scrollLeft(),y:$grid.scrollTop()},x=Math.max(0,Math.min(this.maxVisiblerOrigin.x,offset.x/this.verticalProportion)),y=Math.max(0,Math.min(this.maxVisiblerOrigin.y,offset.y/this.horizontalProportion));$el.find(".tau-boardoverview__visibler").attr("x",x).attr("y",y).data([{x:x,y:y}])},"bus afterRender":function(evt,renderData){this.fire("$el.ready",renderData.element)},"bus options.ready:last + draw.ready:last + $el.ready:last + $boardEl.ready":function(evt,options,draw,$el,$boardEl){if(!draw)return;var config={width:options.width,height:options.height,$boardElement:$boardEl},$holder=$el.find("[role=holder]");this.drawOverview($holder,config).done(_.bind(function(svg){this.fire("svg.ready",svg)},this))},drawOverview:function($holder,config){var def=$.Deferred(),currentSVG=$holder.find("svg");$holder.toggleClass("tau-boardoverview__holder_state_redraw",!0);var drawConfig=_.defaults(config,{width:$.browser.msie?206:207,height:400}),svg=this.draw($holder,drawConfig)[0];return $holder.toggleClass("tau-boardoverview__holder_state_redraw",!1),currentSVG.remove(),def.resolve(svg)},getGridMetrics:function(grid){var $table=$(grid).find("table"),table=$table[0],real={w:$table.width(),h:$table.height()},gridMetrics={contentSize:{width:real.w,height:real.h},clientSize:{width:Math.min(grid.clientWidth,table.clientWidth),height:Math.min(grid.clientHeight,table.clientHeight)}};return gridMetrics},getViewMetrics:function(drawConfig,grid){var max={w:drawConfig.width,h:drawConfig.height},width=max.w,gridMetrics=this.getGridMetrics(grid),proportion=this.verticalProportion=this.horizontalProportion=gridMetrics.contentSize.width/width,contentHeight=Math.ceil(gridMetrics.contentSize.height/proportion),overviewMetrics={clientSize:{width:drawConfig.width,height:Math.min(drawConfig.height,contentHeight)},contentSize:{width:Math.ceil(gridMetrics.contentSize.width/proportion),height:contentHeight},selectorSize:{width:Math.ceil(gridMetrics.clientSize.width/proportion),height:Math.ceil(gridMetrics.clientSize.height/proportion)}};return{width:width,verticalProportion:proportion,horizontalProportion:proportion,overviewMetrics:overviewMetrics}},getFitsViewMetrics:function(drawConfig,grid){var gridMetrics=this.getGridMetrics(grid);this.horizontalProportion=gridMetrics.contentSize.width/drawConfig.width,this.veticalProportion=gridMetrics.contentSize.height/drawConfig.height;var overviewMetrics={clientSize:_.clone(drawConfig),contentSize:_.clone(drawConfig),selectorSize:{width:Math.ceil(gridMetrics.clientSize.width/this.horizontalProportion),height:Math.ceil(gridMetrics.clientSize.height/this.veticalProportion)}};return{width:drawConfig.width,verticalProportion:this.veticalProportion,horizontalProportion:this.horizontalProportion,overviewMetrics:overviewMetrics}},draw:function($holder,drawConfig){var $board=drawConfig.$boardElement,$grid=$board.find(".i-role-grid"),grid=$grid[0],$table=$grid.find("table"),table=$table[0];$table=$table.length?$table:$grid.children().eq(0);if(!$table.length)return!1;drawConfig=_.clone(drawConfig);var scrollWidth=this.scrollWidth,metrics=this.getViewMetrics(drawConfig,grid),clientHeight=metrics.overviewMetrics.clientSize.height,overviewIsFitsInTheDesiredSize=clientHeight>=metrics.overviewMetrics.contentSize.height;overviewIsFitsInTheDesiredSize==0?(drawConfig.width-=scrollWidth+(scrollWidth>0?1:0),metrics=this.getViewMetrics(drawConfig,grid),clientHeight>metrics.overviewMetrics.clientSize.height&&(drawConfig.width+=scrollWidth,metrics=this.getFitsViewMetrics(drawConfig,grid),scrollWidth=0)):scrollWidth=0,clientHeight=metrics.overviewMetrics.clientSize.height;var data=this.getData($board),width=metrics.width,verticalProportion=metrics.verticalProportion,horizontalProportion=metrics.horizontalProportion,overviewMetrics=metrics.overviewMetrics,selectorSize=overviewMetrics.selectorSize;$holder.parent().width(drawConfig.width+scrollWidth+($.browser.msie?1:0)),$holder.width(overviewMetrics.clientSize.width),$holder.parent().height(clientHeight+2);var _s=function(val){return _.isNaN(val)?0:val},svg=d3.select($holder[0]).append("svg").attr("class","tau-boardoverview__chart").attr("width",_s(overviewMetrics.clientSize.width)).attr("height",_s(overviewMetrics.contentSize.height)),x=0,y=0,girdY=0,maxVisiblerOrigin=this.maxVisiblerOrigin={x:overviewMetrics.contentSize.width-selectorSize.width,y:overviewMetrics.contentSize.height-selectorSize.height};_.forEach(data.rows,function(row,i){var cellHeight=row.height/verticalProportion;x=0,_.forEach(row.cells,function(cell,j){var cellWidth=cell.width/horizontalProportion;svg.append("rect").attr("class","tau-boardoverview__cell").attr("width",_s(cellWidth)).attr("height",_s(cellHeight)).attr("x",_s(x)).attr("y",_s(y)),_.forEach(cell.cards,function(card,k){var cardClass="tau-boardoverview__card-"+card.type.toLowerCase(),cardWidth=card.width/horizontalProportion,cardHeight=card.height/verticalProportion,cardRect=svg.append("rect").attr("class","tau-boardoverview__card "+cardClass).attr("width",_s(cardWidth)).attr("height",_s(cardHeight)).attr("x",_s(card.offsetLeft/horizontalProportion)).attr("y",_s(card.offsetTop/verticalProportion))}),x+=cellWidth}),girdY+=row.height,y=girdY/verticalProportion});var startCoords={x:grid.scrollLeft/horizontalProportion,y:grid.scrollTop/verticalProportion},visibler=svg.append("rect").data([{x:startCoords.x,y:startCoords.y}]).attr("class","tau-boardoverview__visibler").attr("width",_s(overviewMetrics.selectorSize.width)).attr("height",_s(overviewMetrics.selectorSize.height)).attr("x",function(d){return _s(d.x)}).attr("y",function(d){return _s(d.y)}),click=function(){var p=d3.mouse(svg[0][0]),x=Math.max(0,Math.min(maxVisiblerOrigin.x,p[0]-selectorSize.width/2)),y=Math.max(0,Math.min(maxVisiblerOrigin.y,p[1]-selectorSize.height/2));visibler.attr("x",_s(x)).attr("y",_s(y)).data([{x:x,y:y}]);var gridX=x*horizontalProportion,gridY=y*verticalProportion;grid.scrollLeft=gridX,grid.scrollTop=gridY};svg.on("click",click);var dragmove=function(d){var x=Math.max(0,Math.min(maxVisiblerOrigin.x,d3.event.x)),y=Math.max(0,Math.min(maxVisiblerOrigin.y,d3.event.y));visibler.attr("x",d.x=_s(x)).attr("y",d.y=_s(y))},dragstop=function(){var x=visibler.attr("x"),y=visibler.attr("y"),gridX=x*horizontalProportion,gridY=y*verticalProportion;grid.scrollLeft=gridX,grid.scrollTop=gridY},drag=d3.behavior.drag().origin(Object).on("drag",dragmove).on("dragend",dragstop);return visibler.call(drag),svg},getData:function($board){var _comp=function(el,name){var c=getComputedStyle(el)[name];return _.isNaN(c)?0:parseInt(getComputedStyle(el)[name],10)},data={rows:[],colNum:0,rowNum:0},$grid=$board.find(".i-role-grid"),$trs=$grid.find("tr");return $trs=$trs.length?$trs:$grid.find(".i-role-cellholder"),$trs.each(function(){var trData={height:this.clientHeight||$(this).height(),cells:[]};data.rows.push(trData);var $cells=$(".i-role-cellholder",this);$cells=$cells.length?$cells:$(this),$cells.each(function(){if(this.getAttribute("data-is-hidden"))return;var w=_comp(this,"width");if($(this).css("display")=="none")return;var cellData={width:w,cards:[]};trData.cells.push(cellData),$(".i-role-card",this).each(function(){cellData.cards.push({id:this.id,type:this.getAttribute("data-entity-type").toLowerCase(),offsetLeft:this.offsetLeft+(this.offsetParent?this.offsetParent.offsetLeft:0),offsetTop:this.offsetTop+(this.offsetParent?this.offsetParent.offsetTop:0),width:_comp(this,"width"),height:_comp(this,"height")})})})}),data.rows.length&&(data.colNum=$board.find(".i-role-header[data-dimension=x] .i-role-cellholder:not([data-is-hidden=1])").length,data.rowNum=$board.find(".i-role-header[data-dimension=y] .i-role-cellholder:not([data-is-hidden=1])").length),data}})})