define(["Underscore","jQuery","tau/core/event.emitter","libs/draw/d3/d3.v2"],function(_,$,a,b){return a.extend({"bus afterRender":function(a){var b=a.data.element,c=b.find("[role=holder]");this.isVisible=!1;var d=this;b.delegate("[role=action-switch]","click",function(){var a=$(".i-role-board-body");d.isVisible?(d.clean(c,a),c.hide()):(c.show(),c.detach(),d.draw(c,a),c.appendTo(b)),d.isVisible=!d.isVisible,b.toggleClass("tau-boardoverview_active_true",d.isVisible)})},"bus afterRender:last+output.changed:last":function(a){var b=a.afterRender.data.element;if(this.isVisible==0)return;var c=this,d=b.find("[role=holder]");d.addClass("tau-boardoverview__holder_state_redraw");var e=$(".i-role-board-body");setTimeout(function(){c.clean(d,e),c.draw(d,e),d.removeClass("tau-boardoverview__holder_state_redraw")},10)},clean:function(a,b){a.find("svg").remove(),b.find(".i-role-grid").unbind("scroll.overview")},draw:function(a,b){var c=b.find(".i-role-grid"),d=c[0],e=c.find("table"),f=e[0],g=this.getData(b),h,i;g.colNum>10||g.rowNum>10?i={w:400,h:400}:i={w:200,h:200};var j={w:e.width(),h:e.height()};j.w>j.h?h=i.w:h=i.w*j.w/j.h;var k={gridReal:j.w,gridClient:Math.min(d.clientWidth,f.clientWidth),overReal:h,overClient:null},l=k.gridReal/h;k.overClient=k.gridClient/k.gridReal*k.overReal;var m={gridReal:j.h,gridClient:Math.min(d.clientHeight,f.clientHeight),overReal:null,overClient:null},n=m.gridReal/l;m.overReal=n,m.overClient=m.gridClient/m.gridReal*m.overReal,a.height(n),a.width(h);var o=a[0],p=d3.select(o).append("svg").attr("class","chart").attr("width",h).attr("height",n),q=0,r=0;_.forEach(g.rows,function(a,b){var c=a.height/l;q=0,_.forEach(a.cells,function(a,b){var d=a.width/l,e=p.append("rect").attr("class","cell").attr("width",d).attr("height",c).attr("x",q).attr("y",r);_.forEach(a.cards,function(a,b){var c="card-us",d=a.width/l,e=a.height/l,f=p.append("rect").attr("class","card "+c).attr("width",d).attr("height",e).attr("x",a.offsetLeft/l).attr("y",a.offsetTop/l)}),q+=d}),r+=a.height/l});var s={x:d.scrollLeft/l,y:d.scrollTop/l},t=p.append("rect").data([{x:s.x,y:s.y}]).attr("class","visibler").attr("width",k.overClient).attr("height",m.overClient).attr("x",function(a){return a.x}).attr("y",function(a){return a.y}),u=function(){var a=d3.mouse(p[0][0]),b=Math.max(0,Math.min(h-k.overClient,a[0]-k.overClient/2)),c=Math.max(0,Math.min(n-m.overClient,a[1]-m.overClient/2));t.attr("x",b).attr("y",c).data([{x:b,y:c}]);var e=b*l,f=c*l;d.scrollLeft=e,d.scrollTop=f};p.on("click",u);var v=function(a){var b=Math.max(0,Math.min(h-k.overClient,d3.event.x)),c=Math.max(0,Math.min(n-m.overClient,d3.event.y));t.attr("x",a.x=b).attr("y",a.y=c)},w=function(){var a=t.attr("x"),b=t.attr("y"),c=a*l,e=b*l;d.scrollLeft=c,d.scrollTop=e},x=d3.behavior.drag().origin(Object).on("drag",v).on("dragend",w);t.call(x);var y=function(){var a={x:c.scrollLeft(),y:c.scrollTop()},b=Math.max(0,Math.min(h-k.overClient,a.x/l)),d=Math.max(0,Math.min(n-m.overClient,a.y/l));t.attr("x",b).attr("y",d).data([{x:b,y:d}])};c.bind("scroll.overview",y)},getData:function(a){var b=function(a,b){return parseInt(getComputedStyle(a)[b],10)},c={rows:[],colNum:0,rowNum:0},d=a.find(".i-role-grid");return d.find("tr").each(function(){var a={height:this.clientHeight||$(this).height(),cells:[]};c.rows.push(a),$(".i-role-cellholder",this).each(function(){if(this.getAttribute("data-is-hidden"))return;var c=b(this,"width");if(_.isNaN(c))return;var d={width:c+1,cards:[]};a.cells.push(d),$(".i-role-card",this).each(function(){d.cards.push({id:this.id,offsetLeft:this.offsetLeft,offsetTop:this.offsetTop,width:b(this,"width"),height:b(this,"height")})})})}),c.rows.length&&(c.colNum=a.find(".i-role-header[data-dimension=x] .i-role-cellholder:not([data-is-hidden=1])").length,c.rowNum=a.find(".i-role-header[data-dimension=y] .i-role-cellholder:not([data-is-hidden=1])").length),c}})})