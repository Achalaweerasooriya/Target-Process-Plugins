define(["Underscore","jQuery"],function(a,b){var c=[];return b.widget("ui.tauBubble",{_isInit:!1,$popup:null,$closeEl:null,$arrows:{top:null,bottom:null},$target:null,$alignTo:null,options:{viewport:"body",alignTo:null,collision:"fit flip",onShow:b.noop,showOnCreation:!1,closeOnEscape:!0},_create:function(){this.$target=this.element,this.options.alignTo&&(this.$alignTo=b(this.options.alignTo)),this.$alignTo=this.$alignTo&&this.$alignTo.length?this.$alignTo:this.$target;if(this.options.showOnCreation==1)this.show();else{var a=this.onTargetClickDelegate=b.proxy(this._onTargetClick,this);this.$target.bind("click",a)}},_onTargetClick:function(a){a.preventDefault(),a.stopPropagation(),this.toggle()},_initInstance:function(d){var e=this,f,g=this.$target.parents(".ui-popup-content:first"),h=null;g.length?(f=g,h=f.parent()):(f=b("body"),h=f);var i=b('<div class="tau-bubble popup-container"><div class="tau-bubble__inner" role="content"></div></div>');i.appendTo(h),this.$popup=i,e.$arrows={top:b('<div class="tau-bubble__arrow-top"></div>'),bottom:b('<div class="tau-bubble__arrow-bottom"></div>')},e.$arrows.top.prependTo(i),e.$arrows.bottom.prependTo(i),a(c).include(e)||c.push(e);var j=b.proxy(this.hide,this);i.mouseenter(function(a){i.data("focus",!0)}),i.mouseleave(function(a){i.data("focus",!1)}),f.scroll(function(){j(),e.$target.trigger("externalClose",{})}),this._initInstance=function(){}},show:function(){this._initInstance();var d=this;d.$popup.zIndex(d.$target.zIndex()+1),d.$target.trigger("show.before",{}),d.adjustPosition(),d.options.onShow.call(d,d.$popup);for(var e=0;e<c.length;e++){var f=c[e];f!=d&&(f.$target.trigger("externalClose",{}),f.hide())}d._signUpForCloseEvents(),d._windowResizeDelegate||(d._windowResizeDelegate=a.bind(function(){this.adjustPosition()},this)),b(window).bind("resize",d._windowResizeDelegate),d.$target.trigger("show",{}),d.$popup.trigger("show",{})},hide:function(){var a=this,c=a.$popup;if(!c.is(":visible"))return;c.hide(),a._documentKeyDown&&(b(document).unbind("keydown",a._documentKeyDown),delete a._documentKeyDown),a._documentClickDelegate&&(b(document).unbind("click",a._documentClickDelegate),delete a._documentClickDelegate),a._windowResizeDelegate&&(b(window).unbind("resize",a._windowResizeDelegate),delete a._windowResizeDelegate),a.$target.trigger("close",{})},_onKeyDown:function(a){if(a.keyCode!=b.ui.keyCode.ESCAPE)return;this.$target.trigger("externalClose",{}),this.hide()},_signUpForCloseEvents:function(){var a=this;a.options.closeOnEscape&&!a._documentKeyDown&&(a._documentKeyDown=function(b){a._onKeyDown(b)},b(document).keydown(a._documentKeyDown)),a._documentClickDelegate||(a._documentClickDelegate=function(b){a._onDocumentClick(b)},b(document).click(a._documentClickDelegate))},_processArrows:function(){var a=this,c=a.$alignTo,d=a.$popup;a.$arrows.top.hide(),a.$arrows.bottom.hide();var e=a.$arrows.top,f=c.offset(),g=d.offset();g.top<f.top&&(e=a.$arrows.bottom);if(g.left<f.left){var h=c.width(),i=f.left-g.left-(b.browser.webkit?17:24)+h/2;e.css("left",i+"px")}e.show()},toggle:function(){var a=this;!a.$popup||!a.$popup.is(":visible")?a.show():a.hide()},widget:function(){return this.$popup||b()},adjustPosition:function(){var a=this,b=a.$alignTo,c=a.$popup;c.show();var d="-20 9";b.width()>=20&&(d="0 9");var e={of:b,my:"left top",at:"left bottom",offset:d,collision:a.options.collision};c.position(e);var f=b.position(),g=c.position();g.top<0&&(e.collision="none",c.position(e),g=c.position()),a._processArrows();var h=a.element},_onDocumentClick:function(a){var c=this,d=b(a.target);if(!c.$popup.is(":visible"))return;if(d.hasClass("tau-bubble-target")||d.parents(".tau-bubble-target,.ui-menu-item").length>0)return;if(d.hasClass("tau-bubble")||d.parents("div.tau-bubble").length>0)return;if(c._justActivated){c._justActivated=!1;return}c._trigger("hide"),c.$target.trigger("externalClose",{}),c.hide()},activate:function(){this._justActivated=!0,this.show()},destroy:function(){var d=this,e=d.element;d.$popup&&(d.hide(),d.$popup.remove(),d.$arrows.top.remove(),d.$arrows.bottom.remove()),e.unbind("click",d.onTargetClickDelegate),c=a(c).without(d),b.Widget.prototype.destroy.apply(this,arguments)},empty:function(){var a=this;a.hide(),a.$popup.find(".tau-bubble__inner").empty()}}),b.fn.tauBubble})