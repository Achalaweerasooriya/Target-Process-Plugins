define(["Underscore","jQuery"],function(t,i){i.widget("ui.tagsEditor",{options:{alwaysShowEditor:!1,renderEditorFirst:!1,selector:".ui-tags__tag",onSave:i.noop,onShow:i.noop},_create:function(){this.init()},init:function(){this.$list=i(this.element);var t=this.options.selector;this.$list.find(t).append('<span class="ui-tags__control-delete i-role-actiondelete" title="Delete tag">Delete tag</span>');var e=this;this.$list.delegate(".ui-tags__control-delete","click",function(s){s.preventDefault(),i(this).parents(t).eq(0).remove(),e.options.onSave(e.getTags())}),this.$widget=i('<li class="ui-tags__editor"></li>'),this.options.renderEditorFirst?this.$list.prepend(this.$widget):this.$list.append(this.$widget),this.options.alwaysShowEditor?this.showEditor():(this.$widget.append(i(['<span title="Add tag" class="ui-tags__editor__control-show i-role-control_show">',"<i>Add tag</i>","</span>"].join(""))),this.$widget.find(".i-role-control_show").click(function(t){t.preventDefault(),this.showEditor()}.bind(this)))},_processAddTag:function(t){var i=this.parseTags(t.find(":text").val()),e=this.getTags();e=e.concat(i),this.options.onSave(e)},showEditor:function(){if(!this._editorIsVisible){if(!this.$editor){var e=i(['<form class="ui-tags__editor__inner">','<input type="text" maxlength="50" class="tau-in-text ui-tags__editor__input" />','<span class="tau-inline-group">','<button title="Add" type="submit" class="tau-btn tau-btn-small ui-tags__editor__button-submit">Add</button>',this.options.alwaysShowEditor?"":'<button title="Cancel" type="reset" class="tau-btn tau-btn-small tau-close ui-tags__editor__button-cancel"></button>',"</span>","</form>"].join("")),s=this;e.on("submit",function(t){t.preventDefault(),s._processAddTag(e)}),e.on("reset",function(){s.hideEditor()}),e.find(":text").keydown(t.bind(this.mapKeys,this)),e.appendTo(this.$widget),this.$editor=e}this.resetEditor(),this.$widget.toggleClass("ui-tags__editor-active",!0),this._editorIsVisible=!0,this.focus(),this._trigger("show",this.$editor)
}},focus:function(){this.$editor.find(":text").focus()},hideEditor:function(){this.$editor&&this._editorIsVisible&&(this.$editor.find(":text").blur(),this.$widget.toggleClass("ui-tags__editor-active",!1),this._editorIsVisible=!1,this.resetEditor())},resetEditor:function(){this.$editor&&this.$editor.find(":text").val("")},setValue:function(i){t.isArray(i)&&(i=i.join(", ")),this.$editor&&this.$editor.find(":text").val(i)},getValue:function(){return this.parseTags(this.$editor.find(":text").val())},mapKeys:function(t){27===t.which&&(t.preventDefault(),this.hideEditor(t))},getTagText:function(i){return t.trim(i.find("span:first").text())},getTags:function(){var t=[],e=this;return this.$list.find(this.options.selector).each(function(s,o){var n=i(o);t.push(e.getTagText(n))}),t},parseTags:function(i){var e=(i||"").split(",");return t.chain(e).map(function(i){return t.trim(i)}).uniq().compact().value()}})});