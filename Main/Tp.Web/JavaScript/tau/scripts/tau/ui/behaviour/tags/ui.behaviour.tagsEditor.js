define(["Underscore","jQuery"],function(_,$){$.widget("ui.tagsEditor",{options:{selector:".ui-tags__tag",onSave:$.noop,onShow:$.noop},_create:function(){this.init()},init:function(){this.$list=$(this.element);var selector=this.options.selector,$items=this.$list.find(selector);$items.append('<span class="ui-tags__control-delete i-role-actiondelete" title="Delete tag">Delete tag</span>');var self=this;this.$list.delegate(".ui-tags__control-delete","click",function(e){e.preventDefault(),$(this).parents(selector).eq(0).remove(),self.options.onSave(self.getTags())}),this.$widget=$(['<li class="ui-tags__editor">','<span title="Add tag" class="ui-tags__editor__control-show i-role-control_show">',"<i>Add tag</i>","</span>","</li>"].join(""));var show=_.bind(this.showEditor,this);this.$widget.find(".i-role-control_show").click(function(e){e.preventDefault(),show()}),this.$list.append(this.$widget)},_processAddTag:function($editor){var self=this,newTags=self.parseTags($editor.find(":text").val()),tags=self.getTags();tags=tags.concat(newTags),self.options.onSave(tags)},showEditor:function(e){if(!this._editorIsVisible){if(!this.$editor){var $editor=$(['<form class="ui-tags__editor__inner">','<input type="text" maxlength="50" class="tau-in-text ui-tags__editor__input" />','<span class="tau-inline-group">','<button title="Add"  type="submit"  class="tau-btn tau-btn-small ui-tags__editor__button-submit">Add</button>','<button title="Cancel" type="reset"  class="tau-btn tau-btn-small tau-close ui-tags__editor__button-cancel"></button>',"</span>","</form>"].join("")),self=this;$editor.on("submit",function(e){e.preventDefault(),self._processAddTag($editor)}),$editor.on("reset",function(e){self.hideEditor()}),$editor.find(":text").keydown(_.bind(this.mapKeys,this)),$editor.appendTo(this.$widget),this.$editor=$editor,this.$text=$editor.find(":text")}this.resetEditor(),this.$widget.toggleClass("ui-tags__editor-active",!0),this._editorIsVisible=!0,this.$editor.find(":text").focus(),this._trigger("show",this.$editor)}},hideEditor:function(){this.$editor&&this._editorIsVisible&&(this.$editor.find(":text").blur(),this.$widget.toggleClass("ui-tags__editor-active",!1),this._editorIsVisible=!1,this.resetEditor())},resetEditor:function(){this.$editor&&this.$editor.find(":text").val("")},setValue:function(text){_.isArray(text)&&(text=text.join(", ")),this.$editor&&this.$editor.find(":text").val(text)},getValue:function(text){return this.parseTags(this.$editor.find(":text").val())},mapKeys:function(event){switch(event.which){case 27:event.preventDefault(),this.hideEditor(event)}},getTagText:function($el){return _.trim($el.find("span:first").text())},getTags:function(){var tags=[],scope=this;return this.$list.find(this.options.selector).each(function(k,v){var $el=$(v);tags.push(scope.getTagText($el))}),tags},parseTags:function(string){string=string||"";var tags=string.split(",");return tags=_(tags).map(function(token){return _.trim(token)}),tags=_.uniq(tags),tags=_.compact(tags),tags}})})