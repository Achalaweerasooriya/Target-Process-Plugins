define(["Underscore","jQuery"],function(t,i){i.widget("ui.tagsEditor",{options:{alwaysShowEditor:!1,renderEditorFirst:!1,selector:".ui-tags__tag",onSave:i.noop,onShow:i.noop},_create:function(){this.init()},init:function(){this.$list=i(this.element);var e=this.options.selector,s=this.$list.find(e);s.append('<span class="ui-tags__control-delete i-role-actiondelete" title="Delete tag">Delete tag</span>');var o=this;this.$list.delegate(".ui-tags__control-delete","click",function(t){t.preventDefault(),i(this).parents(e).eq(0).remove(),o.options.onSave(o.getTags())});var n=t.bind(this.showEditor,this);this.$widget=i(['<li class="ui-tags__editor">',"</li>"].join("")),this.options.renderEditorFirst?this.$list.prepend(this.$widget):this.$list.append(this.$widget),this.options.alwaysShowEditor?n():(this.$widget.append(i(['<span title="Add tag" class="ui-tags__editor__control-show i-role-control_show">',"<i>Add tag</i>","</span>"].join(""))),this.$widget.find(".i-role-control_show").click(function(t){t.preventDefault(),n()}))},_processAddTag:function(t){var i=this,e=i.parseTags(t.find(":text").val()),s=i.getTags();s=s.concat(e),i.options.onSave(s)},showEditor:function(){if(!this._editorIsVisible){if(!this.$editor){var e=i(['<form class="ui-tags__editor__inner">','<input type="text" maxlength="50" class="tau-in-text ui-tags__editor__input" />','<span class="tau-inline-group">','<button title="Add"  type="submit"  class="tau-btn tau-btn-small ui-tags__editor__button-submit">Add</button>',this.options.alwaysShowEditor?"":'<button title="Cancel" type="reset"  class="tau-btn tau-btn-small tau-close ui-tags__editor__button-cancel"></button>',"</span>","</form>"].join("")),s=this;e.on("submit",function(t){t.preventDefault(),s._processAddTag(e)}),e.on("reset",function(){s.hideEditor()}),e.find(":text").keydown(t.bind(this.mapKeys,this)),e.appendTo(this.$widget),this.$editor=e,this.$text=e.find(":text")}this.resetEditor(),this.$widget.toggleClass("ui-tags__editor-active",!0),this._editorIsVisible=!0,this.$editor.find(":text").focus(),this._trigger("show",this.$editor)}},focus:function(){this.$editor.find(":text").focus()},hideEditor:function(){this.$editor&&this._editorIsVisible&&(this.$editor.find(":text").blur(),this.$widget.toggleClass("ui-tags__editor-active",!1),this._editorIsVisible=!1,this.resetEditor())},resetEditor:function(){this.$editor&&this.$editor.find(":text").val("")},setValue:function(i){t.isArray(i)&&(i=i.join(", ")),this.$editor&&this.$editor.find(":text").val(i)},getValue:function(){return this.parseTags(this.$editor.find(":text").val())},mapKeys:function(t){switch(t.which){case 27:t.preventDefault(),this.hideEditor(t)}},getTagText:function(i){return t.trim(i.find("span:first").text())},getTags:function(){var t=[],e=this;return this.$list.find(this.options.selector).each(function(s,o){var n=i(o);t.push(e.getTagText(n))}),t},parseTags:function(i){i=i||"";var e=i.split(",");return e=t(e).map(function(i){return t.trim(i)}),e=t.uniq(e),e=t.compact(e)}})});