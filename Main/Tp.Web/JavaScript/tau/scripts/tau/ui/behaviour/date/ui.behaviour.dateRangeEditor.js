define(["Underscore","jQuery","libs/date.js/build/date","tau/utils/utils.date","tau/utils/timeline/utils.timeline.date-range"],function(e,t,n,a,i){t.widget("ui.dateRangeEditor",{options:{onSave:t.noop,onDateRangeUpdated:t.noop,validation:{required:!1},dateFormat:"m/dd/yy",showOnInit:!1,targetStyleName:null,initialDateRange:null,onHide:t.noop,onCancel:t.noop},_create:function(){this.init()},init:function(){var e=this.element.addClass("ui-dateeditor-source");this.options.showOnInit?this.showEditor():e.click(t.proxy(this.showEditor,this))},activate:function(){this._justActivated=!0,this.showEditor(),this.$editor.focus()},_attachKeyBoardHandling:function(){this.handleKeyDown||(this.handleKeyDown=e.bind(this.mapKeys,this),this.options.keyboardManager.pushHandler(this))},_detachKeyboardHandling:function(){this.handleKeyDown&&(this.options.keyboardManager.popHandler(),delete this.handleKeyDown)},_createEditors:function(){var n=this,a=null,o=null,s=this._createEditor(function(t){a&&a.setMinDate(t),o&&(n.options.onDateRangeUpdated(o.getDateRange().setStartDate(t)),e.defer(function(){o.setSelection(o.getDateRange())}))},function(t){o&&e.defer(function(){o.setSelection(i.createWithRoundedDays(t,o.getDateRange().endDate),s)})},this.startDateSelectedDayCalculator);a=this._createEditor(function(t){s.setMaxDate(t),o&&(n.options.onDateRangeUpdated(o.getDateRange().setEndDate(t)),e.defer(function(){o.setSelection(o.getDateRange())}))},function(t){o&&e.defer(function(){o.setSelection(i.createWithRoundedDays(o.getDateRange().startDate,t),a)})},this.endDateSelectedDayCalculator),o={focus:function(){s.focus()},show:function(){e.each(this.$nodes,function(e){e.show()})},hide:function(){e.each(this.$nodes,function(e){e.hide()})},destroy:function(){s.destroy(),a.destroy()},setSelection:function(e,t){if(!t)return s.selection.set(s,e),void a.selection.set(a,e);var n=t===s?s:a;n.selection.set(n,e)},setDateRange:function(e){s.setMaxDate(null),a.setMinDate(null),s.setDate(e.startDate),a.setDate(e.endDate),s.setMaxDate(e.endDate),a.setMinDate(e.startDate),this.setSelection(e)
},getDateRange:function(){return i.createWithRoundedDays(s.getDate(),a.getDate())},appendTo:function(t,n){var i=[s,a,this._createPredefinedDateRangesSelector(),this._createControls()];this.$nodes=i,e.each(i,function(e){e.appendTo(n)})},remove:function(){e.each(this.$nodes,function(e){e.remove()})},_createPredefinedDateRangesSelector:function(){var n="ui-daterangepicker-predefined-range",a=this,o=function(e,t,n,i){e[t]={text:n,go:function(){var e=i();a.setDateRange(e)}}},s={};o(s,"ui-daterangepicker-predefined-lastweek-range","last week",i.createLastWeek),o(s,"ui-daterangepicker-predefined-thirtydays-range","30 days",i.createLastThirtyDays),o(s,"ui-daterangepicker-predefined-threemonths-range","3 months",i.createLastThreeMonths),o(s,"ui-daterangepicker-predefined-year-range","1 year",i.createLastYear);var r=e.map(s,function(e,a){return t('<li> <span class = "'+a+" "+n+'">'+e.text+"</span> </li>")}),d=t('<ul class = "ui-daterangepicker-predefined-ranges"></ul>');return e.each(r,function(e){d.append(e)}),d.on("click","."+n,function(n){var a=t(n.currentTarget).attr("class").split(" "),i=e.find(a,function(t){return e.has(s,t)});null!=i&&s[i].go()}),t("<div></div>").append(t('<div class="ui-daterangepicker-predefined-ranges-title">Select:</div>')).append(d)},_createControls:function(){var e=t('<button class="tau-btn tau-primary i-role-action-submit" role="action-submit" type="button">Show</button>');return e.on("click",function(){taus.track({action:"click show button for global date range editor",tags:["timeline"]}),n._onSave()}),t('<div class="ui-daterangepicker-controls"></div>').append(e)}};var r=this.options.initialDateRange?this.options.initialDateRange:i.createDefault();return o.setDateRange(r),o.appendTo(this.options,this.element),o},showEditor:function(){this._editorIsVisible||(this.$editor||(this.$editor=this._createEditors()),this._attachKeyBoardHandling(),this._editorIsVisible=!0,this.$editor.show())},hideEditor:function(){this._detachKeyboardHandling(),this._editorIsVisible=!1,this.$editor&&this.$editor.hide()
},startDateSelectedDayCalculator:{calculateSelectedDay:function(e,t){return e.getFullYear()<t.getFullYear()?{days:"*"}:e.getFullYear()===t.getFullYear()&&e.getMonth()<t.getMonth()?{days:"*"}:e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()<=t.getDate()?{days:t.getDate().toString()}:{days:null}}},endDateSelectedDayCalculator:{calculateSelectedDay:function(e,t){return e.getFullYear()>t.getFullYear()?{days:"*"}:e.getFullYear()===t.getFullYear()&&e.getMonth()>t.getMonth()?{days:"*"}:e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()>=t.getDate()?{days:t.getDate().toString()}:{days:null}}},_createEditor:function(a,i,o){var s=this.options.dateFormat,r=t('<span class="ui-dateeditor"></span>');r.datepicker({showButtonPanel:!1,dateFormat:s,onSelect:function(){a(t(this).datepicker("getDate"))},onChangeMonthYear:function(e,t,a){i(new n(a.selectedYear,a.selectedMonth,a.selectedDay))}});var d={selectionCss:"ui-daterange-region",set:function(t,n){this.remove(t);var a=this._findDayNodes(t,n),i=this;e.each(a,function(e){e.addClass(i.selectionCss)})},remove:function(n){var a=this;e.each(this._getDayNodes(n),function(e){t(e).removeClass(a.selectionCss)})},_findDayNodes:function(n,a){var i=o.calculateSelectedDay(n.getDate(),a.startDate),s=o.calculateSelectedDay(n.getDate(),a.endDate);if(i.days&&s.days){for(var r=e.toArray(this._getDayNodes(n)),d=this._findDayNode(r,i.days),c=this._findDayNode(r,s.days),l=r.indexOf(d.dayNode),u=r.indexOf(c.dayNode),h=-1===l?0:l,g=-1===u?r.length-1:u,f=[],D=h;g>=D;++D)f.push(r[D]);return e.map(f,function(e){return t(e)})}},_findDayNode:function(n,a){var i=e.find(n,function(e){return t(e).children().eq(0).html()==a});return{dayNode:i}},_getDayNodes:function(e){return e.$editor.find("td").not(".ui-datepicker-other-month").not(".ui-datepicker-unselectable")}};return{$editor:r,selection:d,setMinDate:function(e){this._setThreshold("minDate",e)},setMaxDate:function(e){this._setThreshold("maxDate",e)},setDate:function(e){this.$editor.datepicker("setDate",e),a(e)
},getDate:function(){return this.$editor.datepicker("getDate")},_setThreshold:function(e,t){this.$editor.datepicker("option",e,t)},focus:function(){this.$editor.focus()},show:function(){this.$editor.show()},hide:function(){this.$editor.hide()},destroy:function(){this.$editor.datepicker("destroy")},appendTo:function(e){e.append(this.$editor)},remove:function(){this.$editor.remove()}}},_onSave:function(){this.options.onSave()},_onCancel:function(){this.options.initialDateRange&&this.$editor.setDateRange(this.options.initialDateRange),this.options.onCancel&&this.options.onCancel(this.options.initialDateRange)},isDateRangeChanged:function(){var e=this.options.initialDateRange,t=this.getDateRange();return null===e&&null===t?!1:null===e||null===t?!0:!this.options.initialDateRange.equals(this.getDateRange())},getDateRange:function(){return this.$editor.getDateRange()},destroy:function(){this.hideEditor();var e=this.$editor;e&&(e.destroy(),e.remove())},mapKeys:function(e){switch(e.which){case 13:e.preventDefault(),this._onSave();break;case 27:e.preventDefault(),this._onCancel()}}})});