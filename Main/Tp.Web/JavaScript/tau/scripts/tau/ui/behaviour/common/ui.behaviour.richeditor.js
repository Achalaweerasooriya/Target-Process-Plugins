define(["Underscore","jQuery","tau/configurator"],function(a,b,c){b.widget("ui.richeditor",{staticExecutionGroups:{},$target:null,$editor:null,$input:null,ckeInstance:null,ckeConfig:{enterMode:3,language:"en",toolbar:[],toolbarStartupExpanded:!1,disableNativeSpellChecker:!1,scayt_autoStartup:!1,removePlugins:"elementspath",resize_enabled:!1,height:150,width:"auto",skin:"v3",resize_dir:"vertical",startupFocus:!0,autoGrow_maxHeight:8e3,extraPlugins:"autogrow"},options:{validation:{},executionGroupName:null,hideTarget:!0,scrollToButtonBar:!1,placeholder:{className:null,text:null},settings:{},saveAction:{disableIfEmpty:!1,available:!0,text:"Save"},cancelAction:{available:!0,text:"Cancel"},onSave:function(a){},onCancel:function(){}},_create:function(){this.init()},getTemplate:function(){var a=['<div class="ui-richeditor">','   <textarea class="ui-richeditor__area" style="height:'+this.options.settings.height+'px;"></textarea>','   <div class="ui-richeditor__controls button-group">'],b=this.options.saveAction;b.available&&(a=a.concat(['<button class="ui-richeditor__controls__save button" type="button">',b.text,"</button>"]));var c=this.options.cancelAction;c.available&&(a=a.concat(['<button class="ui-richeditor__controls__cancel button" type="button">',c.text,"</button>"])),a=a.concat(["   </div>","</div>"]);return a.join("")},setText:function(a){this.$target.html(a)},setValidationErrors:function(b){this.element.addClass("ui-validationerror"),a.isString(b)&&this.element.attr("title",b)},resetValidationErrors:function(a){this.element.removeClass("ui-validationerror"),this.element.removeAttr("title")},setValue:function(a){this.setText(a)},init:function(){this.$target=b(this.element),this.$target.addClass("editable");var a={};b.extend(!0,a,this.ckeConfig,this.options.settings),a.autoGrow_minHeight=Math.max(this.$target.height(),a.height),this.options.settings=a,this.bindEventsTarget(this.$target),this._applyPlaceholder(this.$target,this.options.placeholder)},_applyPlaceholder:function(a,c){c.className&&b.trim(a.html())===""&&(a.addClass(c.className),a.text(c.text))},_removePlaceholder:function(a,b){b.className&&a.hasClass(b.className)&&(a.removeClass(b.className),a.text(""))},bindEventsTarget:function(a){var c=function(a,b){return function(a,b){var c=null,d=null;a.bind("mousedown",function(a){a.which!=3&&(c=a.pageX,d=a.pageY)}),a.bind("mouseup",function(a){if(a.which!=3){var e=5;c>a.pageX-e&&c<a.pageX+e&&d>a.pageY-e&&d<a.pageY+e&&b.call(this,a),c=null,d=null}})}.call(this,a,b)},d=b.proxy(this.showEditor,this);c(a,function(a){if(a.target.tagName.toLowerCase()!="a"){var c="";document.selection?c=b.trim(document.selection.createRange().text):window.getSelection&&(c=b.trim(window.getSelection().toString())),c.length==0&&d()}})},_dataChangeEventHandler:function(a){var b=this;if(!!b._visible){var c=b.$editor.find(".ui-richeditor__controls__save");window.setTimeout(function(){var b=a.sender.getData(),d=b.length>0;c.attr("disabled",d?!1:"disabled"),d?c.removeClass("disable"):c.addClass("disable")},150)}},__displayEditor:function(){var a=this;a.options.hideTarget&&a.$target.hide(),a.$editor.show();if(a.options.scrollToButtonBar){var c=a.element.parent().find(".ui-richeditor__controls"),d=b(".ui-entity-view.ui-popup-content");d.size()==0&&(d=b(window)),d.scrollTo(c,{duration:500,axis:"y"})}},getSettings:function(){return this.options.settings},setSettings:function(a){this.options.settings=a},_applyEditor:function(){var a=this;a.$input.parents("body").length?this.ckeInstance?(a.__displayEditor(),this.ckeInstance.setMode("wysiwyg"),this.ckeInstance.setData(this.$input.val())):(a._trigger("beforeapply",this.options.settings),this.initCKEditor(this.$input,this.options.settings,function(c,d){a.__displayEditor(),a.ckeInstance=d;var e=a.options.saveAction;if(e.available&&e.disableIfEmpty){var f=["contentDom","afterCommandExec","key","insertElement","taukeypress"],g=b.proxy(a._dataChangeEventHandler,a);for(var h=0,i=f.length;h<i;h++)d.on(f[h],g)}})):(a.$editor.show(),window.setTimeout(function(){a._applyEditor()},0))},showEditor:function(){if(!this._visible){this._visible=!0,this._removePlaceholder(this.$target,this.options.placeholder),this._initText||(this._initText=this.options.hasOwnProperty("text")?this.options.text:this.$target.html()),this.$editor?this.$editor.hide():(this.$editor=this.createEditor(),this.$editor.hide(),this.$editor.insertAfter(this.$target));var a=this.options.executionGroupName;a&&(this.staticExecutionGroups[a]&&this.staticExecutionGroups[a]._innerCancel(),this.staticExecutionGroups[a]=this),this.$input.val(this._initText),this._applyEditor();return this.$editor}},hideEditor:function(){var a=this.$target,b=this.$input,c=this.$editor;b.blur(),c.hide(),this.options.hideTarget&&a.show();var d=this;d._applyPlaceholder(d.$target,d.options.placeholder),this._visible=!1},initCKEditor:function(a,b,d){var e=c.getCkPath(),f=this;require(["Underscore","order!"+e+"ckeditor.js",,"order!"+e+"ckfinder/ckfinder.js",,"order!"+e+"../Javascript/EditView/ui.comments.js"],function(c){CKEDITOR.tools.indexOf=c.indexOf,CKEDITOR.replace(a.attr("id"),b);var g=CKEDITOR.instances[a.attr("id")];CKFinder.SetupCKEditor(g,e+"ckfinder/");var h=function(){f.$editor.find(".ui-richeditor__controls__save").attr("disabled","disabled").addClass("disable")},i=function(){f.$editor.find(".ui-richeditor__controls__save").removeAttr("disabled").removeClass("disable")};g.on("charcount_limit_reached",h),g.on("charcount_limit_restored",i),d(a,g)})},createEditor:function(){var c=b(this.getTemplate()),d=this.$input=c.find("textarea");d.attr("id",a.uniqueId("ui-richeditor__area")),this.bindEventsEditor(c);return c},bindEventsEditor:function(a){var c=this.options,d=a.find(".ui-richeditor__controls__save"),e=a.find(".ui-richeditor__controls__cancel");c.saveAction.available&&d.click(b.proxy(this._save,this)),c.cancelAction.available&&e.click(b.proxy(this._cancel,this))},_isChangedText:function(a){return a!=this._initText},_save:function(a){a.preventDefault();var b=this.$input;this.ckeInstance&&this.ckeInstance.updateElement();var c=b.val();this._isChangedText(c)?(this._initText=c,this.setText(c),this.options.onSave(c)):this._innerCancel(),this.hideEditor()},_cancel:function(a){a.preventDefault(),this._innerCancel()},_innerCancel:function(){this.hideEditor(),this.options.onCancel()},destroy:function(){var a=this.options.executionGroupName;a&&this.staticExecutionGroups[a]===this&&(this.staticExecutionGroups[a]=null),this.ckeInstance&&(this.ckeInstance.focusManager.forceBlur(),this.ckeInstance.destroy()),this.$editor&&this.$editor.remove()}})})