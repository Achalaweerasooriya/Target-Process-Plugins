define(["Underscore","jQuery","tau/configurator"],function(_,$,a){function b(a){var b=a.editor,c=b.dataProcessor,d=c&&c.htmlFilter;dataFilter=c&&c.dataFilter;var e=["head","base","basefont","meta","link","title","style","script","input","isindex","textarea","button","option","select","frameset","frame","iframe","object","embed","applet","bgsound","marque","blink"],f={elements:{$:function(a){return _.indexOf(e,a.name)>0?!1:(a.attributes["class"]&&delete a.attributes["class"],a.attributes.id&&delete a.attributes.id,a.attributes.role&&delete a.attributes.role,a)},a:function(a){return _.trim(a.attributes.href).match(/^javascript:/gi)&&(delete a.attributes.href,delete a.attributes["data-cke-saved-href"]),a},style:function(a){return!1},script:function(a){return!1}},attributeNames:[[/^on/,"no"]]};d.addRules(f),dataFilter.addRules(f)}$.widget("ui.richeditor",{staticExecutionGroups:{},$target:null,$editor:null,$input:null,ckeInstance:null,ckeConfig:{enterMode:3,language:"en",toolbar:[],toolbarStartupExpanded:!1,disableNativeSpellChecker:!1,scayt_autoStartup:!1,removePlugins:"elementspath",resize_enabled:!1,height:150,width:"auto",skin:"v3",resize_dir:"vertical",startupFocus:!0,autoGrow_maxHeight:8e3,extraPlugins:"autogrow",contentsCss:require.toUrl("../css.ext/tau.clientinput.ckeditor.css"),on:{instanceReady:b}},options:{validation:{},executionGroupName:null,hideTarget:!0,scrollToButtonBar:!1,placeholder:{className:null,text:null},settings:{},saveAction:{checkChanges:!0,disableIfEmpty:!1,available:!0,text:"Save"},cancelAction:{available:!0,text:"Cancel"},onSave:function(a){},onCancel:function(){}},_create:function(){this.init()},getTemplate:function(){var a=['<div class="ui-richeditor">','   <textarea class="ui-richeditor__area" style="height:'+this.options.settings.height+'px;"></textarea>','   <div class="ui-richeditor__controls button-group">'],b=this.options.saveAction;b.available&&(a=a.concat(['<button class="ui-richeditor__controls__save button" type="button">',b.text,"</button>"]));var c=this.options.cancelAction;return c.available&&(a=a.concat(['<button class="ui-richeditor__controls__cancel button" type="button">',c.text,"</button>"])),a=a.concat(["   </div>","</div>"]),a.join("")},setText:function(a){this.$target.html(a)},setValidationErrors:function(a){this.element.addClass("ui-validationerror"),_.isString(a)&&this.element.attr("title",a)},resetValidationErrors:function(a){this.element.removeClass("ui-validationerror"),this.element.removeAttr("title")},setValue:function(a){this.setText(a)},init:function(){this.$target=$(this.element),this.$target.addClass("editable");var a={};$.extend(!0,a,this.ckeConfig,this.options.settings),a.autoGrow_minHeight=Math.max(this.$target.height(),a.height),this.options.settings=a,this.bindEventsTarget(this.$target),this._applyPlaceholder(this.$target,this.options.placeholder)},_applyPlaceholder:function(a,b){b.className&&$.trim(a.html())===""&&(a.addClass(b.className),a.text(b.text))},_removePlaceholder:function(a,b){b.className&&a.hasClass(b.className)&&(a.removeClass(b.className),a.text(""))},bindEventsTarget:function(a){var b=function(a,b){return function(a,b){var c=null,d=null;a.bind("mousedown",function(a){a.which!=3&&(c=a.pageX,d=a.pageY)}),a.bind("mouseup",function(a){if(a.which!=3){var e=5;c>a.pageX-e&&c<a.pageX+e&&d>a.pageY-e&&d<a.pageY+e&&b.call(this,a),c=null,d=null}})}.call(this,a,b)},c=$.proxy(this.showEditor,this),d=function(a,b){a.bind("dblclick",b)},e=function(){if(document.selection&&document.selection.empty)document.selection.empty();else if(window.getSelection){var a=window.getSelection();a.removeAllRanges()}};d(a,function(a){e();if(a.target.tagName.toLowerCase()=="a")return;c()})},_dataChangeEventHandler:function(a){var b=this;if(!b._visible)return;var c=b.$editor.find(".ui-richeditor__controls__save");window.setTimeout(function(){var b=a.sender.getData(),d=b.length>0;c.attr("disabled",d?!1:"disabled"),d?c.removeClass("disable"):c.addClass("disable")},150)},__displayEditor:function(){var a=this;a.options.hideTarget&&a.$target.hide(),a.$editor.show();if(a.options.scrollToButtonBar){var b=a.element.parent().find(".ui-richeditor__controls"),c=$(".ui-popup-content.tau-container");c.size()==0&&(c=$(window)),c.scrollTop(b.offset().top)}},getSettings:function(){return this.options.settings},setSettings:function(a){this.options.settings=a},_applyEditor:function(){var a=this;a.$input.parents("body").length?this.ckeInstance?(a.__displayEditor(),this.ckeInstance.setMode("wysiwyg"),this.ckeInstance.setData(this.$input.val())):(a._trigger("beforeapply",this.options.settings),this.initCKEditor(this.$input,this.options.settings,function(b,c){a.__displayEditor(),a.ckeInstance=c;var d=a.options.saveAction;if(d.available&&d.disableIfEmpty){var e=["contentDom","afterCommandExec","key","insertElement","taukeypress"],f=$.proxy(a._dataChangeEventHandler,a);for(var g=0,h=e.length;g<h;g++)c.on(e[g],f)}})):(a.$editor.show(),window.setTimeout(function(){a._applyEditor()},0))},showEditor:function(){if(!this._visible){this._visible=!0,this._removePlaceholder(this.$target,this.options.placeholder),this._initText||(this._initText=this.options.hasOwnProperty("text")?this.options.text:this.$target.html()),this.$editor?this.$editor.hide():(this.$editor=this.createEditor(),this.$editor.hide(),this.$editor.insertAfter(this.$target));var a=this.options.executionGroupName;return a&&(this.staticExecutionGroups[a]&&this.staticExecutionGroups[a]._innerCancel(),this.staticExecutionGroups[a]=this),this.$input.val(this._initText),this._applyEditor(),this.$editor}},hideEditor:function(){var a=this.$target,b=this.$input,c=this.$editor;b.blur(),c.hide(),this.options.hideTarget&&a.show();var d=this;d._applyPlaceholder(d.$target,d.options.placeholder),this._visible=!1},initCKEditor:function(b,c,d){var e=a.getCkPath(),f=this;require(["Underscore","order!"+e+"ckeditor.js",,"order!"+e+"ckfinder/ckfinder.js",,"order!"+e+"../Javascript/EditView/ckeditor.plugins.js"],function(_){CKEDITOR.tools.indexOf=_.indexOf,CKEDITOR.editor.prototype.resize=function(a,b,c,d){var e=this.container,f=CKEDITOR.document.getById("cke_contents_"+this.name),g=d?e.getChild(1):e;g.setSize("width",a,!0),!CKEDITOR.env.webkit;var h=c?0:(g.$.offsetHeight||0)-(f.$.clientHeight||0);f.setStyle("height",Math.max(b-h,0)+"px"),this.fire("resize")},CKEDITOR.replace(b.attr("id"),c);var a=CKEDITOR.instances[b.attr("id")];CKFinder.SetupCKEditor(a,e+"ckfinder/");var g=function(){f.$editor.find(".ui-richeditor__controls__save").attr("disabled","disabled").addClass("disable")},h=function(){f.$editor.find(".ui-richeditor__controls__save").removeAttr("disabled").removeClass("disable")};a.on("charcount_limit_reached",g),a.on("charcount_limit_restored",h),d(b,a)})},createEditor:function(){var a=$(this.getTemplate()),b=this.$input=a.find("textarea");return b.attr("id",_.uniqueId("ui-richeditor__area")),this.bindEventsEditor(a),a},bindEventsEditor:function(a){var b=this.options,c=a.find(".ui-richeditor__controls__save"),d=a.find(".ui-richeditor__controls__cancel");b.saveAction.available&&c.click($.proxy(this._save,this)),b.cancelAction.available&&d.click($.proxy(this._cancel,this))},_isChangedText:function(a){return a!=this._initText},_allowSave:function(a){var b=!0,c=this.options.saveAction.checkChanges;return c&&!this._isChangedText(a)&&(b=!1),b},_save:function(a){a.preventDefault();var b=this.$input;this.ckeInstance&&this.ckeInstance.updateElement();var c=b.val();this._allowSave(c)?(this._initText=c,this.setText(c),this.options.onSave(c)):this._innerCancel(),this.hideEditor()},_cancel:function(a){a.preventDefault(),this._innerCancel()},_innerCancel:function(){this.hideEditor(),this.options.onCancel()},destroy:function(){var a=this.options.executionGroupName;a&&this.staticExecutionGroups[a]===this&&(this.staticExecutionGroups[a]=null),this.ckeInstance&&(this.ckeInstance.focusManager.forceBlur(),this.ckeInstance.destroy()),this.$editor&&this.$editor.remove()}})})