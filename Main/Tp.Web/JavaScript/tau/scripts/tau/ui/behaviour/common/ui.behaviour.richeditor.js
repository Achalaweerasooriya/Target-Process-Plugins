define(["Underscore","jQuery","tau/configurator"],function(_,$,configurator){function configureHtmlOutput(ev){var editor=ev.editor,dataProcessor=editor.dataProcessor,htmlFilter=dataProcessor&&dataProcessor.htmlFilter;dataFilter=dataProcessor&&dataProcessor.dataFilter;var excludeElements=["head","base","basefont","meta","link","title","style","script","input","isindex","textarea","button","option","select","frameset","frame","iframe","object","embed","applet","bgsound","marque","blink"],rules={elements:{$:function(element){return _.indexOf(excludeElements,element.name)>0?!1:(element.attributes["class"]&&delete element.attributes["class"],element.attributes.id&&delete element.attributes.id,element.attributes.role&&delete element.attributes.role,element)},a:function(element){return _.trim(element.attributes.href).match(/^javascript:/gi)&&(delete element.attributes.href,delete element.attributes["data-cke-saved-href"]),element},style:function(element){return!1},script:function(element){return!1}},attributeNames:[[/^on/,"no"]]};htmlFilter.addRules(rules),dataFilter.addRules(rules)}$.widget("ui.richeditor",{staticExecutionGroups:{},$target:null,$editor:null,$input:null,ckeInstance:null,ckeConfig:{enterMode:3,language:"en",toolbar:[],toolbarStartupExpanded:!1,disableNativeSpellChecker:!1,scayt_autoStartup:!1,removePlugins:"elementspath",resize_enabled:!1,height:150,width:"auto",skin:"v3",resize_dir:"vertical",startupFocus:!0,autoGrow_maxHeight:8e3,extraPlugins:"autogrow",contentsCss:require.toUrl("../css.ext/tau.clientinput.ckeditor.css"),on:{instanceReady:configureHtmlOutput}},options:{validation:{},executionGroupName:null,hideTarget:!0,scrollToButtonBar:!1,placeholder:{className:null,text:null},settings:{},saveAction:{checkChanges:!0,disableIfEmpty:!1,available:!0,text:"Done"},cancelAction:{available:!1,text:"Cancel"},onCreateEditor:function(text){},onStartEdit:function(text){},onStopEdit:function(text){},onSave:function(text){},onBeforeSaveWithClose:function(text){},onSaveWithClose:function(text){},onCancel:function(){}},_create:function(){this.init()},getTemplate:function(){var arr=['<div class="ui-richeditor">','   <textarea class="ui-richeditor__area" style="height:'+this.options.settings.height+'px;"></textarea>','   <div class="ui-richeditor__controls button-group">'],saveOptions=this.options.saveAction;saveOptions.available&&(arr=arr.concat(['<button class="ui-richeditor__controls__save button" type="button">',saveOptions.text,"</button>"]));var cancelOptions=this.options.cancelAction;return cancelOptions.available&&(arr=arr.concat(['<button class="ui-richeditor__controls__cancel button" type="button">',cancelOptions.text,"</button>"])),arr=arr.concat(['       <div class="ui-richeditor__controls__status_message"></div>',"   </div>","</div>"]),arr.join("")},setText:function(text){this.$target.html(text)},setValidationErrors:function(data){this.element.addClass("ui-validationerror"),_.isString(data)&&this.element.attr("title",data)},resetValidationErrors:function(data){this.element.removeClass("ui-validationerror"),this.element.removeAttr("title")},setValue:function(value){this.setText(value)},init:function(){this.$target=$(this.element),this.$target.addClass("editable");var mergedSettings={};$.extend(!0,mergedSettings,this.ckeConfig,this.options.settings),mergedSettings.autoGrow_minHeight=Math.max(this.$target.height(),mergedSettings.height),this.options.settings=mergedSettings,this.options.settings.maxHeight&&(this.options.settings.autoGrow_maxHeight=this.options.settings.maxHeight),this.bindEventsTarget(this.$target),this._applyPlaceholder(this.$target,this.options.placeholder)},_applyPlaceholder:function($el,config){config.className&&$.trim($el.html())===""&&($el.addClass(config.className),$el.text(config.text))},_removePlaceholder:function($el,config){config.className&&$el.hasClass(config.className)&&($el.removeClass(config.className),$el.text(""))},bindEventsTarget:function($el){var shortClick=function($el,handler){return function($el,handler){var prevPageX=null,prevPageY=null;$el.bind("mousedown",function(e){e.which!=3&&(prevPageX=e.pageX,prevPageY=e.pageY)}),$el.bind("mouseup",function(e){if(e.which!=3){var delta=5;prevPageX>e.pageX-delta&&prevPageX<e.pageX+delta&&prevPageY>e.pageY-delta&&prevPageY<e.pageY+delta&&handler.call(this,e),prevPageX=null,prevPageY=null}})}.call(this,$el,handler)},cb=$.proxy(this.showEditor,this),bindEvent=function($el,cb){$el.bind("dblclick",cb)},clearSelection=function(){if(document.selection&&document.selection.empty)document.selection.empty();else if(window.getSelection){var sel=window.getSelection();sel.removeAllRanges()}};bindEvent($el,function(e){clearSelection();if(e.target.tagName.toLowerCase()=="a")return;cb()})},_dataChangeEventHandler:function(evt){var self=this;if(!self._visible)return;var $saveBtn=self.$editor.find(".ui-richeditor__controls__save");window.setTimeout(function(){var data=evt.sender.getData(),isEnabled=data.length>0;$saveBtn.attr("disabled",isEnabled?!1:"disabled"),isEnabled?$saveBtn.removeClass("disable"):$saveBtn.addClass("disable")},150)},__displayEditor:function(){var self=this;self.options.hideTarget&&self.$target.hide(),self.$editor.show();if(self.options.scrollToButtonBar){var $target=self.element.parent().find(".ui-richeditor__controls"),$scrollable=$(".ui-popup-content.tau-container");$scrollable.size()==0&&($scrollable=$(window)),$scrollable.scrollTop($target.offset().top)}},getSettings:function(){return this.options.settings},setSettings:function(settings){this.options.settings=settings},_applyEditor:function(){var self=this;self.$input.parents("body").length?this.ckeInstance?(self.__displayEditor(),this.ckeInstance.setMode("wysiwyg"),this.ckeInstance.setData(this.$input.val())):(self._trigger("beforeapply",this.options.settings),this.initCKEditor(this.$input,this.options.settings,function($input,instance){self.__displayEditor(),self.ckeInstance=instance,self.options.onCreateEditor({api:self});var saveActionSettings=self.options.saveAction;if(saveActionSettings.available&&saveActionSettings.disableIfEmpty){var dataChangeEvents=["contentDom","afterCommandExec","key","insertElement","taukeypress"],handler=$.proxy(self._dataChangeEventHandler,self);for(var i=0,len=dataChangeEvents.length;i<len;i++)instance.on(dataChangeEvents[i],handler)}})):(self.$editor.show(),window.setTimeout(function(){self._applyEditor()},0))},showEditor:function(){var self=this;if(!self._visible){self._visible=!0,self._removePlaceholder(self.$target,self.options.placeholder),self._initText||(self._initText=self.options.hasOwnProperty("text")?self.options.text:self.$target.html()),self.$editor?self.$editor.hide():(self.$editor=self.createEditor(),self.$editor.hide(),self.$editor.insertAfter(self.$target));var groupName=self.options.executionGroupName;return groupName&&(self.staticExecutionGroups[groupName]&&self.staticExecutionGroups[groupName]._innerCancel(),self.staticExecutionGroups[groupName]=self),self.$input.val(self._initText),self._applyEditor(),self.options.onStartEdit({editor:self.$editor,element:self.$input,ckeInstance:self.ckeInstance,initialText:self._initText}),self.$editor}},hideEditor:function(){var $target=this.$target,$input=this.$input,$editor=this.$editor;$input.blur(),$editor.hide(),this.options.hideTarget&&$target.show();var self=this;self._applyPlaceholder(self.$target,self.options.placeholder),this._visible=!1,self.options.onStopEdit({element:self.$input,editor:self.$editor,text:self._initText})},initCKEditor:function($input,config,cb){var ckPath=configurator.getCkPath(),self=this,ckEditor=ckPath+"/ckeditor.js",ckFinder=ckPath+"/ckfinder/ckfinder.js",ckPlugins=ckPath+"/../Javascript/EditView/ckeditor.plugins.js";self.element.addClass("ui-overlay-container");var onLoadCkEditor=function(_){CKEDITOR.tools.indexOf=_.indexOf,CKEDITOR.editor.prototype.resize=function(width,height,isContentHeight,resizeInner){var container=this.container,contents=CKEDITOR.document.getById("cke_contents_"+this.name),outer=resizeInner?container.getChild(1):container;outer.setSize("width",width,!0),!CKEDITOR.env.webkit;var delta=isContentHeight?0:(outer.$.offsetHeight||0)-(contents.$.clientHeight||0);contents.setStyle("height",Math.max(height-delta,0)+"px"),this.fire("resize")},CKEDITOR.replace($input.attr("id"),config);var instance=CKEDITOR.instances[$input.attr("id")];CKFinder.SetupCKEditor(instance,ckPath+"/ckfinder/");var disableSave=function(){self.$editor.find(".ui-richeditor__controls__save").attr("disabled","disabled").addClass("disable")},enableSave=function(){self.$editor.find(".ui-richeditor__controls__save").removeAttr("disabled").removeClass("disable")};instance.on("charcount_limit_reached",disableSave),instance.on("charcount_limit_restored",enableSave),cb($input,instance),self.element.removeClass("ui-overlay-container")};require([ckEditor],function(){require([ckFinder],function(){require(["Underscore",ckPlugins],onLoadCkEditor)})})},createEditor:function(){var $editor=$(this.getTemplate()),$input=this.$input=$editor.find("textarea");return $input.attr("id",_.uniqueId("ui-richeditor__area")),this.bindEventsEditor($editor),$editor},bindEventsEditor:function($editor){var opts=this.options,$save=$editor.find(".ui-richeditor__controls__save"),$cancel=$editor.find(".ui-richeditor__controls__cancel");opts.saveAction.available&&$save.click($.proxy(this._save,this)),opts.cancelAction.available&&$cancel.click($.proxy(this._cancel,this))},_isChangedText:function(text){return text!=this._initText},_allowSave:function(text){var result=!0,shouldCheckChanges=this.options.saveAction.checkChanges;return shouldCheckChanges&&!this._isChangedText(text)&&(result=!1),result},_getValueSanitized:function(){var $input=this.$input;return this.ckeInstance&&this.ckeInstance.updateElement(),$input.val()},performSave:function(callBeforeSaveWithClose){var sanitized=this._getValueSanitized();return this._allowSave(sanitized)?(this._initText=sanitized,this.setText(sanitized),callBeforeSaveWithClose&&this.options.onBeforeSaveWithClose(sanitized),this.options.onSave(sanitized),sanitized):null},_save:function(evt){evt.preventDefault();var sanitized=this.performSave(!0);sanitized!==null?(this.options.onSaveWithClose(sanitized),this.hideEditor()):this._innerCancel()},_cancel:function(evt){evt.preventDefault(),this._innerCancel()},_innerCancel:function(){this.hideEditor(),this.options.onCancel()},destroy:function(){var groupName=this.options.executionGroupName;groupName&&this.staticExecutionGroups[groupName]===this&&(this.staticExecutionGroups[groupName]=null),this.ckeInstance&&(this.ckeInstance.focusManager.forceBlur(),this.ckeInstance.destroy()),this.$editor&&this.$editor.remove()}})})