define(["require","tau/utils/utils.uploadFiles","template!./uploader.markdown.plugin.template","libs/jquery/jquery.fileupload","vendors/jquery-textrange/jquery-textrange"],function(e){var r=e("tau/utils/utils.uploadFiles"),a=e("template!./uploader.markdown.plugin.template");e("libs/jquery/jquery.fileupload"),e("vendors/jquery-textrange/jquery-textrange");var t=function(e){return/image\/.*/.test(e)},i=function(e,r,a){var t=e.val(),i=e.textrange("get").position,n=t.indexOf(r);e.val(t.replace(r,a)),i>n&&(i=a.length-r.length+i),e.textrange("setcursor",i)};return function(e){return{init:function(n){var l=n.find(".i-role-textarea"),o=a.render(),u=o.find(".i-role-block-info"),d=o.find(".i-role-block-info-loading"),s=o.find(".i-role-block-info-default"),f=o.find(".i-role-error-message"),p=o.find(".i-role-block-info-error");n.find(".i-role-write").addClass("i-role-uploader-area"),l.after(o);var g=n.find(".i-role-fileuploader"),c=s.find(".i-role-file-wrapper"),m=p.find(".i-role-file-wrapper"),v=function(e,a){u.addClass("tau-hide"),d.removeClass("tau-hide");var n="screenshot";a.files&&(n=a.files[0].name||n);var o="\n[ Uploading "+n+"...]()",v=o.length,x=l.textrange("get").position;l.textrange("replace",o),l.textrange("setcursor",x+v),r.upload(a).then(function(e){var r=e.name||"screenshot",a="["+r+"]("+e.uri+")";t(e.mimeType)&&(a="!"+a),i(l,o,"\n"+a),l.trigger("input"),s.removeClass("tau-hide"),c.prepend(g)},function(e){i(l,o,""),p.removeClass("tau-hide"),m.prepend(g),f.text(e)}).always(function(){d.addClass("tau-hide")})};g.fileupload({url:e.uploadUrl,formData:e.formData,add:v,dropZone:n,pasteZone:n})}}}});