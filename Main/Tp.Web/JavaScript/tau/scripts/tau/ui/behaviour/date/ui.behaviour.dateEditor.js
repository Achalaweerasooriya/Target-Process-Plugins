define(["Underscore","jQuery","tau/core/tau"],function(_,$,tauUtils){$.widget("ui.dateEditor",{options:{widgetName:"datepicker",onSave:function(){},validation:{required:!1},dateFormat:"m/dd/yy"},errors:[],_create:function(){this.init()},init:function(){var $element=$(this.element);this.$element=$element,$element.click($.proxy(this.showEditor,this)),$element.addClass("ui-dateeditor-source")},setValidationErrors:function(data){this.element.addClass("ui-validationerror"),_.isString(data)&&this.element.attr("title",data)},resetValidationErrors:function(data){this.element.removeClass("ui-validationerror"),this.element.removeAttr("title",data)},activate:function(){this._justActivated=!0,this.showEditor(),this.$editor.find(":text").focus()},_attachKeyBoardHandling:function(){var self=this,keyBoardHandler={handleKeyDown:function(){self.mapKeys.apply(self,arguments)}};this.options.keyboardManager.pushHandler(keyBoardHandler)},showEditor:function(e){var self=this;if(!this._editorIsVisible){if(!this.$editor){var $editor=$(tauUtils.concat('<span class="ui-dateeditor">','    <input type="text" maxlength="20" />',"</span>")),$input=$editor.find(":text");$input.focus();var $body=$("body"),bodyClickHandler=function(evt){self._onDocumentClick.apply(self,arguments),$body.unbind("click",bodyClickHandler)},attachBodyClickFunction=function(){$body.click(bodyClickHandler)};$input[this.options.widgetName]({showButtonPanel:!1,dateFormat:this.options.dateFormat,buttonText:"choose",showOn:"button",beforeShow:attachBodyClickFunction,onSelect:function(date){$input.focus()}}),$editor.insertAfter(this.$element),this.$editor=$editor}this._attachKeyBoardHandling(),self._documentClickDelegate||(self._documentClickDelegate=function(ev){self._onDocumentClick(ev)},$(document.body).click(self._documentClickDelegate)),this.$element.hide(),this._editorIsVisible=!0,this.$editor.show(),this.$editor.find(":text").val(this.$element.text())}},trimString:function(value){return _.trim(value||"")},_getDefaultValue:function(){return this.options.date||this.element.text()},_onSave:function(){var value=this.$editor.find(":text").val(),changedValue={value:value};(this.options.beforeChange||function(){})(changedValue),value=changedValue.value,this.hideEditor(),this.$element.show();var defaultValue=this._getDefaultValue();this.trimString(defaultValue)!=this.trimString(value)&&this.options.onSave(value),this.$element.text(value),this.options.keyboardManager.popHandler()},_onCancel:function(){this.options.keyboardManager.popHandler();var value=this.$editor.find(":text").val();this.hideEditor(),this.$element.show(),this.options.onCancel&&this.options.onCancel()},hideEditor:function(){this.$editor&&this._editorIsVisible&&(this.$editor.hide(),this._editorIsVisible=!1),this._documentClickDelegate&&($(document.body).unbind("click",this._documentClickDelegate),delete this._documentClickDelegate)},_onDocumentClick:function(ev){var self=this,$elementClick=$(ev.target);if(!this._editorIsVisible)return;if(this._justActivated&&ev.target!=document.body){this._justActivated=!1;return}if($elementClick.hasClass("ui-dateeditor-source")||$elementClick.hasClass("ui-dateeditor")||$elementClick.parents(".ui-dateeditor").length>0||$elementClick.parents(".ui-datepicker").length>0||$elementClick.parents(".ui-datepicker-calendar").length>0||$elementClick.parents(".ui-datepicker-header").length>0)return;self._onSave(),self.hideEditor(),ev.stopPropagation(),ev.preventDefault()},destroy:function(){this.hideEditor();var $editor=this.$editor;if($editor){var $input=$editor.find(":text");$input[this.options.widgetName]("destroy"),$editor.remove()}},mapKeys:function(event){switch(event.which){case 13:event.preventDefault(),this._onSave();break;case 27:event.preventDefault(),this._onCancel()}}})})