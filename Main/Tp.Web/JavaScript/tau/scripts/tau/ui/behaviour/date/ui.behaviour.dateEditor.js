define(["Underscore","jQuery"],function(t,i){i.widget("ui.dateEditor",{options:{widgetName:"datepicker",onSave:function(){},validation:{required:!1},dateFormat:"m/dd/yy",delayedSave:!0},errors:[],_create:function(){this.init()},init:function(){this.element.addClass("ui-dateeditor-source").click(i.proxy(this.showEditor,this))},setValidationErrors:function(i){this.element.addClass("ui-validationerror"),t.isString(i)&&this.element.attr("title",i)},resetValidationErrors:function(t){this.element.removeClass("ui-validationerror").removeAttr("title",t)},activate:function(){this.showEditor(),this.$editor.find(":text").focus()},_attachKeyBoardHandling:function(){this.handleKeyDown||(this.handleKeyDown=t.bind(this.mapKeys,this),this.options.keyboardManager.pushHandler(this))},_detachKeyboardHandling:function(){this.handleKeyDown&&(this.options.keyboardManager.popHandler(),delete this.handleKeyDown)},attachBlurHandler:function(t,e){var n=null,o=!1;this.$editor.find(".ui-datepicker-trigger").mousedown(function(){o=!0}).mouseup(function(){o=!1}),i(".ui-datepicker.ui-widget").mousedown(function(){o=!0}).mouseup(function(){o=!1});var s=this.options.delayedSave;t.blur(function(){return s?void(o||(n=setTimeout(e,100))):void e()}).focus(function(){clearTimeout(n)})},showEditor:function(){if(!this._editorIsVisible){if(this.$editor||(this.$editor=this._createEditor()),this._attachKeyBoardHandling(),!this._attachedSaveHandler){this._attachedSaveHandler=!0;var t=this.$editor.find(".hasDatepicker");this.attachBlurHandler(t,this._onBlur.bind(this))}this.element.hide(),this._editorIsVisible=!0,this.$editor.show().find(":text").val(this.getValue())}},_createEditor:function(){var t=i('<span class="ui-dateeditor"><input type="text" maxlength="20" /></span>'),e=t.find(":text");return e.focus(),e[this.options.widgetName]({showButtonPanel:!1,dateFormat:this.options.dateFormat,buttonText:"choose",showOn:"button",onSelect:function(){e.focus()}}),t.insertAfter(this.element),t},trimString:function(i){return t.trim(i||"")},_getDefaultValue:function(){return this.options.date||this.getValue()},_onSave:function(){var t=this.$editor.find(":text").val(),i={value:t};this.options.beforeChange&&this.options.beforeChange(i),t=i.value||"",this.hideEditor(),this.element.show();var e=this._getDefaultValue();this.trimString(e)!=this.trimString(t)&&this.options.onSave(t),this.setValue(t)},_onCancel:function(){this.hideEditor(),this.element.show(),this.options.onCancel&&this.options.onCancel()},hideEditor:function(){this.$editor&&this._editorIsVisible&&(this.$editor.hide(),this._editorIsVisible=!1),this._detachKeyboardHandling()},_onBlur:function(){this._editorIsVisible&&(this._onSave(),this.hideEditor())},destroy:function(){this.hideEditor();var t=this.$editor;if(t){var i=t.find(":text");i[this.options.widgetName]("destroy"),t.remove()}},mapKeys:function(t){switch(t.which){case 13:t.preventDefault(),this._onSave();break;case 27:t.preventDefault(),this._onCancel()}},setValue:function(t){this.element.text(t)},getValue:function(){return this.element.text()}})});