define(["Underscore","jQuery","tau/core/tau","tau/configurator"],function(_,$,a,b){$.widget("ui.dateEditor",{options:{widgetName:"datepicker",onSave:function(){},validation:{required:!1},dateFormat:"m/dd/yy"},errors:[],_create:function(){this.init()},init:function(){var a=$(this.element);this.$element=a,a.click($.proxy(this.showEditor,this)),a.addClass("ui-dateeditor-source")},setValidationErrors:function(a){this.element.addClass("ui-validationerror"),_.isString(a)&&this.element.attr("title",a)},resetValidationErrors:function(a){this.element.removeClass("ui-validationerror"),this.element.removeAttr("title",a)},activate:function(){this._justActivated=!0,this.showEditor(),this.$editor.find(":text").focus()},_attachKeyBoardHandling:function(){var a=this,c={handleKeyDown:function(){a.mapKeys.apply(a,arguments)}};b.getKeyBoardManager().pushHandler(c)},showEditor:function(b){var c=this;if(!this._editorIsVisible){if(!this.$editor){var d=$(a.concat('<span class="ui-dateeditor">','    <input type="text" maxlength="20" />',"</span>")),e=d.find(":text");e.focus();var f=$("body"),g=function(a){c._onDocumentClick.apply(c,arguments),f.unbind("click",g)},h=function(){f.click(g)};e[this.options.widgetName]({showButtonPanel:!1,dateFormat:this.options.dateFormat,buttonText:"choose",showOn:"button",beforeShow:h,onSelect:function(a){e.focus()}}),d.insertAfter(this.$element),this.$editor=d}this._attachKeyBoardHandling(),c._documentClickDelegate||(c._documentClickDelegate=function(a){c._onDocumentClick(a)},$(document.body).click(c._documentClickDelegate)),this.$element.hide(),this._editorIsVisible=!0,this.$editor.show(),this.$editor.find(":text").val(this.$element.text())}},trimString:function(a){return(a||"").trim()},_getDefaultValue:function(){return this.options.date||this.element.text()},_onSave:function(){var a=this.$editor.find(":text").val(),c={value:a};(this.options.beforeChange||function(){})(c),a=c.value,this.hideEditor(),this.$element.show();var d=this._getDefaultValue();this.trimString(d)!=this.trimString(a)&&this.options.onSave(a),this.$element.text(a),b.getKeyBoardManager().popHandler()},_onCancel:function(){b.getKeyBoardManager().popHandler();var a=this.$editor.find(":text").val();this.hideEditor(),this.$element.show(),this.options.onCancel&&this.options.onCancel()},hideEditor:function(){this.$editor&&this._editorIsVisible&&(this.$editor.hide(),this._editorIsVisible=!1),this._documentClickDelegate&&($(document.body).unbind("click",this._documentClickDelegate),delete this._documentClickDelegate)},_onDocumentClick:function(a){var b=this,c=$(a.target);if(!this._editorIsVisible)return;if(this._justActivated&&a.target!=document.body){this._justActivated=!1;return}if(c.hasClass("ui-dateeditor-source")||c.hasClass("ui-dateeditor")||c.parents(".ui-dateeditor").length>0||c.parents(".ui-datepicker").length>0||c.parents(".ui-datepicker-calendar").length>0||c.parents(".ui-datepicker-header").length>0)return;b._onSave(),b.hideEditor(),a.stopPropagation(),a.preventDefault()},destroy:function(){this.hideEditor();var a=this.$editor;if(a){var b=a.find(":text");b[this.options.widgetName]("destroy"),a.remove()}},mapKeys:function(a){switch(a.which){case 13:a.preventDefault(),this._onSave();break;case 27:a.preventDefault(),this._onCancel()}}})})