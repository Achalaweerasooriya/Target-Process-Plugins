define(["Underscore","jQuery","tau/comet/comet.connection"],function(_,$,CometConnection){return{disposeAsync:function(callback){CometConnection.stopAsync(callback)},listen:function(type,params){_.isArray(params)||(params=[params]);var $cmdStart=$.Deferred(),$cmdStarted=$.Deferred(),$cmdStop=$.Deferred(),$cmdStopped=$.Deferred(),hash={},dispatcherCallback=function(r){var $dAlways=hash["*"];$dAlways&&$dAlways.notify(r)},$cmdNotify=$.Deferred();$cmdNotify.progress(dispatcherCallback),_.each(params,function(pi){pi.callback=$cmdNotify.notify,pi.clientId=pi.parameters.clientId});var r={start:function(callback){return $cmdStarted.done(callback),$cmdStart.resolve(params),this},stop:function(callback){$cmdStopped.done(callback),$cmdStop.resolve()},on:function(args){var e=(args.eventName||"*").toLowerCase(),c=args.callback||$.noop;!hash.hasOwnProperty(e)&&(hash[e]=$.Deferred());var $d=hash[e];return $d.progress(c),this}};return CometConnection.startAsync(function(ProxySubscriptionFactory){var s=ProxySubscriptionFactory.createSubscriber(type);$cmdStop.done(function(){s.unsubscribe($cmdStopped.resolve)}),$cmdStart.done(function(p){s.subscribe(p,$cmdStarted.resolve)})}),r}}})