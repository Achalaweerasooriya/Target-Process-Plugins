define(["require","tau/core/class","Underscore","tau/services/boards/view.types"],function(e){var i=e("tau/core/class"),t=e("Underscore"),s=e("tau/services/boards/view.types"),a="board.menu.comet";return i.extend({init:function(e,i,t,s){this._cometApi=e,this._viewsMenuApi=i,this._boardsOperationsService=t,this._featuresService=s},startListen:function(){this._featuresService.isEnabled(a)&&(this._subscription=this._cometApi.subscribe("view-menu",{parameters:{clientId:this._viewsMenuApi.getViewsMenuClientId()},batchCallback:this._batchCometCallback.bind(this)}))},stopListen:function(){this._subscription&&(this._subscription.stop(),this._subscription=null)},_batchCometCallback:function(e){if(this._featuresService.isEnabled(a)){var i=JSON.parse(e.Data);t.each(i,function(e){var i=(e.data.itemType||"").toLowerCase();return"group"===i?this._handleGroup(e):s.isKnownViewType(i)?this._handleView(e):void console.error("Unknown item type",i,e)},this)}},_handleGroup:function(e){var i=e.data.itemData;switch(e.modificationType.toLowerCase()){case"added":this._viewsMenuApi.groupsApi._notifyItemCreated(i);break;case"updated":this._viewsMenuApi.groupsApi.mergeViewMenuItemCache(i),this._viewsMenuApi.groupsApi._notifyItemUpdated(i);break;case"unavailable":this._viewsMenuApi.groupsApi.clearCacheForViewMenuItem(i.key),this._viewsMenuApi.groupsApi._notifyItemRemoved(i.key)}},_handleView:function(e){var i=e.data.itemData;switch(e.modificationType.toLowerCase()){case"added":this._viewsMenuApi.viewsApi._notifyItemCreated(i);break;case"updated":this._viewsMenuApi.viewsApi.mergeViewMenuItemCache(i),this._viewsMenuApi.viewsApi._notifyItemUpdated(i);break;case"unavailable":this._onViewUnavailable(i.key)}},_onViewUnavailable:function(e){this._viewsMenuApi.viewsApi.clearCacheForViewMenuItem(e),this._viewsMenuApi.viewsApi._notifyItemRemoved(e)},destroy:function(){this.stopListen()}})});