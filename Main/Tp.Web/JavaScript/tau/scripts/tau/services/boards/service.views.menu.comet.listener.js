define(["require","tau/core/class","Underscore"],function(e){var i=e("tau/core/class"),t=e("Underscore"),a="board.menu.comet";return i.extend({init:function(e,i,t,a){this._cometApi=e,this._viewsMenuApi=i,this._boardsOperationsService=t,this._featuresService=a},startListen:function(){this._featuresService.isEnabled(a)&&(this._subscription=this._cometApi.listen("view-menu",{parameters:{clientId:this._viewsMenuApi.getViewsMenuClientId()}}).on({batchCallback:this._batchCometCallback.bind(this)}).start())},stopListen:function(){this._subscription&&(this._subscription.stop(),this._subscription=null)},_batchCometCallback:function(e){if(this._featuresService.isEnabled(a)){var i=JSON.parse(e.Data);t.each(i,function(e){switch(e.data.itemType){case"board":return this._handleBoard(e);case"group":return this._handleGroup(e)}},this)}},_handleGroup:function(e){var i=e.data.itemData;switch(e.modificationType.toLowerCase()){case"added":this._viewsMenuApi.groupsApi._notifyItemCreated(i);break;case"updated":this._viewsMenuApi.groupsApi.mergeViewMenuItemCache(i),this._viewsMenuApi.groupsApi._notifyItemUpdated(i);break;case"unavailable":this._viewsMenuApi.groupsApi.clearCacheForViewMenuItem(i.key),this._viewsMenuApi.groupsApi._notifyItemRemoved(i.key)}},_handleBoard:function(e){var i=e.data.itemData;switch(e.modificationType.toLowerCase()){case"added":this._viewsMenuApi.boardsApi._notifyItemCreated(i);break;case"updated":this._viewsMenuApi.boardsApi.mergeViewMenuItemCache(i),this._viewsMenuApi.boardsApi._notifyItemUpdated(i);break;case"unavailable":this._onBoardUnavailable(i.key)}},_onBoardUnavailable:function(e){this._viewsMenuApi.boardsApi.clearCacheForViewMenuItem(e),this._viewsMenuApi.boardsApi._notifyItemRemoved(e)},destroy:function(){this.stopListen()}})});