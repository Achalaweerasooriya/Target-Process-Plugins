define(["require","Underscore","tau/core/event","tau/core/class","app.path","tau/utils/utils.api","./service.views.menu.utils"],function(e){var t=e("Underscore"),i=e("tau/core/event"),n=e("tau/core/class"),a=e("app.path"),r=e("tau/utils/utils.api"),s=e("./service.views.menu.utils");return i.extend(n.extend({init:function(e){this._storage=new s.StorageApiFacade(e.storageConfig,e.storageKeyPrefix,e.storageKeyPrefix+"_id_"),this._noCacheStorage=new s.NoCacheStorageApiFacade(e.storageConfig),this._itemType=e.itemType,this._apiItemType=e.apiItemType,this._clientId=e.clientId},createViewMenuItem:function(e){return this._setItemDataInternal("",e).then(function(e){return this._notifyItemCreated(e.data),e}.bind(this))},getViewMenuItem:function(e){var t=this._storage.createStoreRequestConfig(e),i=this._createApiAjaxConfig(e,t);return this._storage.makeServiceCall(i)},getViewMenuItemNoCache:function(e){return this.clearCacheForViewMenuItem(e),this.getViewMenuItem(e)},updateViewMenuItem:function(e,i,n){n&&this._notifyItemUpdating(t.extend({key:e},i));var a=t.union(t.keys(i),["key"]);return this._setItemDataInternal(e,i).fail(function(){n&&this._notifyItemUpdated(t.extend({key:e},n))}.bind(this)).then(function(e){return this._notifyItemUpdated(e.data,a),e}.bind(this))},removeViewMenuItem:function(e){this._notifyItemRemoving(e);var t=this._storage.createStoreRequestConfig(e),i=this._createApiAjaxConfig(e).url,n=r.createDeleteAjaxCommandConfig({url:i,data:JSON.stringify({clientId:this._clientId})});return n.$scope=t,this._storage.makeServiceCall(n).then(this._storage.clearCacheForViewItem.bind(this._storage,e)).then(this._notifyItemRemoved.bind(this,e))},restoreViewMenuItem:function(e,t){return this.updateViewMenuItem(e,t).then(function(e){return this._notifyItemRestored(e.data),e}.bind(this))},prioritizeViewMenuItem:function(e,t,i){var n={url:a.get()+"/api/views/v1/prioritize/"+this._apiItemType,type:"POST",data:{itemId:e,targetItemId:t,placeAfter:!!i,clientId:this._clientId}};return this._noCacheStorage.makeServiceCall(n)
},setViewMenuItemCache:function(e){var t=this._storage.createStoreRequestConfig(e.key),i=this._createApiAjaxConfig(e.key,t),n={ajaxConfig:i,config:t,data:e,value:e};this._storage.saveCacheByGroupAndKey(e,n)},mergeViewMenuItemCache:function(e){this._storage.mergeCacheByGroupAndKey(e)},setViewMenuItemCollectionCache:function(e){t.each(e,this.setViewMenuItemCache,this)},clearViewMenuItemCollectionCache:function(){this._storage.clearCache()},clearCacheForViewMenuItem:function(e){this._storage.clearCacheForViewItem(e)},_setItemDataInternal:function(e,i){i=t.deepClone(i),i.clientId=this._clientId;var n=this._storage.createStoreRequestConfig(e);n.$value=i;var a=this._createApiAjaxConfig(e,n);return a.type="POST",a.data=JSON.stringify(i),this._storage.makeServiceCall(a)},_createApiAjaxConfig:function(e,t){return{url:a.get()+"/api/views/v1/"+this._apiItemType+"/"+e,contentType:"application/json; charset=utf-8",dataType:"json",$scope:t,type:"GET"}},_notifyItemCreated:function(e){this._notifyBase("service.views.api.created",e)},_notifyItemUpdating:function(e){this._notifyBase("service.views.api.updating",e)},_notifyItemUpdated:function(e,i){var n=i&&i.length?t.pick(e,i):e;this._notifyBase("service.views.api.updated",n)},_notifyItemRemoving:function(e){this._notifyBase("service.views.api.removing",e)},_notifyItemRemoved:function(e){this._notifyBase("service.views.api.removed",e)},_notifyItemRestored:function(e){this._notifyBase("service.views.api.restored",e)},_notifyBase:function(e,t){this.fire(e,{type:this._itemType,data:t}),this.fire(e+"."+this._itemType,t)}}))});