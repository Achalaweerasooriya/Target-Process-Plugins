define(["Underscore","jQuery","tau/core/class","tau/core/event","libs/parseUri","libs/json2"],function(_,$,Class,Event,parseUri){var Service=Class.extend({init:function(configurator){this._id=_.uniqueId("sh"),this.setWindow(configurator.getWindow()),this.setEncoder(configurator.getHashEncoder()||this.encoderDefault())},setWindow:function(windw){this.window&&$(this.window).unbind("hashchange."+this._id),this.window=_.defaults(windw||{},{location:{hash:""}}),$(this.window).bind("hashchange."+this._id,_.bind(function(){this.fire("changed",{hash:this.getHash()})},this))},setEncoder:function(encoder){this.paramsEncoder=encoder},getHash:function(){var hash=this.window.location.hash;while(hash.indexOf("#")===0)hash=hash.substr(1);return this.tryDecodeUri(hash)},setHref:function(href){this.window.location.href=href},getHref:function(){return this.window.location.href},getHrefParsed:function(){return parseUri(this.getHref())},setHash:function(hashStr){this.window.location.replace("#"+hashStr)},triggerChange:function(hash){$(this.window).trigger("hashchange."+this._id,{hash:hash})},hashParams:function(){var result={},hash=this.getHash(),parts=hash.split("&");for(var i=0,len=parts.length;i<len;i++){var token=parts[i],pos=token.indexOf("=");if(pos!==-1){var n=token.substr(0,pos),v=token.substr(pos+1);result[n]=this.paramsEncoder.decode(v)}}return result},getHashParam:function(id,defaultValue){var hash=this.hashParams();return hash[id]||(arguments.length>1?defaultValue:{})},setHashParam:function(id,value){var hash=this.getHash(),newHashString=this.mergeHashParams(hash,id,value);this.setHash(newHashString)},applyHashObject:function(obj){var self=this,newHashString=this.getHash();_.each(obj,function(val,id){newHashString=this.mergeHashParams(newHashString,id,val)},self),self.setHash(newHashString)},mergeHashParams:function(hash,id,value){hash=hash.charAt(0)!=="&"?"&"+hash:hash;var index=hash.indexOf("&"+id+"="),left=index!==-1?index:hash.length;index=hash.indexOf("&",1+left);var right=index!==-1?index:hash.length,serializedParam="";if(value!==null){var v=this.paramsEncoder.encode(value),prefix=hash==="&"?"":"&";serializedParam=prefix+id+"="+v}var head=hash.substring(0,left),tail=hash.substring(right),newHashString=head+serializedParam+tail;return newHashString=newHashString.charAt(0)!=="&"?newHashString:newHashString.substring(1),newHashString},tryDecodeUri:function(hash){var r=hash;try{r=decodeURIComponent(hash)}catch(e){}return r},onHashChange:function(handler){this.on("changed",handler,handler)},unbindHashChange:function(handler){this.removeListener("changed",handler,handler)},encoderDefault:function(){return{encode:function(value){var v=value;return _.isObject(value)&&(v=JSON.stringify(value)),v},decode:function(str){var v=str;return v.charAt(0)==="{"&&v.charAt(v.length-1)==="}"&&(v=JSON.parse(v)),v}}},setDefaultEncoder:function(){this.paramsEncoder=this.encoderDefault()},setFakeWindow:function(){var args=_.toArray(arguments),location;args.length==2?location={hash:args[0],href:args[1]}:_.isString(args[0])?location={hash:args[0]}:location=args[0]||{};var $w=$("<div />");$w.location=_.defaults(location,{hash:"",href:"",replace:function(val){$w.location.hash=_.asString(val),$w.trigger("hashchange",{})}}),this.setWindow($w)}});return Service.prototype.triggerHashChange=Service.prototype.triggerChange,Event.implementOn(Service.prototype),Service})