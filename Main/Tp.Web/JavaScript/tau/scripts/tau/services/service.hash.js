define(["Underscore","jQuery","tau/core/class","tau/core/event","libs/parseUri","tau/utils/utils.base64hashEncoder"],function(t,n,e,i,s,r){var h=e.extend({init:function(){this._id=t.uniqueId("sh"),this.setEncoder(r)},setWindow:function(e){this.removeWindowListener(),this.window=t.defaults(e||{},{location:{hash:"",replace:function(t){e.location.hash=t}}}),n(this.window).on("hashchange."+this._id,function(){this.fire("changed",{hash:this.getHash()})}.bind(this))},setEncoder:function(t){this.paramsEncoder=t},getHash:function(){for(var t=this.window.location.hash;0===t.indexOf("#");)t=t.substr(1);return this.tryDecodeUri(t)},setHref:function(t){this.window.location.href=t},getHref:function(){return this.window.location.href},getHrefParsed:function(){return s(this.getHref())},setHash:function(t){this.window.location.replace("#"+t)},triggerHashChange:function(t){n(this.window).trigger("hashchange."+this._id,{hash:t})},hashParams:function(){for(var t={},n=this.getHash(),e=n.split("&"),i=0,s=e.length;s>i;i++){var r=e[i],h=r.indexOf("=");if(-1!==h){var a=r.substr(0,h),o=r.substr(h+1);t[a]=this.paramsEncoder.decode(o)}}return t},getHashParam:function(t,n){var e=this.hashParams();return e[t]||(arguments.length>1?n:{})},setHashParam:function(t,n){var e=this.getHash(),i=this.mergeHashParams(e,t,n);this.setHash(i)},mergeHashParams:function(t,n,e){t="&"===t.charAt(0)?t:"&"+t;var i=t.indexOf("&"+n+"="),s=-1===i?t.length:i;i=t.indexOf("&",1+s);var r=-1===i?t.length:i,h="";if(null!==e){var a=this.paramsEncoder.encode(e),o="&"===t?"":"&";h=o+n+"="+a}var c=t.substring(0,s),u=t.substring(r),d=c+h+u;return d="&"===d.charAt(0)?d.substring(1):d},tryDecodeUri:function(t){var n=t;try{n=decodeURIComponent(t)}catch(e){}return n},onHashChange:function(t){this.on("changed",t,t)},unbindHashChange:function(t){this.removeListener("changed",t,t)},setFakeWindow:function(e){var i=this._getLocation(e),s=n("<div />");s.location=t.defaults(i,{hash:"",href:"",replace:function(n){s.location.hash=t.asString(n),s.trigger("hashchange",{})
}}),this.on("destroy",function(){s.remove()}),this.setWindow(s)},_getLocation:function(n){return t.isString(n)?{hash:n}:n||{}},removeWindowListener:function(){this.window&&n(this.window).off("hashchange."+this._id)},destroy:function(){this.removeWindowListener(),this.fire("destroy"),this.removeAllListeners()}});return i.implementOn(h.prototype),h});