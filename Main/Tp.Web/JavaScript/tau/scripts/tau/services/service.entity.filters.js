define(["require","Underscore","jQuery","tau/core/class","tau/store/types","tau/utils/utils.api"],function(t){var e=t("Underscore"),i=t("jQuery"),r=t("tau/core/class"),n=t("tau/store/types"),s=t("tau/utils/utils.api"),a={assigneduser:"assignment",createdate:"datetime",enddate:"datetime",startdate:"datetime",team:"responsibleteam"},l={userStory:["releasable"],bug:["releasable"],feature:["releasable"],task:["releasable"],iteration:["releasable","time_container"],teamIteration:["time_container"],release:["time_container"]};return r.extend({init:function(t){this._applicationPath=t.applicationPath,this._loggedUser=t.loggedUser,this.onEntityFilterAdded=e.Callbacks(),this.onEntityFilterUpdated=e.Callbacks(),this.onEntityFilterRemoved=e.Callbacks(),this.onEntityFiltersChanged=e.Callbacks()},getPropertiesWithTypes:function(t){return t=t||{},e.reduce(t,function(t,e,i){var r=(e||{}).types||[];return r.length&&(t[i]={types:r}),t},{})},getEntityFilters:function(t){return this.getAllEntityFilters().then(function(i){var r=this.getPropertiesWithTypes(t);return e.each(r,function(t,e){this._createFiltersForProperty(t,i,e)},this),r}.bind(this))},_createFiltersForProperty:function(t,i,r){var n=e.chain(i).filter(function(i){return e.every(t.types,function(t){return e.some(i.entityTypes,function(e){return this._isTypeEqualOrDerived(t,e.toLowerCase())},this)},this)},this).map(function(t){return{label:t.description,value:t.value,key:t.key,isShared:t.isShared,isEditable:t.ownerId===this._loggedUser.id||this._loggedUser.isAdministrator,canShare:this._loggedUser.isAdministrator}},this).value();t.filters={name:r,types:t.types,privateFilters:e.where(n,{isShared:!1}),sharedFilters:e.where(n,{isShared:!0})}},_isTypeEqualOrDerived:function(t,i){if(t===i)return!0;var r=n.findByKeyword(t);return r?r.name.toLowerCase()===i||a[t]===i?!0:l[r.name]&&e.contains(l[r.name],i)?!0:r.parent?this._isTypeEqualOrDerived(r.parent,i):!1:!1},getAllEntityFilters:function(){if(!this._entityFiltersDefer){if(this._entityFilters)return i.Deferred().resolve(this._entityFilters);
this._entityFiltersDefer=i.ajax(this._getRequestParams(null,"GET")).then(function(t){return this._entityFilters=t.reverse(),this._entityFilters}.bind(this)).always(function(){this._entityFiltersDefer=null}.bind(this))}return this._entityFiltersDefer},getEntityFilter:function(t){return i.ajax(this._getRequestParams(t,"GET"))},createEntityFilter:function(t){return i.ajax(this._getRequestParams(null,"POST",t)).then(function(t){return this._entityFilters.unshift(t),this.onEntityFilterAdded.fire(t),this.onEntityFiltersChanged.fire(),t}.bind(this))},updateEntityFilter:function(t,r){var n=e.findWhere(this._entityFilters,{key:t});return i.ajax(this._getRequestParams(t,"POST",e.extend({},n,r))).then(function(t){var i=e.findIndex(this._entityFilters,function(e){return e.key===t.key});return this._entityFilters[i]=t,this.onEntityFilterUpdated.fire(t),this.onEntityFiltersChanged.fire(),t}.bind(this))},setIsShared:function(t,e){return this.updateEntityFilter(t,{isShared:e})},removeEntityFilter:function(t){return i.ajax(this._getRequestParams(t,"DELETE")).then(function(i){return this._entityFilters=e.filter(this._entityFilters,function(e){return e.key!==t}),this.onEntityFilterRemoved.fire(t),this.onEntityFiltersChanged.fire(),i}.bind(this))},_getRequestParams:function(t,e,i){var r={url:this._getRequestUrl(t),type:e,dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(i)};return"DELETE"===e&&(r=s.createDeleteAjaxCommandConfig(r)),r},_getRequestUrl:function(t){return this._applicationPath+"/api/EntityFilters/v1/"+(t||"")}})});