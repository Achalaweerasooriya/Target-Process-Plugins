define(["Underscore","tau/core/class","tau/core/event"],function(e,t,n){var r=t.extend({storage:{},init:function(e){window.performance&&window.performance.timing&&(this.storage.page={server:window.performance.timing.responseEnd-window.performance.timing.navigationStart,client:window.performance.timing.loadEventEnd-window.performance.timing.responseEnd}),this._configurator=e.configurator,this._window=this._configurator.getWindow()},set:function(e,t){this.storage[e]=t,this.fire(e,t)},remove:function(e){delete this.storage[e]},get:function(e){return this.storage[e]},page:function(){return this.get("page")},networkLatency:function(){var t=e.range(10).map(function(){return this._networkLatencyCall()}.bind(this));return $.whenList(t).then(function(){var t=e.chain(arguments).filter(function(e){return"success"===e.status}),n=t.reduce(function(e,t){return e+t.latency},0).value()/t.value().length,r=t.map(function(e){return e.timestamp}).first().value();return{timestamp:r,latency:n}})},_networkLatencyCall:function(){var e;return $.ajax({url:this._getDiagnosticsUrl("ServerTime"),dataType:"json",contentType:"application/json",async:!1,beforeSend:function(){e=(new Date).getTime()}}).then(function(t,n){return{timestamp:"success"===n?new Date(t):"N/A",status:n,latency:(new Date).getTime()-e}})},networkSpeed:function(){var e;return $.ajax({url:this._getDiagnosticsUrl("SampleFile"),contentType:"image/png",async:!1,beforeSend:function(){e=(new Date).getTime()}}).then(function(){var t=(new Date).getTime()-e,n=this.complete&&"undefined"!=typeof this.naturalWidth&&0!==this.naturalWidth?"success":"failed";return{status:n,speed:t}})},jsBenchmark:function(){for(var e=1e7,t=0,n=1,r=(new Date).getTime(),i=0;e>=i;i++)t=t+4/n-4/(n+2),n+=4;return(new Date).getTime()-r},serverUsage:function(){return $.ajax({url:this._getDiagnosticsUrl("usage"),dataType:"json",contentType:"application/json"}).then(function(e){return e})},memoryUsage:function(){if(this._window.performance&&this._window.performance.memory){var e=1048576;
return{jsHeapSizeLimit:this._window.performance.memory.jsHeapSizeLimit/e,usedJSHeapSize:this._window.performance.memory.usedJSHeapSize/e,totalJSHeapSize:this._window.performance.memory.totalJSHeapSize/e}}return null},_detectBrowser:function(){var e=this._window.navigator.userAgent;return/Firefox[\/\s](\d+\.\d+)/.test(e)?"Firefox "+new Number(RegExp.$1):/MSIE (\d+\.\d+);/.test(e)||/Trident.*rv[ :]*(\d+)/.test(e)?"IE "+new Number(RegExp.$1):/Opera[\/\s](\d+\.\d+)/.test(e)||/OPR[\/\s](\d+\.\d+)/.test(e)?"Opera "+new Number(RegExp.$1):/Chrome[\/\s](\d+\.\d+)/.test(e)?"Chrome "+new Number(RegExp.$1):/Version\/(\d+).*Safari/.test(e)||/Safari[\/\s](\d+\.\d+)/.test(e)?"Safari "+new Number(RegExp.$1):e},browser:function(){var e=this.jsBenchmark(),t=this.page(),n=t?{processing:t.client,network:t.server}:null;return{language:this._window.navigator.language,platform:this._window.navigator.platform,userAgent:this._detectBrowser(),benchmark:e,timing:n,memory:this.memoryUsage()}},sendReport:function(e){return $.ajax({url:this._getDiagnosticsUrl("SendReport"),data:JSON.stringify(e),type:"POST",dataType:"json",contentType:"application/json"})},_getDiagnosticsUrl:function(e){return this._configurator.getApplicationPath()+"/diagnostics/v1/"+e}});return n.implementOn(r.prototype),r});