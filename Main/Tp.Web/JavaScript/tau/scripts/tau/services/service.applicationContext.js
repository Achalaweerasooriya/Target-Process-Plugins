define(["Underscore","jQuery","tau/core/class","tau/core/event"],function(e,t,i,s){var o=i.extend({dirtyState:!1,init:function(e){this.configurator=e,this.store=e.getStore(),this.store2=e.getStore2(),this.onApplicationContextRetrieved=t.Callbacks()},refreshChoice:function(){this.fire("refreshChoice.after")},setCurrentAcid:function(e,t){this.store.save("context",{acid:e}).done(t)},getTeamsProjectsAvailable:function(e){return this.configurator.getStore2().getTeamsProjectsAvailable(e)},appendToContext:function(t,i,s){return s.get({fields:["acid"]}).then(function(e){return this.getApplicationContext({acid:e.acid})}.bind(this)).then(function(s){var o={project:s.selectedProjectIds,team:s.selectedTeamIds};o[t.toLowerCase()]=e.union(o[t.toLowerCase()],i);var n={projectIds:o.project,teamIds:o.team};return this.getApplicationContext(n)}.bind(this)).then(function(e){return s.set({set:{acid:e.acid}})}.bind(this))},findByEntity:function(e){var i=t.Deferred();return this.getApplicationContext({id:e.id},{success:function(e){i.resolve(e)},failure:function(e){i.reject(e)}}),i},markAsDirty:function(){this.dirtyState=!0},_getErrorMessage:function(t){var i=t[0]||{};return e.complexKey(i,"data.response.Message")||"Failed to load application context"},getApplicationContext:function(i,s){var o=t.Deferred(),n=this,r={fields:["id","acid","culture","edition","appContext",{loggedUser:["id","email","isAdministrator"]},{processes:["id","name","terms","practices","customFields"]},{selectedProjects:["id","name",{process:["id","name"]}]},{selectedTeams:["id","name"]}]};i.hasOwnProperty("acid")?r.acid=i.acid:i.hasOwnProperty("ids")&&(r.ids=i.ids),(i.hasOwnProperty("projectIds")||i.hasOwnProperty("projectId"))&&(r.projectIds=i.projectIds||i.projectId),(i.hasOwnProperty("teamIds")||i.hasOwnProperty("teamId"))&&(r.teamIds=i.teamIds||i.teamId),r.id=i.id||i.acid,r.failureGlobal=!1;var a,c;r.id?this.dirtyState?(c=function(){this.dirtyState=!1}.bind(this),a="refresh"):a="get":a="turboGet";var d=function(e,t){e.availableProcesses=t.availableProcesses},l=function(t,i){var s=e(i.teams).pluck("id"),o=e(i.projects).pluck("id");t.teamIdsAvailable=s,t.selectedTeamIdsAvailable=e.intersection(t.selectedTeamIds,s),t.projectIdsAvailable=o,t.selectedProjectIdsAvailable=e.intersection(t.selectedProjectIds,o)},u=function(t,i){var s=i.projectContext.no?["null"]:[],o=i.teamContext.no?["null"]:[];t.selectedProjectIds=e.union(s,e.pluck(t.selectedProjects,"id")),t.selectedTeamIds=e.union(o,e.pluck(t.selectedTeams,"id"))},p=function(e,t){n.isBoardEdition&&(t.push("board"),t.push("hasTeams")),e.edition=t},f=this.configurator;return f.getFeaturesService().isEnabled("context.v2")?this.store2.getApplicationContext(r).done(function(t){var i=f.getSystemInfo(),s=t.context,n={__type:"context",acid:s.acid,appContext:{projectContext:{no:s.isNoProjectIncluded},teamContext:{no:s.isNoTeamIncluded}},culture:i.culture,edition:i.edition,id:s.acid,loggedUser:e.omit(f.getLoggedUser(),"role"),selectedProjects:s.selectedProjects.items,selectedTeams:s.selectedTeams.items,processes:e.map(s.processes,function(e){return{customFields:e.customFields.items,id:e.id,name:e.name,isDefault:e.isDefault,practices:e.practices.items,terms:e.terms.items}})},r={name:"turboGet",type:n.__type,config:{}};this.store.registerWithEvents(n,"__type",r),p(n,[i.edition]),u(n,n.appContext),d(n,s),l(n,t),n.projects=t.projects,n.teams=t.teams,n.loggedUser=f.getLoggedUser(),o.resolve(n)}.bind(this)).fail(function(e){o.reject(this._getErrorMessage([{data:e}]))}.bind(this)):this.store[a]("context",r).done({success:function(t){var i=t[0].data;e.isArray(i)&&(i=i[0]);var s=i.edition?[i.edition]:[];p(i,s);var r=i.appContext||{};e.defaults(r,{projectContext:{no:!1},teamContext:{no:!1}}),u(i,r),n.getTeamsProjectsAvailable(i.loggedUser.id).done(function(e){d(i,e),l(i,e),o.resolve(i)}).fail(function(e){o.reject(e.statusText)})},failure:function(e){o.reject(this._getErrorMessage(e))}.bind(this)}),o.done(e.compact([function(e){this.onApplicationContextRetrieved.fire(e),s&&s.success&&s.success.apply(null,[e])}.bind(this),c])).fail(function(e){s&&s.failure&&s.failure.apply(null,[e])}),o}});return s.implementOn(o.prototype),o});