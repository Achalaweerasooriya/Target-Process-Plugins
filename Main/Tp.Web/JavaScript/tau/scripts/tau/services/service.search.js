define(["jQuery","Underscore","tau/core/termProcessor","tau/core/class","tau/utils/utils.date"],function($,_,TermProcessor,Class,dateUtils){var strategies={comment:function(item){item.entityType={name:"comment"};var tp=new TermProcessor;return item.general.entityType.term=tp.getTerms(item.general.entityType.name).name,item}},itemAdapter=function(item){var t=item.__type.toLowerCase(),preProcessing=strategies[t]||_.fixedPoint;item=preProcessing(item);var tp=new TermProcessor;return item.entityType.term=tp.getTerms(item.entityType.name).name,item.nameExt=item.nameExt||item.name,item.descExt=item.descExt||item.description||"",item.tags=item.tags?item.tags.split(", "):[],item.createDate=dateUtils.parse(item.createDate),item},Service=Class.extend({init:function(config){var x=this;x.defaultParams={searchString:"",entityTypeId:null,entityStateIds:null,pageSize:10,pageNo:0},x.storage=config.storage,x._params=config.storage,x.configurator=config.configurator,x.$paramsChangedCallbacks=$.Callbacks(),x.$dParamsChanged=$.Deferred(),x.$dParamsChanged.progress(x.$paramsChangedCallbacks.fire),x.$clearCallbacks=$.Callbacks(),x.$dClear=$.Deferred(),x.$dClear.progress(x.$clearCallbacks.fire),x.$submitCallbacks=$.Callbacks(),x.$dSubmit=$.Deferred(),x.$dSubmit.progress(x.$submitCallbacks.fire),x.$searchCallbacks=$.Callbacks(),x.$dSearch=$.Deferred(),x.$dSearch.progress(x.$searchCallbacks.fire)},asDisposable:function(callback,methodName){var o=this,r={};return r.dispose=_.bind(function(o,callback,methodName){o[methodName](callback)},r,o,callback,methodName),r},onParamsChanged:function(callback){var o=this;return o.$paramsChangedCallbacks.add(callback),o.asDisposable(callback,"offParamsChanged")},offParamsChanged:function(callback){this.$paramsChangedCallbacks.remove(callback)},onClear:function(callback){return this.$clearCallbacks.add(callback),this.asDisposable(callback,"offClear")},offClear:function(callback){this.$clearCallbacks.remove(callback)},onSubmit:function(callback){return this.$submitCallbacks.add(callback),this.asDisposable(callback,"offSubmit")},offSubmit:function(callback){this.$submitCallbacks.remove(callback)},onSearch:function(callback){return this.$searchCallbacks.add(callback),this.asDisposable(callback,"offSearch")},offSearch:function(callback){this.$searchCallbacks.remove(callback)},params:function(){var service=this;return{get:function(key){return arguments.length?service._params[key]:service._params},set:function(key,val){var keys=[],params={};if(_.isString(key))keys=[key],params[key]=val;else{if(!_.isObject(key))throw new Error("Unsupported argument [key]");keys=_.keys(key),params=key}var isPageNoParameter=keys.length===1&&keys[0]==="pageNo";isPageNoParameter||(params.pageNo=0);var k=_.keys(params),delta={};return _.each(k,function(key){params[key]!==service._params[key]&&(delta[key]=params[key])}),service._params=_.extend(service._params,params),service.$dParamsChanged.notify(delta),this},submit:function(){var params=service._params;service.$dSubmit.notify(params)},clear:function(){service._params=_.clone(service.defaultParams),service.$dClear.notify(service._params)}}},__adaptEntityTypes:function(items){var tp=new TermProcessor;return _(items).chain().filter(function(x){var n=x.name.toLowerCase();return n!=="solution"&&n!=="impediment"}).map(function(x){return x.term=tp.getTerms(x.name).name,x}).value()},__adaptEntityStates:function(items){return _(items).chain().reduce(function(memo,d){return memo[d.name]=memo[d.name]||[],memo[d.name].push(d.id),memo},{}).map(function(v,k){return{id:v.join(","),name:k}}).sortBy(function(o){return o.name}).value()},getSearchDomain:function(parameters){var x=this;parameters=parameters||x.params().get();var configurator=this.configurator,$resultDefer=$.Deferred(),store=configurator.getStore(),acidStore=configurator.getAppStateStore(),ctxService=configurator.getApplicationContextService();return acidStore.get({fields:["acid"],callback:function(r){ctxService.getApplicationContext({acid:r.acid},{success:function(r){var processIds=_.pluck(r.processes,"id"),$query={process:{id:{$in:processIds}}};store.find("entityType",{list:!0,fields:["id","name"],$query:{isSearchable:1}}).find("entityState",{list:!0,fields:["id","name",{entityType:["id","name"]}],$query:$query}).done(function(r){var entityTypes=x.__adaptEntityTypes(r[0].data),iterator=parameters.entityTypeId?function(d){return d.entityType.id==parameters.entityTypeId}:function(d){return!0},raw=_(r[1].data).filter(iterator),entityStates=x.__adaptEntityStates(raw);$resultDefer.resolve({entityTypes:entityTypes,entityStates:entityStates,params:parameters})})}})}}),$resultDefer},extractPluralIDs:function(str){var isIDs=!1,parts=str.split(",");if(parts.length>1){var IDs=[];isIDs=_(parts).every(function(p){var token=_.trim(p),isDigit=/^\d+$/.test(token);return isDigit&&IDs.push(parseInt(token)),isDigit})}return isIDs?IDs:null},search:function(params){var self=this,configurator=this.configurator;return _.defaults(params,self.defaultParams),{done:function(callback){var $defer;_.isFunction(callback)?($defer=$.Deferred(),$defer.always(callback)):$defer=callback,$defer.always(self.$dSearch.notify);var root=configurator.getApplicationPath(),store=configurator.getStore(),acidStore=configurator.getAppStateStore(),ctxService=configurator.getApplicationContextService(),searchIDs=function(ctx){var plgn="{AppPath}/api/v1/Plugins.asmx/Search/Profiles/Now%20running/Commands/Search".replace(/{AppPath}/g,root),post=JSON.stringify({Command:"Search",Plugin:"Search",TeamIds:_.without(ctx.selectedTeamIds,"null"),IncludeNoTeam:ctx.includeNoTeam,ProjectIds:_.without(ctx.selectedProjectIds,"null"),IncludeNoProject:ctx.includeNoProject,Query:params.searchString,EntityTypeId:params.entityTypeId,EntityStateIds:_.isArray(params.entityStateIds)?params.entityStateIds:_((params.entityStateIds||"").split(",")).chain().without("").map(function(n){return parseInt(n)}).value(),Page:{Number:params.pageNo,Size:params.pageSize}});return $.ajax({url:plgn,type:"POST",data:post,dataType:"json"})},fetchDetailsByIDs=function(r){var indexProgress=_.defaults(r.IndexProgressData||{},{CompleteInPercents:100}),rData={info:{pageNo:params.pageNo,pageSize:params.pageSize,total:r.Total,indexProgress:indexProgress.CompleteInPercents},items:[]},$r=$.Deferred();if(rData.info.total>0){var assignableIds=r.AssignableIds,testCaseIds=r.TestCaseIds,generalIds=r.GeneralIds,commentIds=r.CommentIds,configurator=self.configurator,storeChain=configurator.getStore();if(assignableIds.length){var $assignableQuery={fields:["id","name","description","tags","createDate",{entityType:["id","name"]},{entityState:["id","name","isFinal"]},{project:["id","name"]},{team:["id","name"]}],$query:{id:{$in:assignableIds}}};storeChain=storeChain.find("assignable",$assignableQuery)}if(testCaseIds.length){var $testCaseQuery={fields:["id","name","description","steps","success","tags","createDate",{entityType:["id","name"]},{project:["id","name"]}],$query:{id:{$in:testCaseIds}}};storeChain=storeChain.find("testcase",$testCaseQuery)}if(generalIds.length){var $generalQuery={fields:["id","name","description","tags","createDate",{entityType:["id","name"]},{project:["id","name"]}],$query:{id:{$in:generalIds}}};storeChain=storeChain.find("general",$generalQuery)}if(commentIds.length){var $commentQuery={fields:["id","description","createDate",{general:["id","name",{entityType:["id","name"]}]}],$query:{id:{$in:commentIds}}};storeChain=storeChain.find("comment",$commentQuery)}storeChain.done({success:function(r){var resultItems=[];_.each(r,function(x){resultItems=resultItems.concat(x.data)}),rData.items=_.sortBy(resultItems,function(e){return-1*e.id}),$r.resolve(rData)},failure:function(r){$r.reject(r)}})}else $r.resolve(rData);return $r},handleSearchResult=function(chained){chained.fail(function(r){$defer.reject({data:{error:!0,response:r}})}).done(function(r){var ss=_.trim(params.searchString),keywords=_.without(ss?ss.split(/\s|\?|\*|\+|-|:|'|"/g):[],"");$defer.resolve({data:{keywords:keywords,info:r.info,items:_.map(r.items,itemAdapter)}})})},pluralIds=self.extractPluralIDs(params.searchString);if(pluralIds)store.get("general",{fields:["id",{entityType:["name"]}],$query:{id:{$in:pluralIds}}}).done(function(r){var adapter=_(r[0].data).chain().filter(function(d){return _.contains(pluralIds,d.id)&&d.hasOwnProperty("entityType")}).reduce(function(memo,d){var typeName=d.entityType.name,memoKey=typeName+"Ids";if(!memo.hasOwnProperty(memoKey)){var ref=store.typeMetaInfo(typeName);memoKey=_.titleize(ref.parent)+"Ids"}return memo.hasOwnProperty(memoKey)&&(memo[memoKey].push(d.id),++memo.Total),memo},{AssignableIds:[],CommentIds:[],GeneralIds:[],TestCaseIds:[],Total:0}).value();handleSearchResult(fetchDetailsByIDs(adapter))});else if(params.isAllProjects){var user=configurator.getLoggedUser(),continuation=function(r){var ctx={includeNoProject:!0,selectedProjectIds:r.projIds,includeNoTeam:!0,selectedTeamIds:r.teamIds};handleSearchResult(searchIDs(ctx).pipe(fetchDetailsByIDs))};ctxService.getTeamsProjectsAvailable(user.id).pipe(function(r){return{teamIds:_(r.teams).pluck("id"),projIds:_(r.projects).pluck("id")}}).done(continuation)}else acidStore.get({fields:["acid"],callback:function(r){ctxService.getApplicationContext({acid:r.acid},{success:function(r){var ctx={includeNoProject:r.appContext.projectContext.no,selectedProjectIds:r.selectedProjectIdsAvailable,includeNoTeam:r.appContext.teamContext.no,selectedTeamIds:r.selectedTeamIdsAvailable};handleSearchResult(searchIDs(ctx).pipe(fetchDetailsByIDs))}})}})}}}});return Service})