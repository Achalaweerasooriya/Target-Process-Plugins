define(["jQuery","Underscore","tau/core/termProcessor","tau/core/class","tau/services/search/service.search.commandFacttory","tau/services/search/service.search.command.multiIdsParts","tau/services/search/service.search.command.text"],function(a,e,t,r,n){var s=r.extend({init:function(e){var t=this;t.defaultParams={searchString:"",entityTypeId:null,entityStateIds:null,pageSize:10,pageNo:0},t.storage=e.storage,t._params=e.storage,t.configurator=e.configurator,t.$paramsChangedCallbacks=a.Callbacks(),t.$dParamsChanged=a.Deferred(),t.$dParamsChanged.progress(t.$paramsChangedCallbacks.fire),t.$clearCallbacks=a.Callbacks(),t.$dClear=a.Deferred(),t.$dClear.progress(t.$clearCallbacks.fire),t.$submitCallbacks=a.Callbacks(),t.$dSubmit=a.Deferred(),t.$dSubmit.progress(t.$submitCallbacks.fire),t.$searchCallbacks=a.Callbacks(),t.$dSearch=a.Deferred(),t.$dSearch.progress(t.$searchCallbacks.fire)},asDisposable:function(a,t){var r=this,n={};return n.dispose=e.bind(function(a,e,t){a[t](e)},n,r,a,t),n},onParamsChanged:function(a){var e=this;return e.$paramsChangedCallbacks.add(a),e.asDisposable(a,"offParamsChanged")},offParamsChanged:function(a){this.$paramsChangedCallbacks.remove(a)},onClear:function(a){return this.$clearCallbacks.add(a),this.asDisposable(a,"offClear")},offClear:function(a){this.$clearCallbacks.remove(a)},onSubmit:function(a){return this.$submitCallbacks.add(a),this.asDisposable(a,"offSubmit")},offSubmit:function(a){this.$submitCallbacks.remove(a)},onSearch:function(a){return this.$searchCallbacks.add(a),this.asDisposable(a,"offSearch")},offSearch:function(a){this.$searchCallbacks.remove(a)},params:function(){var a=this;return{get:function(e){return arguments.length?a._params[e]:a._params},set:function(t,r){var n=[],s={};if(e.isString(t))n=[t],s[t]=r;else{if(!e.isObject(t))throw new Error("Unsupported argument [key]");n=e.keys(t),s=t}var i=1===n.length&&"pageNo"===n[0];i||(s.pageNo=0);var c=e.keys(s),o={};return e.each(c,function(e){s[e]!==a._params[e]&&(o[e]=s[e])}),a._params=e.extend(a._params,s),a.$dParamsChanged.notify(o),this},submit:function(){var e=a._params;a.$dSubmit.notify(e)},clear:function(){a._params=e.clone(a.defaultParams),a.$dClear.notify(a._params)}}},__adaptEntityTypes:function(a){var r=new t;return e(a).chain().filter(function(a){var e=a.name.toLowerCase();return"solution"!==e}).map(function(a){return a.term=r.getTerms(a.name).name,a}).value()},__adaptEntityStates:function(a,t){return e(a).chain().reduce(function(a,r){return a[r.name]=a[r.name]||{contextStateIds:[],availableStateIds:[]},e.contains(t,r.process.id)&&a[r.name].contextStateIds.push(r.id),a[r.name].availableStateIds.push(r.id),a},{}).pairs().reject(function(a){return 0===a[1].contextStateIds.length}).map(function(a){var e=a[0],t=a[1];return{id:t.contextStateIds.join(","),availableId:t.availableStateIds.join(","),name:e}}).sortBy(function(a){return a.name}).value()},getSearchDomain:function(t){var r=this;t=t||r.params().get();var n=this.configurator,s=a.Deferred(),i=n.getStore(),c=n.getAppStateStore(),o=n.getApplicationContextService();return c.get({fields:["acid"],callback:function(a){o.getApplicationContext({acid:a.acid},{success:function(a){var n=e.pluck(a.availableProcesses,"id"),c=e.pluck(a.processes,"id"),o={process:{id:{$in:n}}};i.find("entityType",{list:!0,fields:["id","name"],$query:{isSearchable:1}}).find("entityState",{list:!0,fields:["id","name",{entityType:["id","name"]},{process:["id"]}],$query:o}).done(function(a){var i=r.__adaptEntityTypes(a[0].data),o=t.entityTypeId?function(a){return a.entityType.id==t.entityTypeId}:function(){return!0},l=e(a[1].data).filter(o),u=r.__adaptEntityStates(l,t.isAllProjects?n:c);s.resolve({entityTypes:i,entityStates:u,params:t})})}})}}),s},search:function(t){return e.defaults(t,this.defaultParams),{done:e.bind(function(r){var n;e.isFunction(r)?(n=a.Deferred(),n.always(r)):n=r,n.always(this.$dSearch.notify);var s=this.getSuitableCommand(t.searchString);new s(this.configurator,t,n).execute()},this)}},getSuitableCommand:function(a){return n.getSuitableCommand(a)}});return s});