define(["jQuery","Underscore","tau/core/class","tau/core/event2","tau/services/service.help-scenario-runner","tau/services/help-scenarios"],function(e,t,n,r,i,o){var s=n.extend({_defaultsScenarios:function(){this.currentSectionId=-1,this.scenarios=t.deepClone(o.scenarios)},init:function(e){var t=this;t.configurator=e.configurator,t._state=0,t.currentFlowId=null,t._defaultsScenarios(),t.stateTypes={Stopped:0,ToBeStarted:1,InProgress:2,Aborted:3,Done:4}},createBoardFromTemplate:function(n){var r=e.Deferred(),i=this.configurator,o={$where:'publicData.name=="\\"'+n+'\\""',$fields:["key","publicData.name","publicData.definition"],$limit:{start:0,max:50}};return i.getRestStorage().select("boardTemplates",o).done(function(e,n){var i=n.data[0];if(!i)return void r.reject();var o=this.configurator.getBoardDefinitionFactory(),s=o.createForLoggedUser();s.name=i.name,o.createBoard(s).done(function(e){var n=this.configurator.getBoardSettingsFactory().create(e),o=t.extend({isDraft:!1},e,i.definition);n.setDef({set:o}).done(r.resolve)}.bind(this))}.bind(this,r)),r.promise()},setState:function(e){this._state=e},getState:function(){return this._state},run:function(e){var n=this,r=n.getScenarioById(e);n.scenarioRunner=new i({configurator:n.configurator,scenario:r,methods:{setup:o.utils.setup,teardown:o.utils.teardown}}),n.scenarioRunner.on("next",t.bind(n.handleNextStep,n)),n.scenarioRunner.on("done",t.bind(n.handleDoneStep,n)),n.scenarioRunner.start(),n.setState(n.stateTypes.InProgress),n.fire("run.scenario",{scenarioId:e})},abort:function(){this.scenarioRunner&&this.scenarioRunner.abort(),this.setState(this.stateTypes.Aborted),this._defaultsScenarios(),this.fire("abort.scenario")},handleDoneStep:function(){this.markSection("done"),this.setState(this.stateTypes.Done),this.fire("done.scenario",{})},handleNextStep:function(e){var t=e.data,n=t.section.id;this.currentSectionId!=n&&(this.markSection("done"),this.currentSectionId=n,this.markSection("active"),this.fire("next.section",{})),this.fire("next.step",{})},markSection:function(e){var t=this.getScenarioById(this.currentFlowId).sections[this.currentSectionId];t&&(t.state=e)},getAvailableFlows:function(){return t.toObject(this.scenarios,"id")},setCurrentFlow:function(e){this.currentFlowId=e},getCurrentFlow:function(){return this.currentFlowId},getScenarios:function(){return t.map(this.scenarios,t.identity)},checkScenarioPrerequisites:function(e,n){var r=n.requiredProject,i=t.contains(e.selectedProjectIds||[],n.requiredProject),o=t.contains(t(e.selectedProjects||[]).pluck("name"),n.requiredProjectName);return!r||i&&o},getScenarioById:function(e){var n=this.scenarios[e]||{};return t.defaults(n,{sections:[]})},getSubFlows:function(e){var n=this.getScenarioById(e);return t(n.sections).map(function(e,t){return{id:t,name:e.name,state:e.state}})}});return r.implementOn(s.prototype),s});