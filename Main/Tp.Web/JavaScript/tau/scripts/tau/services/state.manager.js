define(["Underscore","tau/core/class"],function(e,t){var a=function(){},i=t.extend({init:function(e){e=e||{};var t=[];if(e.state||t.push("state"),e.service||t.push("service"),t.length>0)throw"State manager should be initialized with following parameters: ["+t.join(",")+"]";this.subscriptions={},this.cfg=e},get:function(t){var i=this;if(!t.id)throw"StateManager.get operation requires parameter [id]";var r=e.defaults(t,{fields:[],callback:a}),n=this.cfg.service;return n.get(r),i},set:function(t){var i=this;if(!t.id)throw"StateManager.set operation requires parameter [id]";var r=e.defaults(t,{set:{},callback:a}),n=this.cfg.service;return n.set(r),i},update:function(t){var a=this,i=this.cfg.state,r=[];e(t).chain().keys().each(function(n){r.push(n);var s=i[n]||{},c=t[n];if(!e.isString(c)&&!e.isString(s)){var l=e(s).keys(),u=e(c).keys();e(e.union(l,u)).each(function(t){if(!e.isEqual(c[t],s[t])){var i=s.hasOwnProperty(t)?s[t]:null,r=c.hasOwnProperty(t)?c[t]:null;a.applyChanges({paramId:n,fieldName:t,value:r,delta:{prev:i,curr:r}})}})}}),e(i).chain().keys().difference(r).each(function(t){var r=i[t];e.isString(r)||e(r).chain().keys().each(function(e){a.applyChanges({paramId:t,fieldName:e,value:null,delta:{prev:r[e],curr:null}})})}),a.cfg.state=t},applyChanges:function(t){for(var a=this.subscriptions,i=e.clone((a[t.paramId]||{})[t.fieldName]||[]),r=0,n=i.length;n>r;r++){var s=i[r];s&&!s.isDeleted&&s.callback.call(s.scope,t)}},bind:function(e){var t=e.paramId,a=e.fieldName,i=e.callback,r=e.listener,n=this.subscriptions;return n[t]=n[t]||{},n[t][a]=n[t][a]||[],n[t][a].push({callback:i,scope:r}),this},unbind:function(t){for(var a=this.subscriptions,i=e(a).keys(),r=0,n=i.length;n>r;r++){for(var s=i[r],c=e(a[s]).keys(),l=0,u=c.length;u>l;l++){for(var o=c[l],h=a[s][o],f=h.length-1;f>=0;f--)h[f].scope===t&&(h[f].isDeleted=!0,h.splice(f,1));0===a[s][o].length&&delete a[s][o]}0===e(a[s]).keys()&&delete a[s]}}});return i});