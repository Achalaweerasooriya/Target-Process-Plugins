define(["Underscore","tau/core/class"],function(e,t){var a=function(){},i=t.extend({init:function(e){if(e=e||{},!e.state||!e.service)throw"State manager should be initialized with state and service parameters";this.subscriptions={},this.cfg=e},get:function(t){if(!t.id)throw"StateManager.get operation requires parameter [id]";var i=e.defaults(t,{fields:[],callback:a});return this.cfg.service.get(i),this},set:function(t){if(!t.id)throw"StateManager.set operation requires parameter [id]";var i=e.defaults(t,{set:{},callback:a});return this.cfg.service.set(i),this},update:function(t){var a=this,i=this.cfg.state,r=[];e.each(t,function(n,s){r.push(s);var c=i[s]||{},l=t[s];if(!e.isString(l)&&!e.isString(c)){var u=e.keys(c),o=e.keys(l),f=e.union(u,o);e.each(f,function(t){if(!e.isEqual(l[t],c[t])){var i=c.hasOwnProperty(t)?c[t]:null,r=l.hasOwnProperty(t)?l[t]:null;a.applyChanges({paramId:s,fieldName:t,value:r,delta:{prev:i,curr:r}})}})}}),e.chain(i).keys().difference(r).each(function(t){var r=i[t];e.isString(r)||e.each(r,function(e,i){a.applyChanges({paramId:t,fieldName:i,value:null,delta:{prev:e,curr:null}})})}),this.cfg.state=t},applyChanges:function(t){for(var a=this.subscriptions[t.paramId]||{},i=e.clone(a[t.fieldName]||[]),r=0,n=i.length;n>r;r++){var s=i[r];s&&!s.isDeleted&&s.callback.call(s.scope,t)}},bind:function(e){var t=e.paramId,a=e.fieldName,i=e.callback,r=e.listener,n=this.subscriptions;return n[t]=n[t]||{},n[t][a]=n[t][a]||[],n[t][a].push({callback:i,scope:r}),this},unbind:function(t){for(var a=this.subscriptions,i=e.keys(a),r=0,n=i.length;n>r;r++){for(var s=i[r],c=e.keys(a[s]),l=0,u=0,o=c.length;o>u;u++){for(var f=c[u],h=a[s][f],d=h.length-1;d>=0;d--)h[d].scope===t&&(h[d].isDeleted=!0,h.splice(d,1));0===h.length&&(delete a[s][f],l++)}l===o&&delete a[s]}}});return i});