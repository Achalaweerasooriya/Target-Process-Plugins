define(["require","jQuery","Underscore","tau/core/class"],function(t){var e=t("jQuery"),i=t("Underscore"),s=t("tau/core/class");return s.extend({init:function(t){this._configurator=t.configurator,this._store=t.configurator.getStore(),this._entity=t.entity,this.onReset=i.Callbacks(),this.resetCache(),this._subscribeOnStore(t.customFields)},getCustomFields:function(){return this._customFields?e.Deferred().resolve(this._customFields):(this._currentCall||(this._currentCall=e.when(this._store.getDef(this._entity.entityType.name,{id:this._entity.id,fields:["id","customFields"]}),function(){var t=this._entity.entityType.name,e="time"!==t.toLowerCase()&&"teamiteration"!==t.toLowerCase()?")&id="+this._entity.id:")";return this._configurator.getStore2().findAll([t,"?select=(customValues)&where=(id==",this._entity.id,e].join(""))}.bind(this)()).then(function(t,e){return this._customFields=e.length?e[0].customFields:[],this._customFields}.bind(this))),this._currentCall)},resetCache:function(){this._customFields=null,this._currentCall=null},destroy:function(){this._store.unbind(this)},_subscribeOnStore:function(t){var e=i.filter(t,function(t){return t.entityKind.toLowerCase()===this._entity.entityType.name.toLowerCase()}.bind(this));e.length>0&&this._store.on({eventName:"afterSave",type:this._entity.entityType.name,listener:this,filter:{id:this._entity.id}},i.debounce(function(t){this._isNeedApplyChange(t)&&(this.resetCache(),this.getCustomFields().done(function(){this.onReset.fire()}.bind(this)))}.bind(this),100,!0))},_isNeedApplyChange:function(t){var e=i.keys(t.data.changes);return!(!(e.length>0)||1===e.length&&"modifyDate"===e[0]||1===e.length&&"customFields"===e[0]&&0===t.data.changes.customFields.length||t.data.changes.teamStates)}})});