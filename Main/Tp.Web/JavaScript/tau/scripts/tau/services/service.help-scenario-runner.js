define(["jQuery","Underscore","tau/core/class","tau/core/event"],function(t,e,s,n){var i=s.extend({init:function(){this.data={}},get:function(t){return this.data[t]},set:function(t,e){this.data[t]=e}}),o=s.extend({init:function(t){var s=this;s.configurator=t.configurator,s.globalBus=t.configurator.getGlobalBus(),s.scenarioContext=new i,s.general_setup=t.methods.setup,s.general_teardown=t.methods.teardown,s._defaultsStep();var n=e.deepClone(t.scenario);s.scenario=e(n.sections).reduce(function(t,s,n){var i={id:n,name:s.name};return e(s.steps).each(function(t){t.section=i}),t.concat(s.steps)},[]),s.processStep=e.bind(s.processStep,s)},_defaultsStep:function(){var t=this;t.step=null,t.stepIndex=-1,t.stepTargetDefer=null,t.stepCompleteDefer=null},next:function(){this.stepIndex++,this.step=this.scenario[this.stepIndex],this.step?(e.defaults(this.step,{teardown:t.noop,rollbackDepth:1,scenarioContext:this.scenarioContext,configurator:this.configurator}),this.stepTargetDefer=this.step.target(this.step),this.stepTargetDefer.done(this.processStep)):(this._defaultsStep(),this.fire("done"))},processStep:function(t){this.fire("next",this.step);var s=this.general_setup(t,this.step),n=e.bind(this.rollbackStep,this,s),i=e.bind(this.completeStep,this,s);this.stepCompleteDefer=this.step.complete(s).fail(n).done(i)},rollbackStep:function(t,e){this._teardownContext(t),e?(this._defaultsStep(),this.fire("abort")):(this.fire("rollback",this.step),this.stepIndex-=this.step.rollbackDepth,this.next())},completeStep:function(t){this._teardownContext(t),this.next()},_teardownContext:function(t){this.step.teardown(t),this.general_teardown(t)},start:function(){this.next()},abort:function(){this.stepTargetDefer&&this.stepTargetDefer.reject(),this.stepCompleteDefer&&this.stepCompleteDefer.reject(!0)}});return n.implementOn(o.prototype),o});