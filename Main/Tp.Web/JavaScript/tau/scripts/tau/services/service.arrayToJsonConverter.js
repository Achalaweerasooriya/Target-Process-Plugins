define(["Underscore","tau/core/header","tau/services/formatProperties"],function(a,b,c){return{convertArray:function(c,d){var e=this,f=[],g=[];return d.next&&g.push(b.getNextPage(f,d.next,c.header)),d=d.items?d.items:d,a.each(d,function(a){var b=e.convert(c,a);f.push(b.data),g=g.concat(b.nextPages)}),{data:f,nextPages:g}},convert:function(d,e){var f={},g=this,h=[];for(var i=0,j=d.header.length;i<j;i++){var k=e[i];a.isUndefined(k)&&(k=null);var l=d.header[i];if(b.header.isSimple(l)){c.hasOwnProperty(l)&&(k=b.formatObject(k).data),f[l]=k;continue}var m=b.header.getFieldName(l),n=l.list===!0;!a.isNull(k)&&(k.hasOwnProperty("items")||k.hasOwnProperty("Items"))&&(n=!0);if(a.isEmpty(k)&&!n){f[m]=null;continue}if(!a.isNull(k)){var o={header:l[m]},p=k;if(k.hasOwnProperty("items")||k.hasOwnProperty("Items"))k=k.items||k.Items;if(n){var q=[];a.each(k,function(a){var b=g.convert(o,a);h=h.concat(b.nextPages),q.push(b.data)}),k=q,p.next&&h.push(b.getNextPage(q,p.next,o.header))}else{var r=g.convert(o,k);h=h.concat(r.nextPages),k=r.data}}a.isNull(k)&&n&&(k=[]),f[m]=k}return{data:f,nextPages:h}}}})