define(["Underscore","jQuery","tau/core/class","./comet.subscription"],function(t,i,n,e){return n.extend({TIMEOUTS:[5,10,20,60,120,300],CONNECTED:"connected",DISCONNECTED:"disconnected",init:function(n,e){this._cometConnection=n,this._activityService=e,this._subscriptions=[],this._reconnectAttempt=0,this._started=i.Deferred(),this._reconnectTimeout=null,this._reconnectNotificationInterval=null,this._secondsTillReconnect=0,this.state=this.CONNECTED,this.refreshRequired=t.Callbacks(),this.connecting=this._cometConnection.connecting,this.connected=this._cometConnection.connected,this.disconnected=this._cometConnection.disconnected,this.start(function(t){this._started.resolve(t),this.connected.add(this._onConnected,this),this.disconnected.add(this._onDisconnected,this)}.bind(this))},_onConnected:function(){this._subscribeRefreshOnInactivity(),this._reconnectAttempt=0,this.state=this.CONNECTED,t.each(this._subscriptions,this._renewSubscription,this)},_renewSubscription:function(t){var i=this._subscribe(t.type,t.params);t.id=i.id,t.subscription=i.subscription},_onDisconnected:function(){this._clearRefreshOnInactivitySubscription(),this._clearReconnectTimeout(),this.state=this.DISCONNECTED,this._secondsTillReconnect=this._calculateNextTimeout(),this._reconnectTimeout=window.setTimeout(this.start.bind(this),1e3*this._secondsTillReconnect),this._reconnectNotificationInterval=window.setInterval(function(){this._secondsTillReconnect--,this._secondsTillReconnect<0&&this._clearReconnectNotificationInterval()}.bind(this),1e3)},_subscribeRefreshOnInactivity:function(){var t=6e4;this._inactivePromise=this._activityService.inactive(t).always(function(){this._inactivePromise=null}.bind(this)).done(function(){this.refreshRequired.fire()}.bind(this))},_clearRefreshOnInactivitySubscription:function(){this._inactivePromise&&this._inactivePromise.reject()},_calculateNextTimeout:function(){return this._reconnectAttempt++,this.TIMEOUTS[Math.min(this._reconnectAttempt,this.TIMEOUTS.length)-1]
},_clearReconnectTimeout:function(){this._reconnectTimeout&&(window.clearTimeout(this._reconnectTimeout),this._reconnectTimeout=null),this._clearReconnectNotificationInterval()},_clearReconnectNotificationInterval:function(){this._reconnectNotificationInterval&&(window.clearInterval(this._reconnectNotificationInterval),this._reconnectNotificationInterval=null)},start:function(t){this._cometConnection.startAsync(t),this._clearReconnectTimeout()},secondsTillReconnect:function(){return this._secondsTillReconnect},subscribe:function(i,n){var e=this._subscribe(i,n);return this._subscriptions.push(e),{id:e.id,stop:function(i){var n=t.findWhere(this._subscriptions,{id:e.id});n&&(this._subscriptions=t.without(this._subscriptions,n),this._unsubscribe(i,n))}.bind(this)}},whenStarted:function(){return this._started},removeEventHandlers:function(t){this.connected.remove(t),this.connecting.remove(t),this.disconnected.remove(t),this.refreshRequired.remove(t)},_subscribe:function(i,n){var s={id:t.uniqueId(),type:i,params:n,subscription:new e(i,n.parameters).on(t.pick(n,"callback","batchCallback","clientId"))};return this.whenStarted().then(function(t){s.subscription.setSubscriber(t.createSubscriber(i))}),s.subscription.start(function(){n.started&&n.started(s)}),s},_unsubscribe:function(t,i){i&&i.subscription.stop(t)},destroy:function(){t.each(this._subscriptions,this._unsubscribe.bind(this,null)),this._subscriptions=null,this.removeEventHandlers(this)}})});