define(["require","jQuery","Underscore","tau/core/class","./comet.subscriber"],function(n){var i=n("jQuery"),e=n("Underscore"),t=n("tau/core/class"),c=n("./comet.subscriber");return t.extend({init:function(n){this._featureService=n,this._callbacksAsyncProxyDisconnected=i.Callbacks(),this._$asyncProxyStarted=i.Deferred(),this._lockOpenForInitialization=!0,this.disconnectedOnce=this._callbacksAsyncProxyDisconnected.add,this._namespace=".cometConnection"+e.uniqueId(),i(window).on("beforeunload"+this._namespace,function(){this._callbacksAsyncProxyDisconnected.disable()}.bind(this))},startAsync:function(e){this._featureService.isEnabled("comet.notifications")&&(e=e||i.noop,this._$asyncProxyStarted.done(e),this._lockOpenForInitialization&&(this._lockOpenForInitialization=!1,n(["tp/serverNotifications"],function(n){n&&(n.disconnected(function(){this._lockOpenForInitialization=!0,this._$asyncProxyStarted=i.Deferred(),this._callbacksAsyncProxyDisconnected.fire().empty()}.bind(this)),n.start(function(){var i={createSubscriber:function(i){return new c(i,n)}};this._$asyncProxyStarted.resolve(i)}.bind(this)))}.bind(this))))},clearSubscriptions:function(){this._callbacksAsyncProxyDisconnected.empty()},destroy:function(){this.clearSubscriptions(),i(window).off(this._namespace)}})});