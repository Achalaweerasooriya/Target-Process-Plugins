define(["require","jQuery","Underscore","tau/core/class","./comet.subscriber"],function(e){var t=e("jQuery"),i=e("Underscore"),n=e("tau/core/class"),s=e("./comet.subscriber");return n.extend({init:function(e){this._featureService=e,this.disconnected=i.Callbacks(),this.connected=i.Callbacks(),this.connecting=i.Callbacks(),this._$asyncProxyStarted=t.Deferred(),this._lockOpenForInitialization=!0,this._eventNamespace=".cometConnection"+i.uniqueId(),t(window).on("beforeunload"+this._eventNamespace,this.clearSubscriptions.bind(this))},startAsync:function(i){this._featureService.isEnabled("comet.notifications")&&(i=i||t.noop,this._$asyncProxyStarted.done(i),this._lockOpenForInitialization&&(this._lockOpenForInitialization=!1,this.connecting.fire(),e(["tp/serverNotifications"],function(e){e.disconnected.once(function(){this._lockOpenForInitialization=!0,this._$asyncProxyStarted=t.Deferred(),this.disconnected.fire().remove(this)},this),e.start(function(){var t={createSubscriber:function(t){return new s(t,e)}};this.connected.fire(),this._$asyncProxyStarted.resolve(t)}.bind(this))}.bind(this))))},clearSubscriptions:function(){this.connecting.remove(this),this.connected.remove(this),this.disconnected.remove(this)},destroy:function(){this.clearSubscriptions(),t(window).off(this._eventNamespace)}})});