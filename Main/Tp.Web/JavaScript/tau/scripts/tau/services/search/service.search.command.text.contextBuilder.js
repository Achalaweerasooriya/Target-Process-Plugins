define(["jQuery","Underscore","tau/core/class"],function(e,t,n){var r=n.extend({init:function(e,t){this.configurator=e,this.params=t},getContextPromise:function(){var n=e.Deferred();return this._getInitialContextPromise().done(t.bind(function(r){var s=e.Deferred(),i=e.Deferred(),o=this.configurator.getStore(),a=t.difference(r.selectedProjectIds,r.selectedProjectIdsAvailable),c=t.difference(r.selectedTeamIds,r.selectedTeamIdsAvailable),l=r.isAllProjects?r.selectedTeamIds:c;l=t.without(l,"null");var d=r.isAllTeams?r.selectedProjectIds:a;d=t.without(d,"null");var u=0!==l.length,f=0!==d.length;u?o=this._handleTeams(o,l,s):s.resolve({}),f?o=this._handleProjects(o,d,i):i.resolve({}),(u||f)&&o.done(),e.when(s,i).then(function(e,s){var i={},o=function(e,n){var r=t.union(i[n]||[],e);r.length&&(i[n]=r)};t.each(e,o),t.each(s,o),r.teamProjectRelations=t(i).chain().keys().reduce(function(e,n){n=parseInt(n,10);var s=e[n];return(r.isAllProjects||r.isAllTeams)&&t.contains(r.selectedTeamIdsAvailable,n)?s=t.difference(s,r.selectedProjectIdsAvailable):r.isAllTeams&&!t.contains(r.selectedTeamIdsAvailable,n)||(t.contains(c,n)?s=t.intersection(s,r.selectedProjectIds):t.contains(r.selectedTeamIdsAvailable,n)?s=t.intersection(s,a):(s=[],delete e[n])),s.length?e[n]=s:delete e[n],e},i).value(),n.resolve(r)})},this)),n.promise()},_getInitialContextPromise:function(){var n=this.configurator.getApplicationContextService(),r=this.configurator.getLoggedUser(),s=e.Deferred(),i=e.Deferred(),o=e.Deferred(),a=e.Deferred(),c=this.params.isAllProjects,l=this.params.isAllTeams;if(c?e.when(a).done(function(e){var n=t(e.projects).pluck("id");s.resolve({isAllProjects:!0,includeNoProject:!0,selectedProjectIds:n,selectedProjectIdsAvailable:n})}):e.when(o).done(function(e){s.resolve({includeNoProject:e.appContext.projectContext.no,selectedProjectIds:e.selectedProjectIds,selectedProjectIdsAvailable:e.selectedProjectIdsAvailable})}),l?e.when(a).done(function(e){var n=t(e.teams).pluck("id");i.resolve({isAllTeams:!0,includeNoTeam:!0,selectedTeamIds:n,selectedTeamIdsAvailable:n})}):e.when(o).done(function(e){i.resolve({includeNoTeam:e.appContext.teamContext.no,selectedTeamIds:e.selectedTeamIds,selectedTeamIdsAvailable:e.selectedTeamIdsAvailable})}),(c||l)&&n.getTeamsProjectsAvailable(r.id).done(a.resolve),!c||!l){var d=this.configurator.getAppStateStore();d.get({fields:["acid"]}).then(function(e){return n.getApplicationContext({acid:e.acid})}).done(o.resolve)}return e.when(s,i).then(function(e,n){return t.extend(e,n)})},_handleTeams:function(e,n,r){return e=e.find("teams",{fields:["id",{teamProjects:["id",{project:["id"]}]}],$query:{id:{$in:n}},list:!0},{success:function(e){var n=e.data,s=t(n).reduce(function(e,n){var r=t(n.teamProjects).map(function(e){return e.project.id});return r.length&&(e[n.id]=r),e},{});r.resolve(s)}})},_handleProjects:function(e,n,r){return e=e.find("projects",{fields:["id",{teamProjects:["id",{team:["id"]}]}],$query:{id:{$in:n}},list:!0},{success:function(e){var n=e.data,s=t(n).reduce(function(e,n){var r=t(n.teamProjects).map(function(e){return e.team.id});return e=t(r).reduce(function(e,t){return e[t]=e[t]||[],e[t].push(n.id),e},e)},{});r.resolve(s)}})}});return r});