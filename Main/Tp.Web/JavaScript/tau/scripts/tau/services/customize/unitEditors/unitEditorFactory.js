define(["require","tau/core/class","jQuery","Underscore","./unitEditorConfigs","./adapters/editor.adapter.default","./unitEditorView","./unitEditorEventHandler","./editor.utils"],function(t){var e=t("tau/core/class"),i=t("jQuery"),n=t("Underscore"),r=t("./unitEditorConfigs"),o=t("./adapters/editor.adapter.default"),a=t("./unitEditorView"),d=t("./unitEditorEventHandler"),u=t("./editor.utils");return e.extend({init:function(t,e,i){this._configurator=t,this._bus=e,this._editorEventHandler=i||new d},createEditorView:function(t){return this._withProgressIndicator(t.$unit,function(){var e=t.unit,i=t.unitEditorType,r=n.extend({type:i},t.unitEditorOptions),d=t.cardDataForUnit,u=t.$unit,s=t.$card,c=s.data("entityType"),l={id:s.data("entityId"),entityType:{name:c},type:c},f=this._getEditorDescriptionFor(i),p=f.adapter||o,h=new p,b=h.adaptEditorData(e,d),g=this._createBubbleConfigOptions(f,u,s),E={entity:l,configurator:this._configurator};return h.adaptComponentContext(E).then(function(t){var i=this._createComponentConfig(r,t,b,u,g),n=this._configurator.getComponentBuilder();return n.createAsChild(i,this._bus).then(this._initBubble.bind(this,h,t,u)).then(function(t){h.startEdit(t,f.adapterConfig);var i=new a(e,s,u,h);return this._editorEventHandler.wireUpNewUnitEditorView(i),i}.bind(this))}.bind(this))})},_withProgressIndicator:function(t,e){var i=n.delay(function(){u.toggleElementBusyIndicator(t,!0)},200);return e.call(this).always(function(e){return clearTimeout(i),u.toggleElementBusyIndicator(t,!1),e})},_getEditorDescriptionFor:function(t){var e=n.find(r,function(e,i){return n.startsWith(t,i)});return n.extend({},r.defaults,e)},_initBubble:function(t,e,n,r){var o,a=i.Deferred(),d=i.Deferred();return r.once("childrenBuses.ready",function(e,i){o=i[0],t.createEditableElement(o).then(function(){d.resolve(t)})}),r.once("$bubbled.ready",function(t,e){o.fire("$outerBubbled.ready",e),a.resolve(e)}),r.initialize({context:e}),r.fire("view.dom.ready"),r.fire("$trigger.ready",n),i.when(a,d)
},_createBubbleConfigOptions:function(t,e,i){var r=i.closest(".i-role-unit-editor-popup-append-target"),o=r.length?r:i;return n.extend({appendTo:o,within:this._findEditorContainer(e),className:t.className,showArrow:!1,template:['<div class="tau-bubble tau-bubble-newlist-editor" style="',t.maxWidth?" max-width: "+e.width()+"px;":"",t.minWidth?" min-width: "+e.outerWidth()+"px;":"",'">','<div class="tau-bubble__inner" role="content"></div>',"</div>"].join(""),onPositionConfig:function(e){e.my="left "+t.positionVertical,e.at="left "+t.positionVertical,e.collision="flipfit flipfit"}},t.bubbleConfig)},_createComponentConfig:function(t,e,i,r,o){var a=n.extend({},t,{context:e,extensions:[],data:i,$within:this._findEditorContainer(r)});return{type:"bubble.container",visible:!0,children:[a],extensions:[],options:o}},_findEditorContainer:function(t){return t.closest(".i-role-unit-editor-popup-position-within")}})});