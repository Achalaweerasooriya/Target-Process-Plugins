define(["Underscore","tau/core/class","tau/utils/utils.base64hashEncoder","tau/models/board.customize.units/board.customize.units.customFields","tau/services/customize/templateRegistrators/cardTemplateRegistrator","tau/services/customize/templateRegistrators/listTemplateRegistrator","tau/services/customize/service.customize.units.customField.sampleData","tau/services/customize/service.customize.units.helper"],function(e,t,i,s,n,r,a,u){return t.extend({prefix:"custom_field__",init:function(e){this.unitIdRegex=new RegExp("^"+this.prefix+"(.+?)__(.+)$","i"),this.unitsHelper=new u([new n,new r]),this.units=this.register(s),this.configurator=e},register:function(t){return e.object(e.map(t,e.bind(function(e){return this.unitsHelper.processSettings(e),this.unitsHelper.processIsApplicable(e),this.unitsHelper.processCustomFunctions(e),this.unitsHelper.processTemplates(e),[e.id,e]},this)))},getUnitById:function(e){var t=this.unitIdRegex.exec(e);if(null===t)return null;var s=t[1],n=t[2],r=this.units[this.prefix+s+"__{{name}}"];return r?this.createUnit(r,i.decodeName(n)):this.units[e]},createUnit:function(t,s){var n=e.deepClone(t);return this.unitsHelper.processSettings(n,function(e){return e.replace("{{name}}",s)}),this.unitsHelper.processIsApplicable(n),n.name=s+" custom field",n.sampleData.cf.name=s,n.sampleData.cf.value=this._prepareSampleValue(n.sampleData.cf.value,s),n.id=n.id.replace("{{name}}",i.encodeName(s.toLowerCase())),n},_prepareSampleValue:function(t,i){var s,n=function(t){return e.isString(t)?t.replace("{{name}}",i):t};return e.isString(t)?s=n(t):(s=e.deepClone(t),t.name?s.name=n(t.name):t.label?s.label=n(t.label):t.value&&(s.value=n(t.value))),s},_createUnitsFromCustomField:function(t){var i=t.name,s=t.type.toLowerCase();return e.chain(this.units).filter(function(t){return e.contains(t.customFieldTypes,s)}).map(e.bind(function(e){var n=this.createUnit(e,i);return n.sampleData.cf.value=this._prepareSampleValue(a[s],i),n.sampleData.cf.type=s,n.types=[t.entityKind.toLowerCase()],n.settings[0].types=n.types,n},this)).value()},_getCustomFields:function(){var t=this.configurator;return t.getAppStateStore().get({fields:["acid"]}).then(function(e){return t.getApplicationContextService().getApplicationContext({acid:e.acid})}).then(function(t){return e.chain(t.processes).pluck("customFields").flatten().value()})},getAllUnits:function(){return this._getCustomFields().then(e.bind(function(t){return e.chain(t).map(e.bind(this._createUnitsFromCustomField,this)).flatten().groupBy("id").map(this._groupCustomFields).value()},this))},_groupCustomFields:function(t){return e.foldl(t,function(t,i){return t?(t.types=e.unique(t.types.concat(i.types)),t.settings[0].types=t.types):t=i,t},null)}})});