define(["jQuery","Underscore","./service.customize.card.layout.factory","tau/ui/extensions/board.plus/ui.board.plus.utils"],function(t,n,e,i){return e.extend({name:"newlist",createFactory:function(t){return n.bind(function(t,n){var e=this.findSettings(t.cardSettings,n,[this.sizes.LIST]),i=this.getSavedSetting(t.cardSettings,n);return e=this.processOrderAndEmptyFields(e,i)},this,t)},getSavedSetting:function(t,n){var e=i.getListKeyByTypes(n);return t&&t[e]&&t[e].list},_replaceShortUnitsWithLong:function(t){var e=["long","full_length"];return n.map(t,function(t){var i=t,r=/.+_short$/;if(r.test(t.id))for(var u=0;u<e.length;u++){var a=t.id.replace(/(.+)_short$/,"$1_"+e[u]),s=this.findUnitById(a);if(s){i=n.defaults({id:a,unit:s},t);break}}return i}.bind(this))},processOrderAndEmptyFields:function(t,e){var i=this.sizes.LIST,r=function(t){var e=n.countBy(t,function(t){return t.id});return n.each(t,function(t){t.rank=e[t.id],t.unit.rank&&(t.rank=t.unit.rank)}),t},u=function(t,e){var i=e[0].reverse();return n.each(t,function(t){for(var n=0;n<i.length;n++)if(t.id==i[n].id){t.rank=n;break}}),t},a=n.chain(t).map(function(t){return t[i]}).flatten().value();a=e?u(a,e):r(a);var s=n.chain(a).flatten().unique(function(t){return t.id}).value();return n.reduce(t,function(t,e,r){return t[r]=n.filter(s,function(t){return t.unit.isApplicableByTypeAndSize(r,i)}),0===t[r].length&&(t[r]=[{id:"name_unit_default",unit:this.findUnitById("name_unit_default"),isDefault:!0}]),t[r]=this._replaceShortUnitsWithLong(t[r]),t}.bind(this),{})}})});