define(["require","tau/core/class","Underscore","./context.menu.items/separator","template!./templates/context.menu.template"],function(e){var t=e("tau/core/class"),n=e("Underscore"),i=e("./context.menu.items/separator"),o=e("template!./templates/context.menu.template");return t.extend({_isElementVisible:n.abstractMethod,_getContainerSelector:n.abstractMethod,_getScrollContainerSelector:n.abstractMethod,_createSeparator:function(){return new i},_showMenu:function(e,t){var i=n.filter(e,function(e){return!e.shouldRender||e.shouldRender(t)});i=this._normalizeSeparators(i);var o=t.$target,r=[];t.destroyBubble=function(){n.each(r,function(e){e()}),r=[],o.removeClass("t3-opened"),o.data("ui-tauBubble")&&o.tauBubble("destroy")},t.hideBubble=function(){o.data("ui-tauBubble")&&o.tauBubble("hide")},t.whenDestroyed=function(e){r.push(e)};var a=this._initBubble(t,i,o.closest(this._getContainerSelector()));n.each(i,this._initMenuItemEvents.bind(this,t,a)),this._initMenuEvents(t)},_initMenuItemEvents:function(e,t,n){var i="."+n.getMenuItemClassName(e).replace(" ",".");if(n.whenRendered){var o=t.find(i);n.whenRendered(e,o)}n.actionHandler&&t.on("click",i,function(){n.actionHandler(e),e.hideBubble()}.bind(this))},_initMenuEvents:function(e){var t=e.$target,n=function(){t.data("ui-tauBubble")&&(this._isElementVisible(t)?t.tauBubble("adjust"):e.destroyBubble())}.bind(this),i=t.closest(this._getScrollContainerSelector());i.on("scroll",n),t.on("taububbledestroy",function(){i.off("scroll",n)})},_initBubble:function(e,t,i){return e.destroyBubble(),e.$target.tauBubble(n.extend({appendTo:i,showArrow:!1,content:this._getMenuContent(e,t),onPositionConfig:function(e){e.my="left top",e.at="right top"},onShow:function(){e.$target.addClass("t3-opened")},onHide:function(t,n){n.preventDefault&&n.preventDefault(),e.destroyBubble()},template:['<div class="tau-bubble t3-views-navigator-bubble">','    <div class="tau-bubble__inner" role="content"></div>',"</div>"].join(""),zIndex:999},e.options)),e.$target.tauBubble("show"),i.find(".tau-bubble")
},_getMenuContent:function(e,t){var i=n.map(t,function(t){return{menuItem:t,menuConfig:e}});return o.render({menuItems:i})},_normalizeSeparators:function(e){var t=n.reduce(e,function(e,t){if(t instanceof i){if(!e.length)return e;if(n.last(e)instanceof i)return e}return e.push(t),e},[]);return n.last(t)instanceof i&&t.splice(t.length-1,1),t}})});