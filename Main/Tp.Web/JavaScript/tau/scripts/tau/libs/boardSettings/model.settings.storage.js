define(["Underscore","jQuery","tau/core/class"],function(e,t,i){var n=function(t,i){var n=new Array(t.length);return function(s){var r=s.uid;n[r]=s.data,t=e.without(t,r),0===t.length&&i(n)}},s=function(e,t){return function(i){e.callback(i),t.resolve(i)}};return i.extend({init:function(i,n){this.settings=e.defaults(i,{cache:!0}),this.sources=n,this.callbacksMap=[],this.responses=[],this.fieldsRetrieved=[],this.onChange=t.Callbacks(),this.commonCallback=e.bind(function(e,t){var i=this.mergeChanges(e.data,t);if(null!==i){var n=e.cmd||{};this._onBeforeRetrieve(i),this.applyCallback(i,n.isSilent)}},this)},getGroupName:function(){return this.settings.groupName},applyCallback:function(t,i){for(var n=e.keys(t),s=e.clone(this.callbacksMap),r=0;r<s.length;r++){var a=s[r];a.isDeleted||i&&!a.skipSilentCallsFiltering||!this.matchCommandCallback(n,a)||a.callback.call(a.listener,t)}},matchCommandCallback:function(t,i){var n=i.fields;return e.any(t,function(t){return e.indexOf(n,t)>=0})},each:function(t,i){this.sources.length?e.each(this.sources,t):i&&i()},mergeChanges:function(t,i){for(var n=this.settings,s=e.keys(t),r=null,a=0;a<s.length;a++){var l=s[a];this.markFieldsRetrieved(l);var c=t[l];if(!e.isEqual(n[l],c)){r=r||{};var o=e.cloneDeep(c);e.isNumber(i)&&(this.responses[i]=this.responses[i]||{},this.responses[i][l]=o,o=this.getField(l)),r[l]=n[l]=o}}return r},_isValue:function(t){return!e.isNull(t)&&!e.isUndefined(t)&&!e.isNaN(t)},getField:function(e){for(var t=this.responses.length-1;t>=0;t--){var i=this.responses[t][e];if(this._isValue(i))return i}},markFieldsRetrieved:function(t){t=e.isString(t)?[t]:t,this.fieldsRetrieved=e.union(this.fieldsRetrieved,t)},selectNotRetrievedFields:function(t){return this.settings.cache?e.difference(t,this.fieldsRetrieved):t},_cmdDefaults:function(i){e.defaults(i,{callback:t.noop})},_onBeforeRetrieve:function(){},_onBeforeSave:function(){},get:function(i){e.isArray(i)&&(i={fields:i}),this._cmdDefaults(i);var r=t.Deferred(),a=s(i,r),l=this.settings,c={},o=e.range(this.sources.length),u=this.selectNotRetrievedFields(i.fields),h=this,f=function(i){h.markFieldsRetrieved(u),e.each(i,function(t,i){h.responses[i]=e.extend(h.responses[i]||{},t);for(var n=0;n<u.length;n++){var s=u[n],r=null===t[s]?l[s]:t[s];h._isValue(r)&&(c[s]=r)}}),e.extend(l,c);var n={};t.extend(!0,n,l),this._onBeforeRetrieve(n),a(n)}.bind(this);if(0===u.length)f([]);else{var d=n(o,f);this.each(function(e,t){e.get({uid:t,fields:u,callback:d})},function(){f([])})}return r},set:function(i){var r=e.cloneDeep(i.set);this._onBeforeSave(r),this._cmdDefaults(i);var a=t.Deferred(),l=s(i,a),c=this.sources,o=e.range(c.length),u=function(){},h=n(o,u),f=this.mergeChanges(r);this.each(function(e,t){e.set({uid:t,set:r,callback:function(e){h.call(this,e,t)}})},function(){u([])}),null!==f&&(this._onBeforeRetrieve(f),this.onChange.fire(f),this.applyCallback(f,i.isSilent));var d=e.clone(this.settings);return this._onBeforeRetrieve(d),l(d),a},setDef:function(i){var n=e.cloneDeep(i.set);this._onBeforeSave(n);var s=this.sources;return t.when.apply(null,e.map(s,function(e){var i=t.Deferred();return e.set({uid:0,set:n,callback:i.resolve}),i})).done(e.bind(function(){this.commonCallback({data:n,cmd:i})},this))},registerSubscription:function(e){return this.callbacksMap.push(e),this.commonCallback},unregisterSubscription:function(t){this.callbacksMap.length&&(this.callbacksMap=e.reject(this.callbacksMap,function(e){var i=t===e.listener;return i&&(e.isDeleted=!0),i}))},bind:function(e){var t=this.registerSubscription(e);this.each(function(i,n){i.bind({uid:n,fields:e.fields,listener:e.listener,callback:function(e){t.call(this,e,n)}})})},_unbindListener:function(e){var t={listener:e};this.each(function(e){e.unbind(t)})},unbind:function(e){this._unbindListener(e.listener),this.unregisterSubscription(e.listener)},dispose:function(){this._unbindListener(this),this.callbacksMap=[]}})});