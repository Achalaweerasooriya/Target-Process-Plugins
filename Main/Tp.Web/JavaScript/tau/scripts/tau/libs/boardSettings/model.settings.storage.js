define(["Underscore","jQuery","tau/core/class"],function(e,i,t){var n=function(i,t){var n=new Array(i.length);return function(s){var r=s.uid;n[r]=s.data,i=e.without(i,r),0===i.length&&t(n)}},s=function(e,i){return function(t){e.callback(t),i.resolve(t)}};return t.extend({init:function(t,n){this.settings=e.defaults(t,{cache:!0}),this.sources=n,this.callbacksMap=[],this.responses=[],this.fieldsRetrieved=[],this.onChange=i.Callbacks(),this.commonCallback=e.bind(function(e,i){var t=this.mergeChanges(e.data,i);if(null!==t){var n=e.cmd||{};this._onBeforeRetrieve(t),this.applyCallback(t,n.isSilent)}},this)},getGroupName:function(){return this.settings.groupName},applyCallback:function(i,t){for(var n=e.keys(i),s=e.clone(this.callbacksMap),r=0;r<s.length;r++){var a=s[r];a.isDeleted||t&&!a.skipSilentCallsFiltering||!this.matchCommandCallback(n,a)||a.callback.call(a.listener,i)}},matchCommandCallback:function(i,t){var n=t.fields;return e.any(i,function(i){return e.indexOf(n,i)>=0})},each:function(i,t){this.sources.length?e.each(this.sources,i):t&&t()},mergeChanges:function(i,t){for(var n=this.settings,s=e.keys(i),r=null,a=0;a<s.length;a++){var l=s[a];this.markFieldsRetrieved(l);var c=i[l];if(!e.isEqual(n[l],c)){r=r||{};var o=e.cloneDeep(c);e.isNumber(t)&&(this.responses[t]=this.responses[t]||{},this.responses[t][l]=o,o=this.getField(l)),r[l]=n[l]=o}}return r},_isValue:function(i){return!e.isNull(i)&&!e.isUndefined(i)&&!e.isNaN(i)},getField:function(e){for(var i=this.responses.length-1;i>=0;i--){var t=(this.responses[i]||{})[e];if(this._isValue(t))return t}},markFieldsRetrieved:function(i){i=e.isString(i)?[i]:i,this.fieldsRetrieved=e.union(this.fieldsRetrieved,i)},selectNotRetrievedFields:function(i){return this.settings.cache?e.difference(i,this.fieldsRetrieved):i},_cmdDefaults:function(t){e.defaults(t,{callback:i.noop,onReceived:i.noop,failure:i.noop})},_onBeforeRetrieve:function(){},_onBeforeSave:function(){},get:function(t){e.isArray(t)&&(t={fields:t}),this._cmdDefaults(t);var r=i.Deferred(),a=s(t,r),l=this.settings,c={},o=this.selectNotRetrievedFields(t.fields),h=function(n){this.markFieldsRetrieved(o),e.each(n,function(i,t){this.responses[t]=e.extend(this.responses[t]||{},i);
for(var n=0;n<o.length;n++){var s=o[n],r=null===i[s]?l[s]:i[s];this._isValue(r)&&(c[s]=r)}},this),t.skipCacheUpdate||e.extend(l,c);var s={};i.extend(!0,s,l,c),this._onBeforeRetrieve(s),a(s)}.bind(this);if(0===o.length)h([]);else{var u=e.range(this.sources.length),f=n(u,h);this.each(function(e,i){e.get({uid:i,fields:o,callback:f})},function(){h([])})}return r},set:function(t){var r=e.cloneDeep(t.set);this._onBeforeSave(r),this._cmdDefaults(t);var a=i.Deferred(),l=s(t,a),c=this.sources,o=e.range(c.length),h=function(){},u=n(o,h),f=this.mergeChanges(r),d=this;this.each(function(e,i){e.set({uid:i,set:r,_originalBoardData:t._originalBoardData,failure:function(e){d._mergeAndFireChanges(e.data.data,t),l(d.settings),t.failure(e)},callback:function(e){t.onReceived(e),u.call(this,e,i)}})},function(){h([])}),null!==f&&(this._onBeforeRetrieve(f),this.onChange.fire(f),this.applyCallback(f,t.isSilent));var v=e.clone(this.settings);return this._onBeforeRetrieve(v),l(v),a},_mergeAndFireChanges:function(e,i){var t=this.mergeChanges(e);null!==t&&(this._onBeforeRetrieve(t),this.onChange.fire(t),this.applyCallback(t,i.isSilent))},setDef:function(t){var n=e.cloneDeep(t.set);this._onBeforeSave(n);var s=this.sources;return i.when.apply(null,e.map(s,function(e){var t=i.Deferred();return e.set({uid:0,set:n,callback:t.resolve}),t})).done(e.bind(function(){this.commonCallback({data:n,cmd:t})},this))},registerSubscription:function(e){return this.callbacksMap.push(e),this.commonCallback},unregisterSubscription:function(i){this.callbacksMap.length&&(this.callbacksMap=e.reject(this.callbacksMap,function(e){var t=i===e.listener;return t&&(e.isDeleted=!0),t}))},bind:function(e){var i=this.registerSubscription(e);this.each(function(t,n){t.bind({uid:n,fields:e.fields,listener:e.listener,callback:function(e){i.call(this,e,n)}})})},_unbindListener:function(e){var i={listener:e};this.each(function(e){e.unbind(i)})},unbind:function(e){this._unbindListener(e.listener||e),this.unregisterSubscription(e.listener||e)
},dispose:function(){this._unbindListener(this),this.callbacksMap=[]}})});