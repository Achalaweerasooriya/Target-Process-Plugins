define(["Underscore","tau/core/class"],function(e,t){var a=t.extend({init:function(t,a){var i=this;i.restStorage=t,i.options=e.defaults(a||{},{}),i._cache={}},set:function(e,t){this._cache={},this.add(e,t)},add:function(t,a){var i=this,n=this._sanitize(t),c=e.values(i._cache).length;e.forEach(n,function(e){var t=i._createKey(e);i._cache[t]=e}),e.values(i._cache).length!=c&&this._save(i._cache,a)},update:function(t,a){var i=this,n=this._sanitize(t);e.forEach(n,function(e){var t=i._createKey(e);i._cache[t]=e}),this._save(i._cache,a)},remove:function(t,a){var i=this,n=e.values(i._cache).length,c=this._sanitize(t);e.forEach(c,function(e){var t=i._createKey(e);delete i._cache[t]}),e.values(i._cache).length!=n&&this._save(i._cache,a)},removeAll:function(e){self._cache={},this._save([],e)},getAll:function(t){var a=this;this._get(function(i,n){e.forEach(n,function(e){a._cache[a._createKey(e)]=e}),t(i,n)})},unbind:function(e){this.restStorage.unbind({listener:e})},bind:function(e,t){this.restStorage.bind({listener:e,fields:["items"],callback:function(e){t&&t(null,e.items||[])}})},_save:function(t,a){this.restStorage.set({set:{items:e.values(t)},callback:function(e){a&&a(null,e.items)}})},_get:function(e){this.restStorage.get({fields:["items"],callback:function(t){e&&e(null,t.items||[])}})},_sanitize:function(t){var a=this,i=function(t){return t=e.deepClone(t||{}),t=e.pick(t,"id","data","isSelected"),t._id=a._createKey(t),t.data=e.defaults(t.data||{},{id:"",type:""}),t.data.type=t.data.type.toLowerCase(),t};return e.map(e.isArray(t)?t:[t],i)},_createKey:function(e){return"_"+e.data.type+"_"+e.id+"_"}});return a});