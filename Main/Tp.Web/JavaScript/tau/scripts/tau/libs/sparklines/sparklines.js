define(["tau/core/class"],function(Class){return Array.prototype.map&&require(["libs/d3/d3"],function(draw){}),Class.extend({init:function(config){this.config=_.defaults(config,{width:100,height:50,letterWidth:7.5,letterHeight:8,emptyStart:8}),this.config.padding=this.config.padding||this.config.letterHeight+1,this.config.percent=Math.ceil(this.config.height/100)},createDrawData:function(data){var len=data.len||15,currentWeek=data.currentWeek,opened=data.opened,closed=data.closed,drawData=[];for(var week=currentWeek-len;week<=currentWeek;week++){var item={open:0,closed:0},openedItem=_.find(opened,function(item){return week==item.key});item.open=openedItem?openedItem.count:0;var closedItem=_.find(closed,function(item){return week==item.key});item.closed=closedItem?closedItem.count:0,drawData.push(item)}return drawData},draw:function(data,el){var isBugs=!1;if(data===null){var source=$(el).data("source");data=this.createDrawData(source),isBugs=$(el).is(".tau-sparkline-bugs")}var c=this.config,svg=d3.select(el||$("<svg />")[0]).attr("width",c.width).attr("height",c.height),dto=_.pluck(data,"open"),dtc=_.pluck(data,"closed"),maxOpen=Math.max.apply(null,dto),maxClose=Math.max.apply(null,dtc),max=Math.max.apply(null,[maxOpen,maxClose]),legendLength=2;data.length&&(legendLength=Math.max.apply(null,[(""+_.last(dtc)).length,(""+_.last(dto)).length,2]));var legendSpace=legendLength*c.letterWidth,dtcHasEmptyStart=_.all(dtc.slice(0,this.config.emptyStart),function(v){return v==0}),dtoHasEmptyStart=_.all(dto.slice(0,this.config.emptyStart),function(v){return v==0}),hasEmptyStart=dtcHasEmptyStart&&dtoHasEmptyStart;return this.drawTop(svg,{items:dtc,max:max,legendSpace:legendSpace,height:c.height,width:c.width,padding:c.padding,percent:c.percent,emptyStartLabel:hasEmptyStart?isBugs?"fixed":"done":!1}),this.drawBottom(svg,{items:dto,max:max,legendSpace:legendSpace,height:c.height,width:c.width,padding:c.padding,percent:c.percent,emptyStartLabel:hasEmptyStart?"added":!1}),svg[0]},drawTop:function(msvg,config){var dt=config.items,legendSpace=config.legendSpace,max=config.max,height=config.height,width=config.width,padding=config.padding,percent=config.percent,svg=msvg.append("g").attr("transform","translate(0,"+padding+")"),maxData=null,currentValue=null,diffData=null;dt.length&&(maxData=_.reduce(dt,function(memo,v,index){return v>memo.value?{index:index,value:v}:memo},{index:0,value:dt[0]}),maxData.index==dt.length-1&&(maxData=null),currentValue=_.last(dt),diffData=_.reduce(dt,function(memo,v,index){return memo?memo.concat({diff:v-_.last(memo).to,to:v,from:_.last(memo).to}):[{diff:v,to:v,from:0}]},null));var hasEmptyStart=_.all(dt.slice(0,this.config.emptyStart),function(v){return v==0}),scaleX=d3.scale.ordinal().domain(_.keys(dt)).rangeRoundBands([0,width-legendSpace]),scaleWidth=scaleX.rangeBand(),scaleY=d3.scale.linear().domain([0,max]).range([height/2-padding,0]),scaleHeight=d3.scale.linear().domain([0,max]).range([0,height/2-padding]);if(dt.length==0){this.drawAxis(svg,_.extend(config,{scaleY:scaleY}));return}svg.selectAll(".tau-sparkline__openbar").data(dt).enter().append("rect").attr("class","tau-sparkline__openbar").attr("x",function(data,i){return scaleX(i)}).attr("y",scaleY).attr("height",scaleHeight).attr("width",scaleWidth),this.drawAxis(svg,_.extend(config,{scaleY:scaleY})),svg.selectAll(".tau-sparkline__openmark").data(dt).enter().append("rect").attr("class","tau-sparkline__openmark").attr("x",function(data,i){return scaleX(i)}).attr("y",scaleY).attr("height",function(data,i){return data==0?0:percent}).attr("width",scaleWidth),svg.selectAll(".tau-sparkline__diffmark-open").data(diffData).enter().append("rect").attr("class","tau-sparkline__diffmark-open").attr("x",function(data,i){return scaleX(i)-1}).attr("y",function(data){return scaleY(Math.max(data.from,data.to))+(data.diff>0?0:1)}).attr("height",function(data){return scaleHeight(Math.abs(data.diff))}).attr("width",1),maxData&&svg.selectAll("text").data([maxData]).enter().append("text").text(function(d){return d.value||""}).attr("x",function(data,i){return scaleX(data.index)+(data.index?scaleWidth/2:0)}).attr("y",function(data,i){return scaleY(data.value)}).attr("text-anchor",function(data,i){return data.index?data.index==dt.length-1?"right":"middle":"left"}).attr("dy",-2),svg.selectAll("text.legend").data([currentValue]).enter().append("text").attr("class","legend").text(function(d){return d}).attr("x",function(data,i){return width-legendSpace}).attr("y",function(data){return scaleY(data)+padding/2>scaleY(0)?scaleY(0)-padding/2:scaleY(data)}).attr("text-anchor","right").attr("dx",percent).attr("dy",(padding-1)/2),hasEmptyStart&&config.emptyStartLabel&&svg.selectAll("text.tau-sparkline__emptylegend").data([config.emptyStartLabel]).enter().append("text").attr("class","tau-sparkline__emptylegend").text(function(d){return d||""}).attr("x",function(data,i){return scaleX(0)}).attr("y",function(data){return scaleY(0)-padding/2-3}).attr("text-anchor","left").attr("dx",percent).attr("dy",(padding-1)/2)},drawBottom:function(msvg,config){var dt=config.items,legendSpace=config.legendSpace,max=config.max,height=config.height,width=config.width,padding=config.padding,percent=config.percent;if(dt.length==0)return;var svg=msvg.append("g").attr("transform","translate(0,"+height/2+")"),maxData=_.reduce(dt,function(memo,v,index){return v>memo.value?{index:index,value:v}:memo},{index:0,value:dt[0]}),currentValue=_.last(dt);maxData.index==dt.length-1&&(maxData=null);var hasEmptyStart=_.all(dt.slice(0,this.config.emptyStart),function(v){return v==0}),diffData=_.reduce(dt,function(memo,v,index){return memo?memo.concat({diff:v-_.last(memo).to,to:v,from:_.last(memo).to}):[{diff:v,to:v,from:0}]},null),scaleX=d3.scale.ordinal().domain(_.keys(dt)).rangeRoundBands([0,width-legendSpace]),scaleWidth=scaleX.rangeBand(),scaleY=d3.scale.linear().domain([0,max]).range([0,height/2-padding]),scaleHeight=d3.scale.linear().domain([0,max]).range([0,height/2-padding]);svg.selectAll(".tau-sparkline__closedmark").data(dt).enter().append("rect").attr("class","tau-sparkline__closedmark").attr("x",function(data,i){return scaleX(i)}).attr("y",scaleY).attr("height",function(data,i){return data==0?0:percent}).attr("width",scaleWidth),svg.selectAll(".tau-sparkline__diffmark-closed").data(diffData).enter().append("rect").attr("class","tau-sparkline__diffmark-closed").attr("x",function(data,i){return scaleX(i)-1}).attr("y",function(data){return scaleY(Math.min(data.from,data.to))+(data.diff>0?1:0)}).attr("height",function(data){return scaleHeight(Math.abs(data.diff))}).attr("width",1),maxData&&svg.selectAll("text").data([maxData]).enter().append("text").text(function(d){return d.value||""}).attr("x",function(data,i){return scaleX(data.index)+(data.index?scaleWidth/2:0)}).attr("y",function(data,i){return scaleY(data.value)+padding}).attr("text-anchor",function(data,i){return data.index?data.index==dt.length-1?"right":"middle":"left"}),svg.selectAll("text.legend").data([currentValue]).enter().append("text").attr("class","legend").text(function(d){return d}).attr("x",function(data,i){return width-legendSpace}).attr("y",function(data){return scaleY(data)-padding/2<scaleY(0)?padding/2:scaleY(data)}).attr("text-anchor","right").attr("dx",percent).attr("dy",(padding-percent)/2),hasEmptyStart&&config.emptyStartLabel&&svg.selectAll("text.tau-sparkline__emptylegend").data([config.emptyStartLabel]).enter().append("text").attr("class","tau-sparkline__emptylegend").text(function(d){return d||""}).attr("x",function(data,i){return scaleX(0)}).attr("y",function(data){return scaleY(0)+padding/2+2}).attr("text-anchor","left").attr("dx",percent).attr("dy",(padding-percent)/2)},drawAxis:function(svg,config){svg.append("rect").attr("class","tau-sparkline__axis").attr("y",config.scaleY(0)).attr("x",0).attr("width",config.width-config.legendSpace).attr("height",config.percent)}})})