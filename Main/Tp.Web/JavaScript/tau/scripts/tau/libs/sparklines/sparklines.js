define(["tau/core/class"],function(t){return Array.prototype.map&&require(["libs/d3/d3"],function(){}),t.extend({init:function(t){this.config=_.defaults(t,{width:100,height:50,letterWidth:7.5,letterHeight:8,emptyStart:8}),this.config.padding=this.config.padding||this.config.letterHeight+1,this.config.percent=Math.ceil(this.config.height/100)},createDrawData:function(t){for(var e=t.len||15,n=t.currentWeek,a=t.opened,r=t.closed,i=[],l=n-e;n>=l;l++){var d={open:0,closed:0},u=_.find(a,function(t){return l==t.key});d.open=u?u.count:0;var c=_.find(r,function(t){return l==t.key});d.closed=c?c.count:0,i.push(d)}return i},draw:function(t,e){var n=!1;if(null===t){var a=$(e).data("source");t=this.createDrawData(a),n=$(e).is(".tau-sparkline-bugs")}var r=this.config,i=d3.select(e||$("<svg />")[0]).attr("width",r.width).attr("height",r.height),l=_.pluck(t,"open"),d=_.pluck(t,"closed"),u=Math.max.apply(null,l),c=Math.max.apply(null,d),o=Math.max.apply(null,[u,c]),s=2;t.length&&(s=Math.max.apply(null,[(""+_.last(d)).length,(""+_.last(l)).length,2]));var p=s*r.letterWidth,f=_.all(d.slice(0,this.config.emptyStart),function(t){return 0==t}),h=_.all(l.slice(0,this.config.emptyStart),function(t){return 0==t}),g=f&&h;return this.drawTop(i,{items:d,max:o,legendSpace:p,height:r.height,width:r.width,padding:r.padding,percent:r.percent,emptyStartLabel:g?n?"fixed":"done":!1}),this.drawBottom(i,{items:l,max:o,legendSpace:p,height:r.height,width:r.width,padding:r.padding,percent:r.percent,emptyStartLabel:g?"added":!1}),i[0]},drawTop:function(t,e){var n=e.items,a=e.legendSpace,r=e.max,i=e.height,l=e.width,d=e.padding,u=e.percent,c=t.append("g").attr("transform","translate(0,"+d+")"),o=null,s=null,p=null;n.length&&(o=_.reduce(n,function(t,e,n){return e>t.value?{index:n,value:e}:t},{index:0,value:n[0]}),o.index==n.length-1&&(o=null),s=_.last(n),p=_.reduce(n,function(t,e){return t?t.concat({diff:e-_.last(t).to,to:e,from:_.last(t).to}):[{diff:e,to:e,from:0}]},null));var f=_.all(n.slice(0,this.config.emptyStart),function(t){return 0==t}),h=d3.scale.ordinal().domain(_.keys(n)).rangeRoundBands([0,l-a]),g=h.rangeBand(),x=d3.scale.linear().domain([0,r]).range([i/2-d,0]),m=d3.scale.linear().domain([0,r]).range([0,i/2-d]);return 0==n.length?void this.drawAxis(c,_.extend(e,{scaleY:x})):(c.selectAll(".tau-sparkline__openbar").data(n).enter().append("rect").attr("class","tau-sparkline__openbar").attr("x",function(t,e){return h(e)}).attr("y",x).attr("height",m).attr("width",g),this.drawAxis(c,_.extend(e,{scaleY:x})),c.selectAll(".tau-sparkline__openmark").data(n).enter().append("rect").attr("class","tau-sparkline__openmark").attr("x",function(t,e){return h(e)}).attr("y",x).attr("height",function(t){return 0==t?0:u}).attr("width",g),c.selectAll(".tau-sparkline__diffmark-open").data(p).enter().append("rect").attr("class","tau-sparkline__diffmark-open").attr("x",function(t,e){return h(e)-1}).attr("y",function(t){return x(Math.max(t.from,t.to))+(t.diff>0?0:1)}).attr("height",function(t){return m(Math.abs(t.diff))}).attr("width",1),o&&c.selectAll("text").data([o]).enter().append("text").text(function(t){return t.value||""}).attr("x",function(t){return h(t.index)+(t.index?g/2:0)}).attr("y",function(t){return x(t.value)}).attr("text-anchor",function(t){return t.index?t.index==n.length-1?"right":"middle":"left"}).attr("dy",-2),c.selectAll("text.legend").data([s]).enter().append("text").attr("class","legend").text(function(t){return t}).attr("x",function(){return l-a}).attr("y",function(t){return x(t)+d/2>x(0)?x(0)-d/2:x(t)}).attr("text-anchor","right").attr("dx",u).attr("dy",(d-1)/2),void(f&&e.emptyStartLabel&&c.selectAll("text.tau-sparkline__emptylegend").data([e.emptyStartLabel]).enter().append("text").attr("class","tau-sparkline__emptylegend").text(function(t){return t||""}).attr("x",function(){return h(0)}).attr("y",function(){return x(0)-d/2-3}).attr("text-anchor","left").attr("dx",u).attr("dy",(d-1)/2)))},drawBottom:function(t,e){var n=e.items,a=e.legendSpace,r=e.max,i=e.height,l=e.width,d=e.padding,u=e.percent;if(0!=n.length){var c=t.append("g").attr("transform","translate(0,"+i/2+")"),o=_.reduce(n,function(t,e,n){return e>t.value?{index:n,value:e}:t},{index:0,value:n[0]}),s=_.last(n);o.index==n.length-1&&(o=null);var p=_.all(n.slice(0,this.config.emptyStart),function(t){return 0==t}),f=_.reduce(n,function(t,e){return t?t.concat({diff:e-_.last(t).to,to:e,from:_.last(t).to}):[{diff:e,to:e,from:0}]},null),h=d3.scale.ordinal().domain(_.keys(n)).rangeRoundBands([0,l-a]),g=h.rangeBand(),x=d3.scale.linear().domain([0,r]).range([0,i/2-d]),m=d3.scale.linear().domain([0,r]).range([0,i/2-d]);c.selectAll(".tau-sparkline__closedmark").data(n).enter().append("rect").attr("class","tau-sparkline__closedmark").attr("x",function(t,e){return h(e)}).attr("y",x).attr("height",function(t){return 0==t?0:u}).attr("width",g),c.selectAll(".tau-sparkline__diffmark-closed").data(f).enter().append("rect").attr("class","tau-sparkline__diffmark-closed").attr("x",function(t,e){return h(e)-1}).attr("y",function(t){return x(Math.min(t.from,t.to))+(t.diff>0?1:0)}).attr("height",function(t){return m(Math.abs(t.diff))}).attr("width",1),o&&c.selectAll("text").data([o]).enter().append("text").text(function(t){return t.value||""}).attr("x",function(t){return h(t.index)+(t.index?g/2:0)}).attr("y",function(t){return x(t.value)+d}).attr("text-anchor",function(t){return t.index?t.index==n.length-1?"right":"middle":"left"}),c.selectAll("text.legend").data([s]).enter().append("text").attr("class","legend").text(function(t){return t}).attr("x",function(){return l-a}).attr("y",function(t){return x(t)-d/2<x(0)?d/2:x(t)}).attr("text-anchor","right").attr("dx",u).attr("dy",(d-u)/2),p&&e.emptyStartLabel&&c.selectAll("text.tau-sparkline__emptylegend").data([e.emptyStartLabel]).enter().append("text").attr("class","tau-sparkline__emptylegend").text(function(t){return t||""}).attr("x",function(){return h(0)}).attr("y",function(){return x(0)+d/2+2}).attr("text-anchor","left").attr("dx",u).attr("dy",(d-u)/2)}},drawAxis:function(t,e){t.append("rect").attr("class","tau-sparkline__axis").attr("y",e.scaleY(0)).attr("x",0).attr("width",e.width-e.legendSpace).attr("height",e.percent)}})});