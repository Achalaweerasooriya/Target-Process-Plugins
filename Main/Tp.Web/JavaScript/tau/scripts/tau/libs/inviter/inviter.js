define(["Underscore","tau/core/class"],function(_,Class){return Class.extend({init:function(configurator){this.store=configurator.getStore()},invite:function(members){var self=this,store=this.store,fs=[];fs=_.map(members,function(user){return function(next){user.id?next(!1,{success:user.id}):store.find("user",{$query:{email:user.email,deleteDate:{$isNull:!0}},fields:["id","firstName","lastName"]}).done(function(res){var fuser=res[0].data.length?res[0].data[0]:null;fuser?next(!1,{success:fuser.id}):store.save("user",{failureGlobal:!1,$set:{login:user.login,email:user.email,password:Math.round(Math.random()*1e11)}},{success:function(res){next(!1,{success:res.data.id})},failure:function(res){next(!1,{failure:user})}}).done()})}});var def=$.Deferred();return _.series(fs,function(err,res){err?def.failure(err):def.resolve(res)}),def}})})