define(["require","Underscore","jQuery","libs/cache","tau/core/class"],function(e){var t=e("Underscore"),r=e("jQuery"),a=e("libs/cache"),s=e("tau/core/class"),i=s.extend({init:function(e){this.loggedUser=e.getLoggedUser(),this.path=e.getApplicationPath()+"/api/v2/",this.service=e.getStore2Service(),e.getFeaturesService().isEnabled("short.term.requests.cache")&&(this.getTeamsProjectsAvailable=a.deferred(this.getTeamsProjectsAvailable,6e4),this.getApplicationContext=a.deferred(this.getApplicationContext,1e4,this._prepareQueryString))},escapeExpressionArgument:function(e){return encodeURIComponent(this._jsEscape(t.asString(e)))},arg:function(e){return this.escapeExpressionArgument(e)},getTeamsProjectsAvailable:function(e){var r="User?select={AvailableProjects() as projects, AvailableTeams() as teams, AvailableProcesses() as availableProcesses}&where=(id == "+e+")",a=this.path+r;return this.service({url:a}).then(function(e){var r={projects:[],teams:[]};return 1===e.items.length?t.defaults(e.items[0],r):r})},_prepareQueryString:function(e){if(e.acid)return"acid="+e.acid;e.ids=e.id||e.ids,e.ids||(e.projectIds=e.projectIds||e.projectId||"*",e.teamIds=e.teamIds||e.teamId||"*");var r=["fields","failureGlobal","id"];return t.chain(e).keys().filter(function(t){return r.indexOf(t)<0&&e[t]}).map(function(t){return t+"="+e[t]}).value().join("&")},getApplicationContext:function(e){var t=this.path+"Context";return t+=e.acid?"/"+e.acid:"?"+this._prepareQueryString(e),this.service({url:t,contentType:"application/json; charset=utf-8",dataType:"json"}).then(function(e){return{context:e,projects:e.availableProjects,teams:e.availableTeams,programs:e.availablePrograms}}).fail(function(e){e.response=r.parseJSON(e.responseText||null)})},findAll:function(e){return this.service({url:this.path+e}).then(function(e){return e.items})},_jsEscape:function(e){return e.replace(/(["'\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r")
}});return i});