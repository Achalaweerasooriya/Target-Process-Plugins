define(["Underscore","jQuery","tau/core/class"],function(e,t,r){var n=r.extend({init:function(e){this.loggedUser=e.getLoggedUser(),this.path=e.getApplicationPath()+"/api/v2/",this.service=t.ajax},escapeExpressionArgument:function(t){return encodeURIComponent(this._jsEscape(e.asString(t)))},getTeamsProjectsAvailable:e.memoize(function(t){var r="User?select={AvailableProjects() as projects, AvailableTeams() as teams, AvailableProcesses() as availableProcesses}&where=(id == "+t+")",n=this.path+r;return this.service({url:n}).then(function(t){var r={projects:[],teams:[]};return 1===t.items.length?e.defaults(t.items[0],r):r})}),getApplicationContext:function(r){var n=function(t){if(t.acid)return"acid="+t.acid;t.ids=t.id||t.ids,t.ids||(t.projectIds=t.projectIds||t.projectId||"*",t.teamIds=t.teamIds||t.teamId||"*");var r=["fields","failureGlobal","id"];return e.chain(t).keys().filter(function(e){return r.indexOf(e)<0&&t[e]}).map(function(e){return e+"="+t[e]}).value().join("&")},a=n(r);return this.service({url:this.path+"Context?"+a,contentType:"application/json; charset=utf-8",dataType:"json"}).then(function(e){return{context:e,projects:e.availableProjects,teams:e.availableTeams}}).fail(function(e){e.response=t.parseJSON(e.responseText||null)})},findAll:function(e){return this.service({url:this.path+e}).then(function(e){return e.items})},_jsEscape:function(e){return e.replace(/(["'\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r")}});return n.prototype.arg=n.prototype.escapeExpressionArgument,n});