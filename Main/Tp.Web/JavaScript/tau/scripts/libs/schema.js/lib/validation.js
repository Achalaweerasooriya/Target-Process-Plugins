define(["require","exports","module","./utils","./objecttools"],function(require,exports,module){var utils=require("./utils"),objecttools=require("./objecttools"),locale=utils.locale,slice=Array.prototype.slice;module.exports=function(){var env=this,detectRecursion=this.detectRecursion,Validation=this.Validation=function(schema,instance,options){options=options||{},this._flags={},this._errors={},this._wasError=0,this._stack=[],this.path=[],this.id=Validation._id++,this.schema,this.push(schema),this.instance=instance,this.locale=env.locale||"en",this.detectRecursion=options.detectRecursion||detectRecursion,this.errors=[];var validation=this,_Error=this.Error=function(attribute,description,moreInfo){this.schema=validation.schema,this.path=validation.path?[].concat(validation.path):[],this.attribute=attribute||"",this.description=typeof description=="object"?locale(description,validation.locale)(this):description||"",moreInfo&&utils.extend(this,moreInfo),validation._errors[this.id()]||(validation._errors[this.id()]=!0,validation.errors.push(this)),validation._wasError++};_Error.prototype.toJSON=function(){return{path:this.path,name:this.attribute,description:this.description}},_Error.prototype.id=function(){return[this.path,undefined,this.attribute]+""},this.instance=this.start(instance),delete this._flags,this._errors,this._wasError,this._stack,this.path,this.id};utils.extend(Validation.prototype,{isError:function(){return this.errors.length>0},getError:function(){if(this.errors.length===0)return null;var e=new Error(locale(env.i18n("validation_error"),this.locale)(this));return e.errors=this.errors,e.toJSON=function(){return{message:this.message,errors:this.errors}},e},wasError:function(){var was=this._wasError;return this._wasError=0,was},push:function(schema,key){this.schema=schema,this._stack.push(schema),key!==undefined&&this.path.push(key)},pop:function(omitKey){var ret=[this._stack.pop(),omitKey?undefined:this.path.pop()],len=this._stack.length;return this.schema=len?this._stack[len-1]:null,ret},getFlag:function(instance){return objecttools.id(instance)+"_"+this.schema.id},flagObject:function(instance){return this._flags[this.getFlag(instance)]=!0,instance},isObjectFlagged:function(instance){return this.getFlag(instance)in this._flags},callPlugin:function(plugin,instance){var args=arguments.length>2?slice.call(arguments,1):[instance];return typeof plugin!="function"&&(plugin=Validation.plugins[plugin]||Validation.plugins.addError),plugin.apply(this,args)}}),utils.extend(Validation,{_id:1,registerPlugins:function(plugins){utils.extend(Validation.plugins,plugins)},plugins:{addError:function(instance,errorName){return new this.Error(errorName,env.i18n["validation_error_"+errorName]),instance}}}),require("./"+this.v+"/validation").call(this)}})