/* objecttools
 *
 * JavaScript Object and JSON reference utilities
 * Copyright 2011 Andreas Kalsch
 */

define(["require","exports","module"],function(require,exports,module){typeof global=="undefined"&&typeof window=="object"&&(window.global=window),Object.keys||(Object.keys=function(obj){if(obj!==Object(obj))throw new TypeError("Invalid object");var keys=[];for(var key in obj)obj.hasOwnProperty.call(obj,key)&&(keys[keys.length]=key);return keys});var __id=0,specialObjectKeys=["$ref","$refs","$$refs"],objecttools={},find=objecttools.find=function(object,path){var key,obj=object;for(var li=path.length,i=0;i<li;i++){if((key=path[i])===undefined)break;if(!((obj instanceof Object||obj instanceof Array)&&key in obj))return;obj=obj[key]}return obj},__registry={},id=objecttools.id=function(object){if(object instanceof Object)return object.hasOwnProperty("__id")||(object.__id=__id++),object.__id;return},resetRefs=objecttools.resetRefs=function(object){if(object instanceof Object){var refs=getRefs(object);return refs?(refs.splice(0),refs):(refs=[],object instanceof Array?object.push({$$refs:refs}):object.$refs=refs,refs)}return null},getRefs=objecttools.getRefs=function(object){if(object instanceof Object)return object instanceof Array&&object[object.length-1]&&object[object.length-1].$$refs instanceof Array?object[object.length-1].$$refs:object.hasOwnProperty("$refs")?object.$refs:null;return null},addRef=objecttools.addRef=function(object,toPath,fromPath){var refs=getRefs(object);if(!refs)throw new Error("You need to call resetRefs(object) first!");return refs.push(toPath),refs.push(fromPath),refs},findRefs=objecttools.findRefs=function(object){var fromPathById={},toPath=[],refs=resetRefs(object),self=function(obj){if(!(obj instanceof Object))return;var _id=id(obj);if(fromPathById[_id]!==undefined){refs.push([].concat(toPath)),refs.push(fromPathById[_id]);return}fromPathById[_id]=["#"].concat(toPath);if(object instanceof Array){for(var li=object.length,i=0;i<li;i++)toPath.push(i),self(obj[i]),toPath.pop();return}for(var ks=Object.keys(obj),li=ks.length,i=0,key;key=ks[i],i<li;i++){if(specialObjectKeys.indexOf(key)>-1)continue;toPath.push(key),self(obj[key]),toPath.pop()}};return self(object),object},resolveRefs=objecttools.resolveRefs=function(object,isTrustedSource){var refs,isArray=object instanceof Array;if(isArray){var last=object[object.length-1];last instanceof Object&&last.$refs instanceof Array&&(refs=last.$refs)}else object instanceof Object&&object.$refs instanceof Array&&(refs=object.$refs);if(!refs)return object;var to,to_last,from,from_first,obj;for(var li=refs.length,i=0;i<li;i+=2){to=[].concat(refs[i]),from=[].concat(refs[i+1]),to_last=to.pop(),from_first=from.shift();if(to_last===undefined||from_first===undefined)continue;obj=find(object,to);if(!obj)continue;from_first!=="#"&&from.unshift(from_first);if(from_first!=="#"&&!isTrustedSource)continue;obj[to_last]=find(from_first==="#"?object:global,from),refs.splice(i,2),i-=2,li-=2}return object};module.exports={},typeof module=="object"&&module.exports&&(module.exports=objecttools)})