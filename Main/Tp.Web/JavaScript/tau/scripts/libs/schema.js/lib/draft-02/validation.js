define(["require","exports","module","Underscore","../utils","../objecttools"],function(require,exports,module){var _=require("Underscore"),utils=require("../utils"),objecttools=require("../objecttools");module.exports=function(){var env=this,Schema=this.Schema;utils.extend(this.Validation.prototype,{start:function(instance){if(this.detectRecursion&&instance instanceof Object){if(this.isObjectFlagged(instance))return instance;this.flagObject(instance)}return instance=this["extends"](instance),this.wasError()?instance:(instance=this.adapters(instance,"pre"),this.wasError()?instance:(instance=this.optional(instance),this.wasError()||instance===undefined?instance:(instance=this.empty(instance),this.wasError()||instance===""||instance===null?instance:(instance=this.type(instance),this.wasError()?instance:(instance=this.requires(instance),this.wasError()?instance:(instance=this.adapters(instance,"post"),instance))))))},"extends":function(instance){return this.schema["extends"]?(this.push(this.schema["extends"]),instance=this.start(instance),this.pop(!0),instance):instance},optional:function(instance){return this.schema.optional||instance!==undefined?instance:this.callPlugin(this.schema.fallbacks.optional,instance,"optional")},empty:function(instance){return this.schema.empty||instance!==undefined&&instance!==""&&instance!==null?instance:this.callPlugin(this.schema.fallbacks.optional,instance,"empty")},adapters:function(instance,position){if(!this.schema[position])return instance;var adapters=this.schema[position];adapters instanceof Array||(adapters=[adapters]);var len=this.errors.length,adapter;for(var li=adapters.length,i=0;i<li;i++){adapter=adapters[i],instance=this.callPlugin(adapter,instance);if(this.errors.length>len)return instance}return instance},type:function(instance,type,isFirst){isFirst=isFirst===!1?!1:!0;var toType=type||this.schema.type;if(!(toType instanceof Array)){var fromType=typeof instance,ok=function(){if(toType==="any")return!0;if(toType==="null")return instance===null;if(toType==="array")return instance instanceof Array;if(toType==="object")return instance instanceof Object&&!(instance instanceof Array);if(toType==="number")return fromType==="number";if(toType==="integer")return fromType==="number"&&Math.round(instance)===instance;if(toType==="string")return fromType==="string";if(toType==="boolean")return fromType==="boolean"}();if(!ok){instance=this.callPlugin(this.schema.fallbacks.type,instance,"type");if(this.wasError())return instance}var type=typeof instance;return type==="number"?(instance=this.minimum(instance),this.wasError()?instance:(instance=this.maximum(instance),this.wasError()?instance:(instance=this.maxDecimal(instance),this.wasError()?instance:(isFirst&&(instance=this["enum"](instance)),instance)))):type==="string"?(instance=this.pattern(instance),this.wasError()?instance:(instance=this.minLength(instance),this.wasError()?instance:(instance=this.maxLength(instance),this.wasError()?instance:(isFirst&&(instance=this["enum"](instance)),instance)))):instance instanceof Array?(instance=this.minItems(instance),this.wasError()?instance:(instance=this.maxItems(instance),this.wasError()?instance:(instance=this.items(instance),this.wasError()?instance:(instance=this.additionalProperties(instance),this.wasError()?instance:(isFirst&&(instance=this["enum"](instance)),instance))))):instance instanceof Object?(instance=this.properties(instance),instance=this.additionalProperties(instance),this.wasError()?instance:(isFirst&&(instance=this["enum"](instance)),instance)):instance}var inst,len=this.errors.length;for(var li=toType.length,i=0;i<li;i++){inst=this.type(instance,toType[i],i===0);if(this.errors.length===len){instance=inst;break}i+1<li&&(this.errors.splice(len,1),this.wasError())}return instance},"enum":function(instance){return"enum"in this.schema?_.indexOf(this.schema["enum"],instance)>-1?instance:this.callPlugin(this.schema.fallbacks["enum"],instance,"enum"):instance},requires:function(instance){if(this.schema.requires!==undefined&&this.parentInstance){var tempSchema;typeof this.schema.requires=="string"?(tempSchema={properties:{}},tempSchema.properties[this.schema.requires]={type:"any"}):tempSchema={properties:this.schema.requires},tempSchema=Schema.create(tempSchema);var schema_key=this.pop();this.push(tempSchema),this.properties(this.parentInstance),this.pop(!0),this.push.apply(this,schema_key)}return instance},properties:function(instance){if("properties"in this.schema){var props=this.schema.properties,prop,inst;this.parentInstance=instance;var isIn,inst;for(var key in props){this.push(props[key],key),isIn=key in instance,key!="__id"?inst=this.start(instance[key]):(inst=undefined,isIn=!1);if(isIn||inst!==undefined)instance[key]=inst;this.pop()}this.parentInstance=null}return this.wasError(),instance},additionalProperties:function(instance){if("additionalProperties"in this.schema)if(instance instanceof Object&&!(instance instanceof Array)){var props=this.schema.properties||{};if(!this.schema.additionalProperties){for(var ks=Object.keys(instance),li=ks.length,i=0,key;key=ks[i],i<li;i++)if(!(key in props)&&key!="__id")return this.callPlugin(this.schema.fallbacks.additionalProperties,instance,"additionalProperties")}else if(this.schema.additionalProperties!==!0)for(var ks=Object.keys(instance),li=ks.length,i=0,key;key=ks[i],i<li;i++)key in props||(this.push(this.schema.additionalProperties,key),key!=="__id"&&(instance[key]=this.start(instance[key])),this.pop())}else if(this.schema.items instanceof Array)if(!this.schema.additionalProperties){if(instance.length>this.schema.items.length)return this.callPlugin(this.schema.fallbacks.additionalProperties,instance,"additionalProperties")}else if(this.schema.additionalProperties!==!0)for(var li=instance.length,i=this.schema.items.length;i<li;i++)this.push(this.schema.additionalProperties,i),instance[i]=this.start(instance[i]),this.pop();return instance},items:function(instance){if("items"in this.schema)if(this.schema.items instanceof Array){var isIn,inst;for(var li=this.schema.items.length,i=0;i<li;i++){this.push(this.schema.items[i],i),isIn=i in instance,i!="__id"?inst=this.start(instance[i]):(isIn=!1,inst=undefined);if(isIn||inst!==undefined)instance[i]=inst;this.pop()}}else for(var li=instance.length,i=0;i<li;i++)this.push(this.schema.items,i),i!="__id"&&(instance[i]=this.start(instance[i])),this.pop();return instance},maxItems:function(instance){return this.schema.maxItems&&instance.length>this.schema.maxItems?this.callPlugin(this.schema.fallbacks.maxItems,instance,"maxItems"):instance},minItems:function(instance){return this.schema.minItems&&instance.length<this.schema.minItems?this.callPlugin(this.schema.fallbacks.minItems,instance,"minItems"):instance},minimum:function(instance){if("minimum"in this.schema){var minimumCanEqual="minimumCanEqual"in this.schema?this.schema.minimumCanEqual:!0;return(minimumCanEqual?instance>=this.schema.minimum:instance>this.schema.minimum)?instance:this.callPlugin(this.schema.fallbacks.minimum,instance,"minimum")}return instance},maximum:function(instance){if("maximum"in this.schema){var maximumCanEqual="maximumCanEqual"in this.schema?this.schema.maximumCanEqual:!0;return(maximumCanEqual?instance<=this.schema.maximum:instance<this.schema.maximum)?instance:this.callPlugin(this.schema.fallbacks.maximum,instance,"maximum")}return instance},maxDecimal:function(instance){if("maxDecimal"in this.schema){var factor=Math.pow(10,this.schema.maxDecimal);return Math.round(instance*factor)/factor===instance?instance:this.callPlugin(this.schema.fallbacks.maxDecimal,instance,"maxDecimal")}return instance},pattern:function(instance){return this.schema.pattern?this.schema.pattern.test(instance)?instance:this.callPlugin(this.schema.fallbacks.pattern,instance,"pattern"):instance},minLength:function(instance){return this.schema.minLength===undefined?instance:instance.length>=this.schema.minLength?instance:this.callPlugin(this.schema.fallbacks.minLength,instance,"minLength")},maxLength:function(instance){return this.schema.maxLength===undefined?instance:instance.length<=this.schema.maxLength?instance:this.callPlugin(this.schema.fallbacks.maxLength,instance,"maxLength")}}),utils.extend(this.Validation,{TOLERANT_FALLBACKS:{optional:"setDefault",type:"castTolerantlyToType","enum":"setDefault",requires:"addError",additionalProperties:"removeAdditionalProperties",maxItems:"sliceToMaxItems",minItems:"addError",maximum:"setMaximum",minimum:"setMinimum",maxDecimal:"roundToMaxDecimal",pattern:"addError",minLength:"addError",maxLength:"addError"},STRICT_FALLBACKS:{optional:"addError",type:"addError","enum":"addError",requires:"addError",additionalProperties:"addError",maxItems:"addError",minItems:"addError",maximum:"addError",minimum:"addError",maxDecimal:"addError",pattern:"addError",minLength:"addError",maxLength:"addError"}}),this.Validation.registerPlugins({addToRefs:function(instance){if(instance instanceof Object&&!(instance instanceof Array)&&typeof instance.$ref=="string"){var toPath=this.path,fromPath=instance.$ref.split(".");objecttools.addRef(this.instance,[].concat(toPath),fromPath[0]==="#"?[].concat(fromPath):["#","constructor","instances"].concat(fromPath))}return instance},instantiateSchema:function(instance){if(!(instance instanceof Object)||instance instanceof Array)return instance;var isThisInstance=instance===this.instance;instance instanceof Schema||(instance=new Schema(instance)),isThisInstance&&(this.instance=instance);if(instance.properties instanceof Object){var props=instance.properties||{};for(var key in props)props[key]instanceof Object&&!(props[key]instanceof Schema)&&(props[key]=new Schema(props[key]))}if(instance.items instanceof Array){var items=instance.items;for(var li=items.length,i=0;i<li;i++)items[i]instanceof Object&&!(items[i]instanceof Schema)&&(items[i]=new Schema(items[i]))}else instance.items instanceof Object&&(instance.items instanceof Schema||(instance.items=new Schema(instance.items)));if(instance.requires&&instance.requires instanceof Object&&!(instance.requires instanceof Array)){var props=instance.requires;for(var key in props)props[key]=new Schema(props[key])}return instance.additionalProperties instanceof Object&&!(instance.additionalProperties instanceof Schema)&&(instance.additionalProperties=new Schema(instance.additionalProperties)),instance["extends"]instanceof Object&&(instance["extends"]instanceof Schema||(instance["extends"]=new Schema(instance["extends"]))),instance.setFallbacks(instance.fallbacks),objecttools.resetRefs(instance),instance},castTolerantlyToType:function(instance,errorName){errorName=errorName||"type";var toType=this.schema.type,fromType=typeof instance,inst;if(toType==="string")return fromType==="object"?instance!==null&&typeof instance.toString=="function"&&instance.toString!==Object.prototype.toString&&instance.toString!==Array.prototype.toString?""+instance:(new this.Error(errorName,env.i18n["validation_error_"+errorName]),instance):""+instance;if(toType==="number"){if(fromType!=="boolean")return inst=parseFloat(instance),isNaN(inst)&&instance!=0?(new this.Error(errorName,env.i18n["validation_error_"+errorName]?env.i18n["validation_error_"+errorName]:"validation_error_"+errorName),instance):isNaN(inst)?instance:inst;if(instance===!1)return 0;if(instance===!0)return 1}if(toType==="integer"){if(fromType!=="boolean")return inst=parseInt(instance,10),isNaN(inst)?(new this.Error(errorName,env.i18n["validation_error_"+errorName]),instance):inst;if(instance===!1)return 0;if(instance===!0)return 1}if(toType==="boolean")return fromType==="string"?instance.trim().toLowerCase()==="false"?!1:(inst=parseFloat(instance),isNaN(inst)?!0:!!inst):!!instance;if(toType==="object")return instance instanceof Array&&instance.length===0?{}:((fromType!=="object"||instance===null||instance instanceof Array)&&new this.Error(errorName,env.i18n["validation_error_"+errorName]),instance);if(toType==="array"){if(!instance)return[];if(instance instanceof Object){var inst=[],key_int,allInt=!0;if(Object.keys(instance).length===0)return inst;for(var key in instance){key_int=parseInt(key,10),""+key_int===key?inst[key_int]=instance[key]:allInt=!1;break}}return new this.Error(errorName,env.i18n["validation_error_"+errorName]),instance}if(toType==="null")return new this.Error(errorName,env.i18n["validation_error_"+errorName]),instance},roundToMaxDecimal:function(instance,errorName){if(this.schema.maxDecimal===undefined)return new this.Error(errorName,env.i18n["validation_error_"+errorName]),instance;var factor=Math.pow(10,this.schema.maxDecimal);return Math[instance<0?"ceil":"floor"](instance*factor)/factor},setMinimum:function(instance,errorName){return this.schema.minimum===undefined?(new this.Error(errorName,env.i18n["validation_error_"+errorName]),instance):this.schema.minimum},setMaximum:function(instance,errorName){return this.schema.maximum===undefined?(new this.Error(errorName,env.i18n["validation_error_"+errorName]),instance):this.schema.maximum},truncateToMaxLength:function(instance,errorName){return this.schema.maxLength===undefined?(new this.Error(errorName,env.i18n["validation_error_"+errorName]),instance):instance.substr(0,this.schema.maxLength)},setDefault:function(instance,errorName){if("default"in this.schema)return this.schema["default"];new this.Error(errorName,env.i18n["validation_error_"+errorName])},removeAdditionalProperties:function(instance,errorName){if(this.schema.type==="object"){var props=this.schema.properties||{};for(var ks=Object.keys(instance),li=ks.length,i=0,key;key=ks[i],i<li;i++)props[key]===undefined&&delete instance[key];return instance}if(this.schema.items&&this.schema.items instanceof Array)for(var li=instance.length,i=this.schema.items.length;i<li;i++)delete instance[i];return instance},sliceToMaxItems:function(instance,errorName){return this.schema.maxItems!==undefined?instance.length>this.schema.maxItems&&instance.splice(this.schema.maxItems):new this.Error(errorName,env.i18n["validation_error_"+errorName]),instance},deleteInstance:function(instance){return undefined}})}})