define(function(require,exports,module){var _=require("Underscore"),a=require("../utils"),b=require("../objecttools");module.exports=function(){var c=this,d=this.Schema;a.extend(this.Validation.prototype,{start:function(a){if(this.detectRecursion&&a instanceof Object){if(this.isObjectFlagged(a))return a;this.flagObject(a)}return a=this["extends"](a),this.wasError()?a:(a=this.adapters(a,"pre"),this.wasError()?a:(a=this.optional(a),this.wasError()||a===undefined?a:(a=this.empty(a),this.wasError()||a===""||a===null?a:(a=this.type(a),this.wasError()?a:(a=this.requires(a),this.wasError()?a:(a=this.adapters(a,"post"),a))))))},"extends":function(a){return this.schema["extends"]?(this.push(this.schema["extends"]),a=this.start(a),this.pop(!0),a):a},optional:function(a){return this.schema.optional||a!==undefined?a:this.callPlugin(this.schema.fallbacks.optional,a,"optional")},empty:function(a){return this.schema.empty||a!==undefined&&a!==""&&a!==null?a:this.callPlugin(this.schema.fallbacks.optional,a,"empty")},adapters:function(a,b){if(!this.schema[b])return a;var c=this.schema[b];c instanceof Array||(c=[c]);var d=this.errors.length,e;for(var f=c.length,g=0;g<f;g++){e=c[g],a=this.callPlugin(e,a);if(this.errors.length>d)return a}return a},type:function(a,b,c){c=c===!1?!1:!0;var d=b||this.schema.type;if(!(d instanceof Array)){var e=typeof a,f=function(){if(d==="any")return!0;if(d==="null")return a===null;if(d==="array")return a instanceof Array;if(d==="object")return a instanceof Object&&!(a instanceof Array);if(d==="number")return e==="number";if(d==="integer")return e==="number"&&Math.round(a)===a;if(d==="string")return e==="string";if(d==="boolean")return e==="boolean"}();if(!f){a=this.callPlugin(this.schema.fallbacks.type,a,"type");if(this.wasError())return a}var b=typeof a;return b==="number"?(a=this.minimum(a),this.wasError()?a:(a=this.maximum(a),this.wasError()?a:(a=this.maxDecimal(a),this.wasError()?a:(c&&(a=this["enum"](a)),a)))):b==="string"?(a=this.pattern(a),this.wasError()?a:(a=this.minLength(a),this.wasError()?a:(a=this.maxLength(a),this.wasError()?a:(c&&(a=this["enum"](a)),a)))):a instanceof Array?(a=this.minItems(a),this.wasError()?a:(a=this.maxItems(a),this.wasError()?a:(a=this.items(a),this.wasError()?a:(a=this.additionalProperties(a),this.wasError()?a:(c&&(a=this["enum"](a)),a))))):a instanceof Object?(a=this.properties(a),a=this.additionalProperties(a),this.wasError()?a:(c&&(a=this["enum"](a)),a)):a}var g,h=this.errors.length;for(var i=d.length,j=0;j<i;j++){g=this.type(a,d[j],j===0);if(this.errors.length===h){a=g;break}j+1<i&&(this.errors.splice(h,1),this.wasError())}return a},"enum":function(a){return"enum"in this.schema?_.indexOf(this.schema["enum"],a)>-1?a:this.callPlugin(this.schema.fallbacks["enum"],a,"enum"):a},requires:function(a){if(this.schema.requires!==undefined&&this.parentInstance){var b;typeof this.schema.requires=="string"?(b={properties:{}},b.properties[this.schema.requires]={type:"any"}):b={properties:this.schema.requires},b=d.create(b);var c=this.pop();this.push(b),this.properties(this.parentInstance),this.pop(!0),this.push.apply(this,c)}return a},properties:function(a){if("properties"in this.schema){var b=this.schema.properties,c,d;this.parentInstance=a;var e,d;for(var f in b){this.push(b[f],f),e=f in a,f!="__id"?d=this.start(a[f]):(d=undefined,e=!1);if(e||d!==undefined)a[f]=d;this.pop()}this.parentInstance=null}return this.wasError(),a},additionalProperties:function(a){if("additionalProperties"in this.schema)if(a instanceof Object&&!(a instanceof Array)){var b=this.schema.properties||{};if(!this.schema.additionalProperties){for(var c=Object.keys(a),d=c.length,e=0,f;f=c[e],e<d;e++)if(!(f in b)&&f!="__id")return this.callPlugin(this.schema.fallbacks.additionalProperties,a,"additionalProperties")}else if(this.schema.additionalProperties!==!0)for(var c=Object.keys(a),d=c.length,e=0,f;f=c[e],e<d;e++)f in b||(this.push(this.schema.additionalProperties,f),f!=="__id"&&(a[f]=this.start(a[f])),this.pop())}else if(this.schema.items instanceof Array)if(!this.schema.additionalProperties){if(a.length>this.schema.items.length)return this.callPlugin(this.schema.fallbacks.additionalProperties,a,"additionalProperties")}else if(this.schema.additionalProperties!==!0)for(var d=a.length,e=this.schema.items.length;e<d;e++)this.push(this.schema.additionalProperties,e),a[e]=this.start(a[e]),this.pop();return a},items:function(a){if("items"in this.schema)if(this.schema.items instanceof Array){var b,c;for(var d=this.schema.items.length,e=0;e<d;e++){this.push(this.schema.items[e],e),b=e in a,e!="__id"?c=this.start(a[e]):(b=!1,c=undefined);if(b||c!==undefined)a[e]=c;this.pop()}}else for(var d=a.length,e=0;e<d;e++)this.push(this.schema.items,e),e!="__id"&&(a[e]=this.start(a[e])),this.pop();return a},maxItems:function(a){return this.schema.maxItems&&a.length>this.schema.maxItems?this.callPlugin(this.schema.fallbacks.maxItems,a,"maxItems"):a},minItems:function(a){return this.schema.minItems&&a.length<this.schema.minItems?this.callPlugin(this.schema.fallbacks.minItems,a,"minItems"):a},minimum:function(a){if("minimum"in this.schema){var b="minimumCanEqual"in this.schema?this.schema.minimumCanEqual:!0;return(b?a>=this.schema.minimum:a>this.schema.minimum)?a:this.callPlugin(this.schema.fallbacks.minimum,a,"minimum")}return a},maximum:function(a){if("maximum"in this.schema){var b="maximumCanEqual"in this.schema?this.schema.maximumCanEqual:!0;return(b?a<=this.schema.maximum:a<this.schema.maximum)?a:this.callPlugin(this.schema.fallbacks.maximum,a,"maximum")}return a},maxDecimal:function(a){if("maxDecimal"in this.schema){var b=Math.pow(10,this.schema.maxDecimal);return Math.round(a*b)/b===a?a:this.callPlugin(this.schema.fallbacks.maxDecimal,a,"maxDecimal")}return a},pattern:function(a){return this.schema.pattern?this.schema.pattern.test(a)?a:this.callPlugin(this.schema.fallbacks.pattern,a,"pattern"):a},minLength:function(a){return this.schema.minLength===undefined?a:a.length>=this.schema.minLength?a:this.callPlugin(this.schema.fallbacks.minLength,a,"minLength")},maxLength:function(a){return this.schema.maxLength===undefined?a:a.length<=this.schema.maxLength?a:this.callPlugin(this.schema.fallbacks.maxLength,a,"maxLength")}}),a.extend(this.Validation,{TOLERANT_FALLBACKS:{optional:"setDefault",type:"castTolerantlyToType","enum":"setDefault",requires:"addError",additionalProperties:"removeAdditionalProperties",maxItems:"sliceToMaxItems",minItems:"addError",maximum:"setMaximum",minimum:"setMinimum",maxDecimal:"roundToMaxDecimal",pattern:"addError",minLength:"addError",maxLength:"addError"},STRICT_FALLBACKS:{optional:"addError",type:"addError","enum":"addError",requires:"addError",additionalProperties:"addError",maxItems:"addError",minItems:"addError",maximum:"addError",minimum:"addError",maxDecimal:"addError",pattern:"addError",minLength:"addError",maxLength:"addError"}}),this.Validation.registerPlugins({addToRefs:function(a){if(a instanceof Object&&!(a instanceof Array)&&typeof a.$ref=="string"){var c=this.path,d=a.$ref.split(".");b.addRef(this.instance,[].concat(c),d[0]==="#"?[].concat(d):["#","constructor","instances"].concat(d))}return a},instantiateSchema:function(a){if(!(a instanceof Object)||a instanceof Array)return a;var c=a===this.instance;a instanceof d||(a=new d(a)),c&&(this.instance=a);if(a.properties instanceof Object){var e=a.properties||{};for(var f in e)e[f]instanceof Object&&!(e[f]instanceof d)&&(e[f]=new d(e[f]))}if(a.items instanceof Array){var g=a.items;for(var h=g.length,i=0;i<h;i++)g[i]instanceof Object&&!(g[i]instanceof d)&&(g[i]=new d(g[i]))}else a.items instanceof Object&&(a.items instanceof d||(a.items=new d(a.items)));if(a.requires&&a.requires instanceof Object&&!(a.requires instanceof Array)){var e=a.requires;for(var f in e)e[f]=new d(e[f])}return a.additionalProperties instanceof Object&&!(a.additionalProperties instanceof d)&&(a.additionalProperties=new d(a.additionalProperties)),a["extends"]instanceof Object&&(a["extends"]instanceof d||(a["extends"]=new d(a["extends"]))),a.setFallbacks(a.fallbacks),b.resetRefs(a),a},castTolerantlyToType:function(a,b){b=b||"type";var d=this.schema.type,e=typeof a,f;if(d==="string")return e==="object"?a!==null&&typeof a.toString=="function"&&a.toString!==Object.prototype.toString&&a.toString!==Array.prototype.toString?""+a:(new this.Error(b,c.i18n["validation_error_"+b]),a):""+a;if(d==="number"){if(e!=="boolean")return f=parseFloat(a),isNaN(f)&&a!=0?(new this.Error(b,c.i18n["validation_error_"+b]?c.i18n["validation_error_"+b]:"validation_error_"+b),a):isNaN(f)?a:f;if(a===!1)return 0;if(a===!0)return 1}if(d==="integer"){if(e!=="boolean")return f=parseInt(a,10),isNaN(f)?(new this.Error(b,c.i18n["validation_error_"+b]),a):f;if(a===!1)return 0;if(a===!0)return 1}if(d==="boolean")return e==="string"?a.trim().toLowerCase()==="false"?!1:(f=parseFloat(a),isNaN(f)?!0:!!f):!!a;if(d==="object")return a instanceof Array&&a.length===0?{}:((e!=="object"||a===null||a instanceof Array)&&new this.Error(b,c.i18n["validation_error_"+b]),a);if(d==="array"){if(!a)return[];if(a instanceof Object){var f=[],g,h=!0;if(Object.keys(a).length===0)return f;for(var i in a){g=parseInt(i,10),""+g===i?f[g]=a[i]:h=!1;break}}return new this.Error(b,c.i18n["validation_error_"+b]),a}if(d==="null")return new this.Error(b,c.i18n["validation_error_"+b]),a},roundToMaxDecimal:function(a,b){if(this.schema.maxDecimal===undefined)return new this.Error(b,c.i18n["validation_error_"+b]),a;var d=Math.pow(10,this.schema.maxDecimal);return Math[a<0?"ceil":"floor"](a*d)/d},setMinimum:function(a,b){return this.schema.minimum===undefined?(new this.Error(b,c.i18n["validation_error_"+b]),a):this.schema.minimum},setMaximum:function(a,b){return this.schema.maximum===undefined?(new this.Error(b,c.i18n["validation_error_"+b]),a):this.schema.maximum},truncateToMaxLength:function(a,b){return this.schema.maxLength===undefined?(new this.Error(b,c.i18n["validation_error_"+b]),a):a.substr(0,this.schema.maxLength)},setDefault:function(a,b){if("default"in this.schema)return this.schema["default"];new this.Error(b,c.i18n["validation_error_"+b])},removeAdditionalProperties:function(a,b){if(this.schema.type==="object"){var c=this.schema.properties||{};for(var d=Object.keys(a),e=d.length,f=0,g;g=d[f],f<e;f++)c[g]===undefined&&delete a[g];return a}if(this.schema.items&&this.schema.items instanceof Array)for(var e=a.length,f=this.schema.items.length;f<e;f++)delete a[f];return a},sliceToMaxItems:function(a,b){return this.schema.maxItems!==undefined?a.length>this.schema.maxItems&&a.splice(this.schema.maxItems):new this.Error(b,c.i18n["validation_error_"+b]),a},deleteInstance:function(a){return undefined}})}})