define(function(require,exports,module){var a=require("./objecttools"),b=require("./utils"),c=Array.prototype.slice,d=b.extend,e=b.locale,f=function(a,b){var c;if(typeof a=="object")b=a;else{if(f.instances[a])return f.instances[a];c=this,this.id=a,f.instances[a]=this}b=b||{};var e=b.i18n||["../i18n/default"];e instanceof Array||(e=[e]);var g=this.i18n=function(a){return g[a]||{en:function(){return""}}},h;for(var i=0,j=e.length;i<j;i++)h=e[i],typeof h=="object"?d(g,h):d(g,require(h));delete b.i18n,this.locale=b.locale||"en",delete b.locale,this.v="draft-02",delete b.v,this.detectRecursion=b.detectRecursion===undefined?!0:b.detectRecursion,delete b.detectRecursion,require("./schema").call(this);var k=this.Schema;k.v=this.v,require("./validation").call(this);var l=this.Validation,m=b.fallbacks||"TOLERANT_FALLBACKS";typeof m=="object"?this.fallbacks=d(l.STRICT_FALLBACKS,m):this.fallbacks=l[m],delete b.fallbacks,d(this,b),require("./"+this.v+"/setupSchemaSchema").call(this);var n=this.schemaSchema.validate(this.schemaSchema,{detectRecursion:!0});if(n.isError()){console.log("The core schema is not valid!");throw n.getError()}};d(f.prototype,{validateCall:function(a,b){if(a.SCHEMA instanceof this.Schema){var d=a.SCHEMA.validate(c.call(arguments,2)),e=d.instance;if(d.isError())throw d.getError();return a.apply(b,e)}throw"No SCHEMA defined"},validateCallAsync:function(a,b){if(!(a.SCHEMA instanceof this.Schema))throw"No SCHEMA defined";var d=c.call(arguments,2),e=d.pop(),f=a.SCHEMA.validate(d),d=f.instance;if(f.isError())return e(f.getError());d.push(e),a.apply(b,d)},f:function(a,b,d,e){var f=c.call(arguments),e=f.pop();if(f.length===0){e.IS_ASYNC=!1;return e}if(a instanceof Object){var b=!!f[1],a=this.Schema.create(a),d=!!f[2],g,h,i=this;d?g=function(){return i.validateCallAsync.apply(i,[e,this].concat(c.call(arguments)))}:g=function(){return i.validateCall.apply(i,[e,this].concat(c.call(arguments)))},e.SCHEMA=a,e.IS_VALIDATING=b,e.IS_ASYNC=d,g.SCHEMA=a,g.IS_VALIDATING=b,g.IS_ASYNC=d,h=b?g:e,b||(h.validate=g);return h}e.IS_ASYNC=!!f[0];return e}}),f.instances={};var g=function(a,b){return new f(a,b)};module.exports={},typeof module=="object"&&module.exports?module.exports=g:window.createEnvironment=g;return module.exports})