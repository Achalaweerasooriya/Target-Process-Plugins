/* schema.js
 *
 * Sophisticated JSON schema data validation and adaptation
 * Copyright 2010-2011 Andreas Kalsch
 */

define(["require","exports","module","./objecttools","./utils","./schema","./validation"],function(require,exports,module){var objecttools=require("./objecttools"),utils=require("./utils"),slice=Array.prototype.slice,extend=utils.extend,locale=utils.locale,Environment=function(id,options){var env;if(typeof id=="object")options=id;else{if(Environment.instances[id])return Environment.instances[id];env=this,this.id=id,Environment.instances[id]=this}options=options||{};var _i18n=options.i18n||["../i18n/default"];_i18n instanceof Array||(_i18n=[_i18n]);var i18n=this.i18n=function(id){return i18n[id]||{en:function(){return""}}},part;for(var i=0,ii=_i18n.length;i<ii;i++)part=_i18n[i],typeof part=="object"?extend(i18n,part):extend(i18n,require(part));delete options.i18n,this.locale=options.locale||"en",delete options.locale,this.v="draft-02",delete options.v,this.detectRecursion=options.detectRecursion===undefined?!0:options.detectRecursion,delete options.detectRecursion,require("./schema").call(this);var Schema=this.Schema;Schema.v=this.v,require("./validation").call(this);var Validation=this.Validation,fallbacks=options.fallbacks||"TOLERANT_FALLBACKS";typeof fallbacks=="object"?this.fallbacks=extend(Validation.STRICT_FALLBACKS,fallbacks):this.fallbacks=Validation[fallbacks],delete options.fallbacks,extend(this,options),require("./"+this.v+"/setupSchemaSchema").call(this);var validation=this.schemaSchema.validate(this.schemaSchema,{detectRecursion:!0});if(validation.isError())throw console.log("The core schema is not valid!"),validation.getError()};extend(Environment.prototype,{validateCall:function(func,context){if(func.SCHEMA instanceof this.Schema){var v=func.SCHEMA.validate(slice.call(arguments,2)),args=v.instance;if(v.isError())throw v.getError();return func.apply(context,args)}throw"No SCHEMA defined"},validateCallAsync:function(func,context){if(!(func.SCHEMA instanceof this.Schema))throw"No SCHEMA defined";var args=slice.call(arguments,2),_cb=args.pop(),v=func.SCHEMA.validate(args),args=v.instance;if(v.isError())return _cb(v.getError());args.push(_cb),func.apply(context,args)},f:function(schema,isValidating,isAsync,func){var args=slice.call(arguments),func=args.pop();if(args.length===0)return func.IS_ASYNC=!1,func;if(schema instanceof Object){var isValidating=!!args[1],schema=this.Schema.create(schema),isAsync=!!args[2],func_,func__,_this=this;return isAsync?func_=function(){return _this.validateCallAsync.apply(_this,[func,this].concat(slice.call(arguments)))}:func_=function(){return _this.validateCall.apply(_this,[func,this].concat(slice.call(arguments)))},func.SCHEMA=schema,func.IS_VALIDATING=isValidating,func.IS_ASYNC=isAsync,func_.SCHEMA=schema,func_.IS_VALIDATING=isValidating,func_.IS_ASYNC=isAsync,func__=isValidating?func_:func,isValidating||(func__.validate=func_),func__}return func.IS_ASYNC=!!args[0],func}}),Environment.instances={};var createEnvironment=function(id,options){return new Environment(id,options)};return module.exports={},typeof module=="object"&&module.exports?module.exports=createEnvironment:window.createEnvironment=createEnvironment,module.exports})