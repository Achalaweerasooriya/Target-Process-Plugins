define(["libs/jquery/jquery.ui","Underscore"],function(t,e){"use strict";var i=function(t){var e,i,n=0;if(window.getSelection)e=window.getSelection(),e.rangeCount&&(i=e.getRangeAt(0),i.commonAncestorContainer.parentNode==t&&(n=i.endOffset));else if(document.selection&&document.selection.createRange&&(i=document.selection.createRange(),i.parentElement()==t)){var s=document.createElement("span");t.insertBefore(s,t.firstChild);var o=i.duplicate();o.moveToElementText(s),o.setEndPoint("EndToEnd",i),n=o.text.length}return n},n="textEditor";return function(t,n){if(n in t)throw new Error('jQuery already has the "'+n+'" property.');var s=function(e,i,s){for(var o in s)e.on(o+"."+n,t.proxy(s[o],i))},o=function(e,i,s){for(var o in s)e.off(o+"."+n,t.proxy(s[o],i))},a=function(t,e){this.setOptions(e),this.initElement(t),this.enabled&&this.bindEvents()};a.prototype={constructor:a,initElement:function(t){this.$element=t.addClass(this.className)},setOptions:function(e){this.onSave=t.isFunction(e.onSave)?e.onSave:t.noop,this.onEditStart=t.isFunction(e.onEditStart)?e.onEditStart:t.noop,this.onEditEnd=t.isFunction(e.onEditEnd)?e.onEditEnd:t.noop,this.maxLength=e.maxLength||null,this.mask=e.mask?new RegExp(e.mask):!1,this.restoreText="undefined"==typeof e.restoreText?!0:e.restoreText,this.enabled=e.hasOwnProperty("enabled")?e.enabled:!0,this.className=e.className||"editableText",this.classNameActive=e.className||"active",this.options=e},enable:function(){this.enabled||(this.$element.addClass(this.className),this.enabled=!0,this.bindEvents())},disable:function(){this.enabled&&(this.$element.removeClass(this.className),this.enabled=!1,this.deactivate(),this.unbindEvents())},bindEvents:function(){if(s(this.$element,this,{blur:this.onBlur,keydown:this.mapKeys,keypress:this.mapKeys,click:this.onFocus}),!t.ui.ie){var e=function(){this.$element.blur()}.bind(this);this.$element.on("remove",function(){t(window).off("blur.textEditor",e)}),t(window).on("blur.textEditor",e)}},unbindEvents:function(){o(this.$element,this,{blur:this.onBlur,keydown:this.mapKeys,keypress:this.mapKeys,click:this.onFocus})},onFocus:function(t){t&&t.stopPropagation(),this.isActive()||(this.activate(),this.onEditStart(),this.storeInitialText())},_performSave:function(t){return t||this.isActive()?(this.deactivate(),this.saveText(),void this.onEditEnd()):void this.deactivate()},_cancelEdit:function(){this.isActive()&&(this.deactivate(),this.restoreInitialText(),this.onEditEnd())},onBlur:function(){this.options.preventDefaultBlur||this._performSave()},onEnter:function(t){t.preventDefault(),this._performSave(!0),this.$element.blur()},onEscape:function(t){t.preventDefault(),t.stopPropagation(),this._cancelEdit(),this.$element.blur()},onKeyDefault:function(t){var e=t.which;if(!(t.ctrlKey||t.altKey||t.metaKey||32>e)){var n=this._getValue(),s=String.fromCharCode(e),o=i(this.$element[0]),a=[n.substring(0,o),s,n.substring(o)],r=a.join("");this.mask.test(r)||t.preventDefault()}},activate:function(){this.$element.prop("contentEditable",!0).data("testEditorActive",!0).addClass(this.classNameActive).focus()},deactivate:function(){this.$element.prop("scrollTop",0).prop("scrollLeft",0).prop("contentEditable",!1).data("testEditorActive",!1).removeClass(this.classNameActive)},isActive:function(){return this.$element.data("testEditorActive")||!1},setInitialText:function(t){this.initialText=t},getInitialText:function(){return this.initialText},storeInitialText:function(){this.setInitialText(this._getValue())},restoreInitialText:function(){this._setValue(this.getInitialText())},trimText:function(t){return e.trim(t)},normalizeText:function(t){var e=this.trimText(t);return 0==e.length&&this.restoreText===!0&&(e=this.getInitialText()),e},saveText:function(){var t=this.normalizeText(this._getValue());this._setValue(t),t!=this.getInitialText()&&this.onSave(t)},mapKeys:function(t){switch(t.which){case 13:this.onEnter(t);break;case 27:this.onEscape(t);break;default:"keypress"==t.type&&this.mask&&this.onKeyDefault(t)}},_getValue:function(){return this.$element.is("input")?this.$element.val():this.$element.text()},_setValue:function(t){return this.$element.is("input")?this.$element.val(t):this.$element.text(t)}},t.fn[n]=function(e){return this.each(function(i,s){var o=t(s);o.data(n,new a(o,e))})},t[n]=function(e,i){return t(e)[n](i)}}(t,n),t.fn[n]});