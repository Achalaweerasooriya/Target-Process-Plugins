define(["Underscore","libs/jquery/jquery.ui"],function(t,e){e.widget("ui.tauSortable",{widgetEventPrefix:"tausortable",options:{groups:"",items:"> *",helper:function(){return e(this).clone().removeAttr("id").wrap('<div class="tau-sortable__helper" />').parent()},distance:50,cursorDistance:5,scroll:!0,zIndex:9999,scrollSensitivity:100,cursor:"move",draggedClassName:"tau-sortable__placeholder",processToGroup:null,useSelectable:!1,moveInGroup:!0,cancel:'[contentEditable="true"]'},_globals:{},dndOptions:{},shiftPressed:!1,currentGroup:null,currentGroupOptions:null,$placeholder:null,_create:function(){this.currentGroupOptions=this.options,this._globals=e.ui.tauSelectable,this.interval=e.noop;var r=this.options.useSelectable?e(this.options.useSelectable):!1;this.dndOptions=e.extend(!0,{},this.options,{start:t.bind(this._onDragStart,this,r),drag:t.bind(this._onDrag,this),stop:t.bind(this._onDragStop,this,r)}),e(document).on("keydown"+this.eventNamespace,t.bind(this._onKeyDown,this)).on("keyup"+this.eventNamespace,t.bind(this._onKeyUp,this)),this.element.addClass("tau-sortable");var i=t.bind(this._onMouseEnter,this),o=this.options.items;"string"==typeof o?this.element.on("mouseenter.tausortable",o,i):e(o).on("mouseenter.tausortable",i)},getOptions:function(){return this.options},_onMouseEnter:function(t){if(!this._globals.active){var r=e(t.currentTarget);r.data("ui-draggable")||r.draggable(this.dndOptions)}},_onKeyDown:function(t){var e=27===t.keyCode,r=this.$placeholder;return e?void(r&&r.data("ui-draggable")&&r.draggable("option","revert",!0)):void(t.shiftKey&&this.shiftPressed!==!0&&(this.shiftPressed=!0,r&&r.addClass("shiftDown")))},_onKeyUp:function(t){t.shiftKey||this.shiftPressed===!1||(this.shiftPressed=!1,this.$placeholder&&this.$placeholder.removeClass("shiftDown"))},_dragInterval:function(){},_onDragStart:function(r,i,o){this._globals.active=!0;var n=e(i.target);this.currentGroup=n.parents(this.options.groups).first();var s=t.bind(this._updateLocation,this,n,o);this._dragInterval=t.throttle(s,100),this._lastDraggedIndex=null,o.group=this.currentGroup,o.item=i.target,o.sender=this.element,o.helper&&e.data(o.helper,"helper",!0),n.removeClass("tau-selected tau-is-selected-duplicate"),n.addClass(this.options.draggedClassName),this.$oldContent=n.html(),this._updatePlaceholder(n,this.options.moveInGroup,o.group);
var a=n;if(r){var l=r.tauSelectable("getSelected"),u=l.not(n).not(":data(helper)");u.hide(),a=a.add(u)}this._applyDndData(a,"source"),a.length>1&&o.helper&&(o.helper.addClass("tau-sortable__helper_multiple_true"),o.helper.children().attr("data-batch_count",t.asString(a.length))),o.items=a,this._trigger("start",i,o),this._triggerToConnected("startconnected",i,o)},_onDrag:function(t){this._updatePosition(t),this._dragInterval()},_onDragStop:function(r,i,o){this._triggerAll("beforestop",i,o);var n=e(i.target),s=n.draggable("option","revert");s&&n.draggable("option","revert",!1),o.item=i.target,o.sender=this.element,o.index=this.currentGroup.find(this.options.items).add(n).toArray().indexOf(n[0]),s||(this._updatePosition(i),this._updateLocation(n,o)),o.group=this.currentGroup,n.removeClass(this.options.draggedClassName),this.$oldContent&&n.empty().append(this.$oldContent);var a=n;if(r){var l=r.tauSelectable("getSelected"),u=l.not(n);a=a.add(u),o&&o.helper&&(o.helper.removeClass("tau-sortable__helper_multiple_true"),o.helper.children().removeAttr("data-batch_count"));var d=0;if(n.show(),s)u.show();else{var h=t.bind(this._applyDndData,this);h(n,"target"),h(n,"order",d++);var p=n;u.each(function(){var t=e(this);t.insertAfter(p),p=t,t.show(),h(t,"target"),h(t,"order",d++)})}}o.items=a,o.isReverted=s,this._triggerAll("stop",i,o),this._globals.active=!1,this._triggerToConnected("stopconnected",i,o)},_updatePlaceholder:function(t,e,r){var i=this._createPlaceholderElement(e,r);i.height(t.height()),t.empty().append(i),this.$placeholder=t},_createPlaceholderElement:function(t,r){var i=this.options.createPlaceholderContent(t,r),o=['<div class="tau-sortable__placeholder-outer"><div class="tau-sortable__placeholder-inner">',i,"</div></div>"];return e(o.join(""))},_within:function(t,e){var r=t[0],i=r.getBoundingClientRect(),o=t.css(["marginTop","marginRight","marginBottom","marginLeft"]),n=this.options.cursorDistance,s={left:i.left-(Math.round(parseFloat(o.marginLeft))+n),right:i.right+(Math.round(parseFloat(o.marginRight))+n),top:i.top-(Math.round(parseFloat(o.marginTop))+n),bottom:i.bottom+(Math.round(parseFloat(o.marginBottom))+n)};
return e.x>=s.left&&e.x<=s.right&&e.y<=s.bottom&&e.y>=s.top},_processToGroup:function(t,r,i){if(this.options.processToGroup)this.options.processToGroup.call(this,t,r,i);else{var o=e();(this.options.moveInGroup===!0||"shift"===this.options.moveInGroup&&this.shiftPressed)&&(o=i.children()),t.appendTo(o.length?o.eq(0):i)}},_updateCurrentGroup:function(t,e){var r=this.currentGroup;if(this._within(r,this.cursorPosition))return r;var i=this._findNewGroup();return i.length?(this._onGroupLeft(e,r),this._onBeforeGroupEntered(e,i),this._processToGroup(t,r,i),this.currentGroup=i,this.currentGroupOptions=this._getSortableGroupOptions(this.currentGroup)||this.options,this._onGroupEntered(e,i),this._onGroupChanged(t,r,i),i):r},_onGroupLeft:function(t,r){var i=e.extend(t,{group:r});this._triggerAll("groupleft",null,i)},_onBeforeGroupEntered:function(t,r){var i=e.extend(t,{group:r});this._triggerAll("beforegroupentered",null,i)},_onGroupEntered:function(t,r){var i=e.extend(t,{group:r});this._triggerAll("groupentered",null,i)},_onGroupChanged:function(t,e,r){var i={item:this.$placeholder,groupFrom:e,groupTo:r};this._updatePlaceholder(t,this.currentGroupOptions.moveInGroup,r),this._triggerAll("groupchanged",null,i)},_getSortableGroupOptions:function(t){var e=t.closest(".tau-sortable");return e.length>0?e.tauSortable("getOptions"):null},_updateLocation:function(t,e){var r=this._updateCurrentGroup(t,e);this._updateSorting(t,r,e)},_updateSorting:function(t,e,r){var i=this.currentGroupOptions,o=i.moveInGroup,n=o===!0||"shift"===o&&this.shiftPressed;if(n){var s=this.currentGroup.find(i.items).not(t),a=this._findNewItemIndex(s);if(a>-1){var l=s.eq(a);t.index()<l.index()?(r.index=a+1,t.insertAfter(l)):(r.index=a,t.insertBefore(l)),this._lastDraggedIndex=r.index,this._triggerAll("changed",null,r)}else r.index=this._lastDraggedIndex,this._within(t,this.cursorPosition)||(this._processToGroup(t,this.currentGroup,this.currentGroup),this._triggerAll("changed",null,r))}},_updatePosition:function(t){this.cursorPosition={x:t.pageX,y:t.pageY}
},_findNewGroup:function(){for(var t=e(this.options.groups),r=this.cursorPosition,i=0,o=t.length;o>i;i++){var n=t.eq(i);if(this._within(n,r))return n}return e()},_findNewItemIndex:function(t){for(var e=this.cursorPosition,r=0,i=t.length;i>r;r++){var o=t.eq(r);if(this._within(o,e))return r}return-1},_applyDndData:function(r,i,o){var n=this;r.each(function(){var r=e(this),s=t.defaults(r.data("boardDnd")||{},n._createInitialDndData());if("source"==i||"target"==i){var a=r.parents(".i-role-cell:first, .i-role-cellholder:first").eq(0),l=r.prevAll("[role=card]:first"),u=r.nextAll("[role=card]:first"),d=r.data();s[i]={index:r.index(),cellElementId:a.attr("id"),x:a.data("x")||null,y:a.data("y")||null,sliceId:d.id,entityType:d.entityType,entityId:d.id,elementId:r.attr("id"),beforeEntityId:l.data("id"),beforeElementId:l.attr("id"),afterEntityId:u.data("id"),afterElementId:u.attr("id")}}else s[i]=o;r.data("boardDnd",s)})},_createInitialDndData:function(){return{uid:t.uniqueId("boardDnd"),source:{},target:{},order:null}},_triggerToConnected:function(t,r,i){if(this.options.connectedSortable){var o=e(this.options.connectedSortable);if(!o.is(this.element)){var n=o.data("ui-tauSortable");n&&n._trigger(t,r,i)}}},_triggerToConnectedGroup:function(t,e,r){if(this.options.connectedSortable){var i=this.currentGroup.parents(":data(ui-tauSortable)");if(!i.is(this.element)){var o=i.data("ui-tauSortable");o._trigger(t,e,r)}}},_triggerAll:function(t,e,r){this._trigger(t,e,r),this._triggerToConnectedGroup(t,e,r)},destroy:function(){var t,r=this.options.items;t="string"==typeof r?this.element.off("mouseenter.tausortable",r).find(r+":data(ui-draggable)"):e(r).off("mouseenter.tausortable").filter(":data(ui-draggable)"),t.draggable("destroy"),e(document).off(this.eventNamespace),this.element.removeClass("tau-sortable"),this._super()},_setOption:function(t,e){this.dndOptions[t]=e,this._super(t,e)}}),e.extend(e.ui.tauSelectable,{active:!1})});