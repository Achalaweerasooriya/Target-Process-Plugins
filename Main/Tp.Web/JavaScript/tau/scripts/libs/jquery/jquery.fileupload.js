(function(a){typeof define=="function"&&define.amd?define(["jQuery","./jquery.iframe-transport"],a):a(window.jQuery)})(function($){$.widget("blueimp.fileupload",{options:{namespace:undefined,dropZone:$(document),fileInput:undefined,replaceFileInput:!0,paramName:undefined,singleFileUploads:!0,limitMultiFileUploads:undefined,sequentialUploads:!1,limitConcurrentUploads:undefined,forceIframeTransport:!1,postMessage:undefined,multipart:!0,maxChunkSize:undefined,uploadedBytes:undefined,recalculateProgress:!0,formData:function(a){return a.serializeArray()},add:function(a,b){b.submit()},processData:!1,contentType:!1,cache:!1},_refreshOptionsList:["namespace","dropZone","fileInput"],_isXHRUpload:function(a){var b="undefined";return!a.forceIframeTransport&&typeof XMLHttpRequestUpload!==b&&typeof File!==b&&(!a.multipart||typeof FormData!==b)},_getFormData:function(a){var b;return typeof a.formData=="function"?a.formData(a.form):$.isArray(a.formData)?a.formData:a.formData?(b=[],$.each(a.formData,function(a,c){b.push({name:a,value:c})}),b):[]},_getTotal:function(a){var b=0;return $.each(a,function(a,c){b+=c.size||1}),b},_onProgress:function(a,b){if(a.lengthComputable){var c=b.total||this._getTotal(b.files),d=parseInt(a.loaded/a.total*(b.chunkSize||c),10)+(b.uploadedBytes||0);this._loaded+=d-(b.loaded||b.uploadedBytes||0),b.lengthComputable=!0,b.loaded=d,b.total=c,this._trigger("progress",a,b),this._trigger("progressall",a,{lengthComputable:!0,loaded:this._loaded,total:this._total})}},_initProgressListener:function(a){var b=this,c=a.xhr?a.xhr():$.ajaxSettings.xhr();c.upload&&($(c.upload).bind("progress",function(c){var d=c.originalEvent;c.lengthComputable=d.lengthComputable,c.loaded=d.loaded,c.total=d.total,b._onProgress(c,a)}),a.xhr=function(){return c})},_initXHRData:function(a){var b,c=a.files[0];if(!a.multipart||a.blob)a.headers=$.extend(a.headers,{"X-File-Name":c.name,"X-File-Type":c.type,"X-File-Size":c.size}),a.blob?a.multipart||(a.contentType="application/octet-stream",a.data=a.blob):(a.contentType=c.type,a.data=c);a.multipart&&typeof FormData!="undefined"&&(a.postMessage?(b=this._getFormData(a),a.blob?b.push({name:a.paramName,value:a.blob}):$.each(a.files,function(c,d){b.push({name:a.paramName,value:d})})):(a.formData instanceof FormData?b=a.formData:(b=new FormData,$.each(this._getFormData(a),function(a,c){b.append(c.name,c.value)})),a.blob?b.append(a.paramName,a.blob):$.each(a.files,function(c,d){d instanceof Blob&&b.append(a.paramName,d)})),a.data=b),a.blob=null},_initIframeSettings:function(a){a.dataType="iframe "+(a.dataType||""),a.formData=this._getFormData(a)},_initDataSettings:function(a){this._isXHRUpload(a)?(this._chunkedUpload(a,!0)||(a.data||this._initXHRData(a),this._initProgressListener(a)),a.postMessage&&(a.dataType="postmessage "+(a.dataType||""))):this._initIframeSettings(a,"iframe")},_initFormSettings:function(a){if(!a.form||!a.form.length)a.form=$(a.fileInput.prop("form"));a.paramName||(a.paramName=a.fileInput.prop("name")||"files[]"),a.url||(a.url=a.form.prop("action")||location.href),a.type=(a.type||a.form.prop("method")||"").toUpperCase(),a.type!=="POST"&&a.type!=="PUT"&&(a.type="POST")},_getAJAXSettings:function(a){var b=$.extend({},this.options,a);return this._initFormSettings(b),this._initDataSettings(b),b},_enhancePromise:function(a){return a.success=a.done,a.error=a.fail,a.complete=a.always,a},_getXHRPromise:function(a,b,c){var d=$.Deferred(),e=d.promise();return b=b||this.options.context||e,a===!0?d.resolveWith(b,c):a===!1&&d.rejectWith(b,c),e.abort=d.promise,this._enhancePromise(e)},_chunkedUpload:function(a,b){var c=this,d=a.files[0],e=d.size,f=a.uploadedBytes=a.uploadedBytes||0,g=a.maxChunkSize||e,h=d.webkitSlice||d.mozSlice||d.slice,i,j,k,l;return!(this._isXHRUpload(a)&&h&&(f||g<e))||a.data?!1:b?!0:f>=e?(d.error="uploadedBytes",this._getXHRPromise(!1,a.context,[null,"error",d.error])):(j=Math.ceil((e-f)/g),i=function(b){return b?i(b-=1).pipe(function(){var e=$.extend({},a);return e.blob=h.call(d,f+b*g,f+(b+1)*g),e.chunkSize=e.blob.size,c._initXHRData(e),c._initProgressListener(e),k=($.ajax(e)||c._getXHRPromise(!1,e.context)).done(function(){e.loaded||c._onProgress($.Event("progress",{lengthComputable:!0,loaded:e.chunkSize,total:e.chunkSize}),e),a.uploadedBytes=e.uploadedBytes+=e.chunkSize}),k}):c._getXHRPromise(!0,a.context)},l=i(j),l.abort=function(){return k.abort()},this._enhancePromise(l))},_beforeSend:function(a,b){this._active===0&&this._trigger("start"),this._active+=1,this._loaded+=b.uploadedBytes||0,this._total+=this._getTotal(b.files)},_onDone:function(a,b,c,d){this._isXHRUpload(d)||this._onProgress($.Event("progress",{lengthComputable:!0,loaded:1,total:1}),d),d.result=a,d.textStatus=b,d.jqXHR=c,this._trigger("done",null,d)},_onFail:function(a,b,c,d){d.jqXHR=a,d.textStatus=b,d.errorThrown=c,this._trigger("fail",null,d),d.recalculateProgress&&(this._loaded-=d.loaded||d.uploadedBytes||0,this._total-=d.total||this._getTotal(d.files))},_onAlways:function(a,b,c,d){this._active-=1,d.textStatus=b,c&&c.always?(d.jqXHR=c,d.result=a):(d.jqXHR=a,d.errorThrown=c),this._trigger("always",null,d),this._active===0&&(this._trigger("stop"),this._loaded=this._total=0)},_onSend:function(a,b){var c=this,d,e,f,g=c._getAJAXSettings(b),h=function(b,e){return c._sending+=1,d=d||(b!==!1&&c._trigger("send",a,g)!==!1&&(c._chunkedUpload(g)||$.ajax(g))||c._getXHRPromise(!1,g.context,e)).done(function(a,b,d){c._onDone(a,b,d,g)}).fail(function(a,b,d){c._onFail(a,b,d,g)}).always(function(a,b,d){c._sending-=1,c._onAlways(a,b,d,g);if(g.limitConcurrentUploads&&g.limitConcurrentUploads>c._sending){var e=c._slots.shift();while(e){if(!e.isRejected()){e.resolve();break}e=c._slots.shift()}}}),d};return this._beforeSend(a,g),this.options.sequentialUploads||this.options.limitConcurrentUploads&&this.options.limitConcurrentUploads<=this._sending?(this.options.limitConcurrentUploads>1?(e=$.Deferred(),this._slots.push(e),f=e.pipe(h)):f=this._sequence=this._sequence.pipe(h,h),f.abort=function(){var a=[undefined,"abort","abort"];return d?d.abort():(e&&e.rejectWith(a),h(!1,a))},this._enhancePromise(f)):h()},_onAdd:function(a,b){var c=this,d=!0,e=$.extend({},this.options,b),f=e.limitMultiFileUploads,g,h;if(!e.singleFileUploads&&!f||!this._isXHRUpload(e))g=[b.files];else if(!e.singleFileUploads&&f){g=[];for(h=0;h<b.files.length;h+=f)g.push(b.files.slice(h,h+f))}return b.originalFiles=b.files,$.each(g||b.files,function(e,f){var h=g?f:[f],i=$.extend({},b,{files:h});return i.submit=function(){return i.jqXHR=this.jqXHR=c._trigger("submit",a,this)!==!1&&c._onSend(a,this),this.jqXHR},d=c._trigger("add",a,i)}),d},_normalizeFile:function(a,b){b.name===undefined&&b.size===undefined&&(b.name=b.fileName,b.size=b.fileSize)},_replaceFileInput:function(a){var b=a.clone(!0);$("<form></form>").append(b)[0].reset(),a.after(b).detach(),$.cleanData(a.unbind("remove")),this.options.fileInput=this.options.fileInput.map(function(c,d){return d===a[0]?b[0]:d}),a[0]===this.element[0]&&(this.element=b)},_onChange:function(a){var b=a.data.fileupload,c={files:$.each($.makeArray(a.target.files),b._normalizeFile),fileInput:$(a.target),form:$(a.target.form)};c.files.length||(c.files=[{name:a.target.value.replace(/^.*\\/,"")}]),b.options.replaceFileInput&&b._replaceFileInput(c.fileInput);if(b._trigger("change",a,c)===!1||b._onAdd(a,c)===!1)return!1},_onPaste:function(a){var b=a.data.fileupload,c=a.originalEvent.clipboardData,d=c&&c.items||[],e={files:[]};$.each(d,function(a,b){var c=b.getAsFile&&b.getAsFile();c&&e.files.push(c)});if(b._trigger("paste",a,e)===!1||b._onAdd(a,e)===!1)return!1},_onDrop:function(a){var b=a.data.fileupload,c=a.dataTransfer=a.originalEvent.dataTransfer,d={files:$.each($.makeArray(c&&c.files),b._normalizeFile)};if(b._trigger("drop",a,d)===!1||b._onAdd(a,d)===!1)return!1;a.preventDefault()},_onDragOver:function(a){var b=a.data.fileupload,c=a.dataTransfer=a.originalEvent.dataTransfer;if(b._trigger("dragover",a)===!1)return!1;c&&(c.dropEffect=c.effectAllowed="copy"),a.preventDefault()},_initEventHandlers:function(){var a=this.options.namespace;this.options.dropZone.bind("dragover."+a,{fileupload:this},this._onDragOver).bind("drop."+a,{fileupload:this},this._onDrop).bind("paste."+a,{fileupload:this},this._onPaste),this.options.fileInput.bind("change."+a,{fileupload:this},this._onChange)},_destroyEventHandlers:function(){var a=this.options.namespace;this.options.dropZone.unbind("dragover."+a,this._onDragOver).unbind("drop."+a,this._onDrop).unbind("paste."+a,this._onPaste),this.options.fileInput.unbind("change."+a,this._onChange)},_beforeSetOption:function(a,b){this._destroyEventHandlers()},_afterSetOption:function(a,b){var c=this.options;c.fileInput||(c.fileInput=$()),c.dropZone||(c.dropZone=$()),this._initEventHandlers()},_setOption:function(a,b){var c=$.inArray(a,this._refreshOptionsList)!==-1;c&&this._beforeSetOption(a,b),$.Widget.prototype._setOption.call(this,a,b),c&&this._afterSetOption(a,b)},_create:function(){var a=this.options;a.namespace=a.namespace||this.widgetName,a.fileInput===undefined?a.fileInput=this.element.is("input:file")?this.element:this.element.find("input:file"):a.fileInput||(a.fileInput=$()),a.dropZone||(a.dropZone=$()),this._slots=[],this._sequence=this._getXHRPromise(!0),this._sending=this._active=this._loaded=this._total=0,this._initEventHandlers()},destroy:function(){this._destroyEventHandlers(),$.Widget.prototype.destroy.call(this)},enable:function(){$.Widget.prototype.enable.call(this),this._initEventHandlers()},disable:function(){this._destroyEventHandlers(),$.Widget.prototype.disable.call(this)},add:function(a){if(!a||this.options.disabled)return;a.files=$.each($.makeArray(a.files),this._normalizeFile),this._onAdd(null,a)},send:function(a){if(a&&!this.options.disabled){a.files=$.each($.makeArray(a.files),this._normalizeFile);if(a.files.length)return this._onSend(null,a)}return this._getXHRPromise(!1,a&&a.context)}})})