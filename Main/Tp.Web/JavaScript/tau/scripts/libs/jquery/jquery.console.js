define(["jQuery"],function(jQuery){return function($){$.fn.console=function(a){function x(){n=0,o="",s=0,N(),j=$('<div class="jquery-console-prompt-box"></div>');var a=$('<span class="jquery-console-prompt-label"></span>'),b=w.continuedPrompt?m:l;j.append(a.text(b).show()),a.html(a.html().replace(" ","&nbsp;")),k=$('<span class="jquery-console-prompt"></span>'),j.append(k),h.append(j),Z()}function y(a){return(a.keyCode==b.tab||a.keyCode==192)&&a.altKey}function z(b){if(r.length==0)return;s+=b,s<0?s=r.length:s>r.length&&(s=0);var c=o;s==0?o=p:o=r[s-1],a.historyPreserveColumn?o.length<n+1?n=o.length:n==0&&(n=o.length):n=o.length,Z()}function A(){z(-1)}function B(){z(1)}function C(a){r.push(a),p=""}function D(){return n<o.length?(o=o.substring(0,n)+o.substring(n+1),p=o,!0):!1}function E(){Q(-1)&&(D(),Z())}function F(){D()&&Z()}function G(){while(D())Z()}function H(){while(n<o.length&&!X(o[n]))D(),Z();while(n<o.length&&X(o[n]))D(),Z()}function I(){var b=o;if(typeof a.commandValidate=="function"){var c=a.commandValidate(b);c==1||c==0?c&&L():O(c,"jquery-console-message-error")}else L()}function J(){h.prop({scrollTop:h.prop("scrollHeight")})}function K(){typeof a.cancelHandle=="function"&&a.cancelHandle()}function L(){if(typeof a.commandHandle=="function"){M(),C(o);var b=o;w.continuedPrompt?q?q+="\n"+o:q=o:q=undefined,q&&(b=q);var c=a.commandHandle(b,function(a){O(a)});w.continuedPrompt&&!q&&(q=o),typeof c=="boolean"?c?O():O("Command failed.","jquery-console-message-error"):typeof c=="string"?O(c,"jquery-console-message-success"):typeof c=="object"&&c.length?O(c):w.continuedPrompt&&O()}}function M(){u=!1}function N(){u=!0}function O(a,b){n=-1,Z();if(typeof a=="string")P(a,b);else for(var c in a){var d=a[c];P(d.msg,d.className)}x()}function P(a,b){var c=$('<div class="jquery-console-message"></div>');b&&c.addClass(b),c.filledText(a).hide(),h.append(c),c.show()}function Q(a){return n+a>=0&&n+a<=o.length?(n+=a,!0):!1}function R(){return Q(1)?(Z(),!0):!1}function S(){return Q(-1)?(Z(),!0):!1}function T(){Q(-n)&&Z()}function U(){Q(o.length-n)&&Z()}function V(){while(n<o.length&&!X(o[n])&&R());while(n<o.length&&X(o[n])&&R());}function W(){while(n-1>=0&&!X(o[n-1])&&S());while(n-1>=0&&X(o[n-1])&&S());}function X(a){if(typeof a=="string"){var b=a.charCodeAt();return b>="A".charCodeAt()&&b<="Z".charCodeAt()||b>="a".charCodeAt()&&b<="z".charCodeAt()||b>="0".charCodeAt()&&b<="9".charCodeAt()}return!1}function Y(){}function Z(){var a=o,b="";if(n>0&&a=="")b=e;else if(n==o.length)b=_(a)+e;else{var c=a.substring(0,n),d=a.substring(n,n+1);d&&(d='<span class="jquery-console-cursor">'+_(d)+"</span>");var f=a.substring(n+1);b=_(c)+d+_(f)}k.html(b),J()}function _(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/</g,"&lt;").replace(/ /g,"&nbsp;").replace(/\n/g,"<br />").replace(/([^<>&]{10})/g,"$1<wbr>&shy;"+f)}var b={37:S,39:R,38:A,40:B,8:E,46:F,35:U,36:T,13:I,18:Y},c={65:T,69:U,68:F,78:B,80:A,66:S,70:R,75:G},d={70:V,66:W,68:H},e='<span class="jquery-console-cursor">&nbsp;</span>',f=$.browser.opera?"&#8203;":"",g=$(this),h=$('<div class="jquery-console-inner"></div>'),i=$('<textarea class="jquery-console-typer"></textarea>'),j,k,l=a&&a.promptLabel?a.promptLabel:"> ",m=a&&a.continuedPromptLabel?a.continuedPromptLabel:"> ",n=0,o="",p="",q="",r=[],s=0,t=0,u=!0,v=!1,w={};return function(){g.append(h),h.append(i),i.css({position:"absolute",top:0,left:"-9999px"}),a.welcomeMessage&&P(a.welcomeMessage,"jquery-console-welcome"),x(),a.autofocus&&(h.addClass("jquery-console-focus"),i.focus(),setTimeout(function(){h.addClass("jquery-console-focus"),i.focus()},100)),w.inner=h,w.typer=i,w.scrollToBottom=J}(),w.reset=function(){var b=typeof a.welcomeMessage!="undefined";h.parent().fadeOut(function(){h.find("div").each(function(){b?b=!1:$(this).remove()}),x(),h.parent().fadeIn(function(){h.addClass("jquery-console-focus"),i.focus()})})},w.notice=function(a,b){var c=$('<div class="notice"></div>').append($("<div></div>").text(a)).css({visibility:"hidden"});g.append(c);var d=!0;if(b=="fadeout")setTimeout(function(){c.fadeOut(function(){c.remove()})},4e3);else if(b=="prompt"){var e=$('<br/><div class="action"><a href="javascript:">OK</a><div class="clear"></div></div>');c.append(e),d=!1,e.click(function(){c.fadeOut(function(){c.remove(),h.css({opacity:1})})})}var f=c.height();return c.css({height:"0px",visibility:"visible"}).animate({height:f+"px"},function(){d||h.css({opacity:.5})}),c.css("cursor","default"),c},$("body").keydown(function(a){if(a.ctrlKey||a.altKey)return;return h.addClass("jquery-console-focus"),h.removeClass("jquery-console-nofocus"),i.focus(),J(),!1}),i.blur(function(){h.removeClass("jquery-console-focus"),h.addClass("jquery-console-nofocus")}),i.bind("paste",function(a){i.val(""),setTimeout(function(){i.consoleInsert(i.val()),i.val("")},0)}),i.keydown(function(a){t=0;var e=a.keyCode;if(a.ctrlKey&&e==67)return t=e,K(),!1;if(u){if(e in b)return t=e,b[e](),!1;if(a.ctrlKey&&e in c)return t=e,c[e](),!1;if(a.altKey&&e in d)return t=e,d[e](),!1}}),i.keypress(function(b){var c=b.keyCode||b.which;if(y(b))return!1;if(b.ctrlKey&&String.fromCharCode(c).toLowerCase()=="v")return!0;if(u&&t!=c&&c>=32){if(t)return!1;(typeof a.charInsertTrigger=="undefined"||typeof a.charInsertTrigger=="function"&&a.charInsertTrigger(c,o))&&i.consoleInsert(c)}if($.browser.webkit)return!1}),i.consoleInsert=function(a){var b=isNaN(a)?a:String.fromCharCode(a),c=o.substring(0,n),d=o.substring(n);o=c+b+d,Q(b.length),p=o,Z()},w.promptText=function(a){return a&&(o=a,n=o.length,Z()),o},w},$.fn.filledText=function(a){return $(this).html(a),$(this).html($(this).html()),this}}(jQuery),jQuery})