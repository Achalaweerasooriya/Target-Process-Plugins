// JQuery Console 1.0
// Sun Feb 21 20:28:47 GMT 2010
//
// Copyright 2010 Chris Done, Simon David Pratt. All rights reserved.
//
// Redistribution and use in source and binary forms, with or without
// modification, are permitted provided that the following conditions
// are met:
//
//    1. Redistributions of source code must retain the above
//       copyright notice, this list of conditions and the following
//       disclaimer.
//
//    2. Redistributions in binary form must reproduce the above
//       copyright notice, this list of conditions and the following
//       disclaimer in the documentation and/or other materials
//       provided with the distribution.
//
// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
// "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
// LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
// FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
// COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
// INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
// BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
// LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
// CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
// LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
// ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
// POSSIBILITY OF SUCH DAMAGE.

define(["libs/jquery/jquery"],function(jQuery){return function($){$.fn.console=function(config){function newPromptBox(){column=0,promptText="",ringn=0,enableInput(),promptBox=$('<div class="jquery-console-prompt-box"></div>');var label=$('<span class="jquery-console-prompt-label"></span>'),labelText=extern.continuedPrompt?continuedPromptLabel:promptLabel;promptBox.append(label.text(labelText).show()),label.html(label.html().replace(" ","&nbsp;")),prompt=$('<span class="jquery-console-prompt"></span>'),promptBox.append(prompt),inner.append(promptBox),updatePromptDisplay()}function isIgnorableKey(e){return(e.keyCode==keyCodes.tab||e.keyCode==192)&&e.altKey}function rotateHistory(n){if(history.length==0)return;ringn+=n,ringn<0?ringn=history.length:ringn>history.length&&(ringn=0);var prevText=promptText;ringn==0?promptText=restoreText:promptText=history[ringn-1],config.historyPreserveColumn?promptText.length<column+1?column=promptText.length:column==0&&(column=promptText.length):column=promptText.length,updatePromptDisplay()}function previousHistory(){rotateHistory(-1)}function nextHistory(){rotateHistory(1)}function addToHistory(line){history.push(line),restoreText=""}function deleteCharAtPos(){return column<promptText.length?(promptText=promptText.substring(0,column)+promptText.substring(column+1),restoreText=promptText,!0):!1}function backDelete(){moveColumn(-1)&&(deleteCharAtPos(),updatePromptDisplay())}function forwardDelete(){deleteCharAtPos()&&updatePromptDisplay()}function deleteUntilEnd(){while(deleteCharAtPos())updatePromptDisplay()}function deleteNextWord(){while(column<promptText.length&&!isCharAlphanumeric(promptText[column]))deleteCharAtPos(),updatePromptDisplay();while(column<promptText.length&&isCharAlphanumeric(promptText[column]))deleteCharAtPos(),updatePromptDisplay()}function commandTrigger(){var line=promptText;if(typeof config.commandValidate=="function"){var ret=config.commandValidate(line);ret==1||ret==0?ret&&handleCommand():commandResult(ret,"jquery-console-message-error")}else handleCommand()}function scrollToBottom(){inner.prop({scrollTop:inner.prop("scrollHeight")})}function cancelExecution(){typeof config.cancelHandle=="function"&&config.cancelHandle()}function handleCommand(){if(typeof config.commandHandle=="function"){disableInput(),addToHistory(promptText);var text=promptText;extern.continuedPrompt?continuedText?continuedText+="\n"+promptText:continuedText=promptText:continuedText=undefined,continuedText&&(text=continuedText);var ret=config.commandHandle(text,function(msgs){commandResult(msgs)});extern.continuedPrompt&&!continuedText&&(continuedText=promptText),typeof ret=="boolean"?ret?commandResult():commandResult("Command failed.","jquery-console-message-error"):typeof ret=="string"?commandResult(ret,"jquery-console-message-success"):typeof ret=="object"&&ret.length?commandResult(ret):extern.continuedPrompt&&commandResult()}}function disableInput(){acceptInput=!1}function enableInput(){acceptInput=!0}function commandResult(msg,className){column=-1,updatePromptDisplay();if(typeof msg=="string")message(msg,className);else for(var x in msg){var ret=msg[x];message(ret.msg,ret.className)}newPromptBox()}function message(msg,className){var mesg=$('<div class="jquery-console-message"></div>');className&&mesg.addClass(className),mesg.filledText(msg).hide(),inner.append(mesg),mesg.show()}function moveColumn(n){return column+n>=0&&column+n<=promptText.length?(column+=n,!0):!1}function moveForward(){return moveColumn(1)?(updatePromptDisplay(),!0):!1}function moveBackward(){return moveColumn(-1)?(updatePromptDisplay(),!0):!1}function moveToStart(){moveColumn(-column)&&updatePromptDisplay()}function moveToEnd(){moveColumn(promptText.length-column)&&updatePromptDisplay()}function moveToNextWord(){while(column<promptText.length&&!isCharAlphanumeric(promptText[column])&&moveForward());while(column<promptText.length&&isCharAlphanumeric(promptText[column])&&moveForward());}function moveToPreviousWord(){while(column-1>=0&&!isCharAlphanumeric(promptText[column-1])&&moveBackward());while(column-1>=0&&isCharAlphanumeric(promptText[column-1])&&moveBackward());}function isCharAlphanumeric(charToTest){if(typeof charToTest=="string"){var code=charToTest.charCodeAt();return code>="A".charCodeAt()&&code<="Z".charCodeAt()||code>="a".charCodeAt()&&code<="z".charCodeAt()||code>="0".charCodeAt()&&code<="9".charCodeAt()}return!1}function doNothing(){}function updatePromptDisplay(){var line=promptText,html="";if(column>0&&line=="")html=cursor;else if(column==promptText.length)html=htmlEncode(line)+cursor;else{var before=line.substring(0,column),current=line.substring(column,column+1);current&&(current='<span class="jquery-console-cursor">'+htmlEncode(current)+"</span>");var after=line.substring(column+1);html=htmlEncode(before)+current+htmlEncode(after)}prompt.html(html),scrollToBottom()}function htmlEncode(text){return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/</g,"&lt;").replace(/ /g,"&nbsp;").replace(/\n/g,"<br />").replace(/([^<>&]{10})/g,"$1<wbr>&shy;"+wbr)}var keyCodes={37:moveBackward,39:moveForward,38:previousHistory,40:nextHistory,8:backDelete,46:forwardDelete,35:moveToEnd,36:moveToStart,13:commandTrigger,18:doNothing},ctrlCodes={65:moveToStart,69:moveToEnd,68:forwardDelete,78:nextHistory,80:previousHistory,66:moveBackward,70:moveForward,75:deleteUntilEnd},altCodes={70:moveToNextWord,66:moveToPreviousWord,68:deleteNextWord},cursor='<span class="jquery-console-cursor">&nbsp;</span>',wbr=$.browser.opera?"&#8203;":"",container=$(this),inner=$('<div class="jquery-console-inner"></div>'),typer=$('<textarea class="jquery-console-typer"></textarea>'),promptBox,prompt,promptLabel=config&&config.promptLabel?config.promptLabel:"> ",continuedPromptLabel=config&&config.continuedPromptLabel?config.continuedPromptLabel:"> ",column=0,promptText="",restoreText="",continuedText="",history=[],ringn=0,cancelKeyPress=0,acceptInput=!0,cancelCommand=!1,extern={};return function(){container.append(inner),inner.append(typer),typer.css({position:"absolute",top:0,left:"-9999px"}),config.welcomeMessage&&message(config.welcomeMessage,"jquery-console-welcome"),newPromptBox(),config.autofocus&&(inner.addClass("jquery-console-focus"),typer.focus(),setTimeout(function(){inner.addClass("jquery-console-focus"),typer.focus()},100)),extern.inner=inner,extern.typer=typer,extern.scrollToBottom=scrollToBottom}(),extern.reset=function(){var welcome=typeof config.welcomeMessage!="undefined";inner.parent().fadeOut(function(){inner.find("div").each(function(){welcome?welcome=!1:$(this).remove()}),newPromptBox(),inner.parent().fadeIn(function(){inner.addClass("jquery-console-focus"),typer.focus()})})},extern.notice=function(msg,style){var n=$('<div class="notice"></div>').append($("<div></div>").text(msg)).css({visibility:"hidden"});container.append(n);var focused=!0;if(style=="fadeout")setTimeout(function(){n.fadeOut(function(){n.remove()})},4e3);else if(style=="prompt"){var a=$('<br/><div class="action"><a href="javascript:">OK</a><div class="clear"></div></div>');n.append(a),focused=!1,a.click(function(){n.fadeOut(function(){n.remove(),inner.css({opacity:1})})})}var h=n.height();return n.css({height:"0px",visibility:"visible"}).animate({height:h+"px"},function(){focused||inner.css({opacity:.5})}),n.css("cursor","default"),n},$("body").keydown(function(evt){if(evt.ctrlKey||evt.altKey)return;return inner.addClass("jquery-console-focus"),inner.removeClass("jquery-console-nofocus"),typer.focus(),scrollToBottom(),!1}),typer.blur(function(){inner.removeClass("jquery-console-focus"),inner.addClass("jquery-console-nofocus")}),typer.bind("paste",function(e){typer.val(""),setTimeout(function(){typer.consoleInsert(typer.val()),typer.val("")},0)}),typer.keydown(function(e){cancelKeyPress=0;var keyCode=e.keyCode;if(e.ctrlKey&&keyCode==67)return cancelKeyPress=keyCode,cancelExecution(),!1;if(acceptInput){if(keyCode in keyCodes)return cancelKeyPress=keyCode,keyCodes[keyCode](),!1;if(e.ctrlKey&&keyCode in ctrlCodes)return cancelKeyPress=keyCode,ctrlCodes[keyCode](),!1;if(e.altKey&&keyCode in altCodes)return cancelKeyPress=keyCode,altCodes[keyCode](),!1}}),typer.keypress(function(e){var keyCode=e.keyCode||e.which;if(isIgnorableKey(e))return!1;if(e.ctrlKey&&String.fromCharCode(keyCode).toLowerCase()=="v")return!0;if(acceptInput&&cancelKeyPress!=keyCode&&keyCode>=32){if(cancelKeyPress)return!1;(typeof config.charInsertTrigger=="undefined"||typeof config.charInsertTrigger=="function"&&config.charInsertTrigger(keyCode,promptText))&&typer.consoleInsert(keyCode)}if($.browser.webkit)return!1}),typer.consoleInsert=function(data){var text=isNaN(data)?data:String.fromCharCode(data),before=promptText.substring(0,column),after=promptText.substring(column);promptText=before+text+after,moveColumn(text.length),restoreText=promptText,updatePromptDisplay()},extern.promptText=function(text){return text&&(promptText=text,column=promptText.length,updatePromptDisplay()),promptText},extern},$.fn.filledText=function(txt){return $(this).html(txt),$(this).html($(this).html()),this}}(jQuery),jQuery})