define(["Underscore","libs/jquery/jquery.ui"],function(t,i){function e(t){return t=parseFloat(t),0>t?""+t:t>0?"+"+t:""}function o(t){if(t.offset){var i=t.at.replace(r,"").split(" "),o=t.offset.split(" ");t.at=i[0]+e(o[0])+" "+i[1]+e(o[1]),delete t.offset}return t}function n(t,i,e){return t>=i&&e>=t}function s(t,i,e){switch(e){case"right":return n(t.left+9,i.left,i.right);case"left":return n(t.right-9,i.left,i.right);case"bottom":return n(t.top+9,i.top,i.bottom);case"top":return n(t.bottom-9,i.top,i.bottom);default:return!1}}var r=/[\+\-]\d+(\.[\d]+)?%?/g,a={};i.widget("ui.tauBubble",{options:{within:null,hideOnScroll:!0,parent:null,appendTo:null,appendMethod:null,alignTo:null,zIndex:null,onBeforeShow:i.noop,onShow:i.noop,onHide:i.noop,onPositionConfig:i.noop,onArrowPositionConfig:i.noop,onCurrentOrientationConfig:i.noop,onResize:i.noop,showOnCreation:!1,showArrow:!0,ignoreOverlap:!1,closeOnEscape:!0,mode:"bubble",showEvent:"click",hideEvent:"click",documentMouseEvent:"mousedown",className:"",content:"",stackName:"default",delay:0,template:['<div class="tau-bubble">','    <div class="tau-bubble__arrow" role="arrow"></div>','    <div class="tau-bubble__inner" role="content"></div>',"</div>"].join(""),dontCloseSelectors:[]},_timeoutToken:null,toggle:function(t){this.$popup&&this.$popup.is(":visible")?this._onHideEvent(t):this._onShowEvent(t)},show:function(){var t=this.options;if(!t.disabled){this._initInstance();var i=this.$popup;""!=t.zIndex&&(t.zIndex=t.zIndex||this.$target.zIndex()+1,i.zIndex(t.zIndex)),i.addClass("i-role-bubble");var e=this.$target.parents(".i-role-bubble:first");if(e.length&&(this.parentId=e.attr("id"),i.data("parentId",this.parentId)),this.$target.trigger("show.before",{}),t.onBeforeShow.call(this,i)!==!1){i.addClass("i-state_visible"),t.className&&i.addClass(t.className),i.show(),this.adjust(),t.onShow.call(this,i),this._hideOtherBubbles(),this._subscribeToGlobalEvents();var o={api:this,target:this.$target,popup:this.$popup};this._trigger("show"),this.$target.trigger("show",o),this.$popup.trigger("show",o)}}},_hideOtherBubbles:function(){for(var t=a[this.options.stackName]||[],i=t.length-1;i>=0;i--){var e=t[i];if(e!=this&&e.id!=this.parentId&&(e.$target.trigger("externalClose",{}),e.hide()),e.id==this.parentId)break}},_hideChildrenBubbles:function(){for(var t=a[this.options.stackName],i=t.length-1;i>=0;i--){var e=t[i];e.parentId==this.id&&(e.$target.trigger("externalClose",{}),e.hide())}},hide:function(t){t=t||{};var i=this.$popup;i&&i.hasClass("i-state_visible")&&(i.removeClass("i-state_visible"),this.options.onHide.call(this,i),i.hide(),this._hideChildrenBubbles(),this.options.className&&i.removeClass(this.options.className),this._unsubscribeFromGlobalEvents(),this.$target.trigger("close",{event:t}),this._trigger("hide",t,t))},isVisible:function(){return this.$popup&&this.$popup.hasClass("i-state_visible")},_create:function(){var t=this.options;this.$target=this.element,this.id="bubble"+this.uuid,t.showOnCreation&&this.show(),t.showEvent==t.hideEvent?this.$target.on(t.showEvent+".tauBubble",this._onToggleEvent.bind(this)):(this.$target.on(t.showEvent+".tauBubble",this._onShowEvent.bind(this)),this.$target.on(t.hideEvent+".tauBubble",this._onHideEvent.bind(this))),this._trigger("onCreate")},_getDelay:function(){var i=this.options.delay,e=t.isFunction(i)?i.call(this):i;return e>0?e:0},_clearTimeout:function(){this._timeoutToken&&clearTimeout(this._timeoutToken)},_onShowEvent:function(i){if(this._clearTimeout(),!this._isLinkClicked(i)){var e=this._getDelay();e?this._timeoutToken=t.delay(this.show.bind(this),e):this.show()}},_onHideEvent:function(){this._clearTimeout(),this.hide()},_isLinkClicked:function(t){if(!t||"click"!==t.type)return!1;var e=i(t.target);return e.is("a")||e.parent().is("a")},_onToggleEvent:function(t){t.isPropagationStopped()||this._isLinkClicked(t)||(t.stopPropagation(),this.toggle(t))},_initInstance:function(){if(!this._isInitialize){this._isInitialize=!0;var e=this.options,o=i(e.template).attr("id",this.id);e.showCloseButton&&i('<div class="tau-bubble__control-close" role="close"></div>').appendTo(o).click(i.proxy(this.hide,this)),this.$popup=o,this._append(o),e.content&&this.setContent(e.content),this.$arrow=o.find("[role=arrow]"),a[e.stackName]=a[e.stackName]||[],t.include(a[e.stackName],this)||a[e.stackName].push(this),o.mouseenter(function(){o.data("focus",!0)}),o.mouseleave(function(){o.data("focus",!1)}),e.hideOnScroll&&i(e.appendTo).on("scroll.tauBubble",i.proxy(function(){this.hide(),this.$target.trigger("externalClose",{})},this))}},_append:function(t){var e=this.options,o=i(e.appendTo?e.appendTo:[]),n="appendTo";o.length||(o=this.$target.parents(".i-role-bubble-holder:first"),n="appendTo"),o.length||(o=this.$target.parents(".tau-bubble:first").prevAll(".i-role-application:first"),n="insertAfter"),o.length||(o=this.$target.parents(".i-role-application:first"),n="insertAfter"),o.length||(o=i("body"),n="appendTo"),e.appendTo=o,t[e.appendMethod||n](o)},_onKeyDown:function(t){t.keyCode==i.ui.keyCode.ESCAPE&&(this.$target.trigger("externalClose",{}),this.hide(t))},widget:function(){return this.$popup||i()},adjustPosition:function(t){var i=this.$popup;if(i){var e=this.getAlignTo(),n=t||(this.options.showArrow?e[0].getBoundingClientRect():{}),r=this._getPositionConfig();r=this.options.onPositionConfig(r)||r,r=o(r);var a={},h={};r.using=function(t,e){var o=e.element;a={left:o.left,top:o.top,width:o.width,height:o.height,right:o.left+o.width,bottom:o.top+o.height},h=t,i.css(h)},i.css({top:0,left:0}).position(r);var l=this._getCurrentOrientation(a,n);i.hasClass("i-orientation_"+l)||(i.removeClass("i-orientation_"+i.attr("data-orientation")),i.addClass("i-orientation_"+l),i.attr("data-orientation",l));var u=!1;if(this.options.showArrow&&(u=this.options.ignoreOverlap||!s(n,a,l)),u){this.$arrow.attr("data-orientation",l);var d=this._getArrowPositionConfig(a,n,e);this.$arrow.position(d),this.$arrow.show()}else this.$arrow.hide()}},adjustSize:function(){if(this.options.onResize&&this.options.onResize!==i.noop){var t=this.$popup;if(t){var e=i("body")[0],o={height:e.clientHeight,width:e.clientWidth},n=t[0].getBoundingClientRect(),s={height:o.height-n.top,width:o.width-n.left};this.options.onResize(t,s)}}},adjust:t.throttle(function(){if(this.element.data(this.widgetFullName)){var t;if(this.options.showArrow){var i=this.getAlignTo();t=i[0].getBoundingClientRect()}this.adjustPosition(t),this.adjustSize(),this.adjustPosition(t)}},10),_getArrowPositionConfig:function(i,e,n){var s={within:this.options.within,of:n,collision:"fit flip"},r=i.width>e.width/1.1,a=this._getCurrentOrientation(i,e),h={top:{my:"center top",at:r?"center bottom":"left+20 bottom"},bottom:{my:"center bottom",at:r?"center top":"left+20 top"},left:{my:"left center",at:"right center"},right:{my:"right center",at:"left center"}};return s=t.defaults(h[a],s),s=this.options.onArrowPositionConfig(s,a)||s,s=o(s)},_getPositionConfig:function(){var t=this.options,e={within:t.within,of:this.getAlignTo(),collision:"fit flip"};return"tooltip"==t.mode?i.extend(e,{my:"center top",at:"center bottom"}):i.extend(e,{my:"left top",at:"left-30 bottom"}),e},_getCurrentOrientation:function(t,i){var e="top";return Math.floor(t.top)+1<Math.floor(i.top)&&(e="bottom"),t.right<=i.left+1?e="right":t.left+1>=i.right&&(e="left"),e=this.options.onCurrentOrientationConfig(t,i)||e},_onDocumentClick:function(e){var o=i(e.target),n=t.toArray(this.options.dontCloseSelectors);n.push(".i-role-taububble-ignore"),n.push(".ui-autocomplete"),n=n.join(",");var s=o.closest(n).length>0;if(!s&&this.$popup.is(":visible")){var r=i(this.$target).add(this.$popup);if(!(o.closest(r).length>0)){if(this._justActivated)return void(this._justActivated=!1);var a=this.id,h=o.parents(".i-role-bubble");h=o.is(".i-role-bubble")?h.add(o):h;var l=function(t){return i(t).data("parentId")===a};h.length&&t.some(h,l)||(this.$target.trigger("externalClose",{}),this.hide())}}},getAlignTo:function(){var e=this.options.alignTo;return e=t.isFunction(e)?e():i(e),e&&e.length?e:i(this.element)},getContent:function(){return this.$popup.find("[role=content]")},setContent:function(t){this.getContent().html(t)},activate:function(){this._justActivated=!0,this.show()},_subscribeToGlobalEvents:function(){this.options.closeOnEscape&&!this._documentKeyDown&&(this._documentKeyDown=t.bind(this._onKeyDown,this),i(document).on("keydown",this._documentKeyDown)),this._documentClickDelegate||(this._documentClickDelegate=t.bind(this._onDocumentClick,this),i(document).on(this.options.documentMouseEvent,this._documentClickDelegate)),this._windowResizeDelegate||(this._windowResizeDelegate=t.bind(this.adjustPosition,this,null),i(window).on("resize",this._windowResizeDelegate))},_unsubscribeFromGlobalEvents:function(){this._documentKeyDown&&(i(document).off("keydown",this._documentKeyDown),this._documentKeyDown=null),this._documentClickDelegate&&(i(document).off(this.options.documentMouseEvent,this._documentClickDelegate),this._documentClickDelegate=null),this._windowResizeDelegate&&(i(window).off("resize",this._windowResizeDelegate),this._windowResizeDelegate=null)},destroy:function(){var e=this.options;e.hideOnScroll&&i(e.appendTo).off("scroll.tauBubble"),this._unsubscribeFromGlobalEvents(),this.$popup&&(this.hide(),this.$popup.remove(),this.$arrow.remove()),this.$target.off(".tauBubble"),e.content=null,a[e.stackName]=t.without(a[e.stackName],this),this._super(),this._trigger("destroy")},empty:function(){this.hide(),this.$target.data("bubbleLoaded",!1),this.getContent().empty()},_setOption:function(t,i){"content"==t&&this.$popup&&(this.setContent(i),this.adjust()),this._super(t,i)}})});