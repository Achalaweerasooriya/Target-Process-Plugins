define(["Underscore","libs/jquery/jquery.ui"],function(t,e){function i(t){return t=parseFloat(t),0>t?""+t:t>0?"+"+t:""}function o(t){if(t.offset){var e=t.at.replace(r,"").split(" "),o=t.offset.split(" ");t.at=e[0]+i(o[0])+" "+e[1]+i(o[1]),delete t.offset}return t}function n(t,e,i){return t>=e&&i>=t}function s(t,e,i){switch(i){case"right":return n(t.left+9,e.left,e.right);case"left":return n(t.right-9,e.left,e.right);case"bottom":return n(t.top+9,e.top,e.bottom);case"top":return n(t.bottom-9,e.top,e.bottom);default:return!1}}var r=/[\+\-]\d+(\.[\d]+)?%?/g,a={};e.widget("ui.tauBubble",{options:{within:null,hideOnScroll:!0,hideOnScrollContainer:null,parent:null,appendTo:null,appendMethod:null,alignTo:null,zIndex:null,onBeforeShow:e.noop,onShow:e.noop,onHide:e.noop,onPositionConfig:e.noop,onArrowPositionConfig:e.noop,onCurrentOrientationConfig:e.noop,onResize:e.noop,showOnCreation:!1,showArrow:!0,ignoreOverlap:!1,closeOnEscape:!0,mode:"bubble",showEvent:"click",hideEvent:"click",documentMouseEvent:"mousedown",className:"",content:"",stackName:"default",delay:0,template:['<div class="tau-bubble">','    <div class="tau-bubble__arrow" role="arrow"></div>','    <div class="tau-bubble__inner" role="content"></div>',"</div>"].join(""),dontCloseSelectors:[]},_timeoutToken:null,toggle:function(t){this.$popup&&this.$popup.is(":visible")?this._onHideEvent(t):this._onShowEvent(t)},show:function(){var t=this.options;if(!t.disabled){this._initInstance();var e=this.$popup;""!=t.zIndex&&(t.zIndex=t.zIndex||this.$target.zIndex()+1,e.zIndex(t.zIndex)),e.addClass("i-role-bubble");var i=this.$target.parents(".i-role-bubble:first");if(i.length&&(this.parentId=i.attr("id"),e.data("parentId",this.parentId)),this.$target.trigger("show.before",{}),t.onBeforeShow.call(this,e)!==!1){e.addClass("i-state_visible"),t.className&&e.addClass(t.className),e.show(),this.adjust(),t.onShow.call(this,e),this._hideOtherBubbles(),this._subscribeToGlobalEvents();var o={api:this,target:this.$target,popup:this.$popup};
this._trigger("show"),this.$target.trigger("show",o),this.$popup.trigger("show",o)}}},_hideOtherBubbles:function(){for(var t=a[this.options.stackName]||[],e=t.length-1;e>=0;e--){var i=t[e];if(i!=this&&i.id!=this.parentId&&(i.$target.trigger("externalClose",{}),i.hide()),i.id==this.parentId)break}},_hideChildrenBubbles:function(){for(var t=a[this.options.stackName],e=t.length-1;e>=0;e--){var i=t[e];i.parentId==this.id&&(i.$target.trigger("externalClose",{}),i.hide())}},hide:function(t){t=t||{};var e=this.$popup;e&&e.hasClass("i-state_visible")&&(e.removeClass("i-state_visible"),this.options.onHide.call(this,e,t),e.hide(),this._hideChildrenBubbles(),this.options.className&&e.removeClass(this.options.className),this._unsubscribeFromGlobalEvents(),this.$target.trigger("close",{event:t}),this._trigger("hide",t,t))},isVisible:function(){return Boolean(this.$popup&&this.$popup.hasClass("i-state_visible"))},_create:function(){var t=this.options;this.$target=this.element,this.id="bubble"+this.uuid,t.showOnCreation&&this.show(),t.showEvent==t.hideEvent?this.$target.on(t.showEvent+".tauBubble",this._onToggleEvent.bind(this)):(this.$target.on(t.showEvent+".tauBubble",this._onShowEvent.bind(this)),this.$target.on(t.hideEvent+".tauBubble",this._onHideEvent.bind(this))),this._trigger("onCreate")},_getDelay:function(){var e=this.options.delay,i=t.isFunction(e)?e.call(this):e;return i>0?i:0},_clearTimeout:function(){this._timeoutToken&&clearTimeout(this._timeoutToken)},_onShowEvent:function(e){if(this._clearTimeout(),!this._isLinkClicked(e)){var i=this._getDelay();i?this._timeoutToken=t.delay(this.show.bind(this),i):this.show()}},_onHideEvent:function(t){this._clearTimeout(),this.hide(t)},_isLinkClicked:function(t){if(!t||"click"!==t.type)return!1;var i=e(t.target);return i.is("a")||i.parent().is("a")},_onToggleEvent:function(t){t.isPropagationStopped()||this._isLinkClicked(t)||(t.stopPropagation(),this.toggle(t))},_initInstance:function(){if(!this._isInitialize){this._isInitialize=!0;
var i=this.options,o=e(i.template).attr("id",this.id);i.showCloseButton&&e('<div class="tau-bubble__control-close" role="close"></div>').appendTo(o).click(e.proxy(this.hide,this)),this.$popup=o,this._append(o),i.content&&this.setContent(i.content),this.$arrow=o.find("[role=arrow]"),a[i.stackName]=a[i.stackName]||[],t.include(a[i.stackName],this)||a[i.stackName].push(this),o.mouseenter(function(){o.data("focus",!0)}),o.mouseleave(function(){o.data("focus",!1)}),i.hideOnScroll&&e(i.hideOnScrollContainer||i.appendTo).on("scroll.tauBubble",e.proxy(function(){this.hide(),this.$target.trigger("externalClose",{})},this))}},_append:function(t){var i=this.options,o=e(i.appendTo?i.appendTo:[]),n="appendTo";o.length||(o=this.$target.parents(".i-role-bubble-holder:first"),n="appendTo"),o.length||(o=this.$target.parents(".tau-bubble:first").prevAll(".i-role-application:first"),n="insertAfter"),o.length||(o=this.$target.parents(".i-role-application:first"),n="insertAfter"),o.length||(o=e("body"),n="appendTo"),i.appendTo=o,t[i.appendMethod||n](o)},_onKeyDown:function(t){t.keyCode==e.ui.keyCode.ESCAPE&&(this.$target.trigger("externalClose",{}),this.hide(t))},widget:function(){return this.$popup||e()},adjustPosition:function(t){var e=this.$popup;if(e){var i=this.getAlignTo(),n=t||(this.options.showArrow?i[0].getBoundingClientRect():{}),r=this._getPositionConfig();r=this.options.onPositionConfig(r)||r,r=o(r);var a={},h={};r.using=function(t,i){var o=i.element;a={left:o.left,top:o.top,width:o.width,height:o.height,right:o.left+o.width,bottom:o.top+o.height},h=t,e.css(h)},e.css({top:0,left:0}).position(r);var l=this._getCurrentOrientation(a,n);e.hasClass("i-orientation_"+l)||(e.removeClass("i-orientation_"+e.attr("data-orientation")),e.addClass("i-orientation_"+l),e.attr("data-orientation",l));var u=!1;if(this.options.showArrow&&(u=this.options.ignoreOverlap||!s(n,a,l)),u){this.$arrow.attr("data-orientation",l);var d=this._getArrowPositionConfig(a,n,i);this.$arrow.position(d),this.$arrow.show()
}else this.$arrow.hide()}},adjustSize:function(){if(this.options.onResize&&this.options.onResize!==e.noop){var t=this.$popup;if(t){var i=e("body")[0],o={height:i.clientHeight,width:i.clientWidth},n=t[0].getBoundingClientRect(),s={height:o.height-n.top,width:o.width-n.left};this.options.onResize(t,s)}}},adjust:t.throttle(function(){if(this.element.data(this.widgetFullName)){var t;if(this.options.showArrow){var e=this.getAlignTo();t=e[0].getBoundingClientRect()}this.adjustPosition(t),this.adjustSize(),this.adjustPosition(t)}},10),_getArrowPositionConfig:function(e,i,n){var s={within:this.options.within,of:n,collision:"fit flip"},r=e.width>i.width/1.1,a=this._getCurrentOrientation(e,i),h={top:{my:"center top",at:r?"center bottom":"left+20 bottom"},bottom:{my:"center bottom",at:r?"center top":"left+20 top"},left:{my:"left center",at:"right center"},right:{my:"right center",at:"left center"}};return s=t.defaults(h[a],s),s=this.options.onArrowPositionConfig(s,a)||s,s=o(s)},_getPositionConfig:function(){var t=this.options,i={within:t.within,of:this.getAlignTo(),collision:"fit flip"};return"tooltip"==t.mode?e.extend(i,{my:"center top",at:"center bottom"}):e.extend(i,{my:"left top",at:"left-30 bottom"}),i},_getCurrentOrientation:function(t,e){var i="top";return Math.floor(t.top)+1<Math.floor(e.top)&&(i="bottom"),t.right<=e.left+1?i="right":t.left+1>=e.right&&(i="left"),i=this.options.onCurrentOrientationConfig(t,e)||i},_onDocumentClick:function(i){var o=e(i.target),n=t.toArray(this.options.dontCloseSelectors);n.push(".i-role-taububble-ignore"),n.push(".ui-autocomplete"),n=n.join(",");var s=o.closest(n).length>0;if(!s&&this.$popup.is(":visible")){var r=e(this.$target).add(this.$popup);if(!(o.closest(r).length>0)){if(this._justActivated)return void(this._justActivated=!1);var a=this.id,h=o.parents(".i-role-bubble");h=o.is(".i-role-bubble")?h.add(o):h;var l=function(t){return e(t).data("parentId")===a};h.length&&t.some(h,l)||(this.$target.trigger("externalClose",{}),this.hide())
}}},getAlignTo:function(){var i=this.options.alignTo;return i=t.isFunction(i)?i():e(i),i&&i.length?i:e(this.element)},getContent:function(){return this.$popup.find("[role=content]")},setContent:function(t){this.getContent().html(t)},activate:function(){this._justActivated=!0,this.show()},_subscribeToGlobalEvents:function(){this.options.closeOnEscape&&!this._documentKeyDown&&(this._documentKeyDown=t.bind(this._onKeyDown,this),e(document).on("keydown",this._documentKeyDown)),this._documentClickDelegate||(this._documentClickDelegate=t.bind(this._onDocumentClick,this),e(document).on(this.options.documentMouseEvent,this._documentClickDelegate)),this._windowResizeDelegate||(this._windowResizeDelegate=t.bind(this.adjustPosition,this,null),e(window).on("resize",this._windowResizeDelegate))},_unsubscribeFromGlobalEvents:function(){this._documentKeyDown&&(e(document).off("keydown",this._documentKeyDown),this._documentKeyDown=null),this._documentClickDelegate&&(e(document).off(this.options.documentMouseEvent,this._documentClickDelegate),this._documentClickDelegate=null),this._windowResizeDelegate&&(e(window).off("resize",this._windowResizeDelegate),this._windowResizeDelegate=null)},destroy:function(){var i=this.options;i.hideOnScroll&&e(i.hideOnScrollContainer||i.appendTo).off("scroll.tauBubble"),this._unsubscribeFromGlobalEvents(),this.$popup&&(this.hide(),this.$popup.remove(),this.$arrow.remove()),this.$target.off(".tauBubble"),i.content=null,a[i.stackName]=t.without(a[i.stackName],this),this._super(),this._trigger("destroy")},empty:function(){this.hide(),this.$target.data("bubbleLoaded",!1),this.getContent().empty()},_setOption:function(t,e){"content"==t&&this.$popup&&(this.setContent(e),this.adjust()),this._super(t,e)}})});