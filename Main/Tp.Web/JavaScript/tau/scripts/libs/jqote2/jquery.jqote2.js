define(["libs/jquery/jquery","Underscore"],function(t,e){return function(n){function r(t,e){throw n.extend(t,e),t}function o(t){var e=[];if(h.call(t)!==u)return!1;for(var n=0,r=t.length;r>n;n++)e[n]=t[n].jqote_id;return e.length?e.sort().join(".").replace(/(\b\d+\b)\.(?:\1(\.|$))+/g,"$1$2"):!1}function a(t,e){var r,o=[],e=e||f,i=h.call(t);if(i===s)return t.jqote_id?[t]:!1;if(i!==u)return[n.jqotec(t,e)];if(i===u)for(var c=0,l=t.length;l>c;c++)(r=a(t[c],e))&&o.push(r[0]);return o.length?o:!1}var i="UndefinedTemplateError",c="TemplateCompilationError",l="TemplateExecutionError",u="[object Array]",p="[object String]",s="[object Function]",j=1,f="%",d=/^[^<]*(<[\w\W]+>)[^>]*$/,h=Object.prototype.toString;n.fn.extend({jqote:function(t,e){var t=h.call(t)===u?t:[t],r="";return this.each(function(o){for(var a=n.jqotec(this,e),i=0;i<t.length;i++)r+=a.call(t[i],o,i,t,a)}),r}}),n.each({app:"append",pre:"prepend",sub:"html"},function(t,e){n.fn["jqote"+t]=function(r,i,c){var l,u,p=n.jqote(r,i,c),s=d.test(p)?n:function(t){return n(document.createTextNode(t))};return(l=o(a(r)))&&(u=new RegExp("(^|\\.)"+l.split(".").join("\\.(.*)?")+"(\\.|$)")),this.each(function(){var r=s(p);n(this)[e](r),(3===r[0].nodeType?n(this):r).trigger("jqote."+t,[r,u])})}}),n.extend({jqote:function(t,e,n){var o="",n=n||f,c=a(t,n);c===!1&&r(new Error("Empty or undefined template passed to $.jqote"),{type:i}),e=h.call(e)!==u?[e]:e;for(var l=0,p=c.length;p>l;l++)for(var s=0;s<e.length;s++)o+=c[l].call(e[s],l,s,e,c[l]);return o},jqotec:function(e,o){var a,u,s,o=o||f,q=h.call(e);if(q===p&&d.test(e)){if(u=s=e,a=n.jqotecache[e])return a}else if(u=q===p||e.nodeType?n(e):e instanceof t?e:null,u[0]&&((s=u[0].innerHTML)||(s=u.text()))||r(new Error("Empty or undefined template passed to $.jqotec"),{type:i}),a=n.jqotecache[n.data(u[0],"jqote_id")])return a;for(var g,v="",m=s.replace(/\s*<!\[CDATA\[\s*|\s*\]\]>\s*|[\r\n\t]/g,"").split("<"+o).join(o+">").split(o+">"),y=0,b=m.length;b>y;y++)v+=""!==m[y].charAt(0)?"out+='"+m[y].replace(/(\\|["'])/g,"\\$1")+"'":"="===m[y].charAt(1)?";out+=("+m[y].substr(2)+");":"!"===m[y].charAt(1)?";out+=$.jqotenc(("+m[y].substr(2)+"));":";"+m[y].substr(1);v="try{"+('var out="";'+v+";return out;").split("out+='';").join("").split('var out="";out+=').join("var out=")+'}catch(e){e.type="'+l+'";e.args=arguments;e.template=arguments.callee.toString();throw e;}';try{var E=new Function("i, j, data, fn",v)}catch($){r($,{type:c})}return g=u instanceof t?n.data(u[0],"jqote_id",j):u,n.jqotecache[g]=(E.jqote_id=j++,E)},jqotefn:function(t){var e=h.call(t),r=e===p&&d.test(t)?t:n.data(n(t)[0],"jqote_id");return n.jqotecache[r]||!1},jqotetag:function(t){h.call(t)===p&&(f=t)},jqotenc:function(t){return e.asString(t).replace(/&(?!\w+;)/g,"&#38;").split("<").join("&#60;").split(">").join("&#62;").split('"').join("&#34;").split("'").join("&#39;")},jqotecache:{}}),n.event.special.jqote={add:function(t){var e,n=t.handler,r=t.data?h.call(t.data)!==u?[t.data]:t.data:[];t.namespace||(t.namespace="app.pre.sub"),r.length&&(e=o(a(r)))&&(t.handler=function(t,r,o){return!o||o.test(e)?n.apply(this,[t,r]):null})}}}(t),t});