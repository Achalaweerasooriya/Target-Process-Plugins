define(["./js-signals"],function(){!function(t){function e(t,e){for(var r=t.length;r--;)if(t[r]===e)return r;return-1}function r(t,e){return"[object "+t+"]"===h.call(e)}function n(t){return r("RegExp",t)}function i(t){return r("Array",t)}function a(t){return r("Function",t)}function s(t){return t}var u,o,c,h=Object.prototype.toString;u=function(){function t(t,e,n){var i=new o(t,e,n,m);return r(i),i}function r(t){var e=n();do--e;while(l[e]&&t._priority<=l[e]._priority);l.splice(e+1,0,t)}function n(){return l.length}function i(t){var e=a(t);e>=0&&l.splice(e,1),t._destroy()}function a(t){return e(l,t)}function s(){for(var t=n();t--;)l[t]._destroy();l.length=0}function u(t){t=t||"";var e=h(t),r=e?f(t,e):null;e?(r?e.matched.dispatch.apply(e.matched,r):e.matched.dispatch(),d.dispatch(t,e,r)):p.dispatch(t)}function h(t){for(var e,r=n();e=l[--r];)if(e.match(t))return e;return null}function f(t,e){return c.getParamValues(t,e._matchRegexp)}var l=[],p=new signals.Signal,d=new signals.Signal,m={_routes:l,addRoute:t,removeRoute:i,removeAllRoutes:s,parse:u,bypassed:p,routed:d,getNumRoutes:n,toString:function(){return"[crossroads numRoutes:"+n()+"]"}};return m},o=function(t,e,r,i){var a=n(t);this._crossroads=i,this._pattern=t,this._paramsIds=a?null:c.getParamIds(this._pattern),this._matchRegexp=a?t:c.compilePattern(t),this.matched=new signals.Signal,e&&this.matched.add(e,this),this._priority=r||0},o.prototype={rules:void 0,match:function(t){return this._matchRegexp.test(t)&&this._validateParams(t)},_validateParams:function(t){var e,r=this.rules;for(e in r)if(r.hasOwnProperty(e)&&!this._isValidParam(t,e))return!1;return!0},_isValidParam:function(t,r){var s,u=this.rules[r],o=this._getParamValuesObject(t),c=o[r];return n(u)?s=u.test(c):i(u)?s=-1!==e(u,c):a(u)&&(s=u(c,t,o)),s||!1},_getParamValuesObject:function(t){for(var e=this._paramsIds,r=c.getParamValues(t,this._matchRegexp),n={},i=e?e.length:0;i--;)n[e[i]]=r[i];return n.request_=s(t),n},dispose:function(){this._crossroads.removeRoute(this)},_destroy:function(){this.matched.dispose(),this.matched=this._pattern=this._matchRegexp=null},toString:function(){return'[Route pattern:"'+this._pattern+'", numListeners:'+this.matched.getNumListeners()+"]"}},c=function(){function t(t){for(var e,r=[],n=new RegExp(h);e=n.exec(t);)r.push(e[1]);return r}function e(t){return t=t?r(t):"",t=t.replace(/\/$/,""),t=i(t),t=n(t),new RegExp("^"+t+"/?$")}function r(t){return t.replace(h,f)}function n(t){return t.replace(l,c.source)}function i(t){return t.replace(o,"\\$&")}function a(t,e){var r=e.exec(t);return r&&(r.shift(),r=u(r)),r}function u(t){for(var e=t.length,r=[];e--;)r[e]=s(t[e]);return r}var o=/[\\\.\+\*\?\^\$\[\]\(\)\{\}\/\'\#]/g,c=/([^\/]+)/,h=/\{([^\}]+)\}/g,f="___CR_PARAM___",l=new RegExp(f,"g");return{getParamIds:t,getParamValues:a,compilePattern:e}}(),t.crossroads=u}(window||this)});