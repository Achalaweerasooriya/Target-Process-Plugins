define(["./js-signals"],function(a){function l(a){return a===null?a:f.test(a)?a.toLowerCase()==="true":a===""||isNaN(a)?a:parseFloat(a)}function k(a){return h("Function",a)}function j(a){return h("Array",a)}function i(a){return h("RegExp",a)}function h(a,b){return"[object "+a+"]"===e.call(b)}function g(a,b){var c=a.length;while(c--)if(a[c]===b)return c;return-1}var b,c,d,e=Object.prototype.toString,f=/^(true|false)$/i;b=function(){function p(a,b){return d.getParamValues(a,b._matchRegexp)}function o(a){var c=j(),d;while(d=b[--c])if(d.match(a))return d;return null}function n(a){a=a||"";var b=o(a),c=b?p(a,b):null;b?(c?b.matched.dispatch.apply(b.matched,c):b.matched.dispatch(),f.dispatch(a,b,c)):e.dispatch(a)}function m(){var a=j();while(a--)b[a]._destroy();b.length=0}function l(a){return g(b,a)}function k(a){var c=l(a);c>=0&&b.splice(c,1),a._destroy()}function j(){return b.length}function i(a){var c=j();do--c;while(b[c]&&a._priority<=b[c]._priority);b.splice(c+1,0,a)}function h(a,b,d){var e=new c(a,b,d);i(e);return e}var b=[],e=new a.Signal,f=new a.Signal;return{_routes:b,addRoute:h,removeRoute:k,removeAllRoutes:m,parse:n,bypassed:e,routed:f,getNumRoutes:j,toString:function(){return"[crossroads numRoutes:"+j()+"]"}}}(),c=function(b,c,e){var f=i(b);this._pattern=b,this._paramsIds=f?null:d.getParamIds(this._pattern),this._matchRegexp=f?b:d.compilePattern(b),this.matched=new a.Signal,c&&this.matched.add(c),this._priority=e||0},c.prototype={rules:void 0,match:function(a){return this._matchRegexp.test(a)&&this._validateParams(a)},_validateParams:function(a){var b=this.rules,c;for(c in b)if(b.hasOwnProperty(c)&&!this._isValidParam(a,c))return!1;return!0},_isValidParam:function(a,b){var c=this.rules[b],d=this._getParamValuesObject(a),e=d[b],f;i(c)?f=c.test(e):j(c)?f=g(c,e)!==-1:k(c)&&(f=c(e,a,d));return f||!1},_getParamValuesObject:function(a){var b=this._paramsIds,c=d.getParamValues(a,this._matchRegexp),e={},f=b?b.length:0;while(f--)e[b[f]]=c[f];e.request_=l(a);return e},dispose:function(){b.removeRoute(this)},_destroy:function(){this.matched.dispose(),this.matched=this._pattern=this._matchRegexp=null},toString:function(){return'[Route pattern:"'+this._pattern+'", numListeners:'+this.matched.getNumListeners()+"]"}},d=b.patternLexer=function(){function m(a){var b=a.length,c=[];while(b--)c[b]=l(a[b]);return c}function k(a,b){var c=b.exec(a);c&&(c.shift(),c=m(c));return c}function j(b){return b.replace(a,"\\$&")}function i(a){return a.replace(e,b.source)}function h(a){return a.replace(c,d)}function g(a){a=a?h(a):"",a=a.replace(/\/$/,""),a=j(a),a=i(a);return new RegExp("^"+a+"/?$")}function f(a){var b=[],d;while(d=c.exec(a))b.push(d[1]);return b}var a=/[\\\.\+\*\?\^\$\[\]\(\)\{\}\/\'\#]/g,b=/([^\/]+)/,c=/\{([^\}]+)\}/g,d="___CR_PARAM___",e=new RegExp(d,"g");return{getParamIds:f,getParamValues:k,compilePattern:g}}();return b})