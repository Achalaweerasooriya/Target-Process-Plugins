var w=960,h=500,x=d3.scale.linear().range([0,w]),y=d3.scale.linear().range([0,h-40]),svg=d3.select("#chart").append("svg").attr("width",w).attr("height",h).style("padding-right","30px").append("g").attr("transform","translate("+x(1)+","+(h-20)+")scale(-1,-1)"),body=svg.append("g").attr("transform","translate(0,0)"),rules=svg.append("g"),title=svg.append("text").attr("class","title").attr("dy",".71em").attr("transform","translate("+x(1)+","+y(1)+")scale(-1,-1)").text(2e3);d3.csv("population.csv",function(a){function h(){if(f in a)title.text(f),body.transition().duration(750).attr("transform",function(a){return"translate("+x(f-e)+",0)"}),g.selectAll("rect").data(function(b){return a[f][b]||[0,0]}).transition().duration(750).attr("height",y);else return}a.forEach(function(a){a.people=+a.people,a.year=+a.year,a.age=+a.age});var b=0,c=d3.max(a,function(a){return a.age}),d=d3.min(a,function(a){return a.year}),e=d3.max(a,function(a){return a.year}),f=e;x.domain([0,c+5]),y.domain([0,d3.max(a,function(a){return a.people})]),rules=rules.selectAll(".rule").data(y.ticks(10)).enter().append("g").attr("class","rule").attr("transform",function(a){return"translate(0,"+y(a)+")"}),rules.append("line").attr("x2",w),rules.append("text").attr("x",6).attr("dy",".35em").attr("transform","rotate(180)").text(function(a){return Math.round(a/1e6)+"M"});var g=body.selectAll("g").data(d3.range(d-c,e+5,5)).enter().append("g").attr("transform",function(a){return"translate("+x(e-a)+",0)"});g.selectAll("rect").data(d3.range(2)).enter().append("rect").attr("x",1).attr("width",x(5)-2).attr("height",1e-6),g.append("text").attr("y",-6).attr("x",-x(5)/2).attr("transform","rotate(180)").attr("text-anchor","middle").style("fill","#fff").text(String),svg.append("g").selectAll("text").data(d3.range(0,c+5,5)).enter().append("text").attr("text-anchor","middle").attr("transform",function(a){return"translate("+(x(a)+x(5)/2)+",-4)scale(-1,-1)"}).attr("dy",".71em").text(String),a=d3.nest().key(function(a){return a.year}).key(function(a){return a.year-a.age}).rollup(function(a){return a.map(function(a){return a.people})}).map(a),d3.select(window).on("keydown",function(){switch(d3.event.keyCode){case 37:f=Math.max(d,f-10);break;case 39:f=Math.min(e,f+10)}h()}),h()})