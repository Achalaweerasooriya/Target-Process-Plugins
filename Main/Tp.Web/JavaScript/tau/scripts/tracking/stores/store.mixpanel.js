define(["tau/core/class","Underscore"],function(Class,_){return Class.extend({init:function(config){this.config=config||{},function(c,a){window.mixpanel=a;var b,d,h,e;b=c.createElement("script"),b.type="text/javascript",b.async=!0,b.src=("https:"===c.location.protocol?"https:":"http:")+"//cdn.mxpnl.com/libs/mixpanel-2.1.min.js",d=c.getElementsByTagName("script")[0],d.parentNode.insertBefore(b,d),a._i=[],a.init=function(b,c,f){function d(a,b){var c=b.split(".");2==c.length&&(a=a[c[0]],b=c[1]),a[b]=function(){a.push([b].concat(Array.prototype.slice.call(arguments,0)))}}var g=a;"undefined"!=typeof f?g=a[f]=[]:f="mixpanel",g.people=g.people||[],h="disable track track_pageview track_links track_forms register register_once unregister identify name_tag set_config people.identify people.set people.increment".split(" ");for(e=0;e<h.length;e++)d(g,h[e]);a._i.push([b,c,f])},a.__SV=1.1}(document,window.mixpanel||[]),mixpanel.init(this.config.token||"9358df1d76f74e41257a47b79af1681f")},toPlainObject:function(node,value,path){var self=this;_.isUndefined(value)&&(value=null);var isArray=_.isArray(value);if(_.isString(value)||_.isNumber(value)||_.isDate(value)||isArray||_.isBoolean(value)||_.isNull(value)){node[path]=value,isArray&&value&&(node[path+"-not-empty"]=value.length>0,node[path+"-empty"]=value.length===0,node[path+"-length"]=value.length);return}var keys=_.keys(value);for(var i=0;i<keys.length;i++){var key=keys[i];self.toPlainObject(node,value[key],path+"-"+key)}},post:function(data){var mixpanel=window.mixpanel,isContext=data.type==="context";if(isContext&&data.user&&!this._userRegistered){this._userRegistered=!0;var id=data.user.role+" ["+data.user.host+"/"+data.user.id+"]";mixpanel.name_tag(id),mixpanel.people.identify(id);var content={name:id,role:data.user.role,id:data.user.id,host:data.user.host};mixpanel.people.set(content)}var dataToPost={};this.toPlainObject(dataToPost,data,"tp"),isContext&&(dataToPost["tp-user-name"]=data.user.role),mixpanel.track(data.type,dataToPost)}})})