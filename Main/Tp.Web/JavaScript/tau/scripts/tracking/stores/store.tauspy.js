define(["jQuery","Underscore","app.path","libs/json2"],function(t,e,o){var r=!1,n=0;"withCredentials"in new XMLHttpRequest&&(r=!0);var i=[],a=function(t){this.config=e.defaults(t||{},{local:"taus"}),this.usePost=r,this.config.local&&(this.localUrl=o.get()+"/"+t.local,this.usePost=!0)};return a.prototype={encode:function(t){var e,o,r,n,i,a,c,s,u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",h=0,l=0,f="",p=[];if(!t)return t;do e=t.charCodeAt(h++),o=t.charCodeAt(h++),r=t.charCodeAt(h++),s=e<<16|o<<8|r,n=s>>18&63,i=s>>12&63,a=s>>6&63,c=63&s,p[l++]=u.charAt(n)+u.charAt(i)+u.charAt(a)+u.charAt(c);while(h<t.length);f=p.join("");var g=t.length%3;return(g?f.slice(0,g-3):f)+"===".slice(g||3)},postViaImage:function(t){try{if(!t)return!1;var e="https:"===document.location.protocol;if(e&&!this.config.urlSSL)return!1;var o=this.encode(encodeURIComponent(JSON.stringify(t)));if(Image){var r=e?this.config.urlSSL:this.config.url;(new Image).src=r+"?f=b&d="+o}}catch(n){}return!0},queueItem:function(t){var o=this;e.isArray(t)?i=i.concat(t):i.push(t),clearTimeout(n);var r=function(){if(0!==i.length){var t=i.concat([]);i=[],o.usePost?o.postForm(t):o.postViaImage(t)}};i.length>(o.usePost?20:3)?r():n=setTimeout(r,1e3)},postForm:function(e){try{if(!e)return!1;var o=this.localUrl;if(!o){o=r?this.config.urlSSL:this.config.url;var r="https:"===document.location.protocol;if(r&&!this.config.urlSSL)return!1}t.ajax({type:"POST",url:o,dataType:"text",processData:!1,data:JSON.stringify(e),contentType:"application/json; charset=utf-8"})}catch(n){}return!0},post:function(t){this.queueItem(t)}},a});