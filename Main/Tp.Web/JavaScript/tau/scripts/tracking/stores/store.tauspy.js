define(["jQuery","Underscore","app.path","libs/json2"],function($,_,appPath){var isCanBePostUsed=!1,timeoutId=0;"withCredentials"in new XMLHttpRequest&&(isCanBePostUsed=!0);var queue=[],track=function(config){this.config=_.defaults(config||{},{local:"taus"}),this.usePost=isCanBePostUsed,this.config.local&&(this.localUrl=appPath.get()+"/"+config.local,this.usePost=!0)};return track.prototype={encode:function(data){var b64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o1,o2,o3,h1,h2,h3,h4,bits,i=0,ac=0,enc="",tmp_arr=[];if(!data)return data;do o1=data.charCodeAt(i++),o2=data.charCodeAt(i++),o3=data.charCodeAt(i++),bits=o1<<16|o2<<8|o3,h1=bits>>18&63,h2=bits>>12&63,h3=bits>>6&63,h4=bits&63,tmp_arr[ac++]=b64.charAt(h1)+b64.charAt(h2)+b64.charAt(h3)+b64.charAt(h4);while(i<data.length);enc=tmp_arr.join("");var r=data.length%3;return(r?enc.slice(0,r-3):enc)+"===".slice(r||3)},postViaImage:function(data){try{if(!data)return!1;var isSSL="https:"===document.location.protocol;if(isSSL&&!this.config.urlSSL)return!1;var d=this.encode(encodeURIComponent(JSON.stringify(data)));if(Image){var url=isSSL?this.config.urlSSL:this.config.url;(new Image).src=url+"?f=b&d="+d}}catch(e){}return!0},queueItem:function(data){var self=this;_.isArray(data)?queue=queue.concat(data):queue.push(data),clearTimeout(timeoutId);var processQueue=function(){if(queue.length===0)return;var post=queue.concat([]);queue=[],self.usePost?self.postForm(post):self.postViaImage(post)};queue.length>(self.usePost?20:3)?processQueue():timeoutId=setTimeout(processQueue,1e3)},postForm:function(data){try{if(!data)return!1;var url=this.localUrl;if(!url){url=isSSL?this.config.urlSSL:this.config.url;var isSSL="https:"===document.location.protocol;if(isSSL&&!this.config.urlSSL)return!1}$.ajax({type:"POST",url:url,dataType:"json",processData:!1,data:JSON.stringify(data),contentType:"application/json; charset=utf-8"})}catch(e){}return!0},post:function(data){this.queueItem(data)}},track})