define(["jQuery","app.path","Underscore","libs/schedule","./extension.tracking.base","tau/configurator","./session","tp/mashups","./host.info","tp/mashups/failed"],function(e,t,i,s,r,n,a,o,d,c){var h=function(e,t){if(!e)return"";var i=e.toLowerCase().split("/mashups/");return i.length?(i=(i[i.length-1]||"").replace("/","").replace(t,"").replace(".js",""),i=i.split(o.prototype.mashupKeySeparator)[0]):""};return r.extend({init:function(e){var t=e.scheduler;this._super.apply(this,arguments),this.global.on("application.context.data",function(e){e.removeListener(),t.onceADay(function(){this.getSessionData(e.data,function(e){this.fire("data.track",e)}.bind(this))}.bind(this)),window.performance&&window.performance.memory&&window.performance.memory.usedJSHeapSize&&t.eachXMins(30,function(e){var t={date:e.date,"live-minutes":30*e.i,"schedule-shift":e["schedule-shift"],memory:window.performance.memory};taus.track("browser-memory",t)})}.bind(this),this)},"global boardsSet.selected":function(e,t){var i=this.getHost(),s=this.getUser(),r={userProcess:{_id:s._id,user:{id:s._id},host:{id:i},process:t}};this.fire("data.track",r)},getUser:function(e){var t=this.getHost();e=e||{};var s=[window.loggedUser,n.getLoggedUser(),e.loggedUser,{id:0,role:"N/A"}],r=i.find(s,i.identity);return r=i.deepClone(r),r._id=t+"/user/"+r.id,r.host={id:t},r.tau_keep_date=!0,delete r.id,r},getSessionData:function(t,s){var r=this,n=r.getHost(),u=this.getUser(t);a.done(function(t){var r=t.location||{address:{}},a=new Date,l=a.getDate()+"_"+(a.getMonth()+1)+"_"+a.getFullYear(),p=u._id+"/"+l;delete r.latitude,delete r.longitude,delete r.source,u.location=r;var f=[],g=o.prototype.getRegisteredMashups();i.each(i.keys(g),function(e){var t=h(e,n),s=g[e],r=s.files;t.length&&f.push({_id:n+"/"+t+"/"+l,name:i.trim(t),host:{id:n},files:r})});var m={user:u,mashup:f,host:{_id:n},visit:{_id:p,user:{id:u._id},host:{id:n},browser:t.browser,device:t.device,locale:t.locale,location:r}},v=i.keys(c);if(v.length>0){var w=[];i.each(v,function(e){var t=h(e,n);
t.length&&w.push({_id:n+"/"+t+"/"+l,name:t,path:e,host:{id:n}})}),m.failedMashup=w}d.get().done(function(t){if("string"===e.type(t.createdOn)){var r=t.createdOn.split("/");t.createdOn=new Date(parseInt(r[2],10),parseInt(r[0],10)-1,parseInt(r[1],10))}i.extend(m.host,t),i.extend(m.visit.host,t),i.extend(m.user.host,t),s(m)})})}})});