define(["jQuery","app.path","Underscore","./extension.tracking.base","tau/configurator","./session"],function($,path,_,Extension,configurator,session){var trackSingle={};return Extension.extend({"global application.context.data":function(evtHash,initData){var trackDate=new Date,trackKey=trackDate.getDate()+"_"+(trackDate.getMonth()+1)+"_"+trackDate.getFullYear();if(trackSingle[trackKey])return;trackSingle[trackKey]=!0;var self=this,host=self.getHost(),user=window.loggedUser||configurator.getLoggedUser()||initData.loggedUser||{id:0,role:"N/A"};user=_.deepClone(user),user._id=host+"/user/"+user.id,user.host={id:host,tau_ref:"host"},user.tau_keep_date=!0,delete user.id,delete user.name,delete user.email,session.then(function(data){var location=data.location||{address:{}},date=new Date,session_id=user._id+"/"+date.getDate()+"_"+(date.getMonth()+1)+"_"+date.getFullYear();delete location.latitude,delete location.longitude,delete location.source,user.location=location;var evtData={user:user,host:{_id:host},visit:{_id:session_id,user:{id:user._id,tau_ref:"user"},host:{id:host,tau_ref:"host"},browser:data.browser,device:data.device,locale:data.locale,location:location}},$hostInfo=$.ajax({url:path.get()+"/info.ashx",dataType:"json"});$hostInfo.done(function(data){var dateParts=data.createdOn.split("/");data.createdOn=new Date(parseInt(dateParts[2]),parseInt(dateParts[0])-1,parseInt(dateParts[1])),_.extend(evtData.host,data),_.extend(evtData.visit.host,data),_.extend(evtData.user.host,data),self.fire("data.track",evtData)})})}})})