define(["Underscore","./extension.tracking.base","tau/configurator","./session"],function(_,Extension,configurator,session){var isTracked=!1;return Extension.extend({"global application.context.data":function(evtHash,initData){if(isTracked)return;isTracked=!0;var self=this,host=self.getHost(),user=window.loggedUser||configurator.getLoggedUser()||initData.loggedUser||{id:0,role:"N/A"};user=_.deepClone(user),user._id=host+"/user/"+user.id,user.host={id:host,tau_ref:"host"},user.tau_keep_date=!0,delete user.id,delete user.name,delete user.email,session.then(function(data){var location=data.location||{address:{}},date=new Date,session_id=user._id+"/"+date.getDate()+"_"+(date.getMonth()+1)+"_"+date.getFullYear();delete location.latitude,delete location.longitude,delete location.source,user.location=location,self.fire("data.track",{user:user,host:{_id:host},visit:{_id:session_id,user:{id:user._id,tau_ref:"user"},host:{id:host,tau_ref:"host"},browser:data.browser,device:data.device,locale:data.locale,location:location}})})}})})