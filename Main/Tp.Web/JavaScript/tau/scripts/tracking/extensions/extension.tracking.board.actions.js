define(["Underscore","./extension.tracking.base","libs/json2"],function(_,Extension){return Extension.extend({bs_id:0,"global boardSettings.ready":function(evtHash,data){var bs=data.boardSettings;if(this.bs_id===bs.__objectId)return;this.bs_id=bs.__objectId,this.fire("reset.tracking.board.settings",bs),this.fire("tracking.current.board.settings",bs)},"global add.board":function(evtHash,data){this.fire("track.action",_.extend({name:"add board"},data))},"global remove.board":function(evtHash,data){this.fire("track.action",_.extend({name:"remove board"},data))},"global application.navigate.entity":function(evt,card){if(!card)return;var entity=card.type||card.entity;this.fire("track.action",{name:"view "+entity+" #"+card.id,tags:["view entity"],type:entity,id:card.id})},"global quick.add.popup.rendered":function(evt){this.fire("track.action",{name:"show quick add popup",tags:["board","quick add"]})},"global paging.cell.show.more":function(evt){this.fire("track.action",{name:"show more cards",tags:["board","show more"]})},"global board.configurator.initialized > board.configuration.ready > board.definition.ready":function(evtHash,initData,config,definition){var event={contextBoard:config.acid&&config.acid.length>0?!0:!1};_.extend(event,config);var boardContext=this.getBoardContext(definition);_.extend(event,boardContext),event.boardName=event.name||"Unknown board",event.tags=["board","open board"],delete event.cards;var cards=boardContext.cards.types.join(",");cards||(cards="no cards"),event.name='open board "'+event.boardName+'" ['+boardContext.x.type+"/"+boardContext.y.type+" with cards "+cards+"]",this.fire("track.action",event)},"global model.data.item.did.add":function(evt,data){if(!data.message)return;if(!data.message.dataItem)return;if(!data.message.dataItem.type)return;if(!data.message.dataItem.data)return;var type=data.message.dataItem.type.toLowerCase();this.fire("track.action",{name:type+" #"+data.message.dataItem.data.id+" added using quick add",type:type,tags:["add "+type,"add card","board"]})},"global model.data.item.did.fail.add":function(evt,data){if(!data.Message)return;this.fire("track.error",{name:"quick addd error",message:data.Message}),this.fire("track.action",{name:"quick add error",tags:["error","board","quick add"],message:data.Message})},"global view.card.batch.move.completed":function(evt,data){var cards=[],types={};_.each(data,function($card){if(!$card.data)return;var type=$card.data("entity-type");cards.push({type:type,id:$card.data("entity-id")}),types[type]||(types[type]=0),types[type]++}),this.fire("track.action",{name:cards.length+" card(s) moved "+JSON.stringify(types),cards:cards,tags:["board","business action","move cards"]})},"global board.template.selected":function(evt,data){data=data||{name:"not defined"},this.fire("track.action",{name:"apply template ["+data.name+"]",template:data,tags:["board","templates","customize","settings"]})},"bus tracking.current.board.settings > reset.tracking.board.settings":function(evt,settings){settings.unbind({listener:this})},"bus tracking.current.board.settings":function(evt,settings){var self=this;settings.unbind({listener:self}),settings.bind({listener:self,fields:["viewMode","isShared","selectedMarks","focus","user","acid","zoomLevel","page","name","collapse","x","y","edit","cells"],callback:function(r){if(!r)return;var names=[],data={};_.each(_.keys(r),function(key){var name=key;if(name.toLowerCase()==="isdraft")return;var valueOfChange=r[key];key==="user"?name="user filter":key==="edit"?name="switch "+(valueOfChange?"on":"off")+" board edit mode":name=key=="name"?"boardName":key,data[name]=valueOfChange,names.push(name)});if(names.length>0){var eventData={name:"change board settings ["+names.join(",")+"]",tags:["customize","board"].concat(names),changes:data};self.fire("track.action",eventData)}}})}})})