define(["Underscore","tracking/stores/store.factory"],function(t,e){var s="action",i=function(s){this.sid=s.sid,this.globalBus=s.globalBus,this.debugMode=s.debugMode,this.stores=t.map(s.store,function(t,s){return e.createTrackingStore(s,t)});var i=s.adapters;this.adapters={get:function(e){return i[e]||t.identity}},this.getPostAdapters=s.getPostAdapters||function(t){return[t,"--global--"]},this.sync={},this.temp={},this.last={},this.adaptersScope={sid:this.sid}};return i.prototype={_getAdapterArr:function(e){return t.isArray(e)?e:t.isString(e)?[e]:[]},_isDuplicate:function(t,e){var s="--tmp-"+t,i=JSON.stringify(e),r=(new Date).getTime(),n=r-(this.last[s]||0);return this.temp[s]===i&&3e3>=n?!0:(this.temp[s]=i,this.last[s]=r,!1)},_post:function(e){if(t.isObject(e))for(var s=0;s<this.stores.length;s++)try{this.stores[s].api.post(e)}catch(i){}},_verifyThenPost:function(e,s){if(this._isDuplicate(e,s))return!1;var i={};return i[e]=t.extend({sid:this.sid,tick:(new Date).getTime()},s),this._post(i),!0},_adapt:function(e,s){var i=t.isFunction(s)?s:this.adapters.get(s);return i.call(this.adaptersScope,e)},_applyAdapters:function(e,s){var i="@",r=this._getAdapterArr(e[i]),n=t.omit(e,i),a=r.concat(s);return t.reduce(a,this._adapt.bind(this),n)},context:function(t){this._applyAdapters(t,[])},track:function(e,i){1===arguments.length&&(i=t.isString(e)?{name:e}:e,e=s);try{var r=this._applyAdapters(i,this.getPostAdapters(e));this._verifyThenPost(e,r)}catch(n){this.debugMode&&"undefined"!=typeof console&&console.log(n)}},error:function(t){this.track("error",t)},start:function(){var e,i;if(t.isFunction(arguments[0])){var r=arguments[0]();e=r.tick,i=r.args}else e=+new Date,i=[].slice.call(arguments);var n,a,o;if(3===i.length)n=i[0],a=i[1],o=i[2];else if(2===i.length){var c=t.isObject(i[0]);n=c?s:i[0],a=c?i[0]:i[1],o=c?i[1]:t.uniqueId()}else 1===i.length&&(n=s,a=t.isString(i[0])?{name:i[0]}:i[0],o=t.uniqueId());return this.sync[o]={t0:e,type:n,data:a},{stop:this.stop.bind(this,o)}},stop:function(){var e,s;
if(t.isFunction(arguments[0])){var i=arguments[0]();e=i.tick,s=i.args}else e=+new Date,s=[].slice.call(arguments);var r=s[0],n=s[1]||{},a=this.sync[r];if(a&&a.t0){var o=t.extend({t0:a.t0,t1:e},a.data,n),c=this._getAdapterArr(o["@"]);c.splice(0,0,"to-timing"),o["@"]=c,this.track(a.type,o),delete this.sync[r]}}},i});