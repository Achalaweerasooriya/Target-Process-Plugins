require(["tp/plugins/vcs/tpUsersPopoverWidget","tp/plugins/vcs/ui.widgets","libs.tests/jquery.simulate"],function(a){module("tpuser widget",{setup:function(){this._placeHolder=$('<div><input class="tpUser"/></div>').appendTo("body"),this._input=this._placeHolder.find(".tpUser"),this._source=[{Id:"1",Name:"John Smith",Role:"Developer",Avatar:"avatar"},{Id:"2",Name:"Ivan Petrov",Role:"Manager",Avatar:"avatar"}],new a({elements:this._input,source:this._source,delay:1}),this.equal=function(a,b){var c={Id:a.find(".id").val(),Name:a.find(".name").text(),Role:a.find(".role").text(),Avatar:a.find("img").attr("src")};deepEqual(c,b)},this.assertWidgetHasUsers=function(a){equal(this.getAutocompleteItems().length,a,"widget should have "+a+" users")},this.assertUserIsSelected=function(a){equal(this._input.attr("userId"),a.Id),equal(this._input.val(),a.Name)},this.assertWidgetIsHidden=function(){var a=!1;this.getAutocompleteItems().length==0?a=!0:a=this.getAutocompleteItems().parents("ul").css("display")=="none",ok(a,"widget should be hidden")},this.keyDown=function(){this._input.simulate("keydown",{keyCode:$.ui.keyCode.DOWN})},this.keyEnter=function(){this._input.simulate("keydown",{keyCode:$.ui.keyCode.ENTER})},this.getAutocompleteItems=function(){return this._placeHolder.next().find("li ul")},this.clickItem=function(a){$(this.getAutocompleteItems()[a]).parent("a").mouseenter(),$(this.getAutocompleteItems()[a]).parent("a").click()}},teardown:function(){this._placeHolder.remove()}}),test("should display user mapping when got focus",function(){this.assertWidgetIsHidden(),this.keyDown(),this.assertWidgetHasUsers(2);var a=this.getAutocompleteItems();this.equal($(a[0]),this._source[0]),this.equal($(a[1]),this._source[1])}),test("should filter users as typing",function(){this._input.val("Ivan"),this.keyDown(),this.assertWidgetHasUsers(1);var a=this.getAutocompleteItems();this.equal($(a[0]),this._source[1])}),test("should allow to select user to input from widget by click",function(){this.keyDown(),this.clickItem(0);var a=this._source[0];this.assertUserIsSelected(a),this.assertWidgetIsHidden()}),test("should allow to select user to input from widget by Enter key",function(){this.keyDown(),this.keyDown(),this.keyEnter();var a=this._source[0];this.assertUserIsSelected(a),this.assertWidgetIsHidden()})})