require(["tp/plugins/vcs/tpUsersPopoverWidget","tp/plugins/vcs/ui.widgets","libs.tests/jquery.simulate"],function(tpUsersPopoverWidget){module("tpuser widget",{setup:function(){this._placeHolder=$('<div><input class="tpUser"/></div>').appendTo("body"),this._input=this._placeHolder.find(".tpUser"),this._source=[{Id:"1",Name:"John Smith",Role:"Developer",Avatar:"avatar"},{Id:"2",Name:"Ivan Petrov",Role:"Manager",Avatar:"avatar"}],new tpUsersPopoverWidget({elements:this._input,source:this._source,delay:1}),this.equal=function(userItem,user){var actual={Id:userItem.find(".id").val(),Name:userItem.find(".name").text(),Role:userItem.find(".role").text(),Avatar:userItem.find("img").attr("src")};deepEqual(actual,user)},this.assertWidgetHasUsers=function(count){equal(this.getAutocompleteItems().length,count,"widget should have "+count+" users")},this.assertUserIsSelected=function(user){equal(this._input.attr("userId"),user.Id),equal(this._input.val(),user.Name)},this.assertWidgetIsHidden=function(){var isHidden=!1;this.getAutocompleteItems().length==0?isHidden=!0:isHidden=this.getAutocompleteItems().parents("ul").css("display")=="none",ok(isHidden,"widget should be hidden")},this.keyDown=function(){this._input.simulate("keydown",{keyCode:$.ui.keyCode.DOWN})},this.keyEnter=function(){this._input.simulate("keydown",{keyCode:$.ui.keyCode.ENTER})},this.getAutocompleteItems=function(){return this._placeHolder.next().find("li ul")},this.clickItem=function(index){$(this.getAutocompleteItems()[index]).parent("a").mouseenter(),$(this.getAutocompleteItems()[index]).parent("a").click()}},teardown:function(){this._placeHolder.remove()}}),test("should display user mapping when got focus",function(){this.assertWidgetIsHidden(),this.keyDown(),this.assertWidgetHasUsers(2);var userItems=this.getAutocompleteItems();this.equal($(userItems[0]),this._source[0]),this.equal($(userItems[1]),this._source[1])}),test("should filter users as typing",function(){this._input.val("Ivan"),this.keyDown(),this.assertWidgetHasUsers(1);var userItems=this.getAutocompleteItems();this.equal($(userItems[0]),this._source[1])}),test("should allow to select user to input from widget by click",function(){this.keyDown(),this.clickItem(0);var selectedUser=this._source[0];this.assertUserIsSelected(selectedUser),this.assertWidgetIsHidden()}),test("should allow to select user to input from widget by Enter key",function(){this.keyDown(),this.keyDown(),this.keyEnter();var selectedUser=this._source[0];this.assertUserIsSelected(selectedUser),this.assertWidgetIsHidden()})})